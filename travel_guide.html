<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxuryHavenTravel - Đặt Phòng Khách Sạn Trực Tuyến</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase CDN Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- EmailJS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <link rel="stylesheet" href="css/travel_guide.css">
    <link rel="stylesheet" href="css\chatbox.css">
    <script type="module" src="js/search.js"></script>
    <script src="js/mobile.js"></script>
    <link rel="stylesheet" href="css\mobile.css">
    <link rel="stylesheet" href="css/loading.css">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
    <script src="js/loading.js"></script>
    <style>
        @font-face {
            font-family: 'Nautica Script Bold';
            src: url('fonts/nautica-bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        .nautica-script {
            font-family: 'Nautica Script Bold', cursive;
            font-size: 3em;
            font-weight: bold;
            color: #cddae6;
            text-align: center;
        }

        /* Guide Card Enhancements */
        .guide-card-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .guide-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .guide-rating-section {
            margin-top: 8px;
        }

        .guide-rating {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rating-stars {
            display: flex;
            gap: 2px;
        }

        .rating-stars i {
            color: #ffd700;
            cursor: pointer;
            font-size: 14px;
            transition: color 0.2s;
        }

        .rating-stars i:hover {
            color: #ffed4e;
        }

        .rating-stars i.fas {
            color: #ffd700;
        }

        .rating-count {
            font-size: 12px;
            color: #6c757d;
        }

        .guide-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .guide-actions .btn {
            flex: 1;
            font-size: 12px;
            padding: 6px 12px;
        }

        .favorite-btn.active {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .favorite-btn.active i {
            color: white;
        }

        .favorite-btn .like-count {
            font-size: 12px;
            margin-left: 4px;
            color: #6c757d;
            font-weight: 600;
        }

        .favorite-btn.active .like-count {
            color: white;
        }

        .favorite-btn:hover {
            transform: scale(1.05);
            transition: all 0.2s;
        }

        .favorite-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .favorite-btn:disabled:hover {
            transform: none !important;
        }

        /* Comment Modal Styles */
        .comment-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .comment-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            max-width: 700px;
            max-height: 85vh;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .comment-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .comment-close:hover {
            background-color: #e9ecef;
        }

        .comment-body {
            flex: 1;
            max-height: 450px;
            overflow-y: auto;
            padding: 20px;
        }

        .comment-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .comment-item {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease-in;
        }

        .comment-main {
            display: flex;
            gap: 12px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #1a237e, #0d47a1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            background: #f1f3f4;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .comment-author {
            font-weight: bold;
            font-size: 13px;
            color: #1a237e;
            margin-bottom: 4px;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.4;
            color: #333;
            margin-bottom: 8px;
        }

        .comment-image {
            margin: 8px 0;
            cursor: pointer;
        }

        .comment-image img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
            transition: transform 0.2s;
        }

        .comment-image img:hover {
            transform: scale(1.02);
        }

        .comment-actions-bar {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            align-items: center;
        }

        .comment-like-btn, .comment-dislike-btn, .comment-reply-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 12px;
            color: #65676b;
        }

        .comment-like-btn:hover, .comment-dislike-btn:hover, .comment-reply-btn:hover {
            background: #e4e6ea;
        }

        .comment-like-btn.active {
            color: #1877f2;
        }

        .comment-dislike-btn.active {
            color: #e41e3f;
        }

        .comment-time {
            font-size: 12px;
            color: #65676b;
            margin-top: 6px;
            margin-left: 52px;
        }

        .comment-replies {
            margin-left: 52px;
            margin-top: 10px;
            border-left: 2px solid #e4e6ea;
            padding-left: 15px;
        }

        .comment-reply-form {
            margin-left: 52px;
            margin-top: 10px;
            display: none;
        }

        .comment-reply-input {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 15px;
            padding: 8px 12px;
            resize: none;
            min-height: 35px;
            font-size: 13px;
        }

        .comment-reply-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .comment-reply-submit, .comment-reply-cancel {
            padding: 4px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .comment-reply-submit {
            background: #1a237e;
            color: white;
        }

        .comment-reply-cancel {
            background: #6c757d;
            color: white;
        }

        .comment-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .comment-input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .comment-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 16px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            font-size: 14px;
        }

        .comment-input:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.1);
        }

        .comment-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .comment-image-upload {
            position: relative;
        }

        .comment-image-input {
            display: none;
        }

        .comment-image-btn {
            background: #e4e6ea;
            color: #65676b;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .comment-image-btn:hover {
            background: #dadde1;
        }

        .comment-submit {
            background: linear-gradient(45deg, #1a237e, #0d47a1);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .comment-submit:hover:not(:disabled) {
            transform: scale(1.1);
        }

        .comment-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .comment-image-preview {
            margin-top: 10px;
            display: none;
        }

        .comment-preview-container {
            position: relative;
            display: inline-block;
            max-width: 200px;
        }

        .comment-preview-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .comment-remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e41e3f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .no-comments {
            text-align: center;
            color: #65676b;
            padding: 40px 20px;
            font-style: italic;
        }

        /* Image Viewer Modal */
        .image-viewer-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s ease;
        }

        .image-viewer-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .image-viewer-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 2001;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Rating Modal Styles */
        .rating-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .rating-modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border-radius: 12px;
            max-width: 400px;
            position: relative;
        }

        .rating-stars-large {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .rating-stars-large i {
            font-size: 32px;
            color: #ffd700;
            cursor: pointer;
            transition: color 0.2s;
        }

        .rating-stars-large i:hover {
            color: #ffed4e;
        }

        .rating-stars-large i.fas {
            color: #ffd700;
        }
        .guide-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(30,42,80,0.10);
            border: none;
            padding: 28px 28px 28px 24px;
            margin-bottom: 0;
            transition: box-shadow 0.22s, transform 0.22s;
            display: flex;
            align-items: center;
            min-height: 110px;
            position: relative;
            overflow: hidden;
        }
        .guide-card:hover {
            box-shadow: 0 10px 32px rgba(30,42,80,0.18);
            transform: translateY(-3px) scale(1.025);
        }
        .guide-card .guide-item-icon {
            width: 64px;
            height: 64px;
            margin-right: 24px;
            border-radius: 16px;
            object-fit: cover;
            background: #f0f4fa;
            box-shadow: 0 2px 8px rgba(30,42,80,0.07);
            flex-shrink: 0;
        }
        .guide-card .guide-item-title {
            font-size: 1.18rem;
            font-weight: 700;
            color: #1a2a3a;
            line-height: 1.45;
            margin-bottom: 0;
            transition: color 0.2s;
        }
        .guide-card:hover .guide-item-title {
            color: #0d6efd;
        }

        /* Guide Card Link Styles */
        .guide-card-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            width: 100%;
            color: inherit;
            transition: all 0.3s ease;
        }

        .guide-card-link:hover {
            text-decoration: none;
            color: inherit;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <dotlottie-wc 
            src="https://lottie.host/22866d75-292a-42dc-ae8a-72f6f903386d/dwhv5hvZ72.lottie" 
            style="width: 300px; height: 300px" 
            speed="1" 
            autoplay 
            loop>
        </dotlottie-wc>
        <div class="loading-text">LuxuryHavenTravel</div>
        <div class="loading-subtext">Đang tải nội dung...</div>
    </div>
    
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-flex">
                <!-- Logo -->
                <a class="navbar-brand" href="#">
                    <img src="images/LuxuryHavenTravel.png" alt="LuxuryHaven Logo">
                </a> <!-- Mobile Menu Button -->
                <button class="mobile-menu-btn" id="mobile-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>

               <!-- Search Box -->
<div class="nav-search">
    <div class="search-input-group">
        <input type="text" placeholder="Tìm kiếm..." id="main-search-input" autocomplete="off">
        <button type="button" id="main-search-btn">
            <i class="fas fa-search"></i>
        </button>
    </div>
</div>
                <div class="nav-right">
                    <ul class="nav-links" id="nav-links">
                        <li><a href="index.html">Trang chủ</a></li>
                        <li><a href="hotel.html">Khách sạn</a></li>

                        <li class="dropdown"><a href="tours.html">Tours</a></li>

                        <li class="dropdown"><a href="prioritize.html">Ưu đãi</a></li>
                        <li class="dropdown"><a href="travel_guide.html" class="active">Cẩm nang du lịch</a></li>
                        <li class="dropdown"><a href="about_us.html">Về chúng tôi</a></li>
                        <!-- <li class="dropdown"><a href="vuichoi.html">🌐</a></li> -->

                        <li>
                            <div class="d-flex align-items-center">
                                <div class="dropdown" id="user-dropdown" style="display:none;">
                                    <button class="btn btn-outline-primary dropdown-toggle" type="button"
                                        id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-user"></i> <span id="user-name"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                        <li><a class="dropdown-item" href="member.html"><i
                                                    class="fas fa-user-circle"></i> Tài khoản</a></li>
                                        <li><a class="dropdown-item" href="#" id="logout-btn"><i
                                                    class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
                                    </ul>
                                </div>
                                <a href="auth.html" class="btn btn-outline-primary me-2" id="login-btn">
                                    <i class="fas fa-user"></i> Đăng nhập
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <!-- Hero Section -->
        <section class="hero-section-new">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <div class="hero-content">
                            <h1>LuxuryHavenTravel</h1>
                            <p>Khám phá những điểm đến tuyệt vời, lên kế hoạch cho chuyến đi mơ ước của bạn cùng chúng tôi.</p>
                            <a href="#packages-section" class="btn btn-enquire">Khám phá ngay</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="hero-image-container d-none d-lg-block">
                <img src="https://cdn.pixabay.com/photo/2018/08/01/21/26/map-3578213_1280.jpg" alt="Travelers exploring">
            </div>
        </section>

        <!-- Tour Packages Section -->
        <section id="packages-section" class="packages-section section-spacing">
            <div class="container">
                <div class="section-heading text-center mb-5">
                    <h1 class="fw-bold" style="color:#1a237e;">Tour Packages</h1>
                    <p class="text-muted">Chúng tôi gọi đây là Cẩm Nang Du Lịch</p>
                </div>

                <h3 class="sub-heading mb-3" style="color:#0d47a1;">Cẩm nang nổi bật</h3>
                <div class="row g-4" id="featured-guides-container">
                    <!-- Featured guides will be injected here by JavaScript -->
                </div>

                <h3 class="sub-heading mt-5 mb-3" style="color:#0d47a1;">Cẩm nang mới nhất</h3>
                <div class="row g-4" id="latest-guides-container">
                    <!-- Latest guides will be injected here by JavaScript -->
                </div>
            </div>
        </section>
        
        <!-- Section: Da Nang & Hoi An Hero -->
        <section class="travel-hero-section" style="background:#181c24; color:#fff; padding:60px 0 40px 0;">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6 mb-4 mb-lg-0">
                        <h1 style="font-family:'Playfair Display',serif;font-size:3.2rem;font-weight:700;color:#ffb347;">Da Nang & Hoi An</h1>
                        <p style="font-size:1.3rem;max-width:500px;line-height:1.6;">Khám phá vẻ đẹp hiện đại của Đà Nẵng và nét cổ kính, yên bình của Hội An. Hai điểm đến tuyệt vời cho hành trình du lịch miền Trung Việt Nam.</p>
                    </div>
                    <div class="col-lg-6 text-center">
                        <img src="https://cdn.pixabay.com/photo/2017/03/13/19/11/hoi-an-2140906_1280.jpg" alt="Da Nang & Hoi An" class="img-fluid rounded-4 shadow-lg" style="max-height:340px;object-fit:cover;">
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Da Nang Block -->
        <section class="travel-block-section" style="background:#fff; color:#181c24; padding:60px 0;">
            <div class="container">
                <div class="row align-items-center g-5">
                    <div class="col-md-6 order-md-2">
                        <img src="https://cdn.pixabay.com/photo/2023/08/26/15/07/vietnam-8215249_1280.jpg" alt="Da Nang" class="img-fluid rounded-4 shadow-lg">
                    </div>
                    <div class="col-md-6 order-md-1">
                        <h2 style="font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:700;color:#ffb347;">Da Nang</h2>
                        <p style="font-size:1.1rem;line-height:1.7;">Đà Nẵng là thành phố biển năng động, nổi tiếng với bãi biển Mỹ Khê, cầu Rồng, Bà Nà Hills và ẩm thực phong phú. Đây là điểm dừng chân lý tưởng cho du khách yêu thích sự hiện đại và tiện nghi.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Hoi An Block -->
        <section class="travel-block-section" style="background:#181c24; color:#fff; padding:60px 0;">
            <div class="container">
                <div class="row align-items-center g-5">
                    <div class="col-md-6">
                        <img src="https://cdn.pixabay.com/photo/2022/02/12/15/14/light-7009157_1280.jpg" alt="Hoi An" class="img-fluid rounded-4 shadow-lg">
                    </div>
                    <div class="col-md-6">
                        <h2 style="font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:700;color:#ffb347;">Hoi An</h2>
                        <p style="font-size:1.1rem;line-height:1.7;">Hội An nổi bật với phố cổ rực rỡ đèn lồng, những con phố nhỏ yên bình, di sản văn hóa thế giới và nền ẩm thực đặc sắc. Đây là nơi lý tưởng để trải nghiệm không gian xưa và sự thân thiện của người dân địa phương.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Hoi An Nightlife -->
        <section class="travel-block-section" style="background:#fff; color:#181c24; padding:60px 0;">
            <div class="container">
                <div class="row align-items-center g-5">
                    <div class="col-md-6 order-md-2">
                        <img src="https://cdn.pixabay.com/photo/2021/08/04/02/54/hoi-an-6520902_1280.jpg" alt="Hoi An Nightlife" class="img-fluid rounded-4 shadow-lg">
                    </div>
                    <div class="col-md-6 order-md-1">
                        <h2 style="font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:700;color:#ffb347;">Hoi An Nightlife</h2>
                        <p style="font-size:1.1rem;line-height:1.7;">Khi màn đêm buông xuống, Hội An trở nên lung linh với hàng ngàn chiếc đèn lồng, các quán cà phê ven sông và hoạt động giải trí sôi động. Đừng bỏ lỡ trải nghiệm thả đèn hoa đăng trên sông Hoài!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Hoi An Street -->
        <section class="travel-block-section" style="background:#181c24; color:#fff; padding:60px 0;">
            <div class="container">
                <div class="row align-items-center g-5">
                    <div class="col-md-6">
                        <img src="https://cdn.pixabay.com/photo/2022/10/06/03/45/hoi-an-7501885_1280.jpg" alt="Hoi An Street" class="img-fluid rounded-4 shadow-lg">
                    </div>
                    <div class="col-md-6">
                        <h2 style="font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:700;color:#ffb347;">Hoi An Street</h2>
                        <p style="font-size:1.1rem;line-height:1.7;">Những con phố nhỏ rợp bóng hoa giấy, nhà cổ vàng rực và các cửa hàng thủ công truyền thống tạo nên nét quyến rũ riêng cho Hội An. Mỗi góc phố đều là một background sống ảo tuyệt đẹp!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Giữ lại phần Ưu đãi đa dạng và Về chúng tôi, làm mới lại cho đồng bộ phong cách -->
        <section class="offers-section py-5" style="background:#6a6d7c; color:#fff;">
            <div class="container text-center">
                <p class="offers-subtitle text-uppercase fw-semibold mb-2" style="color:#ffb347;">Ưu đãi đa dạng</p>
                <h2 class="section-title fw-bold mb-4" style="color:#fff;">Lựa Chọn Các Loại Hình Du Lịch</h2>
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-6 g-4 justify-content-center">
                    <div class="col">
                        <div class="offer-item card border-0 shadow-sm h-100 py-4" style="background:#fff; color:#ffb347;">
                            <div class="icon-container mb-2"><i class="fas fa-gopuram fa-2x"></i></div>
                            <p class="fw-semibold mb-0">Khám Phá Văn Hóa</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="offer-item card border-0 shadow-sm h-100 py-4" style="background:#fff; color:#ffb347;">
                            <div class="icon-container mb-2"><i class="fas fa-bus-alt fa-2x"></i></div>
                            <p class="fw-semibold mb-0">Tour Đường Bộ</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="offer-item card border-0 shadow-sm h-100 py-4" style="background:#fff; color:#ffb347;">
                            <div class="icon-container mb-2"><i class="fas fa-utensils fa-2x"></i></div>
                            <p class="fw-semibold mb-0">Tour Ẩm Thực</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="offer-item card border-0 shadow-sm h-100 py-4" style="background:#fff; color:#ffb347;">
                            <div class="icon-container mb-2"><i class="fas fa-umbrella-beach fa-2x"></i></div>
                            <p class="fw-semibold mb-0">Nghỉ Dưỡng Biển</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="offer-item card border-0 shadow-sm h-100 py-4" style="background:#fff; color:#ffb347;">
                            <div class="icon-container mb-2"><i class="fas fa-ship fa-2x"></i></div>
                            <p class="fw-semibold mb-0">Du Thuyền Xa Hoa</p>
                        </div>
                    </div>
                    <div class="col">
                        <div class="offer-item card border-0 shadow-sm h-100 py-4" style="background:#fff; color:#ffb347;">
                            <div class="icon-container mb-2"><i class="fas fa-mountain fa-2x"></i></div>
                            <p class="fw-semibold mb-0">Chinh Phục Núi Cao</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="about-section section-spacing py-5">
            <div class="container">
                <div class="row align-items-center g-5">
                    <div class="col-lg-6">
                        <div class="about-image rounded-4 overflow-hidden shadow-sm">
                            <img src="../images/vecteezy_ai-generated-travelling-to-thailand-advertisment-background_37248582.jpg" alt="About Us" class="img-fluid">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="about-content ps-lg-4">
                            <h2 class="fw-bold mb-3" style="color:#ffb347;font-family:'Playfair Display',serif;">Về chúng tôi</h2>
                            <p class="text-muted fs-5">Chúng tôi là một điểm dừng duy nhất cho mọi nhu cầu du lịch của bạn. Chúng tôi hiểu tầm quan trọng của chuyến đi đối với bạn, vì vậy chúng tôi nỗ lực hết mình để làm cho chuyến đi của bạn trở nên đáng nhớ. Kỳ nghỉ của bạn phải thực sự khó quên, từ yêu cầu đầu tiên cho đến khi bạn trở về nhà sau chuyến đi.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!-- End Contact Section -->

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h4>Về LuxuryHavenTravel</h4>
                    <ul>
                        <li><a href="about_us.html">Giới thiệu</a></li>
                        <li><a href="footer\recruitment.html">Tuyển dụng</a></li>
                        <li><a href="footer\news.html">Tin tức</a></li>
                        <li><a href="footer\contact.html">Liên hệ</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h4>Hỗ trợ</h4>
                    <ul>
                        <li><a href="footer\help-center.html">Trung tâm trợ giúp</a></li>
                        <li><a href="footer\privacy-policy.html">Chính sách bảo mật</a></li>
                        <li><a href="footer\terms.html">Điều khoản sử dụng</a></li>
                        <li><a href="footer\cookie-policy.html">Chính sách cookie</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h4>Đối tác</h4>
                    <ul>
                        <li><a href="footer\partner.html">Đăng ký làm đối tác</a></li>
                        <li><a href="footer\marketing.html">Chương trình tiếp thị</a></li>
                        <li><a href="footer\affiliate.html">Affiliate</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h4>Theo dõi chúng tôi</h4>
                    <div class="social-links">
                        <a href="https://facebook.com/100083035936090"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 LuxuryHavenTravel. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content"
            style="max-width: 400px; padding: 32px 28px 24px 28px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.18);">
            <span class="close" id="close-auth-modal" style="right: 18px; top: 12px; font-size: 32px;">&times;</span>

            <div id="auth-forms">
                <form id="login-form" class="auth-form" style="text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="login-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="email" id="login-email" placeholder="e.g. elon@tesla.com" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="login-password" style="font-weight: 500;">Mật khẩu</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="login-password" placeholder="e.g. ilovemangools123" required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">Đăng nhập</button>
                    <div class="login-links">
                        <a href="#" id="to-register">Không có tài khoản?</a>
                        <a href="#" id="to-forgot">Quên mật khẩu?</a>
                    </div>
                </form>

                <form id="register-form" class="auth-form" style="display: none; text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-username" style="font-weight: 500;">Tên người dùng</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="register-username" placeholder="Nhập tên của bạn" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="register-email" placeholder="Nhập email của bạn" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-password" style="font-weight: 500;">Mật khẩu</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="register-password" placeholder="Tối thiểu 6 ký tự" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-confirm-password" style="font-weight: 500;">Xác nhận mật khẩu</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="register-confirm-password" placeholder="Nhập lại mật khẩu"
                                required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">Đăng ký</button>
                    <div class="login-links">
                        <a href="#" id="to-login">Đã có tài khoản? Đăng nhập</a>
                    </div>
                </form>

                <form id="forgot-form" class="auth-form" style="display: none; text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="forgot-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="forgot-email" placeholder="Nhập email của bạn" required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">Gửi yêu cầu đặt lại mật khẩu</button>
                    <div class="login-links">
                        <a href="#" id="back-to-login">Quay lại đăng nhập</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Firebase config và xử lý xác thực
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.firebasestorage.app",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
    
        // Đợi DOM load xong
        document.addEventListener('DOMContentLoaded', function () {
            // Helper function để lấy element an toàn
            function safeGetElement(id) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element with ID '${id}' not found`);
                }
                return element;
            }

            // Lấy các elements với kiểm tra an toàn
            const loginForm = safeGetElement('login-form');
            const registerForm = safeGetElement('register-form');
            const forgotForm = safeGetElement('forgot-form');
            const closeAuthModal = safeGetElement('close-auth-modal');
            const openLoginModal = safeGetElement('open-login-modal');
            const userDropdown = safeGetElement('user-dropdown');
            const userName = safeGetElement('user-name');
            const logoutBtn = safeGetElement('logout-btn');

            // Xử lý đăng nhập
            if (loginForm) {
                loginForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const emailInput = safeGetElement('login-email');
                    const passwordInput = safeGetElement('login-password');
                    
                    if (!emailInput || !passwordInput) {
                        console.error('Login form elements not found');
                        return;
                    }
                    
                    const email = emailInput.value;
                    const password = passwordInput.value;

                    firebase.auth().signInWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            const authModal = safeGetElement('auth-modal');
                            if (authModal) {
                                authModal.style.display = 'none';
                            }

                            // Kiểm tra nếu là admin
                            if (email === 'quantrikhachsan@gmail.com') {
                                Swal.fire({
                                    title: 'Đăng nhập thành công!',
                                    text: 'Chào mừng Admin!',
                                    icon: 'success',
                                    confirmButtonColor: '#e67e22'
                                }).then(() => {
                                    window.location.href = 'admin-dashboard.html';
                                });
                            } else if (email === 'nhanvien2@luxuryhaven.com') {
                                Swal.fire({
                                    title: 'Đăng nhập thành công!',
                                    text: 'Chào mừng Nhân viên!',
                                    icon: 'success',
                                    confirmButtonColor: '#e67e22'
                                }).then(() => {
                                    window.location.href = 'admin-dashboard.html';
                                });
                            } else {
                                Swal.fire({
                                    title: 'Đăng nhập thành công!',
                                    icon: 'success',
                                    confirmButtonColor: '#e67e22'
                                });
                            }
                        })
                        .catch((error) => {
                            Swal.fire({
                                title: 'Lỗi đăng nhập!',
                                text: error.message,
                                icon: 'error',
                                confirmButtonColor: '#e67e22'
                            });
                        });
                });
            }

            // Xử lý đăng ký
            if (registerForm) {
                registerForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const emailInput = safeGetElement('register-email');
                    const passwordInput = safeGetElement('register-password');
                    const confirmPasswordInput = safeGetElement('register-confirm-password');
                    const usernameInput = safeGetElement('register-username');
                    
                    if (!emailInput || !passwordInput || !confirmPasswordInput || !usernameInput) {
                        console.error('Register form elements not found');
                        return;
                    }
                    
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;
                    const username = usernameInput.value;

                    if (password.length < 6) {
                        Swal.fire({
                            title: 'Lỗi đăng ký!',
                            text: 'Mật khẩu phải có ít nhất 6 ký tự.',
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                        return;
                    }

                    if (password !== confirmPassword) {
                        Swal.fire({
                            title: 'Lỗi đăng ký!',
                            text: 'Mật khẩu nhập lại không khớp.',
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                        return;
                    }

                    firebase.auth().createUserWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            // Cập nhật displayName và lưu thông tin user vào database
                            return Promise.all([
                                user.updateProfile({
                                    displayName: username
                                }),
                                // Thêm thông tin user vào Realtime Database
                                firebase.database().ref('users/' + user.uid).set({
                                    name: username,
                                    email: user.email,
                                    loyaltyPoints: 0, // Điểm thành viên mặc định
                                    memberLevel: 'Đồng', // Hạng thành viên mặc định
                                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                                })
                            ]);
                        })
                        .then(() => {
                            // Gửi thông báo cho admin khi có member mới đăng ký
                            generateNotification('fas fa-user-plus', 'bg-success', `Thành viên mới: ${username} (${email}) đã đăng ký tài khoản.`);
                            
                            const authModal = safeGetElement('auth-modal');
                            if (authModal) {
                                authModal.style.display = 'none';
                            }
                            Swal.fire({
                                title: 'Đăng ký thành công!',
                                icon: 'success',
                                confirmButtonColor: '#e67e22'
                            });
                        })
                        .catch((error) => {
                            Swal.fire({
                                title: 'Lỗi đăng ký!',
                                text: error.message,
                                icon: 'error',
                                confirmButtonColor: '#e67e22'
                            });
                        });
                });
            }

            // Xử lý quên mật khẩu
            if (forgotForm) {
                forgotForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const emailInput = safeGetElement('forgot-email');
                    
                    if (!emailInput) {
                        console.error('Forgot email input not found');
                        return;
                    }
                    
                    const email = emailInput.value;

                    firebase.auth().sendPasswordResetEmail(email)
                        .then(() => {
                            Swal.fire({
                                title: 'Email đã được gửi!',
                                text: 'Vui lòng kiểm tra email của bạn để đặt lại mật khẩu.',
                                icon: 'success',
                                confirmButtonColor: '#e67e22'
                            });
                        })
                        .catch((error) => {
                            Swal.fire({
                                title: 'Lỗi!',
                                text: error.message,
                                icon: 'error',
                                confirmButtonColor: '#e67e22'
                            });
                        });
                });
            }

            // Xử lý chuyển đổi giữa các form với kiểm tra an toàn
            const toRegisterBtn = safeGetElement('to-register');
            if (toRegisterBtn) {
                toRegisterBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (loginForm) loginForm.style.display = 'none';
                    if (registerForm) registerForm.style.display = 'block';
                    if (forgotForm) forgotForm.style.display = 'none';
                });
            }

            const toLoginBtn = safeGetElement('to-login');
            if (toLoginBtn) {
                toLoginBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (loginForm) loginForm.style.display = 'block';
                    if (registerForm) registerForm.style.display = 'none';
                    if (forgotForm) forgotForm.style.display = 'none';
                });
            }

            const toForgotBtn = safeGetElement('to-forgot');
            if (toForgotBtn) {
                toForgotBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (loginForm) loginForm.style.display = 'none';
                    if (registerForm) registerForm.style.display = 'none';
                    if (forgotForm) forgotForm.style.display = 'block';
                });
            }

            const backToLoginBtn = safeGetElement('back-to-login');
            if (backToLoginBtn) {
                backToLoginBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (loginForm) loginForm.style.display = 'block';
                    if (registerForm) registerForm.style.display = 'none';
                    if (forgotForm) forgotForm.style.display = 'none';
                });
            }

            // Xử lý đóng modal
            if (closeAuthModal) {
                closeAuthModal.addEventListener('click', () => {
                    const authModal = safeGetElement('auth-modal');
                    if (authModal) {
                        authModal.style.display = 'none';
                    }
                });
            }

            // Xử lý mở modal đăng nhập - kiểm tra element tồn tại
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const authModal = safeGetElement('auth-modal');
                    if (authModal) {
                        authModal.style.display = 'block';
                    }
                });
            }

            // Đóng modal khi click ra ngoài
            window.onclick = function (event) {
                const modal = document.getElementById('auth-modal');
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };

            // Theo dõi trạng thái đăng nhập
            firebase.auth().onAuthStateChanged(function (user) {
                const loginBtn = document.getElementById('login-btn');
                const contributeBtn = document.getElementById('open-contribute-modal');
                
                if (user) {
                    if (loginBtn) loginBtn.style.display = 'none';
                    if (userDropdown) userDropdown.style.display = 'block';
                    if (userName) userName.textContent = user.displayName || user.email;
                    
                    // Hiển thị nút đóng góp cẩm nang cho members đã đăng nhập
                    if (contributeBtn) contributeBtn.style.display = 'flex';
                } else {
                    if (loginBtn) loginBtn.style.display = 'block';
                    if (userDropdown) userDropdown.style.display = 'none';
                    
                    // Ẩn nút đóng góp khi chưa đăng nhập
                    if (contributeBtn) contributeBtn.style.display = 'none';
                }
            });

            // Xử lý đăng xuất
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    firebase.auth().signOut().then(() => {
                        Swal.fire({
                            title: 'Đăng xuất thành công!',
                            icon: 'success',
                            confirmButtonColor: '#e67e22'
                        });
                    }).catch((error) => {
                        Swal.fire({
                            title: 'Lỗi đăng xuất!',
                            text: error.message,
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                    });
                });
            }

            // --- Logic for Travel Guide Content ---
            const database = firebase.database();

            // === CÁC TÍNH NĂNG MỚI CHO CẨM NANG ===

            // Mở modal bình luận
            function openCommentModal(guideSlug, guideTitle) {
                document.getElementById('comment-guide-title').textContent = guideTitle;
                document.getElementById('comment-modal').style.display = 'block';
                window.currentCommentGuide = { slug: guideSlug, title: guideTitle };
                
                // Load comments cho guide này
                loadComments(guideSlug);
            }

            // Load tất cả comments cho một guide
            function loadComments(guideSlug) {
                const commentsContainer = document.getElementById('comments-container');
                
                firebase.database().ref(`guideComments/${guideSlug}`).orderByChild('timestamp').on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const commentsData = snapshot.val();
                        const comments = Object.keys(commentsData).map(key => ({
                            id: key,
                            ...commentsData[key]
                        })).reverse(); // Newest first
                        
                        commentsContainer.innerHTML = '';
                        
                        comments.forEach(comment => {
                            const commentElement = createCommentElement(comment);
                            commentsContainer.appendChild(commentElement);
                        });
                    } else {
                        commentsContainer.innerHTML = `
                            <div class="no-comments">
                                <i class="fas fa-comments" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                                <p>Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
                            </div>`;
                    }
                });
            }

            // Tạo element cho một comment
            function createCommentElement(comment) {
                const div = document.createElement('div');
                div.className = 'comment-item';
                div.dataset.commentId = comment.id || '';
                
                const userInitial = comment.userName ? comment.userName.charAt(0).toUpperCase() : 'U';
                const timeAgo = getTimeAgo(comment.timestamp);
                const likeCount = comment.likes ? Object.keys(comment.likes).length : 0;
                const dislikeCount = comment.dislikes ? Object.keys(comment.dislikes).length : 0;
                
                const imageHTML = comment.image ? `
                    <div class="comment-image" onclick="openImageViewer('${comment.image}')">
                        <img src="${comment.image}" alt="Comment image" style="max-width: 300px;">
                    </div>
                ` : '';
                
                div.innerHTML = `
                    <div class="comment-main">
                        <div class="comment-avatar">${userInitial}</div>
                        <div class="comment-content">
                            <div class="comment-author">${comment.userName || 'Ẩn danh'}</div>
                            <div class="comment-text">${comment.text}</div>
                            ${imageHTML}
                            <div class="comment-actions-bar">
                                <button class="comment-like-btn" onclick="toggleCommentLike('${comment.id}', 'like', this)">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="like-count">${likeCount}</span>
                                </button>
                                <button class="comment-dislike-btn" onclick="toggleCommentLike('${comment.id}', 'dislike', this)">
                                    <i class="fas fa-thumbs-down"></i>
                                    <span class="dislike-count">${dislikeCount}</span>
                                </button>
                                <button class="comment-reply-btn" onclick="showReplyForm('${comment.id}')">
                                    <i class="fas fa-reply"></i>
                                    Trả lời
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="comment-time">${timeAgo}</div>
                    <div class="comment-reply-form" id="reply-form-${comment.id}">
                        <textarea class="comment-reply-input" placeholder="Viết trả lời..." rows="2"></textarea>
                        <div class="comment-reply-actions">
                            <button class="comment-reply-cancel" onclick="hideReplyForm('${comment.id}')">Hủy</button>
                            <button class="comment-reply-submit" onclick="submitReply('${comment.id}')">Trả lời</button>
                        </div>
                    </div>
                    <div class="comment-replies" id="replies-${comment.id}"></div>
                `;
                
                // Load replies if exist
                if (comment.replies) {
                    const repliesContainer = div.querySelector(`#replies-${comment.id}`);
                    Object.values(comment.replies).forEach(reply => {
                        const replyElement = createReplyElement(reply);
                        repliesContainer.appendChild(replyElement);
                    });
                }
                
                return div;
            }

            // Tạo element cho reply
            function createReplyElement(reply) {
                const div = document.createElement('div');
                div.className = 'comment-item';
                div.style.marginBottom = '10px';
                
                const userInitial = reply.userName ? reply.userName.charAt(0).toUpperCase() : 'U';
                const timeAgo = getTimeAgo(reply.timestamp);
                
                div.innerHTML = `
                    <div class="comment-main">
                        <div class="comment-avatar" style="width: 32px; height: 32px; font-size: 14px;">${userInitial}</div>
                        <div class="comment-content">
                            <div class="comment-author">${reply.userName || 'Ẩn danh'}</div>
                            <div class="comment-text">${reply.text}</div>
                        </div>
                    </div>
                    <div class="comment-time" style="margin-left: 44px;">${timeAgo}</div>
                `;
                
                return div;
            }

            // Tính thời gian đã qua
            function getTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'Vừa xong';
                if (minutes < 60) return `${minutes} phút trước`;
                if (hours < 24) return `${hours} giờ trước`;
                return `${days} ngày trước`;
            }

            // Submit comment
            function submitComment() {
                const user = firebase.auth().currentUser;
                if (!user) {
                    Swal.fire({
                        title: 'Yêu cầu đăng nhập',
                        text: 'Vui lòng đăng nhập để bình luận',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Đăng nhập',
                        cancelButtonText: 'Hủy',
                        confirmButtonColor: '#1a237e',
                        cancelButtonColor: '#d33'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            document.getElementById('auth-modal').style.display = 'block';
                        }
                    });
                    return;
                }

                const commentInput = document.getElementById('comment-input');
                const commentText = commentInput.value.trim();
                const imageFile = document.getElementById('comment-image-input').files[0];
                
                if (!commentText && !imageFile) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Vui lòng nhập nội dung bình luận hoặc chọn ảnh',
                        icon: 'error',
                        confirmButtonColor: '#e67e22'
                    });
                    return;
                }

                const guideSlug = window.currentCommentGuide.slug;
                const submitBtn = document.getElementById('comment-submit');
                
                // Disable button và hiển thị loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                // Tạo comment object
                const comment = {
                    text: commentText || '',
                    userName: user.displayName || user.email,
                    userId: user.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                // Function để lưu comment
                const saveComment = (commentData) => {
                    return firebase.database().ref(`guideComments/${guideSlug}`).push(commentData)
                        .then(() => {
                            commentInput.value = '';
                            commentInput.style.height = 'auto';
                            removeCommentImage();
                            
                            // Toast notification
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true
                            });
                            Toast.fire({
                                icon: 'success',
                                title: 'Bình luận đã được đăng!'
                            });
                        })
                        .catch(error => {
                            Swal.fire({
                                title: 'Lỗi!',
                                text: 'Không thể đăng bình luận. Vui lòng thử lại sau.',
                                icon: 'error',
                                confirmButtonColor: '#e67e22'
                            });
                            console.error("Error posting comment:", error);
                        })
                        .finally(() => {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                        });
                };

                // Nếu có ảnh, upload trước
                if (imageFile) {
                    uploadImageToImgur(imageFile)
                        .then(imageUrl => {
                            comment.image = imageUrl;
                            return saveComment(comment);
                        })
                        .catch(error => {
                            console.error('Error uploading image:', error);
                            Swal.fire({
                                title: 'Lỗi upload ảnh!',
                                text: 'Không thể tải ảnh lên. Bình luận sẽ được đăng không có ảnh.',
                                icon: 'warning',
                                confirmButtonColor: '#e67e22'
                            });
                            // Đăng comment không có ảnh
                            saveComment(comment);
                        });
                } else {
                    // Không có ảnh, đăng comment thông thường
                    saveComment(comment);
                }
            }

            // Load comment count cho tất cả guides
            function loadAllCommentsCount() {
                firebase.database().ref('guideComments').on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const allComments = snapshot.val();
                        Object.keys(allComments).forEach(guideSlug => {
                            const comments = allComments[guideSlug];
                            const commentCount = Object.keys(comments).length;
                            
                            // Cập nhật số comment cho guide này
                            document.querySelectorAll(`[data-guide-slug="${guideSlug}"] .comment-count`).forEach(element => {
                                element.textContent = commentCount;
                            });
                        });
                    }
                });
            }

            // Đóng modal comment
            function closeCommentModal() {
                document.getElementById('comment-modal').style.display = 'none';
                removeCommentImage(); // Clear any image preview when closing
            }

            // Upload ảnh lên Imgur
            function uploadImageToImgur(imageFile) {
                const clientId = 'a3b8e5ec21a4b1b'; // Imgur Client ID miễn phí
                
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    
                    fetch('https://api.imgur.com/3/image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Client-ID ${clientId}`
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            resolve(data.data.link);
                        } else {
                            reject(new Error('Upload failed'));
                        }
                    })
                    .catch(error => {
                        reject(error);
                    });
                });
            }

            // Xử lý preview ảnh
            function handleImagePreview() {
                const input = document.getElementById('comment-image-input');
                const preview = document.getElementById('comment-image-preview');
                const previewImage = document.getElementById('comment-preview-image');
                
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Kiểm tra kích thước file (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            Swal.fire({
                                title: 'Ảnh quá lớn!',
                                text: 'Vui lòng chọn ảnh có kích thước nhỏ hơn 5MB',
                                icon: 'error',
                                confirmButtonColor: '#e67e22'
                            });
                            input.value = '';
                            return;
                        }
                        
                        // Hiển thị preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Xóa ảnh preview
            function removeCommentImage() {
                const input = document.getElementById('comment-image-input');
                const preview = document.getElementById('comment-image-preview');
                
                input.value = '';
                preview.style.display = 'none';
            }

            // Toggle like/dislike comment
            function toggleCommentLike(commentId, type, button) {
                const user = firebase.auth().currentUser;
                if (!user) {
                    Swal.fire({
                        title: 'Yêu cầu đăng nhập',
                        text: 'Vui lòng đăng nhập để tương tác',
                        icon: 'warning',
                        confirmButtonColor: '#1a237e'
                    });
                    return;
                }

                const guideSlug = window.currentCommentGuide.slug;
                const isActive = button.classList.contains('active');
                const countElement = button.querySelector(type === 'like' ? '.like-count' : '.dislike-count');
                
                button.disabled = true;
                
                if (isActive) {
                    // Remove like/dislike
                    firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${type}s/${user.uid}`)
                        .remove()
                        .then(() => {
                            button.classList.remove('active');
                            const currentCount = parseInt(countElement.textContent) || 0;
                            countElement.textContent = Math.max(0, currentCount - 1);
                        })
                        .finally(() => {
                            button.disabled = false;
                        });
                } else {
                    // Add like/dislike
                    const oppositeType = type === 'like' ? 'dislike' : 'like';
                    const oppositeButton = button.parentElement.querySelector(`.comment-${oppositeType}-btn`);
                    
                    // Remove opposite reaction if exists
                    if (oppositeButton.classList.contains('active')) {
                        firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${oppositeType}s/${user.uid}`)
                            .remove()
                            .then(() => {
                                oppositeButton.classList.remove('active');
                                const oppositeCount = oppositeButton.querySelector(`.${oppositeType}-count`);
                                const currentCount = parseInt(oppositeCount.textContent) || 0;
                                oppositeCount.textContent = Math.max(0, currentCount - 1);
                            });
                    }
                    
                    // Add new reaction
                    firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${type}s/${user.uid}`)
                        .set({
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            userName: user.displayName || user.email
                        })
                        .then(() => {
                            button.classList.add('active');
                            const currentCount = parseInt(countElement.textContent) || 0;
                            countElement.textContent = currentCount + 1;
                        })
                        .finally(() => {
                            button.disabled = false;
                        });
                }
            }

            // Show reply form
            function showReplyForm(commentId) {
                const user = firebase.auth().currentUser;
                if (!user) {
                    Swal.fire({
                        title: 'Yêu cầu đăng nhập',
                        text: 'Vui lòng đăng nhập để trả lời',
                        icon: 'warning',
                        confirmButtonColor: '#1a237e'
                    });
                    return;
                }
                
                const replyForm = document.getElementById(`reply-form-${commentId}`);
                replyForm.style.display = 'block';
                replyForm.querySelector('.comment-reply-input').focus();
            }

            // Hide reply form
            function hideReplyForm(commentId) {
                const replyForm = document.getElementById(`reply-form-${commentId}`);
                replyForm.style.display = 'none';
                replyForm.querySelector('.comment-reply-input').value = '';
            }

            // Submit reply
            function submitReply(commentId) {
                const user = firebase.auth().currentUser;
                if (!user) return;
                
                const replyForm = document.getElementById(`reply-form-${commentId}`);
                const replyInput = replyForm.querySelector('.comment-reply-input');
                const replyText = replyInput.value.trim();
                
                if (!replyText) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Vui lòng nhập nội dung trả lời',
                        icon: 'error',
                        confirmButtonColor: '#e67e22'
                    });
                    return;
                }
                
                const guideSlug = window.currentCommentGuide.slug;
                const reply = {
                    text: replyText,
                    userName: user.displayName || user.email,
                    userId: user.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                firebase.database().ref(`guideComments/${guideSlug}/${commentId}/replies`).push(reply)
                    .then(() => {
                        hideReplyForm(commentId);
                        
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true
                        });
                        Toast.fire({
                            icon: 'success',
                            title: 'Trả lời đã được đăng!'
                        });
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Không thể đăng trả lời. Vui lòng thử lại.',
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                        console.error("Error posting reply:", error);
                    });
            }

            // Open image viewer
            function openImageViewer(imageUrl) {
                const modal = document.getElementById('image-viewer-modal');
                const image = document.getElementById('image-viewer-image');
                
                image.src = imageUrl;
                modal.style.display = 'block';
            }

            // Close image viewer
            function closeImageViewer() {
                document.getElementById('image-viewer-modal').style.display = 'none';
            }

            // Mở modal đánh giá
            function openGuideRatingModal(guideId) {
                // Kiểm tra đăng nhập
                const user = firebase.auth().currentUser;
                if (!user) {
                    Swal.fire({
                        title: 'Yêu cầu đăng nhập',
                        text: 'Vui lòng đăng nhập để đánh giá cẩm nang',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Đăng nhập',
                        cancelButtonText: 'Hủy',
                        confirmButtonColor: '#1a237e',
                        cancelButtonColor: '#d33'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            document.getElementById('auth-modal').style.display = 'block';
                        }
                    });
                    return;
                }

                // Lấy thông tin cẩm nang
                firebase.database().ref(`travelGuides/${guideId}`).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const guide = snapshot.val();
                            document.getElementById('rating-guide-title').textContent = guide.title;
                            document.getElementById('guide-rating-modal').style.display = 'block';
                            window.currentRatingGuide = { id: guideId, title: guide.title };
                            
                            // Reset rating stars
                            window.currentRating = 0;
                            document.querySelectorAll('#modal-rating-stars i').forEach(star => {
                                star.classList.remove('fas');
                                star.classList.add('far');
                            });
                        }
                    });
            }

            // Toggle yêu thích
            function toggleFavorite(guideSlug, button) {
                const user = firebase.auth().currentUser;
                if (!user) {
                    Swal.fire({
                        title: 'Yêu cầu đăng nhập',
                        text: 'Vui lòng đăng nhập để lưu cẩm nang yêu thích',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Đăng nhập',
                        cancelButtonText: 'Hủy',
                        confirmButtonColor: '#1a237e',
                        cancelButtonColor: '#d33'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            document.getElementById('auth-modal').style.display = 'block';
                        }
                    });
                    return;
                }

                const isFavorited = button.classList.contains('active');
                
                // Disable button để tránh spam click
                button.disabled = true;
                
                // Thêm animation cho button
                button.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    button.style.transform = 'scale(1)';
                }, 200);

                if (isFavorited) {
                    // Bỏ yêu thích - xóa từ cả hai nguồn để đảm bảo
                    const favoriteRef = firebase.database().ref(`users/${user.uid}/favorites/${guideSlug}`);
                    const travelGuideLikesRef = firebase.database().ref(`travelGuides/${guideSlug}/likes/${user.uid}`);
                    const userContributionLikesRef = firebase.database().ref(`userContributions/${guideSlug}/likes/${user.uid}`);
                    
                    Promise.all([
                        favoriteRef.remove(),
                        travelGuideLikesRef.remove(),
                        userContributionLikesRef.remove()
                    ]).then(() => {
                        // Cập nhật UI ngay lập tức
                        button.classList.remove('active');
                        button.querySelector('i').classList.remove('fas');
                        button.querySelector('i').classList.add('far');
                        
                        // Hiển thị thông báo nhỏ
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true
                        });
                        Toast.fire({
                            icon: 'info',
                            title: 'Đã bỏ thích'
                        });
                    }).finally(() => {
                        button.disabled = false;
                    });
                } else {
                    // Thêm yêu thích - cần xác định nguồn dữ liệu để lưu đúng chỗ
                    const favoriteRef = firebase.database().ref(`users/${user.uid}/favorites/${guideSlug}`);
                    
                    // Function để xác định nguồn và lưu like
                    const saveLikeToCorrectSource = async () => {
                        let likeSaved = false;
                        
                        // Thử kiểm tra xem guide có trong travelGuides không
                        try {
                            const travelGuideSnapshot = await firebase.database().ref(`travelGuides/${guideSlug}`).once('value');
                            if (travelGuideSnapshot.exists()) {
                                await firebase.database().ref(`travelGuides/${guideSlug}/likes/${user.uid}`).set({
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    userName: user.displayName || user.email
                                });
                                likeSaved = true;
                                console.log('Like saved to travelGuides');
                            }
                        } catch (error) {
                            console.log('Guide not found in travelGuides');
                        }
                        
                        // Nếu không có trong travelGuides, lưu vào userContributions
                        if (!likeSaved) {
                            try {
                                const userContributionSnapshot = await firebase.database().ref(`userContributions/${guideSlug}`).once('value');
                                if (userContributionSnapshot.exists()) {
                                    await firebase.database().ref(`userContributions/${guideSlug}/likes/${user.uid}`).set({
                                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                                        userName: user.displayName || user.email
                                    });
                                    console.log('Like saved to userContributions');
                                }
                            } catch (error) {
                                console.error('Error saving like to userContributions:', error);
                            }
                        }
                    };
                    
                    Promise.all([
                        favoriteRef.set({
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            guideSlug: guideSlug
                        }),
                        saveLikeToCorrectSource()
                    ]).then(() => {
                        // Cập nhật UI ngay lập tức
                        button.classList.add('active');
                        button.querySelector('i').classList.remove('far');
                        button.querySelector('i').classList.add('fas');
                        
                        // Hiển thị thông báo nhỏ với animation tim
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true
                        });
                        Toast.fire({
                            icon: 'success',
                            title: 'Đã thích! ❤️'
                        });
                    }).finally(() => {
                        button.disabled = false;
                    });
                }
            }

            // Load tất cả cẩm nang để hiển thị số like real-time
            function loadAllGuidesLikeCount() {
                firebase.database().ref('travelGuides').on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const guides = snapshot.val();
                        Object.keys(guides).forEach(guideSlug => {
                            const guide = guides[guideSlug];
                            
                            // Đếm số like từ object likes thay vì dựa vào likeCount
                            const likesCount = guide.likes ? Object.keys(guide.likes).length : 0;
                            
                            // Cập nhật tất cả button có cùng guideSlug
                            document.querySelectorAll(`[data-guide-slug="${guideSlug}"] .like-count`).forEach(element => {
                                element.textContent = likesCount;
                            });
                        });
                    }
                });
            }

            // Load trạng thái yêu thích và số lượt thích
            function loadFavoriteStatus(guideSlug, button) {
                const user = firebase.auth().currentUser;
                
                // Load số lượt thích từ cả hai nguồn
                const loadLikeCount = async () => {
                    let totalLikes = 0;
                    
                    // Load từ travelGuides
                    try {
                        const travelGuidesLikesSnapshot = await firebase.database().ref(`travelGuides/${guideSlug}/likes`).once('value');
                        if (travelGuidesLikesSnapshot.exists()) {
                            totalLikes += Object.keys(travelGuidesLikesSnapshot.val()).length;
                        }
                    } catch (error) {
                        console.log('No likes in travelGuides for:', guideSlug);
                    }
                    
                    // Load từ guideLikes (cho userContributions)
                    try {
                        const guideLikesSnapshot = await firebase.database().ref(`guideLikes/${guideSlug}`).once('value');
                        if (guideLikesSnapshot.exists()) {
                            totalLikes += Object.keys(guideLikesSnapshot.val()).length;
                        }
                    } catch (error) {
                        console.log('No likes in guideLikes for:', guideSlug);
                    }
                    
                    // Cập nhật UI
                    const likeCountElement = button.querySelector('.like-count');
                    if (likeCountElement) {
                        likeCountElement.textContent = totalLikes;
                    }
                };
                
                // Load số lượt thích
                loadLikeCount();

                if (!user) return;

                // Kiểm tra trạng thái yêu thích của user hiện tại
                firebase.database().ref(`users/${user.uid}/favorites/${guideSlug}`).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            button.classList.add('active');
                            button.querySelector('i').classList.remove('far');
                            button.querySelector('i').classList.add('fas');
                        }
                    });
            }

            // Submit đánh giá cẩm nang
            function submitGuideRating() {
                const user = firebase.auth().currentUser;
                if (!user) return;

                const guide = window.currentRatingGuide;
                const rating = window.currentRating || 0;
                const comment = document.getElementById('guide-comment').value;

                console.log('Submitting rating:', rating, 'for guide:', guide);

                if (rating == 0) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Vui lòng chọn số sao đánh giá',
                        icon: 'error',
                        confirmButtonColor: '#e67e22'
                    });
                    return;
                }

                // Hiển thị loading
                Swal.fire({
                    title: 'Đang gửi...',
                    text: 'Vui lòng đợi trong giây lát',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Lưu đánh giá vào Firebase
                const ratingRef = firebase.database().ref(`guideRatings/${guide.id}/${user.uid}`);
                ratingRef.set({
                    rating: parseInt(rating),
                    comment: comment,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userName: user.displayName || user.email
                }).then(() => {
                    // Cập nhật rating trung bình
                    updateGuideAverageRating(guide.id);
                    
                    Swal.fire({
                        title: 'Thành công!',
                        text: 'Cảm ơn bạn đã đánh giá cẩm nang',
                        icon: 'success',
                        confirmButtonColor: '#e67e22'
                    });
                    
                    closeRatingModal();
                    loadGuideRatings(); // Reload ratings
                }).catch(error => {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Không thể gửi đánh giá. Vui lòng thử lại sau.',
                        icon: 'error',
                        confirmButtonColor: '#e67e22'
                    });
                    console.error("Error submitting rating:", error);
                });
            }

            // Cập nhật rating trung bình
            function updateGuideAverageRating(guideId) {
                firebase.database().ref(`guideRatings/${guideId}`).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const ratings = Object.values(snapshot.val());
                            const totalRating = ratings.reduce((sum, rating) => sum + rating.rating, 0);
                            const averageRating = totalRating / ratings.length;
                            
                            // Lưu rating trung bình
                            firebase.database().ref(`travelGuides/${guideId}/averageRating`).set(averageRating);
                            firebase.database().ref(`travelGuides/${guideId}/ratingCount`).set(ratings.length);
                        }
                    });
            }

            // Load ratings cho tất cả cẩm nang
            function loadGuideRatings() {
                firebase.database().ref('travelGuides').once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const guides = snapshot.val();
                            Object.keys(guides).forEach(guideId => {
                                const guide = guides[guideId];
                                const ratingCount = guide.ratingCount || 0;
                                const averageRating = guide.averageRating || 0;
                                
                                // Cập nhật hiển thị rating
                                const ratingElement = document.querySelector(`[data-guide-id="${guideId}"]`);
                                if (ratingElement) {
                                    const countElement = ratingElement.nextElementSibling;
                                    if (countElement) {
                                        countElement.textContent = `${ratingCount} đánh giá`;
                                    }
                                    
                                    // Hiển thị sao trung bình
                                    const stars = ratingElement.querySelectorAll('i');
                                    stars.forEach((star, index) => {
                                        if (index < Math.round(averageRating)) {
                                            star.classList.remove('far');
                                            star.classList.add('fas');
                                        } else {
                                            star.classList.remove('fas');
                                            star.classList.add('far');
                                        }
                                    });
                                }
                            });
                        }
                    });
            }

            // Đóng modal đánh giá
            function closeRatingModal() {
                document.getElementById('guide-rating-modal').style.display = 'none';
                document.getElementById('guide-comment').value = '';
                window.currentRating = 0;
                highlightModalStars(0); // Reset stars
            }

            // Highlight stars trong modal
            function highlightModalStars(rating) {
                document.querySelectorAll('#modal-rating-stars i').forEach(star => {
                    const starRating = star.dataset.rating;
                    if (starRating <= rating) {
                        star.classList.remove('far');
                        star.classList.add('fas');
                    } else {
                        star.classList.remove('fas');
                        star.classList.add('far');
                    }
                });
            }

            // Load travel guides data - Load from both travelGuides and approved userContributions
            console.log('DOM ready, loading travel guides...');
            
            // Function để load tất cả guides từ nhiều nguồn
            async function loadAllGuides() {
                try {
                    let allGuides = [];
                    
                    // Load từ travelGuides (guides cũ)
                    const travelGuidesSnapshot = await firebase.database().ref('travelGuides').once('value');
                    if (travelGuidesSnapshot.exists()) {
                        const travelGuidesData = travelGuidesSnapshot.val();
                        const travelGuides = Object.keys(travelGuidesData).map(key => ({
                            ...travelGuidesData[key],
                            slug: key,
                            source: 'travelGuides' // Để biết nguồn gốc
                        }));
                        allGuides = allGuides.concat(travelGuides);
                        console.log('Loaded from travelGuides:', travelGuides.length);
                    }
                    
                    // Load từ userContributions (guides đã được duyệt)
                    const userContributionsSnapshot = await firebase.database().ref('userContributions').once('value');
                    if (userContributionsSnapshot.exists()) {
                        const userContributionsData = userContributionsSnapshot.val();
                        const approvedContributions = Object.keys(userContributionsData)
                            .filter(key => userContributionsData[key].status === 'approved')
                            .map(key => ({
                                ...userContributionsData[key],
                                slug: userContributionsData[key].slug || key, // Ưu tiên slug có sẵn, nếu không thì dùng key
                                id: key, // Giữ lại key gốc để có thể truy vấn
                                source: 'userContributions', // Để biết nguồn gốc
                                // Đảm bảo có đủ fields cần thiết
                                title: userContributionsData[key].title,
                                summary: userContributionsData[key].summary,
                                main_image: userContributionsData[key].main_image || '/images/default-guide.jpg',
                                is_featured_on_homepage: userContributionsData[key].is_featured_on_homepage || false,
                                approvedAt: userContributionsData[key].approvedAt || userContributionsData[key].submittedAt
                            }));
                        allGuides = allGuides.concat(approvedContributions);
                        console.log('Loaded from approved userContributions:', approvedContributions.length);
                    }
                    
                    console.log('Total guides loaded:', allGuides.length);
                    console.log('All guides:', allGuides);
                    
                    if (allGuides.length > 0) {
                        const featuredGuides = allGuides.filter(g => g.is_featured_on_homepage === true).slice(0, 4);
                        const latestGuides = allGuides.sort((a, b) => {
                            // Sắp xếp theo last_updated hoặc approvedAt hoặc submittedAt
                            const dateA = new Date(a.last_updated || a.approvedAt || a.submittedAt || '2024-01-01');
                            const dateB = new Date(b.last_updated || b.approvedAt || b.submittedAt || '2024-01-01');
                            return dateB - dateA;
                        }).slice(0, 8);
                        
                        console.log('Featured guides count:', featuredGuides.length);
                        console.log('Latest guides count:', latestGuides.length);
                        console.log('Featured guides:', featuredGuides);
                        console.log('Latest guides:', latestGuides);
                        
                        renderGuides(featuredGuides, 'featured-guides-container');
                        renderGuides(latestGuides, 'latest-guides-container');
                        
                        // Load real-time like count cho tất cả cẩm nang
                        loadAllGuidesLikeCount();
                    } else {
                        console.log('No guides data found');
                        document.getElementById('featured-guides-container').innerHTML = '<p class="col-12">Không tìm thấy cẩm nang nổi bật.</p>';
                        document.getElementById('latest-guides-container').innerHTML = '<p class="col-12">Không tìm thấy cẩm nang mới nhất.</p>';
                    }
                } catch (error) {
                    console.error("Firebase read error:", error);
                    document.getElementById('featured-guides-container').innerHTML = '<p class="col-12">Lỗi khi tải dữ liệu.</p>';
                    document.getElementById('latest-guides-container').innerHTML = '<p class="col-12">Lỗi khi tải dữ liệu.</p>';
                }
            }
            
            // Gọi function load data
            loadAllGuides();
        });

        // === RENDER GUIDES FUNCTION - Moved outside DOMContentLoaded ===
        function renderGuides(guides, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            if (guides.length === 0) {
                container.innerHTML = '<p class="col-12">Không có cẩm nang nào để hiển thị.</p>';
                return;
            }
            
            guides.forEach(guide => {
                const guideHTML = `
                    <div class="col-md-6">
                        <div class="guide-card">
                            <div class="guide-card-content">
                                <a href="destination_detail.html?slug=${guide.slug}" class="guide-card-link">
                                    <img src="${guide.main_image || '/images/default-guide.jpg'}" alt="${guide.title}" class="guide-item-icon">
                                    <div class="guide-item-info">
                                        <span class="guide-item-title">${guide.title}</span>
                                        <div class="guide-rating-section">
                                            <div class="guide-rating">
                                                <span class="rating-stars" data-guide-id="${guide.slug}">
                                                    <i class="far fa-star" data-rating="1"></i>
                                                    <i class="far fa-star" data-rating="2"></i>
                                                    <i class="far fa-star" data-rating="3"></i>
                                                    <i class="far fa-star" data-rating="4"></i>
                                                    <i class="far fa-star" data-rating="5"></i>
                                                </span>
                                                <span class="rating-count" data-guide-id="${guide.slug}">0 đánh giá</span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                <div class="guide-actions">
                                    <button class="btn btn-sm btn-outline-primary comment-btn" data-guide-slug="${guide.slug}" data-guide-title="${guide.title}">
                                        <i class="fas fa-comment"></i> 
                                        <span class="comment-count">0</span> Bình luận
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger favorite-btn" data-guide-slug="${guide.slug}">
                                        <i class="far fa-heart"></i>
                                        <span class="like-count">0</span> Like
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                container.innerHTML += guideHTML;
            });
            
            // Thêm event listeners cho các nút mới
            if (typeof initializeGuideActions === 'function') {
                initializeGuideActions();
            }
        }

        // === HELPER FUNCTIONS - Add missing functions ===
        function loadAllCommentsCount() {
            // Implementation for loading comment counts
            firebase.database().ref('guideComments').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const comments = snapshot.val();
                    Object.keys(comments).forEach(guideSlug => {
                        const commentCount = Object.keys(comments[guideSlug]).length;
                        const countElement = document.querySelector(`[data-guide-slug="${guideSlug}"] .comment-count`);
                        if (countElement) {
                            countElement.textContent = commentCount;
                        }
                    });
                }
            });
        }

        function loadAllGuidesLikeCount() {
            // Load từ travelGuides - real-time listener
            firebase.database().ref('travelGuides').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const guides = snapshot.val();
                    Object.keys(guides).forEach(guideSlug => {
                        const likeCount = guides[guideSlug].likes ? Object.keys(guides[guideSlug].likes).length : 0;
                        // Cập nhật tất cả buttons có cùng guideSlug
                        document.querySelectorAll(`[data-guide-slug="${guideSlug}"] .like-count`).forEach(element => {
                            element.textContent = likeCount;
                        });
                    });
                }
            });
            
            // Load từ guideLikes (cho userContributions) - real-time listener
            firebase.database().ref('guideLikes').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const guideLikes = snapshot.val();
                    Object.keys(guideLikes).forEach(guideSlug => {
                        const likeCount = Object.keys(guideLikes[guideSlug]).length;
                        // Chỉ cập nhật nếu guide này không có trong travelGuides
                        // (để tránh ghi đè số like của travelGuides)
                        firebase.database().ref(`travelGuides/${guideSlug}`).once('value').then(travelGuideSnapshot => {
                            if (!travelGuideSnapshot.exists()) {
                                // Guide này từ userContributions, cập nhật từ guideLikes
                                document.querySelectorAll(`[data-guide-slug="${guideSlug}"] .like-count`).forEach(element => {
                                    element.textContent = likeCount;
                                });
                            }
                        });
                    });
                }
            });
        }

        function loadFavoriteStatus(guideSlug, button) {
            const user = firebase.auth().currentUser;
            
            // Function để load số lượt thích từ cả hai nguồn
            const loadLikeCount = async () => {
                let likesCount = 0;
                
                // Thử load từ travelGuides trước
                try {
                    const travelGuideSnapshot = await firebase.database().ref(`travelGuides/${guideSlug}/likes`).once('value');
                    if (travelGuideSnapshot.exists()) {
                        likesCount = Object.keys(travelGuideSnapshot.val()).length;
                    }
                } catch (error) {
                    console.log('No likes in travelGuides for:', guideSlug);
                }
                
                // Nếu không có, thử load từ userContributions
                if (likesCount === 0) {
                    try {
                        const userContributionSnapshot = await firebase.database().ref(`userContributions/${guideSlug}/likes`).once('value');
                        if (userContributionSnapshot.exists()) {
                            likesCount = Object.keys(userContributionSnapshot.val()).length;
                        }
                    } catch (error) {
                        console.log('No likes in userContributions for:', guideSlug);
                    }
                }
                
                // Cập nhật UI
                const likeCountElement = button.querySelector('.like-count');
                if (likeCountElement) {
                    likeCountElement.textContent = likesCount;
                }
            };
            
            // Load số lượt thích
            loadLikeCount();

            if (!user) return;

            // Kiểm tra trạng thái yêu thích của user hiện tại
            firebase.database().ref(`users/${user.uid}/favorites/${guideSlug}`).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        button.classList.add('active');
                        button.querySelector('i').classList.remove('far');
                        button.querySelector('i').classList.add('fas');
                    }
                });
        }

        function loadGuideRatings() {
            // Implementation for loading guide ratings from both sources
            
            // Load từ travelGuides
            firebase.database().ref('travelGuides').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const guides = snapshot.val();
                        Object.keys(guides).forEach(guideSlug => {
                            const ratingElement = document.querySelector(`[data-guide-id="${guideSlug}"]`);
                            if (ratingElement) {
                                const stars = ratingElement.querySelectorAll('i');
                                stars.forEach((star, index) => {
                                    if (index < 4) { // Default 4 stars
                                        star.classList.remove('far');
                                        star.classList.add('fas');
                                    }
                                });
                            }
                        });
                    }
                });
                
            // Load từ userContributions (approved)
            firebase.database().ref('userContributions').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const contributions = snapshot.val();
                        Object.keys(contributions).forEach(contributionSlug => {
                            const contribution = contributions[contributionSlug];
                            if (contribution.status === 'approved') {
                                const ratingElement = document.querySelector(`[data-guide-id="${contributionSlug}"]`);
                                if (ratingElement) {
                                    const stars = ratingElement.querySelectorAll('i');
                                    stars.forEach((star, index) => {
                                        if (index < 4) { // Default 4 stars
                                            star.classList.remove('far');
                                            star.classList.add('fas');
                                        }
                                    });
                                }
                            }
                        });
                    }
                });
        }

        // === INITIALIZE GUIDE ACTIONS - Moved to global scope ===
        function initializeGuideActions() {
            // Event listeners cho rating stars
            document.querySelectorAll('.rating-stars i').forEach(star => {
                star.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const guideId = this.closest('.rating-stars').dataset.guideId;
                    openGuideRatingModal(guideId);
                });
            });

            // Event listeners cho comment buttons
            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const guideSlug = this.dataset.guideSlug;
                    const guideTitle = this.dataset.guideTitle;
                    openCommentModal(guideSlug, guideTitle);
                });
            });

            // Load comment count cho tất cả cẩm nang
            if (typeof loadAllCommentsCount === 'function') {
                loadAllCommentsCount();
            }

            // Event listeners cho favorite buttons
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const guideSlug = this.dataset.guideSlug;
                    toggleFavorite(guideSlug, this);
                });
                
                // Load trạng thái yêu thích và số lượt thích
                const guideSlug = btn.dataset.guideSlug;
                if (typeof loadFavoriteStatus === 'function') {
                    loadFavoriteStatus(guideSlug, btn);
                }
            });

            // Load ratings cho tất cả cẩm nang
            if (typeof loadGuideRatings === 'function') {
                loadGuideRatings();
            }
        }

        // === GLOBAL FUNCTIONS ===
        // Các functions này cần được define ở global scope để có thể gọi từ onclick

        // Mở modal bình luận
        function openCommentModal(guideSlug, guideTitle) {
            console.log('Opening comment modal for:', guideSlug, guideTitle);
            
            const modalTitleElement = document.getElementById('comment-guide-title');
            const modalElement = document.getElementById('comment-modal');
            
            if (!modalTitleElement) {
                console.error('Element comment-guide-title not found!');
                return;
            }
            
            if (!modalElement) {
                console.error('Element comment-modal not found!');
                return;
            }
            
            modalTitleElement.textContent = guideTitle;
            modalElement.style.display = 'block';
            window.currentCommentGuide = { slug: guideSlug, title: guideTitle };
            
            console.log('Current comment guide set to:', window.currentCommentGuide);
            
            // Load comments cho guide này
            loadComments(guideSlug);
        }

        // Đóng modal comment
        function closeCommentModal() {
            document.getElementById('comment-modal').style.display = 'none';
            removeCommentImage();
        }

        // Submit comment
        function submitComment() {
            console.log('submitComment function called');
            
            // Kiểm tra kết nối mạng
            if (!navigator.onLine) {
                console.log('No internet connection');
                Swal.fire({
                    title: 'Không có kết nối!',
                    text: 'Vui lòng kiểm tra kết nối internet và thử lại.',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                return;
            }

            const user = firebase.auth().currentUser;
            console.log('Current user:', user);
            
            if (!user) {
                console.log('User not authenticated');
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Vui lòng đăng nhập để bình luận',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Đăng nhập',
                    cancelButtonText: 'Hủy',
                    confirmButtonColor: '#1a237e',
                    cancelButtonColor: '#d33'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('auth-modal').style.display = 'block';
                    }
                });
                return;
            }

            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            const imageFile = document.getElementById('comment-image-input').files[0];
            
            console.log('Comment text:', commentText);
            console.log('Image file:', imageFile);
            
            if (!commentText && !imageFile) {
                console.log('No content to post');
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Vui lòng nhập nội dung bình luận hoặc chọn ảnh',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                return;
            }

            const guideSlug = window.currentCommentGuide.slug;
            console.log('Guide slug:', guideSlug);
            
            const submitBtn = document.getElementById('comment-submit');
            
            // Disable button và hiển thị loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // Tạo comment object
            const comment = {
                text: commentText || '',
                userName: user.displayName || user.email,
                userId: user.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            console.log('Comment object:', comment);

            // Function để lưu comment
            const saveComment = (commentData) => {
                console.log('Saving comment:', commentData);
                return firebase.database().ref(`guideComments/${guideSlug}`).push(commentData)
                    .then(() => {
                        console.log('Comment saved successfully');
                        commentInput.value = '';
                        commentInput.style.height = 'auto';
                        removeCommentImage();
                        
                        // Toast notification
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true
                        });
                        Toast.fire({
                            icon: 'success',
                            title: 'Bình luận đã được đăng!'
                        });
                    })
                    .catch(error => {
                        console.error("Error posting comment:", error);
                        let errorMessage = 'Không thể đăng bình luận. Vui lòng thử lại sau.';
                        
                        if (error.code === 'PERMISSION_DENIED') {
                            errorMessage = 'Bạn không có quyền đăng bình luận. Vui lòng đăng nhập lại.';
                        } else if (error.code === 'NETWORK_ERROR') {
                            errorMessage = 'Lỗi kết nối mạng. Vui lòng kiểm tra internet và thử lại.';
                        }
                        
                        Swal.fire({
                            title: 'Lỗi!',
                            text: errorMessage,
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    });
            };

            // Nếu có ảnh, upload trước
            if (imageFile) {
                console.log('Uploading image...');
                uploadImageToImgur(imageFile)
                    .then(imageUrl => {
                        console.log('Image uploaded successfully:', imageUrl);
                        comment.image = imageUrl;
                        return saveComment(comment);
                    })
                    .catch(error => {
                        console.error('Error uploading image:', error);
                        
                        // Hỏi user có muốn đăng comment không có ảnh không
                        Swal.fire({
                            title: 'Lỗi upload ảnh!',
                            text: 'Không thể tải ảnh lên. Bạn có muốn đăng bình luận không có ảnh không?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Đăng không có ảnh',
                            cancelButtonText: 'Hủy',
                            confirmButtonColor: '#e67e22',
                            cancelButtonColor: '#6c757d'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Đăng comment không có ảnh
                                saveComment(comment);
                            } else {
                                // Khôi phục trạng thái button
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                            }
                        });
                    });
            } else {
                // Không có ảnh, đăng comment thông thường
                console.log('Posting comment without image');
                saveComment(comment);
            }
        }

        // Upload ảnh lên ImgBB (service thay thế cho Imgur)
        function uploadImageToImgur(imageFile) {
            // Sử dụng imgbb với API key công khai
            const apiKey = 'a1b2c3d4e5f6'; // Placeholder - sẽ dùng Imgur public thay thế
            
            console.log('Starting image upload...');
            console.log('File size:', imageFile.size, 'bytes');
            console.log('File type:', imageFile.type);
            
            return new Promise((resolve, reject) => {
                // Kiểm tra file size (max 5MB)
                if (imageFile.size > 5 * 1024 * 1024) {
                    console.error('File too large:', imageFile.size);
                    reject(new Error('File quá lớn! Vui lòng chọn ảnh dưới 5MB.'));
                    return;
                }
                
                // Kiểm tra file type
                if (!imageFile.type.startsWith('image/')) {
                    console.error('Invalid file type:', imageFile.type);
                    reject(new Error('File không phải là ảnh! Vui lòng chọn file ảnh.'));
                    return;
                }
                
                // Thử upload lên Imgur với anonymous upload
                const formData = new FormData();
                formData.append('image', imageFile);
                
                console.log('Trying Imgur anonymous upload...');
                
                fetch('https://api.imgur.com/3/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Client-ID 546c25a59c58ad7' // Public Imgur client ID
                    },
                    body: formData
                })
                .then(response => {
                    console.log('Imgur response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Imgur response data:', data);
                    if (data.success) {
                        console.log('Image uploaded successfully to:', data.data.link);
                        resolve(data.data.link);
                    } else {
                        console.error('Imgur upload failed:', data.data);
                        throw new Error('Imgur upload failed');
                    }
                })
                .catch(error => {
                    console.error('Imgur upload error:', error);
                    
                    // Fallback to base64
                    console.log('Using base64 fallback...');
                    uploadImageFallback(imageFile)
                        .then(url => resolve(url))
                        .catch(fallbackError => {
                            console.error('Fallback upload also failed:', fallbackError);
                            reject(new Error('Không thể upload ảnh. Vui lòng thử lại sau.'));
                        });
                });
            });
        }
        
        // Fallback image upload service (base64)
        function uploadImageFallback(imageFile) {
            return new Promise((resolve, reject) => {
                // Resize image trước khi convert base64
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Resize to max 800px width
                    let { width, height } = img;
                    const maxWidth = 800;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const base64Data = canvas.toDataURL('image/jpeg', 0.8);
                    console.log('Base64 image created, size:', base64Data.length);
                    resolve(base64Data);
                };
                
                img.onerror = function(error) {
                    console.error('Image load error:', error);
                    reject(new Error('Không thể đọc file ảnh'));
                };
                
                // Convert file to data URL
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.onerror = function(error) {
                    console.error('FileReader error:', error);
                    reject(new Error('Không thể đọc file ảnh'));
                };
                reader.readAsDataURL(imageFile);
            });
        }

        // Xóa ảnh preview
        function removeCommentImage() {
            const input = document.getElementById('comment-image-input');
            const preview = document.getElementById('comment-image-preview');
            
            input.value = '';
            preview.style.display = 'none';
        }

        // Open image viewer
        function openImageViewer(imageUrl) {
            const modal = document.getElementById('image-viewer-modal');
            const image = document.getElementById('image-viewer-image');
            
            image.src = imageUrl;
            modal.style.display = 'block';
        }

        // Close image viewer
        function closeImageViewer() {
            document.getElementById('image-viewer-modal').style.display = 'none';
        }

        // Toggle like/dislike comment
        function toggleCommentLike(commentId, type, button) {
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Vui lòng đăng nhập để tương tác',
                    icon: 'warning',
                    confirmButtonColor: '#1a237e'
                });
                return;
            }

            const guideSlug = window.currentCommentGuide.slug;
            const isActive = button.classList.contains('active');
            const countElement = button.querySelector(type === 'like' ? '.like-count' : '.dislike-count');
            
            button.disabled = true;
            
            if (isActive) {
                // Remove like/dislike
                firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${type}s/${user.uid}`)
                    .remove()
                    .then(() => {
                        button.classList.remove('active');
                        const currentCount = parseInt(countElement.textContent) || 0;
                        countElement.textContent = Math.max(0, currentCount - 1);
                    })
                    .finally(() => {
                        button.disabled = false;
                    });
            } else {
                // Add like/dislike
                const oppositeType = type === 'like' ? 'dislike' : 'like';
                const oppositeButton = button.parentElement.querySelector(`.comment-${oppositeType}-btn`);
                
                // Remove opposite reaction if exists
                if (oppositeButton && oppositeButton.classList.contains('active')) {
                    firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${oppositeType}s/${user.uid}`)
                        .remove()
                        .then(() => {
                            oppositeButton.classList.remove('active');
                            const oppositeCount = oppositeButton.querySelector(`.${oppositeType}-count`);
                            const currentCount = parseInt(oppositeCount.textContent) || 0;
                            oppositeCount.textContent = Math.max(0, currentCount - 1);
                        });
                }
                
                // Add new reaction
                firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${type}s/${user.uid}`)
                    .set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        userName: user.displayName || user.email
                    })
                    .then(() => {
                        button.classList.add('active');
                        const currentCount = parseInt(countElement.textContent) || 0;
                        countElement.textContent = currentCount + 1;
                    })
                    .finally(() => {
                        button.disabled = false;
                    });
            }
        }

        // Show reply form
        function showReplyForm(commentId) {
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Vui lòng đăng nhập để trả lời',
                    icon: 'warning',
                    confirmButtonColor: '#1a237e'
                });
                return;
            }
            
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = 'block';
            replyForm.querySelector('.comment-reply-input').focus();
        }

        // Hide reply form
        function hideReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = 'none';
            replyForm.querySelector('.comment-reply-input').value = '';
        }

        // Submit reply
        function submitReply(commentId) {
            const user = firebase.auth().currentUser;
            if (!user) return;
            
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            const replyInput = replyForm.querySelector('.comment-reply-input');
            const replyText = replyInput.value.trim();
            
            if (!replyText) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Vui lòng nhập nội dung trả lời',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                return;
            }
            
            const guideSlug = window.currentCommentGuide.slug;
            const reply = {
                text: replyText,
                userName: user.displayName || user.email,
                userId: user.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            firebase.database().ref(`guideComments/${guideSlug}/${commentId}/replies`).push(reply)
                .then(() => {
                    hideReplyForm(commentId);
                    
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true
                    });
                    Toast.fire({
                        icon: 'success',
                        title: 'Trả lời đã được đăng!'
                    });
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Không thể đăng trả lời. Vui lòng thử lại.',
                        icon: 'error',
                        confirmButtonColor: '#e67e22'
                    });
                    console.error("Error posting reply:", error);
                });
        }

        // Load comments cho guide
        function loadComments(guideSlug) {
            console.log('Loading comments for guide:', guideSlug);
            
            const commentsContainer = document.getElementById('comments-container');
            
            if (!commentsContainer) {
                console.error('Comments container not found!');
                return;
            }
            
            firebase.database().ref(`guideComments/${guideSlug}`).orderByChild('timestamp').on('value', (snapshot) => {
                console.log('Comments snapshot received:', snapshot.exists());
                
                if (snapshot.exists()) {
                    const commentsData = snapshot.val();
                    console.log('Comments data:', commentsData);
                    
                    const comments = Object.keys(commentsData).map(key => ({
                        id: key,
                        ...commentsData[key]
                    })).reverse();
                    
                    console.log('Processed comments:', comments);
                    
                    commentsContainer.innerHTML = '';
                    
                    comments.forEach(comment => {
                        const commentElement = createCommentElement(comment);
                        commentsContainer.appendChild(commentElement);
                    });
                } else {
                    console.log('No comments found for this guide');
                    commentsContainer.innerHTML = `
                        <div class="no-comments">
                            <i class="fas fa-comments" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                            <p>Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
                        </div>`;
                }
            }, (error) => {
                console.error('Error loading comments:', error);
            });
        }

        // Tạo comment element
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'comment-item';
            div.dataset.commentId = comment.id || '';
            
            const userInitial = comment.userName ? comment.userName.charAt(0).toUpperCase() : 'U';
            const timeAgo = getTimeAgo(comment.timestamp);
            const likeCount = comment.likes ? Object.keys(comment.likes).length : 0;
            const dislikeCount = comment.dislikes ? Object.keys(comment.dislikes).length : 0;
            
            const imageHTML = comment.image ? `
                <div class="comment-image" onclick="openImageViewer('${comment.image}')">
                    <img src="${comment.image}" alt="Comment image" style="max-width: 300px; cursor: pointer; border-radius: 8px; margin-top: 8px;">
                </div>
            ` : '';
            
            div.innerHTML = `
                <div class="comment-main">
                    <div class="comment-avatar">${userInitial}</div>
                    <div class="comment-content">
                        <div class="comment-author">${comment.userName || 'Ẩn danh'}</div>
                        <div class="comment-text">${comment.text}</div>
                        ${imageHTML}
                        <div class="comment-actions-bar">
                            <button class="comment-like-btn" onclick="toggleCommentLike('${comment.id}', 'like', this)">
                                <i class="fas fa-thumbs-up"></i>
                                <span class="like-count">${likeCount}</span>
                            </button>
                            <button class="comment-dislike-btn" onclick="toggleCommentLike('${comment.id}', 'dislike', this)">
                                <i class="fas fa-thumbs-down"></i>
                                <span class="dislike-count">${dislikeCount}</span>
                            </button>
                            <button class="comment-reply-btn" onclick="showReplyForm('${comment.id}')">
                                <i class="fas fa-reply"></i>
                                Trả lời
                            </button>
                        </div>
                    </div>
                </div>
                <div class="comment-time">${timeAgo}</div>
                <div class="comment-reply-form" id="reply-form-${comment.id}" style="display: none;">
                    <textarea class="comment-reply-input" placeholder="Viết trả lời..." rows="2"></textarea>
                    <div class="comment-reply-actions">
                        <button class="comment-reply-cancel" onclick="hideReplyForm('${comment.id}')">Hủy</button>
                        <button class="comment-reply-submit" onclick="submitReply('${comment.id}')">Trả lời</button>
                    </div>
                </div>
                <div class="comment-replies" id="replies-${comment.id}"></div>
            `;
            
            // Load replies if exist
            if (comment.replies) {
                const repliesContainer = div.querySelector(`#replies-${comment.id}`);
                Object.values(comment.replies).forEach(reply => {
                    const replyElement = createReplyElement(reply);
                    repliesContainer.appendChild(replyElement);
                });
            }
            
            return div;
        }

        // Tạo reply element
        function createReplyElement(reply) {
            const div = document.createElement('div');
            div.className = 'comment-item';
            div.style.marginBottom = '10px';
            div.style.marginLeft = '40px';
            div.style.borderLeft = '2px solid #e0e0e0';
            div.style.paddingLeft = '15px';
            
            const userInitial = reply.userName ? reply.userName.charAt(0).toUpperCase() : 'U';
            const timeAgo = getTimeAgo(reply.timestamp);
            
            div.innerHTML = `
                <div class="comment-main">
                    <div class="comment-avatar" style="width: 32px; height: 32px; font-size: 14px;">${userInitial}</div>
                    <div class="comment-content">
                        <div class="comment-author" style="font-size: 14px;">${reply.userName || 'Ẩn danh'}</div>
                        <div class="comment-text" style="font-size: 14px;">${reply.text}</div>
                    </div>
                </div>
                <div class="comment-time" style="margin-left: 44px; font-size: 12px;">${timeAgo}</div>
            `;
            
            return div;
        }

        // Tính thời gian đã qua
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Vừa xong';
            if (minutes < 60) return `${minutes} phút trước`;
            if (hours < 24) return `${hours} giờ trước`;
            return `${days} ngày trước`;
        }

        // Setup event listeners khi DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra Firebase connection status
            const connectedRef = firebase.database().ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('Firebase connected');
                } else {
                    console.log('Firebase disconnected');
                    
                    // Hiển thị thông báo khi mất kết nối Firebase
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                    Toast.fire({
                        icon: 'warning',
                        title: 'Mất kết nối với server!'
                    });
                }
            });

            // Network status listeners
            window.addEventListener('online', () => {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });
                Toast.fire({
                    icon: 'success',
                    title: 'Đã kết nối internet!'
                });
            });

            window.addEventListener('offline', () => {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                Toast.fire({
                    icon: 'error',
                    title: 'Mất kết nối internet!'
                });
            });

            // Comment submit button
            const commentSubmitBtn = document.getElementById('comment-submit');
            if (commentSubmitBtn) {
                commentSubmitBtn.addEventListener('click', submitComment);
            }

            // Comment input auto-resize
            const commentInput = document.getElementById('comment-input');
            if (commentInput) {
                commentInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });

                commentInput.addEventListener('keydown', function(e) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        submitComment();
                    }
                });
            }

            // Image upload preview
            const imageInput = document.getElementById('comment-image-input');
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('comment-image-preview');
                    const previewImage = document.getElementById('comment-preview-image');
                    
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            Swal.fire({
                                title: 'Ảnh quá lớn!',
                                text: 'Vui lòng chọn ảnh có kích thước nhỏ hơn 5MB',
                                icon: 'error',
                                confirmButtonColor: '#e67e22'
                            });
                            this.value = '';
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Image viewer modal close
            const imageViewerModal = document.getElementById('image-viewer-modal');
            if (imageViewerModal) {
                imageViewerModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeImageViewer();
                    }
                });
            }

            // ESC key handlers
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (imageViewerModal && imageViewerModal.style.display === 'block') {
                        closeImageViewer();
                    }
                    
                    const commentModal = document.getElementById('comment-modal');
                    if (commentModal && commentModal.style.display === 'block') {
                        closeCommentModal();
                    }
                }
            });
        });

        // Khởi tạo EmailJS với public key
        (function () {
            emailjs.init("yI6xhpzYSnD3AGzbX");
        })();

        // Xử lý form liên hệ - Kiểm tra element tồn tại trước
        const contactForm = document.getElementById('contact-form');
        if (contactForm) {
            contactForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Lấy thông tin từ form với kiểm tra an toàn
                const nameInput = document.getElementById('contact-name');
                const emailInput = document.getElementById('contact-email');
                const messageInput = document.getElementById('contact-message');
                
                if (!nameInput || !emailInput || !messageInput) {
                    console.error('Contact form inputs not found');
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Không thể tìm thấy các trường trong form. Vui lông thử lại.',
                        icon: 'error',
                        confirmButtonColor: '#e67e22'
                    });
                    return;
                }
                
                const name = nameInput.value;
                const email = emailInput.value;
                const message = messageInput.value;

                // Hiển thị loading
                Swal.fire({
                    title: 'Đang gửi...',
                    text: 'Vui lòng đợi trong giây lát',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Gửi email
                emailjs.send("service_6spwxxw", "template_vcjlg02", {
                    to_email: "quantrikhachsan001@gmail.com",
                    from_name: name,
                    from_email: email,
                    message: message
                })
                    .then(function () {
                        // Thành công
                        Swal.fire({
                            title: 'Gửi thành công!',
                            text: 'Cảm ơn bạn đã liên hệ. Chúng tôi sẽ phản hồi sớm nhất có thể.',
                            icon: 'success',
                            confirmButtonColor: '#e67e22'
                        });
                        // Reset form
                        contactForm.reset();
                    })
                    .catch(function (error) {
                        // Thất bại
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Không thể gửi email. Vui lòng thử lại sau.',
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                        console.error("Error sending email:", error);
                    });
            });
        } else {
            console.warn("Contact form not found - skipping contact form initialization");
        }



        let autoSlideInterval;
        let currentSlideIndex = 0;

        function startAutoSlide() {
            stopAutoSlide(); // Clear any existing interval
            autoSlideInterval = setInterval(() => {
                document.querySelectorAll('.slider-container').forEach(container => {
                    const nextBtn = container.querySelector('.next');
                    if (nextBtn) nextSlide(nextBtn);
                });
            }, 4000); // Chuyển slide mỗi 4 giây
        }

        function stopAutoSlide() {
            if (autoSlideInterval) {
                clearInterval(autoSlideInterval);
            }
        }

        function nextSlide(btn) {
            const container = btn.closest('.slider-container');
            const slider = container.querySelector('.slider');
            const dots = container.querySelectorAll('.dot');
            const slides = container.querySelectorAll('.slide');

            currentSlideIndex = (currentSlideIndex + 1) % slides.length;
            updateSlider(slider, dots, currentSlideIndex);
        }

        function prevSlide(btn) {
            const container = btn.closest('.slider-container');
            const slider = container.querySelector('.slider');
            const dots = container.querySelectorAll('.dot');
            const slides = container.querySelectorAll('.slide');

            currentSlideIndex = (currentSlideIndex - 1 + slides.length) % slides.length;
            updateSlider(slider, dots, currentSlideIndex);
        }

        function currentSlide(dot, index) {
            const container = dot.closest('.slider-container');
            const slider = container.querySelector('.slider');
            const dots = container.querySelectorAll('.dot');

            currentSlideIndex = index;
            updateSlider(slider, dots, index);
        }

        function updateSlider(slider, dots, index) {
            const sliderWidth = slider.offsetWidth;
            slider.style.transform = `translateX(${-index * sliderWidth}px)`;

            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        // Khởi động auto slide và xử lý các sự kiện khi trang load xong
        document.addEventListener('DOMContentLoaded', () => {
            startAutoSlide();

            // Thêm sự kiện hover để dừng/tiếp tục auto slide
            document.querySelectorAll('.slider-container').forEach(container => {
                container.addEventListener('mouseenter', stopAutoSlide);
                container.addEventListener('mouseleave', startAutoSlide);
            });
        });


    </script>

    <!-- Nút mở modal đánh giá -->
    <button id="open-review-modal" class="btn btn-primary"
        style="position: fixed; bottom: 20px; right: 20px; z-index: 999; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-star" style="font-size: 24px;"></i>
    </button>

    <!-- Nút đăng cẩm nang cho members -->
    <button id="open-contribute-modal" class="btn btn-success" 
        style="position: fixed; bottom: 90px; right: 20px; z-index: 999; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; display: none;">
        <i class="fas fa-plus" style="font-size: 24px;"></i>
    </button>

    <!-- Modal đánh giá -->
    <div id="review-modal" class="modal"
        style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content"
            style="background-color: #fff; margin: 15% auto; padding: 20px; border-radius: 12px; max-width: 500px; position: relative;">
            <span class="close-review-modal"
                style="position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer;">&times;</span>
            <h2 style="color: #003366; margin-bottom: 20px;">Đánh giá của bạn</h2>
            <form id="review-form">
                <div class="rating" style="margin-bottom: 20px; text-align: center;">
                    <i class="far fa-star star" data-rating="1"
                        style="font-size: 24px; color: #ffd700; cursor: pointer; margin: 0 5px;"></i>
                    <i class="far fa-star star" data-rating="2"
                        style="font-size: 24px; color: #ffd700; cursor: pointer; margin: 0 5px;"></i>
                    <i class="far fa-star star" data-rating="3"
                        style="font-size: 24px; color: #ffd700; cursor: pointer; margin: 0 5px;"></i>
                    <i class="far fa-star star" data-rating="4"
                        style="font-size: 24px; color: #ffd700; cursor: pointer; margin: 0 5px;"></i>
                    <i class="far fa-star star" data-rating="5"
                        style="font-size: 24px; color: #ffd700; cursor: pointer; margin: 0 5px;"></i>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="review-title" style="display: block; margin-bottom: 5px;">Tiêu đề</label>
                    <input type="text" id="review-title" class="form-control" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="review-content" style="display: block; margin-bottom: 5px;">Nội dung đánh giá</label>
                    <textarea id="review-content" class="form-control" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; padding: 10px; background: linear-gradient(45deg, #1a237e, #0d47a1); border: none;">Gửi
                    đánh giá</button>
            </form>
        </div>
    </div>

    <!-- Modal đóng góp cẩm nang -->
    <div id="contribute-modal" class="modal"
        style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto;">
        <div class="modal-content"
            style="background-color: #fff; margin: 2% auto; padding: 30px; border-radius: 12px; max-width: 800px; position: relative;">
            <span class="close-contribute-modal"
                style="position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: #999;">&times;</span>
            
            <h2 style="color: #1a237e; margin-bottom: 25px; text-align: center;">
                <i class="fas fa-map-marked-alt"></i> Đóng góp cẩm nang du lịch
            </h2>
            
            <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                <h4 style="color: #1a237e; margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> Hướng dẫn đóng góp
                </h4>
                <ul style="margin: 0; color: #666;">
                    <li>Chia sẻ kinh nghiệm du lịch thực tế của bạn</li>
                    <li>Cung cấp thông tin hữu ích và chính xác</li>
                    <li>Kèm theo hình ảnh chất lượng (nếu có)</li>
                    <li>Cẩm nang sẽ được admin duyệt trước khi công bố</li>
                </ul>
            </div>

            <form id="contribute-form">
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="contribute-title" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-heading"></i> Tiêu đề cẩm nang *
                            </label>
                            <input type="text" id="contribute-title" class="form-control" 
                                placeholder="VD: Khám phá vẻ đẹp hoang sơ của Sa Pa" required
                                style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="contribute-category" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-tags"></i> Danh mục *
                            </label>
                            <select id="contribute-category" class="form-control" required
                                style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="">Chọn danh mục</option>
                                <option value="mountain">Miền núi</option>
                                <option value="beach">Biển đảo</option>
                                <option value="city">Thành phố</option>
                                <option value="culture">Di tích văn hóa</option>
                                <option value="food">Ẩm thực</option>
                                <option value="adventure">Phiêu lưu</option>
                                <option value="budget">Du lịch tiết kiệm</option>
                                <option value="luxury">Du lịch cao cấp</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="contribute-location" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-map-marker-alt"></i> Địa điểm *
                            </label>
                            <input type="text" id="contribute-location" class="form-control" 
                                placeholder="VD: Sa Pa, Lào Cai" required
                                style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="contribute-duration" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-clock"></i> Thời gian gợi ý
                            </label>
                            <input type="text" id="contribute-duration" class="form-control" 
                                placeholder="VD: 2-3 ngày"
                                style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="contribute-summary" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                        <i class="fas fa-align-left"></i> Tóm tắt ngắn gọn *
                    </label>
                    <textarea id="contribute-summary" class="form-control" rows="3" 
                        placeholder="Mô tả ngắn gọn về cẩm nang này (100-200 từ)" required
                        style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="contribute-content" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                        <i class="fas fa-file-alt"></i> Nội dung chi tiết *
                    </label>
                    <textarea id="contribute-content" class="form-control" rows="10" 
                        placeholder="Chia sẻ kinh nghiệm chi tiết của bạn: cách di chuyển, địa điểm tham quan, ăn uống, lưu trú, chi phí, lưu ý..." required
                        style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
                </div>

                <!-- Phần khách sạn gợi ý -->
                <div style="background: linear-gradient(135deg, #fff3e0, #e8f5e8); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                    <h4 style="color: #1a237e; margin-bottom: 15px;">
                        <i class="fas fa-hotel"></i> Khách sạn gợi ý tại ${địa điểm}
                    </h4>
                    <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                        Chia sẻ những khách sạn bạn đã trải nghiệm hoặc gợi ý cho du khách khác
                    </p>

                    <div id="hotel-recommendations">
                        <div class="hotel-recommendation-item" style="border: 2px dashed #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                            <i class="fas fa-hotel"></i> Tên khách sạn
                                        </label>
                                        <input type="text" class="form-control hotel-name" 
                                            placeholder="VD: Sapa Paradise Hotel"
                                            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                            <i class="fas fa-star"></i> Đánh giá (1-5 sao)
                                        </label>
                                        <select class="form-control hotel-rating" 
                                            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                            <option value="">Chọn đánh giá</option>
                                            <option value="5">⭐⭐⭐⭐⭐ (5 sao - Tuyệt vời)</option>
                                            <option value="4">⭐⭐⭐⭐ (4 sao - Rất tốt)</option>
                                            <option value="3">⭐⭐⭐ (3 sao - Tốt)</option>
                                            <option value="2">⭐⭐ (2 sao - Tạm được)</option>
                                            <option value="1">⭐ (1 sao - Không tốt)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                            <i class="fas fa-dollar-sign"></i> Giá phòng ước tính
                                        </label>
                                        <input type="text" class="form-control hotel-price" 
                                            placeholder="VD: 800.000 - 1.200.000 VND/đêm"
                                            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                            <i class="fas fa-map-marker-alt"></i> Vị trí cụ thể
                                        </label>
                                        <input type="text" class="form-control hotel-location" 
                                            placeholder="VD: Trung tâm thị trấn Sapa"
                                            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                    <i class="fas fa-comment"></i> Nhận xét về khách sạn
                                </label>
                                <textarea class="form-control hotel-review" rows="3" 
                                    placeholder="Chia sẻ trải nghiệm: dịch vụ, vệ sinh, view, tiện ích, ưu/nhược điểm..."
                                    style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                            </div>

                            <div class="form-group">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                    <i class="fas fa-check-circle"></i> Gợi ý đặt phòng
                                </label>
                                <select class="form-control hotel-recommendation" 
                                    style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">Chọn mức độ gợi ý</option>
                                    <option value="highly-recommended">🔥 Rất khuyến khích - Tuyệt vời!</option>
                                    <option value="recommended">👍 Khuyến khích - Đáng thử</option>
                                    <option value="okay">😐 Tạm được - Có thể cân nhắc</option>
                                    <option value="not-recommended">👎 Không khuyến khích</option>
                                </select>
                            </div>

                            <button type="button" class="remove-hotel-btn" onclick="removeHotelRecommendation(this)" 
                                style="background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-trash"></i> Xóa khách sạn này
                            </button>
                        </div>
                    </div>

                    <button type="button" onclick="addHotelRecommendation()" 
                        style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                        <i class="fas fa-plus"></i> Thêm khách sạn khác
                    </button>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="contribute-budget" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-dollar-sign"></i> Chi phí ước tính
                            </label>
                            <input type="text" id="contribute-budget" class="form-control" 
                                placeholder="VD: 1.5 - 2 triệu/người"
                                style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="contribute-season" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-calendar-alt"></i> Thời điểm phù hợp
                            </label>
                            <input type="text" id="contribute-season" class="form-control" 
                                placeholder="VD: Tháng 9-11 và 3-5"
                                style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="contribute-image" style="display: block; margin-bottom: 8px; font-weight: bold; color: #1a237e;">
                        <i class="fas fa-camera"></i> Hình ảnh đại diện
                    </label>
                    <input type="file" id="contribute-image" class="form-control" accept="image/*"
                        style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <small style="color: #666; font-style: italic;">Kích thước tối đa 5MB. Khuyến khích tỷ lệ 16:9</small>
                    
                    <!-- Preview ảnh -->
                    <div id="contribute-image-preview" style="margin-top: 15px; display: none;">
                        <img id="contribute-preview-img" style="max-width: 300px; max-height: 200px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <br>
                        <button type="button" onclick="removeContributeImage()" 
                            style="margin-top: 10px; background: #ff4444; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-times"></i> Xóa ảnh
                        </button>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="contribute-agreement" required style="margin-right: 10px; transform: scale(1.2);">
                        <span style="color: #666;">
                            Tôi cam kết thông tin chia sẻ là trải nghiệm thực tế và chính xác. 
                            Tôi đồng ý để admin kiểm duyệt và chỉnh sửa nội dung nếu cần thiết.
                        </span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary"
                    style="width: 100%; padding: 15px; background: linear-gradient(45deg, #1a237e, #0d47a1); border: none; border-radius: 8px; font-size: 16px; font-weight: bold;">
                    <i class="fas fa-paper-plane"></i> Gửi cẩm nang để duyệt
                </button>
            </form>
        </div>
    </div>

    <!-- Modal đánh giá cẩm nang -->
    <div id="guide-rating-modal" class="rating-modal">
        <div class="rating-modal-content">
            <span class="close-rating-modal" style="position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer;">&times;</span>
            <h3 style="color: #1a237e; margin-bottom: 20px;">Đánh giá cẩm nang</h3>
            <p id="rating-guide-title" style="color: #666; margin-bottom: 20px;"></p>
            <div class="rating-stars-large" id="modal-rating-stars">
                <i class="far fa-star" data-rating="1" onclick="setModalRating(1)"></i>
                <i class="far fa-star" data-rating="2" onclick="setModalRating(2)"></i>
                <i class="far fa-star" data-rating="3" onclick="setModalRating(3)"></i>
                <i class="far fa-star" data-rating="4" onclick="setModalRating(4)"></i>
                <i class="far fa-star" data-rating="5" onclick="setModalRating(5)"></i>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="guide-comment" style="display: block; margin-bottom: 5px;">Bình luận (tùy chọn)</label>
                <textarea id="guide-comment" class="form-control" rows="3" placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
            </div>
            <button type="button" class="btn btn-primary" onclick="submitGuideRating()" style="width: 100%; padding: 10px;">
                Gửi đánh giá
            </button>
        </div>
    </div>

    <!-- Modal bình luận cẩm nang -->
    <div id="comment-modal" class="comment-modal">
        <div class="comment-modal-content">
            <div class="comment-header">
                <h5 id="comment-guide-title" style="margin: 0; color: #1a237e;">Bình luận</h5>
                <button class="comment-close" onclick="closeCommentModal()">&times;</button>
            </div>
            <div class="comment-body" id="comments-container">
                <div class="no-comments">
                    <i class="fas fa-comments" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                    <p>Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
                </div>
            </div>
            <div class="comment-footer">
                <div class="comment-input-group">
                    <div class="comment-input-row">
                        <textarea 
                            id="comment-input" 
                            class="comment-input" 
                            placeholder="Viết bình luận hoặc chia sẻ ảnh tại địa điểm này..." 
                            rows="1"></textarea>
                        <div class="comment-actions">
                            <div class="comment-image-upload">
                                <input type="file" id="comment-image-input" class="comment-image-input" accept="image/*">
                                <button type="button" class="comment-image-btn" onclick="document.getElementById('comment-image-input').click()">
                                    <i class="fas fa-image"></i>
                                </button>
                            </div>
                            <button type="button" id="comment-submit" class="comment-submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    <div id="comment-image-preview" class="comment-image-preview">
                        <div class="comment-preview-container">
                            <img id="comment-preview-image" class="comment-preview-image" src="" alt="Preview">
                            <button type="button" class="comment-remove-image" onclick="removeCommentImage()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal xem ảnh full screen -->
    <div id="image-viewer-modal" class="image-viewer-modal">
        <button class="image-viewer-close" onclick="closeImageViewer()">&times;</button>
        <div class="image-viewer-content">
            <img id="image-viewer-image" class="image-viewer-image" src="" alt="">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const reviewModal = document.getElementById('review-modal');
            const openReviewBtn = document.getElementById('open-review-modal');
            const closeReviewBtn = document.querySelector('.close-review-modal');
            const reviewForm = document.getElementById('review-form');
            const stars = document.querySelectorAll('.star');
            let currentRating = 0;

            // Contribute modal elements
            const contributeModal = document.getElementById('contribute-modal');
            const openContributeBtn = document.getElementById('open-contribute-modal');
            const closeContributeBtn = document.querySelector('.close-contribute-modal');
            const contributeForm = document.getElementById('contribute-form');

            // Mở modal
            openReviewBtn.addEventListener('click', () => {
                reviewModal.style.display = 'block';
            });

            // Mở modal đóng góp cẩm nang
            if (openContributeBtn) {
                openContributeBtn.addEventListener('click', () => {
                    contributeModal.style.display = 'block';
                });
            }

            // Đóng modal
            closeReviewBtn.addEventListener('click', () => {
                reviewModal.style.display = 'none';
            });

            // Đóng modal đóng góp cẩm nang
            if (closeContributeBtn) {
                closeContributeBtn.addEventListener('click', () => {
                    contributeModal.style.display = 'none';
                    resetContributeForm();
                });
            }

            // Đóng modal khi click ngoài modal
            window.addEventListener('click', (event) => {
                if (event.target == reviewModal) {
                    reviewModal.style.display = 'none';
                }
                if (event.target == contributeModal) {
                    contributeModal.style.display = 'none';
                    resetContributeForm();
                }
            });

            // Xử lý hover và click cho sao
            stars.forEach(star => {
                // Hover effect
                star.addEventListener('mouseover', function () {
                    const rating = this.getAttribute('data-rating');
                    highlightStars(rating);
                });

                // Click event
                star.addEventListener('click', function () {
                    currentRating = this.getAttribute('data-rating');
                    highlightStars(currentRating);
                });
            });

            // Reset stars khi mouse out khỏi container
            document.querySelector('.rating').addEventListener('mouseleave', () => {
                highlightStars(currentRating);
            });

            // Hàm highlight sao
            function highlightStars(rating) {
                stars.forEach(star => {
                    const starRating = star.getAttribute('data-rating');
                    if (starRating <= rating) {
                        star.classList.remove('far');
                        star.classList.add('fas');
                    } else {
                        star.classList.remove('fas');
                        star.classList.add('far');
                    }
                });
            }

            // Xử lý submit form
            reviewForm.addEventListener('submit', function (e) {
                e.preventDefault();

                if (currentRating === 0) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Vui lòng chọn số sao đánh giá',
                        icon: 'error',
                        confirmButtonColor: '#e67e22'
                    });
                    return;
                }

                // Kiểm tra đăng nhập
                const user = firebase.auth().currentUser;
                if (!user) {
                    Swal.fire({
                        title: 'Yêu cầu đăng nhập',
                        text: 'Vui lòng đăng nhập để gửi đánh giá',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Đăng nhập',
                        cancelButtonText: 'Hủy',
                        confirmButtonColor: '#1a237e',
                        cancelButtonColor: '#d33'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Mở modal đăng nhập
                            document.getElementById('auth-modal').style.display = 'block';
                        }
                    });
                    return;
                }

                const reviewData = {
                    rating: currentRating,
                    title: document.getElementById('review-title').value,
                    content: document.getElementById('review-content').value,
                    timestamp: new Date().toISOString(),
                    userId: user.uid,
                    userEmail: user.email,
                    userName: user.displayName || user.email
                };



                // Hiển thị loading
                Swal.fire({
                    title: 'Đang gửi...',
                    text: 'Vui lòng đợi trong giây lát',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Lưu đánh giá vào Firebase và gửi qua EmailJS
                Promise.all([
                    // Lưu vào Firebase
                    firebase.database().ref('reviews').push({
                        userId: reviewData.userId,
                        hotelId: "general", // Đánh giá chung
                        rating: parseInt(reviewData.rating),
                        comment: reviewData.content,
                        date: Date.now(),
                        userName: reviewData.userName,
                        title: reviewData.title
                    }),

                    // Gửi qua EmailJS
                    emailjs.send("service_6spwxxw", "template_vcjlg02", {
                        to_email: "quantrikhachsan001@gmail.com",
                        from_name: reviewData.userId || "Khách vãng lai",
                        rating: reviewData.rating + " sao",
                        title: reviewData.title,
                        message: reviewData.content,
                        timestamp: new Date().toLocaleString('vi-VN')
                    })
                ])
                    .then(() => {
                        Swal.fire({
                            title: 'Thành công!',
                            text: 'Cảm ơn bạn đã gửi đánh giá',
                            icon: 'success',
                            confirmButtonColor: '#e67e22'
                        });
                        reviewModal.style.display = 'none';
                        reviewForm.reset();
                        currentRating = 0;
                        highlightStars(0);
                    })
                    .catch((error) => {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Không thể gửi đánh giá. Vui lòng thử lại sau.',
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                        console.error("Error sending review: ", error);
                    });
            });

            // Xử lý submit form đóng góp cẩm nang
            if (contributeForm) {
                contributeForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    submitContribution();
                });
            }

            // Preview ảnh khi chọn file
            const contributeImageInput = document.getElementById('contribute-image');
            if (contributeImageInput) {
                contributeImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Kiểm tra kích thước file (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            Swal.fire({
                                title: 'Ảnh quá lớn!',
                                text: 'Vui lòng chọn ảnh có kích thước nhỏ hơn 5MB',
                                icon: 'error',
                                confirmButtonColor: '#e67e22'
                            });
                            this.value = '';
                            return;
                        }
                        
                        // Hiển thị preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('contribute-preview-img').src = e.target.result;
                            document.getElementById('contribute-image-preview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Mobile Menu Toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const navLinks = document.getElementById('nav-links');

            if (mobileMenuBtn && navLinks) {
                mobileMenuBtn.addEventListener('click', function () {
                    this.classList.toggle('active');
                    navLinks.classList.toggle('active');
                });

                // Close mobile menu when clicking on links
                navLinks.addEventListener('click', function (e) {
                    if (e.target.tagName === 'A') {
                        mobileMenuBtn.classList.remove('active');
                        navLinks.classList.remove('active');
                    }
                });

                // Close mobile menu when clicking outside
                document.addEventListener('click', function (e) {
                    if (!mobileMenuBtn.contains(e.target) && !navLinks.contains(e.target)) {
                        mobileMenuBtn.classList.remove('active');
                        navLinks.classList.remove('active');
                    }
                });
            }

            // Event listeners cho modal mới
            // Close comment modal
            const closeCommentBtn = document.querySelector('.close-comment-modal');
            if (closeCommentBtn) {
                closeCommentBtn.addEventListener('click', function() {
                    closeCommentModal();
                });
            }

            // Comment submit button
            const commentSubmitBtn = document.getElementById('comment-submit');
            if (commentSubmitBtn) {
                commentSubmitBtn.addEventListener('click', submitComment);
            }

            // Comment input auto-resize and Enter key
            const commentInput = document.getElementById('comment-input');
            if (commentInput) {
                // Auto resize
                commentInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });

                // Submit on Ctrl/Cmd + Enter
                commentInput.addEventListener('keydown', function(e) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        submitComment();
                    }
                });
            }

            // Initialize image preview functionality
            handleImagePreview();

            // Image viewer modal events
            const imageViewerModal = document.getElementById('image-viewer-modal');
            if (imageViewerModal) {
                imageViewerModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeImageViewer();
                    }
                });
                
                // ESC key to close image viewer
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && imageViewerModal.style.display === 'block') {
                        closeImageViewer();
                    }
                });
            }
            
            // Close rating modal
            const closeRatingBtn = document.querySelector('.close-rating-modal');
            if (closeRatingBtn) {
                closeRatingBtn.addEventListener('click', function() {
                    document.getElementById('guide-rating-modal').style.display = 'none';
                    document.getElementById('guide-comment').value = '';
                });
            }
            
            // Click outside modals
            window.addEventListener('click', function(event) {
                const commentModal = document.getElementById('comment-modal');
                const ratingModal = document.getElementById('guide-rating-modal');
                
                if (event.target === commentModal) {
                    closeCommentModal();
                }
                if (event.target === ratingModal) {
                    document.getElementById('guide-rating-modal').style.display = 'none';
                    document.getElementById('guide-comment').value = '';
                }
            });

            // Rating stars trong modal
            const modalStars = document.querySelectorAll('#modal-rating-stars i');
            if (modalStars.length > 0) {
                modalStars.forEach(star => {
                    star.addEventListener('mouseover', function() {
                        const rating = this.dataset.rating;
                        highlightModalStars(rating);
                    });

                    star.addEventListener('click', function() {
                        const rating = this.dataset.rating;
                        highlightModalStars(rating);
                        window.currentRating = rating;
                    });
                });

                const modalRatingContainer = document.querySelector('#modal-rating-stars');
                if (modalRatingContainer) {
                    modalRatingContainer.addEventListener('mouseleave', function() {
                        highlightModalStars(window.currentRating || 0);
                    });
                }
            }
            
            // Load travel guides data
            console.log('DOM ready, loading travel guides...');
            
            firebase.database().ref('travelGuides').once('value', (snapshot) => {
                const guidesData = snapshot.val();
                console.log('TravelGuides data:', guidesData); // Debug log
                if (guidesData) {
                    const allGuides = Object.keys(guidesData).map(key => ({
                        ...guidesData[key],
                        slug: key // Ensure slug is set từ Firebase key
                    }));
                    console.log('All guides count:', allGuides.length); // Debug log
                    console.log('All guides:', allGuides); // Debug log
                    
                    const featuredGuides = allGuides.filter(g => g.is_featured_on_homepage === true).slice(0, 4);
                    const latestGuides = allGuides.sort((a, b) => {
                        // Sắp xếp theo last_updated hoặc timestamp
                        const dateA = new Date(a.last_updated || a.approvedAt || '2024-01-01');
                        const dateB = new Date(b.last_updated || b.approvedAt || '2024-01-01');
                        return dateB - dateA;
                    }).slice(0, 8);
                    
                    console.log('Featured guides count:', featuredGuides.length); // Debug log
                    console.log('Latest guides count:', latestGuides.length); // Debug log
                    console.log('Featured guides:', featuredGuides); // Debug log
                    console.log('Latest guides:', latestGuides); // Debug log
                    
                    renderGuides(featuredGuides, 'featured-guides-container');
                    renderGuides(latestGuides, 'latest-guides-container');
                    
                    // Load real-time like count cho tất cả cẩm nang
                    loadAllGuidesLikeCount();
                } else {
                    console.log('No guides data found'); // Debug log
                    const featuredContainer = document.getElementById('featured-guides-container');
                    const latestContainer = document.getElementById('latest-guides-container');
                    if (featuredContainer) {
                        featuredContainer.innerHTML = '<p class="col-12">Không tìm thấy cẩm nang nổi bật.</p>';
                    }
                    if (latestContainer) {
                        latestContainer.innerHTML = '<p class="col-12">Không tìm thấy cẩm nang mới nhất.</p>';
                    }
                }
            }).catch(error => {
                console.error("Firebase read error:", error);
                const featuredContainer = document.getElementById('featured-guides-container');
                const latestContainer = document.getElementById('latest-guides-container');
                if (featuredContainer) {
                    featuredContainer.innerHTML = '<p class="col-12">Lỗi khi tải dữ liệu.</p>';
                }
                if (latestContainer) {
                    latestContainer.innerHTML = '<p class="col-12">Lỗi khi tải dữ liệu.</p>';
                }
            });
        });

        // =================== GLOBAL FUNCTIONS ===================
        // Các functions này cần để global để có thể gọi từ HTML onclick

        // Xử lý preview ảnh
        function handleImagePreview() {
            const input = document.getElementById('comment-image-input');
            const preview = document.getElementById('comment-image-preview');
            const previewImage = document.getElementById('comment-preview-image');
            
            if (input) {
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Kiểm tra kích thước file (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            Swal.fire({
                                title: 'Ảnh quá lớn!',
                                text: 'Vui lòng chọn ảnh có kích thước nhỏ hơn 5MB',
                                icon: 'error',
                                confirmButtonColor: '#e67e22'
                            });
                            input.value = '';
                            return;
                        }
                        
                        // Hiển thị preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            if (previewImage) {
                                previewImage.src = e.target.result;
                            }
                            if (preview) {
                                preview.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        // Submit đánh giá cẩm nang
        function submitGuideRating() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const guide = window.currentRatingGuide;
            const rating = window.currentRating || 0;
            const comment = document.getElementById('guide-comment').value;

            console.log('Submitting rating:', rating, 'for guide:', guide);

            if (rating == 0) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Vui lòng chọn số sao đánh giá',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                return;
            }

            // Hiển thị loading
            Swal.fire({
                title: 'Đang gửi...',
                text: 'Vui lòng đợi trong giây lát',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Lưu đánh giá vào Firebase
            const ratingRef = firebase.database().ref(`guideRatings/${guide.id}/${user.uid}`);
            ratingRef.set({
                rating: parseInt(rating),
                comment: comment,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                userName: user.displayName || user.email
            }).then(() => {
                // Cập nhật rating trung bình
                updateGuideAverageRating(guide.id);
                
                Swal.fire({
                    title: 'Thành công!',
                    text: 'Cảm ơn bạn đã đánh giá cẩm nang',
                    icon: 'success',
                    confirmButtonColor: '#e67e22'
                });
                
                closeRatingModal();
                loadGuideRatings(); // Reload ratings
            }).catch(error => {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể gửi đánh giá. Vui lòng thử lại sau.',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                console.error("Error submitting rating:", error);
            });
        }

        // Cập nhật rating trung bình
        function updateGuideAverageRating(guideId) {
            firebase.database().ref(`guideRatings/${guideId}`).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const ratings = Object.values(snapshot.val());
                        const totalRating = ratings.reduce((sum, rating) => sum + rating.rating, 0);
                        const averageRating = totalRating / ratings.length;
                        
                        // Lưu rating trung bình
                        firebase.database().ref(`travelGuides/${guideId}/averageRating`).set(averageRating);
                        firebase.database().ref(`travelGuides/${guideId}/ratingCount`).set(ratings.length);
                    }
                });
        }

        // Load ratings cho tất cả cẩm nang
        function loadGuideRatings() {
            firebase.database().ref('travelGuides').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const guides = snapshot.val();
                        Object.keys(guides).forEach(guideId => {
                            const guide = guides[guideId];
                            const ratingCount = guide.ratingCount || 0;
                            const averageRating = guide.averageRating || 0;
                            
                            // Cập nhật hiển thị rating
                            const ratingElement = document.querySelector(`[data-guide-id="${guideId}"]`);
                            if (ratingElement) {
                                const countElement = ratingElement.nextElementSibling;
                                if (countElement) {
                                    countElement.textContent = `${ratingCount} đánh giá`;
                                }
                                
                                // Hiển thị sao trung bình
                                const stars = ratingElement.querySelectorAll('i');
                                stars.forEach((star, index) => {
                                    if (index < Math.round(averageRating)) {
                                        star.classList.add('fas');
                                    } else {
                                        star.classList.add('far');
                                    }
                                });
                            }
                        });
                    }
                });
        }

        // Đóng modal đánh giá
        function closeRatingModal() {
            document.getElementById('guide-rating-modal').style.display = 'none';
            document.getElementById('guide-comment').value = '';
            window.currentRating = 0;
            highlightModalStars(0); // Reset stars
        }

        // Highlight stars trong modal
        function highlightModalStars(rating) {
            document.querySelectorAll('#modal-rating-stars i').forEach(star => {
                const starRating = star.dataset.rating;
                if (starRating <= rating) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });
        }

        // Mở modal đánh giá
        function openGuideRatingModal(guideId) {
            // Kiểm tra đăng nhập
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Vui lòng đăng nhập để đánh giá cẩm nang',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Đăng nhập',
                    cancelButtonText: 'Hủy',
                    confirmButtonColor: '#1a237e',
                    cancelButtonColor: '#d33'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('auth-modal').style.display = 'block';
                    }
                });
                return;
            }

            // Lấy thông tin cẩm nang
            firebase.database().ref(`travelGuides/${guideId}`).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const guide = snapshot.val();
                        document.getElementById('rating-guide-title').textContent = guide.title;
                        document.getElementById('guide-rating-modal').style.display = 'block';
                        window.currentRatingGuide = { id: guideId, title: guide.title };
                        
                        // Reset rating stars
                        window.currentRating = 0;
                        document.querySelectorAll('#modal-rating-stars i').forEach(star => {
                            star.classList.remove('fas');
                            star.classList.add('far');
                        });
                    }
                });
        }

        // Submit comment
        function submitComment() {
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Vui lòng đăng nhập để bình luận',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Đăng nhập',
                    cancelButtonText: 'Hủy',
                    confirmButtonColor: '#1a237e',
                    cancelButtonColor: '#d33'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('auth-modal').style.display = 'block';
                    }
                });
                return;
            }

            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            const imageFile = document.getElementById('comment-image-input').files[0];
            
            if (!commentText && !imageFile) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Vui lòng nhập nội dung bình luận hoặc chọn ảnh',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                return;
            }

            const guideSlug = window.currentCommentGuide.slug;
            const submitBtn = document.getElementById('comment-submit');
            
            // Disable button và hiển thị loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // Tạo comment object
            const comment = {
                text: commentText || '',
                userName: user.displayName || user.email,
                userId: user.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Function để lưu comment
            const saveComment = (commentData) => {
                return firebase.database().ref(`guideComments/${guideSlug}`).push(commentData)
                    .then(() => {
                        commentInput.value = '';
                        commentInput.style.height = 'auto';
                        removeCommentImage();
                        
                        // Toast notification
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true
                        });
                        Toast.fire({
                            icon: 'success',
                            title: 'Bình luận đã được đăng!'
                        });
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Không thể đăng bình luận. Vui lòng thử lại sau.',
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                        console.error("Error posting comment:", error);
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    });
            };

            // Nếu có ảnh, upload trước
            if (imageFile) {
                uploadImageToImgur(imageFile)
                    .then(imageUrl => {
                        comment.image = imageUrl;
                        return saveComment(comment);
                    })
                    .catch(error => {
                        console.error('Error uploading image:', error);
                        Swal.fire({
                            title: 'Lỗi upload ảnh!',
                            text: 'Không thể tải ảnh lên. Bình luận sẽ được đăng không có ảnh.',
                            icon: 'warning',
                            confirmButtonColor: '#e67e22'
                        });
                        // Đăng comment không có ảnh
                        saveComment(comment);
                    });
            } else {
                // Không có ảnh, đăng comment thông thường
                saveComment(comment);
            }
        }

        // Upload ảnh lên Imgur
        function uploadImageToImgur(imageFile) {
            const clientId = 'a3b8e5ec21a4b1b'; // Imgur Client ID miễn phí
            
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('image', imageFile);
                
                fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Client-ID ${clientId}`
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resolve(data.data.link);
                    } else {
                        reject(new Error('Upload failed'));
                    }
                })
                .catch(error => {
                    reject(error);
                });
            });
        }

        // Đóng modal comment
        function closeCommentModal() {
            document.getElementById('comment-modal').style.display = 'none';
            removeCommentImage(); // Clear any image preview when closing
        }

        // Xóa ảnh preview
        function removeCommentImage() {
            const input = document.getElementById('comment-image-input');
            const preview = document.getElementById('comment-image-preview');
            
            input.value = '';
            preview.style.display = 'none';
        }

        // Open image viewer
        function openImageViewer(imageUrl) {
            const modal = document.getElementById('image-viewer-modal');
            const image = document.getElementById('image-viewer-image');
            
            image.src = imageUrl;
            modal.style.display = 'block';
        }

        // Close image viewer
        function closeImageViewer() {
            document.getElementById('image-viewer-modal').style.display = 'none';
        }

        // Toggle like/dislike comment
        function toggleCommentLike(commentId, type, button) {
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Vui lòng đăng nhập để tương tác',
                    icon: 'warning',
                    confirmButtonColor: '#1a237e'
                });
                return;
            }

            const guideSlug = window.currentCommentGuide.slug;
            const isActive = button.classList.contains('active');
            const countElement = button.querySelector(type === 'like' ? '.like-count' : '.dislike-count');
            
            button.disabled = true;
            
            if (isActive) {
                // Remove like/dislike
                firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${type}s/${user.uid}`)
                    .remove()
                    .then(() => {
                        button.classList.remove('active');
                        const currentCount = parseInt(countElement.textContent) || 0;
                        countElement.textContent = Math.max(0, currentCount - 1);
                    })
                    .finally(() => {
                        button.disabled = false;
                    });
            } else {
                // Add like/dislike
                const oppositeType = type === 'like' ? 'dislike' : 'like';
                const oppositeButton = button.parentElement.querySelector(`.comment-${oppositeType}-btn`);
                
                // Remove opposite reaction if exists
                if (oppositeButton.classList.contains('active')) {
                    firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${oppositeType}s/${user.uid}`)
                        .remove()
                        .then(() => {
                            oppositeButton.classList.remove('active');
                            const oppositeCount = oppositeButton.querySelector(`.${oppositeType}-count`);
                            const currentCount = parseInt(oppositeCount.textContent) || 0;
                            oppositeCount.textContent = Math.max(0, currentCount - 1);
                        });
                }
                
                // Add new reaction
                firebase.database().ref(`guideComments/${guideSlug}/${commentId}/${type}s/${user.uid}`)
                    .set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        userName: user.displayName || user.email
                    })
                    .then(() => {
                        button.classList.add('active');
                        const currentCount = parseInt(countElement.textContent) || 0;
                        countElement.textContent = currentCount + 1;
                    })
                    .finally(() => {
                        button.disabled = false;
                    });
            }
        }

        // Show reply form
        function showReplyForm(commentId) {
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Vui lòng đăng nhập để trả lời',
                    icon: 'warning',
                    confirmButtonColor: '#1a237e'
                });
                return;
            }
            
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = 'block';
            replyForm.querySelector('.comment-reply-input').focus();
        }

        // Hide reply form
        function hideReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = 'none';
            replyForm.querySelector('.comment-reply-input').value = '';
        }

        // Submit reply
        function submitReply(commentId) {
            const user = firebase.auth().currentUser;
            if (!user) return;
            
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            const replyInput = replyForm.querySelector('.comment-reply-input');
            const replyText = replyInput.value.trim();
            
            if (!replyText) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Vui lòng nhập nội dung trả lời',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                return;
            }
            
            const guideSlug = window.currentCommentGuide.slug;
            const reply = {
                text: replyText,
                userName: user.displayName || user.email,
                userId: user.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            firebase.database().ref(`guideComments/${guideSlug}/${commentId}/replies`).push(reply)
                .then(() => {
                    hideReplyForm(commentId);
                    
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true
                    });
                    Toast.fire({
                        icon: 'success',
                        title: 'Trả lời đã được đăng!'
                    });
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Không thể đăng trả lời. Vui lòng thử lại.',
                        icon: 'error',
                        confirmButtonColor: '#e67e22'
                    });
                    console.error("Error posting reply:", error);
                });
        }

        // =================== CONTRIBUTE FUNCTIONS ===================

        // Submit đóng góp cẩm nang
        async function submitContribution() {
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire({
                    title: 'Yêu cầu đăng nhập',
                    text: 'Vui lòng đăng nhập để đóng góp cẩm nang',
                    icon: 'warning',
                    confirmButtonColor: '#1a237e'
                });
                return;
            }

            // Thu thập dữ liệu từ form
            const formData = {
                title: document.getElementById('contribute-title').value.trim(),
                category: document.getElementById('contribute-category').value,
                location: document.getElementById('contribute-location').value.trim(),
                duration: document.getElementById('contribute-duration').value.trim(),
                summary: document.getElementById('contribute-summary').value.trim(),
                content: document.getElementById('contribute-content').value.trim(),
                budget: document.getElementById('contribute-budget').value.trim(),
                season: document.getElementById('contribute-season').value.trim(),
                hotelRecommendations: collectHotelRecommendations(), // Thêm dữ liệu khách sạn
                authorId: user.uid,
                authorName: user.displayName || user.email,
                authorEmail: user.email,
                status: 'pending', // Chờ duyệt
                submittedAt: firebase.database.ServerValue.TIMESTAMP,
                slug: generateSlug(document.getElementById('contribute-title').value.trim())
            };

            // Validate dữ liệu
            if (!formData.title || !formData.category || !formData.location || !formData.summary || !formData.content) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Vui lòng điền đầy đủ các trường bắt buộc (*)',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                return;
            }

            // Khuyến khích nhưng không bắt buộc phải có khách sạn gợi ý
            if (formData.hotelRecommendations.length === 0) {
                const result = await Swal.fire({
                    title: 'Thiếu thông tin khách sạn',
                    text: 'Bạn chưa thêm khách sạn gợi ý nào. Điều này sẽ giúp du khách có thêm lựa chọn lưu trú. Bạn có muốn tiếp tục?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Tiếp tục gửi',
                    cancelButtonText: 'Quay lại thêm khách sạn',
                    confirmButtonColor: '#1a237e',
                    cancelButtonColor: '#e67e22'
                });
                
                if (!result.isConfirmed) {
                    return; // Dừng lại để user thêm khách sạn
                }
            }

            // Kiểm tra checkbox đồng ý
            if (!document.getElementById('contribute-agreement').checked) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Vui lòng đồng ý với điều khoản đóng góp',
                    icon: 'error',
                    confirmButtonColor: '#e67e22'
                });
                return;
            }

            // Hiển thị loading
            Swal.fire({
                title: 'Đang gửi...',
                text: 'Vui lòng đợi trong giây lát',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Xử lý upload ảnh (nếu có)
            const imageFile = document.getElementById('contribute-image').files[0];
            const submitData = (finalData) => {
                // Lưu vào Firebase Realtime Database
                firebase.database().ref('userContributions').push(finalData)
                    .then((ref) => {
                        // Gửi thông báo cho admin
                        const notificationData = {
                            type: 'contribution',
                            title: 'Cẩm nang mới chờ duyệt',
                            message: `${formData.authorName} đã gửi cẩm nang "${formData.title}" chờ duyệt`,
                            contributionId: ref.key,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            isRead: false
                        };
                        
                        return firebase.database().ref('adminNotifications').push(notificationData);
                    })
                    .then(() => {
                        // Gửi email thông báo cho admin
                        return emailjs.send("service_6spwxxw", "template_vcjlg02", {
                            to_email: "quantrikhachsan001@gmail.com",
                            from_name: formData.authorName,
                            from_email: formData.authorEmail,
                            message: `Cẩm nang mới: "${formData.title}" - Địa điểm: ${formData.location} - Danh mục: ${formData.category}`,
                            title: "Cẩm nang mới chờ duyệt",
                            timestamp: new Date().toLocaleString('vi-VN')
                        });
                    })
                    .then(() => {
                        Swal.fire({
                            title: 'Gửi thành công!',
                            html: `
                                <p>Cảm ơn bạn đã đóng góp cẩm nang <strong>"${formData.title}"</strong></p>
                                <p>Cẩm nang sẽ được admin xem xét và duyệt trong vòng 1-2 ngày làm việc.</p>
                                <p>Chúng tôi sẽ thông báo kết quả qua email.</p>
                            `,
                            icon: 'success',
                            confirmButtonColor: '#1a237e',
                            confirmButtonText: 'Đã hiểu'
                        });
                        
                        // Reset form và đóng modal
                        resetContributeForm();
                        document.getElementById('contribute-modal').style.display = 'none';
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Không thể gửi cẩm nang. Vui lòng thử lại sau.',
                            icon: 'error',
                            confirmButtonColor: '#e67e22'
                        });
                        console.error("Error submitting contribution:", error);
                    });
            };

            // Upload ảnh nếu có
            if (imageFile) {
                uploadImageToImgur(imageFile)
                    .then(imageUrl => {
                        formData.main_image = imageUrl;
                        submitData(formData);
                    })
                    .catch(error => {
                        console.error('Error uploading image:', error);
                        // Vẫn submit mà không có ảnh
                        formData.main_image = '/images/default-guide.jpg';
                        submitData(formData);
                    });
            } else {
                // Không có ảnh, dùng ảnh mặc định
                formData.main_image = '/images/default-guide.jpg';
                submitData(formData);
            }
        }

        // Generate slug từ title
        function generateSlug(title) {
            return title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/[đĐ]/g, 'd')
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Remove multiple hyphens
                .trim('-'); // Remove leading/trailing hyphens
        }

        // Xóa ảnh preview
        function removeContributeImage() {
            document.getElementById('contribute-image').value = '';
            document.getElementById('contribute-image-preview').style.display = 'none';
        }

        // =================== HOTEL RECOMMENDATION FUNCTIONS ===================

        // Thêm khách sạn gợi ý mới
        function addHotelRecommendation() {
            const container = document.getElementById('hotel-recommendations');
            const newHotelDiv = document.createElement('div');
            newHotelDiv.className = 'hotel-recommendation-item';
            newHotelDiv.style.cssText = 'border: 2px dashed #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px;';
            
            newHotelDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-hotel"></i> Tên khách sạn
                            </label>
                            <input type="text" class="form-control hotel-name" 
                                placeholder="VD: Sapa Paradise Hotel"
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-star"></i> Đánh giá (1-5 sao)
                            </label>
                            <select class="form-control hotel-rating" 
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">Chọn đánh giá</option>
                                <option value="5">⭐⭐⭐⭐⭐ (5 sao - Tuyệt vời)</option>
                                <option value="4">⭐⭐⭐⭐ (4 sao - Rất tốt)</option>
                                <option value="3">⭐⭐⭐ (3 sao - Tốt)</option>
                                <option value="2">⭐⭐ (2 sao - Tạm được)</option>
                                <option value="1">⭐ (1 sao - Không tốt)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-dollar-sign"></i> Giá phòng ước tính
                            </label>
                            <input type="text" class="form-control hotel-price" 
                                placeholder="VD: 800.000 - 1.200.000 VND/đêm"
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                                <i class="fas fa-map-marker-alt"></i> Vị trí cụ thể
                            </label>
                            <input type="text" class="form-control hotel-location" 
                                placeholder="VD: Trung tâm thị trấn Sapa"
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                        <i class="fas fa-comment"></i> Nhận xét về khách sạn
                    </label>
                    <textarea class="form-control hotel-review" rows="3" 
                        placeholder="Chia sẻ trải nghiệm: dịch vụ, vệ sinh, view, tiện ích, ưu/nhược điểm..."
                        style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                </div>

                <div class="form-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1a237e;">
                        <i class="fas fa-check-circle"></i> Gợi ý đặt phòng
                    </label>
                    <select class="form-control hotel-recommendation" 
                        style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">Chọn mức độ gợi ý</option>
                        <option value="highly-recommended">🔥 Rất khuyến khích - Tuyệt vời!</option>
                        <option value="recommended">👍 Khuyến khích - Đáng thử</option>
                        <option value="okay">😐 Tạm được - Có thể cân nhắc</option>
                        <option value="not-recommended">👎 Không khuyến khích</option>
                    </select>
                </div>

                <button type="button" class="remove-hotel-btn" onclick="removeHotelRecommendation(this)" 
                    style="background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer; font-size: 12px;">
                    <i class="fas fa-trash"></i> Xóa khách sạn này
                </button>
            `;
            
            container.appendChild(newHotelDiv);
        }

        // Xóa khách sạn gợi ý
        function removeHotelRecommendation(button) {
            const hotelItem = button.closest('.hotel-recommendation-item');
            const container = document.getElementById('hotel-recommendations');
            
            // Không cho xóa nếu chỉ còn 1 item
            if (container.children.length > 1) {
                hotelItem.remove();
            } else {
                Swal.fire({
                    title: 'Thông báo',
                    text: 'Cần ít nhất 1 khách sạn gợi ý. Hãy thêm khách sạn khác trước khi xóa.',
                    icon: 'info',
                    confirmButtonColor: '#1a237e'
                });
            }
        }

        // Thu thập dữ liệu khách sạn từ form
        function collectHotelRecommendations() {
            const hotelItems = document.querySelectorAll('.hotel-recommendation-item');
            const hotels = [];
            
            hotelItems.forEach(item => {
                const name = item.querySelector('.hotel-name').value.trim();
                const rating = item.querySelector('.hotel-rating').value;
                const price = item.querySelector('.hotel-price').value.trim();
                const location = item.querySelector('.hotel-location').value.trim();
                const review = item.querySelector('.hotel-review').value.trim();
                const recommendation = item.querySelector('.hotel-recommendation').value;
                
                // Chỉ thêm nếu có ít nhất tên khách sạn
                if (name) {
                    hotels.push({
                        name,
                        rating: rating || null,
                        price: price || null,
                        location: location || null,
                        review: review || null,
                        recommendation: recommendation || null
                    });
                }
            });
            
            return hotels;
        }

        // Reset form đóng góp
        function resetContributeForm() {
            document.getElementById('contribute-form').reset();
            removeContributeImage();
            
            // Reset về chỉ 1 khách sạn recommendation
            const container = document.getElementById('hotel-recommendations');
            const firstHotel = container.querySelector('.hotel-recommendation-item');
            
            // Clear tất cả hotels
            container.innerHTML = '';
            
            // Thêm lại 1 hotel trống
            addHotelRecommendation();
        }

    </script>
    <!-- <script src="https://app.tudongchat.com/js/chatbox.js"></script>
<script>
  const tudong_chatbox = new TuDongChat('uJVgdUIOTh0OIAMlQoEWD')
  tudong_chatbox.initial()
</script> -->
<!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/684e312c6b65fa190ea6f4dd/1iton06be';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>

<script>
// Hàm tạo thông báo cho admin
function generateNotification(icon, color, text, link = '#') {
    const newNotif = {
        icon: icon,
        color: color,
        text: text,
        link: link,
        read: false,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    firebase.database().ref('notifications').push(newNotif);
}
</script>
<!-- Bottom Navigation Bar for Mobile -->
<nav class="bottom-nav d-md-none d-lg-none">
    <a href="index.html" class="bottom-nav-item ">
        <i class="fas fa-home"></i>
        <span>Trang chủ</span>
    </a>
    <a href="hotel.html" class="bottom-nav-item">
        <i class="fas fa-hotel"></i>
        <span>Khách sạn</span>
    </a>
    <a href="tours.html" class="bottom-nav-item">
        <i class="fas fa-map-marked-alt"></i>
        <span>Tours</span>
    </a>
    <a href="prioritize.html" class="bottom-nav-item">
        <i class="fas fa-gift"></i>
        <span>Ưu đãi</span>
    </a>
    <a href="travel_guide.html" class="bottom-nav-item active">
        <i class="fas fa-map-marked-alt"></i>
        <span>Cẩm nang</span>
    <a href="about_us.html" class="bottom-nav-item">
        <i class="fas fa-phone"></i>
        <span>Liên hệ</span>
    </a>
    <a href="member.html" class="bottom-nav-item">
        <i class="fas fa-user"></i>
        <span>Tài khoản</span>
    </a>
    
    </a>
</nav>

<script>
// =================== RATING MODAL FUNCTIONS ===================
// Functions cần thiết để xử lý rating modal

// Set rating cho modal stars
window.setModalRating = function(rating) {
    console.log('Setting modal rating:', rating);
    window.currentRating = rating;
    highlightModalStars(rating);
}

// Highlight modal stars
window.highlightModalStars = function(rating) {
    document.querySelectorAll('#modal-rating-stars i').forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        if (starRating <= rating) {
            star.classList.remove('far');
            star.classList.add('fas');
        } else {
            star.classList.remove('fas');
            star.classList.add('far');
        }
    });
}

// Submit rating (phải là global function)
window.submitGuideRating = function() {
    const user = firebase.auth().currentUser;
    if (!user) {
        Swal.fire({
            title: 'Yêu cầu đăng nhập',
            text: 'Vui lòng đăng nhập để đánh giá',
            icon: 'warning',
            confirmButtonColor: '#1a237e'
        });
        return;
    }

    const guide = window.currentRatingGuide;
    const rating = window.currentRating || 0;
    const comment = document.getElementById('guide-comment').value;

    console.log('Submitting rating:', rating, 'for guide:', guide);

    if (rating == 0) {
        Swal.fire({
            title: 'Lỗi!',
            text: 'Vui lòng chọn số sao đánh giá',
            icon: 'error',
            confirmButtonColor: '#e67e22'
        });
        return;
    }

    // Hiển thị loading
    Swal.fire({
        title: 'Đang gửi...',
        text: 'Vui lòng đợi trong giây lát',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // Lưu đánh giá vào Firebase
    const ratingRef = firebase.database().ref(`guideRatings/${guide.id}/${user.uid}`);
    ratingRef.set({
        rating: parseInt(rating),
        comment: comment,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        userName: user.displayName || user.email
    }).then(() => {
        Swal.fire({
            title: 'Thành công!',
            text: 'Cảm ơn bạn đã đánh giá cẩm nang',
            icon: 'success',
            confirmButtonColor: '#e67e22'
        });
        
        // Đóng modal
        document.getElementById('guide-rating-modal').style.display = 'none';
        document.getElementById('guide-comment').value = '';
        window.currentRating = 0;
        highlightModalStars(0);
        
    }).catch(error => {
        Swal.fire({
            title: 'Lỗi!',
            text: 'Không thể gửi đánh giá. Vui lòng thử lại sau.',
            icon: 'error',
            confirmButtonColor: '#e67e22'
        });
        console.error("Error submitting rating:", error);
    });
}

// Close rating modal
window.closeRatingModal = function() {
    document.getElementById('guide-rating-modal').style.display = 'none';
    document.getElementById('guide-comment').value = '';
    window.currentRating = 0;
    highlightModalStars(0);
}

// Toggle favorite - Global function
window.toggleFavorite = function(guideSlug, button) {
    const user = firebase.auth().currentUser;
    if (!user) {
        Swal.fire({
            title: 'Yêu cầu đăng nhập',
            text: 'Vui lòng đăng nhập để lưu cẩm nang yêu thích',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Đăng nhập',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#1a237e',
            cancelButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('auth-modal').style.display = 'block';
            }
        });
        return;
    }

    const isFavorited = button.classList.contains('active');
    
    // Disable button để tránh spam click
    button.disabled = true;
    
    // Thêm animation cho button
    button.style.transform = 'scale(1.2)';
    setTimeout(() => {
        button.style.transform = 'scale(1)';
    }, 200);

    if (isFavorited) {
        // Bỏ yêu thích - chỉ xóa từ favorites của user và travelGuides (nếu có)
        const favoriteRef = firebase.database().ref(`users/${user.uid}/favorites/${guideSlug}`);
        const travelGuideLikesRef = firebase.database().ref(`travelGuides/${guideSlug}/likes/${user.uid}`);
        // Lưu likes cho userContributions vào bảng riêng
        const userContributionLikesRef = firebase.database().ref(`guideLikes/${guideSlug}/${user.uid}`);
        
        Promise.all([
            favoriteRef.remove(),
            travelGuideLikesRef.remove(),
            userContributionLikesRef.remove() // Xóa từ bảng guideLikes riêng
        ]).then(() => {
            // Cập nhật UI ngay lập tức
            button.classList.remove('active');
            button.querySelector('i').classList.remove('fas');
            button.querySelector('i').classList.add('far');
            
            // Cập nhật số lượt like ngay lập tức
            const likeCountElement = button.querySelector('.like-count');
            if (likeCountElement) {
                const currentCount = parseInt(likeCountElement.textContent) || 0;
                likeCountElement.textContent = Math.max(0, currentCount - 1);
            }
            
            // Hiển thị thông báo nhỏ
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true
            });
            Toast.fire({
                icon: 'info',
                title: 'Đã bỏ thích'
            });
        }).catch(error => {
            console.error('Error removing favorite:', error);
        }).finally(() => {
            button.disabled = false;
        });
    } else {
        // Thêm yêu thích - xác định nguồn và lưu đúng cách
        const favoriteRef = firebase.database().ref(`users/${user.uid}/favorites/${guideSlug}`);
        
        // Function để xác định nguồn và lưu like
        const saveLikeToCorrectSource = async () => {
            let likeSaved = false;
            
            // Thử kiểm tra xem guide có trong travelGuides không
            try {
                const travelGuideSnapshot = await firebase.database().ref(`travelGuides/${guideSlug}`).once('value');
                if (travelGuideSnapshot.exists()) {
                    await firebase.database().ref(`travelGuides/${guideSlug}/likes/${user.uid}`).set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        userName: user.displayName || user.email
                    });
                    likeSaved = true;
                    console.log('Like saved to travelGuides');
                }
            } catch (error) {
                console.log('Guide not found in travelGuides');
            }
            
            // Nếu không có trong travelGuides, có thể là từ userContributions
            // Lưu vào bảng guideLikes riêng thay vì userContributions trực tiếp
            if (!likeSaved) {
                try {
                    const userContributionSnapshot = await firebase.database().ref(`userContributions/${guideSlug}`).once('value');
                    if (userContributionSnapshot.exists()) {
                        // Lưu vào bảng guideLikes riêng biệt
                        await firebase.database().ref(`guideLikes/${guideSlug}/${user.uid}`).set({
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            userName: user.displayName || user.email,
                            source: 'userContributions' // Đánh dấu nguồn
                        });
                        console.log('Like saved to guideLikes for userContribution');
                    }
                } catch (error) {
                    console.error('Error saving like to guideLikes:', error);
                }
            }
        };
        
        Promise.all([
            favoriteRef.set({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                guideSlug: guideSlug
            }),
            saveLikeToCorrectSource()
        ]).then(() => {
            // Cập nhật UI ngay lập tức
            button.classList.add('active');
            button.querySelector('i').classList.remove('far');
            button.querySelector('i').classList.add('fas');
            
            // Cập nhật số lượt like ngay lập tức
            const likeCountElement = button.querySelector('.like-count');
            if (likeCountElement) {
                const currentCount = parseInt(likeCountElement.textContent) || 0;
                likeCountElement.textContent = currentCount + 1;
            }
            
            // Hiển thị thông báo nhỏ với animation tim
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true
            });
            Toast.fire({
                icon: 'success',
                title: 'Đã thích! ❤️'
            });
        }).catch(error => {
            console.error('Error adding favorite:', error);
            Swal.fire({
                title: 'Lỗi!',
                text: 'Không thể thêm vào yêu thích. Vui lòng thử lại.',
                icon: 'error',
                confirmButtonColor: '#e67e22'
            });
        }).finally(() => {
            button.disabled = false;
        });
    }
}

// Open comment modal - Global function
window.openCommentModal = function(guideSlug, guideTitle) {
    document.getElementById('comment-guide-title').textContent = guideTitle;
    document.getElementById('comment-modal').style.display = 'block';
    window.currentCommentGuide = { slug: guideSlug, title: guideTitle };
    
    // Load comments cho guide này
    loadComments(guideSlug);
}

// Close comment modal - Global function
window.closeCommentModal = function() {
    document.getElementById('comment-modal').style.display = 'none';
    removeCommentImage(); // Clear any image preview when closing
}

// Load comments function - Global
function loadComments(guideSlug) {
    const commentsContainer = document.getElementById('comments-container');
    
    firebase.database().ref(`guideComments/${guideSlug}`).orderByChild('timestamp').on('value', (snapshot) => {
        if (snapshot.exists()) {
            const commentsData = snapshot.val();
            const comments = Object.keys(commentsData).map(key => ({
                id: key,
                ...commentsData[key]
            })).reverse(); // Newest first
            
            commentsContainer.innerHTML = '';
            
            comments.forEach(comment => {
                const commentElement = createCommentElement(comment);
                commentsContainer.appendChild(commentElement);
            });
        } else {
            commentsContainer.innerHTML = `
                <div class="no-comments">
                    <p>Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
                </div>`;
        }
    });
}
</script>

</body>

</html>