<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán - Luxury Haven</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Thêm SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Add CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <!-- Thêm SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .checkout-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }
        .checkout-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .order-summary {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .payment-method {
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .payment-method:hover {
            border-color: #0d6efd;
        }
        .payment-method.selected {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .btn-checkout {
            background-color: #0d6efd;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            width: 100%;
        }
        .btn-checkout:hover {
            background-color: #0b5ed7;
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <h1 class="text-center mb-4">Thanh Toán</h1>
        
        <div class="row">
            <!-- Form Thanh Toán -->
            <div class="col-md-8">
                <div class="checkout-form">
                    <h3 class="mb-4">Thông Tin Thanh Toán</h3>
                    <form id="checkoutForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">Họ</label>
                                <input type="text" class="form-control" id="firstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Tên</label>
                                <input type="text" class="form-control" id="lastName" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">Số Điện Thoại</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Địa Chỉ</label>
                            <input type="text" class="form-control" id="address" required>
                        </div>

                    
                        <h4 class="mt-4 mb-3">Phương Thức Thanh Toán</h4>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPayment('credit')">
                                <input type="radio" name="payment" id="credit" value="credit">
                                <label for="credit">Thẻ Tín Dụng</label>
                                <i class="fas fa-credit-card float-end"></i>
                                <div id="creditDetails" class="payment-details mt-3" style="display: none;">
                                    <div class="mb-3">
                                        <label for="cardNumber" class="form-label">Số thẻ</label>
                                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456">
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="expiryDate" class="form-label">Ngày hết hạn</label>
                                            <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="cvv" class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="cvv" placeholder="123">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="cardName" class="form-label">Tên chủ thẻ</label>
                                        <input type="text" class="form-control" id="cardName" placeholder="NGUYEN VAN A">
                                    </div>
                                </div>
                            </div>

                            <div class="payment-method" onclick="selectPayment('momo')">
                                <input type="radio" name="payment" id="momo" value="momo">
                                <label for="momo">Ví MoMo</label>
                                <i class="fas fa-wallet float-end"></i>
                                <div id="momoDetails" class="payment-details mt-3" style="display: none;">
                                    <div class="text-center">
                                        <div class="momo-qr-placeholder mb-3" style="width: 200px; height: 200px; margin: 0 auto; background: #f8f9fa; display: flex; align-items: center; justify-content: center; border: 1px solid #dee2e6;">
                                            <i class="fas fa-qrcode fa-3x text-muted"></i>
                                        </div>
                                        <p>Quét mã QR bằng ứng dụng MoMo để thanh toán</p>
                                    </div>
                                </div>
                            </div>

                            <div class="payment-method" onclick="selectPayment('bank')">
                                <input type="radio" name="payment" id="bank" value="bank">
                                <label for="bank">Chuyển Khoản Ngân Hàng</label>
                                <i class="fas fa-university float-end"></i>
                                <div id="bankDetails" class="payment-details mt-3" style="display: none;">
                                    <div class="bank-info">
                                        <p><strong>Ngân hàng:</strong> Vietcombank</p>
                                        <p><strong>Số tài khoản:</strong> 1234567890</p>
                                        <p><strong>Chủ tài khoản:</strong> CONG TY TNHH LUXURY HAVEN</p>
                                        <p><strong>Số tiền:</strong> <span id="bankAmount"></span></p>
                                        <p><strong>Nội dung chuyển khoản:</strong> <span id="transferContent"></span></p>
                                    </div>
                                </div>
                            </div>

                            <div class="payment-method" onclick="selectPayment('vnpay')">
                                <input type="radio" name="payment" id="vnpay" value="vnpay">
                                <label for="vnpay">VNPay</label>
                                <i class="fas fa-credit-card float-end"></i>
                                <div id="vnpayDetails" class="payment-details mt-3" style="display: none;">
                                    <div class="text-center">
                                        <img src="https://sandbox.vnpayment.vn/apis/vnpay-demo/images/vnpay-logo.png" alt="VNPay Logo" style="max-width: 200px;">
                                        <p class="mt-3">Thanh toán qua cổng thanh toán VNPay</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tổng Kết Đơn Hàng -->
            <div class="col-md-4">
                <div class="order-summary">
                    <h3 class="mb-4">Tổng Kết Đơn Hàng</h3>
                    <div class="hotel-info mb-4">
                        <h5 id="hotelName">Đang tải...</h5>
                        <p class="mb-1" id="roomType">Đang tải...</p>
                        <p class="mb-1" id="stayInfo">Đang tải...</p>
                        <p class="mb-1" id="checkInOut">Đang tải...</p>
                        <p class="mb-1" id="hotelAddress">Đang tải...</p>
                        <p class="mb-1" id="hotelPhone">Đang tải...</p>
                    </div>
                    
                    <div class="price-details">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Giá phòng</span>
                            <span id="roomPrice">Đang tải...</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Thuế và phí</span>
                            <span id="taxAndFees">Đang tải...</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Tổng cộng</strong>
                            <strong id="totalPrice">Đang tải...</strong>
                        </div>
                    </div>

                    <button class="btn btn-checkout" onclick="processCheckout()">
                        Xác Nhận Thanh Toán
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, get, set, serverTimestamp, update, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.firebasestorage.app",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Đặt biến urlParams và bookingId ở ngoài cùng để dùng chung
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('bookingId');

        // VNPay Configuration
        const vnpayConfig = {
            vnp_TmnCode: "9SMU243L",
            vnp_HashSecret: "54NPAQSBPH9OZN9SEAP4JJ6MUSEY6C2G",
            vnp_Url: "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html",
            vnp_ReturnUrl: window.location.origin + "/vnpay_return.html"
        };

        // Hàm format tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Hàm format ngày tháng theo định dạng VNPay (yyyyMMddHHmmss)
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}${hours}${minutes}${seconds}`;
        }

        // Hàm tạo mã giao dịch duy nhất trong ngày
        function generateTxnRef() {
            const now = new Date();
            const timestamp = now.getTime().toString();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `BOOK${timestamp}${random}`;
        }

        // Hàm tạo URL thanh toán VNPay
        function createVNPayPaymentUrl(orderInfo) {
            const date = new Date();
            const createDate = formatDate(date);
            const expireDate = new Date(date.getTime() + 15 * 60 * 1000); // 15 phút
            const expireDateStr = formatDate(expireDate);

            // Số tiền phải là số nguyên, không có dấu chấm, là VND * 100
            const amount = Math.round(orderInfo.totalPrice) * 100;
            if (!Number.isInteger(amount) || amount <= 0) {
                throw new Error('Số tiền không hợp lệ');
            }

            const txnRef = generateTxnRef();

            // Chỉ gửi các tham số bắt buộc
            const inputData = {
                vnp_Version: '2.1.0',
                vnp_Command: 'pay',
                vnp_TmnCode: vnpayConfig.vnp_TmnCode,
                vnp_Amount: amount.toString(),
                vnp_CurrCode: 'VND',
                vnp_TxnRef: txnRef,
                vnp_OrderInfo: `Thanh toan don hang ${txnRef}`,
                vnp_OrderType: 'other',
                vnp_Locale: 'vn',
                vnp_ReturnUrl: vnpayConfig.vnp_ReturnUrl,
                vnp_IpAddr: '127.0.0.1',
                vnp_CreateDate: createDate,
                vnp_ExpireDate: expireDateStr
            };

            // Sắp xếp các tham số theo thứ tự alphabet
            const sortedParams = Object.keys(inputData)
                .sort()
                .reduce((acc, key) => {
                    acc[key] = inputData[key];
                    return acc;
                }, {});

            // Tạo chuỗi ký tự
            const signData = Object.entries(sortedParams)
                .map(([key, value]) => `${key}=${value}`)
                .join('&');

            // Tạo chữ ký
            const hmac = CryptoJS.HmacSHA512(signData, vnpayConfig.vnp_HashSecret);
            const vnp_SecureHash = hmac.toString(CryptoJS.enc.Hex);

            // Tạo URL thanh toán
            const queryString = `${signData}&vnp_SecureHash=${vnp_SecureHash}`;
            return `${vnpayConfig.vnp_Url}?${queryString}`;
        }

        // Lấy thông tin đặt phòng từ Firebase
        async function loadBookingInfo() {
            console.log('Bắt đầu tải thông tin đặt phòng - bookingId:', bookingId);
            if (!bookingId) {
                alert('Không tìm thấy thông tin đặt phòng!');
                return;
            }

            try {
                // Lấy thông tin booking
                const bookingRef = ref(database, `bookings/${bookingId}`);
                const bookingSnapshot = await get(bookingRef);
                const bookingData = bookingSnapshot.val();
                console.log('Dữ liệu booking:', bookingData);

                if (!bookingData) {
                    alert('Không tìm thấy thông tin đặt phòng!');
                    return;
                }

                // Lấy thông tin khách sạn từ location
                const locationRef = ref(database, 'location');
                const locationSnapshot = await get(locationRef);
                const locationData = locationSnapshot.val();
                console.log('Dữ liệu location:', locationData);

                // Tìm khách sạn dựa trên hotelId
                let hotelData = null;
                let selectedRoom = null;

                // Tìm khách sạn trong tất cả các thành phố
                for (const city in locationData) {
                    if (locationData[city].hotels) {
                        const hotels = locationData[city].hotels;
                        for (let i = 0; i < hotels.length; i++) {
                            if (hotels[i].tenKhachSan === bookingData.hotelId) {
                                hotelData = hotels[i];
                                // Tìm thông tin phòng
                                if (hotelData.chiTiet && hotelData.chiTiet.rooms) {
                                    selectedRoom = hotelData.chiTiet.rooms.find(room => 
                                        room.name === bookingData.roomId || 
                                        `Phòng ${room.name}` === bookingData.roomId
                                    );
                                }
                                break;
                            }
                        }
                        if (hotelData) break;
                    }
                }

                console.log('Dữ liệu khách sạn tìm thấy:', hotelData);
                console.log('Thông tin phòng tìm thấy:', selectedRoom);

                if (hotelData) {
                    // Cập nhật thông tin khách sạn
                    document.getElementById('hotelName').textContent = hotelData.tenKhachSan;
                    document.getElementById('hotelAddress').textContent = `Địa chỉ: ${hotelData.diaChi}`;
                    document.getElementById('hotelPhone').textContent = `Điện thoại: ${hotelData.phone}`;

                    if (selectedRoom) {
                        document.getElementById('roomType').textContent = `Phòng ${selectedRoom.name} - ${selectedRoom.size}`;
                        
                        // Cập nhật giá phòng và phí dịch vụ
                        const roomPrice = selectedRoom.price;
                        const serviceFee = hotelData.serviceFee || 200000;
                        const totalPrice = roomPrice + serviceFee;

                        document.getElementById('roomPrice').textContent = formatCurrency(roomPrice);
                        document.getElementById('taxAndFees').textContent = formatCurrency(serviceFee);
                        document.getElementById('totalPrice').textContent = formatCurrency(totalPrice);
                    } else {
                        // Sử dụng giá từ booking nếu không tìm thấy thông tin phòng
                        const roomPrice = parseInt(bookingData.price) || 2000000;
                        const serviceFee = parseInt(bookingData.taxAndFees) || 200000;
                        const totalPrice = roomPrice + serviceFee;

                        document.getElementById('roomType').textContent = bookingData.roomId || 'Phòng Deluxe';
                        document.getElementById('roomPrice').textContent = formatCurrency(roomPrice);
                        document.getElementById('taxAndFees').textContent = formatCurrency(serviceFee);
                        document.getElementById('totalPrice').textContent = formatCurrency(totalPrice);
                    }
                } else {
                    // Sử dụng dữ liệu từ booking nếu không tìm thấy khách sạn
                    document.getElementById('hotelName').textContent = bookingData.hotelId || 'Luxury Haven Hotel';
                    document.getElementById('hotelAddress').textContent = 'Địa chỉ: Đang cập nhật...';
                    document.getElementById('hotelPhone').textContent = 'Điện thoại: Đang cập nhật...';
                    document.getElementById('roomType').textContent = bookingData.roomId || 'Phòng Deluxe';
                    
                    const roomPrice = parseInt(bookingData.price) || 2000000;
                    const serviceFee = parseInt(bookingData.taxAndFees) || 200000;
                    const totalPrice = roomPrice + serviceFee;

                    document.getElementById('roomPrice').textContent = formatCurrency(roomPrice);
                    document.getElementById('taxAndFees').textContent = formatCurrency(serviceFee);
                    document.getElementById('totalPrice').textContent = formatCurrency(totalPrice);
                }

                // Cập nhật thông tin đặt phòng
                const checkInDate = bookingData.checkIn || bookingData.checkInDate;
                const checkOutDate = bookingData.checkOut || bookingData.checkOutDate;
                
                document.getElementById('stayInfo').textContent = 
                    `${bookingData.guests || 2} người`;
                document.getElementById('checkInOut').textContent = 
                    `Check-in: ${checkInDate} - Check-out: ${checkOutDate}`;

                // Tự động điền thông tin người dùng
                if (bookingData.guestInfo) {
                    // Cấu trúc mới
                    const guestInfo = bookingData.guestInfo;
                    if (guestInfo.name) {
                        const nameParts = guestInfo.name.split(' ');
                        const lastName = nameParts.pop() || '';
                        const firstName = nameParts.join(' ');
                        document.getElementById('firstName').value = firstName;
                        document.getElementById('lastName').value = lastName;
                    }
                    if (guestInfo.email) document.getElementById('email').value = guestInfo.email;
                    if (guestInfo.phone) document.getElementById('phone').value = guestInfo.phone;
                    if (guestInfo.address) document.getElementById('address').value = guestInfo.address;
                } else {
                    // Cấu trúc cũ
                    if (bookingData.name) {
                        const nameParts = bookingData.name.split(' ');
                        const lastName = nameParts.pop() || '';
                        const firstName = nameParts.join(' ');
                        document.getElementById('firstName').value = firstName;
                        document.getElementById('lastName').value = lastName;
                    }
                    if (bookingData.email) document.getElementById('email').value = bookingData.email;
                    if (bookingData.phone) document.getElementById('phone').value = bookingData.phone;
                    if (bookingData.address) document.getElementById('address').value = bookingData.address;
                }
            } catch (error) {
                console.error('Lỗi khi tải thông tin:', error);
                alert('Có lỗi xảy ra khi tải thông tin đặt phòng!');
            }
        }

        // Hàm chọn phương thức thanh toán
        window.selectPayment = function(method) {
            // Ẩn tất cả các chi tiết thanh toán
            document.querySelectorAll('.payment-details').forEach(el => {
                el.style.display = 'none';
            });
            
            // Xóa trạng thái selected của tất cả các phương thức
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Hiển thị chi tiết của phương thức được chọn
            document.querySelector(`#${method}Details`).style.display = 'block';
            document.querySelector(`#${method}`).parentElement.classList.add('selected');
            document.querySelector(`#${method}`).checked = true;

            // Cập nhật thông tin chuyển khoản nếu cần
            if (method === 'bank') {
                const totalPrice = document.getElementById('totalPrice').textContent;
                document.getElementById('bankAmount').textContent = totalPrice;
                document.getElementById('transferContent').textContent = `THANH TOAN ${bookingId}`;
            }
        }

        // Hàm tạo chuỗi ký tự ngẫu nhiên
        function generateRandomString(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // Hàm tạo chữ ký VNPay
        function createVNPaySignature(inputData) {
            const sortedParams = Object.keys(inputData)
                .sort()
                .reduce((acc, key) => {
                    acc[key] = inputData[key];
                    return acc;
                }, {});

            const signData = Object.entries(sortedParams)
                .map(([key, value]) => `${key}=${value}`)
                .join('&');

            const hmac = CryptoJS.HmacSHA512(signData, vnpayConfig.vnp_HashSecret);
            return hmac.toString(CryptoJS.enc.Hex);
        }

        // Cập nhật hàm processVNPayPayment
        async function processVNPayPayment(bookingId, amount) {
            try {
                if (!bookingId) {
                    throw new Error('Mã đặt phòng không hợp lệ');
                }

                // Kiểm tra user đã đăng nhập
                if (!auth.currentUser) {
                    throw new Error('Vui lòng đăng nhập để thực hiện thanh toán');
                }

                // Kiểm tra quyền truy cập booking
                const bookingRef = ref(database, `bookings/${bookingId}`);
                const bookingSnapshot = await get(bookingRef);
                const bookingData = bookingSnapshot.val();

                if (!bookingData) {
                    throw new Error('Không tìm thấy thông tin đặt phòng');
                }

                // Kiểm tra xem user có quyền thanh toán booking này không
                if (bookingData.userId && bookingData.userId !== auth.currentUser.uid) {
                    throw new Error('Bạn không có quyền thanh toán đơn đặt phòng này');
                }

                // Tạo mã giao dịch duy nhất
                const txnRef = generateTxnRef();
                
                // Lấy địa chỉ IP của người dùng
                const ipAddr = await getClientIp();
                
                // Tạo thời gian hiện tại và thời gian hết hạn
                const createDate = moment().format('YYYYMMDDHHmmss');
                const expireDate = moment().add(15, 'minutes').format('YYYYMMDDHHmmss');

                // Chuẩn bị dữ liệu thanh toán
                const vnp_Params = {
                    vnp_Version: '2.1.0',
                    vnp_Command: 'pay',
                    vnp_TmnCode: vnpayConfig.vnp_TmnCode,
                    vnp_Locale: 'vn',
                    vnp_CurrCode: 'VND',
                    vnp_TxnRef: txnRef,
                    vnp_OrderInfo: `Thanh toan dat phong ${bookingId}`,
                    vnp_OrderType: 'other',
                    vnp_Amount: Math.round(amount * 100).toString(),
                    vnp_ReturnUrl: vnpayConfig.vnp_ReturnUrl,
                    vnp_IpAddr: ipAddr,
                    vnp_CreateDate: createDate,
                    vnp_ExpireDate: expireDate
                };

                // Sắp xếp tham số theo thứ tự alphabet
                const sortedParams = Object.keys(vnp_Params)
                    .sort()
                    .reduce((acc, key) => {
                        acc[key] = vnp_Params[key];
                        return acc;
                    }, {});

                // Tạo chuỗi ký tự cần mã hóa
                const signData = Object.entries(sortedParams)
                    .map(([key, value]) => `${key}=${encodeURIComponent(value).replace(/%20/g, '+')}`)
                    .join('&');

                // Tạo chữ ký
                const hmac = CryptoJS.HmacSHA512(signData, vnpayConfig.vnp_HashSecret);
                const vnp_SecureHash = hmac.toString(CryptoJS.enc.Hex);

                // Thêm chữ ký vào tham số
                sortedParams.vnp_SecureHash = vnp_SecureHash;

                // Tạo URL thanh toán
                const paymentUrl = vnpayConfig.vnp_Url + '?' + Object.entries(sortedParams)
                    .map(([key, value]) => `${key}=${encodeURIComponent(value).replace(/%20/g, '+')}`)
                    .join('&');

                try {
                    // Cập nhật trạng thái thanh toán trong Firebase
                    const paymentRef = ref(database, `bookings/${bookingId}/payments/${auth.currentUser.uid}`);
                    
                    // Cập nhật thông tin payment
                    await update(ref(database, `bookings/${bookingId}`), {
                        userId: auth.currentUser.uid,
                        status: 'pending_payment',
                        updatedAt: serverTimestamp()
                    });

                    // Lưu thông tin payment
                    await set(paymentRef, {
                        status: 'pending',
                        paymentMethod: 'vnpay',
                        amount: amount,
                        transactionRef: txnRef,
                        timestamp: serverTimestamp(),
                        userId: auth.currentUser.uid,
                        paymentUrl: paymentUrl
                    });

                    // Chuyển hướng đến trang thanh toán VNPay
                    window.location.href = paymentUrl;

                } catch (error) {
                    console.error('Lỗi xử lý thanh toán VNPay:', error);
                    await Swal.fire({
                        icon: 'error',
                        title: 'Lỗi thanh toán',
                        text: 'Có lỗi xảy ra khi xử lý thanh toán VNPay. Vui lòng thử lại sau.'
                    });
                }

            } catch (error) {
                console.error('Lỗi xử lý thanh toán VNPay:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Lỗi thanh toán',
                    text: error.message || 'Có lỗi xảy ra khi xử lý thanh toán VNPay. Vui lòng thử lại sau.'
                });
            }
        }

        // Hàm lấy địa chỉ IP của người dùng
        async function getClientIp() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || '127.0.0.1';
            } catch (error) {
                console.error('Lỗi khi lấy địa chỉ IP:', error);
                return '127.0.0.1';
            }
        }

        // Cập nhật hàm processCheckout để xử lý thanh toán VNPay
        window.processCheckout = async function() {
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const paymentMethod = document.querySelector('input[name="payment"]:checked');
            if (!paymentMethod) {
                alert('Vui lòng chọn phương thức thanh toán');
                return;
            }

            // Kiểm tra bookingId
            if (!bookingId) {
                alert('Không tìm thấy thông tin đặt phòng!');
                window.location.href = 'index.html';
                return;
            }

            // Kiểm tra xác thực người dùng
            const user = auth.currentUser;
            if (!user) {
                alert('Vui lòng đăng nhập để thực hiện thanh toán!');
                return;
            }

            try {
                // Lấy thông tin giá từ DOM
                const totalPriceText = document.getElementById('totalPrice').textContent;
                const totalPrice = parseInt(totalPriceText.replace(/[^0-9]/g, ''));

                // Xử lý thanh toán VNPay
                if (paymentMethod.value === 'vnpay') {
                    try {
                        // Tạo payment mới với push
                        await processVNPayPayment(bookingId, totalPrice);
                        return;
                    } catch (error) {
                        console.error('Error creating payment:', error);
                        alert('Có lỗi xảy ra khi tạo thông tin thanh toán!');
                        return;
                    }
                }

                // Thu thập thông tin thanh toán cho các phương thức khác
                const paymentInfo = {
                    status: 'pending',
                    paymentMethod: paymentMethod.value,
                    amount: totalPrice,
                    timestamp: new Date().toISOString(),
                    userId: user.uid
                };

                // Thêm thông tin thanh toán cụ thể cho từng phương thức
                switch(paymentMethod.value) {
                    case 'credit':
                        paymentInfo.cardInfo = {
                            last4Digits: document.getElementById('cardNumber').value.slice(-4),
                            expiryDate: document.getElementById('expiryDate').value,
                            cardName: document.getElementById('cardName').value
                        };
                        break;
                    case 'bank':
                        paymentInfo.bankInfo = {
                            accountNumber: '1234567890',
                            bankName: 'Vietcombank',
                            transferContent: document.getElementById('transferContent').textContent
                        };
                        break;
                }

                // Cập nhật thông tin thanh toán vào Firebase
                try {
                    // Tạo payment mới với push
                    const paymentRef = ref(database, `bookings/${bookingId}/payments`);
                    const newPaymentRef = await push(paymentRef);
                    await set(newPaymentRef, paymentInfo);

                    // Cập nhật trạng thái booking
                    await update(ref(database, `bookings/${bookingId}`), {
                        status: 'confirmed',
                        updatedAt: serverTimestamp(),
                        userId: user.uid
                    });

                    alert('Thanh toán thành công!');
                    window.location.href = `confirmation.html?bookingId=${bookingId}`;
                } catch (error) {
                    console.error('Error creating payment:', error);
                    alert('Có lỗi xảy ra khi tạo thông tin thanh toán!');
                }
            } catch (error) {
                console.error('Error processing payment:', error);
                alert('Có lỗi xảy ra khi xử lý thanh toán!');
            }
        }

        // Load thông tin đặt phòng khi trang được tải
        function loadBookingData() {
            if (bookingId) {
                loadBookingInfo();
            } else {
                alert('Không tìm thấy thông tin đặt phòng! Vui lòng đặt phòng lại.');
                window.location.href = 'index.html';
            }
        }

        // Gọi hàm khi trang được tải
        window.onload = loadBookingData;

        // Lấy thông tin user từ Firebase và tự động điền vào form
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = ref(database, `users/${user.uid}`);
                try {
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        // Tách họ và tên
                        const nameParts = (userData.name || '').split(' ');
                        const lastName = nameParts.pop() || '';
                        const firstName = nameParts.join(' ');
                        document.getElementById('firstName').value = firstName;
                        document.getElementById('lastName').value = lastName;
                        document.getElementById('email').value = userData.email || '';
                        document.getElementById('phone').value = userData.phone || '';
                        document.getElementById('address').value = userData.address || '';
                        // Nếu có thêm city, zipCode thì điền tiếp
                        if (userData.city) document.getElementById('city').value = userData.city;
                        if (userData.zipCode) document.getElementById('zipCode').value = userData.zipCode;
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }
        });
    </script>
</body>
</html>