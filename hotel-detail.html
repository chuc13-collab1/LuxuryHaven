<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Khách sạn - LuxuryHavenTravel</title>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

    <!-- Firebase Config -->
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.firebasestorage.app",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="css/hotel.css"> <!-- Sử dụng lại CSS chung -->
    <link rel="stylesheet" href="css/hotel-detail.css"> <!-- CSS riêng cho trang chi tiết -->
    <link rel="stylesheet" href="css\chatbox.css">
    <script type="module" src="js/search.js"></script>
    <style>
        /* Similar Hotels Styles */
        .similar-hotels {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .similar-hotels h2 {
            color: #1a237e;
            font-weight: 600;
            text-align: center;
            margin-bottom: 25px;
        }

        .similar-hotel-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            height: 100%;
            margin-bottom: 20px;
        }

        .similar-hotel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .similar-hotel-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .similar-hotel-card:hover .similar-hotel-image {
            transform: scale(1.05);
        }

        .similar-hotel-content {
            padding: 20px;
        }

        .similar-hotel-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a237e;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .similar-hotel-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .similar-hotel-rating {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .similar-hotel-stars {
            color: #ffc107;
            margin-right: 8px;
        }

        .similar-hotel-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #e67e22;
            margin-bottom: 15px;
        }

        .similar-hotel-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .similar-hotel-feature {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .similar-hotel-btn {
            width: 100%;
            background: linear-gradient(45deg, #1a237e, #0d47a1);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .similar-hotel-btn:hover {
            background: linear-gradient(45deg, #0d47a1, #1a237e);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26,35,126,0.3);
        }

        .similar-hotel-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e67e22;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .similar-hotels {
                padding: 20px;
            }
            
            .similar-hotel-card {
                margin-bottom: 15px;
            }
        }
    </style>

</head>

<body>
     <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-flex">
                <a class="navbar-brand" href="index.html">
                    <img src="images/LuxuryHavenTravel.png" alt="LuxuryHaven Logo">
                </a>
                <button class="mobile-menu-btn" id="mobile-menu-btn"><span></span><span></span><span></span></button>
                <!-- Search Box -->
<div class="nav-search">
    <div class="search-input-group">
        <input type="text" placeholder="Tìm kiếm..." id="main-search-input" autocomplete="off">
        <button type="button" id="main-search-btn">
            <i class="fas fa-search"></i>
        </button>
    </div>
</div>
                <div class="nav-right">
                    <ul class="nav-links" id="nav-links">
                        <li><a href="index.html">Trang chủ</a></li>
                        <li><a href="hotel.html" class="active">Khách sạn</a></li>
                        <li><a href="tours.html">Tours</a></li>
                        <li><a href="prioritize.html">Ưu đãi</a></li>
                        <li><a href="travel_guide.html">Cẩm nang du lịch</a></li>
                        <li><a href="about_us.html">Về chúng tôi</a></li>
                        <li>
                            <div class="d-flex align-items-center">
                                <div class="dropdown" id="user-dropdown" style="display:none;">
                                    <button class="btn btn-outline-primary dropdown-toggle" type="button"
                                        id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-user"></i> <span id="user-name"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                        <li><a class="dropdown-item" href="member.html"><i class="fas fa-user-circle"></i> Tài khoản</a></li>
                                        <li><a class="dropdown-item" href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
                                    </ul>
                                </div>
                                <a href="#" class="btn btn-outline-primary me-2" id="open-login-modal"><i class="fas fa-user"></i> Đăng nhập</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <main class="container my-5" id="hotel-detail-container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="hotel.html">Khách sạn</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-hotel-name">Đang tải...</li>
            </ol>
        </nav>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Đang tải dữ liệu khách sạn...</p>
        </div>

        <!-- Hotel Detail Content (hidden until loaded) -->
        <div id="hotel-content" class="d-none">
            <section class="hotel-main-info">
                <h1 id="hotel-name"></h1>
                <div class="d-flex align-items-center mb-3">
                    <div id="hotel-stars" class="text-warning me-2"></div>
                    <div id="hotel-rating" class="badge bg-primary me-3"></div>
                    <i class="fas fa-map-marker-alt text-secondary me-1"></i>
                    <span id="hotel-address" class="text-secondary"></span>
                </div>
            </section>

            <section class="hotel-gallery mb-4">
                 <!-- Thư viện ảnh sẽ được render ở đây -->
            </section>

            <div class="row">
                <!-- Cột trái: Thông tin chi tiết, phòng, tiện nghi -->
                <div class="col-lg-8">
                    <section class="hotel-description mb-4 card card-body">
                        <h2>Mô tả khách sạn</h2>
                        <p id="hotel-description-content"></p>
                    </section>

                    <section class="hotel-facilities mb-4 card card-body">
                        <h2>Tiện nghi chung</h2>
                        <div id="hotel-facilities-list" class="row"></div>
                    </section>
                    
                    <section id="hotel-rooms" class="mb-4">
                        <h2>Chọn phòng</h2>
                        <div id="rooms-list">
                            <!-- Danh sách phòng sẽ được render ở đây -->
                        </div>
                    </section>

                    <!-- Gợi ý khách sạn cùng loại -->
                    <section class="similar-hotels mb-4">
                        <h2 class="mb-3">Khách sạn tương tự</h2>
                        <div class="row" id="similar-hotels-list">
                            <!-- Danh sách khách sạn tương tự sẽ được render ở đây -->
                        </div>
                    </section>
                </div>

                <!-- Cột phải: Form đặt phòng -->
                <div class="col-lg-4">
                    <aside class="booking-form-wrapper">
                        <!-- Form đặt phòng ngay -->
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h3 class="fs-5 mb-0"><i class="fas fa-calendar-check me-2"></i>Đặt phòng ngay</h3>
                            </div>
                            <div class="card-body">
                                <form id="booking-form">
                                    <div class="mb-3">
                                        <label for="check-in-date" class="form-label">Ngày nhận phòng</label>
                                        <input type="date" id="check-in-date" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="check-out-date" class="form-label">Ngày trả phòng</label>
                                        <input type="date" id="check-out-date" class="form-control" required>
                                    </div>
                                     <div class="mb-3">
                                        <label for="guests-number" class="form-label">Số lượng khách</label>
                                        <input type="number" id="guests-number" class="form-control" value="2" min="1" required>
                                    </div>
                                    <div class="alert alert-info d-none" id="price-summary">
                                        <h5>Tạm tính</h5>
                                        <p class="mb-1">Loại phòng: <strong id="summary-room-name"></strong></p>
                                        <p class="mb-1">Số đêm: <strong id="summary-nights"></strong></p>
                                        <p class="mb-0">Tổng cộng: <strong id="summary-total-price" class="fs-5"></strong></p>
                                    </div>
                                    <button type="submit" class="btn btn-warning w-100 fw-bold" id="btn-book-now" disabled>Vui lòng chọn phòng</button>
                                </form>
                            </div>
                        </div>

                        <!-- Form đặt cọc phòng -->
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h3 class="fs-5 mb-0"><i class="fas fa-hand-holding-usd me-2"></i>Đặt cọc giữ chỗ</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Lưu ý:</strong> Đặt cọc 30% giá phòng để giữ chỗ. Số tiền còn lại thanh toán khi nhận phòng. Vui lòng nhấn vào đây để xem chi tiết <a href="clause.html">điều khoản đặt cọc</a>
                                </div>
                                <form id="deposit-form">
                                    <div class="mb-3">
                                        <label for="deposit-check-in-date" class="form-label">Ngày dự kiến nhận phòng</label>
                                        <input type="date" id="deposit-check-in-date" class="form-control" required>
                                        <!-- <small class="text-muted">Ngày mặc định: Hôm nay. Bạn có thể chọn ngày khác nếu muốn.</small> -->
                                    </div>
                                    <div class="mb-3">
                                        <label for="deposit-check-out-date" class="form-label">Ngày dự kiến trả phòng</label>
                                        <input type="date" id="deposit-check-out-date" class="form-control" required>
                                        <!-- <small class="text-muted">Ngày mặc định: Ngày mai. Bạn có thể chọn ngày khác nếu muốn.</small> -->
                                    </div>
                                    <div class="mb-3">
                                        <label for="deposit-guests-number" class="form-label">Số lượng khách</label>
                                        <input type="number" id="deposit-guests-number" class="form-control" value="2" min="1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="deposit-amount" class="form-label">Số tiền đặt cọc</label>
                                        <div class="input-group">
                                            <input type="number" id="deposit-amount" class="form-control" placeholder="Tự động tính 30% giá phòng" required readonly>
                                            <span class="input-group-text">VNĐ</span>
                                        </div>
                                        <small class="text-muted">Tự động tính 30% giá phòng dựa trên loại phòng đã chọn</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="deposit-note" class="form-label">Ghi chú</label>
                                        <textarea id="deposit-note" class="form-control" rows="3" placeholder="Ghi chú thêm về yêu cầu đặt cọc..."></textarea>
                                    </div>
                                    <div class="alert alert-warning d-none" id="deposit-summary">
                                        <h6>Tóm tắt đặt cọc</h6>
                                        <p class="mb-1">Loại phòng: <strong id="deposit-room-name"></strong></p>
                                        <p class="mb-1">Số đêm: <strong id="deposit-nights"></strong></p>
                                        <p class="mb-1">Tổng giá phòng: <strong id="deposit-total-price"></strong></p>
                                        <p class="mb-0">Số tiền đặt cọc: <strong id="deposit-amount-display" class="text-primary"></strong></p>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100 fw-bold" id="btn-deposit" disabled>Đặt cọc giữ chỗ</button>
                                </form>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </div>
    </main>


    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h4>Về LuxuryHavenTravel</h4>
                    <ul>
                        <li><a href="footer/about.html">Giới thiệu</a></li>
                        <li><a href="footer/recruitment.html">Tuyển dụng</a></li>
                        <li><a href="footer/news.html">Tin tức</a></li>
                        <li><a href="footer/contact.html">Liên hệ</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h4>Hỗ trợ</h4>
                    <ul>
                        <li><a href="footer/help-center.html">Trung tâm trợ giúp</a></li>
                        <li><a href="footer/privacy-policy.html">Chính sách bảo mật</a></li>
                        <li><a href="footer/terms.html">Điều khoản sử dụng</a></li>
                        <li><a href="footer/cookie-policy.html">Chính sách cookie</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h4>Đối tác</h4>
                    <ul>
                        <li><a href="footer/partner.html">Đăng ký làm đối tác</a></li>
                        <li><a href="footer/marketing.html">Chương trình tiếp thị</a></li>
                        <li><a href="footer/affiliate.html">Affiliate</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h4>Theo dõi chúng tôi</h4>
                    <div class="social-links">
                        <a href="https://facebook.com/100083035936090"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 LuxuryHavenTravel. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <!-- Auth Modal (giữ lại để hoạt động đăng nhập/ký) -->
    <div id="auth-modal" class="modal">
        <div class="modal-content"
            style="max-width: 400px; padding: 32px 28px 24px 28px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.18);">
            <span class="close" id="close-auth-modal" style="right: 18px; top: 12px; font-size: 32px;">&times;</span>

            <div id="auth-forms">
                <form id="login-form" class="auth-form" style="text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="login-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="email" id="login-email" placeholder="e.g. elon@tesla.com" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="login-password" style="font-weight: 500;">Mật khẩu</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="login-password" placeholder="e.g. ilovemangools123" required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">Đăng nhập</button>
                    <div class="login-links">
                        <a href="#" id="to-register">Không có tài khoản?</a>
                        <a href="#" id="to-forgot">Quên mật khẩu?</a>
                    </div>
                </form>

                <form id="register-form" class="auth-form" style="display: none; text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-username" style="font-weight: 500;">Tên người dùng</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="register-username" placeholder="Nhập tên của bạn" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="register-email" placeholder="Nhập email của bạn" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-password" style="font-weight: 500;">Mật khẩu</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="register-password" placeholder="Tối thiểu 6 ký tự" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-confirm-password" style="font-weight: 500;">Xác nhận mật khẩu</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="register-confirm-password" placeholder="Nhập lại mật khẩu"
                                required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">Đăng ký</button>
                    <div class="login-links">
                        <a href="#" id="to-login">Đã có tài khoản? Đăng nhập</a>
                    </div>
                </form>

                <form id="forgot-form" class="auth-form" style="display: none; text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="forgot-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="forgot-email" placeholder="Nhập email của bạn" required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">Gửi yêu cầu đặt lại mật khẩu</button>
                    <div class="login-links">
                        <a href="#" id="back-to-login">Quay lại đăng nhập</a>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script>
        // --- AUTH & UI SCRIPT (COPIED FROM HOTEL.HTML) ---
        document.addEventListener('DOMContentLoaded', function () {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const forgotForm = document.getElementById('forgot-form');
            const closeAuthModal = document.getElementById('close-auth-modal');
            const openLoginModal = document.getElementById('open-login-modal');
            const userDropdown = document.getElementById('user-dropdown');
            const userName = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn');
            if(loginForm){loginForm.addEventListener('submit',function(e){e.preventDefault();const t=document.getElementById("login-email").value,n=document.getElementById("login-password").value;firebase.auth().signInWithEmailAndPassword(t,n).then(e=>{const t=e.user;document.getElementById("auth-modal").style.display="none",Swal.fire({title:"Đăng nhập thành công!",icon:"success",confirmButtonColor:"#e67e22"})}).catch(e=>{Swal.fire({title:"Lỗi đăng nhập!",text:e.message,icon:"error",confirmButtonColor:"#e67e22"})})});}
            if(registerForm){registerForm.addEventListener('submit',function(e){e.preventDefault();const t=document.getElementById("register-email").value,n=document.getElementById("register-password").value,o=document.getElementById("register-confirm-password").value,i=document.getElementById("register-username").value;if(n.length<6)return void Swal.fire({title:"Lỗi đăng ký!",text:"Mật khẩu phải có ít nhất 6 ký tự.",icon:"error",confirmButtonColor:"#e67e22"});if(n!==o)return void Swal.fire({title:"Lỗi đăng ký!",text:"Mật khẩu nhập lại không khớp.",icon:"error",confirmButtonColor:"#e67e22"});firebase.auth().createUserWithEmailAndPassword(t,n).then(e=>e.user.updateProfile({displayName:i})).then(()=>{document.getElementById("auth-modal").style.display="none",Swal.fire({title:"Đăng ký thành công!",icon:"success",confirmButtonColor:"#e67e22"})}).catch(e=>{Swal.fire({title:"Lỗi đăng ký!",text:e.message,icon:"error",confirmButtonColor:"#e67e22"})})});}
            if(forgotForm){forgotForm.addEventListener('submit',function(e){e.preventDefault();const t=document.getElementById("forgot-email").value;firebase.auth().sendPasswordResetEmail(t).then(()=>{Swal.fire({title:"Email đã được gửi!",text:"Vui lòng kiểm tra email của bạn để đặt lại mật khẩu.",icon:"success",confirmButtonColor:"#e67e22"})}).catch(e=>{Swal.fire({title:"Lỗi!",text:e.message,icon:"error",confirmButtonColor:"#e67e22"})})});}
            document.getElementById("to-register").addEventListener("click",function(e){e.preventDefault(),loginForm.style.display="none",registerForm.style.display="block",forgotForm.style.display="none"}),document.getElementById("to-login").addEventListener("click",function(e){e.preventDefault(),loginForm.style.display="block",registerForm.style.display="none",forgotForm.style.display="none"}),document.getElementById("to-forgot").addEventListener("click",function(e){e.preventDefault(),loginForm.style.display="none",registerForm.style.display="none",forgotForm.style.display="block"}),document.getElementById("back-to-login").addEventListener("click",function(e){e.preventDefault(),loginForm.style.display="block",registerForm.style.display="none",forgotForm.style.display="none"});
            if(closeAuthModal){closeAuthModal.addEventListener("click",()=>{document.getElementById("auth-modal").style.display="none"});}
            if(openLoginModal){openLoginModal.addEventListener("click",e=>{e.preventDefault(),document.getElementById("auth-modal").style.display="block"});}
            window.onclick=function(e){const t=document.getElementById("auth-modal");e.target==t&&(t.style.display="none")};
            firebase.auth().onAuthStateChanged(function(user){const loginBtn=document.getElementById("open-login-modal");if(user){if(loginBtn)loginBtn.style.display="none";if(userDropdown)userDropdown.style.display="block";if(userName)userName.textContent=user.displayName||user.email}else{if(loginBtn)loginBtn.style.display="block";if(userDropdown)userDropdown.style.display="none"}});
            if(logoutBtn){logoutBtn.addEventListener("click",function(e){e.preventDefault(),firebase.auth().signOut().then(()=>{Swal.fire({title:"Đăng xuất thành công!",icon:"success",confirmButtonColor:"#e67e22"})}).catch(e=>{Swal.fire({title:"Lỗi đăng xuất!",text:e.message,icon:"error",confirmButtonColor:"#e67e22"})})});}
            const mobileMenuBtn=document.getElementById("mobile-menu-btn"),navLinks=document.getElementById("nav-links");if(mobileMenuBtn&&navLinks){mobileMenuBtn.addEventListener("click",function(){this.classList.toggle("active"),navLinks.classList.toggle("active")}),navLinks.addEventListener("click",function(e){"A"===e.target.tagName&&(mobileMenuBtn.classList.remove("active"),navLinks.classList.remove("active"))}),document.addEventListener("click",function(e){mobileMenuBtn.contains(e.target)||navLinks.contains(e.target)||(mobileMenuBtn.classList.remove("active"),navLinks.classList.remove("active"))});}
        });

        // --- HOTEL DETAIL PAGE LOGIC ---
        document.addEventListener('DOMContentLoaded', async function() {
            const params = new URLSearchParams(window.location.search);
            const hotelIdWithCity = params.get('id');

            if (!hotelIdWithCity) {
                document.getElementById('hotel-detail-container').innerHTML = '<div class="alert alert-danger">Không tìm thấy ID khách sạn. Vui lòng quay lại trang danh sách.</div>';
                return;
            }
            
            const [cityKey, hotelKey] = hotelIdWithCity.split('_');

            if (!cityKey || !hotelKey) {
                 document.getElementById('hotel-detail-container').innerHTML = '<div class="alert alert-danger">ID khách sạn không hợp lệ.</div>';
                 return;
            }

            try {
                const snapshot = await firebase.database().ref(`location/${cityKey}/hotels/${hotelKey}`).once('value');
                const hotel = snapshot.val();
                
                if (hotel) {
                    hotel.id = hotelIdWithCity; // Gắn lại ID đầy đủ
                    renderHotelDetails(hotel);
                    document.getElementById('loading-spinner').classList.add('d-none');
                    document.getElementById('hotel-content').classList.remove('d-none');
                } else {
                    document.getElementById('hotel-detail-container').innerHTML = '<div class="alert alert-danger">Không tìm thấy thông tin chi tiết cho khách sạn này.</div>';
                }
            } catch (error) {
                console.error("Lỗi tải dữ liệu khách sạn:", error);
                document.getElementById('hotel-detail-container').innerHTML = `<div class="alert alert-danger">Đã xảy ra lỗi: ${error.message}</div>`;
            }
        });

        let selectedRoom = null;
        let hotelData = null;

        function renderHotelDetails(hotel) {
            hotelData = hotel; // Lưu dữ liệu khách sạn vào biến toàn cục
            const defaultImage = 'images/LuxuryHavenTravel.png';

            // --- Render thông tin cơ bản ---
            document.title = `${hotel.tenKhachSan} - LuxuryHavenTravel`;
            document.getElementById('breadcrumb-hotel-name').textContent = hotel.tenKhachSan;
            document.getElementById('hotel-name').textContent = hotel.tenKhachSan;
            document.getElementById('hotel-address').textContent = hotel.diaChi;
            document.getElementById('hotel-description-content').textContent = hotel.moTa;
            
            // Sao và rating
            let starsHtml = (hotel.xepHangSao ? Array(Math.floor(hotel.xepHangSao)).fill(0).map(() => '<i class="fas fa-star"></i>').join('') : '') +
                            (hotel.xepHangSao ? Array(5 - Math.floor(hotel.xepHangSao)).fill(0).map(() => '<i class="far fa-star"></i>').join('') : 'Chưa xếp hạng');
            document.getElementById('hotel-stars').innerHTML = starsHtml;
            if (hotel.rating) {
                document.getElementById('hotel-rating').textContent = `${hotel.rating}/5`;
            } else {
                document.getElementById('hotel-rating').style.display = 'none';
            }

            // --- Render thư viện ảnh ---
            const galleryContainer = document.querySelector('.hotel-gallery');
            const mainImage = hotel.chiTiet?.image || defaultImage;
            let allImages = [mainImage];
            if (hotel.chiTiet?.rooms) {
                hotel.chiTiet.rooms.forEach(room => {
                    if (room.room_images) {
                        allImages.push(...room.room_images);
                    }
                });
            }
            galleryContainer.innerHTML = allImages.slice(0, 5).map(img => `<img src="${img}" class="gallery-image" onerror="this.src='${defaultImage}'">`).join('');
            
            // --- Render tiện nghi ---
            const facilitiesList = document.getElementById('hotel-facilities-list');
            const facilities = hotel.chiTiet?.facilities || [];
            if (facilities.length > 0) {
                 facilitiesList.innerHTML = facilities.map(f => `
                    <div class="col-md-6">
                        <div class="facility-item"><i class="fas fa-check-circle"></i> ${f}</div>
                    </div>
                `).join('');
            } else {
                facilitiesList.innerHTML = '<p>Chưa có thông tin về tiện nghi.</p>';
            }

            // --- Render danh sách phòng ---
            const roomsList = document.getElementById('rooms-list');
            const rooms = hotel.chiTiet?.rooms || [];
             if (rooms.length > 0) {
                roomsList.innerHTML = rooms.map((room, index) => `
                <div class="room-card" id="room-card-${index}" onclick="selectRoom(${index})">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5>${room.name || 'Tên phòng'}</h5>
                            <div class="room-details-grid mb-2">
                                <span><i class="fas fa-bed me-1"></i> ${room.bed || 'N/A'}</span>
                                <span><i class="fas fa-ruler-combined me-1"></i> ${room.size || 'N/A'}</span>
                                <span><i class="fas fa-eye me-1"></i> ${room.view || 'N/A'}</span>
                                <span><i class="fas fa-users me-1"></i> ${room.availableRooms || 'N/A'} phòng trống</span>
                            </div>
                            <p class="mb-0 small">${room.moTa || ''}</p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="room-price">${room.price ? room.price.toLocaleString() + ' VNĐ' : 'Liên hệ'}</div>
                            <small class="text-muted">/ đêm</small>
                            <div class="form-check mt-2 d-inline-block d-md-block">
                                <input class="form-check-input" type="radio" name="roomSelection" id="room-radio-${index}">
                                <label class="form-check-label" for="room-radio-${index}">Chọn</label>
                            </div>
                        </div>
                    </div>
                </div>
                `).join('');
            } else {
                 roomsList.innerHTML = '<div class="alert alert-warning">Chưa có thông tin phòng cho khách sạn này.</div>';
            }
            
            // Gắn sự kiện cho form
            attachFormEvents();
            
            // Load khách sạn tương tự
            loadSimilarHotels(hotel);
        }

        function selectRoom(index) {
            selectedRoom = hotelData.chiTiet.rooms[index];

            // Cập nhật giao diện
            document.querySelectorAll('.room-card').forEach(card => card.classList.remove('selected'));
            document.getElementById(`room-card-${index}`).classList.add('selected');
            document.getElementById(`room-radio-${index}`).checked = true;

            // Cập nhật giá và kích hoạt nút cho cả 2 form
            updatePrice();
            updateDepositSummary();
            
            const btnBook = document.getElementById('btn-book-now');
            btnBook.disabled = false;
            btnBook.textContent = 'Tiến hành đặt phòng';
        }

        function updatePrice() {
            if (!selectedRoom) return;

            const checkInDate = new Date(document.getElementById('check-in-date').value);
            const checkOutDate = new Date(document.getElementById('check-out-date').value);

            if (checkInDate && checkOutDate && checkOutDate > checkInDate) {
                const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
                const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
                const totalPrice = nights * (selectedRoom.price || 0);

                if(totalPrice > 0){
                    const summary = document.getElementById('price-summary');
                    summary.classList.remove('d-none');
                    document.getElementById('summary-room-name').textContent = selectedRoom.name;
                    document.getElementById('summary-nights').textContent = nights;
                    document.getElementById('summary-total-price').textContent = totalPrice.toLocaleString() + ' VNĐ';
                }
            } else {
                 document.getElementById('price-summary').classList.add('d-none');
            }
        }

        function attachFormEvents() {
            // Set min date for date pickers
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Set default dates for booking form
            document.getElementById('check-in-date').setAttribute('min', today);
            document.getElementById('check-out-date').setAttribute('min', today);
            document.getElementById('check-in-date').value = today;
            document.getElementById('check-out-date').value = tomorrowStr;
            
            // Set default dates for deposit form
            document.getElementById('deposit-check-in-date').setAttribute('min', today);
            document.getElementById('deposit-check-out-date').setAttribute('min', today);
            document.getElementById('deposit-check-in-date').value = today;
            document.getElementById('deposit-check-out-date').value = tomorrowStr;
            
            // Add listeners for booking form
            document.getElementById('check-in-date').addEventListener('change', updatePrice);
            document.getElementById('check-out-date').addEventListener('change', updatePrice);
            
            document.getElementById('booking-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleBooking();
            });

            // Add listeners for deposit form
            document.getElementById('deposit-check-in-date').addEventListener('change', updateDepositSummary);
            document.getElementById('deposit-check-out-date').addEventListener('change', updateDepositSummary);
            document.getElementById('deposit-amount').addEventListener('input', updateDepositSummary);
            
            document.getElementById('deposit-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleDeposit();
            });
        }
        
        function handleBooking() {
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire('Yêu cầu đăng nhập', 'Vui lòng đăng nhập để tiếp tục đặt phòng.', 'info');
                document.getElementById('open-login-modal').click();
                return;
            }

            const checkIn = document.getElementById('check-in-date').value;
            const checkOut = document.getElementById('check-out-date').value;
            const guests = document.getElementById('guests-number').value;

            if (!selectedRoom) {
                Swal.fire('Chưa chọn phòng', 'Vui lòng chọn một loại phòng.', 'warning');
                return;
            }
            if (!checkIn || !checkOut || new Date(checkOut) <= new Date(checkIn)) {
                 Swal.fire('Ngày không hợp lệ', 'Vui lòng chọn ngày nhận và trả phòng hợp lệ.', 'warning');
                return;
            }
            
            const bookingData = {
                bookingType: 'hotel',
                userId: user.uid,
                email: user.email,
                hotelId: hotelData.id,
                hotelName: hotelData.tenKhachSan,
                roomId: selectedRoom.name,
                roomPrice: selectedRoom.price,
                checkIn: checkIn,
                checkOut: checkOut,
                guests: guests,
                createdAt: Date.now()
            };
            console.log('Booking gửi lên:', bookingData);
            const newBookingRef = firebase.database().ref('bookings').push();
            newBookingRef.set(bookingData)
                .then(() => {
                    const bookingId = newBookingRef.key;
                    // CẬP NHẬT SỐ PHÒNG TRỐNG VÀ CHỜ XONG MỚI CHUYỂN TRANG
                    updateAvailableRoomsAfterBooking().then(() => {
                        // --- CẬP NHẬT SỐ PHÒNG TRỐNG TRÊN GIAO DIỆN ---
                        const roomCards = document.querySelectorAll('.room-card');
                        roomCards.forEach((card, idx) => {
                            if (hotelData.chiTiet.rooms[idx].name === selectedRoom.name) {
                                // Tìm span hiển thị số phòng trống
                                const detailsGrid = card.querySelector('.room-details-grid');
                                if (detailsGrid) {
                                    const spans = detailsGrid.querySelectorAll('span');
                                    spans.forEach(span => {
                                        if (span.innerText.includes('phòng trống')) {
                                            let text = span.textContent;
                                            let match = text.match(/(\d+)/);
                                            if (match) {
                                                let current = parseInt(match[1]);
                                                let newVal = Math.max(0, current - 1);
                                                span.innerHTML = `<i class="fas fa-users me-1"></i> ${newVal} phòng trống`;
                                                // Cập nhật biến dữ liệu
                                                hotelData.chiTiet.rooms[idx].availableRooms = newVal;
                                                // Nếu về 0 thì disable chọn phòng này
                                                const radio = card.querySelector('input[type="radio"]');
                                                if (newVal <= 0 && radio) {
                                                    radio.disabled = true;
                                                    card.classList.add('disabled');
                                                }
                                            }
                                        }
                                    });
                                }
                            }
                        });
                        // --- END cập nhật giao diện ---
                        window.location.href = `check-out.html?bookingId=${bookingId}&paymentMethod=vnpay`;
                    });
                })
                .catch((error) => {
                    Swal.fire('Lỗi', `Đã có lỗi xảy ra khi tạo đơn đặt phòng: ${error.message}`, 'error');
                });
        }

        function updateDepositSummary() {
            const checkInDate = new Date(document.getElementById('deposit-check-in-date').value);
            const checkOutDate = new Date(document.getElementById('deposit-check-out-date').value);

            if (checkInDate && checkOutDate && checkOutDate > checkInDate && selectedRoom) {
                const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
                const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
                const totalPrice = nights * (selectedRoom.price || 0);
                const depositAmount = totalPrice * 0.3; // Tự động tính 30% giá phòng

                if (totalPrice > 0) {
                    // Tự động điền số tiền đặt cọc
                    document.getElementById('deposit-amount').value = Math.round(depositAmount);
                    
                    const summary = document.getElementById('deposit-summary');
                    summary.classList.remove('d-none');
                    document.getElementById('deposit-room-name').textContent = selectedRoom.name;
                    document.getElementById('deposit-nights').textContent = nights;
                    document.getElementById('deposit-total-price').textContent = totalPrice.toLocaleString() + ' VNĐ';
                    document.getElementById('deposit-amount-display').textContent = depositAmount.toLocaleString() + ' VNĐ';

                    // Kích hoạt nút đặt cọc
                    const btnDeposit = document.getElementById('btn-deposit');
                    btnDeposit.disabled = false;
                    btnDeposit.textContent = 'Đặt cọc giữ chỗ';
                    summary.classList.remove('alert-danger');
                    summary.classList.add('alert-warning');
                }
            } else {
                document.getElementById('deposit-summary').classList.add('d-none');
                document.getElementById('btn-deposit').disabled = true;
                document.getElementById('deposit-amount').value = '';
            }
        }

        async function loadSimilarHotels(currentHotel) {
            try {
                // Lấy danh sách khách sạn từ Firebase
                const snapshot = await firebase.database().ref('location').once('value');
                const locations = snapshot.val();
                
                if (!locations) return;

                const similarHotels = [];
                
                // Tìm khách sạn tương tự dựa trên:
                // 1. Cùng khu vực/địa điểm
                // 2. Cùng mức giá (chênh lệch ±20%)
                // 3. Cùng xếp hạng sao
                Object.keys(locations).forEach(cityKey => {
                    const city = locations[cityKey];
                    if (city.hotels) {
                        Object.keys(city.hotels).forEach(hotelKey => {
                            const hotel = city.hotels[hotelKey];
                            const hotelId = `${cityKey}_${hotelKey}`;
                            
                            // Bỏ qua khách sạn hiện tại
                            if (hotelId === currentHotel.id) return;
                            
                            // Kiểm tra điều kiện tương tự
                            const isSimilar = checkSimilarity(currentHotel, hotel);
                            if (isSimilar) {
                                similarHotels.push({
                                    id: hotelId,
                                    ...hotel,
                                    cityKey: cityKey
                                });
                            }
                        });
                    }
                });
                
                // Sắp xếp theo độ tương tự và giới hạn 6 khách sạn
                similarHotels.sort((a, b) => b.similarityScore - a.similarityScore);
                const topSimilarHotels = similarHotels.slice(0, 2);
                
                renderSimilarHotels(topSimilarHotels);
                
            } catch (error) {
                console.error("Lỗi load khách sạn tương tự:", error);
            }
        }

        function checkSimilarity(currentHotel, otherHotel) {
            let similarityScore = 0;
            
            // So sánh xếp hạng sao
            if (currentHotel.xepHangSao && otherHotel.xepHangSao) {
                const starDiff = Math.abs(currentHotel.xepHangSao - otherHotel.xepHangSao);
                if (starDiff <= 1) similarityScore += 3;
                else if (starDiff <= 2) similarityScore += 1;
            }
            
            // So sánh giá phòng (nếu có)
            if (currentHotel.chiTiet?.rooms && otherHotel.chiTiet?.rooms) {
                const currentAvgPrice = getAveragePrice(currentHotel.chiTiet.rooms);
                const otherAvgPrice = getAveragePrice(otherHotel.chiTiet.rooms);
                
                if (currentAvgPrice && otherAvgPrice) {
                    const priceDiff = Math.abs(currentAvgPrice - otherAvgPrice) / currentAvgPrice;
                    if (priceDiff <= 0.2) similarityScore += 2; // Chênh lệch ≤20%
                    else if (priceDiff <= 0.5) similarityScore += 1; // Chênh lệch ≤50%
                }
            }
            
            // So sánh địa điểm
            if (currentHotel.diaChi && otherHotel.diaChi) {
                const currentLocation = currentHotel.diaChi.toLowerCase();
                const otherLocation = otherHotel.diaChi.toLowerCase();
                
                if (currentLocation.includes('hà nội') && otherLocation.includes('hà nội')) similarityScore += 2;
                else if (currentLocation.includes('hồ chí minh') && otherLocation.includes('hồ chí minh')) similarityScore += 2;
                else if (currentLocation.includes('đà nẵng') && otherLocation.includes('đà nẵng')) similarityScore += 2;
                else if (currentLocation.includes('nha trang') && otherLocation.includes('nha trang')) similarityScore += 2;
            }
            
            otherHotel.similarityScore = similarityScore;
            return similarityScore >= 2; // Chỉ hiển thị nếu có độ tương tự từ 2 điểm trở lên
        }

        function getAveragePrice(rooms) {
            if (!rooms || rooms.length === 0) return null;
            
            const prices = rooms.map(room => room.price).filter(price => price > 0);
            if (prices.length === 0) return null;
            
            return prices.reduce((sum, price) => sum + price, 0) / prices.length;
        }

        function renderSimilarHotels(hotels) {
            const container = document.getElementById('similar-hotels-list');
            if (!container || hotels.length === 0) {
                // Ẩn section nếu không có khách sạn tương tự
                document.querySelector('.similar-hotels').style.display = 'none';
                return;
            }
            
            container.innerHTML = hotels.map(hotel => {
                const defaultImage = 'images/LuxuryHavenTravel.png';
                const avgPrice = getAveragePrice(hotel.chiTiet?.rooms);
                const features = getHotelFeatures(hotel);
                
                return `
                    <div class="col-md-6 col-lg-4">
                        <div class="similar-hotel-card">
                            <div style="position: relative;">
                                <img src="${hotel.chiTiet?.image || defaultImage}" 
                                     alt="${hotel.tenKhachSan}" 
                                     class="similar-hotel-image"
                                     onerror="this.src='${defaultImage}'">
                                ${hotel.xepHangSao ? `<div class="similar-hotel-badge">${hotel.xepHangSao}★</div>` : ''}
                            </div>
                            <div class="similar-hotel-content">
                                <h3 class="similar-hotel-name">${hotel.tenKhachSan}</h3>
                                <p class="similar-hotel-location">
                                    <i class="fas fa-map-marker-alt me-1"></i>${hotel.diaChi}
                                </p>
                                <div class="similar-hotel-rating">
                                    <div class="similar-hotel-stars">
                                        ${hotel.xepHangSao ? Array(Math.floor(hotel.xepHangSao)).fill('<i class="fas fa-star"></i>').join('') : ''}
                                    </div>
                                    ${hotel.rating ? `<span class="text-muted">${hotel.rating}/5</span>` : ''}
                                </div>
                                ${avgPrice ? `<div class="similar-hotel-price">Từ ${avgPrice.toLocaleString()} VNĐ/đêm</div>` : ''}
                                <div class="similar-hotel-features">
                                    ${features.slice(0, 3).map(feature => `<span class="similar-hotel-feature">${feature}</span>`).join('')}
                                </div>
                                <a href="hotel-detail.html?id=${hotel.id}" class="btn similar-hotel-btn">
                                    Xem chi tiết
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getHotelFeatures(hotel) {
            const features = [];
            
            if (hotel.chiTiet?.facilities) {
                features.push(...hotel.chiTiet.facilities.slice(0, 3));
            }
            
            if (hotel.xepHangSao) {
                features.push(`${hotel.xepHangSao} sao`);
            }
            
            if (hotel.chiTiet?.rooms) {
                const roomTypes = hotel.chiTiet.rooms.map(room => room.name).filter(Boolean);
                if (roomTypes.length > 0) {
                    features.push(roomTypes[0]);
                }
            }
            
            return features;
        }

        function handleDeposit() {
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire('Yêu cầu đăng nhập', 'Vui lòng đăng nhập để tiếp tục đặt cọc.', 'info');
                document.getElementById('open-login-modal').click();
                return;
            }

            const checkIn = document.getElementById('deposit-check-in-date').value;
            const checkOut = document.getElementById('deposit-check-out-date').value;
            const guests = document.getElementById('deposit-guests-number').value;
            const depositAmount = parseFloat(document.getElementById('deposit-amount').value);
            const note = document.getElementById('deposit-note').value;

            if (!selectedRoom) {
                Swal.fire('Chưa chọn phòng', 'Vui lòng chọn một loại phòng.', 'warning');
                return;
            }
            if (!checkIn || !checkOut || new Date(checkOut) <= new Date(checkIn)) {
                Swal.fire('Ngày không hợp lệ', 'Vui lòng chọn ngày nhận và trả phòng hợp lệ.', 'warning');
                return;
            }
            if (!depositAmount || depositAmount <= 0) {
                Swal.fire('Số tiền không hợp lệ', 'Số tiền đặt cọc chưa được tính toán.', 'warning');
                return;
            }

            // Tính toán tổng giá
            const timeDiff = new Date(checkOut).getTime() - new Date(checkIn).getTime();
            const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
            const totalPrice = nights * (selectedRoom.price || 0);
            const expectedDeposit = totalPrice * 0.3;

            // Kiểm tra số tiền đặt cọc có đúng 30% không
            if (Math.abs(depositAmount - expectedDeposit) > 1000) { // Cho phép sai số 1000 VNĐ
                Swal.fire('Số tiền đặt cọc không chính xác', `Số tiền đặt cọc phải là ${expectedDeposit.toLocaleString()} VNĐ (30% giá phòng).`, 'warning');
                return;
            }

            const depositData = {
                bookingType: 'deposit',
                userId: user.uid,
                email: user.email,
                hotelId: hotelData.id,
                hotelName: hotelData.tenKhachSan,
                roomId: selectedRoom.name,
                roomPrice: selectedRoom.price,
                checkIn: checkIn,
                checkOut: checkOut,
                guests: guests,
                depositAmount: depositAmount,
                totalPrice: totalPrice,
                remainingAmount: totalPrice - depositAmount,
                note: note,
                status: 'pending',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            const newDepositRef = firebase.database().ref('deposits').push();
            newDepositRef.set(depositData)
                .then(() => {
                    const depositId = newDepositRef.key;
                    // Chuyển hướng đến trang check-out với ID đặt cọc và chọn sẵn VNPAY
                    window.location.href = `check-out.html?depositId=${depositId}&paymentMethod=vnpay`;
                })
                .catch((error) => {
                    Swal.fire('Lỗi', `Đã có lỗi xảy ra khi tạo yêu cầu đặt cọc: ${error.message}`, 'error');
                });
        }

    </script>
    <script>
        function updateAvailableRoomsAfterBooking() {
            return new Promise((resolve) => {
                if (!hotelData || !selectedRoom) return resolve();
                const cityKey = hotelData.id.split('_')[0];
                const hotelKey = hotelData.id.split('_')[1];
                const roomsRef = firebase.database().ref(`location/${cityKey}/hotels/${hotelKey}/chiTiet/rooms`);
                roomsRef.once('value').then(snapshot => {
                    const rooms = snapshot.val();
                    let roomIdx = -1;
                    let isArray = false;
                    if (Array.isArray(rooms)) {
                        isArray = true;
                        roomIdx = rooms.findIndex(r => r && r.name === selectedRoom.name);
                    } else if (typeof rooms === 'object' && rooms !== null) {
                        roomIdx = Object.keys(rooms).find(key => rooms[key] && rooms[key].name === selectedRoom.name);
                    }
                    console.log('DEBUG (Firebase) roomIdx:', roomIdx, 'selectedRoom.name:', selectedRoom.name, 'isArray:', isArray);
                    if (roomIdx === -1 || roomIdx === undefined) {
                        console.error('Không tìm thấy loại phòng trên Firebase!');
                        return resolve();
                    }
                    let path;
                    if (isArray) {
                        path = `location/${cityKey}/hotels/${hotelKey}/chiTiet/rooms/${roomIdx}/availableRooms`;
                    } else {
                        path = `location/${cityKey}/hotels/${hotelKey}/chiTiet/rooms/${roomIdx}/availableRooms`;
                    }
                    console.log('Đường dẫn cập nhật:', path);

                    const roomRef = firebase.database().ref(path);
                    roomRef.transaction(current => {
                        console.log('Giá trị hiện tại:', current);
                        if (typeof current !== 'number') return 0;
                        if (current > 0) return current - 1;
                        return 0;
                    }, (error, committed, snapshot) => {
                        if (error) {
                            console.error('Lỗi transaction:', error);
                        } else if (!committed) {
                            console.warn('Transaction không được commit!');
                        } else {
                            console.log('Transaction thành công! Giá trị mới:', snapshot.val());
                        }
                        resolve();
                    });
                });
            });
        }
    </script>
</body>

</html> 