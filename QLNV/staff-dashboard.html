<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Nhân Viên</title>
    <!-- Bootstrap, FontAwesome, Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <style>
        :root {
            --main-bg: #f8f9fa;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --accent: #7c3aed;
            --accent2: #00eaff;
            --text: #2d3748;
            --text-muted: #718096;
            --border: #e2e8f0;
            --shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.1);
        }
        body {
            background: var(--main-bg);
            color: var(--text);
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
        }
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            color: var(--text);
            min-height: 100vh;
            position: fixed;
            top: 0; left: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar .logo {
            padding: 32px 0 24px 0;
            text-align: center;
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--accent);
        }
        .sidebar .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 32px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 1.08rem;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            border-radius: 0 8px 8px 0;
            margin: 2px 0;
        }
        .sidebar .nav-item.active, .sidebar .nav-item:hover {
            background: #f7fafc;
            color: var(--accent2);
            border-left: 4px solid var(--accent);
        }
        .sidebar .nav-item i {
            margin-right: 14px;
            font-size: 1.2rem;
        }
        .sidebar-footer {
            margin-top: auto;
            padding: 24px 32px;
        }
        .sidebar-footer .btn {
            width: 100%;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 500;
        }
        .main-container {
            margin-left: 240px;
            min-height: 100vh;
            background: var(--main-bg);
        }
        .main-header {
            background: #ffffff;
            border-bottom: 1px solid var(--border);
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .main-header .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .main-header .user-info img {
            width: 44px; height: 44px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--accent);
        }
        .content-wrapper {
            padding: 40px 32px 32px 32px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .card-modern {
            background: var(--card-bg);
            border-radius: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 32px;
            padding: 0;
            transition: all 0.3s ease;
        }
        .card-modern:hover {
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .card-modern .card-body {
            padding: 32px 28px;
        }
        .card-modern .card-title {
            color: var(--accent2);
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 18px;
        }
        .profile-info {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        .profile-info img {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--accent);
        }
        .profile-info .info {
            font-size: 1.1rem;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .profile-details div {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .activity-timeline {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .contact-info h6 {
            color: var(--accent2);
            margin-bottom: 10px;
        }
        
        .contact-info p {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }
        
        .leave-stats, .achievement-stats {
            font-size: 0.9rem;
        }
        
        .btn-group .btn.active {
            background-color: var(--accent2);
            border-color: var(--accent2);
            color: white;
        }
        
        /* CSS cho phần chấm công */
        .current-time {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            font-family: 'Courier New', monospace;
        }
        
        .current-date {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .attendance-buttons .btn {
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .attendance-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .today-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .today-status h6 {
            margin-bottom: 10px;
            color: var(--text);
        }
        
        #today-attendance-status {
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            background: #e9ecef;
            color: #6c757d;
        }
        
        #today-attendance-status.checked-in {
            background: #d4edda;
            color: #155724;
        }
        
        #today-attendance-status.checked-out {
            background: #f8d7da;
            color: #721c24;
        }
        .stat-cards {
            display: flex;
            gap: 24px;
            margin-bottom: 32px;
        }
        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #7c3aed 0%, #00eaff 100%);
            color: #fff;
            border-radius: 14px;
            padding: 24px 18px;
            box-shadow: 0 4px 20px 0 rgba(124, 58, 237, 0.15);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 160px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-card .stat-label {
            font-size: 1rem;
            opacity: 0.85;
        }
        .stat-card .stat-value {
            font-size: 2.1rem;
            font-weight: 700;
            margin: 8px 0 0 0;
        }
        .stat-card .stat-icon {
            font-size: 2.2rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        .table-modern {
            color: var(--text);
        }
        .table-modern th, .table-modern td {
            background: transparent !important;
            border-color: var(--border) !important;
        }
        .table-modern th {
            background-color: rgba(124, 58, 237, 0.05) !important;
            color: var(--text) !important;
        }
        .form-control, .form-select {
            background: #ffffff;
            color: var(--text);
            border: 1px solid var(--border);
        }
        .form-control:focus, .form-select:focus {
            background: #ffffff;
            color: var(--text);
            border-color: var(--accent2);
            box-shadow: 0 0 0 2px rgba(0, 234, 255, 0.2);
        }
        .btn-primary, .btn-success {
            background: var(--accent);
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary:hover, .btn-success:hover {
            background: var(--accent2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        .sidebar .nav-item.booking { color: #ffb300; }
        
        /* Booking status badges */
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-confirmed {
            background: #d1edff;
            color: #0c5460;
        }
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        .sidebar .nav-item.checkin { color: #00eaff; }
        .sidebar .nav-item.housekeeping { color: #7c3aed; }
        .sidebar .nav-item.feedback { color: #ff4081; }
        .sidebar .nav-item.stats { color: #00e676; }

        /* CSS cho modal chấm công */
        .modal-content {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--border) !important;
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border) !important;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border) !important;
        }
        
        .modal-title {
            color: var(--accent2) !important;
        }
        
        .btn-close {
            filter: invert(0);
        }
        
        .modal { z-index: 1050; }
        .modal-backdrop { z-index: 1040; }
        
        #timesheetModal { z-index: 1055; }
        #timesheetModal .modal-backdrop { z-index: 1050; }
        
        #createScheduleModal, #addOvertimeModal { z-index: 1060 !important; }
        #createScheduleModal .modal-backdrop, #addOvertimeModal .modal-backdrop { z-index: 1055 !important; }
        
        .modal.show { z-index: 1060 !important; }
        .modal.show .modal-backdrop { z-index: 1055 !important; }
        
        .card {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--border) !important;
            color: var(--text) !important;
        }
        
        .card-header {
            background-color: rgba(124, 58, 237, 0.05) !important;
            border-bottom: 1px solid var(--border) !important;
            color: var(--accent2) !important;
        }
        
        .list-group-item {
            background-color: var(--card-bg) !important;
            border-color: var(--border) !important;
            color: var(--text) !important;
        }
        
        .list-group-item.active {
            background-color: var(--accent) !important;
            border-color: var(--accent) !important;
            color: #ffffff !important;
        }

        @media (max-width: 900px) {
            .sidebar { width: 80px; }
            .main-container { margin-left: 80px; }
            .sidebar .nav-item { padding: 12px 10px; font-size: 0.95rem; }
            .sidebar .logo { font-size: 1.1rem; }
        }
        @media (max-width: 700px) {
            .sidebar { display: none; }
            .main-container { margin-left: 0; }
            .main-header { padding: 12px 10px; }
            .content-wrapper { padding: 12px 4px; }
            .stat-cards { flex-direction: column; gap: 12px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-hotel"></i> LUXSTAFF
        </div>
        <a href="#profile" class="nav-item active" onclick="showSection('profile')"><i class="fas fa-id-badge"></i> Hồ sơ cá nhân</a>
        <!-- <a href="#attendance" class="nav-item" onclick="showSection('attendance')"><i class="fas fa-calendar-check"></i> Chấm công</a> -->
        <a href="#leave" class="nav-item" onclick="showSection('leave')"><i class="fas fa-plane-departure"></i> Xin nghỉ phép</a>
        <a href="#booking" class="nav-item booking" onclick="showSection('booking')"><i class="fas fa-bed"></i> Đặt phòng</a>
        <a href="#feedback" class="nav-item feedback" onclick="showSection('feedback')"><i class="fas fa-comment-dots"></i> Phản hồi</a>
        <a href="#stats" class="nav-item stats" onclick="showSection('stats')"><i class="fas fa-chart-bar"></i> Thống kê</a>
        <div class="sidebar-footer">
            <button class="btn" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</button>
        </div>
    </div>
    <!-- Main content -->
    <div class="main-container">
        <!-- Header -->
        <header class="main-header">
            <h1 class="h4 mb-0" style="color:var(--accent2);">Dashboard Nhân viên</h1>
            <div class="user-info">
                <img src="../images/z6704204165630_f126462fb6b33e841e82b706ba2e582c.jpg" alt="Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM3YzNhZWQiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAxMmMyLjIxIDAgNC0xLjc5IDQtNHMtMS43OS00LTQtNC00IDEuNzktNCA0IDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmgxNnYtMmMwLTIuNjYtNS4zMy00LTgtNHoiLz4KPC9zdmc+Cjwvc3ZnPgo='">
                <span><strong>Nguyễn Văn A</strong></span>
            </div>
        </header>
        <main class="content-wrapper">
            <!-- Hồ sơ cá nhân -->
            <section id="profile-section">
                <!-- Thông tin cá nhân -->
                <div class="card-modern mb-4">
                    <div class="card-body profile-info">
                        <div class="row align-items-center">
                            <div class="col-md-3 text-center">
                                <img src="../images/z6704204165630_f126462fb6b33e841e82b706ba2e582c.jpg" alt="Avatar" class="profile-avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjN2MzYWVkIi8+CjxzdmcgeD0iMzAiIHk9IjMwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPgo8cGF0aCBkPSJNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTQtMS43OS00LTQtNC00IDQgMCAyLjIxIDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmgxNnYtMmMwLTIuNjYtNS4zMy00LTgtNHoiLz4KPC9zdmc+Cjwvc3ZnPgo='">
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="changeAvatar()">
                                    <i class="fas fa-camera"></i> Thay đổi
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h4 class="mb-2" style="color:var(--accent2);" id="profile-name">Nguyễn Văn A</h4>
                                <div class="profile-details">
                                    <div><i class="fas fa-envelope me-2"></i> <span id="profile-email">nguyenvana@email.com</span></div>
                                    <div><i class="fas fa-briefcase me-2"></i> <span id="profile-position">Nhân viên lễ tân</span></div>
                                    <div><i class="fas fa-id-card me-2"></i> Mã NV: <span id="profile-id">NV001</span></div>
                                    <div><i class="fas fa-calendar me-2"></i> Ngày vào làm: <span id="profile-start-date">01/01/2024</span></div>
                                    <div><i class="fas fa-map-marker-alt me-2"></i> <span id="profile-department">Phòng Lễ tân</span></div>
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <button class="btn btn-primary mb-2" onclick="editProfile()">
                                    <i class="fas fa-edit"></i> Chỉnh sửa
                                </button>
                                <button class="btn btn-outline-secondary mb-2" onclick="viewFullProfile()">
                                    <i class="fas fa-eye"></i> Xem chi tiết
                                </button>
                                <button class="btn btn-outline-success mb-2" onclick="previewStaffReport()" title="Xem trước báo cáo thống kê nhân viên">
                                    <i class="fas fa-eye"></i> Xem trước
                                </button>
                                <button class="btn btn-outline-success mb-2" onclick="exportStaffReport()" title="Xuất báo cáo thống kê nhân viên">
                                    <i class="fas fa-file-excel"></i> Xuất báo cáo
                                </button>
                                
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thống kê tổng quan -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card text-center stat-card">
                            <div class="card-body">
                                <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                                <h5>Giờ làm việc</h5>
                                <p class="h3 text-primary" id="total-work-hours">168</p>
                                <small class="text-muted">giờ/tháng</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center stat-card">
                            <div class="card-body">
                                <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                                <h5>Ngày đi làm</h5>
                                <p class="h3 text-success" id="work-days">22</p>
                                <small class="text-muted">ngày/tháng</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center stat-card">
                            <div class="card-body">
                                <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
                                <h5>Hiệu suất</h5>
                                <p class="h3 text-warning" id="performance-score">95%</p>
                                <small class="text-muted">điểm đánh giá</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center stat-card">
                            <div class="card-body">
                                <i class="fas fa-star fa-2x text-info mb-2"></i>
                                <h5>Đánh giá</h5>
                                <p class="h3 text-info" id="rating-score">4.8</p>
                                <small class="text-muted">sao/5</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biểu đồ và thống kê chi tiết -->
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <div class="card-modern">
                            <div class="card-body">
                                <div class="card-title d-flex justify-content-between align-items-center">
                                    <span>Biểu đồ chấm công tháng này</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary active" onclick="changeChartPeriod('week')">Tuần</button>
                                        <button class="btn btn-outline-primary" onclick="changeChartPeriod('month')">Tháng</button>
                                        <button class="btn btn-outline-primary" onclick="changeChartPeriod('quarter')">Quý</button>
                                    </div>
                                </div>
                                <canvas id="attendanceChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phần chấm công -->
                    <div class="col-md-4">
                        <div class="card-modern">
                            <div class="card-body">
                                <div class="card-title">Chấm công hôm nay</div>
                                <div class="text-center mb-3">
                                    <div class="current-time" id="current-time">--:--:--</div>
                                    <div class="current-date" id="current-date">--/--/----</div>
                                </div>
                                <div class="attendance-buttons">
                                    <button class="btn btn-success w-100 mb-2" onclick="checkIn()" id="checkin-btn">
                                        <i class="fas fa-sign-in-alt"></i> Chấm công vào
                                    </button>
                                    <button class="btn btn-danger w-100 mb-2" onclick="checkOut()" id="checkout-btn">
                                        <i class="fas fa-sign-out-alt"></i> Chấm công ra
                                    </button>
                                    <button class="btn btn-info w-100" onclick="viewAttendanceHistory()">
                                        <i class="fas fa-history"></i> Lịch sử chấm công
                                    </button>
                                </div>
                                <hr>
                                <div class="today-status">
                                    <h6>Trạng thái hôm nay:</h6>
                                    <div id="today-attendance-status">Chưa chấm công</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-modern">
                            <div class="card-body">
                                <div class="card-title">Thống kê nghỉ phép</div>
                                <div class="leave-stats">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Phép năm còn lại:</span>
                                        <span class="fw-bold text-success" id="remaining-leave">12 ngày</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Đã sử dụng:</span>
                                        <span class="fw-bold text-warning" id="used-leave">3 ngày</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Nghỉ ốm:</span>
                                        <span class="fw-bold text-danger" id="sick-leave">1 ngày</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Tổng phép năm:</span>
                                        <span class="fw-bold text-primary" id="total-leave">15 ngày</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="card-title">Thành tích tháng</div>
                                <div class="achievement-stats">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Khách phục vụ:</span>
                                        <span class="fw-bold text-info" id="customers-served">156</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Đánh giá tốt:</span>
                                        <span class="fw-bold text-success" id="good-reviews">142</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Phản hồi xử lý:</span>
                                        <span class="fw-bold text-primary" id="feedback-processed">23</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Điểm trung bình:</span>
                                        <span class="fw-bold text-warning" id="avg-rating">4.8</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lịch sử hoạt động gần đây -->
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title d-flex justify-content-between align-items-center">
                            <span>Hoạt động gần đây</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecentActivity()">
                                <i class="fas fa-sync-alt"></i> Làm mới
                            </button>
                        </div>
                        <div class="activity-timeline" id="activity-timeline">
                            <!-- Dữ liệu sẽ được load bằng JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Thông tin liên hệ khẩn cấp -->
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title">Thông tin liên hệ khẩn cấp</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="contact-info">
                                    <h6><i class="fas fa-user me-2"></i>Người liên hệ khẩn cấp</h6>
                                    <p id="emergency-contact">Nguyễn Thị B (Vợ)</p>
                                    <p><i class="fas fa-phone me-2"></i><span id="emergency-phone">0901234567</span></p>
                                    <p><i class="fas fa-map-marker-alt me-2"></i><span id="emergency-address">123 Đường ABC, Quận 1, TP.HCM</span></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="contact-info">
                                    <h6><i class="fas fa-building me-2"></i>Thông tin công ty</h6>
                                    <p><i class="fas fa-phone me-2"></i>Hotline: 1900-1234</p>
                                    <p><i class="fas fa-envelope me-2"></i>HR: hr@luxuryhaven.com</p>
                                    <p><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ: 456 Đường XYZ, Quận 3, TP.HCM</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Chấm công -->
            <section id="attendance-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="card-title">Chấm công hôm nay</div>
                            <button class="btn btn-primary" onclick="showTimesheet()">
                                <i class="fas fa-clock me-2"></i>Hệ thống chấm công
                            </button>
                        </div>
                        
                        <!-- Quick check in/out -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5>Check In</h5>
                                        <p class="h4" id="checkinTime">--:--</p>
                                        <button class="btn btn-success" onclick="quickCheckIn()">Check In</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5>Check Out</h5>
                                        <p class="h4" id="checkoutTime">--:--</p>
                                        <button class="btn btn-danger" onclick="quickCheckOut()">Check Out</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-title mb-2">Trạng thái hôm nay</div>
                        <div id="todayStatus" class="mb-3">
                            <p class="text-muted">Chưa có dữ liệu hôm nay</p>
                        </div>

                        <hr style="border-color:var(--border);">
                        <div class="card-title mb-2">Lịch sử chấm công</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Ngày</th>
                                        <th>Check In</th>
                                        <th>Check Out</th>
                                        <th>Giờ làm việc</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-body">
                                    <!-- Dữ liệu sẽ được load bằng JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Xin nghỉ phép -->
            <section id="leave-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="card-title">Xin nghỉ phép</div>
                            <button class="btn btn-info btn-sm" onclick="loadLeaveHistory()" title="Làm mới dữ liệu">
                                <i class="fas fa-sync-alt me-1"></i> Làm mới
                            </button>
                        </div>
                        <form class="row g-2 align-items-end mb-3" onsubmit="requestLeave(event)">
                            <div class="col-md-3">
                                <label class="form-label">Ngày nghỉ</label>
                                <input type="date" id="leave-date" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Loại nghỉ</label>
                                <select id="leave-type" class="form-select" required>
                                    <option value="">Chọn loại nghỉ</option>
                                    <option value="Nghỉ phép năm">Nghỉ phép năm</option>
                                    <option value="Nghỉ ốm">Nghỉ ốm</option>
                                    <option value="Nghỉ việc riêng">Nghỉ việc riêng</option>
                                    <option value="Nghỉ thai sản">Nghỉ thai sản</option>
                                    <option value="Nghỉ tang lễ">Nghỉ tang lễ</option>
                                    <option value="Nghỉ khẩn cấp">Nghỉ khẩn cấp</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Lý do</label>
                                <input type="text" id="leave-reason" class="form-control" placeholder="Nhập lý do nghỉ..." required>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success w-100" type="submit"><i class="fas fa-paper-plane me-1"></i> Gửi yêu cầu</button>
                            </div>
                        </form>
                        
                        <!-- Thông tin số ngày phép còn lại -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="card text-center" style="background: linear-gradient(135deg, #28a745, #20c997);">
                                    <div class="card-body">
                                        <h5 class="text-white">Phép năm còn lại</h5>
                                        <p class="h3 text-white" id="remainingAnnualLeave">12</p>
                                        <small class="text-white">ngày</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">
                                    <div class="card-body">
                                        <h5 class="text-white">Đã sử dụng</h5>
                                        <p class="h3 text-white" id="usedLeave">3</p>
                                        <small class="text-white">ngày</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);">
                                    <div class="card-body">
                                        <h5 class="text-white">Tổng phép năm</h5>
                                        <p class="h3 text-white" id="totalAnnualLeave">15</p>
                                        <small class="text-white">ngày</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-title mb-2">Lịch sử xin nghỉ phép</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Ngày</th>
                                        <th>Loại nghỉ</th>
                                        <th>Lý do</th>
                                        <th>Trạng thái</th>
                                        <th>Người duyệt</th>
                                        <th>Ngày gửi</th>
                                    </tr>
                                </thead>
                                <tbody id="leave-body">
                                    <!-- Dữ liệu sẽ được load bằng JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Check-in/out -->
            <section id="checkin-section" style="display:none;">
                <!-- ...giữ nguyên nội dung check-in/out... -->
            </section>
            <!-- Buồng phòng -->
            <section id="housekeeping-section" style="display:none;">
                <!-- ...giữ nguyên nội dung buồng phòng... -->
            </section>
            <!-- Phản hồi -->
            <section id="feedback-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-comment-dots me-2"></i>Phản hồi từ khách</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Khách hàng</th>
                                        <th>Phòng</th>
                                        <th>Nội dung</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="feedback-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">Đang tải dữ liệu phản hồi...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Thống kê -->
            <section id="stats-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-chart-bar me-2"></i>Thống kê năng suất cá nhân</div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-bed"></i></div>
                                    <div class="stat-label">Đặt phòng đã xử lý</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-sign-in-alt"></i></div>
                                    <div class="stat-label">Check-in/out đã hỗ trợ</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-comment-dots"></i></div>
                                    <div class="stat-label">Phản hồi khách đã xử lý</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <canvas id="personalStatsChart" height="80"></canvas>
                            <div class="text-center text-muted mt-3" id="stats-empty-message">
                                Chưa có dữ liệu thống kê cá nhân.
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Quản lý đặt phòng -->
            <section id="booking-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                            <div class="card-title mb-0"><i class="fas fa-bed me-2"></i>Quản lý đặt phòng</div>
                            <div class="d-flex gap-2">
                                <select id="bookingStatusFilter" class="form-select form-select-sm" style="max-width: 200px;">
                                    <option value="all" selected>Tất cả trạng thái</option>
                                    <option value="pending">Chờ xác nhận</option>
                                    <option value="confirmed">Đã xác nhận</option>
                                    <option value="cancelled">Đã hủy</option>
                                    <option value="completed">Hoàn thành</option>
                                </select>
                                <input type="text" id="bookingSearchInput" class="form-control form-control-sm" style="max-width: 250px;" placeholder="Tìm kiếm booking...">
                                <button class="btn btn-primary btn-sm" onclick="showAddBookingModal()">
                                    <i class="fas fa-plus-circle me-1"></i> Thêm đặt phòng
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Khách hàng</th>
                                        <th>Email</th>
                                        <th>Số điện thoại</th>
                                        <th>Khách sạn</th>
                                        <th>Dịch vụ</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Số khách</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="booking-table-body">
                                    <tr>
                                        <td colspan="11" class="text-center py-5">Đang tải dữ liệu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Check-in/Check-out -->
            <section id="checkin-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-sign-in-alt me-2"></i>Quản lý Check-in/Check-out</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Phòng</th>
                                        <th>Khách</th>
                                        <th>Ngày đến</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="checkin-table-body">
                                    <tr>
                                        <td>101</td>
                                        <td>Nguyễn Văn B</td>
                                        <td>2024-06-10</td>
                                        <td><span class="badge bg-info">Chờ check-in</span></td>
                                        <td><button class="btn btn-sm btn-success">Check-in</button></td>
                                    </tr>
                                    <tr>
                                        <td>102</td>
                                        <td>Trần Thị C</td>
                                        <td>2024-06-11</td>
                                        <td><span class="badge bg-secondary">Đã check-in</span></td>
                                        <td><button class="btn btn-sm btn-warning">Check-out</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Giao việc buồng phòng -->
            <section id="housekeeping-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-broom me-2"></i>Giao việc buồng phòng</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Phòng</th>
                                        <th>Công việc</th>
                                        <th>Trạng thái</th>
                                        <th>Nhân viên</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="housekeeping-table-body">
                                    <tr>
                                        <td>101</td>
                                        <td>Dọn phòng</td>
                                        <td><span class="badge bg-warning">Chờ làm</span></td>
                                        <td>Nguyễn Văn D</td>
                                        <td><button class="btn btn-sm btn-primary">Xác nhận hoàn thành</button></td>
                                    </tr>
                                    <tr>
                                        <td>102</td>
                                        <td>Sửa điều hòa</td>
                                        <td><span class="badge bg-success">Đã xong</span></td>
                                        <td>Trần Thị E</td>
                                        <td><button class="btn btn-sm btn-secondary" disabled>Đã xác nhận</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Phản hồi khách -->
            <section id="feedback-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-comment-dots me-2"></i>Phản hồi từ khách</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Khách hàng</th>
                                        <th>Phòng</th>
                                        <th>Nội dung</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="feedback-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">Chưa có phản hồi nào từ khách hàng.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Thống kê cá nhân -->
            <section id="stats-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-chart-bar me-2"></i>Thống kê năng suất cá nhân</div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-bed"></i></div>
                                    <div class="stat-label">Đặt phòng đã xử lý</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-sign-in-alt"></i></div>
                                    <div class="stat-label">Check-in/out đã hỗ trợ</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-comment-dots"></i></div>
                                    <div class="stat-label">Phản hồi khách đã xử lý</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <canvas id="personalStatsChart" height="80"></canvas>
                            <div class="text-center text-muted mt-3" id="stats-empty-message">
                                Chưa có dữ liệu thống kê cá nhân.
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Hệ thống chấm công -->
    <div class="modal fade" id="timesheetModal" tabindex="-1" aria-labelledby="timesheetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="timesheetModalLabel">Hệ thống Chấm công</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="list-group" role="tablist">
                                <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#timesheet-overview" role="tab">
                                    <i class="fas fa-calendar-alt me-2"></i>Lịch làm việc tháng này
                                </a>
                               
                                <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#timesheet-schedule" role="tab">
                                    <i class="fas fa-calendar-plus me-2"></i>Lịch làm việc
                                </a>
                                <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#timesheet-report" role="tab">
                                    <i class="fas fa-chart-line me-2"></i>Báo cáo chấm công
                                </a>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="tab-content">
                                <!-- Tab Lịch làm việc tháng này -->
                                <div class="tab-pane fade show active" id="timesheet-overview" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6>Lịch làm việc tháng này</h6>
                                        <button class="btn btn-primary btn-sm" onclick="showCreateScheduleModal()">
                                            <i class="fas fa-plus"></i> Tạo lịch
                                        </button>
                                    </div>
                                    <table class="table table-modern table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Ngày</th>
                                                <th>Ca làm việc</th>
                                                <th>Giờ bắt đầu</th>
                                                <th>Giờ kết thúc</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scheduleTableBody">
                                            <tr>
                                                <td>01/08/2025</td>
                                                <td>Ca sáng</td>
                                                <td>08:00</td>
                                                <td>17:00</td>
                                                <td><span class="badge bg-success">Đã hoàn thành</span></td>
                                            </tr>
                                            <tr>
                                                <td>02/08/2025</td>
                                                <td>Ca sáng</td>
                                                <td>08:00</td>
                                                <td>17:00</td>
                                                <td><span class="badge bg-primary">Đang làm việc</span></td>
                                            </tr>
                                            <tr>
                                                <td>04/08/2025</td>
                                                <td>Ca sáng</td>
                                                <td>08:00</td>
                                                <td>17:00</td>
                                                <td><span class="badge bg-info">Hôm nay</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Tab Check in/out -->
                                <div class="tab-pane fade" id="checkin-checkout" role="tabpanel">
                                    <h6>Check in/out hôm nay</h6>
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h5>Check In</h5>
                                                    <p class="h4" id="modalCheckinTime">--:--</p>
                                                    <button class="btn btn-success" onclick="checkIn()">Check In</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h5>Check Out</h5>
                                                    <p class="h4" id="modalCheckoutTime">--:--</p>
                                                    <button class="btn btn-danger" onclick="checkOut()">Check Out</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="modalTodayStatus">
                                        <p class="text-muted">Chưa có dữ liệu hôm nay</p>
                                    </div>
                                </div>
                                
                                <!-- Tab Lịch làm việc -->
                                <div class="tab-pane fade" id="timesheet-schedule" role="tabpanel">
                                    <h6>Quản lý lịch làm việc</h6>
                                    <div class="mb-3">
                                        <button class="btn btn-primary" onclick="showCreateScheduleModal()">
                                            <i class="fas fa-plus"></i> Tạo lịch mới
                                        </button>
                                    </div>
                                    <table class="table table-modern table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tuần</th>
                                                <th>Ngày bắt đầu</th>
                                                <th>Ngày kết thúc</th>
                                                <th>Tổng giờ</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Tuần 31</td>
                                                <td>29/07/2025</td>
                                                <td>02/08/2025</td>
                                                <td>40 giờ</td>
                                                <td><span class="badge bg-success">Hoàn thành</span></td>
                                            </tr>
                                            <tr>
                                                <td>Tuần 32</td>
                                                <td>03/08/2025</td>
                                                <td>09/08/2025</td>
                                                <td>40 giờ</td>
                                                <td><span class="badge bg-warning">Đang thực hiện</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Tab Báo cáo -->
                                <div class="tab-pane fade" id="timesheet-report" role="tabpanel">
                                    <h6>Báo cáo chấm công</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 style="color: var(--accent2);" id="totalWorkHours">160</h5>
                                                    <p class="mb-0">Tổng giờ tháng này</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 style="color: #28a745;" id="totalWorkDays">22</h5>
                                                    <p class="mb-0">Ngày làm việc</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 style="color: #ffc107;" id="attendanceRate">95%</h5>
                                                    <p class="mb-0">Tỷ lệ chấm công</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tạo lịch làm việc -->
    <div class="modal fade" id="createScheduleModal" tabindex="-1" aria-labelledby="createScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form class="modal-content" id="createScheduleForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="createScheduleModalLabel">Tạo lịch làm việc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="scheduleDate" class="form-label">Ngày làm việc</label>
                        <input type="date" class="form-control" id="scheduleDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="scheduleShift" class="form-label">Ca làm việc</label>
                        <select class="form-control" id="scheduleShift" required>
                            <option value="Sáng">Ca sáng (08:00 - 12:00)</option>
                            <option value="Chiều">Ca chiều (13:00 - 17:00)</option>
                            <option value="Tối">Ca tối (18:00 - 22:00)</option>
                            <option value="Toàn thời gian">Toàn thời gian (08:00 - 17:00)</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleStartTime" class="form-label">Giờ bắt đầu</label>
                                <input type="time" class="form-control" id="scheduleStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleEndTime" class="form-label">Giờ kết thúc</label>
                                <input type="time" class="form-control" id="scheduleEndTime" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Tạo lịch</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase App (core) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // Phân quyền mẫu
        // Các giá trị: 'receptionist', 'manager', 'housekeeping', 'marketing', ...
        const userRole = 'receptionist'; // Đổi giá trị này để test các vai trò khác nhau
        const userName = 'Nguyễn Văn A';
        const userManager = 'Trần Thị B'; // Trưởng phòng

        // Hiển thị vai trò trên header
        document.addEventListener('DOMContentLoaded', function() {
            // Thêm vai trò vào header
            const header = document.querySelector('.main-header .user-info');
            if (header && !document.getElementById('role-badge')) {
                const badge = document.createElement('span');
                badge.id = 'role-badge';
                badge.className = 'badge bg-info';
                badge.style.marginLeft = '8px';
                badge.textContent =
                    userRole === 'manager' ? 'Trưởng phòng' :
                    userRole === 'receptionist' ? 'Lễ tân' :
                    userRole === 'housekeeping' ? 'Buồng phòng' :
                    userRole === 'marketing' ? 'Marketing' : userRole;
                header.appendChild(badge);
            }
        });

        // Sidebar navigation
        function showSection(section) {
            // Ẩn tất cả sections
            document.getElementById('profile-section').style.display = 'none';
            document.getElementById('attendance-section').style.display = 'none';
            document.getElementById('leave-section').style.display = 'none';
            document.getElementById('booking-section').style.display = 'none';
            document.getElementById('checkin-section').style.display = 'none';
            document.getElementById('housekeeping-section').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('stats-section').style.display = 'none';
            
            // Xóa active class từ tất cả nav items
            document.querySelectorAll('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
            
            if (section === 'profile') {
                document.getElementById('profile-section').style.display = '';
                document.querySelector('.sidebar .nav-item[href="#profile"]').classList.add('active');
            } else if (section === 'attendance') {
                document.getElementById('attendance-section').style.display = '';
                document.querySelector('.sidebar .nav-item[href="#attendance"]').classList.add('active');
            } else if (section === 'leave') {
                document.getElementById('leave-section').style.display = '';
                document.querySelector('.sidebar .nav-item[href="#leave"]').classList.add('active');
                loadLeaveHistory(); // Load dữ liệu khi vào trang nghỉ phép
            } else if (section === 'booking') {
                console.log('🎯 Showing booking section...');
                const bookingSection = document.getElementById('booking-section');
                bookingSection.style.display = '';
                console.log('📋 Booking section display style:', bookingSection.style.display);
                document.querySelector('.sidebar .nav-item.booking').classList.add('active');
                loadBookings(); // Load dữ liệu khi vào trang đặt phòng
            } else if (section === 'checkin') {
                document.getElementById('checkin-section').style.display = '';
                document.querySelector('.sidebar .nav-item.checkin').classList.add('active');
            } else if (section === 'housekeeping') {
                document.getElementById('housekeeping-section').style.display = '';
                document.querySelector('.sidebar .nav-item.housekeeping').classList.add('active');
            } else if (section === 'feedback') {
                document.getElementById('feedback-section').style.display = '';
                document.querySelector('.sidebar .nav-item.feedback').classList.add('active');
                console.log('📊 Loading feedback data realtime...');
                loadFeedbackData(); // Load dữ liệu phản hồi realtime từ Firebase
            } else if (section === 'stats') {
                document.getElementById('stats-section').style.display = '';
                document.querySelector('.sidebar .nav-item.stats').classList.add('active');
                console.log('📊 Loading statistics data realtime...');
                // Đảm bảo chart được khởi tạo trước khi load dữ liệu
                initializePersonalStatsChart();
                loadStatisticsData(); // Load dữ liệu thống kê realtime từ Firebase
            }
        }

        // ...existing code...

        // Ẩn/hiện form chấm công theo lựa chọn địa điểm
        document.addEventListener('DOMContentLoaded', function() {
            showSection('profile');
            loadTodayStatusMain();
            
            // Load profile data khi vào trang
            setTimeout(() => {
                loadProfileData();
                updateAttendanceChart('month');
            }, 1000);
            
            // Kiểm tra định kỳ cập nhật trạng thái nghỉ phép từ admin (mỗi 10 giây)
            setInterval(() => {
                if (document.getElementById('leave-section').style.display !== 'none') {
                    loadLeaveHistory();
                }
            }, 10000);
            
            // Attendance chart demo
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22'],
                    datasets: [{
                        label: 'Giờ vào',
                        data: [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124,58,237,0.2)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Giờ ra',
                        data: [17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17],
                        borderColor: '#00eaff',
                        backgroundColor: 'rgba(0,234,255,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    plugins: {
                        legend: { labels: { color: '#2d3748' } }
                    },
                    scales: {
                        x: { ticks: { color: '#718096' }, grid: { color: '#e2e8f0' } },
                        y: { ticks: { color: '#718096' }, grid: { color: '#e2e8f0' } }
                    }
                }
            });

            // Thống kê cá nhân Chart.js
            function initializePersonalStatsChart() {
                const chartCanvas = document.getElementById('personalStatsChart');
                if (chartCanvas && !window.personalStatsChart) {
                    window.personalStatsChart = new Chart(chartCanvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Đặt phòng', 'Check-in/out', 'Phản hồi'],
                            datasets: [{
                                label: 'Số lượt xử lý',
                                data: [0, 0, 0], // Sẽ được cập nhật từ Firebase
                                backgroundColor: [
                                    '#ffb300', '#00eaff', '#ff4081'
                                ]
                            }]
                        },
                                            options: {
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#2d3748' }, grid: { color: '#e2e8f0' } },
                            y: { ticks: { color: '#2d3748' }, grid: { color: '#e2e8f0' } }
                        }
                    }
                    });
                    console.log('✅ Personal stats chart initialized');
                }
            }
            
            // Khởi tạo chart khi trang load
            initializePersonalStatsChart();
        });
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.appspot.com",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };
        
        // Khởi tạo Firebase (chỉ nếu chưa được khởi tạo)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            console.log('📱 Firebase already initialized');
        }
        
        // Bảo mật: Kiểm tra quyền truy cập staff dashboard
        function checkStaffAccess() {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.error('❌ Không có user đăng nhập');
                window.location.href = '../auth.html';
                return;
            }
            
            const email = currentUser.email;
            console.log('🔐 Kiểm tra quyền truy cập cho:', email);
            
            // Kiểm tra admin
            if (email === 'quantrikhachsan@gmail.com') {
                console.log('✅ Admin access granted');
                return;
            }
            
            // Kiểm tra staff access
            return Promise.all([
                firebase.database().ref('staff').once('value'),
                firebase.database().ref('staffAccess').once('value')
            ]).then(([staffSnapshot, staffAccessSnapshot]) => {
                const staffData = staffSnapshot.val();
                const staffAccessData = staffAccessSnapshot.val();
                
                // Kiểm tra trong staffAccess
                const emailKey = email.replace(/[@.]/g, '_');
                if (staffAccessData && staffAccessData[emailKey]) {
                    const role = staffAccessData[emailKey];
                    console.log('✅ Staff access granted:', role);
                    return;
                }
                
                // Kiểm tra trong staff database
                if (staffData) {
                    for (let staffId in staffData) {
                        const staff = staffData[staffId];
                        const staffEmail = staff.email || staff.êmmail || staff['êmmail'];
                        if (staffEmail === email) {
                            console.log('✅ Staff access granted:', staff.role || staff.chucVu);
                            return;
                        }
                    }
                }
                
                // Không có quyền
                console.error('❌ Access denied for:', email);
                Swal.fire({
                    icon: 'error',
                    title: 'Truy cập bị từ chối',
                    text: 'Bạn không có quyền truy cập vào Staff Dashboard.',
                    confirmButtonText: 'Đăng nhập lại'
                }).then(() => {
                    window.location.href = '../auth.html';
                });
            }).catch((error) => {
                console.error('❌ Error checking staff access:', error);
                window.location.href = '../auth.html';
            });
        }
        
        // Đăng nhập tự động khi trang load (demo)
        firebase.auth().onAuthStateChanged(function(user) {
            if (!user) {
                // Nếu chưa đăng nhập, tạo user ẩn danh hoặc đăng nhập demo
                firebase.auth().signInAnonymously().then(() => {
                    console.log('Đăng nhập ẩn danh thành công');
                }).catch((error) => {
                    console.error('Lỗi đăng nhập ẩn danh:', error);
                    // Fallback: đăng nhập với email demo
                    firebase.auth().signInWithEmailAndPassword('staff@demo.com', 'password123').catch(() => {
                        console.warn('Không thể đăng nhập Firebase Auth');
                    });
                });
            } else {
                console.log('User đã đăng nhập:', user.uid);
                // Kiểm tra quyền truy cập sau khi đăng nhập
                checkStaffAccess();
            }
        });
        
        // Đăng xuất với Firebase Auth
        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                // Kiểm tra xem Firebase Auth có sẵn không
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().signOut().then(() => {
                        console.log('Đăng xuất thành công');
                        window.location.href = '../auth.html';
                    }).catch((error) => {
                        console.error('Lỗi đăng xuất:', error);
                        // Vẫn chuyển trang nếu có lỗi
                        window.location.href = '../auth.html';
                    });
                } else {
                    // Fallback nếu Firebase không có
                    window.location.href = '../auth.html';
                }
            }
        }

        // === CHỨC NĂNG XIN NGHỈ PHÉP ===
        
        // Dữ liệu nghỉ phép (Local Storage)
        function getLeaveRequests() {
            return JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        }
        
        function setLeaveRequests(requests) {
            localStorage.setItem('leaveRequests', JSON.stringify(requests));
        }
        
        // Xử lý form xin nghỉ phép
        window.requestLeave = function(event) {
            // Kiểm tra đăng nhập Firebase
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                alert('Bạn cần đăng nhập lại để sử dụng chức năng này!');
                return;
            }
            event.preventDefault();
            const date = document.getElementById('leave-date').value;
            const type = document.getElementById('leave-type').value;
            const reason = document.getElementById('leave-reason').value;
            if (!date || !type || !reason) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            // Kiểm tra ngày nghỉ phải từ hôm nay trở đi
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (selectedDate < today) {
                alert('Ngày nghỉ phải từ hôm nay trở đi!');
                return;
            }
            // Tạo yêu cầu nghỉ phép mới (đúng định dạng rule Firebase)
            const newRequest = {
                employeeId: getCurrentEmployeeId(),
                startDate: date,
                endDate: date, // Nếu chỉ nghỉ 1 ngày, startDate = endDate
                reason: reason,
                status: 'pending', // Rule chỉ cho phép 'pending', 'approved', 'rejected'
                createdAt: Date.now(),
                // Các trường phụ không bắt buộc, giữ lại nếu muốn
                type: type,
                employeeName: userName
            };
            
            console.log('📝 Creating new leave request:', newRequest);
            // Lưu localStorage (giữ lại cho tương thích cũ)
            const requests = getLeaveRequests();
            requests.push(newRequest);
            setLeaveRequests(requests);
            // Lưu lên Firebase
            firebase.database().ref('leaveRequests').push(newRequest, function(error) {
                if (error) {
                    alert('Lỗi khi gửi yêu cầu lên hệ thống!');
                } else {
                    // Thêm vào bảng
                    addLeaveRequestToTable(newRequest);
                    // Reset form
                    document.getElementById('leave-date').value = '';
                    document.getElementById('leave-type').value = '';
                    document.getElementById('leave-reason').value = '';
                    // Hiển thị thông báo
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Gửi yêu cầu thành công!',
                            text: 'Yêu cầu nghỉ phép đã được gửi đến quản lý. Bạn sẽ nhận được phản hồi trong vòng 24 giờ.',
                            timer: 3000,
                            showConfirmButton: false
                        });
                    } else {
                        alert('Đã gửi yêu cầu nghỉ phép thành công!\nYêu cầu sẽ được xem xét trong vòng 24 giờ.');
                    }
                }
            });
        };
        
        // Thêm yêu cầu nghỉ phép vào bảng
        function addLeaveRequestToTable(request) {
            const tbody = document.getElementById('leave-body');
            const row = document.createElement('tr');
            
            // Map status từ Firebase sang tiếng Việt
            const statusMap = {
                'pending': 'Chờ duyệt',
                'approved': 'Đã duyệt', 
                'rejected': 'Từ chối'
            };
            
            const displayStatus = statusMap[request.status] || request.status;
            const statusClass = 
                request.status === 'approved' ? 'bg-success' :
                request.status === 'rejected' ? 'bg-danger' : 'bg-warning';
            
            // Sử dụng startDate thay vì date
            const displayDate = request.startDate || request.date || '';
            const submittedDate = request.createdAt ? new Date(request.createdAt).toLocaleDateString('vi-VN') : 
                                 request.submittedDate ? new Date(request.submittedDate).toLocaleDateString('vi-VN') : '';
            
            row.innerHTML = `
                <td>${displayDate ? new Date(displayDate).toLocaleDateString('vi-VN') : '--'}</td>
                <td>${request.type || '--'}</td>
                <td>${request.reason || '--'}</td>
                <td><span class="badge ${statusClass}">${displayStatus}</span></td>
                <td>${request.approver || '--'}</td>
                <td>${submittedDate}</td>
            `;
            
            tbody.insertAdjacentElement('afterbegin', row);
        }
        
        // Load lịch sử xin nghỉ phép với real-time updates
        function loadLeaveHistory() {
            const tbody = document.getElementById('leave-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">Đang tải dữ liệu...</td></tr>';
            
            const currentEmployeeId = getCurrentEmployeeId();
            console.log('🔍 Loading leave history for employee:', currentEmployeeId);
            
            // Lắng nghe thay đổi real-time từ Firebase
            firebase.database().ref('leaveRequests').orderByChild('employeeId').equalTo(currentEmployeeId).on('value', function(snapshot) {
                const requests = [];
                snapshot.forEach(function(child) {
                    requests.push({ ...child.val(), firebaseKey: child.key });
                });
                
                // Xóa dữ liệu cũ
                tbody.innerHTML = '';
                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">Chưa có yêu cầu nghỉ phép nào</td></tr>';
                    updateLeaveStats([]);
                    return;
                }
                
                // Sắp xếp theo ngày tạo mới nhất
                requests.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                requests.forEach(request => {
                    addLeaveRequestToTable(request);
                });
                updateLeaveStats(requests);
                checkForLeaveStatusUpdates(requests);
            }, function(error) {
                console.error('Error loading leave requests:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-danger">Lỗi tải dữ liệu!</td></tr>';
            });
        }
        
        // Kiểm tra cập nhật trạng thái từ admin
        function checkForLeaveStatusUpdates(requests) {
            const lastChecked = localStorage.getItem('lastLeaveCheck');
            const currentTime = new Date().getTime();
            
            console.log('🔍 Checking for updates:', {
                lastChecked: lastChecked,
                currentTime: currentTime,
                requests: requests
            });
            
            if (lastChecked) {
                const newlyProcessed = requests.filter(r => {
                    // Sử dụng approvedAt hoặc rejectedAt từ Firebase
                    const processedTime = r.approvedAt ? r.approvedAt : (r.rejectedAt ? r.rejectedAt : 0);
                    const isNewlyProcessed = processedTime > parseInt(lastChecked) && r.status !== 'pending';
                    
                    console.log('🧐 Request check:', {
                        firebaseKey: r.firebaseKey,
                        status: r.status,
                        approvedAt: r.approvedAt,
                        rejectedAt: r.rejectedAt,
                        processedTime: processedTime,
                        lastChecked: parseInt(lastChecked),
                        isNewlyProcessed: isNewlyProcessed
                    });
                    
                    return isNewlyProcessed;
                });
                
                console.log('🆕 Newly processed requests:', newlyProcessed);
                
                newlyProcessed.forEach(request => {
                    if (typeof Swal !== 'undefined') {
                        const icon = request.status === 'approved' ? 'success' : 'error';
                        const title = request.status === 'approved' ? '✅ Yêu cầu được duyệt!' : '❌ Yêu cầu bị từ chối';
                        let text = `Yêu cầu nghỉ ${request.type || 'phép'} từ ngày ${request.startDate ? new Date(request.startDate).toLocaleDateString('vi-VN') : '--'} đã được ${request.status === 'approved' ? 'duyệt' : 'từ chối'}.`;
                        
                        if (request.rejectionReason) {
                            text += `\n\nLý do từ chối: ${request.rejectionReason}`;
                        }
                        
                        if (request.approver) {
                            text += `\n\nNgười duyệt: ${request.approver}`;
                        }
                        
                        Swal.fire({
                            icon: icon,
                            title: title,
                            text: text,
                            timer: 10000,
                            showConfirmButton: true,
                            confirmButtonText: 'Đã hiểu'
                        });
                    } else {
                        // Fallback alert nếu không có SweetAlert
                        const message = request.status === 'approved' ? 
                            `✅ Yêu cầu nghỉ phép đã được duyệt!\nNgày: ${request.startDate ? new Date(request.startDate).toLocaleDateString('vi-VN') : '--'}\nLoại: ${request.type || 'phép'}` :
                            `❌ Yêu cầu nghỉ phép bị từ chối!\nNgày: ${request.startDate ? new Date(request.startDate).toLocaleDateString('vi-VN') : '--'}\nLoại: ${request.type || 'phép'}${request.rejectionReason ? '\nLý do: ' + request.rejectionReason : ''}`;
                        alert(message);
                    }
                });
            }
            
            localStorage.setItem('lastLeaveCheck', currentTime.toString());
        }
        
        // Cập nhật thống kê phép
        function updateLeaveStats(requests) {
            const currentYear = new Date().getFullYear();
            const approvedRequests = requests.filter(r => 
                r.status === 'approved' && 
                r.startDate && new Date(r.startDate).getFullYear() === currentYear &&
                (r.type === 'Nghỉ phép năm' || !r.type || r.type.includes('phép'))
            );
            
            const usedDays = approvedRequests.length;
            const totalDays = 15; // Tổng số ngày phép năm
            const remainingDays = totalDays - usedDays;
            
            const usedElement = document.getElementById('usedLeave');
            const remainingElement = document.getElementById('remainingAnnualLeave');
            const totalElement = document.getElementById('totalAnnualLeave');
            
            if (usedElement) usedElement.textContent = usedDays;
            if (remainingElement) remainingElement.textContent = Math.max(0, remainingDays);
            if (totalElement) totalElement.textContent = totalDays;
        }

        // === CHỨC NĂNG CHẤM CÔNG ===
        
        // Dữ liệu chấm công (Local Storage)
        function getAttendances() {
            return JSON.parse(localStorage.getItem('attendances') || '[]');
        }
        
        function setAttendances(attendances) {
            localStorage.setItem('attendances', JSON.stringify(attendances));
        }
        
        function getCurrentEmployeeId() {
            // Return a fixed employee ID for demo purposes
            // In production, this should be the actual employee ID from user profile
            return 'NV001'; // Fixed ID for demo
        }
        
        // Hiển thị modal chấm công
        window.showTimesheet = function() {
            const timesheetModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('timesheetModal'));
            timesheetModal.show();
            loadTimesheetData();
        };
        
        // Quick check in/out cho trang chính
        window.quickCheckIn = function() {
            checkIn();
            loadTodayStatusMain();
        };
        
        window.quickCheckOut = function() {
            checkOut();
            loadTodayStatusMain();
        };
        
        // Check in
        window.checkIn = function() {
            const attendances = getAttendances();
            const today = new Date().toDateString();
            const existing = attendances.find(a => new Date(a.date).toDateString() === today && a.employeeId === getCurrentEmployeeId());
            
            if (existing && existing.checkIn) {
                alert('Bạn đã check in hôm nay!');
                return;
            }
            
            const checkInTime = new Date();
            if (existing) {
                existing.checkIn = checkInTime.toISOString();
            } else {
                attendances.push({
                    id: Date.now(),
                    employeeId: getCurrentEmployeeId(),
                    date: checkInTime.toISOString(),
                    checkIn: checkInTime.toISOString()
                });
            }
            
            setAttendances(attendances);
            loadTodayStatusMain();
            loadTodayStatusModal();
            alert(`Check in thành công lúc ${checkInTime.toLocaleTimeString('vi-VN')}`);
        };
        
        // Check out
        window.checkOut = function() {
            const attendances = getAttendances();
            const today = new Date().toDateString();
            const existing = attendances.find(a => new Date(a.date).toDateString() === today && a.employeeId === getCurrentEmployeeId());
            
            if (!existing || !existing.checkIn) {
                alert('Bạn chưa check in hôm nay!');
                return;
            }
            
            if (existing.checkOut) {
                alert('Bạn đã check out hôm nay!');
                return;
            }
            
            const checkOutTime = new Date();
            existing.checkOut = checkOutTime.toISOString();
            
            // Tính giờ làm việc
            const workHours = (new Date(existing.checkOut) - new Date(existing.checkIn)) / (1000 * 60 * 60);
            existing.workHours = workHours.toFixed(2);
            
            setAttendances(attendances);
            loadTodayStatusMain();
            loadTodayStatusModal();
            alert(`Check out thành công lúc ${checkOutTime.toLocaleTimeString('vi-VN')}\nTổng giờ làm: ${workHours.toFixed(2)} giờ`);
        };
        
        // Load trạng thái hôm nay (trang chính)
        function loadTodayStatusMain() {
            const attendances = getAttendances();
            const today = new Date().toDateString();
            const todayRecord = attendances.find(a => new Date(a.date).toDateString() === today && a.employeeId === getCurrentEmployeeId());
            
            const checkinTimeEl = document.getElementById('checkinTime');
            const checkoutTimeEl = document.getElementById('checkoutTime');
            const statusEl = document.getElementById('todayStatus');
            
            if (checkinTimeEl) {
                checkinTimeEl.textContent = todayRecord && todayRecord.checkIn ? 
                    new Date(todayRecord.checkIn).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '--:--';
            }
            
            if (checkoutTimeEl) {
                checkoutTimeEl.textContent = todayRecord && todayRecord.checkOut ? 
                    new Date(todayRecord.checkOut).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '--:--';
            }
            
            if (statusEl) {
                const statusHtml = todayRecord ? `
                    <p><strong>Check in:</strong> ${todayRecord.checkIn ? new Date(todayRecord.checkIn).toLocaleTimeString('vi-VN') : 'Chưa check in'}</p>
                    <p><strong>Check out:</strong> ${todayRecord.checkOut ? new Date(todayRecord.checkOut).toLocaleTimeString('vi-VN') : 'Chưa check out'}</p>
                    <p><strong>Giờ làm:</strong> ${todayRecord.workHours || '0'} giờ</p>
                ` : '<p class="text-muted">Chưa có dữ liệu hôm nay</p>';
                
                statusEl.innerHTML = statusHtml;
            }
            
            loadAttendanceHistory();
        }
        
        // Load trạng thái hôm nay (modal)
        function loadTodayStatusModal() {
            const attendances = getAttendances();
            const today = new Date().toDateString();
            const todayRecord = attendances.find(a => new Date(a.date).toDateString() === today && a.employeeId === getCurrentEmployeeId());
            
            const modalCheckinTimeEl = document.getElementById('modalCheckinTime');
            const modalCheckoutTimeEl = document.getElementById('modalCheckoutTime');
            const modalStatusEl = document.getElementById('modalTodayStatus');
            
            if (modalCheckinTimeEl) {
                modalCheckinTimeEl.textContent = todayRecord && todayRecord.checkIn ? 
                    new Date(todayRecord.checkIn).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '--:--';
            }
            
            if (modalCheckoutTimeEl) {
                modalCheckoutTimeEl.textContent = todayRecord && todayRecord.checkOut ? 
                    new Date(todayRecord.checkOut).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '--:--';
            }
            
            if (modalStatusEl) {
                const statusHtml = todayRecord ? `
                    <p><strong>Check in:</strong> ${todayRecord.checkIn ? new Date(todayRecord.checkIn).toLocaleTimeString('vi-VN') : 'Chưa check in'}</p>
                    <p><strong>Check out:</strong> ${todayRecord.checkOut ? new Date(todayRecord.checkOut).toLocaleTimeString('vi-VN') : 'Chưa check out'}</p>
                    <p><strong>Giờ làm:</strong> ${todayRecord.workHours || '0'} giờ</p>
                ` : '<p class="text-muted">Chưa có dữ liệu hôm nay</p>';
                
                modalStatusEl.innerHTML = statusHtml;
            }
        }
        
        // Load lịch sử chấm công
        function loadAttendanceHistory() {
            const attendances = getAttendances().filter(a => a.employeeId === getCurrentEmployeeId());
            const tbody = document.getElementById('attendance-body');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Sắp xếp theo ngày mới nhất
            attendances.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            attendances.slice(0, 10).forEach(record => {
                const row = document.createElement('tr');
                const date = new Date(record.date);
                const status = record.checkIn && record.checkOut ? 'Hoàn thành' : 
                             record.checkIn ? 'Đang làm việc' : 'Chưa check in';
                const statusClass = record.checkIn && record.checkOut ? 'bg-success' : 
                                  record.checkIn ? 'bg-primary' : 'bg-secondary';
                
                row.innerHTML = `
                    <td>${date.toLocaleDateString('vi-VN')}</td>
                    <td>${record.checkIn ? new Date(record.checkIn).toLocaleTimeString('vi-VN') : '--'}</td>
                    <td>${record.checkOut ? new Date(record.checkOut).toLocaleTimeString('vi-VN') : '--'}</td>
                    <td>${record.workHours || '0'} giờ</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Load dữ liệu chấm công cho modal
        function loadTimesheetData() {
            loadTodayStatusModal();
            updateMonthlyStats();
        }
        
        // Cập nhật thống kê tháng
        function updateMonthlyStats() {
            const attendances = getAttendances().filter(a => a.employeeId === getCurrentEmployeeId());
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyData = attendances.filter(a => {
                const date = new Date(a.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const totalWorkDays = monthlyData.filter(a => a.checkIn && a.checkOut).length;
            const totalWorkHours = monthlyData.reduce((sum, a) => sum + (parseFloat(a.workHours) || 0), 0);
            const attendanceRate = totalWorkDays > 0 ? ((totalWorkDays / new Date().getDate()) * 100).toFixed(0) : 0;
            
            const totalWorkHoursEl = document.getElementById('totalWorkHours');
            const totalWorkDaysEl = document.getElementById('totalWorkDays');
            const attendanceRateEl = document.getElementById('attendanceRate');
            
            if (totalWorkHoursEl) totalWorkHoursEl.textContent = totalWorkHours.toFixed(0);
            if (totalWorkDaysEl) totalWorkDaysEl.textContent = totalWorkDays;
            if (attendanceRateEl) attendanceRateEl.textContent = attendanceRate + '%';
        }
        
        // Hiển thị modal tạo lịch làm việc
        window.showCreateScheduleModal = function() {
            const createScheduleModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('createScheduleModal'));
            createScheduleModal.show();
        };

        // ===== BOOKING MANAGEMENT FUNCTIONS =====
        let allBookings = [];

            // Load bookings data from Firebase
            function loadBookings() {
                console.log('🔄 Loading bookings data...');
                const bookingsRef = firebase.database().ref('bookings');
                bookingsRef.on('value', (snapshot) => {
                    allBookings = [];
                    if (snapshot.exists()) {
                        console.log('📋 Found', snapshot.numChildren(), 'bookings in database');
                        snapshot.forEach((childSnapshot) => {
                            const booking = childSnapshot.val();
                            booking.id = childSnapshot.key;
                            allBookings.push(booking);
                            console.log('📋 Loaded booking:', {
                                id: booking.id,
                                type: booking.type,
                                bookingType: booking.bookingType,
                                customerName: booking.customerName,
                                hotelName: booking.hotelName,
                                tourName: booking.tourName,
                                status: booking.status
                            });
                        });
                        allBookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by most recent
                    } else {
                        console.log('📋 No bookings found in database');
                    }
                    console.log('📊 All loaded bookings:', allBookings);
                    console.log('📊 Booking types summary:', allBookings.map(b => ({ id: b.id, type: b.type, bookingType: b.bookingType })));
                    filterAndDisplayBookings();
                    console.log('✅ Loaded', allBookings.length, 'bookings');
                }, (error) => {
                    console.error("❌ Error loading bookings:", error);
                    Swal.fire('Lỗi', 'Không thể tải danh sách đặt phòng.', 'error');
                });
            }

        // Filter and display bookings
        function filterAndDisplayBookings() {
            let filteredBookings = [...allBookings];
            console.log('🔍 Starting filter with', allBookings.length, 'bookings');

            // Search filter
            const searchTerm = document.getElementById('bookingSearchInput').value.toLowerCase().trim();
            if (searchTerm) {
                filteredBookings = filteredBookings.filter(b => 
                    (b.id && b.id.toLowerCase().includes(searchTerm)) ||
                    (b.customerName && b.customerName.toLowerCase().includes(searchTerm)) ||
                    (b.customerEmail && b.customerEmail.toLowerCase().includes(searchTerm)) ||
                    (b.customerPhone && b.customerPhone.includes(searchTerm)) ||
                    (b.hotelName && b.hotelName.toLowerCase().includes(searchTerm))
                );
                console.log('🔍 After search filter:', filteredBookings.length, 'bookings');
            }

            // Status filter
            const statusFilter = document.getElementById('bookingStatusFilter').value;
            if (statusFilter !== 'all') {
                filteredBookings = filteredBookings.filter(b => b.status === statusFilter);
                console.log('🔍 After status filter:', filteredBookings.length, 'bookings');
            }

            // Hiển thị tất cả bookings (không filter theo type)
            console.log('📊 Final filtered bookings:', filteredBookings);
            console.log('📊 All booking types:', filteredBookings.map(b => ({ id: b.id, type: b.type, bookingType: b.bookingType })));
            renderBookingsTable(filteredBookings);
        }

        // Render bookings table
        function renderBookingsTable(bookings) {
            console.log('🎨 Rendering table with', bookings.length, 'bookings');
            const tableBody = document.getElementById('booking-table-body');
            if (!tableBody) {
                console.error('❌ Table body element not found!');
                return;
            }
            console.log('✅ Table body found:', tableBody);
            tableBody.innerHTML = '';

            if (bookings.length === 0) {
                console.log('📭 No bookings to display');
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-5">Không tìm thấy dữ liệu phù hợp.</td></tr>';
                return;
            }

            bookings.forEach((booking, index) => {
                const row = document.createElement('tr');
                
                // Status Badge
                const statusBadge = `<span class="status status-${booking.status || 'pending'}">${getStatusText(booking.status)}</span>`;
                
                // Service Details - Hiển thị tất cả loại booking
                let serviceDetails = '';
                let serviceType = '';
                
                if (booking.type === 'hotel' || booking.bookingType === 'hotel' || booking.hotelName) {
                    serviceType = 'Khách sạn';
                    serviceDetails = `
                        <strong title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</strong><br>
                        <small class="text-muted" title="${booking.roomId || booking.roomName || ''}">${booking.roomId || booking.roomName || 'N/A'}</small>
                    `;
                } else if (booking.type === 'tour' || booking.bookingType === 'tour' || booking.tourName) {
                    serviceType = 'Tour';
                    serviceDetails = `
                        <strong title="${booking.tourName || ''}">${booking.tourName || 'Tour'}</strong><br>
                        <small class="text-muted">Tour du lịch</small>
                    `;
                } else {
                    serviceType = 'Dịch vụ';
                    serviceDetails = `
                        <strong>${booking.serviceName || 'Dịch vụ'}</strong><br>
                        <small class="text-muted">${booking.type || booking.bookingType || 'Khác'}</small>
                    `;
                }

                // Format dates
                const checkInDate = booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A';
                const checkOutDate = booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : 'N/A';

                row.innerHTML = `
                    <td title="${booking.id}">
                        <strong>${booking.id}</strong><br>
                        <small class="text-muted">${serviceType}</small>
                    </td>
                    <td title="${booking.customerName || ''}">${booking.customerName || 'N/A'}</td>
                    <td title="${booking.customerEmail || ''}">${booking.customerEmail || 'N/A'}</td>
                    <td title="${booking.customerPhone || ''}">${booking.customerPhone || 'N/A'}</td>
                    <td title="${booking.hotelName || booking.tourName || ''}">${booking.hotelName || booking.tourName || 'N/A'}</td>
                    <td>${serviceDetails}</td>
                    <td title="${checkInDate}">${checkInDate}</td>
                    <td title="${checkOutDate}">${checkOutDate}</td>
                    <td title="${booking.guests || ''}">${booking.guests || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewBookingDetails('${booking.id}')" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="updateBookingStatus('${booking.id}', 'confirmed')" title="Xác nhận" ${booking.status === 'confirmed' ? 'disabled' : ''}>
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="updateBookingStatus('${booking.id}', 'pending')" title="Chờ xử lý" ${booking.status === 'pending' ? 'disabled' : ''}>
                            <i class="fas fa-clock"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
                console.log(`📝 Added row ${index + 1} for booking:`, booking.id, 'Type:', booking.type || booking.bookingType);
            });
            console.log('✅ Table rendering completed. Total rows:', tableBody.children.length);
        }

        // Get status text in Vietnamese
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Chờ xác nhận',
                'confirmed': 'Đã xác nhận',
                'cancelled': 'Đã hủy',
                'completed': 'Hoàn thành'
            };
            return statusMap[status] || 'Chờ xác nhận';
        }

        // View booking details
        window.viewBookingDetails = function(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('Lỗi', 'Không tìm thấy thông tin đặt phòng.', 'error');
                return;
            }

            const detailsHtml = `
                <div class="text-start">
                    <p><strong>ID:</strong> ${booking.id}</p>
                    <p><strong>Khách hàng:</strong> ${booking.customerName || 'N/A'}</p>
                    <p><strong>Email:</strong> ${booking.customerEmail || 'N/A'}</p>
                    <p><strong>Số điện thoại:</strong> ${booking.customerPhone || 'N/A'}</p>
                    <p><strong>Khách sạn:</strong> ${booking.hotelName || 'N/A'}</p>
                    <p><strong>Phòng:</strong> ${booking.roomId || booking.roomName || 'N/A'}</p>
                    <p><strong>Check-in:</strong> ${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</p>
                    <p><strong>Check-out:</strong> ${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : 'N/A'}</p>
                    <p><strong>Số khách:</strong> ${booking.guests || 'N/A'}</p>
                    <p><strong>Trạng thái:</strong> ${getStatusText(booking.status)}</p>
                    <p><strong>Ngày tạo:</strong> ${booking.createdAt ? new Date(booking.createdAt).toLocaleDateString('vi-VN') : 'N/A'}</p>
                </div>
            `;

            Swal.fire({
                title: 'Chi tiết đặt phòng',
                html: detailsHtml,
                icon: 'info',
                confirmButtonText: 'Đóng'
            });
        };

        // Update booking status
        window.updateBookingStatus = function(bookingId, newStatus) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('Lỗi', 'Không tìm thấy thông tin đặt phòng.', 'error');
                return;
            }

            const statusText = getStatusText(newStatus);
            
            Swal.fire({
                title: 'Xác nhận thay đổi',
                text: `Bạn có chắc muốn thay đổi trạng thái đặt phòng ${bookingId} thành "${statusText}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    const bookingRef = firebase.database().ref(`bookings/${bookingId}`);
                    const updateData = {
                        status: newStatus,
                        updatedAt: Date.now(),
                        updatedBy: getCurrentEmployeeId()
                    };

                    bookingRef.update(updateData).then(() => {
                        Swal.fire('Thành công', `Đã cập nhật trạng thái đặt phòng thành "${statusText}"`, 'success');
                    }).catch((error) => {
                        console.error('Error updating booking status:', error);
                        Swal.fire('Lỗi', 'Không thể cập nhật trạng thái đặt phòng.', 'error');
                    });
                }
            });
        };
        
        // Xử lý form tạo lịch làm việc
        document.getElementById('createScheduleForm').onsubmit = function(e) {
            e.preventDefault();
            const date = document.getElementById('scheduleDate').value;
            const shift = document.getElementById('scheduleShift').value;
            const startTime = document.getElementById('scheduleStartTime').value;
            const endTime = document.getElementById('scheduleEndTime').value;

            if (!date || !shift || !startTime || !endTime) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }

            // Thêm lịch làm việc mới vào bảng
            const tableBody = document.getElementById('scheduleTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${new Date(date).toLocaleDateString('vi-VN')}</td>
                <td>${shift}</td>
                <td>${startTime}</td>
                <td>${endTime}</td>
                <td><span class="badge bg-info">Đã lên lịch</span></td>
            `;
            tableBody.appendChild(newRow);

            // Đóng modal và reset form
            bootstrap.Modal.getInstance(document.getElementById('createScheduleModal')).hide();
            this.reset();
            alert('Đã tạo lịch làm việc thành công!');
        };

        // Khởi tạo dữ liệu khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Staff Dashboard Initializing...');
            console.log('📤 All data operations will be sent to Firebase Realtime Database');
            console.log('🔐 Firebase Authentication required for all operations');
            
            // Kiểm tra authentication và load profile data
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    console.log('👤 User authenticated:', user.email);
                    
                    // Hiển thị thông báo chào mừng
                    showWelcomeMessage(user.email);
                    
                    // Load profile data ngay khi user đã đăng nhập
                    loadProfileData();
                    updateAttendanceChart('month');
                    
                    // Load các dữ liệu khác
                    loadTodayStatusMain();
                    loadLeaveHistory();
                    loadBookings();
                    
                    // Khởi tạo chấm công
                    updateCurrentTime();
                    setInterval(updateCurrentTime, 1000); // Cập nhật thời gian mỗi giây
                    loadTodayAttendanceStatus();
                    
                    // Thêm event listeners cho booking filters
                    const bookingStatusFilter = document.getElementById('bookingStatusFilter');
                    const bookingSearchInput = document.getElementById('bookingSearchInput');
                    if (bookingStatusFilter) bookingStatusFilter.addEventListener('change', filterAndDisplayBookings);
                    if (bookingSearchInput) bookingSearchInput.addEventListener('input', filterAndDisplayBookings);
                    
                    // Test load statistics khi trang load (để debug)
                    console.log('🧪 Testing statistics load on page load...');
                    setTimeout(() => {
                        loadStatisticsData();
                    }, 2000); // Load sau 2 giây để Firebase có thời gian khởi tạo
                } else {
                    console.log('❌ No user authenticated, redirecting to auth.html');
                    window.location.href = '../auth.html';
                }
            });
            
            // Thêm test function vào console để debug
            window.testLeaveRequest = function() {
                console.log('🧪 Testing leave request creation...');
                const testRequest = {
                    employeeId: 'NV001',
                    startDate: '2024-12-25',
                    endDate: '2024-12-25',
                    reason: 'Test nghỉ phép',
                    status: 'pending',
                    createdAt: Date.now(),
                    type: 'Nghỉ phép năm',
                    employeeName: 'Nguyễn Văn A'
                };
                
                firebase.database().ref('leaveRequests').push(testRequest).then((ref) => {
                    console.log('✅ Test request created with ID:', ref.key);
                    alert('Test request created successfully!');
                }).catch((error) => {
                    console.error('❌ Error creating test request:', error);
                    alert('Error creating test request: ' + error.message);
                });
            };
            
            // Test function để test stats manually
            window.testStatistics = function() {
                console.log('🧪 Testing statistics manually...');
                showSection('stats');
            };
            
            // Test function để test feedback manually
            window.testFeedback = function() {
                console.log('🧪 Testing feedback manually...');
                showSection('feedback');
            };
            
            // Test function để reload statistics
            window.reloadStats = function() {
                console.log('🔄 Reloading statistics...');
                loadStatisticsData();
            };
            
            // Test function để reload feedback
            window.reloadFeedback = function() {
                console.log('🔄 Reloading feedback...');
                loadFeedbackData();
            };
            
            // Debug function để xem tất cả bookings
            window.debugBookings = function() {
                console.log('🔍 Debugging all bookings...');
                console.log('📊 Total bookings loaded:', allBookings.length);
                console.log('📊 All bookings:', allBookings);
                console.log('📊 Booking IDs:', allBookings.map(b => b.id));
                console.log('📊 Booking types:', allBookings.map(b => ({ id: b.id, type: b.type, bookingType: b.bookingType })));
                
                // Hiển thị trong alert
                const bookingInfo = allBookings.map((b, index) => 
                    `${index + 1}. ID: ${b.id}, Type: ${b.type || 'N/A'}, BookingType: ${b.bookingType || 'N/A'}, Customer: ${b.customerName || 'N/A'}`
                ).join('\n');
                
                alert(`Tổng số bookings: ${allBookings.length}\n\n${bookingInfo}`);
            };
            
            // Function để reload bookings
            window.reloadBookings = function() {
                console.log('🔄 Reloading bookings...');
                loadBookings();
            };
            
            // Function để cleanup Firebase listeners
            window.cleanupListeners = function() {
                console.log('🧹 Cleaning up Firebase listeners...');
                try {
                    firebase.database().ref('bookings').off();
                    firebase.database().ref('reviews').off();
                    console.log('✅ Listeners cleaned up');
                } catch (error) {
                    console.error('❌ Error cleaning up listeners:', error);
                }
            };
            
            // Cleanup listeners when page unloads
            window.addEventListener('beforeunload', function() {
                cleanupListeners();
            });
            
            // Function để kiểm tra quyền Firebase
            window.checkFirebasePermissions = function() {
                console.log('🔍 Checking Firebase permissions...');
                
                // Kiểm tra user hiện tại
                const currentUser = firebase.auth().currentUser;
                console.log('👤 Current user:', currentUser);
                
                if (currentUser) {
                    console.log('📧 User email:', currentUser.email);
                    console.log('🆔 User UID:', currentUser.uid);
                    
                    // Test write permission cho guideComments
                    const testRef = firebase.database().ref('guideComments/test-permission');
                    testRef.set({
                        test: true,
                        timestamp: Date.now()
                    }).then(() => {
                        console.log('✅ Write permission test: SUCCESS');
                        // Xóa test data
                        testRef.remove();
                    }).catch((error) => {
                        console.error('❌ Write permission test: FAILED', error);
                    });
                } else {
                    console.log('❌ No user logged in');
                }
            };
            
            // Function để test permission cho specific feedback
            window.testFeedbackPermission = function(type, id, guideId = '') {
                console.log('🧪 Testing permission for:', { type, id, guideId });
                
                let testRef;
                if (type === 'guide_comment') {
                    testRef = firebase.database().ref(`guideComments/${guideId}/${id}/processed`);
                } else if (type === 'guide_rating') {
                    testRef = firebase.database().ref(`guideRatings/${guideId}/${id}/processed`);
                } else if (type === 'review') {
                    testRef = firebase.database().ref(`reviews/${id}/processed`);
                }
                
                if (testRef) {
                    testRef.set(true).then(() => {
                        console.log('✅ Permission test: SUCCESS');
                        // Revert the change
                        testRef.remove();
                    }).catch((error) => {
                        console.error('❌ Permission test: FAILED', error);
                    });
                }
            };
            
            // Function để theo dõi hoạt động Firebase
            window.monitorFirebaseActivity = function() {
                console.log('📊 Monitoring Firebase activity...');
                
                // Theo dõi tất cả write operations
                const originalUpdate = firebase.database().ref().update;
                firebase.database().ref().update = function(data) {
                    console.log('📤 Firebase UPDATE operation:', {
                        timestamp: new Date().toISOString(),
                        data: data,
                        path: this.toString()
                    });
                    return originalUpdate.call(this, data);
                };
                
                // Theo dõi tất cả set operations
                const originalSet = firebase.database().ref().set;
                firebase.database().ref().set = function(data) {
                    console.log('📤 Firebase SET operation:', {
                        timestamp: new Date().toISOString(),
                        data: data,
                        path: this.toString()
                    });
                    return originalSet.call(this, data);
                };
                
                console.log('✅ Firebase monitoring enabled');
            };
            
            // Function để xem log Firebase operations
            window.showFirebaseLogs = function() {
                console.log('📋 Firebase Operations Log:');
                console.log('🔄 All data is sent to Firebase Realtime Database');
                console.log('📊 No data is stored locally or sent elsewhere');
                console.log('🔐 All operations require Firebase authentication');
                console.log('📝 All changes are logged in Firebase Console');
            };
            
            // === CHỨC NĂNG HỒ SƠ CÁ NHÂN ===
            
            // Load thông tin profile từ Firebase
            window.loadProfileData = async function() {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) return;
                
                console.log('📋 Loading profile data for:', currentUser.email);
                
                try {
                    // Load từ staff database
                    const snapshot = await firebase.database().ref('staff').once('value');
                    const staffData = snapshot.val();
                    
                    if (staffData) {
                        let found = false;
                        for (let staffId in staffData) {
                            const staff = staffData[staffId];
                            const staffEmail = staff.email;
                            console.log('🔍 Checking staff:', staffEmail, 'vs current:', currentUser.email);
                            
                            if (staffEmail === currentUser.email) {
                                console.log('✅ Found matching staff record:', staffId);
                                await updateProfileDisplay(staff);
                                loadProfileStatistics(staffId);
                                loadRecentActivity(staffId);
                                found = true;
                                break;
                            }
                        }
                        
                        if (!found) {
                            console.log('📭 No matching staff record found for:', currentUser.email);
                            console.log('📋 Available staff emails:', Object.values(staffData).map(s => s.email));
                            
                            // Fallback to current user info
                            await updateProfileDisplay({
                                name: currentUser.displayName || 'Chưa cập nhật',
                                email: currentUser.email,
                                role: 'Nhân viên',
                                employeeId: currentUser.uid.substring(0, 8),
                                startDate: 'Chưa cập nhật',
                                department: 'Chưa cập nhật'
                            });
                            loadProfileStatistics(currentUser.uid);
                            loadRecentActivity(currentUser.uid);
                        }
                    } else {
                        console.log('📭 No staff data found, using current user info');
                        // Fallback to current user info
                        await updateProfileDisplay({
                            name: currentUser.displayName || 'Chưa cập nhật',
                            email: currentUser.email,
                            role: 'Nhân viên',
                            employeeId: currentUser.uid.substring(0, 8),
                            startDate: 'Chưa cập nhật',
                            department: 'Chưa cập nhật'
                        });
                        loadProfileStatistics(currentUser.uid);
                        loadRecentActivity(currentUser.uid);
                    }
                } catch (error) {
                    console.error('❌ Error loading profile data:', error);
                    // Fallback to current user info
                    await updateProfileDisplay({
                        name: currentUser.displayName || 'Chưa cập nhật',
                        email: currentUser.email,
                        role: 'Nhân viên',
                        employeeId: currentUser.uid.substring(0, 8),
                        startDate: 'Chưa cập nhật',
                        department: 'Chưa cập nhật'
                    });
                    loadProfileStatistics(currentUser.uid);
                    loadRecentActivity(currentUser.uid);
                }
            };
            
            // Load role name từ database
            window.loadRoleName = function(roleCode) {
                return new Promise((resolve) => {
                    if (!roleCode) {
                        resolve('Chưa cập nhật');
                        return;
                    }
                    
                    firebase.database().ref('roles').once('value').then((snapshot) => {
                        const rolesData = snapshot.val();
                        if (rolesData) {
                            for (let roleId in rolesData) {
                                const role = rolesData[roleId];
                                if (role.code === roleCode) {
                                    console.log('✅ Found role:', role.name, 'for code:', roleCode);
                                    resolve(role.name);
                                    return;
                                }
                            }
                        }
                        console.log('📭 No role found for code:', roleCode);
                        resolve(roleCode); // Fallback to code if not found
                    }).catch((error) => {
                        console.error('❌ Error loading role:', error);
                        resolve(roleCode); // Fallback to code if error
                    });
                });
            };
            
            // Load department name từ database
            window.loadDepartmentName = function(departmentCode) {
                return new Promise((resolve) => {
                    if (!departmentCode) {
                        resolve('Chưa cập nhật');
                        return;
                    }
                    
                    // Map department codes to names based on roles data
                    const departmentMap = {
                        '01': 'Lễ tân (Front Desk)',
                        'Tuân thủ pháp lý': 'Tuân thủ pháp lý',
                        'Quản lý đối tác': 'Quản lý đối tác',
                        'Kiểm duyệt đặt phòng': 'Kiểm duyệt đặt phòng',
                        'Quản lý nội dung': 'Quản lý nội dung',
                        'Hỗ trợ khách hàng': 'Hỗ trợ khách hàng',
                        'Phân tích dữ liệu': 'Phân tích dữ liệu',
                        'Quản lý tài chính': 'Quản lý tài chính',
                        'KD01': 'Kiểm duyệt đặt phòng',
                        'nhân viên': 'Nhân viên'
                    };
                    
                    const departmentName = departmentMap[departmentCode] || departmentCode;
                    console.log('✅ Department mapped:', departmentCode, '→', departmentName);
                    resolve(departmentName);
                });
            };
            
            // Cập nhật hiển thị profile với role và department thực tế
            window.updateProfileDisplay = async function(staffData) {
                console.log('📋 Updating profile display with data:', staffData);
                
                // Cập nhật thông tin cơ bản
                document.getElementById('profile-name').textContent = staffData.name || 'Chưa cập nhật';
                document.getElementById('profile-email').textContent = staffData.email || 'Chưa cập nhật';
                document.getElementById('profile-id').textContent = staffData.employeeId || 'Chưa cập nhật';
                document.getElementById('profile-start-date').textContent = staffData.startDate || 'Chưa cập nhật';
                
                // Load role name từ database
                const roleName = await loadRoleName(staffData.role);
                document.getElementById('profile-position').textContent = roleName;
                
                // Load department name từ database
                const departmentName = await loadDepartmentName(staffData.department);
                document.getElementById('profile-department').textContent = departmentName;
                
                // Cập nhật thông tin khẩn cấp
                if (staffData.emergencyContact) {
                    document.getElementById('emergency-contact').textContent = staffData.emergencyContact;
                }
                if (staffData.emergencyPhone) {
                    document.getElementById('emergency-phone').textContent = staffData.emergencyPhone;
                }
                if (staffData.address) {
                    document.getElementById('emergency-address').textContent = staffData.address;
                }
                
                // Log thông tin đã cập nhật
                console.log('✅ Profile updated:', {
                    name: staffData.name,
                    email: staffData.email,
                    role: roleName,
                    employeeId: staffData.employeeId,
                    department: departmentName,
                    startDate: staffData.startDate
                });
            };
            
            // Load thống kê profile
            window.loadProfileStatistics = function(staffId) {
                console.log('📊 Loading profile statistics for:', staffId);
                
                // Load attendance data
                firebase.database().ref('attendance').child(staffId).once('value').then((snapshot) => {
                    const attendanceData = snapshot.val();
                    if (attendanceData) {
                        calculateWorkStatistics(attendanceData);
                    } else {
                        console.log('📭 No attendance data found for:', staffId);
                        // Set default values
                        document.getElementById('total-work-hours').textContent = '0';
                        document.getElementById('work-days').textContent = '0';
                    }
                }).catch((error) => {
                    console.error('❌ Error loading attendance data:', error);
                    document.getElementById('total-work-hours').textContent = '0';
                    document.getElementById('work-days').textContent = '0';
                });
                
                // Load leave data
                firebase.database().ref('leaveRequests').orderByChild('employeeId').equalTo(staffId).once('value').then((snapshot) => {
                    const leaveData = snapshot.val();
                    if (leaveData) {
                        calculateLeaveStatistics(leaveData);
                    } else {
                        console.log('📭 No leave data found for:', staffId);
                        // Set default values
                        document.getElementById('remaining-leave').textContent = '15 ngày';
                        document.getElementById('used-leave').textContent = '0 ngày';
                        document.getElementById('sick-leave').textContent = '0 ngày';
                        document.getElementById('total-leave').textContent = '15 ngày';
                    }
                }).catch((error) => {
                    console.error('❌ Error loading leave data:', error);
                    document.getElementById('remaining-leave').textContent = '15 ngày';
                    document.getElementById('used-leave').textContent = '0 ngày';
                    document.getElementById('sick-leave').textContent = '0 ngày';
                    document.getElementById('total-leave').textContent = '15 ngày';
                });
                
                // Load performance data
                firebase.database().ref('performance').child(staffId).once('value').then((snapshot) => {
                    const performanceData = snapshot.val();
                    if (performanceData) {
                        updatePerformanceDisplay(performanceData);
                    } else {
                        console.log('📭 No performance data found for:', staffId);
                        // Set default values
                        updatePerformanceDisplay({});
                    }
                }).catch((error) => {
                    console.error('❌ Error loading performance data:', error);
                    updatePerformanceDisplay({});
                });
                
                // Load feedback processing data
                loadFeedbackProcessingStats(staffId);
                
                // Load customer service stats
                loadCustomerServiceStats(staffId);
            };
            
            // Tính toán thống kê làm việc
            window.calculateWorkStatistics = function(attendanceData) {
                let totalHours = 0;
                let workDays = 0;
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                Object.values(attendanceData).forEach(record => {
                    const recordDate = new Date(record.date);
                    if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                        workDays++;
                        if (record.checkIn && record.checkOut) {
                            const checkIn = new Date(record.checkIn);
                            const checkOut = new Date(record.checkOut);
                            const hours = (checkOut - checkIn) / (1000 * 60 * 60);
                            totalHours += hours;
                        }
                    }
                });
                
                document.getElementById('total-work-hours').textContent = Math.round(totalHours);
                document.getElementById('work-days').textContent = workDays;
            };
            
            // Tính toán thống kê nghỉ phép
            window.calculateLeaveStatistics = function(leaveData) {
                let usedLeave = 0;
                let sickLeave = 0;
                const totalLeave = 15; // Mặc định 15 ngày phép năm
                
                Object.values(leaveData).forEach(record => {
                    if (record.status === 'approved') {
                        if (record.type === 'Nghỉ ốm') {
                            sickLeave++;
                        } else {
                            usedLeave++;
                        }
                    }
                });
                
                const remainingLeave = totalLeave - usedLeave - sickLeave;
                
                document.getElementById('remaining-leave').textContent = remainingLeave + ' ngày';
                document.getElementById('used-leave').textContent = usedLeave + ' ngày';
                document.getElementById('sick-leave').textContent = sickLeave + ' ngày';
                document.getElementById('total-leave').textContent = totalLeave + ' ngày';
            };
            
            // Cập nhật hiển thị hiệu suất
            window.updatePerformanceDisplay = function(performanceData) {
                document.getElementById('performance-score').textContent = (performanceData.score || 0) + '%';
                document.getElementById('rating-score').textContent = (performanceData.rating || 0).toFixed(1);
                document.getElementById('customers-served').textContent = performanceData.customersServed || 0;
                document.getElementById('good-reviews').textContent = performanceData.goodReviews || 0;
                document.getElementById('feedback-processed').textContent = performanceData.feedbackProcessed || 0;
                document.getElementById('avg-rating').textContent = (performanceData.avgRating || 0).toFixed(1);
            };
            
            // Load hoạt động gần đây
            window.loadRecentActivity = function(staffId) {
                console.log('📋 Loading recent activity for:', staffId);
                
                const timeline = document.getElementById('activity-timeline');
                timeline.innerHTML = '<div class="text-center text-muted">Đang tải hoạt động...</div>';
                
                // Load từ nhiều nguồn dữ liệu
                Promise.all([
                    firebase.database().ref('attendance').child(staffId).limitToLast(5).once('value'),
                    firebase.database().ref('leaveRequests').orderByChild('employeeId').equalTo(staffId).limitToLast(3).once('value'),
                    firebase.database().ref('reviews').orderByChild('processedBy').equalTo(staffId).limitToLast(3).once('value'),
                    firebase.database().ref('bookings').orderByChild('processedBy').equalTo(staffId).limitToLast(3).once('value')
                ]).then(([attendanceSnapshot, leaveSnapshot, reviewsSnapshot, bookingsSnapshot]) => {
                    const activities = [];
                    
                    // Thêm hoạt động chấm công
                    if (attendanceSnapshot.val()) {
                        Object.entries(attendanceSnapshot.val()).forEach(([key, record]) => {
                            activities.push({
                                type: 'attendance',
                                time: record.date || record.timestamp,
                                title: 'Chấm công',
                                description: `Check-in: ${record.checkIn || '--:--'}, Check-out: ${record.checkOut || '--:--'}`,
                                icon: 'fas fa-clock',
                                color: 'primary'
                            });
                        });
                    }
                    
                    // Thêm hoạt động nghỉ phép
                    if (leaveSnapshot.val()) {
                        Object.entries(leaveSnapshot.val()).forEach(([key, record]) => {
                            activities.push({
                                type: 'leave',
                                time: record.createdAt,
                                title: 'Xin nghỉ phép',
                                description: `${record.type}: ${record.reason}`,
                                icon: 'fas fa-calendar',
                                color: 'warning'
                            });
                        });
                    }
                    
                    // Thêm hoạt động xử lý feedback
                    if (reviewsSnapshot.val()) {
                        Object.entries(reviewsSnapshot.val()).forEach(([key, record]) => {
                            if (record.processed) {
                                activities.push({
                                    type: 'feedback',
                                    time: record.processedAt,
                                    title: 'Xử lý phản hồi',
                                    description: `Đã xử lý phản hồi từ ${record.userName || 'khách hàng'}`,
                                    icon: 'fas fa-comment',
                                    color: 'success'
                                });
                            }
                        });
                    }
                    
                    // Thêm hoạt động xử lý booking
                    if (bookingsSnapshot.val()) {
                        Object.entries(bookingsSnapshot.val()).forEach(([key, record]) => {
                            if (record.processedBy === staffId) {
                                activities.push({
                                    type: 'booking',
                                    time: record.processedAt || record.createdAt,
                                    title: 'Xử lý đặt phòng',
                                    description: `Đã xử lý đặt phòng cho ${record.customerName || 'khách hàng'}`,
                                    icon: 'fas fa-bed',
                                    color: 'info'
                                });
                            }
                        });
                    }
                    
                    // Sắp xếp theo thời gian
                    activities.sort((a, b) => b.time - a.time);
                    
                    // Hiển thị timeline
                    renderActivityTimeline(activities.slice(0, 10));
                }).catch((error) => {
                    console.error('❌ Error loading recent activity:', error);
                    timeline.innerHTML = '<div class="text-center text-muted">Không thể tải hoạt động</div>';
                });
            };
            
            // Render activity timeline
            window.renderActivityTimeline = function(activities) {
                const timeline = document.getElementById('activity-timeline');
                
                if (activities.length === 0) {
                    timeline.innerHTML = '<div class="text-center text-muted">Chưa có hoạt động nào</div>';
                    return;
                }
                
                timeline.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon bg-${activity.color} text-white">
                            <i class="${activity.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="fw-bold">${activity.title}</div>
                            <div class="text-muted">${activity.description}</div>
                            <div class="activity-time">${formatTime(activity.time)}</div>
                        </div>
                    </div>
                `).join('');
            };
            
            // Format thời gian
            window.formatTime = function(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor(diff / (1000 * 60));
                
                if (days > 0) return `${days} ngày trước`;
                if (hours > 0) return `${hours} giờ trước`;
                if (minutes > 0) return `${minutes} phút trước`;
                return 'Vừa xong';
            };
            
            // Chỉnh sửa profile
            window.editProfile = function() {
                Swal.fire({
                    title: 'Chỉnh sửa thông tin cá nhân',
                    html: `
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Họ và tên</label>
                                <input type="text" id="edit-name" class="form-control" value="${document.getElementById('profile-name').textContent}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" id="edit-email" class="form-control" value="${document.getElementById('profile-email').textContent}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" id="edit-phone" class="form-control" value="">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Địa chỉ</label>
                                <input type="text" id="edit-address" class="form-control" value="">
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu thay đổi',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const name = document.getElementById('edit-name').value;
                        const email = document.getElementById('edit-email').value;
                        const phone = document.getElementById('edit-phone').value;
                        const address = document.getElementById('edit-address').value;
                        
                        if (!name || !email) {
                            Swal.showValidationMessage('Vui lòng điền đầy đủ thông tin bắt buộc');
                            return false;
                        }
                        
                        return { name, email, phone, address };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        updateProfileInFirebase(result.value);
                    }
                });
            };
            
            // Cập nhật profile trong Firebase
            window.updateProfileInFirebase = function(profileData) {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) return;
                
                firebase.database().ref('staff').once('value').then((snapshot) => {
                    const staffData = snapshot.val();
                    if (staffData) {
                        for (let staffId in staffData) {
                            const staff = staffData[staffId];
                            const staffEmail = staff.email || staff.êmmail || staff['êmmail'];
                            if (staffEmail === currentUser.email) {
                                // Cập nhật thông tin
                                firebase.database().ref(`staff/${staffId}`).update({
                                    name: profileData.name,
                                    email: profileData.email,
                                    phone: profileData.phone,
                                    address: profileData.address,
                                    updatedAt: Date.now()
                                }).then(() => {
                                    Swal.fire('Thành công', 'Đã cập nhật thông tin cá nhân', 'success');
                                    loadProfileData();
                                }).catch((error) => {
                                    console.error('❌ Error updating profile:', error);
                                    Swal.fire('Lỗi', 'Không thể cập nhật thông tin', 'error');
                                });
                                break;
                            }
                        }
                    } else {
                        // Tạo staff record mới nếu chưa có
                        const newStaffId = firebase.database().ref('staff').push().key;
                        firebase.database().ref(`staff/${newStaffId}`).set({
                            name: profileData.name,
                            email: profileData.email,
                            phone: profileData.phone,
                            address: profileData.address,
                            role: 'Nhân viên',
                            employeeId: currentUser.uid.substring(0, 8),
                            startDate: new Date().toISOString().split('T')[0],
                            department: 'Chưa phân công',
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        }).then(() => {
                            Swal.fire('Thành công', 'Đã tạo và cập nhật thông tin cá nhân', 'success');
                            loadProfileData();
                        }).catch((error) => {
                            console.error('❌ Error creating staff profile:', error);
                            Swal.fire('Lỗi', 'Không thể tạo thông tin', 'error');
                        });
                    }
                });
            };
            
            // Test với nhân viên Thạch Văn Bảo (NV1)
            window.testWithBaoStaff = async function() {
                console.log('🧪 Testing with Thạch Văn Bảo (NV1)...');
                
                try {
                    // Load staff data với email cụ thể
                    const snapshot = await firebase.database().ref('staff').once('value');
                    const staffData = snapshot.val();
                    
                    if (staffData) {
                        for (let staffId in staffData) {
                            const staff = staffData[staffId];
                            if (staff.email === 'bao221330@student.nctu.edu.vn') {
                                console.log('✅ Found Thạch Văn Bảo staff record:', staff);
                                await updateProfileDisplay(staff);
                                loadProfileStatistics(staffId);
                                loadRecentActivity(staffId);
                                
                                Swal.fire({
                                    title: 'Thành công!',
                                    html: `
                                        <div class="text-start">
                                            <h6>Đã load dữ liệu cho:</h6>
                                            <p><strong>Tên:</strong> ${staff.name}</p>
                                            <p><strong>Email:</strong> ${staff.email}</p>
                                            <p><strong>Role:</strong> ${staff.role} (NV1)</p>
                                            <p><strong>Department:</strong> ${staff.department}</p>
                                            <p><strong>Lương:</strong> ${staff.basicSalary ? staff.basicSalary.toLocaleString('vi-VN') + ' ₫' : 'Chưa cập nhật'}</p>
                                            <p><strong>Trạng thái:</strong> ${staff.status}</p>
                                        </div>
                                    `,
                                    icon: 'success',
                                    confirmButtonText: 'Xem chi tiết',
                                    showCancelButton: true,
                                    cancelButtonText: 'Đóng'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        viewFullProfile();
                                    }
                                });
                                return;
                            }
                        }
                    }
                    Swal.fire('Lỗi', 'Không tìm thấy hồ sơ Thạch Văn Bảo', 'error');
                } catch (error) {
                    console.error('❌ Error testing with Thạch Văn Bảo:', error);
                    Swal.fire('Lỗi', 'Không thể load dữ liệu Thạch Văn Bảo', 'error');
                }
            };
            
            // Cập nhật thời gian hiện tại
            function updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateString = now.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                document.getElementById('current-time').textContent = timeString;
                document.getElementById('current-date').textContent = dateString;
            }
            
            // Chấm công vào
            window.checkIn = async function() {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    Swal.fire('Lỗi', 'Vui lòng đăng nhập để chấm công', 'error');
                    return;
                }
                
                try {
                    const now = new Date();
                    const today = now.toISOString().split('T')[0];
                    const timeString = now.toLocaleTimeString('vi-VN');
                    
                    // Tìm staff ID
                    const staffSnapshot = await firebase.database().ref('staff').once('value');
                    const staffData = staffSnapshot.val();
                    let staffId = null;
                    
                    for (let id in staffData) {
                        if (staffData[id].email === currentUser.email) {
                            staffId = id;
                            break;
                        }
                    }
                    
                    if (!staffId) {
                        Swal.fire('Lỗi', 'Không tìm thấy hồ sơ nhân viên', 'error');
                        return;
                    }
                    
                    // Kiểm tra đã chấm công vào chưa
                    const attendanceRef = firebase.database().ref(`attendance/${staffId}/${today}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    
                    if (attendanceSnapshot.exists() && attendanceSnapshot.val().checkIn) {
                        Swal.fire('Thông báo', 'Bạn đã chấm công vào hôm nay rồi!', 'info');
                        return;
                    }
                    
                    // Lưu chấm công vào
                    await attendanceRef.update({
                        checkIn: timeString,
                        checkInTimestamp: now.getTime(),
                        date: today,
                        employeeId: staffId,
                        employeeName: staffData[staffId].name
                    });
                    
                    // Cập nhật UI
                    document.getElementById('today-attendance-status').textContent = `Đã chấm công vào: ${timeString}`;
                    document.getElementById('today-attendance-status').className = 'checked-in';
                    document.getElementById('checkin-btn').disabled = true;
                    document.getElementById('checkin-btn').innerHTML = '<i class="fas fa-check"></i> Đã chấm công vào';
                    
                    Swal.fire('Thành công!', `Đã chấm công vào lúc ${timeString}`, 'success');
                    
                } catch (error) {
                    console.error('❌ Error checking in:', error);
                    
                    if (error.message.includes('PERMISSION_DENIED')) {
                        Swal.fire({
                            title: 'Lỗi quyền truy cập',
                            html: `
                                <div class="text-start">
                                    <p>Không thể chấm công do lỗi quyền truy cập Firebase.</p>
                                    <p><strong>Nguyên nhân:</strong> Chưa deploy Firebase Security Rules cho attendance.</p>
                                    <p><strong>Giải pháp:</strong></p>
                                    <ol>
                                        <li>Vào Firebase Console</li>
                                        <li>Realtime Database → Rules</li>
                                        <li>Deploy rules từ file firebase-security-rules.json</li>
                                    </ol>
                                </div>
                            `,
                            icon: 'warning',
                            confirmButtonText: 'Đã hiểu'
                        });
                    } else {
                        Swal.fire('Lỗi', 'Không thể chấm công: ' + error.message, 'error');
                    }
                }
            };
            
            // Chấm công ra
            window.checkOut = async function() {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    Swal.fire('Lỗi', 'Vui lòng đăng nhập để chấm công', 'error');
                    return;
                }
                
                try {
                    const now = new Date();
                    const today = now.toISOString().split('T')[0];
                    const timeString = now.toLocaleTimeString('vi-VN');
                    
                    // Tìm staff ID
                    const staffSnapshot = await firebase.database().ref('staff').once('value');
                    const staffData = staffSnapshot.val();
                    let staffId = null;
                    
                    for (let id in staffData) {
                        if (staffData[id].email === currentUser.email) {
                            staffId = id;
                            break;
                        }
                    }
                    
                    if (!staffId) {
                        Swal.fire('Lỗi', 'Không tìm thấy hồ sơ nhân viên', 'error');
                        return;
                    }
                    
                    // Kiểm tra đã chấm công vào chưa
                    const attendanceRef = firebase.database().ref(`attendance/${staffId}/${today}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    
                    if (!attendanceSnapshot.exists() || !attendanceSnapshot.val().checkIn) {
                        Swal.fire('Thông báo', 'Bạn chưa chấm công vào hôm nay!', 'warning');
                        return;
                    }
                    
                    if (attendanceSnapshot.val().checkOut) {
                        Swal.fire('Thông báo', 'Bạn đã chấm công ra hôm nay rồi!', 'info');
                        return;
                    }
                    
                    // Tính giờ làm việc
                    const checkInTime = new Date(attendanceSnapshot.val().checkInTimestamp);
                    const workHours = ((now.getTime() - checkInTime.getTime()) / (1000 * 60 * 60)).toFixed(2);
                    
                    // Lưu chấm công ra
                    await attendanceRef.update({
                        checkOut: timeString,
                        checkOutTimestamp: now.getTime(),
                        workHours: parseFloat(workHours),
                        totalHours: parseFloat(workHours)
                    });
                    
                    // Cập nhật UI
                    document.getElementById('today-attendance-status').textContent = `Đã chấm công ra: ${timeString} (${workHours}h)`;
                    document.getElementById('today-attendance-status').className = 'checked-out';
                    document.getElementById('checkout-btn').disabled = true;
                    document.getElementById('checkout-btn').innerHTML = '<i class="fas fa-check"></i> Đã chấm công ra';
                    
                    Swal.fire('Thành công!', `Đã chấm công ra lúc ${timeString}\nTổng giờ làm: ${workHours} giờ`, 'success');
                    
                } catch (error) {
                    console.error('❌ Error checking out:', error);
                    
                    if (error.message.includes('PERMISSION_DENIED')) {
                        Swal.fire({
                            title: 'Lỗi quyền truy cập',
                            html: `
                                <div class="text-start">
                                    <p>Không thể chấm công do lỗi quyền truy cập Firebase.</p>
                                    <p><strong>Nguyên nhân:</strong> Chưa deploy Firebase Security Rules cho attendance.</p>
                                    <p><strong>Giải pháp:</strong></p>
                                    <ol>
                                        <li>Vào Firebase Console</li>
                                        <li>Realtime Database → Rules</li>
                                        <li>Deploy rules từ file firebase-security-rules.json</li>
                                    </ol>
                                </div>
                            `,
                            icon: 'warning',
                            confirmButtonText: 'Đã hiểu'
                        });
                    } else {
                        Swal.fire('Lỗi', 'Không thể chấm công: ' + error.message, 'error');
                    }
                }
            };
            
            // Xem lịch sử chấm công
            window.viewAttendanceHistory = async function() {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    Swal.fire('Lỗi', 'Vui lòng đăng nhập để xem lịch sử', 'error');
                    return;
                }
                
                try {
                    // Tìm staff ID
                    const staffSnapshot = await firebase.database().ref('staff').once('value');
                    const staffData = staffSnapshot.val();
                    let staffId = null;
                    
                    for (let id in staffData) {
                        if (staffData[id].email === currentUser.email) {
                            staffId = id;
                            break;
                        }
                    }
                    
                    if (!staffId) {
                        Swal.fire('Lỗi', 'Không tìm thấy hồ sơ nhân viên', 'error');
                        return;
                    }
                    
                    // Load lịch sử chấm công
                    const attendanceSnapshot = await firebase.database().ref(`attendance/${staffId}`).once('value');
                    const attendanceData = attendanceSnapshot.val();
                    
                    if (!attendanceData) {
                        Swal.fire('Thông báo', 'Chưa có lịch sử chấm công', 'info');
                        return;
                    }
                    
                    // Tạo HTML cho lịch sử
                    let html = '<div class="text-start"><h6>Lịch sử chấm công (30 ngày gần nhất):</h6><div style="max-height: 400px; overflow-y: auto;">';
                    
                    const dates = Object.keys(attendanceData).sort().reverse().slice(0, 30);
                    
                    dates.forEach(date => {
                        const record = attendanceData[date];
                        const dateObj = new Date(date);
                        const formattedDate = dateObj.toLocaleDateString('vi-VN', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        
                        html += `
                            <div class="border-bottom p-2">
                                <strong>${formattedDate}</strong><br>
                                <small class="text-muted">
                                    Vào: ${record.checkIn || 'Chưa chấm công'} | 
                                    Ra: ${record.checkOut || 'Chưa chấm công'} | 
                                    Giờ làm: ${record.workHours ? record.workHours + 'h' : 'N/A'}
                                </small>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                    
                    Swal.fire({
                        title: 'Lịch sử chấm công',
                        html: html,
                        width: '600px',
                        confirmButtonText: 'Đóng'
                    });
                    
                } catch (error) {
                    console.error('❌ Error viewing attendance history:', error);
                    Swal.fire('Lỗi', 'Không thể xem lịch sử: ' + error.message, 'error');
                }
            };
            
            // Load trạng thái chấm công hôm nay
            window.loadTodayAttendanceStatus = async function() {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) return;
                
                try {
                    // Tìm staff ID
                    const staffSnapshot = await firebase.database().ref('staff').once('value');
                    const staffData = staffSnapshot.val();
                    let staffId = null;
                    
                    for (let id in staffData) {
                        if (staffData[id].email === currentUser.email) {
                            staffId = id;
                            break;
                        }
                    }
                    
                    if (!staffId) return;
                    
                    const today = new Date().toISOString().split('T')[0];
                    const attendanceRef = firebase.database().ref(`attendance/${staffId}/${today}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    
                    if (attendanceSnapshot.exists()) {
                        const record = attendanceSnapshot.val();
                        
                        if (record.checkIn && record.checkOut) {
                            // Đã chấm công đầy đủ
                            document.getElementById('today-attendance-status').textContent = 
                                `Đã chấm công đầy đủ (${record.workHours}h)`;
                            document.getElementById('today-attendance-status').className = 'checked-out';
                            document.getElementById('checkin-btn').disabled = true;
                            document.getElementById('checkout-btn').disabled = true;
                            document.getElementById('checkin-btn').innerHTML = '<i class="fas fa-check"></i> Đã chấm công vào';
                            document.getElementById('checkout-btn').innerHTML = '<i class="fas fa-check"></i> Đã chấm công ra';
                        } else if (record.checkIn) {
                            // Chỉ chấm công vào
                            document.getElementById('today-attendance-status').textContent = 
                                `Đã chấm công vào: ${record.checkIn}`;
                            document.getElementById('today-attendance-status').className = 'checked-in';
                            document.getElementById('checkin-btn').disabled = true;
                            document.getElementById('checkin-btn').innerHTML = '<i class="fas fa-check"></i> Đã chấm công vào';
                        }
                    }
                    
                } catch (error) {
                    console.error('❌ Error loading today attendance status:', error);
                }
            };
            
            // Hiển thị thông báo chào mừng khi nhân viên đăng nhập
            window.showWelcomeMessage = async function(userEmail) {
                try {
                    const snapshot = await firebase.database().ref('staff').once('value');
                    const staffData = snapshot.val();
                    
                    if (staffData) {
                        for (let staffId in staffData) {
                            const staff = staffData[staffId];
                            if (staff.email === userEmail) {
                                Swal.fire({
                                    title: 'Chào mừng!',
                                    html: `
                                        <div class="text-start">
                                            <h6>Đăng nhập thành công</h6>
                                            <p><strong>Xin chào:</strong> ${staff.name}</p>
                                            <p><strong>Chức vụ:</strong> ${staff.role}</p>
                                            <p><strong>Phòng ban:</strong> ${staff.department}</p>
                                            <p><strong>Trạng thái:</strong> <span class="badge ${staff.status === 'active' ? 'bg-success' : 'bg-warning'}">${staff.status === 'active' ? 'Đang làm việc' : 'Tạm nghỉ'}</span></p>
                                        </div>
                                    `,
                                    icon: 'success',
                                    confirmButtonText: 'Bắt đầu làm việc',
                                    timer: 3000,
                                    timerProgressBar: true
                                });
                                return;
                            }
                        }
                    }
                } catch (error) {
                    console.error('❌ Error showing welcome message:', error);
                }
            };
            
            // Xem trước báo cáo thống kê nhân viên
            window.previewStaffReport = async function() {
                console.log('📊 Previewing personal staff report...');
                
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    Swal.fire('Lỗi', 'Vui lòng đăng nhập để xem báo cáo', 'error');
                    return;
                }
                
                try {
                    // Load dữ liệu từ Firebase
                    const [staffSnapshot, rolesSnapshot, attendanceSnapshot, leaveSnapshot, performanceSnapshot] = await Promise.all([
                        firebase.database().ref('staff').once('value'),
                        firebase.database().ref('roles').once('value'),
                        firebase.database().ref('attendance').once('value'),
                        firebase.database().ref('leaveRequests').once('value'),
                        firebase.database().ref('performance').once('value')
                    ]);
                    
                    const staffData = staffSnapshot.val();
                    const rolesData = rolesSnapshot.val();
                    const attendanceData = attendanceSnapshot.val();
                    const leaveData = leaveSnapshot.val();
                    const performanceData = performanceSnapshot.val();
                    
                    if (!staffData) {
                        Swal.fire('Lỗi', 'Không có dữ liệu nhân viên', 'error');
                        return;
                    }
                    
                    // Tìm nhân viên hiện tại
                    let currentStaff = null;
                    let currentStaffId = null;
                    
                    for (let staffId in staffData) {
                        const staff = staffData[staffId];
                        if (staff.email === currentUser.email) {
                            currentStaff = staff;
                            currentStaffId = staffId;
                            break;
                        }
                    }
                    
                    if (!currentStaff) {
                        Swal.fire('Lỗi', 'Không tìm thấy hồ sơ nhân viên', 'error');
                        return;
                    }
                    
                    // Tạo map role code -> role name
                    const roleCodeToName = {};
                    if (rolesData) {
                        Object.values(rolesData).forEach(role => {
                            if (role.code && role.name) {
                                roleCodeToName[role.code] = role.name;
                            }
                        });
                    }
                    
                    // Tính toán thống kê cá nhân
                    let workHours = 0;
                    let leaveDays = 0;
                    let performanceScore = 0;
                    let totalWorkDays = 0;
                    
                    // Tính giờ làm việc
                    if (attendanceData && attendanceData[currentStaffId]) {
                        const attendance = attendanceData[currentStaffId];
                        for (let date in attendance) {
                            if (attendance[date].hours) {
                                workHours += attendance[date].hours;
                                totalWorkDays++;
                            }
                        }
                    }
                    
                    // Tính ngày nghỉ phép
                    if (leaveData) {
                        for (let leaveId in leaveData) {
                            const leave = leaveData[leaveId];
                            if (leave.employeeId === currentStaffId && leave.status === 'approved') {
                                const start = new Date(leave.startDate);
                                const end = new Date(leave.endDate);
                                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                                leaveDays += days;
                            }
                        }
                    }
                    
                    // Tính điểm hiệu suất
                    if (performanceData && performanceData[currentStaffId]) {
                        performanceScore = performanceData[currentStaffId].score || 0;
                    }
                    
                    // Tạo HTML cho preview
                    let html = `
                        <div class="text-start">
                            <h6>👤 Thông tin cá nhân</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Họ tên:</strong> ${currentStaff.name}</p>
                                    <p><strong>Email:</strong> ${currentStaff.email}</p>
                                    <p><strong>Mã nhân viên:</strong> ${currentStaff.employeeId}</p>
                                    <p><strong>Số điện thoại:</strong> ${currentStaff.phone || 'Chưa cập nhật'}</p>
                                    <p><strong>Ngày sinh:</strong> ${currentStaff.birthDate || 'Chưa cập nhật'}</p>
                                    <p><strong>Giới tính:</strong> ${currentStaff.gender || 'Chưa cập nhật'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Chức vụ:</strong> ${roleCodeToName[currentStaff.role] || currentStaff.role}</p>
                                    <p><strong>Phòng ban:</strong> ${currentStaff.department}</p>
                                    <p><strong>Loại hợp đồng:</strong> ${currentStaff.employmentType || 'Chưa cập nhật'}</p>
                                    <p><strong>Ngày vào làm:</strong> ${currentStaff.startDate || 'Chưa cập nhật'}</p>
                                    <p><strong>Trạng thái:</strong> <span class="badge ${currentStaff.status === 'active' ? 'bg-success' : 'bg-warning'}">${currentStaff.status === 'active' ? 'Đang làm việc' : 'Tạm nghỉ'}</span></p>
                                    <p><strong>Lương cơ bản:</strong> ${currentStaff.basicSalary ? currentStaff.basicSalary.toLocaleString('vi-VN') + ' ₫' : 'Chưa cập nhật'}</p>
                                </div>
                            </div>
                            
                            <hr>
                            <h6>📊 Thống kê công việc</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Giờ làm việc (tháng):</strong> ${workHours} giờ</p>
                                    <p><strong>Ngày đi làm:</strong> ${totalWorkDays} ngày</p>
                                    <p><strong>Ngày nghỉ phép (năm):</strong> ${leaveDays} ngày</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Điểm hiệu suất:</strong> ${performanceScore}/100</p>
                                    <p><strong>Kinh nghiệm:</strong> ${currentStaff.experience || 0} năm</p>
                                    <p><strong>Trình độ học vấn:</strong> ${currentStaff.education || 'Chưa cập nhật'}</p>
                                </div>
                            </div>
                            
                            <hr>
                            <h6>📋 Thông tin bổ sung</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>CMND/CCCD:</strong> ${currentStaff.idCard || 'Chưa cập nhật'}</p>
                                    <p><strong>Địa chỉ:</strong> ${currentStaff.address || 'Chưa cập nhật'}</p>
                                    <p><strong>Dân tộc:</strong> ${currentStaff.ethnicity || 'Chưa cập nhật'}</p>
                                    <p><strong>Quốc tịch:</strong> ${currentStaff.nationality || 'Chưa cập nhật'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Chuyên ngành:</strong> ${currentStaff.major || 'Chưa cập nhật'}</p>
                                    <p><strong>Trường học:</strong> ${currentStaff.school || 'Chưa cập nhật'}</p>
                                    <p><strong>Kỹ năng:</strong> ${currentStaff.skills || 'Chưa cập nhật'}</p>
                                    <p><strong>Ngân hàng:</strong> ${currentStaff.bankName || 'Chưa cập nhật'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    Swal.fire({
                        title: 'Báo cáo hồ sơ cá nhân',
                        html: html,
                        width: '800px',
                        confirmButtonText: 'Xuất báo cáo',
                        showCancelButton: true,
                        cancelButtonText: 'Đóng',
                        showDenyButton: true,
                        denyButtonText: 'Chỉ xem'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            exportStaffReport();
                        }
                    });
                    
                } catch (error) {
                    console.error('❌ Error previewing personal staff report:', error);
                    Swal.fire('Lỗi', 'Không thể xem trước báo cáo: ' + error.message, 'error');
                }
            };
            
            // Xuất báo cáo thống kê nhân viên
            window.exportStaffReport = async function() {
                console.log('📊 Exporting personal staff report...');
                
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    Swal.fire('Lỗi', 'Vui lòng đăng nhập để xuất báo cáo', 'error');
                    return;
                }
                
                try {
                    // Load dữ liệu từ Firebase
                    const [staffSnapshot, rolesSnapshot, attendanceSnapshot, leaveSnapshot, performanceSnapshot] = await Promise.all([
                        firebase.database().ref('staff').once('value'),
                        firebase.database().ref('roles').once('value'),
                        firebase.database().ref('attendance').once('value'),
                        firebase.database().ref('leaveRequests').once('value'),
                        firebase.database().ref('performance').once('value')
                    ]);
                    
                    const staffData = staffSnapshot.val();
                    const rolesData = rolesSnapshot.val();
                    const attendanceData = attendanceSnapshot.val();
                    const leaveData = leaveSnapshot.val();
                    const performanceData = performanceSnapshot.val();
                    
                    if (!staffData) {
                        Swal.fire('Lỗi', 'Không có dữ liệu nhân viên', 'error');
                        return;
                    }
                    
                    // Tìm nhân viên hiện tại
                    let currentStaff = null;
                    let currentStaffId = null;
                    
                    for (let staffId in staffData) {
                        const staff = staffData[staffId];
                        if (staff.email === currentUser.email) {
                            currentStaff = staff;
                            currentStaffId = staffId;
                            break;
                        }
                    }
                    
                    if (!currentStaff) {
                        Swal.fire('Lỗi', 'Không tìm thấy hồ sơ nhân viên', 'error');
                        return;
                    }
                    
                    // Tạo map role code -> role name
                    const roleCodeToName = {};
                    if (rolesData) {
                        Object.values(rolesData).forEach(role => {
                            if (role.code && role.name) {
                                roleCodeToName[role.code] = role.name;
                            }
                        });
                    }
                    
                    // Tính toán thống kê cá nhân
                    let workHours = 0;
                    let leaveDays = 0;
                    let performanceScore = 0;
                    let totalWorkDays = 0;
                    
                    // Tính giờ làm việc
                    if (attendanceData && attendanceData[currentStaffId]) {
                        const attendance = attendanceData[currentStaffId];
                        for (let date in attendance) {
                            if (attendance[date].hours) {
                                workHours += attendance[date].hours;
                                totalWorkDays++;
                            }
                        }
                    }
                    
                    // Tính ngày nghỉ phép
                    if (leaveData) {
                        for (let leaveId in leaveData) {
                            const leave = leaveData[leaveId];
                            if (leave.employeeId === currentStaffId && leave.status === 'approved') {
                                const start = new Date(leave.startDate);
                                const end = new Date(leave.endDate);
                                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                                leaveDays += days;
                            }
                        }
                    }
                    
                    // Tính điểm hiệu suất
                    if (performanceData && performanceData[currentStaffId]) {
                        performanceScore = performanceData[currentStaffId].score || 0;
                    }
                    
                    // Tạo dữ liệu báo cáo cá nhân
                    const personalData = [
                        {
                            'Thông tin': 'Họ tên',
                            'Giá trị': currentStaff.name || 'N/A'
                        },
                        {
                            'Thông tin': 'Email',
                            'Giá trị': currentStaff.email || 'N/A'
                        },
                        {
                            'Thông tin': 'Mã nhân viên',
                            'Giá trị': currentStaff.employeeId || 'N/A'
                        },
                        {
                            'Thông tin': 'Số điện thoại',
                            'Giá trị': currentStaff.phone || 'N/A'
                        },
                        {
                            'Thông tin': 'Ngày sinh',
                            'Giá trị': currentStaff.birthDate || 'N/A'
                        },
                        {
                            'Thông tin': 'Giới tính',
                            'Giá trị': currentStaff.gender || 'N/A'
                        },
                        {
                            'Thông tin': 'CMND/CCCD',
                            'Giá trị': currentStaff.idCard || 'N/A'
                        },
                        {
                            'Thông tin': 'Địa chỉ',
                            'Giá trị': currentStaff.address || 'N/A'
                        },
                        {
                            'Thông tin': 'Dân tộc',
                            'Giá trị': currentStaff.ethnicity || 'N/A'
                        },
                        {
                            'Thông tin': 'Quốc tịch',
                            'Giá trị': currentStaff.nationality || 'N/A'
                        },
                        {
                            'Thông tin': 'Chức vụ',
                            'Giá trị': roleCodeToName[currentStaff.role] || currentStaff.role || 'N/A'
                        },
                        {
                            'Thông tin': 'Phòng ban',
                            'Giá trị': currentStaff.department || 'N/A'
                        },
                        {
                            'Thông tin': 'Loại hợp đồng',
                            'Giá trị': currentStaff.employmentType || 'N/A'
                        },
                        {
                            'Thông tin': 'Ngày vào làm',
                            'Giá trị': currentStaff.startDate || 'N/A'
                        },
                        {
                            'Thông tin': 'Trạng thái',
                            'Giá trị': currentStaff.status === 'active' ? 'Đang làm việc' : 'Tạm nghỉ'
                        },
                        {
                            'Thông tin': 'Lương cơ bản',
                            'Giá trị': currentStaff.basicSalary ? currentStaff.basicSalary.toLocaleString('vi-VN') + ' ₫' : 'N/A'
                        },
                        {
                            'Thông tin': 'Kinh nghiệm',
                            'Giá trị': currentStaff.experience ? currentStaff.experience + ' năm' : 'N/A'
                        },
                        {
                            'Thông tin': 'Trình độ học vấn',
                            'Giá trị': currentStaff.education || 'N/A'
                        },
                        {
                            'Thông tin': 'Chuyên ngành',
                            'Giá trị': currentStaff.major || 'N/A'
                        },
                        {
                            'Thông tin': 'Trường học',
                            'Giá trị': currentStaff.school || 'N/A'
                        },
                        {
                            'Thông tin': 'Kỹ năng',
                            'Giá trị': currentStaff.skills || 'N/A'
                        },
                        {
                            'Thông tin': 'Ngân hàng',
                            'Giá trị': currentStaff.bankName || 'N/A'
                        },
                        {
                            'Thông tin': 'Số tài khoản',
                            'Giá trị': currentStaff.bankAccount || 'N/A'
                        },
                        {
                            'Thông tin': 'Ngày tạo hồ sơ',
                            'Giá trị': currentStaff.createdAt ? new Date(currentStaff.createdAt).toLocaleDateString('vi-VN') : 'N/A'
                        }
                    ];
                    
                    // Tạo báo cáo thống kê công việc
                    const workStatsData = [
                        {
                            'Thống kê': 'Giờ làm việc (tháng)',
                            'Giá trị': workHours + ' giờ'
                        },
                        {
                            'Thống kê': 'Ngày đi làm',
                            'Giá trị': totalWorkDays + ' ngày'
                        },
                        {
                            'Thống kê': 'Ngày nghỉ phép (năm)',
                            'Giá trị': leaveDays + ' ngày'
                        },
                        {
                            'Thống kê': 'Điểm hiệu suất',
                            'Giá trị': performanceScore + '/100'
                        },
                        {
                            'Thống kê': 'Trung bình giờ làm/ngày',
                            'Giá trị': totalWorkDays > 0 ? (workHours / totalWorkDays).toFixed(1) + ' giờ' : '0 giờ'
                        }
                    ];
                    
                    // Xuất file Excel
                    const workbook = XLSX.utils.book_new();
                    
                    // Sheet thông tin cá nhân
                    const personalWorksheet = XLSX.utils.json_to_sheet(personalData);
                    XLSX.utils.book_append_sheet(workbook, personalWorksheet, 'Thông tin cá nhân');
                    
                    // Sheet thống kê công việc
                    const workStatsWorksheet = XLSX.utils.json_to_sheet(workStatsData);
                    XLSX.utils.book_append_sheet(workbook, workStatsWorksheet, 'Thống kê công việc');
                    
                    // Tạo tên file
                    const now = new Date();
                    const fileName = `Bao_cao_ho_so_ca_nhan_${currentStaff.name.replace(/\s+/g, '_')}_${now.getFullYear()}_${(now.getMonth() + 1).toString().padStart(2, '0')}_${now.getDate().toString().padStart(2, '0')}.xlsx`;
                    
                    // Xuất file
                    XLSX.writeFile(workbook, fileName);
                    
                    // Hiển thị thông báo thành công
                    Swal.fire({
                        title: 'Xuất báo cáo thành công!',
                        html: `
                            <div class="text-start">
                                <h6>Báo cáo hồ sơ cá nhân:</h6>
                                <p><strong>Nhân viên:</strong> ${currentStaff.name}</p>
                                <p><strong>Chức vụ:</strong> ${roleCodeToName[currentStaff.role] || currentStaff.role}</p>
                                <p><strong>Phòng ban:</strong> ${currentStaff.department}</p>
                                <p><strong>Giờ làm việc:</strong> ${workHours} giờ</p>
                                <p><strong>Điểm hiệu suất:</strong> ${performanceScore}/100</p>
                                <p><strong>File xuất:</strong> ${fileName}</p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'Đóng'
                    });
                    
                } catch (error) {
                    console.error('❌ Error exporting personal staff report:', error);
                    Swal.fire('Lỗi', 'Không thể xuất báo cáo: ' + error.message, 'error');
                }
            };
            
            // Tạo dữ liệu mẫu cho testing
            window.createSampleData = function() {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) return;
                
                console.log('🔧 Creating sample data for testing...');
                
                // Tạo attendance data mẫu
                const attendanceData = {};
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    if (date.getDay() !== 0) { // Không tạo data cho Chủ nhật
                        const checkIn = new Date(date);
                        checkIn.setHours(8, 0, 0, 0);
                        const checkOut = new Date(date);
                        checkOut.setHours(17, 30, 0, 0);
                        
                        attendanceData[dateStr] = {
                            checkIn: checkIn.getTime(),
                            checkOut: checkOut.getTime(),
                            date: dateStr,
                            timestamp: checkIn.getTime()
                        };
                    }
                }
                
                // Tạo performance data mẫu
                const performanceData = {
                    score: 95,
                    rating: 4.8,
                    customersServed: 156,
                    goodReviews: 142,
                    feedbackProcessed: 23,
                    avgRating: 4.8,
                    lastUpdated: Date.now()
                };
                
                // Lưu vào Firebase
                Promise.all([
                    firebase.database().ref(`attendance/${currentUser.uid}`).set(attendanceData),
                    firebase.database().ref(`performance/${currentUser.uid}`).set(performanceData)
                ]).then(() => {
                    console.log('✅ Sample data created successfully');
                    Swal.fire('Thành công', 'Đã tạo dữ liệu mẫu cho testing', 'success');
                    loadProfileData();
                }).catch((error) => {
                    console.error('❌ Error creating sample data:', error);
                    Swal.fire('Lỗi', 'Không thể tạo dữ liệu mẫu', 'error');
                });
            };
            
            // Test với email có sẵn trong staff database
            window.testWithStaffEmail = async function() {
                console.log('🧪 Testing with staff email...');
                
                // Các email có sẵn trong staff database
                const staffEmails = [
                    'cheesleenh021@gmail.com',
                    'giameocte@gmail.com', 
                    'nguyentienchuc2023ct@gmail.com',
                    'haibac2222@gmail.com',
                    'haibac222@gmail.com',
                    'bao221330@student.nctu.edu.vn' // Thạch Văn Bảo - NV1
                ];
                
                const result = await Swal.fire({
                    title: 'Test với Staff Email',
                    html: `
                        <p>Chọn email để test:</p>
                        <select id="test-email-select" class="form-control">
                            ${staffEmails.map(email => `<option value="${email}">${email}</option>`).join('')}
                        </select>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Test',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const selectedEmail = document.getElementById('test-email-select').value;
                        return selectedEmail;
                    }
                });
                
                if (result.isConfirmed) {
                    const testEmail = result.value;
                    console.log('🧪 Testing with email:', testEmail);
                    
                    try {
                        // Load staff data với email được chọn
                        const snapshot = await firebase.database().ref('staff').once('value');
                        const staffData = snapshot.val();
                        
                        if (staffData) {
                            for (let staffId in staffData) {
                                const staff = staffData[staffId];
                                if (staff.email === testEmail) {
                                    console.log('✅ Found staff record for testing:', staff);
                                    await updateProfileDisplay(staff);
                                    loadProfileStatistics(staffId);
                                    loadRecentActivity(staffId);
                                    
                                    Swal.fire('Thành công', `Đã load dữ liệu cho ${staff.name}`, 'success');
                                    return;
                                }
                            }
                        }
                        Swal.fire('Lỗi', 'Không tìm thấy staff record', 'error');
                    } catch (error) {
                        console.error('❌ Error testing with staff email:', error);
                        Swal.fire('Lỗi', 'Không thể load dữ liệu staff', 'error');
                    }
                }
            };
            
            // Xem profile chi tiết
            window.viewFullProfile = async function() {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) return;
                
                try {
                    // Load staff data để lấy thông tin chi tiết
                    const snapshot = await firebase.database().ref('staff').once('value');
                    const staffData = snapshot.val();
                    
                    let staffInfo = null;
                    if (staffData) {
                        for (let staffId in staffData) {
                            const staff = staffData[staffId];
                            if (staff.email === currentUser.email) {
                                staffInfo = staff;
                                break;
                            }
                        }
                    }
                    
                    // Load role details
                    let roleDetails = null;
                    if (staffInfo && staffInfo.role) {
                        const rolesSnapshot = await firebase.database().ref('roles').once('value');
                        const rolesData = rolesSnapshot.val();
                        if (rolesData) {
                            for (let roleId in rolesData) {
                                const role = rolesData[roleId];
                                if (role.code === staffInfo.role) {
                                    roleDetails = role;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Tạo HTML cho thông tin chi tiết
                    let html = `
                        <div class="text-start">
                            <h6>Thông tin cá nhân</h6>
                            <p><strong>Họ tên:</strong> ${document.getElementById('profile-name').textContent}</p>
                            <p><strong>Email:</strong> ${document.getElementById('profile-email').textContent}</p>
                            <p><strong>Chức vụ:</strong> ${document.getElementById('profile-position').textContent}</p>
                            <p><strong>Mã nhân viên:</strong> ${document.getElementById('profile-id').textContent}</p>
                            <p><strong>Ngày vào làm:</strong> ${document.getElementById('profile-start-date').textContent}</p>
                            <p><strong>Phòng ban:</strong> ${document.getElementById('profile-department').textContent}</p>
                    `;
                    
                    if (staffInfo) {
                        html += `
                            <hr>
                            <h6>Thông tin cá nhân chi tiết</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Số điện thoại:</strong> ${staffInfo.phone || 'Chưa cập nhật'}</p>
                                    <p><strong>Điện thoại cá nhân:</strong> ${staffInfo.personalPhone || 'Chưa cập nhật'}</p>
                                    <p><strong>Ngày sinh:</strong> ${staffInfo.birthDate || 'Chưa cập nhật'}</p>
                                    <p><strong>Giới tính:</strong> ${staffInfo.gender || 'Chưa cập nhật'}</p>
                                    <p><strong>Dân tộc:</strong> ${staffInfo.ethnicity || 'Chưa cập nhật'}</p>
                                    <p><strong>Quốc tịch:</strong> ${staffInfo.nationality || 'Chưa cập nhật'}</p>
                                    <p><strong>Tôn giáo:</strong> ${staffInfo.religion || 'Chưa cập nhật'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>CMND/CCCD:</strong> ${staffInfo.idCard || 'Chưa cập nhật'}</p>
                                    <p><strong>Ngày cấp:</strong> ${staffInfo.idCardDate || 'Chưa cập nhật'}</p>
                                    <p><strong>Nơi cấp:</strong> ${staffInfo.idCardPlace || 'Chưa cập nhật'}</p>
                                    <p><strong>Địa chỉ thường trú:</strong> ${staffInfo.address || 'Chưa cập nhật'}</p>
                                    <p><strong>Địa chỉ tạm trú:</strong> ${staffInfo.tempAddress || 'Chưa cập nhật'}</p>
                                    <p><strong>Mối quan hệ:</strong> ${staffInfo.relationship || 'Chưa cập nhật'}</p>
                                </div>
                            </div>
                            
                            <hr>
                            <h6>Thông tin công việc</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Loại hợp đồng:</strong> ${staffInfo.employmentType || 'Chưa cập nhật'}</p>
                                    <p><strong>Kinh nghiệm:</strong> ${staffInfo.experience || 0} năm</p>
                                    <p><strong>Trình độ học vấn:</strong> ${staffInfo.education || 'Chưa cập nhật'}</p>
                                    <p><strong>Chuyên ngành:</strong> ${staffInfo.major || 'Chưa cập nhật'}</p>
                                    <p><strong>Trường học:</strong> ${staffInfo.school || 'Chưa cập nhật'}</p>
                                    <p><strong>Chứng chỉ:</strong> ${staffInfo.certificates || 'Chưa cập nhật'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Kỹ năng:</strong> ${staffInfo.skills || 'Chưa cập nhật'}</p>
                                    <p><strong>Trạng thái:</strong> <span class="badge ${staffInfo.status === 'active' ? 'bg-success' : 'bg-warning'}">${staffInfo.status === 'active' ? 'Đang làm việc' : 'Tạm nghỉ'}</span></p>
                                    <p><strong>Ngày tham gia:</strong> ${staffInfo.joinedAt ? new Date(staffInfo.joinedAt).toLocaleDateString('vi-VN') : 'Chưa cập nhật'}</p>
                                    <p><strong>Ngày tạo hồ sơ:</strong> ${staffInfo.createdAt ? new Date(staffInfo.createdAt).toLocaleDateString('vi-VN') : 'Chưa cập nhật'}</p>
                                </div>
                            </div>
                            
                            <hr>
                            <h6>Thông tin tài chính</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Lương cơ bản:</strong> ${staffInfo.basicSalary ? staffInfo.basicSalary.toLocaleString('vi-VN') + ' ₫' : 'Chưa cập nhật'}</p>
                                    <p><strong>Ngân hàng:</strong> ${staffInfo.bankName || 'Chưa cập nhật'}</p>
                                    <p><strong>Số tài khoản:</strong> ${staffInfo.bankAccount || 'Chưa cập nhật'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Ghi chú:</strong> ${staffInfo.note || 'Chưa cập nhật'}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (roleDetails) {
                        html += `
                            <hr>
                            <h6>Chi tiết chức vụ</h6>
                            <p><strong>Mô tả:</strong> ${roleDetails.description || 'Chưa cập nhật'}</p>
                            <p><strong>Quyền hạn:</strong> ${roleDetails.permissions || 'Chưa cập nhật'}</p>
                            <p><strong>Yêu cầu:</strong> ${roleDetails.requirements || 'Chưa cập nhật'}</p>
                            <p><strong>Địa điểm làm việc:</strong> ${roleDetails.location || 'Chưa cập nhật'}</p>
                            <p><strong>Lương:</strong> ${roleDetails.salary ? roleDetails.salary.toLocaleString('vi-VN') + ' ₫' : 'Chưa cập nhật'}</p>
                            <p><strong>Phụ cấp:</strong> ${roleDetails.allowance ? roleDetails.allowance.toLocaleString('vi-VN') + ' ₫' : 'Chưa cập nhật'}</p>
                        `;
                    }
                    
                    html += '</div>';
                    
                    Swal.fire({
                        title: 'Thông tin chi tiết',
                        html: html,
                        width: '600px',
                        confirmButtonText: 'Đóng'
                    });
                    
                } catch (error) {
                    console.error('❌ Error loading full profile:', error);
                    Swal.fire('Lỗi', 'Không thể load thông tin chi tiết', 'error');
                }
            };
            
            // Thay đổi avatar
            window.changeAvatar = function() {
                Swal.fire({
                    title: 'Thay đổi ảnh đại diện',
                    text: 'Chức năng này sẽ được phát triển trong phiên bản tiếp theo',
                    icon: 'info',
                    confirmButtonText: 'Đã hiểu'
                });
            };
            
            // Thay đổi period của chart
            window.changeChartPeriod = function(period) {
                // Cập nhật active button
                document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                // Cập nhật chart theo period
                updateAttendanceChart(period);
            };
            
            // Load feedback processing statistics
            window.loadFeedbackProcessingStats = function(staffId) {
                console.log('📊 Loading feedback processing stats for:', staffId);
                
                // Load processed feedback count
                firebase.database().ref('reviews').orderByChild('processedBy').equalTo(staffId).once('value').then((snapshot) => {
                    const reviewsData = snapshot.val();
                    let processedCount = 0;
                    let goodReviews = 0;
                    
                    if (reviewsData) {
                        Object.values(reviewsData).forEach(review => {
                            if (review.processed) {
                                processedCount++;
                                if (review.rating >= 4) {
                                    goodReviews++;
                                }
                            }
                        });
                    }
                    
                    // Load guide feedback
                    firebase.database().ref('guideComments').once('value').then((guideSnapshot) => {
                        const guideData = guideSnapshot.val();
                        if (guideData) {
                            Object.values(guideData).forEach(guideComments => {
                                if (guideComments) {
                                    Object.values(guideComments).forEach(comment => {
                                        if (comment.processedBy === staffId) {
                                            processedCount++;
                                        }
                                    });
                                }
                            });
                        }
                        
                        // Update display
                        document.getElementById('feedback-processed').textContent = processedCount;
                        document.getElementById('good-reviews').textContent = goodReviews;
                        
                    }).catch((error) => {
                        console.error('❌ Error loading guide feedback:', error);
                    });
                    
                }).catch((error) => {
                    console.error('❌ Error loading feedback stats:', error);
                    document.getElementById('feedback-processed').textContent = '0';
                    document.getElementById('good-reviews').textContent = '0';
                });
            };
            
            // Load customer service statistics
            window.loadCustomerServiceStats = function(staffId) {
                console.log('📊 Loading customer service stats for:', staffId);
                
                // Load bookings handled by this staff
                firebase.database().ref('bookings').orderByChild('processedBy').equalTo(staffId).once('value').then((snapshot) => {
                    const bookingsData = snapshot.val();
                    let customersServed = 0;
                    let totalRating = 0;
                    let ratingCount = 0;
                    
                    if (bookingsData) {
                        Object.values(bookingsData).forEach(booking => {
                            if (booking.status === 'completed' || booking.status === 'confirmed') {
                                customersServed++;
                                if (booking.customerRating) {
                                    totalRating += booking.customerRating;
                                    ratingCount++;
                                }
                            }
                        });
                    }
                    
                    // Calculate average rating
                    const avgRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : '0.0';
                    
                    // Update display
                    document.getElementById('customers-served').textContent = customersServed;
                    document.getElementById('avg-rating').textContent = avgRating;
                    
                }).catch((error) => {
                    console.error('❌ Error loading customer service stats:', error);
                    document.getElementById('customers-served').textContent = '0';
                    document.getElementById('avg-rating').textContent = '0.0';
                });
            };
            
            // Cập nhật attendance chart với dữ liệu thực
            window.updateAttendanceChart = function(period = 'month') {
                const ctx = document.getElementById('attendanceChart');
                if (!ctx) return;
                
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) return;
                
                // Load attendance data from Firebase
                firebase.database().ref('staff').once('value').then((snapshot) => {
                    const staffData = snapshot.val();
                    if (staffData) {
                        for (let staffId in staffData) {
                            const staff = staffData[staffId];
                            const staffEmail = staff.email || staff.êmmail || staff['êmmail'];
                            if (staffEmail === currentUser.email) {
                                loadAttendanceChartData(staffId, period);
                                break;
                            }
                        }
                    }
                });
            };
            
            // Load attendance chart data from Firebase
            window.loadAttendanceChartData = function(staffId, period) {
                firebase.database().ref('attendance').child(staffId).once('value').then((snapshot) => {
                    const attendanceData = snapshot.val();
                    let labels, data;
                    
                    if (attendanceData) {
                        if (period === 'week') {
                            // Last 7 days
                            labels = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
                            data = [0, 0, 0, 0, 0, 0, 0];
                            
                            const today = new Date();
                            for (let i = 6; i >= 0; i--) {
                                const date = new Date(today);
                                date.setDate(date.getDate() - i);
                                const dateStr = date.toISOString().split('T')[0];
                                
                                if (attendanceData[dateStr]) {
                                    const record = attendanceData[dateStr];
                                    if (record.checkIn && record.checkOut) {
                                        const checkIn = new Date(record.checkIn);
                                        const checkOut = new Date(record.checkOut);
                                        const hours = (checkOut - checkIn) / (1000 * 60 * 60);
                                        data[6 - i] = Math.round(hours * 10) / 10;
                                    }
                                }
                            }
                        } else if (period === 'month') {
                            // Last 4 weeks
                            labels = ['Tuần 1', 'Tuần 2', 'Tuần 3', 'Tuần 4'];
                            data = [0, 0, 0, 0];
                            
                            const today = new Date();
                            for (let week = 0; week < 4; week++) {
                                let weekHours = 0;
                                for (let day = 0; day < 7; day++) {
                                    const date = new Date(today);
                                    date.setDate(date.getDate() - (week * 7 + day));
                                    const dateStr = date.toISOString().split('T')[0];
                                    
                                    if (attendanceData[dateStr]) {
                                        const record = attendanceData[dateStr];
                                        if (record.checkIn && record.checkOut) {
                                            const checkIn = new Date(record.checkIn);
                                            const checkOut = new Date(record.checkOut);
                                            const hours = (checkOut - checkIn) / (1000 * 60 * 60);
                                            weekHours += hours;
                                        }
                                    }
                                }
                                data[3 - week] = Math.round(weekHours);
                            }
                        } else {
                            // Last 3 months
                            labels = ['Tháng 1', 'Tháng 2', 'Tháng 3'];
                            data = [0, 0, 0];
                            
                            const today = new Date();
                            for (let month = 0; month < 3; month++) {
                                let monthHours = 0;
                                const monthDate = new Date(today);
                                monthDate.setMonth(monthDate.getMonth() - month);
                                
                                Object.entries(attendanceData).forEach(([dateStr, record]) => {
                                    const recordDate = new Date(dateStr);
                                    if (recordDate.getMonth() === monthDate.getMonth() && 
                                        recordDate.getFullYear() === monthDate.getFullYear()) {
                                        if (record.checkIn && record.checkOut) {
                                            const checkIn = new Date(record.checkIn);
                                            const checkOut = new Date(record.checkOut);
                                            const hours = (checkOut - checkIn) / (1000 * 60 * 60);
                                            monthHours += hours;
                                        }
                                    }
                                });
                                data[2 - month] = Math.round(monthHours);
                            }
                        }
                    } else {
                        // No data available
                        if (period === 'week') {
                            labels = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
                            data = [0, 0, 0, 0, 0, 0, 0];
                        } else if (period === 'month') {
                            labels = ['Tuần 1', 'Tuần 2', 'Tuần 3', 'Tuần 4'];
                            data = [0, 0, 0, 0];
                        } else {
                            labels = ['Tháng 1', 'Tháng 2', 'Tháng 3'];
                            data = [0, 0, 0];
                        }
                    }
                    
                    // Update chart
                    if (window.attendanceChart) {
                        window.attendanceChart.data.labels = labels;
                        window.attendanceChart.data.datasets[0].data = data;
                        window.attendanceChart.update();
                    } else {
                        // Create new chart
                        window.attendanceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Giờ làm việc',
                                    data: data,
                                    borderColor: '#7c3aed',
                                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0,0,0,0.1)'
                                        }
                                    },
                                    x: {
                                        grid: {
                                            display: false
                                        }
                                    }
                                }
                            }
                        });
                    }
                    
                }).catch((error) => {
                    console.error('❌ Error loading attendance chart data:', error);
                    // Show empty chart
                    const labels = period === 'week' ? ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'] :
                                  period === 'month' ? ['Tuần 1', 'Tuần 2', 'Tuần 3', 'Tuần 4'] :
                                  ['Tháng 1', 'Tháng 2', 'Tháng 3'];
                    const data = new Array(labels.length).fill(0);
                    
                    if (window.attendanceChart) {
                        window.attendanceChart.data.labels = labels;
                        window.attendanceChart.data.datasets[0].data = data;
                        window.attendanceChart.update();
                    }
                });
            };
            
            // Function tạm thời để xử lý feedback khi chưa có quyền Firebase
            window.processFeedbackTemporarily = function(type, id, guideId = '') {
                console.log('🔧 Processing feedback temporarily (no Firebase permission):', { type, id, guideId });
                
                // Lưu vào localStorage tạm thời
                const tempProcessed = JSON.parse(localStorage.getItem('tempProcessedFeedback') || '[]');
                const newProcessed = {
                    type: type,
                    id: id,
                    guideId: guideId,
                    processedAt: Date.now(),
                    processedBy: getCurrentEmployeeId(),
                    processedByEmail: firebase.auth().currentUser?.email || 'staff@luxuryhaven.com',
                    processedByUID: firebase.auth().currentUser?.uid || 'temp-uid'
                };
                
                tempProcessed.push(newProcessed);
                localStorage.setItem('tempProcessedFeedback', JSON.stringify(tempProcessed));
                
                console.log('📦 Temporarily stored in localStorage:', newProcessed);
                
                Swal.fire({
                    icon: 'info',
                    title: 'Xử lý tạm thời',
                    text: 'Phản hồi đã được đánh dấu xử lý tạm thời. Dữ liệu sẽ được đồng bộ lên Firebase khi có quyền.',
                    confirmButtonText: 'Đã hiểu'
                });
                
                // Reload feedback data
                loadFeedbackData();
            };
            
            // Function để sync dữ liệu tạm thời lên Firebase khi có quyền
            window.syncTemporaryData = function() {
                console.log('🔄 Syncing temporary data to Firebase...');
                
                const tempProcessed = JSON.parse(localStorage.getItem('tempProcessedFeedback') || '[]');
                if (tempProcessed.length === 0) {
                    console.log('📭 No temporary data to sync');
                    return;
                }
                
                console.log('📦 Found', tempProcessed.length, 'temporary records to sync');
                
                tempProcessed.forEach((record, index) => {
                    let firebaseRef;
                    if (record.type === 'review') {
                        firebaseRef = firebase.database().ref(`reviews/${record.id}`);
                    } else if (record.type === 'guide_comment') {
                        firebaseRef = firebase.database().ref(`guideComments/${record.guideId}/${record.id}`);
                    } else if (record.type === 'guide_rating') {
                        firebaseRef = firebase.database().ref(`guideRatings/${record.guideId}/${record.id}`);
                    }
                    
                    if (firebaseRef) {
                        const updateData = {
                            processed: true,
                            processedAt: record.processedAt,
                            processedBy: record.processedBy,
                            processedByEmail: record.processedByEmail,
                            processedByUID: record.processedByUID
                        };
                        
                        firebaseRef.update(updateData).then(() => {
                            console.log('✅ Synced record', index + 1, 'to Firebase');
                        }).catch((error) => {
                            console.error('❌ Failed to sync record', index + 1, ':', error);
                        });
                    }
                });
                
                // Clear temporary data after sync attempt
                localStorage.removeItem('tempProcessedFeedback');
                console.log('🧹 Cleared temporary data');
            };
        });

        // Show add booking modal - using SweetAlert2 like admin
        window.showAddBookingModal = function() {
            // Lấy danh sách khách sạn từ Firebase
            firebase.database().ref('location').once('value').then(snapshot => {
                let hotelOptions = '';
                let hotelsData = [];
                snapshot.forEach(locationSnap => {
                    const location = locationSnap.val();
                    if (location.hotels) {
                        Object.entries(location.hotels).forEach(([hotelKey, hotel]) => {
                            hotelsData.push({
                                id: hotelKey,
                                name: hotel.tenKhachSan,
                                rooms: hotel.chiTiet && hotel.chiTiet.rooms ? hotel.chiTiet.rooms : [],
                                locationId: locationSnap.key
                            });
                            hotelOptions += `<option value="${locationSnap.key}__${hotelKey}">${hotel.tenKhachSan}</option>`;
                        });
                    }
                });
                
                Swal.fire({
                    title: 'Thêm đặt phòng mới',
                    html: `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <input id="add-customerName" class="swal2-input" placeholder="Tên khách *">
                            <input id="add-customerEmail" class="swal2-input" placeholder="Email">
                            <input id="add-customerPhone" class="swal2-input" placeholder="Số điện thoại *">
                            <select id="add-hotelSelect" class="swal2-input" style="width: 100%"><option value="">Chọn khách sạn *</option>${hotelOptions}</select>
                            <select id="add-roomSelect" class="swal2-input" style="width: 100%" disabled><option value="">Chọn phòng</option></select>
                            <input id="add-checkIn" class="swal2-input" type="date" placeholder="Ngày check-in *">
                            <input id="add-checkOut" class="swal2-input" type="date" placeholder="Ngày check-out *">
                            <input id="add-guests" class="swal2-input" type="number" min="1" placeholder="Số khách *" value="1">
                            <select id="add-status" class="swal2-input" style="width: 100%">
                                <option value="pending">Chờ xác nhận</option>
                                <option value="confirmed">Đã xác nhận</option>
                                <option value="cancelled">Đã hủy</option>
                                <option value="completed">Hoàn thành</option>
                            </select>
                            <input id="add-totalPrice" class="swal2-input" type="number" min="0" placeholder="Tổng tiền (VNĐ)">
                            <textarea id="add-notes" class="swal2-input" placeholder="Ghi chú" rows="2"></textarea>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu',
                    cancelButtonText: 'Hủy',
                    didOpen: () => {
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const roomSelect = document.getElementById('add-roomSelect');
                        hotelSelect.addEventListener('change', function() {
                            const value = this.value;
                            roomSelect.innerHTML = '<option value="">Chọn phòng</option>';
                            roomSelect.disabled = true;
                            if (!value) return;
                            const [locationId, hotelKey] = value.split('__');
                            const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                            if (hotel && Array.isArray(hotel.rooms)) {
                                hotel.rooms.forEach(room => {
                                    if (room && room.name) {
                                        const option = document.createElement('option');
                                        option.value = room.name;
                                        option.textContent = room.name;
                                        roomSelect.appendChild(option);
                                    }
                                });
                                roomSelect.disabled = false;
                            }
                        });
                    },
                    preConfirm: () => {
                        const customerName = document.getElementById('add-customerName').value.trim();
                        const customerPhone = document.getElementById('add-customerPhone').value.trim();
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const checkIn = document.getElementById('add-checkIn').value;
                        const checkOut = document.getElementById('add-checkOut').value;
                        const guests = document.getElementById('add-guests').value;

                        if (!customerName || !customerPhone || !hotelSelect.value || !checkIn || !checkOut || !guests) {
                            Swal.showValidationMessage('Vui lòng điền đầy đủ thông tin bắt buộc!');
                            return false;
                        }

                        if (new Date(checkIn) >= new Date(checkOut)) {
                            Swal.showValidationMessage('Ngày check-out phải sau ngày check-in!');
                            return false;
                        }

                        const hotelValue = hotelSelect.value;
                        const [locationId, hotelKey] = hotelValue.split('__');
                        const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                        
                        return {
                            customerName: customerName,
                            customerEmail: document.getElementById('add-customerEmail').value.trim(),
                            customerPhone: customerPhone,
                            hotelName: hotel ? hotel.name : '',
                            roomName: document.getElementById('add-roomSelect').value,
                            guests: parseInt(guests),
                            checkIn: new Date(checkIn).getTime(),
                            checkOut: new Date(checkOut).getTime(),
                            status: document.getElementById('add-status').value,
                            totalPrice: document.getElementById('add-totalPrice').value ? parseInt(document.getElementById('add-totalPrice').value) : 0,
                            notes: document.getElementById('add-notes').value.trim(),
                            type: 'hotel',
                            bookingType: 'hotel',
                            createdAt: Date.now(),
                            createdBy: getCurrentEmployeeId()
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        firebase.database().ref('bookings').push(result.value).then(() => {
                            Swal.fire('Thành công', 'Đã thêm đặt phòng mới!', 'success');
                            loadBookings();
                        }).catch((error) => {
                            console.error('Error creating booking:', error);
                            Swal.fire('Lỗi', 'Không thể thêm đặt phòng.', 'error');
                        });
                    }
                });
            });
        };

        // ===== PHẢN HỒI VÀ THỐNG KÊ TỪ FIREBASE =====

        // Load dữ liệu phản hồi từ Firebase realtime
        function loadFeedbackData() {
            console.log('🔄 Loading feedback data from Firebase realtime...');
            const tableBody = document.getElementById('feedback-table-body');
            if (!tableBody) {
                console.error('❌ Feedback table body not found!');
                return;
            }

            // Hiển thị loading state
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-3">Đang tải dữ liệu phản hồi...</td></tr>';

            // Load dữ liệu reviews từ Firebase realtime
            firebase.database().ref('reviews').on('value', (snapshot) => {
                let feedbackData = [];
                
                if (snapshot.exists()) {
                    console.log('📋 Loading real reviews data...');
                    snapshot.forEach((childSnapshot) => {
                        const review = childSnapshot.val();
                        if (review && typeof review === 'object') {
                            // Chuyển đổi dữ liệu từ JSON format sang format hiển thị
                            const feedbackItem = {
                                id: childSnapshot.key,
                                type: 'review',
                                userName: review.userName || 'Khách',
                                comment: review.comment || 'Không có nội dung',
                                room: review.hotelId ? `Khách sạn ${review.hotelId}` : '',
                                rating: review.rating || 0,
                                processed: review.processed || false,
                                timestamp: review.date || review.timestamp || Date.now(),
                                hotelId: review.hotelId,
                                userId: review.userId
                            };
                            feedbackData.push(feedbackItem);
                        }
                    });
                    console.log('📊 Reviews loaded:', feedbackData.length);
                }

                // Load guide comments nếu có
                firebase.database().ref('guideComments').once('value').then((guideSnapshot) => {
                    if (guideSnapshot.exists()) {
                        guideSnapshot.forEach((guideChildSnapshot) => {
                            const guideId = guideChildSnapshot.key;
                            if (guideChildSnapshot.val() && typeof guideChildSnapshot.val() === 'object') {
                                Object.entries(guideChildSnapshot.val()).forEach(([commentId, comment]) => {
                                    if (comment && typeof comment === 'object') {
                                        const feedbackItem = {
                                            id: commentId,
                                            guideId: guideId,
                                            type: 'guide_comment',
                                            userName: comment.userName || 'Khách',
                                            text: comment.text || comment.comment || 'Không có nội dung',
                                            processed: comment.processed || false,
                                            timestamp: comment.timestamp || comment.date || Date.now()
                                        };
                                        feedbackData.push(feedbackItem);
                                    }
                                });
                            }
                        });
                        console.log('📊 Guide comments loaded');
                    }

                    // Load guide ratings nếu có
                    return firebase.database().ref('guideRatings').once('value').then((ratingSnapshot) => {
                        if (ratingSnapshot.exists()) {
                            ratingSnapshot.forEach((ratingChildSnapshot) => {
                                const guideId = ratingChildSnapshot.key;
                                if (ratingChildSnapshot.val() && typeof ratingChildSnapshot.val() === 'object') {
                                    Object.entries(ratingChildSnapshot.val()).forEach(([ratingId, rating]) => {
                                        if (rating && typeof rating === 'object') {
                                            const feedbackItem = {
                                                id: ratingId,
                                                guideId: guideId,
                                                type: 'guide_rating',
                                                userName: rating.userName || 'Khách',
                                                comment: rating.comment || 'Không có bình luận',
                                                rating: rating.rating || 0,
                                                processed: rating.processed || false,
                                                timestamp: rating.timestamp || rating.date || Date.now()
                                            };
                                            feedbackData.push(feedbackItem);
                                        }
                                    });
                                }
                            });
                            console.log('📊 Guide ratings loaded');
                        }

                        // Sắp xếp theo thời gian mới nhất
                        feedbackData.sort((a, b) => b.timestamp - a.timestamp);
                        
                        console.log('📊 Total feedback data:', feedbackData.length);
                        renderFeedbackTable(feedbackData);
                    });
                }).catch((error) => {
                    console.error('❌ Error loading guide data:', error);
                    // Vẫn hiển thị reviews nếu có
                    if (feedbackData.length > 0) {
                        feedbackData.sort((a, b) => b.timestamp - a.timestamp);
                        renderFeedbackTable(feedbackData);
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Chưa có phản hồi nào.</td></tr>';
                    }
                });
            }, (error) => {
                console.error('❌ Error loading reviews data:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-danger">Lỗi tải dữ liệu phản hồi!</td></tr>';
            });
        }

        // Render bảng phản hồi
        function renderFeedbackTable(feedbackData) {
            const tableBody = document.getElementById('feedback-table-body');
            tableBody.innerHTML = '';

            if (feedbackData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-5">Chưa có phản hồi nào.</td></tr>';
                return;
            }

            console.log('🎨 Rendering feedback table with data:', feedbackData);

            feedbackData.forEach((feedback) => {
                const row = document.createElement('tr');

                let customerName = feedback.userName || 'Khách';
                let content = '';
                let room = '';
                let status = 'pending';
                let statusText = 'Chờ xử lý';

                if (feedback.type === 'review') {
                    content = feedback.comment || 'Không có nội dung';
                    if (feedback.rating) {
                        content += ` (${feedback.rating}/5 ⭐)`;
                    }
                    room = feedback.room || feedback.hotelId || '';
                    status = feedback.processed ? 'processed' : 'pending';
                    statusText = feedback.processed ? 'Đã xử lý' : 'Chờ xử lý';
                } else if (feedback.type === 'guide_comment') {
                    content = feedback.text || 'Không có nội dung';
                    room = 'Hướng dẫn du lịch';
                    status = feedback.processed ? 'processed' : 'pending';
                    statusText = feedback.processed ? 'Đã xử lý' : 'Chờ xử lý';
                } else if (feedback.type === 'guide_rating') {
                    content = `${feedback.comment || 'Không có bình luận'} (${feedback.rating}/5 ⭐)`;
                    room = 'Hướng dẫn du lịch';
                    status = feedback.processed ? 'processed' : 'pending';
                    statusText = feedback.processed ? 'Đã xử lý' : 'Chờ xử lý';
                }

                const statusBadge = status === 'processed' 
                    ? '<span class="badge bg-success">Đã xử lý</span>'
                    : '<span class="badge bg-warning">Chờ xử lý</span>';

                const actionButton = status === 'processed'
                    ? '<button class="btn btn-sm btn-secondary" disabled>Đã xử lý</button>'
                    : `<button class="btn btn-sm btn-primary" onclick="markFeedbackProcessed('${feedback.type}', '${feedback.id}', '${feedback.guideId || ''}')">Đánh dấu đã xử lý</button>`;

                // Format ngày tháng
                const date = new Date(feedback.timestamp);
                const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});

                row.innerHTML = `
                    <td>
                        <div><strong>${customerName}</strong></div>
                        <small class="text-muted">${formattedDate}</small>
                    </td>
                    <td>${room}</td>
                    <td>
                        <div>${content}</div>
                        ${feedback.rating ? `<small class="text-warning">${'⭐'.repeat(feedback.rating)}</small>` : ''}
                    </td>
                    <td>${statusBadge}</td>
                    <td>${actionButton}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load dữ liệu thống kê từ Firebase realtime
        function loadStatisticsData() {
            console.log('📊 Loading statistics data from Firebase realtime...');
            
            // Hiển thị loading state
            const statsSection = document.getElementById('stats-section');
            if (statsSection) {
                const statValues = statsSection.querySelectorAll('.stat-value');
                statValues.forEach(value => {
                    value.textContent = '...';
                });
            }
            
            // Load dữ liệu bookings realtime
            firebase.database().ref('bookings').on('value', (bookingSnapshot) => {
                let processedBookings = 0;
                let totalBookings = 0;
                
                if (bookingSnapshot.exists()) {
                    console.log('📋 Loading bookings data...');
                    bookingSnapshot.forEach((childSnapshot) => {
                        const booking = childSnapshot.val();
                        if (booking && typeof booking === 'object') {
                            totalBookings++;
                            // Chỉ tính các booking đã xử lý (confirmed hoặc completed)
                            if (booking.status === 'confirmed' || booking.status === 'completed') {
                                processedBookings++;
                            }
                        }
                    });
                }

                console.log('📊 Booking stats:', { processedBookings, totalBookings });

                // Load feedback statistics realtime
                firebase.database().ref('reviews').on('value', (reviewSnapshot) => {
                    let processedFeedback = 0;
                    let totalFeedback = 0;
                    
                    if (reviewSnapshot.exists()) {
                        console.log('📋 Loading reviews data...');
                        reviewSnapshot.forEach((childSnapshot) => {
                            const review = childSnapshot.val();
                            if (review && typeof review === 'object') {
                                totalFeedback++;
                                // Chỉ tính các review đã được xử lý
                                if (review.processed) {
                                    processedFeedback++;
                                }
                            }
                        });
                    }

                    console.log('📊 Review stats:', { processedFeedback, totalFeedback });

                    // Load guide comments statistics
                    firebase.database().ref('guideComments').once('value').then((commentSnapshot) => {
                        if (commentSnapshot.exists()) {
                            console.log('📋 Loading guide comments data...');
                            commentSnapshot.forEach((guideChildSnapshot) => {
                                if (guideChildSnapshot.val() && typeof guideChildSnapshot.val() === 'object') {
                                    Object.values(guideChildSnapshot.val()).forEach((comment) => {
                                        if (comment && typeof comment === 'object') {
                                            totalFeedback++;
                                            if (comment.processed) {
                                                processedFeedback++;
                                            }
                                        }
                                    });
                                }
                            });
                        }

                        // Load guide ratings statistics
                        return firebase.database().ref('guideRatings').once('value').then((ratingSnapshot) => {
                            if (ratingSnapshot.exists()) {
                                console.log('📋 Loading guide ratings data...');
                                ratingSnapshot.forEach((ratingChildSnapshot) => {
                                    if (ratingChildSnapshot.val() && typeof ratingChildSnapshot.val() === 'object') {
                                        Object.values(ratingChildSnapshot.val()).forEach((rating) => {
                                            if (rating && typeof rating === 'object') {
                                                totalFeedback++;
                                                if (rating.processed) {
                                                    processedFeedback++;
                                                }
                                            }
                                        });
                                    }
                                });
                            }

                            console.log('📊 Final stats:', { processedBookings, totalBookings, processedFeedback, totalFeedback });

                            // Cập nhật thống kê với dữ liệu thực
                            updateStatisticsDisplay(processedBookings, totalBookings, processedFeedback, totalFeedback);
                        });
                    }).catch((error) => {
                        console.error('❌ Error loading guide statistics:', error);
                        // Vẫn cập nhật với dữ liệu reviews nếu có
                        updateStatisticsDisplay(processedBookings, totalBookings, processedFeedback, totalFeedback);
                    });
                }, (error) => {
                    console.error('❌ Error loading reviews statistics:', error);
                    // Fallback với dữ liệu bookings
                    updateStatisticsDisplay(processedBookings, totalBookings, 0, 0);
                });
            }, (error) => {
                console.error('❌ Error loading bookings statistics:', error);
                // Fallback với dữ liệu mẫu nếu có lỗi
                console.log('📊 Using fallback data due to error');
                updateStatisticsDisplay(5, 8, 3, 6);
            });
        }

        // Cập nhật hiển thị thống kê
        function updateStatisticsDisplay(processedBookings, totalBookings, processedFeedback, totalFeedback) {
            console.log('📊 Updating statistics display:', { processedBookings, totalBookings, processedFeedback, totalFeedback });
            
            // Kiểm tra xem stats section có tồn tại không
            const statsSection = document.getElementById('stats-section');
            if (!statsSection) {
                console.log('📊 Stats section not found');
                return;
            }
            
            // Tìm các element thống kê
            const statValues = document.querySelectorAll('#stats-section .stat-value');
            console.log('🔍 Found stat value elements:', statValues.length);
            
            if (statValues.length >= 3) {
                // Update booking statistics (first stat-card) - Đặt phòng đã xử lý
                statValues[0].textContent = processedBookings;
                console.log('✅ Updated booking stats:', processedBookings);
                
                // Update check-in/out statistics (second stat-card) - Check-in/out đã hỗ trợ
                // Tính dựa trên số booking đã xử lý (khoảng 70% có check-in/out)
                const checkinValue = Math.floor(processedBookings * 0.7);
                statValues[1].textContent = checkinValue;
                console.log('✅ Updated checkin stats:', checkinValue);
                
                // Update feedback statistics (third stat-card) - Phản hồi đã xử lý
                statValues[2].textContent = processedFeedback;
                console.log('✅ Updated feedback stats:', processedFeedback);
                
                // Update chart data
                updateStatisticsChart(processedBookings, checkinValue, processedFeedback);
                
                // Ẩn thông báo "chưa có dữ liệu" nếu có dữ liệu
                const emptyMessage = document.getElementById('stats-empty-message');
                if (emptyMessage) {
                    if (processedBookings > 0 || processedFeedback > 0) {
                        emptyMessage.style.display = 'none';
                    } else {
                        emptyMessage.style.display = 'block';
                        emptyMessage.textContent = 'Chưa có dữ liệu thống kê cá nhân.';
                    }
                }
                
                // Hiển thị thông tin chi tiết trong console
                console.log('📊 Statistics Summary:');
                console.log('  - Đặt phòng đã xử lý:', processedBookings, '/', totalBookings);
                console.log('  - Check-in/out đã hỗ trợ:', checkinValue);
                console.log('  - Phản hồi đã xử lý:', processedFeedback, '/', totalFeedback);
                
            } else {
                console.error('❌ Not enough stat value elements found');
            }
        }

        // Cập nhật biểu đồ thống kê
        function updateStatisticsChart(bookings, checkins, feedback) {
            const chartCanvas = document.getElementById('personalStatsChart');
            if (chartCanvas && window.personalStatsChart) {
                console.log('📈 Updating chart with data:', { bookings, checkins, feedback });
                try {
                    window.personalStatsChart.data.datasets[0].data = [bookings, checkins, feedback];
                    window.personalStatsChart.update();
                    console.log('✅ Chart updated successfully');
                } catch (error) {
                    console.error('❌ Error updating chart:', error);
                    // Reinitialize chart if needed
                    if (typeof initializePersonalStatsChart === 'function') {
                        initializePersonalStatsChart();
                    }
                }
            } else {
                console.error('❌ Chart canvas or chart instance not found');
                console.log('Canvas exists:', !!chartCanvas);
                console.log('Chart instance exists:', !!window.personalStatsChart);
                // Try to initialize chart
                if (typeof initializePersonalStatsChart === 'function') {
                    initializePersonalStatsChart();
                }
            }
        }

        // Đánh dấu phản hồi đã xử lý với error handling tốt hơn
        window.markFeedbackProcessed = function(type, id, guideId = '') {
            console.log('🔧 Marking feedback as processed:', { type, id, guideId });
            
            // Kiểm tra đăng nhập Firebase
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.error('❌ No Firebase user logged in');
                Swal.fire('Lỗi', 'Bạn cần đăng nhập để thực hiện chức năng này!', 'error');
                return;
            }
            
            // Xác định Firebase reference dựa trên loại feedback
            let firebaseRef;
            if (type === 'review') {
                firebaseRef = firebase.database().ref(`reviews/${id}`);
                console.log('📝 Firebase path: reviews/' + id);
            } else if (type === 'guide_comment') {
                firebaseRef = firebase.database().ref(`guideComments/${guideId}/${id}`);
                console.log('📝 Firebase path: guideComments/' + guideId + '/' + id);
            } else if (type === 'guide_rating') {
                firebaseRef = firebase.database().ref(`guideRatings/${guideId}/${id}`);
                console.log('📝 Firebase path: guideRatings/' + guideId + '/' + id);
            } else {
                console.error('❌ Invalid feedback type:', type);
                Swal.fire('Lỗi', 'Loại phản hồi không hợp lệ!', 'error');
                return;
            }

            if (firebaseRef) {
                // Dữ liệu sẽ được gửi lên Firebase
                const updateData = {
                    processed: true,
                    processedAt: Date.now(),
                    processedBy: getCurrentEmployeeId(),
                    processedByEmail: currentUser.email || 'staff@luxuryhaven.com',
                    processedByUID: currentUser.uid
                };
                
                console.log('📤 Sending data to Firebase:', updateData);
                console.log('🎯 Firebase reference:', firebaseRef.toString());
                
                // Gửi dữ liệu lên Firebase
                firebaseRef.update(updateData).then(() => {
                    console.log('✅ Data sent to Firebase successfully');
                    console.log('📊 Updated feedback in Firebase database');
                    
                    // Hiển thị thông báo thành công
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: 'Đã đánh dấu phản hồi đã xử lý và lưu vào Firebase.',
                        confirmButtonText: 'Đã hiểu'
                    });
                    
                    // Reload dữ liệu từ Firebase
                    loadFeedbackData();
                }).catch((error) => {
                    console.error('❌ Error sending data to Firebase:', error);
                    console.error('🔍 Error details:', {
                        code: error.code,
                        message: error.message,
                        serverResponse: error.serverResponse
                    });
                    
                    if (error.code === 'PERMISSION_DENIED') {
                        // Fallback: Xử lý tạm thời
                        console.log('🔄 Falling back to temporary processing...');
                        processFeedbackTemporarily(type, id, guideId);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi kết nối Firebase',
                            text: 'Không thể gửi dữ liệu lên Firebase: ' + error.message,
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            } else {
                console.error('❌ Invalid Firebase reference');
                Swal.fire('Lỗi', 'Không thể tạo tham chiếu Firebase hợp lệ!', 'error');
            }
        };


    </script>


</body>
</html>