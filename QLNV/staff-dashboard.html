<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Nhân Viên</title>
    <!-- Bootstrap, FontAwesome, Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <style>
        :root {
            --main-bg: #181c2f;
            --sidebar-bg: #23244a;
            --card-bg: #23244a;
            --accent: #7c3aed;
            --accent2: #00eaff;
            --text: #f3f6fa;
            --text-muted: #b0b8d1;
            --border: #2e325a;
            --shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.15);
        }
        body {
            background: var(--main-bg);
            color: var(--text);
            font-family: 'Poppins', Arial, sans-serif;
            margin: 0;
        }
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            color: var(--text);
            min-height: 100vh;
            position: fixed;
            top: 0; left: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .sidebar .logo {
            padding: 32px 0 24px 0;
            text-align: center;
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--accent);
        }
        .sidebar .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 32px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 1.08rem;
            border-left: 4px solid transparent;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }
        .sidebar .nav-item.active, .sidebar .nav-item:hover {
            background: #1a1d36;
            color: var(--accent2);
            border-left: 4px solid var(--accent);
        }
        .sidebar .nav-item i {
            margin-right: 14px;
            font-size: 1.2rem;
        }
        .sidebar-footer {
            margin-top: auto;
            padding: 24px 32px;
        }
        .sidebar-footer .btn {
            width: 100%;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 500;
        }
        .main-container {
            margin-left: 240px;
            min-height: 100vh;
            background: var(--main-bg);
        }
        .main-header {
            background: #1a1d36;
            border-bottom: 1px solid var(--border);
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .main-header .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .main-header .user-info img {
            width: 44px; height: 44px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--accent);
        }
        .content-wrapper {
            padding: 40px 32px 32px 32px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .card-modern {
            background: var(--card-bg);
            border-radius: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 32px;
            padding: 0;
        }
        .card-modern .card-body {
            padding: 32px 28px;
        }
        .card-modern .card-title {
            color: var(--accent2);
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 18px;
        }
        .profile-info {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        .profile-info img {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--accent);
        }
        .profile-info .info {
            font-size: 1.1rem;
        }
        .stat-cards {
            display: flex;
            gap: 24px;
            margin-bottom: 32px;
        }
        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #7c3aed 0%, #00eaff 100%);
            color: #fff;
            border-radius: 14px;
            padding: 24px 18px;
            box-shadow: 0 2px 12px 0 rgba(44, 62, 80, 0.12);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 160px;
        }
        .stat-card .stat-label {
            font-size: 1rem;
            opacity: 0.85;
        }
        .stat-card .stat-value {
            font-size: 2.1rem;
            font-weight: 700;
            margin: 8px 0 0 0;
        }
        .stat-card .stat-icon {
            font-size: 2.2rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        .table-modern {
            color: var(--text);
        }
        .table-modern th, .table-modern td {
            background: transparent !important;
            border-color: var(--border) !important;
        }
        .form-control, .form-select {
            background: #23244a;
            color: var(--text);
            border: 1px solid var(--border);
        }
        .form-control:focus, .form-select:focus {
            background: #23244a;
            color: var(--text);
            border-color: var(--accent2);
            box-shadow: 0 0 0 2px var(--accent2, #00eaff33);
        }
        .btn-primary, .btn-success {
            background: var(--accent);
            border: none;
        }
        .btn-primary:hover, .btn-success:hover {
            background: var(--accent2);
        }
        .sidebar .nav-item.booking { color: #ffb300; }
        
        /* Booking status badges */
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-confirmed {
            background: #d1edff;
            color: #0c5460;
        }
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        .sidebar .nav-item.checkin { color: #00eaff; }
        .sidebar .nav-item.housekeeping { color: #7c3aed; }
        .sidebar .nav-item.feedback { color: #ff4081; }
        .sidebar .nav-item.stats { color: #00e676; }

        /* CSS cho modal chấm công */
        .modal-content {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--border) !important;
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border) !important;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border) !important;
        }
        
        .modal-title {
            color: var(--accent2) !important;
        }
        
        .btn-close {
            filter: invert(1);
        }
        
        .modal { z-index: 1050; }
        .modal-backdrop { z-index: 1040; }
        
        #timesheetModal { z-index: 1055; }
        #timesheetModal .modal-backdrop { z-index: 1050; }
        
        #createScheduleModal, #addOvertimeModal { z-index: 1060 !important; }
        #createScheduleModal .modal-backdrop, #addOvertimeModal .modal-backdrop { z-index: 1055 !important; }
        
        .modal.show { z-index: 1060 !important; }
        .modal.show .modal-backdrop { z-index: 1055 !important; }
        
        .card {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--border) !important;
            color: var(--text) !important;
        }
        
        .card-header {
            background-color: rgba(124, 58, 237, 0.1) !important;
            border-bottom: 1px solid var(--border) !important;
            color: var(--accent2) !important;
        }
        
        .list-group-item {
            background-color: var(--card-bg) !important;
            border-color: var(--border) !important;
            color: var(--text) !important;
        }
        
        .list-group-item.active {
            background-color: var(--accent) !important;
            border-color: var(--accent) !important;
        }

        @media (max-width: 900px) {
            .sidebar { width: 80px; }
            .main-container { margin-left: 80px; }
            .sidebar .nav-item { padding: 12px 10px; font-size: 0.95rem; }
            .sidebar .logo { font-size: 1.1rem; }
        }
        @media (max-width: 700px) {
            .sidebar { display: none; }
            .main-container { margin-left: 0; }
            .main-header { padding: 12px 10px; }
            .content-wrapper { padding: 12px 4px; }
            .stat-cards { flex-direction: column; gap: 12px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-hotel"></i> LUXSTAFF
        </div>
        <a href="#profile" class="nav-item active" onclick="showSection('profile')"><i class="fas fa-id-badge"></i> Hồ sơ cá nhân</a>
        <a href="#attendance" class="nav-item" onclick="showSection('attendance')"><i class="fas fa-calendar-check"></i> Chấm công</a>
        <a href="#leave" class="nav-item" onclick="showSection('leave')"><i class="fas fa-plane-departure"></i> Xin nghỉ phép</a>
        <a href="#booking" class="nav-item booking" onclick="showSection('booking')"><i class="fas fa-bed"></i> Đặt phòng</a>
        <a href="#feedback" class="nav-item feedback" onclick="showSection('feedback')"><i class="fas fa-comment-dots"></i> Phản hồi</a>
        <a href="#stats" class="nav-item stats" onclick="showSection('stats')"><i class="fas fa-chart-bar"></i> Thống kê</a>
        <div class="sidebar-footer">
            <button class="btn" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</button>
        </div>
    </div>
    <!-- Main content -->
    <div class="main-container">
        <!-- Header -->
        <header class="main-header">
            <h1 class="h4 mb-0" style="color:var(--accent2);">Dashboard Nhân viên</h1>
            <div class="user-info">
                <img src="../images/z6704204165630_f126462fb6b33e841e82b706ba2e582c.jpg" alt="Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM3YzNhZWQiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAxMmMyLjIxIDAgNC0xLjc5IDQtNHMtMS43OS00LTQtNC00IDEuNzktNCA0IDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmgxNnYtMmMwLTIuNjYtNS4zMy00LTgtNHoiLz4KPC9zdmc+Cjwvc3ZnPgo='">
                <span><strong>Nguyễn Văn A</strong></span>
            </div>
        </header>
        <main class="content-wrapper">
            <!-- Hồ sơ cá nhân -->
            <section id="profile-section">
                <div class="card-modern mb-4">
                    <div class="card-body profile-info">
                        <img src="../images/z6704204165630_f126462fb6b33e841e82b706ba2e582c.jpg" alt="Avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjN2MzYWVkIi8+CjxzdmcgeD0iMzAiIHk9IjMwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPgo8cGF0aCBkPSJNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTQtMS43OS00LTQtNC00IDQgMCAyLjIxIDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmgxNnYtMmMwLTIuNjYtNS4zMy00LTgtNHoiLz4KPC9zdmc+Cjwvc3ZnPgo='">
                        <div class="info">
                            <h4 class="mb-1" style="color:var(--accent2);">Nguyễn Văn A</h4>
                            <div><i class="fas fa-envelope me-2"></i> nguyenvana@email.com</div>
                            <div><i class="fas fa-briefcase me-2"></i> Nhân viên lễ tân</div>
                            <div><i class="fas fa-id-card me-2"></i> Mã NV: NV001</div>
                        </div>
                    </div>
                </div>
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title">Biểu đồ chấm công tháng này</div>
                        <canvas id="attendanceChart" height="80"></canvas>
                    </div>
                </div>
            </section>
            <!-- Chấm công -->
            <section id="attendance-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="card-title">Chấm công hôm nay</div>
                            <button class="btn btn-primary" onclick="showTimesheet()">
                                <i class="fas fa-clock me-2"></i>Hệ thống chấm công
                            </button>
                        </div>
                        
                        <!-- Quick check in/out -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5>Check In</h5>
                                        <p class="h4" id="checkinTime">--:--</p>
                                        <button class="btn btn-success" onclick="quickCheckIn()">Check In</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5>Check Out</h5>
                                        <p class="h4" id="checkoutTime">--:--</p>
                                        <button class="btn btn-danger" onclick="quickCheckOut()">Check Out</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-title mb-2">Trạng thái hôm nay</div>
                        <div id="todayStatus" class="mb-3">
                            <p class="text-muted">Chưa có dữ liệu hôm nay</p>
                        </div>

                        <hr style="border-color:var(--border);">
                        <div class="card-title mb-2">Lịch sử chấm công</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Ngày</th>
                                        <th>Check In</th>
                                        <th>Check Out</th>
                                        <th>Giờ làm việc</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-body">
                                    <!-- Dữ liệu sẽ được load bằng JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Xin nghỉ phép -->
            <section id="leave-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="card-title">Xin nghỉ phép</div>
                            <button class="btn btn-info btn-sm" onclick="loadLeaveHistory()" title="Làm mới dữ liệu">
                                <i class="fas fa-sync-alt me-1"></i> Làm mới
                            </button>
                        </div>
                        <form class="row g-2 align-items-end mb-3" onsubmit="requestLeave(event)">
                            <div class="col-md-3">
                                <label class="form-label">Ngày nghỉ</label>
                                <input type="date" id="leave-date" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Loại nghỉ</label>
                                <select id="leave-type" class="form-select" required>
                                    <option value="">Chọn loại nghỉ</option>
                                    <option value="Nghỉ phép năm">Nghỉ phép năm</option>
                                    <option value="Nghỉ ốm">Nghỉ ốm</option>
                                    <option value="Nghỉ việc riêng">Nghỉ việc riêng</option>
                                    <option value="Nghỉ thai sản">Nghỉ thai sản</option>
                                    <option value="Nghỉ tang lễ">Nghỉ tang lễ</option>
                                    <option value="Nghỉ khẩn cấp">Nghỉ khẩn cấp</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Lý do</label>
                                <input type="text" id="leave-reason" class="form-control" placeholder="Nhập lý do nghỉ..." required>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success w-100" type="submit"><i class="fas fa-paper-plane me-1"></i> Gửi yêu cầu</button>
                            </div>
                        </form>
                        
                        <!-- Thông tin số ngày phép còn lại -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="card text-center" style="background: linear-gradient(135deg, #28a745, #20c997);">
                                    <div class="card-body">
                                        <h5 class="text-white">Phép năm còn lại</h5>
                                        <p class="h3 text-white" id="remainingAnnualLeave">12</p>
                                        <small class="text-white">ngày</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">
                                    <div class="card-body">
                                        <h5 class="text-white">Đã sử dụng</h5>
                                        <p class="h3 text-white" id="usedLeave">3</p>
                                        <small class="text-white">ngày</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);">
                                    <div class="card-body">
                                        <h5 class="text-white">Tổng phép năm</h5>
                                        <p class="h3 text-white" id="totalAnnualLeave">15</p>
                                        <small class="text-white">ngày</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-title mb-2">Lịch sử xin nghỉ phép</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Ngày</th>
                                        <th>Loại nghỉ</th>
                                        <th>Lý do</th>
                                        <th>Trạng thái</th>
                                        <th>Người duyệt</th>
                                        <th>Ngày gửi</th>
                                    </tr>
                                </thead>
                                <tbody id="leave-body">
                                    <!-- Dữ liệu sẽ được load bằng JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Check-in/out -->
            <section id="checkin-section" style="display:none;">
                <!-- ...giữ nguyên nội dung check-in/out... -->
            </section>
            <!-- Buồng phòng -->
            <section id="housekeeping-section" style="display:none;">
                <!-- ...giữ nguyên nội dung buồng phòng... -->
            </section>
            <!-- Phản hồi -->
            <section id="feedback-section" style="display:none;">
                <!-- ...giữ nguyên nội dung phản hồi... -->
            </section>
            <!-- Thống kê -->
            <section id="stats-section" style="display:none;">
                <!-- ...giữ nguyên nội dung thống kê... -->
            </section>

            <!-- Section: Quản lý đặt phòng -->
            <section id="booking-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                            <div class="card-title mb-0"><i class="fas fa-bed me-2"></i>Quản lý đặt phòng</div>
                            <div class="d-flex gap-2">
                                <select id="bookingStatusFilter" class="form-select form-select-sm" style="max-width: 200px;">
                                    <option value="all" selected>Tất cả trạng thái</option>
                                    <option value="pending">Chờ xác nhận</option>
                                    <option value="confirmed">Đã xác nhận</option>
                                    <option value="cancelled">Đã hủy</option>
                                    <option value="completed">Hoàn thành</option>
                                </select>
                                <input type="text" id="bookingSearchInput" class="form-control form-control-sm" style="max-width: 250px;" placeholder="Tìm kiếm booking...">
                                <button class="btn btn-primary btn-sm" onclick="showAddBookingModal()">
                                    <i class="fas fa-plus-circle me-1"></i> Thêm đặt phòng
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Khách hàng</th>
                                        <th>Email</th>
                                        <th>Số điện thoại</th>
                                        <th>Khách sạn</th>
                                        <th>Dịch vụ</th>
                                        <th>Check-in</th>
                                        <th>Check-out</th>
                                        <th>Số khách</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="booking-table-body">
                                    <tr>
                                        <td colspan="11" class="text-center py-5">Đang tải dữ liệu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Check-in/Check-out -->
            <section id="checkin-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-sign-in-alt me-2"></i>Quản lý Check-in/Check-out</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Phòng</th>
                                        <th>Khách</th>
                                        <th>Ngày đến</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="checkin-table-body">
                                    <tr>
                                        <td>101</td>
                                        <td>Nguyễn Văn B</td>
                                        <td>2024-06-10</td>
                                        <td><span class="badge bg-info">Chờ check-in</span></td>
                                        <td><button class="btn btn-sm btn-success">Check-in</button></td>
                                    </tr>
                                    <tr>
                                        <td>102</td>
                                        <td>Trần Thị C</td>
                                        <td>2024-06-11</td>
                                        <td><span class="badge bg-secondary">Đã check-in</span></td>
                                        <td><button class="btn btn-sm btn-warning">Check-out</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Giao việc buồng phòng -->
            <section id="housekeeping-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-broom me-2"></i>Giao việc buồng phòng</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Phòng</th>
                                        <th>Công việc</th>
                                        <th>Trạng thái</th>
                                        <th>Nhân viên</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="housekeeping-table-body">
                                    <tr>
                                        <td>101</td>
                                        <td>Dọn phòng</td>
                                        <td><span class="badge bg-warning">Chờ làm</span></td>
                                        <td>Nguyễn Văn D</td>
                                        <td><button class="btn btn-sm btn-primary">Xác nhận hoàn thành</button></td>
                                    </tr>
                                    <tr>
                                        <td>102</td>
                                        <td>Sửa điều hòa</td>
                                        <td><span class="badge bg-success">Đã xong</span></td>
                                        <td>Trần Thị E</td>
                                        <td><button class="btn btn-sm btn-secondary" disabled>Đã xác nhận</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Phản hồi khách -->
            <section id="feedback-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-comment-dots me-2"></i>Phản hồi từ khách</div>
                        <div class="table-responsive">
                            <table class="table table-modern table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Khách hàng</th>
                                        <th>Phòng</th>
                                        <th>Nội dung</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="feedback-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">Chưa có phản hồi nào từ khách hàng.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Thống kê cá nhân -->
            <section id="stats-section" style="display:none;">
                <div class="card-modern mb-4">
                    <div class="card-body">
                        <div class="card-title"><i class="fas fa-chart-bar me-2"></i>Thống kê năng suất cá nhân</div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-bed"></i></div>
                                    <div class="stat-label">Đặt phòng đã xử lý</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-sign-in-alt"></i></div>
                                    <div class="stat-label">Check-in/out đã hỗ trợ</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="stat-card">
                                    <div class="stat-icon"><i class="fas fa-comment-dots"></i></div>
                                    <div class="stat-label">Phản hồi khách đã xử lý</div>
                                    <div class="stat-value">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <canvas id="personalStatsChart" height="80"></canvas>
                            <div class="text-center text-muted mt-3" id="stats-empty-message">
                                Chưa có dữ liệu thống kê cá nhân.
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Hệ thống chấm công -->
    <div class="modal fade" id="timesheetModal" tabindex="-1" aria-labelledby="timesheetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="timesheetModalLabel">Hệ thống Chấm công</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="list-group" role="tablist">
                                <a class="list-group-item list-group-item-action active" data-bs-toggle="list" href="#timesheet-overview" role="tab">
                                    <i class="fas fa-calendar-alt me-2"></i>Lịch làm việc tháng này
                                </a>
                               
                                <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#timesheet-schedule" role="tab">
                                    <i class="fas fa-calendar-plus me-2"></i>Lịch làm việc
                                </a>
                                <a class="list-group-item list-group-item-action" data-bs-toggle="list" href="#timesheet-report" role="tab">
                                    <i class="fas fa-chart-line me-2"></i>Báo cáo chấm công
                                </a>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="tab-content">
                                <!-- Tab Lịch làm việc tháng này -->
                                <div class="tab-pane fade show active" id="timesheet-overview" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6>Lịch làm việc tháng này</h6>
                                        <button class="btn btn-primary btn-sm" onclick="showCreateScheduleModal()">
                                            <i class="fas fa-plus"></i> Tạo lịch
                                        </button>
                                    </div>
                                    <table class="table table-modern table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Ngày</th>
                                                <th>Ca làm việc</th>
                                                <th>Giờ bắt đầu</th>
                                                <th>Giờ kết thúc</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scheduleTableBody">
                                            <tr>
                                                <td>01/08/2025</td>
                                                <td>Ca sáng</td>
                                                <td>08:00</td>
                                                <td>17:00</td>
                                                <td><span class="badge bg-success">Đã hoàn thành</span></td>
                                            </tr>
                                            <tr>
                                                <td>02/08/2025</td>
                                                <td>Ca sáng</td>
                                                <td>08:00</td>
                                                <td>17:00</td>
                                                <td><span class="badge bg-primary">Đang làm việc</span></td>
                                            </tr>
                                            <tr>
                                                <td>04/08/2025</td>
                                                <td>Ca sáng</td>
                                                <td>08:00</td>
                                                <td>17:00</td>
                                                <td><span class="badge bg-info">Hôm nay</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Tab Check in/out -->
                                <div class="tab-pane fade" id="checkin-checkout" role="tabpanel">
                                    <h6>Check in/out hôm nay</h6>
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h5>Check In</h5>
                                                    <p class="h4" id="modalCheckinTime">--:--</p>
                                                    <button class="btn btn-success" onclick="checkIn()">Check In</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h5>Check Out</h5>
                                                    <p class="h4" id="modalCheckoutTime">--:--</p>
                                                    <button class="btn btn-danger" onclick="checkOut()">Check Out</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="modalTodayStatus">
                                        <p class="text-muted">Chưa có dữ liệu hôm nay</p>
                                    </div>
                                </div>
                                
                                <!-- Tab Lịch làm việc -->
                                <div class="tab-pane fade" id="timesheet-schedule" role="tabpanel">
                                    <h6>Quản lý lịch làm việc</h6>
                                    <div class="mb-3">
                                        <button class="btn btn-primary" onclick="showCreateScheduleModal()">
                                            <i class="fas fa-plus"></i> Tạo lịch mới
                                        </button>
                                    </div>
                                    <table class="table table-modern table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tuần</th>
                                                <th>Ngày bắt đầu</th>
                                                <th>Ngày kết thúc</th>
                                                <th>Tổng giờ</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Tuần 31</td>
                                                <td>29/07/2025</td>
                                                <td>02/08/2025</td>
                                                <td>40 giờ</td>
                                                <td><span class="badge bg-success">Hoàn thành</span></td>
                                            </tr>
                                            <tr>
                                                <td>Tuần 32</td>
                                                <td>03/08/2025</td>
                                                <td>09/08/2025</td>
                                                <td>40 giờ</td>
                                                <td><span class="badge bg-warning">Đang thực hiện</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Tab Báo cáo -->
                                <div class="tab-pane fade" id="timesheet-report" role="tabpanel">
                                    <h6>Báo cáo chấm công</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 style="color: var(--accent2);" id="totalWorkHours">160</h5>
                                                    <p class="mb-0">Tổng giờ tháng này</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 style="color: #28a745;" id="totalWorkDays">22</h5>
                                                    <p class="mb-0">Ngày làm việc</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 style="color: #ffc107;" id="attendanceRate">95%</h5>
                                                    <p class="mb-0">Tỷ lệ chấm công</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tạo lịch làm việc -->
    <div class="modal fade" id="createScheduleModal" tabindex="-1" aria-labelledby="createScheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form class="modal-content" id="createScheduleForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="createScheduleModalLabel">Tạo lịch làm việc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="scheduleDate" class="form-label">Ngày làm việc</label>
                        <input type="date" class="form-control" id="scheduleDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="scheduleShift" class="form-label">Ca làm việc</label>
                        <select class="form-control" id="scheduleShift" required>
                            <option value="Sáng">Ca sáng (08:00 - 12:00)</option>
                            <option value="Chiều">Ca chiều (13:00 - 17:00)</option>
                            <option value="Tối">Ca tối (18:00 - 22:00)</option>
                            <option value="Toàn thời gian">Toàn thời gian (08:00 - 17:00)</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleStartTime" class="form-label">Giờ bắt đầu</label>
                                <input type="time" class="form-control" id="scheduleStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleEndTime" class="form-label">Giờ kết thúc</label>
                                <input type="time" class="form-control" id="scheduleEndTime" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Tạo lịch</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase App (core) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // Phân quyền mẫu
        // Các giá trị: 'receptionist', 'manager', 'housekeeping', 'marketing', ...
        const userRole = 'receptionist'; // Đổi giá trị này để test các vai trò khác nhau
        const userName = 'Nguyễn Văn A';
        const userManager = 'Trần Thị B'; // Trưởng phòng

        // Hiển thị vai trò trên header
        document.addEventListener('DOMContentLoaded', function() {
            // Thêm vai trò vào header
            const header = document.querySelector('.main-header .user-info');
            if (header && !document.getElementById('role-badge')) {
                const badge = document.createElement('span');
                badge.id = 'role-badge';
                badge.className = 'badge bg-info';
                badge.style.marginLeft = '8px';
                badge.textContent =
                    userRole === 'manager' ? 'Trưởng phòng' :
                    userRole === 'receptionist' ? 'Lễ tân' :
                    userRole === 'housekeeping' ? 'Buồng phòng' :
                    userRole === 'marketing' ? 'Marketing' : userRole;
                header.appendChild(badge);
            }
        });

        // Sidebar navigation
        function showSection(section) {
            document.getElementById('profile-section').style.display = 'none';
            document.getElementById('attendance-section').style.display = 'none';
            document.getElementById('leave-section').style.display = 'none';
            document.getElementById('booking-section').style.display = 'none';
            document.getElementById('checkin-section').style.display = 'none';
            document.getElementById('housekeeping-section').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('stats-section').style.display = 'none';
            document.querySelectorAll('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
            if (section === 'profile') {
                document.getElementById('profile-section').style.display = '';
                document.querySelector('.sidebar .nav-item[href="#profile"]').classList.add('active');
            } else if (section === 'attendance') {
                document.getElementById('attendance-section').style.display = '';
                document.querySelector('.sidebar .nav-item[href="#attendance"]').classList.add('active');
            } else if (section === 'leave') {
                document.getElementById('leave-section').style.display = '';
                document.querySelector('.sidebar .nav-item[href="#leave"]').classList.add('active');
                loadLeaveHistory(); // Load dữ liệu khi vào trang nghỉ phép
            } else if (section === 'booking') {
                console.log('🎯 Showing booking section...');
                const bookingSection = document.getElementById('booking-section');
                bookingSection.style.display = '';
                console.log('📋 Booking section display style:', bookingSection.style.display);
                document.querySelector('.sidebar .nav-item.booking').classList.add('active');
                loadBookings(); // Load dữ liệu khi vào trang đặt phòng
            } else if (section === 'checkin') {
                document.getElementById('checkin-section').style.display = '';
                document.querySelector('.sidebar .nav-item.checkin').classList.add('active');
            } else if (section === 'housekeeping') {
                document.getElementById('housekeeping-section').style.display = '';
                document.querySelector('.sidebar .nav-item.housekeeping').classList.add('active');
            } else if (section === 'feedback') {
                document.getElementById('feedback-section').style.display = '';
                document.querySelector('.sidebar .nav-item.feedback').classList.add('active');
                loadFeedbackData(); // Load dữ liệu phản hồi từ Firebase
            } else if (section === 'stats') {
                document.getElementById('stats-section').style.display = '';
                document.querySelector('.sidebar .nav-item.stats').classList.add('active');
                loadStatisticsData(); // Load dữ liệu thống kê từ Firebase
            }
        }

        // ...existing code...

        // Ẩn/hiện form chấm công theo lựa chọn địa điểm
        document.addEventListener('DOMContentLoaded', function() {
            showSection('profile');
            loadTodayStatusMain();
            
            // Kiểm tra định kỳ cập nhật trạng thái nghỉ phép từ admin (mỗi 10 giây)
            setInterval(() => {
                if (document.getElementById('leave-section').style.display !== 'none') {
                    loadLeaveHistory();
                }
            }, 10000);
            
            // Attendance chart demo
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22'],
                    datasets: [{
                        label: 'Giờ vào',
                        data: [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124,58,237,0.2)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Giờ ra',
                        data: [17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17],
                        borderColor: '#00eaff',
                        backgroundColor: 'rgba(0,234,255,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        x: { ticks: { color: '#b0b8d1' }, grid: { color: '#2e325a' } },
                        y: { ticks: { color: '#b0b8d1' }, grid: { color: '#2e325a' } }
                    }
                }
            });

            // Thống kê cá nhân Chart.js
            if (document.getElementById('personalStatsChart')) {
                window.personalStatsChart = new Chart(document.getElementById('personalStatsChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Đặt phòng', 'Check-in/out', 'Phản hồi'],
                        datasets: [{
                            label: 'Số lượt xử lý',
                            data: [0, 0, 0], // Sẽ được cập nhật từ Firebase
                            backgroundColor: [
                                '#ffb300', '#00eaff', '#ff4081'
                            ]
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#fff' }, grid: { color: '#2e325a' } },
                            y: { ticks: { color: '#fff' }, grid: { color: '#2e325a' } }
                        }
                    }
                });
            }
        });
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.appspot.com",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };
        
        // Khởi tạo Firebase (chỉ nếu chưa được khởi tạo)
        if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        }
        
        // Đăng nhập tự động khi trang load (demo)
        firebase.auth().onAuthStateChanged(function(user) {
            if (!user) {
                // Nếu chưa đăng nhập, tạo user ẩn danh hoặc đăng nhập demo
                firebase.auth().signInAnonymously().then(() => {
                    console.log('Đăng nhập ẩn danh thành công');
                }).catch((error) => {
                    console.error('Lỗi đăng nhập ẩn danh:', error);
                    // Fallback: đăng nhập với email demo
                    firebase.auth().signInWithEmailAndPassword('staff@demo.com', 'password123').catch(() => {
                        console.warn('Không thể đăng nhập Firebase Auth');
                    });
                });
            } else {
                console.log('User đã đăng nhập:', user.uid);
            }
        });
        
        // Đăng xuất với Firebase Auth
        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                // Kiểm tra xem Firebase Auth có sẵn không
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().signOut().then(() => {
                        console.log('Đăng xuất thành công');
                        window.location.href = '../auth.html';
                    }).catch((error) => {
                        console.error('Lỗi đăng xuất:', error);
                        // Vẫn chuyển trang nếu có lỗi
                        window.location.href = '../auth.html';
                    });
                } else {
                    // Fallback nếu Firebase không có
                    window.location.href = '../auth.html';
                }
            }
        }

        // === CHỨC NĂNG XIN NGHỈ PHÉP ===
        
        // Dữ liệu nghỉ phép (Local Storage)
        function getLeaveRequests() {
            return JSON.parse(localStorage.getItem('leaveRequests') || '[]');
        }
        
        function setLeaveRequests(requests) {
            localStorage.setItem('leaveRequests', JSON.stringify(requests));
        }
        
        // Xử lý form xin nghỉ phép
        window.requestLeave = function(event) {
            // Kiểm tra đăng nhập Firebase
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                alert('Bạn cần đăng nhập lại để sử dụng chức năng này!');
                return;
            }
            event.preventDefault();
            const date = document.getElementById('leave-date').value;
            const type = document.getElementById('leave-type').value;
            const reason = document.getElementById('leave-reason').value;
            if (!date || !type || !reason) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            // Kiểm tra ngày nghỉ phải từ hôm nay trở đi
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (selectedDate < today) {
                alert('Ngày nghỉ phải từ hôm nay trở đi!');
                return;
            }
            // Tạo yêu cầu nghỉ phép mới (đúng định dạng rule Firebase)
            const newRequest = {
                employeeId: getCurrentEmployeeId(),
                startDate: date,
                endDate: date, // Nếu chỉ nghỉ 1 ngày, startDate = endDate
                reason: reason,
                status: 'pending', // Rule chỉ cho phép 'pending', 'approved', 'rejected'
                createdAt: Date.now(),
                // Các trường phụ không bắt buộc, giữ lại nếu muốn
                type: type,
                employeeName: userName
            };
            
            console.log('📝 Creating new leave request:', newRequest);
            // Lưu localStorage (giữ lại cho tương thích cũ)
            const requests = getLeaveRequests();
            requests.push(newRequest);
            setLeaveRequests(requests);
            // Lưu lên Firebase
            firebase.database().ref('leaveRequests').push(newRequest, function(error) {
                if (error) {
                    alert('Lỗi khi gửi yêu cầu lên hệ thống!');
                } else {
                    // Thêm vào bảng
                    addLeaveRequestToTable(newRequest);
                    // Reset form
                    document.getElementById('leave-date').value = '';
                    document.getElementById('leave-type').value = '';
                    document.getElementById('leave-reason').value = '';
                    // Hiển thị thông báo
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Gửi yêu cầu thành công!',
                            text: 'Yêu cầu nghỉ phép đã được gửi đến quản lý. Bạn sẽ nhận được phản hồi trong vòng 24 giờ.',
                            timer: 3000,
                            showConfirmButton: false
                        });
                    } else {
                        alert('Đã gửi yêu cầu nghỉ phép thành công!\nYêu cầu sẽ được xem xét trong vòng 24 giờ.');
                    }
                }
            });
        };
        
        // Thêm yêu cầu nghỉ phép vào bảng
        function addLeaveRequestToTable(request) {
            const tbody = document.getElementById('leave-body');
            const row = document.createElement('tr');
            
            // Map status từ Firebase sang tiếng Việt
            const statusMap = {
                'pending': 'Chờ duyệt',
                'approved': 'Đã duyệt', 
                'rejected': 'Từ chối'
            };
            
            const displayStatus = statusMap[request.status] || request.status;
            const statusClass = 
                request.status === 'approved' ? 'bg-success' :
                request.status === 'rejected' ? 'bg-danger' : 'bg-warning';
            
            // Sử dụng startDate thay vì date
            const displayDate = request.startDate || request.date || '';
            const submittedDate = request.createdAt ? new Date(request.createdAt).toLocaleDateString('vi-VN') : 
                                 request.submittedDate ? new Date(request.submittedDate).toLocaleDateString('vi-VN') : '';
            
            row.innerHTML = `
                <td>${displayDate ? new Date(displayDate).toLocaleDateString('vi-VN') : '--'}</td>
                <td>${request.type || '--'}</td>
                <td>${request.reason || '--'}</td>
                <td><span class="badge ${statusClass}">${displayStatus}</span></td>
                <td>${request.approver || '--'}</td>
                <td>${submittedDate}</td>
            `;
            
            tbody.insertAdjacentElement('afterbegin', row);
        }
        
        // Load lịch sử xin nghỉ phép với real-time updates
        function loadLeaveHistory() {
            const tbody = document.getElementById('leave-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">Đang tải dữ liệu...</td></tr>';
            
            const currentEmployeeId = getCurrentEmployeeId();
            console.log('🔍 Loading leave history for employee:', currentEmployeeId);
            
            // Lắng nghe thay đổi real-time từ Firebase
            firebase.database().ref('leaveRequests').orderByChild('employeeId').equalTo(currentEmployeeId).on('value', function(snapshot) {
                const requests = [];
                snapshot.forEach(function(child) {
                    requests.push({ ...child.val(), firebaseKey: child.key });
                });
                
                // Xóa dữ liệu cũ
                tbody.innerHTML = '';
                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">Chưa có yêu cầu nghỉ phép nào</td></tr>';
                    updateLeaveStats([]);
                    return;
                }
                
                // Sắp xếp theo ngày tạo mới nhất
                requests.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                requests.forEach(request => {
                    addLeaveRequestToTable(request);
                });
                updateLeaveStats(requests);
                checkForLeaveStatusUpdates(requests);
            }, function(error) {
                console.error('Error loading leave requests:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-danger">Lỗi tải dữ liệu!</td></tr>';
            });
        }
        
        // Kiểm tra cập nhật trạng thái từ admin
        function checkForLeaveStatusUpdates(requests) {
            const lastChecked = localStorage.getItem('lastLeaveCheck');
            const currentTime = new Date().getTime();
            
            console.log('🔍 Checking for updates:', {
                lastChecked: lastChecked,
                currentTime: currentTime,
                requests: requests
            });
            
            if (lastChecked) {
                const newlyProcessed = requests.filter(r => {
                    // Sử dụng approvedAt hoặc rejectedAt từ Firebase
                    const processedTime = r.approvedAt ? r.approvedAt : (r.rejectedAt ? r.rejectedAt : 0);
                    const isNewlyProcessed = processedTime > parseInt(lastChecked) && r.status !== 'pending';
                    
                    console.log('🧐 Request check:', {
                        firebaseKey: r.firebaseKey,
                        status: r.status,
                        approvedAt: r.approvedAt,
                        rejectedAt: r.rejectedAt,
                        processedTime: processedTime,
                        lastChecked: parseInt(lastChecked),
                        isNewlyProcessed: isNewlyProcessed
                    });
                    
                    return isNewlyProcessed;
                });
                
                console.log('🆕 Newly processed requests:', newlyProcessed);
                
                newlyProcessed.forEach(request => {
                    if (typeof Swal !== 'undefined') {
                        const icon = request.status === 'approved' ? 'success' : 'error';
                        const title = request.status === 'approved' ? '✅ Yêu cầu được duyệt!' : '❌ Yêu cầu bị từ chối';
                        let text = `Yêu cầu nghỉ ${request.type || 'phép'} từ ngày ${request.startDate ? new Date(request.startDate).toLocaleDateString('vi-VN') : '--'} đã được ${request.status === 'approved' ? 'duyệt' : 'từ chối'}.`;
                        
                        if (request.rejectionReason) {
                            text += `\n\nLý do từ chối: ${request.rejectionReason}`;
                        }
                        
                        if (request.approver) {
                            text += `\n\nNgười duyệt: ${request.approver}`;
                        }
                        
                        Swal.fire({
                            icon: icon,
                            title: title,
                            text: text,
                            timer: 10000,
                            showConfirmButton: true,
                            confirmButtonText: 'Đã hiểu'
                        });
                    } else {
                        // Fallback alert nếu không có SweetAlert
                        const message = request.status === 'approved' ? 
                            `✅ Yêu cầu nghỉ phép đã được duyệt!\nNgày: ${request.startDate ? new Date(request.startDate).toLocaleDateString('vi-VN') : '--'}\nLoại: ${request.type || 'phép'}` :
                            `❌ Yêu cầu nghỉ phép bị từ chối!\nNgày: ${request.startDate ? new Date(request.startDate).toLocaleDateString('vi-VN') : '--'}\nLoại: ${request.type || 'phép'}${request.rejectionReason ? '\nLý do: ' + request.rejectionReason : ''}`;
                        alert(message);
                    }
                });
            }
            
            localStorage.setItem('lastLeaveCheck', currentTime.toString());
        }
        
        // Cập nhật thống kê phép
        function updateLeaveStats(requests) {
            const currentYear = new Date().getFullYear();
            const approvedRequests = requests.filter(r => 
                r.status === 'approved' && 
                r.startDate && new Date(r.startDate).getFullYear() === currentYear &&
                (r.type === 'Nghỉ phép năm' || !r.type || r.type.includes('phép'))
            );
            
            const usedDays = approvedRequests.length;
            const totalDays = 15; // Tổng số ngày phép năm
            const remainingDays = totalDays - usedDays;
            
            const usedElement = document.getElementById('usedLeave');
            const remainingElement = document.getElementById('remainingAnnualLeave');
            const totalElement = document.getElementById('totalAnnualLeave');
            
            if (usedElement) usedElement.textContent = usedDays;
            if (remainingElement) remainingElement.textContent = Math.max(0, remainingDays);
            if (totalElement) totalElement.textContent = totalDays;
        }

        // === CHỨC NĂNG CHẤM CÔNG ===
        
        // Dữ liệu chấm công (Local Storage)
        function getAttendances() {
            return JSON.parse(localStorage.getItem('attendances') || '[]');
        }
        
        function setAttendances(attendances) {
            localStorage.setItem('attendances', JSON.stringify(attendances));
        }
        
        function getCurrentEmployeeId() {
            // Return a fixed employee ID for demo purposes
            // In production, this should be the actual employee ID from user profile
            return 'NV001'; // Fixed ID for demo
        }
        
        // Hiển thị modal chấm công
        window.showTimesheet = function() {
            const timesheetModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('timesheetModal'));
            timesheetModal.show();
            loadTimesheetData();
        };
        
        // Quick check in/out cho trang chính
        window.quickCheckIn = function() {
            checkIn();
            loadTodayStatusMain();
        };
        
        window.quickCheckOut = function() {
            checkOut();
            loadTodayStatusMain();
        };
        
        // Check in
        window.checkIn = function() {
            const attendances = getAttendances();
            const today = new Date().toDateString();
            const existing = attendances.find(a => new Date(a.date).toDateString() === today && a.employeeId === getCurrentEmployeeId());
            
            if (existing && existing.checkIn) {
                alert('Bạn đã check in hôm nay!');
                return;
            }
            
            const checkInTime = new Date();
            if (existing) {
                existing.checkIn = checkInTime.toISOString();
            } else {
                attendances.push({
                    id: Date.now(),
                    employeeId: getCurrentEmployeeId(),
                    date: checkInTime.toISOString(),
                    checkIn: checkInTime.toISOString()
                });
            }
            
            setAttendances(attendances);
            loadTodayStatusMain();
            loadTodayStatusModal();
            alert(`Check in thành công lúc ${checkInTime.toLocaleTimeString('vi-VN')}`);
        };
        
        // Check out
        window.checkOut = function() {
            const attendances = getAttendances();
            const today = new Date().toDateString();
            const existing = attendances.find(a => new Date(a.date).toDateString() === today && a.employeeId === getCurrentEmployeeId());
            
            if (!existing || !existing.checkIn) {
                alert('Bạn chưa check in hôm nay!');
                return;
            }
            
            if (existing.checkOut) {
                alert('Bạn đã check out hôm nay!');
                return;
            }
            
            const checkOutTime = new Date();
            existing.checkOut = checkOutTime.toISOString();
            
            // Tính giờ làm việc
            const workHours = (new Date(existing.checkOut) - new Date(existing.checkIn)) / (1000 * 60 * 60);
            existing.workHours = workHours.toFixed(2);
            
            setAttendances(attendances);
            loadTodayStatusMain();
            loadTodayStatusModal();
            alert(`Check out thành công lúc ${checkOutTime.toLocaleTimeString('vi-VN')}\nTổng giờ làm: ${workHours.toFixed(2)} giờ`);
        };
        
        // Load trạng thái hôm nay (trang chính)
        function loadTodayStatusMain() {
            const attendances = getAttendances();
            const today = new Date().toDateString();
            const todayRecord = attendances.find(a => new Date(a.date).toDateString() === today && a.employeeId === getCurrentEmployeeId());
            
            const checkinTimeEl = document.getElementById('checkinTime');
            const checkoutTimeEl = document.getElementById('checkoutTime');
            const statusEl = document.getElementById('todayStatus');
            
            if (checkinTimeEl) {
                checkinTimeEl.textContent = todayRecord && todayRecord.checkIn ? 
                    new Date(todayRecord.checkIn).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '--:--';
            }
            
            if (checkoutTimeEl) {
                checkoutTimeEl.textContent = todayRecord && todayRecord.checkOut ? 
                    new Date(todayRecord.checkOut).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '--:--';
            }
            
            if (statusEl) {
                const statusHtml = todayRecord ? `
                    <p><strong>Check in:</strong> ${todayRecord.checkIn ? new Date(todayRecord.checkIn).toLocaleTimeString('vi-VN') : 'Chưa check in'}</p>
                    <p><strong>Check out:</strong> ${todayRecord.checkOut ? new Date(todayRecord.checkOut).toLocaleTimeString('vi-VN') : 'Chưa check out'}</p>
                    <p><strong>Giờ làm:</strong> ${todayRecord.workHours || '0'} giờ</p>
                ` : '<p class="text-muted">Chưa có dữ liệu hôm nay</p>';
                
                statusEl.innerHTML = statusHtml;
            }
            
            loadAttendanceHistory();
        }
        
        // Load trạng thái hôm nay (modal)
        function loadTodayStatusModal() {
            const attendances = getAttendances();
            const today = new Date().toDateString();
            const todayRecord = attendances.find(a => new Date(a.date).toDateString() === today && a.employeeId === getCurrentEmployeeId());
            
            const modalCheckinTimeEl = document.getElementById('modalCheckinTime');
            const modalCheckoutTimeEl = document.getElementById('modalCheckoutTime');
            const modalStatusEl = document.getElementById('modalTodayStatus');
            
            if (modalCheckinTimeEl) {
                modalCheckinTimeEl.textContent = todayRecord && todayRecord.checkIn ? 
                    new Date(todayRecord.checkIn).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '--:--';
            }
            
            if (modalCheckoutTimeEl) {
                modalCheckoutTimeEl.textContent = todayRecord && todayRecord.checkOut ? 
                    new Date(todayRecord.checkOut).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'}) : '--:--';
            }
            
            if (modalStatusEl) {
                const statusHtml = todayRecord ? `
                    <p><strong>Check in:</strong> ${todayRecord.checkIn ? new Date(todayRecord.checkIn).toLocaleTimeString('vi-VN') : 'Chưa check in'}</p>
                    <p><strong>Check out:</strong> ${todayRecord.checkOut ? new Date(todayRecord.checkOut).toLocaleTimeString('vi-VN') : 'Chưa check out'}</p>
                    <p><strong>Giờ làm:</strong> ${todayRecord.workHours || '0'} giờ</p>
                ` : '<p class="text-muted">Chưa có dữ liệu hôm nay</p>';
                
                modalStatusEl.innerHTML = statusHtml;
            }
        }
        
        // Load lịch sử chấm công
        function loadAttendanceHistory() {
            const attendances = getAttendances().filter(a => a.employeeId === getCurrentEmployeeId());
            const tbody = document.getElementById('attendance-body');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Sắp xếp theo ngày mới nhất
            attendances.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            attendances.slice(0, 10).forEach(record => {
                const row = document.createElement('tr');
                const date = new Date(record.date);
                const status = record.checkIn && record.checkOut ? 'Hoàn thành' : 
                             record.checkIn ? 'Đang làm việc' : 'Chưa check in';
                const statusClass = record.checkIn && record.checkOut ? 'bg-success' : 
                                  record.checkIn ? 'bg-primary' : 'bg-secondary';
                
                row.innerHTML = `
                    <td>${date.toLocaleDateString('vi-VN')}</td>
                    <td>${record.checkIn ? new Date(record.checkIn).toLocaleTimeString('vi-VN') : '--'}</td>
                    <td>${record.checkOut ? new Date(record.checkOut).toLocaleTimeString('vi-VN') : '--'}</td>
                    <td>${record.workHours || '0'} giờ</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Load dữ liệu chấm công cho modal
        function loadTimesheetData() {
            loadTodayStatusModal();
            updateMonthlyStats();
        }
        
        // Cập nhật thống kê tháng
        function updateMonthlyStats() {
            const attendances = getAttendances().filter(a => a.employeeId === getCurrentEmployeeId());
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyData = attendances.filter(a => {
                const date = new Date(a.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const totalWorkDays = monthlyData.filter(a => a.checkIn && a.checkOut).length;
            const totalWorkHours = monthlyData.reduce((sum, a) => sum + (parseFloat(a.workHours) || 0), 0);
            const attendanceRate = totalWorkDays > 0 ? ((totalWorkDays / new Date().getDate()) * 100).toFixed(0) : 0;
            
            const totalWorkHoursEl = document.getElementById('totalWorkHours');
            const totalWorkDaysEl = document.getElementById('totalWorkDays');
            const attendanceRateEl = document.getElementById('attendanceRate');
            
            if (totalWorkHoursEl) totalWorkHoursEl.textContent = totalWorkHours.toFixed(0);
            if (totalWorkDaysEl) totalWorkDaysEl.textContent = totalWorkDays;
            if (attendanceRateEl) attendanceRateEl.textContent = attendanceRate + '%';
        }
        
        // Hiển thị modal tạo lịch làm việc
        window.showCreateScheduleModal = function() {
            const createScheduleModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('createScheduleModal'));
            createScheduleModal.show();
        };

        // ===== BOOKING MANAGEMENT FUNCTIONS =====
        let allBookings = [];

            // Load bookings data from Firebase
            function loadBookings() {
                console.log('🔄 Loading bookings data...');
                const bookingsRef = firebase.database().ref('bookings');
                bookingsRef.on('value', (snapshot) => {
                    allBookings = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const booking = childSnapshot.val();
                            booking.id = childSnapshot.key;
                            allBookings.push(booking);
                            console.log('📋 Loaded booking:', booking.id, booking.type, booking.bookingType, booking.customerName);
                        });
                        allBookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by most recent
                    }
                    console.log('📊 All loaded bookings:', allBookings);
                    filterAndDisplayBookings();
                    console.log('✅ Loaded', allBookings.length, 'bookings');
                }, (error) => {
                    console.error("❌ Error loading bookings:", error);
                    Swal.fire('Lỗi', 'Không thể tải danh sách đặt phòng.', 'error');
                });
            }

        // Filter and display bookings
        function filterAndDisplayBookings() {
            let filteredBookings = [...allBookings];
            console.log('🔍 Starting filter with', allBookings.length, 'bookings');

            // Search filter
            const searchTerm = document.getElementById('bookingSearchInput').value.toLowerCase().trim();
            if (searchTerm) {
                filteredBookings = filteredBookings.filter(b => 
                    (b.id && b.id.toLowerCase().includes(searchTerm)) ||
                    (b.customerName && b.customerName.toLowerCase().includes(searchTerm)) ||
                    (b.customerEmail && b.customerEmail.toLowerCase().includes(searchTerm)) ||
                    (b.customerPhone && b.customerPhone.includes(searchTerm)) ||
                    (b.hotelName && b.hotelName.toLowerCase().includes(searchTerm))
                );
                console.log('🔍 After search filter:', filteredBookings.length, 'bookings');
            }

            // Status filter
            const statusFilter = document.getElementById('bookingStatusFilter').value;
            if (statusFilter !== 'all') {
                filteredBookings = filteredBookings.filter(b => b.status === statusFilter);
                console.log('🔍 After status filter:', filteredBookings.length, 'bookings');
            }

            // Filter only hotel bookings (exclude tours)
            const beforeHotelFilter = filteredBookings.length;
            filteredBookings = filteredBookings.filter(b => {
                const isHotel = (!b.type && !b.bookingType) || 
                               b.type === 'hotel' || 
                               b.bookingType === 'hotel';
                if (!isHotel) {
                    console.log('🚫 Filtered out non-hotel booking:', b.id, 'type:', b.type, 'bookingType:', b.bookingType);
                }
                return isHotel;
            });
            console.log('🔍 After hotel filter:', filteredBookings.length, 'bookings (removed', beforeHotelFilter - filteredBookings.length, ')');

            console.log('📊 Final filtered bookings:', filteredBookings);
            renderBookingsTable(filteredBookings);
        }

                        // Render bookings table
                function renderBookingsTable(bookings) {
                    console.log('🎨 Rendering table with', bookings.length, 'bookings');
                    const tableBody = document.getElementById('booking-table-body');
                    if (!tableBody) {
                        console.error('❌ Table body element not found!');
                        return;
                    }
                    console.log('✅ Table body found:', tableBody);
                    tableBody.innerHTML = '';

                    if (bookings.length === 0) {
                        console.log('📭 No bookings to display');
                        tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-5">Không tìm thấy dữ liệu phù hợp.</td></tr>';
                        return;
                    }

            bookings.forEach(booking => {
                const row = document.createElement('tr');
                
                // Status Badge
                const statusBadge = `<span class="status status-${booking.status || 'pending'}">${getStatusText(booking.status)}</span>`;
                
                // Service Details
                let serviceDetails = '';
                if (booking.type === 'hotel' || booking.roomId || booking.roomName) {
                    serviceDetails = `
                        <strong title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</strong><br>
                        <small class="text-muted" title="${booking.roomId || booking.roomName || ''}">${booking.roomId || booking.roomName || 'N/A'}</small>
                    `;
                } else if (booking.type === 'tour') {
                    serviceDetails = `
                        <strong title="${booking.tourName || ''}">${booking.tourName || 'Tour'}</strong><br>
                        <small class="text-muted">Tour</small>
                    `;
                } else {
                    serviceDetails = 'Không xác định';
                }

                row.innerHTML = `
                    <td title="${booking.id}">${booking.id}</td>
                    <td title="${booking.customerName || ''}">${booking.customerName || 'N/A'}</td>
                    <td title="${booking.customerEmail || ''}">${booking.customerEmail || 'N/A'}</td>
                    <td title="${booking.customerPhone || ''}">${booking.customerPhone || 'N/A'}</td>
                    <td title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</td>
                    <td>${serviceDetails}</td>
                    <td title="${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : ''}">${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td title="${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : ''}">${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td title="${booking.guests || ''}">${booking.guests || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewBookingDetails('${booking.id}')" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="updateBookingStatus('${booking.id}', 'confirmed')" title="Xác nhận" ${booking.status === 'confirmed' ? 'disabled' : ''}>
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="updateBookingStatus('${booking.id}', 'pending')" title="Chờ xử lý" ${booking.status === 'pending' ? 'disabled' : ''}>
                            <i class="fas fa-clock"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
                console.log('📝 Added row for booking:', booking.id);
            });
            console.log('✅ Table rendering completed. Total rows:', tableBody.children.length);
        }

        // Get status text in Vietnamese
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Chờ xác nhận',
                'confirmed': 'Đã xác nhận',
                'cancelled': 'Đã hủy',
                'completed': 'Hoàn thành'
            };
            return statusMap[status] || 'Chờ xác nhận';
        }

        // View booking details
        window.viewBookingDetails = function(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('Lỗi', 'Không tìm thấy thông tin đặt phòng.', 'error');
                return;
            }

            const detailsHtml = `
                <div class="text-start">
                    <p><strong>ID:</strong> ${booking.id}</p>
                    <p><strong>Khách hàng:</strong> ${booking.customerName || 'N/A'}</p>
                    <p><strong>Email:</strong> ${booking.customerEmail || 'N/A'}</p>
                    <p><strong>Số điện thoại:</strong> ${booking.customerPhone || 'N/A'}</p>
                    <p><strong>Khách sạn:</strong> ${booking.hotelName || 'N/A'}</p>
                    <p><strong>Phòng:</strong> ${booking.roomId || booking.roomName || 'N/A'}</p>
                    <p><strong>Check-in:</strong> ${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</p>
                    <p><strong>Check-out:</strong> ${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : 'N/A'}</p>
                    <p><strong>Số khách:</strong> ${booking.guests || 'N/A'}</p>
                    <p><strong>Trạng thái:</strong> ${getStatusText(booking.status)}</p>
                    <p><strong>Ngày tạo:</strong> ${booking.createdAt ? new Date(booking.createdAt).toLocaleDateString('vi-VN') : 'N/A'}</p>
                </div>
            `;

            Swal.fire({
                title: 'Chi tiết đặt phòng',
                html: detailsHtml,
                icon: 'info',
                confirmButtonText: 'Đóng'
            });
        };

        // Update booking status
        window.updateBookingStatus = function(bookingId, newStatus) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('Lỗi', 'Không tìm thấy thông tin đặt phòng.', 'error');
                return;
            }

            const statusText = getStatusText(newStatus);
            
            Swal.fire({
                title: 'Xác nhận thay đổi',
                text: `Bạn có chắc muốn thay đổi trạng thái đặt phòng ${bookingId} thành "${statusText}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    const bookingRef = firebase.database().ref(`bookings/${bookingId}`);
                    const updateData = {
                        status: newStatus,
                        updatedAt: Date.now(),
                        updatedBy: getCurrentEmployeeId()
                    };

                    bookingRef.update(updateData).then(() => {
                        Swal.fire('Thành công', `Đã cập nhật trạng thái đặt phòng thành "${statusText}"`, 'success');
                    }).catch((error) => {
                        console.error('Error updating booking status:', error);
                        Swal.fire('Lỗi', 'Không thể cập nhật trạng thái đặt phòng.', 'error');
                    });
                }
            });
        };
        
        // Xử lý form tạo lịch làm việc
        document.getElementById('createScheduleForm').onsubmit = function(e) {
            e.preventDefault();
            const date = document.getElementById('scheduleDate').value;
            const shift = document.getElementById('scheduleShift').value;
            const startTime = document.getElementById('scheduleStartTime').value;
            const endTime = document.getElementById('scheduleEndTime').value;

            if (!date || !shift || !startTime || !endTime) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }

            // Thêm lịch làm việc mới vào bảng
            const tableBody = document.getElementById('scheduleTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${new Date(date).toLocaleDateString('vi-VN')}</td>
                <td>${shift}</td>
                <td>${startTime}</td>
                <td>${endTime}</td>
                <td><span class="badge bg-info">Đã lên lịch</span></td>
            `;
            tableBody.appendChild(newRow);

            // Đóng modal và reset form
            bootstrap.Modal.getInstance(document.getElementById('createScheduleModal')).hide();
            this.reset();
            alert('Đã tạo lịch làm việc thành công!');
        };

        // Khởi tạo dữ liệu khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadTodayStatusMain();
            loadLeaveHistory(); // Load ngay khi trang khởi động
            loadBookings(); // Load booking data
            
            // Thêm event listeners cho booking filters
            const bookingStatusFilter = document.getElementById('bookingStatusFilter');
            const bookingSearchInput = document.getElementById('bookingSearchInput');
            if (bookingStatusFilter) bookingStatusFilter.addEventListener('change', filterAndDisplayBookings);
            if (bookingSearchInput) bookingSearchInput.addEventListener('input', filterAndDisplayBookings);
            
            // Test load statistics khi trang load (để debug)
            console.log('🧪 Testing statistics load on page load...');
            setTimeout(() => {
                loadStatisticsData();
            }, 2000); // Load sau 2 giây để Firebase có thời gian khởi tạo
            
            // Thêm test function vào console để debug
            window.testLeaveRequest = function() {
                console.log('🧪 Testing leave request creation...');
                const testRequest = {
                    employeeId: 'NV001',
                    startDate: '2024-12-25',
                    endDate: '2024-12-25',
                    reason: 'Test nghỉ phép',
                    status: 'pending',
                    createdAt: Date.now(),
                    type: 'Nghỉ phép năm',
                    employeeName: 'Nguyễn Văn A'
                };
                
                firebase.database().ref('leaveRequests').push(testRequest).then((ref) => {
                    console.log('✅ Test request created with ID:', ref.key);
                    alert('Test request created successfully!');
                }).catch((error) => {
                    console.error('❌ Error creating test request:', error);
                    alert('Error creating test request: ' + error.message);
                });
            };
            
            // Test function để test stats manually
            window.testStatistics = function() {
                console.log('🧪 Testing statistics manually...');
                showSection('stats');
            };
        });

        // Show add booking modal - using SweetAlert2 like admin
        window.showAddBookingModal = function() {
            // Lấy danh sách khách sạn từ Firebase
            firebase.database().ref('location').once('value').then(snapshot => {
                let hotelOptions = '';
                let hotelsData = [];
                snapshot.forEach(locationSnap => {
                    const location = locationSnap.val();
                    if (location.hotels) {
                        Object.entries(location.hotels).forEach(([hotelKey, hotel]) => {
                            hotelsData.push({
                                id: hotelKey,
                                name: hotel.tenKhachSan,
                                rooms: hotel.chiTiet && hotel.chiTiet.rooms ? hotel.chiTiet.rooms : [],
                                locationId: locationSnap.key
                            });
                            hotelOptions += `<option value="${locationSnap.key}__${hotelKey}">${hotel.tenKhachSan}</option>`;
                        });
                    }
                });
                
                Swal.fire({
                    title: 'Thêm đặt phòng mới',
                    html: `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <input id="add-customerName" class="swal2-input" placeholder="Tên khách *">
                            <input id="add-customerEmail" class="swal2-input" placeholder="Email">
                            <input id="add-customerPhone" class="swal2-input" placeholder="Số điện thoại *">
                            <select id="add-hotelSelect" class="swal2-input" style="width: 100%"><option value="">Chọn khách sạn *</option>${hotelOptions}</select>
                            <select id="add-roomSelect" class="swal2-input" style="width: 100%" disabled><option value="">Chọn phòng</option></select>
                            <input id="add-checkIn" class="swal2-input" type="date" placeholder="Ngày check-in *">
                            <input id="add-checkOut" class="swal2-input" type="date" placeholder="Ngày check-out *">
                            <input id="add-guests" class="swal2-input" type="number" min="1" placeholder="Số khách *" value="1">
                            <select id="add-status" class="swal2-input" style="width: 100%">
                                <option value="pending">Chờ xác nhận</option>
                                <option value="confirmed">Đã xác nhận</option>
                                <option value="cancelled">Đã hủy</option>
                                <option value="completed">Hoàn thành</option>
                            </select>
                            <input id="add-totalPrice" class="swal2-input" type="number" min="0" placeholder="Tổng tiền (VNĐ)">
                            <textarea id="add-notes" class="swal2-input" placeholder="Ghi chú" rows="2"></textarea>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu',
                    cancelButtonText: 'Hủy',
                    didOpen: () => {
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const roomSelect = document.getElementById('add-roomSelect');
                        hotelSelect.addEventListener('change', function() {
                            const value = this.value;
                            roomSelect.innerHTML = '<option value="">Chọn phòng</option>';
                            roomSelect.disabled = true;
                            if (!value) return;
                            const [locationId, hotelKey] = value.split('__');
                            const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                            if (hotel && Array.isArray(hotel.rooms)) {
                                hotel.rooms.forEach(room => {
                                    if (room && room.name) {
                                        const option = document.createElement('option');
                                        option.value = room.name;
                                        option.textContent = room.name;
                                        roomSelect.appendChild(option);
                                    }
                                });
                                roomSelect.disabled = false;
                            }
                        });
                    },
                    preConfirm: () => {
                        const customerName = document.getElementById('add-customerName').value.trim();
                        const customerPhone = document.getElementById('add-customerPhone').value.trim();
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const checkIn = document.getElementById('add-checkIn').value;
                        const checkOut = document.getElementById('add-checkOut').value;
                        const guests = document.getElementById('add-guests').value;

                        if (!customerName || !customerPhone || !hotelSelect.value || !checkIn || !checkOut || !guests) {
                            Swal.showValidationMessage('Vui lòng điền đầy đủ thông tin bắt buộc!');
                            return false;
                        }

                        if (new Date(checkIn) >= new Date(checkOut)) {
                            Swal.showValidationMessage('Ngày check-out phải sau ngày check-in!');
                            return false;
                        }

                        const hotelValue = hotelSelect.value;
                        const [locationId, hotelKey] = hotelValue.split('__');
                        const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                        
                        return {
                            customerName: customerName,
                            customerEmail: document.getElementById('add-customerEmail').value.trim(),
                            customerPhone: customerPhone,
                            hotelName: hotel ? hotel.name : '',
                            roomName: document.getElementById('add-roomSelect').value,
                            guests: parseInt(guests),
                            checkIn: new Date(checkIn).getTime(),
                            checkOut: new Date(checkOut).getTime(),
                            status: document.getElementById('add-status').value,
                            totalPrice: document.getElementById('add-totalPrice').value ? parseInt(document.getElementById('add-totalPrice').value) : 0,
                            notes: document.getElementById('add-notes').value.trim(),
                            type: 'hotel',
                            bookingType: 'hotel',
                            createdAt: Date.now(),
                            createdBy: getCurrentEmployeeId()
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        firebase.database().ref('bookings').push(result.value).then(() => {
                            Swal.fire('Thành công', 'Đã thêm đặt phòng mới!', 'success');
                            loadBookings();
                        }).catch((error) => {
                            console.error('Error creating booking:', error);
                            Swal.fire('Lỗi', 'Không thể thêm đặt phòng.', 'error');
                        });
                    }
                });
            });
        };

        // ===== PHẢN HỒI VÀ THỐNG KÊ TỪ FIREBASE =====

        // Load dữ liệu phản hồi từ Firebase
        function loadFeedbackData() {
            console.log('🔄 Loading feedback data from Firebase...');
            const tableBody = document.getElementById('feedback-table-body');
            if (!tableBody) {
                console.error('❌ Feedback table body not found!');
                return;
            }

            // Hiển thị loading state
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-3">Đang tải dữ liệu phản hồi...</td></tr>';

            // Load reviews (đánh giá khách sạn)
            firebase.database().ref('reviews').once('value').then((snapshot) => {
                let feedbackData = [];
                
                console.log('📋 Reviews snapshot:', snapshot.val());
                snapshot.forEach((childSnapshot) => {
                    const review = childSnapshot.val();
                    if (review && typeof review === 'object') {
                        review.id = childSnapshot.key;
                        review.type = 'review';
                        feedbackData.push(review);
                    }
                });

                console.log('📊 Reviews loaded:', feedbackData.length);

                // Load guide comments (bình luận cẩm nang)
                return firebase.database().ref('guideComments').once('value').then((guideSnapshot) => {
                    console.log('📋 Guide comments snapshot:', guideSnapshot.val());
                    guideSnapshot.forEach((guideChildSnapshot) => {
                        const guideId = guideChildSnapshot.key;
                        if (guideChildSnapshot.val() && typeof guideChildSnapshot.val() === 'object') {
                            Object.entries(guideChildSnapshot.val()).forEach(([commentId, comment]) => {
                                if (comment && typeof comment === 'object') {
                                    comment.id = commentId;
                                    comment.guideId = guideId;
                                    comment.type = 'guide_comment';
                                    feedbackData.push(comment);
                                }
                            });
                        }
                    });

                    console.log('📊 Guide comments loaded, total feedback:', feedbackData.length);

                    // Load guide ratings (đánh giá cẩm nang)
                    return firebase.database().ref('guideRatings').once('value').then((ratingSnapshot) => {
                        console.log('📋 Guide ratings snapshot:', ratingSnapshot.val());
                        ratingSnapshot.forEach((ratingChildSnapshot) => {
                            const guideId = ratingChildSnapshot.key;
                            if (ratingChildSnapshot.val() && typeof ratingChildSnapshot.val() === 'object') {
                                Object.entries(ratingChildSnapshot.val()).forEach(([ratingId, rating]) => {
                                    if (rating && typeof rating === 'object') {
                                        rating.id = ratingId;
                                        rating.guideId = guideId;
                                        rating.type = 'guide_rating';
                                        feedbackData.push(rating);
                                    }
                                });
                            }
                        });

                        console.log('📊 All feedback loaded, total:', feedbackData.length);
                        
                        // Sort by timestamp (newest first)
                        feedbackData.sort((a, b) => (b.timestamp || b.date || 0) - (a.timestamp || a.date || 0));
                        
                        console.log('📊 Loaded feedback data:', feedbackData);
                        renderFeedbackTable(feedbackData);
                    });
                });
            }).catch((error) => {
                console.error('❌ Error loading feedback data:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-danger">Lỗi tải dữ liệu phản hồi!</td></tr>';
                Swal.fire('Lỗi', 'Không thể tải dữ liệu phản hồi: ' + error.message, 'error');
            });
        }

        // Render bảng phản hồi
        function renderFeedbackTable(feedbackData) {
            const tableBody = document.getElementById('feedback-table-body');
            tableBody.innerHTML = '';

            if (feedbackData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-5">Chưa có phản hồi nào.</td></tr>';
                return;
            }

            console.log('🎨 Rendering feedback table with data:', feedbackData);

            feedbackData.forEach((feedback) => {
                const row = document.createElement('tr');

                let customerName = feedback.userName || 'Khách';
                let content = '';
                let room = '';
                let status = 'pending';
                let statusText = 'Chờ xử lý';

                if (feedback.type === 'review') {
                    content = feedback.comment || 'Không có nội dung';
                    room = feedback.room ? feedback.room : '';
                    status = feedback.processed ? 'processed' : 'pending';
                    statusText = feedback.processed ? 'Đã xử lý' : 'Chờ xử lý';
                } else if (feedback.type === 'guide_comment') {
                    content = feedback.text || 'Không có nội dung';
                    room = '';
                    status = feedback.processed ? 'processed' : 'pending';
                    statusText = feedback.processed ? 'Đã xử lý' : 'Chờ xử lý';
                } else if (feedback.type === 'guide_rating') {
                    content = `${feedback.comment || 'Không có bình luận'} (${feedback.rating}/5 sao)`;
                    room = '';
                    status = feedback.processed ? 'processed' : 'pending';
                    statusText = feedback.processed ? 'Đã xử lý' : 'Chờ xử lý';
                }

                const statusBadge = status === 'processed' 
                    ? '<span class="badge bg-success">Đã xử lý</span>'
                    : '<span class="badge bg-warning">Chờ xử lý</span>';

                const actionButton = status === 'processed'
                    ? '<button class="btn btn-sm btn-secondary" disabled>Đã xử lý</button>'
                    : `<button class="btn btn-sm btn-primary" onclick="markFeedbackProcessed('${feedback.type}', '${feedback.id}', '${feedback.guideId || ''}')">Đánh dấu đã xử lý</button>`;

                row.innerHTML = `
                    <td>${customerName}</td>
                    <td>${room}</td>
                    <td>${content}</td>
                    <td>${statusBadge}</td>
                    <td>${actionButton}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load dữ liệu thống kê từ Firebase
        function loadStatisticsData() {
            console.log('📊 Loading statistics data from Firebase...');
            
            // Load booking statistics
            firebase.database().ref('bookings').once('value').then((bookingSnapshot) => {
                let processedBookings = 0;
                let totalBookings = 0;
                
                console.log('📋 Bookings snapshot:', bookingSnapshot.val());
                bookingSnapshot.forEach((childSnapshot) => {
                    const booking = childSnapshot.val();
                    if (booking && typeof booking === 'object') {
                        totalBookings++;
                        if (booking.status === 'confirmed' || booking.status === 'completed') {
                            processedBookings++;
                        }
                    }
                });

                console.log('📊 Booking stats:', { processedBookings, totalBookings });

                // Load feedback statistics
                return firebase.database().ref('reviews').once('value').then((reviewSnapshot) => {
                    let processedFeedback = 0;
                    let totalFeedback = 0;
                    
                    console.log('📋 Reviews for stats snapshot:', reviewSnapshot.val());
                    reviewSnapshot.forEach((childSnapshot) => {
                        const review = childSnapshot.val();
                        if (review && typeof review === 'object') {
                            totalFeedback++;
                            if (review.processed) {
                                processedFeedback++;
                            }
                        }
                    });

                    console.log('📊 Review stats:', { processedFeedback, totalFeedback });

                    // Load guide comments statistics
                    return firebase.database().ref('guideComments').once('value').then((commentSnapshot) => {
                        console.log('📋 Guide comments for stats snapshot:', commentSnapshot.val());
                        commentSnapshot.forEach((guideChildSnapshot) => {
                            if (guideChildSnapshot.val() && typeof guideChildSnapshot.val() === 'object') {
                                Object.values(guideChildSnapshot.val()).forEach((comment) => {
                                    if (comment && typeof comment === 'object') {
                                        totalFeedback++;
                                        if (comment.processed) {
                                            processedFeedback++;
                                        }
                                    }
                                });
                            }
                        });

                        console.log('📊 After guide comments stats:', { processedFeedback, totalFeedback });

                        // Load guide ratings statistics
                        return firebase.database().ref('guideRatings').once('value').then((ratingSnapshot) => {
                            console.log('📋 Guide ratings for stats snapshot:', ratingSnapshot.val());
                            ratingSnapshot.forEach((ratingChildSnapshot) => {
                                if (ratingChildSnapshot.val() && typeof ratingChildSnapshot.val() === 'object') {
                                    Object.values(ratingChildSnapshot.val()).forEach((rating) => {
                                        if (rating && typeof rating === 'object') {
                                            totalFeedback++;
                                            if (rating.processed) {
                                                processedFeedback++;
                                            }
                                        }
                                    });
                                }
                            });

                            console.log('📊 Final stats:', { processedBookings, totalBookings, processedFeedback, totalFeedback });

                            // Update statistics display
                            updateStatisticsDisplay(processedBookings, totalBookings, processedFeedback, totalFeedback);
                        });
                    });
                });
            }).catch((error) => {
                console.error('❌ Error loading statistics:', error);
                Swal.fire('Lỗi', 'Không thể tải dữ liệu thống kê: ' + error.message, 'error');
                
                // Hiển thị dữ liệu mặc định để không để trống
                updateStatisticsDisplay(0, 0, 0, 0);
            });
        }

        // Cập nhật hiển thị thống kê
        function updateStatisticsDisplay(processedBookings, totalBookings, processedFeedback, totalFeedback) {
            console.log('📊 Updating statistics display:', { processedBookings, totalBookings, processedFeedback, totalFeedback });
            
            // Kiểm tra xem stats section có tồn tại không
            const statsSection = document.getElementById('stats-section');
            if (!statsSection) {
                console.log('📊 Stats section not found');
                return;
            }
            
            // Get all stat values (backup method)
            const allStatValues = document.querySelectorAll('#stats-section .stat-value');
            console.log('🔍 Found stat value elements:', allStatValues.length);
            
            // Update booking statistics (first stat-card)
            let bookingValueElement = document.querySelector('#stats-section .col-md-4:nth-child(1) .stat-value');
            if (!bookingValueElement && allStatValues.length >= 1) {
                bookingValueElement = allStatValues[0]; // Fallback to first element
            }
            if (bookingValueElement) {
                bookingValueElement.textContent = processedBookings;
                console.log('✅ Updated booking stats:', processedBookings);
            } else {
                console.error('❌ Booking value element not found');
            }

            // Update check-in/out statistics (second stat-card)
            let checkinValueElement = document.querySelector('#stats-section .col-md-4:nth-child(2) .stat-value');
            if (!checkinValueElement && allStatValues.length >= 2) {
                checkinValueElement = allStatValues[1]; // Fallback to second element
            }
            if (checkinValueElement) {
                const checkinValue = Math.floor(processedBookings * 0.7);
                checkinValueElement.textContent = checkinValue;
                console.log('✅ Updated checkin stats:', checkinValue);
            } else {
                console.error('❌ Checkin value element not found');
            }

            // Update feedback statistics (third stat-card)
            let feedbackValueElement = document.querySelector('#stats-section .col-md-4:nth-child(3) .stat-value');
            if (!feedbackValueElement && allStatValues.length >= 3) {
                feedbackValueElement = allStatValues[2]; // Fallback to third element
            }
            if (feedbackValueElement) {
                feedbackValueElement.textContent = processedFeedback;
                console.log('✅ Updated feedback stats:', processedFeedback);
            } else {
                console.error('❌ Feedback value element not found');
            }

            // Update chart data
            updateStatisticsChart(processedBookings, Math.floor(processedBookings * 0.7), processedFeedback);
        }

        // Cập nhật biểu đồ thống kê
        function updateStatisticsChart(bookings, checkins, feedback) {
            const chartCanvas = document.getElementById('personalStatsChart');
            if (chartCanvas && window.personalStatsChart) {
                console.log('📈 Updating chart with data:', { bookings, checkins, feedback });
                window.personalStatsChart.data.datasets[0].data = [bookings, checkins, feedback];
                window.personalStatsChart.update();
                console.log('✅ Chart updated successfully');
            } else {
                console.error('❌ Chart canvas or chart instance not found');
                console.log('Canvas exists:', !!chartCanvas);
                console.log('Chart instance exists:', !!window.personalStatsChart);
            }
        }

        // Đánh dấu phản hồi đã xử lý với error handling tốt hơn
        window.markFeedbackProcessed = function(type, id, guideId = '') {
            console.log('🔧 Marking feedback as processed:', { type, id, guideId });
            
            let ref;
            if (type === 'review') {
                ref = firebase.database().ref(`reviews/${id}`);
            } else if (type === 'guide_comment') {
                ref = firebase.database().ref(`guideComments/${guideId}/${id}`);
            } else if (type === 'guide_rating') {
                ref = firebase.database().ref(`guideRatings/${guideId}/${id}`);
            }

            if (ref) {
                ref.update({
                    processed: true,
                    processedAt: Date.now(),
                    processedBy: getCurrentEmployeeId()
                }).then(() => {
                    console.log('✅ Feedback marked as processed successfully');
                    Swal.fire('Thành công', 'Đã đánh dấu phản hồi đã xử lý!', 'success');
                    loadFeedbackData(); // Reload data
                }).catch((error) => {
                    console.error('❌ Error marking feedback as processed:', error);
                    Swal.fire('Lỗi', 'Không thể cập nhật trạng thái phản hồi.', 'error');
                });
            } else {
                console.error('❌ Invalid feedback reference');
                Swal.fire('Lỗi', 'Tham chiếu phản hồi không hợp lệ.', 'error');
            }
        };


    </script>


</body>
</html>