<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý tài chính (Finance Manager)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --main-bg: #181c2f; --sidebar-bg: #23244a; --card-bg: #23244a; --accent: #7c3aed; --accent2: #00eaff; --text: #f3f6fa; --text-muted: #b0b8d1; --border: #2e325a; --shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.15); }
        body { background: var(--main-bg); color: var(--text); font-family: 'Poppins', Arial, sans-serif; margin: 0; }
        .sidebar { width: 240px; background: var(--sidebar-bg); color: var(--text); min-height: 100vh; position: fixed; top: 0; left: 0; z-index: 100; display: flex; flex-direction: column; }
        .sidebar .logo { padding: 32px 0 24px 0; text-align: center; font-size: 1.6rem; font-weight: 700; letter-spacing: 2px; color: var(--accent); }
        .sidebar .nav-item { display: flex; align-items: center; padding: 14px 32px; color: var(--text-muted); text-decoration: none; font-size: 1.08rem; border-left: 4px solid transparent; transition: background 0.2s, color 0.2s, border-color 0.2s; }
        .sidebar .nav-item.active, .sidebar .nav-item:hover { background: #1a1d36; color: var(--accent2); border-left: 4px solid var(--accent); }
        .sidebar .nav-item i { margin-right: 14px; font-size: 1.2rem; }
        .sidebar-footer { margin-top: auto; padding: 24px 32px; }
        .sidebar-footer .btn { width: 100%; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-weight: 500; }
        .main-container { margin-left: 240px; min-height: 100vh; background: var(--main-bg); }
        .main-header { background: #1a1d36; border-bottom: 1px solid var(--border); padding: 20px 40px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
        .main-header .user-info { display: flex; align-items: center; gap: 14px; }
        .main-header .user-info img { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .content-wrapper { padding: 40px 32px 32px 32px; }
        .card-modern { background: var(--card-bg); border-radius: 18px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 32px; padding: 0; }
        .card-modern .card-body { padding: 32px 28px; }
        .card-modern .card-title { color: var(--accent2); font-weight: 600; font-size: 1.2rem; margin-bottom: 18px; }
        .profile-info { display: flex; align-items: center; gap: 32px; }
        .profile-info img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .profile-info .info { font-size: 1.1rem; }

        /* New styles for finance management */
        .content-section { display: none; }
        .content-section.active { display: block; }
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: 24px; border: 1px solid var(--border); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px; }
        .trend-up { color: #28a745; font-weight: 600; }
        .trend-down { color: #dc3545; font-weight: 600; }
        .trend-stable { color: #ffc107; font-weight: 600; }
        .finance-card { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border); padding: 24px; margin-bottom: 24px; }
        .finance-card h5 { color: var(--accent2); margin-bottom: 20px; font-weight: 600; }
        .data-table { background: var(--card-bg); border-radius: 12px; overflow: hidden; }
        .table-dark { --bs-table-bg: var(--card-bg); --bs-table-border-color: var(--border); }
        .form-control, .form-select { background: var(--main-bg); border: 1px solid var(--border); color: var(--text); }
        .form-control:focus, .form-select:focus { background: var(--main-bg); border-color: var(--accent); color: var(--text); box-shadow: 0 0 0 0.2rem rgba(124, 58, 237, 0.25); }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: #6d28d9; border-color: #6d28d9; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning:hover { background: #d39e00; }
        .btn-info:hover { background: #138496; }
        .btn-danger:hover { background: #c82333; }
        .progress-custom { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar-custom { height: 100%; transition: width 0.3s ease; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--border); }
        .modal-header { border-bottom: 1px solid var(--border); }
        .modal-footer { border-top: 1px solid var(--border); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .metric-card { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 16px; margin-bottom: 12px; }

        @media (max-width: 900px) { .sidebar { width: 80px; } .main-container { margin-left: 80px; } .sidebar .nav-item { padding: 12px 10px; font-size: 0.95rem; } .sidebar .logo { font-size: 1.1rem; } .kpi-grid { grid-template-columns: 1fr; } }
        @media (max-width: 700px) { .sidebar { display: none; } .main-container { margin-left: 0; } .main-header { padding: 12px 10px; } .content-wrapper { padding: 12px 4px; } }
        
        /* Activity items */
        .activity-item { display: flex; align-items: center; margin-bottom: 16px; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
        .activity-content { flex: 1; }
        .activity-title { font-weight: 500; margin-bottom: 4px; }
        .activity-time { font-size: 0.8rem; color: var(--text-muted); }
        
        /* Progress bars */
        .progress-custom { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .progress-bar-custom { height: 100%; transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-hotel"></i> LUXSTAFF
        </div>
        <a href="#dashboard" class="nav-item" onclick="showSection('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a href="#revenue" class="nav-item" onclick="showSection('revenue')"><i class="fas fa-dollar-sign"></i> Doanh thu</a>
        <a href="#commission" class="nav-item" onclick="showSection('commission')"><i class="fas fa-percent"></i> Hoa hồng</a>
        <a href="#reconciliation" class="nav-item" onclick="showSection('reconciliation')"><i class="fas fa-balance-scale"></i> Đối soát</a>
        <a href="#settings" class="nav-item" onclick="showSection('settings')"><i class="fas fa-cogs"></i> Cài đặt</a>
        <div class="sidebar-footer">
            <button class="btn" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</button>
        </div>
    </div>
    <div class="main-container">
        <header class="main-header">
            <h1 class="h4 mb-0" style="color:var(--accent2);">Quản lý tài chính</h1>
            <div class="user-info">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar">
                <span><strong>Finance Manager</strong></span>
            </div>
        </header>
        <main class="content-wrapper">
            <!-- Section Vai trò (mặc định) -->
            <div id="roleSection" class="content-section active">
                <!-- KPI Overview -->
                <section class="mb-4">
                    <div class="kpi-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--accent2);">₫12.8B</div>
                            <div class="stat-label">Tổng doanh thu tháng</div>
                            <small class="trend-up"><i class="fas fa-arrow-up"></i> +18.5%</small>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #28a745;">₫890M</div>
                            <div class="stat-label">Hoa hồng khách sạn</div>
                            <small class="trend-up"><i class="fas fa-arrow-up"></i> +12.3%</small>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #ffc107;">₫156M</div>
                            <div class="stat-label">Phí dịch vụ</div>
                            <small class="trend-stable"><i class="fas fa-minus"></i> 0.0%</small>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #17a2b8;">98.2%</div>
                            <div class="stat-label">Tỷ lệ đối soát</div>
                            <small class="trend-up"><i class="fas fa-arrow-up"></i> +2.1%</small>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="card-modern mb-4">
                        <div class="card-body profile-info">
                            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar">
                            <div class="info">
                                <h4 class="mb-1" style="color:var(--accent2);">Quản lý tài chính (Finance Manager)</h4>
                                <div><i class="fas fa-briefcase me-2"></i> Đối soát doanh thu, hoa hồng giữa hệ thống và khách sạn</div>
                                <hr style="border-color: var(--border); margin: 16px 0;">
                                <div>
                                    <strong style="color: var(--accent2);">Chức năng chính:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px;">
                                        <li>Theo dõi doanh thu và hoa hồng real-time</li>
                                        <li>Đối soát số liệu với các khách sạn đối tác</li>
                                        <li>Quản lý thanh toán và refund</li>
                                        <li>Báo cáo tài chính định kỳ</li>
                                        <li>Phân tích xu hướng và dự báo</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Section Dashboard -->
            <div id="dashboardSection" class="content-section">
                <!-- Thống kê tổng quan -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="finance-card">
                            <div class="text-center">
                                <i class="fas fa-chart-line fa-2x mb-2" style="color: var(--accent2);"></i>
                                <h6>Doanh thu tháng này</h6>
                                <div class="stat-number text-success" id="monthlyRevenue">₫0</div>
                                <small class="text-muted" id="revenueGrowth">+0% so với tháng trước</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="finance-card">
                            <div class="text-center">
                                <i class="fas fa-coins fa-2x mb-2" style="color: #ffc107;"></i>
                                <h6>Hoa hồng chờ thanh toán</h6>
                                <div class="stat-number text-warning" id="pendingCommission">₫0</div>
                                <small class="text-muted" id="commissionCount">0 khách sạn</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="finance-card">
                            <div class="text-center">
                                <i class="fas fa-hotel fa-2x mb-2" style="color: #28a745;"></i>
                                <h6>Booking khách sạn</h6>
                                <div class="stat-number text-success" id="hotelBookings">0</div>
                                <small class="text-muted" id="hotelRevenue">₫0 doanh thu</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="finance-card">
                            <div class="text-center">
                                <i class="fas fa-map-marked-alt fa-2x mb-2" style="color: #17a2b8;"></i>
                                <h6>Booking tour</h6>
                                <div class="stat-number text-info" id="tourBookings">0</div>
                                <small class="text-muted" id="tourRevenue">₫0 doanh thu</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thống kê chi tiết -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="finance-card">
                            <h5><i class="fas fa-chart-pie me-2"></i>Phân bố doanh thu</h5>
                            <div class="row">
                                <div class="col-6">
                                    <div class="metric-card text-center">
                                        <div class="stat-number text-primary" id="hotelPercentage">0%</div>
                                        <div class="stat-label">Khách sạn</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card text-center">
                                        <div class="stat-number text-warning" id="tourPercentage">0%</div>
                                        <div class="stat-label">Tour</div>
                                    </div>
                                </div>
                            </div>
                            <div class="progress-custom mt-3">
                                <div class="progress-bar-custom" id="revenueProgress" style="width: 0%; background: var(--accent);"></div>
                            </div>
                            <small class="text-muted">Target tháng: ₫2.5 tỷ</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="finance-card">
                            <h5><i class="fas fa-credit-card me-2"></i>Giao dịch VNPay</h5>
                            <div class="row">
                                <div class="col-6">
                                    <div class="metric-card text-center">
                                        <div class="stat-number text-success" id="vnpaySuccess">0</div>
                                        <div class="stat-label">Thành công</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card text-center">
                                        <div class="stat-number text-danger" id="vnpayFailed">0</div>
                                        <div class="stat-label">Thất bại</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-info btn-sm" onclick="generateVNPayReport()">
                                    <i class="fas fa-file-alt me-1"></i>Báo cáo VNPay
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top khách sạn và đối tác -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="finance-card">
                            <h5><i class="fas fa-trophy me-2"></i>Top khách sạn theo doanh thu</h5>
                            <div id="topHotels">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="finance-card">
                            <h5><i class="fas fa-handshake me-2"></i>Top đối tác affiliate</h5>
                            <div id="topPartners">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Giao dịch gần đây và hoạt động -->
                <div class="row g-4">
                    <div class="col-md-8">
                        <div class="finance-card">
                            <h5><i class="fas fa-history me-2"></i>Giao dịch gần đây</h5>
                            <div class="data-table">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>Thời gian</th>
                                            <th>Khách sạn/Tour</th>
                                            <th>Khách hàng</th>
                                            <th>Số tiền</th>
                                            <th>Trạng thái</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentTransactions">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="finance-card">
                            <h5><i class="fas fa-bell me-2"></i>Hoạt động gần đây</h5>
                            <div id="recentActivities">
                                <div class="activity-item">
                                    <div class="activity-icon bg-success">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">Đối soát thành công</div>
                                        <div class="activity-time">2 phút trước</div>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon bg-warning">
                                        <i class="fas fa-exclamation"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">Chênh lệch phát hiện</div>
                                        <div class="activity-time">15 phút trước</div>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon bg-info">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">Thanh toán hoa hồng</div>
                                        <div class="activity-time">1 giờ trước</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nút thao tác nhanh -->
                <div class="row g-4 mt-4">
                    <div class="col-12">
                        <div class="finance-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-bolt me-2"></i>Thao tác nhanh</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="updateDashboard()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh Dashboard
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100 mb-2" onclick="showSection('revenue')">
                                        <i class="fas fa-dollar-sign me-1"></i>Xem doanh thu
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-warning w-100 mb-2" onclick="showSection('commission')">
                                        <i class="fas fa-coins me-1"></i>Quản lý hoa hồng
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-info w-100 mb-2" onclick="showSection('reconciliation')">
                                        <i class="fas fa-balance-scale me-1"></i>Đối soát
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-success w-100 mb-2" onclick="showSection('settings')">
                                        <i class="fas fa-cogs me-1"></i>Cài đặt
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Doanh thu -->
            <div id="revenueSection" class="content-section">
                <div class="finance-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-dollar-sign me-2"></i>Quản lý doanh thu</h5>
                        <div>
                            <!-- <button class="btn btn-info btn-sm me-2" onclick="refreshFirebaseData()" title="Refresh từ Firebase">
                                <i class="fas fa-fire"></i> Refresh Firebase
                            </button> -->
                            <!-- <button class="btn btn-warning btn-sm me-2" onclick="loadSampleData()" title="Load dữ liệu mẫu">
                                <i class="fas fa-database"></i> Load Sample
                            </button> -->
                            <!-- <button class="btn btn-secondary btn-sm me-2" onclick="debugData()" title="Kiểm tra dữ liệu">
                                <i class="fas fa-bug"></i> Debug
                            </button> -->
                            <button class="btn btn-success btn-sm me-2" onclick="exportRevenue()">
                                <i class="fas fa-download"></i> Xuất Excel
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="refreshRevenue()">
                                <i class="fas fa-sync"></i> Làm mới
                            </button>
                        </div>
                    </div>

                    <!-- Bộ lọc -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <select class="form-select" id="revenueHotel">
                                <option value="">Tất cả khách sạn</option>
                                <option value="luxury-hn">Luxury Hotel HN</option>
                                <option value="beach-dn">Beach Resort DN</option>
                                <option value="city-hcm">City Hotel HCM</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="revenueFromDate" value="2025-08-01">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="revenueToDate" value="2025-08-03">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary w-100" onclick="filterRevenue()">
                                <i class="fas fa-filter"></i> Lọc dữ liệu
                            </button>
                        </div>
                    </div>

                    <!-- Bảng doanh thu -->
                    <div class="row mb-4">
                        <!-- Thống kê tổng hợp -->
                        <div class="col-12">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-primary">🏨 <span id="totalHotelBookings">0</span></div>
                                        <div class="stat-label">Booking Khách sạn</div>
                                        <div class="small text-muted" id="totalHotelRevenue">₫0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-warning">🗺️ <span id="totalTourBookings">0</span></div>
                                        <div class="stat-label">Booking Tours</div>
                                        <div class="small text-muted" id="totalTourRevenue">₫0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-info">💰 <span id="totalDepositBookings">0</span></div>
                                        <div class="stat-label">Đặt cọc</div>
                                        <div class="small text-muted" id="totalDepositRevenue">₫0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-success">🎁 <span id="totalPromotionBookings">0</span></div>
                                        <div class="stat-label">Ưu đãi</div>
                                        <div class="small text-muted" id="totalPromotionRevenue">₫0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-success">💰 <span id="totalRevenue">₫0</span></div>
                                        <div class="stat-label">Tổng doanh thu</div>
                                        <div class="small text-muted" id="totalCommission">Hoa hồng: ₫0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-info">📊 <span id="totalBookings">0</span></div>
                                        <div class="stat-label">Tổng booking</div>
                                        <div class="small text-muted" id="averageRevenue">TB: ₫0/booking</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Bảng Khách sạn (trên) -->
                        <div class="col-12">
                            <div class="data-table mb-4">
                                <h6 class="mb-3"><i class="fas fa-hotel text-primary"></i> Doanh thu Khách sạn</h6>
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Khách sạn</th>
                                            <th>Số booking</th>
                                            <th>Doanh thu gross</th>
                                            <th>Hoa hồng (15%)</th>
                                            <th>Doanh thu net</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hotelRevenueTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Đang tải dữ liệu khách sạn...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Bảng Tours (dưới) -->
                        <div class="col-12">
                            <div class="data-table mb-4">
                                <h6 class="mb-3"><i class="fas fa-map-marked-alt text-warning"></i> Doanh thu Tours</h6>
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Tour</th>
                                            <th>Số booking</th>
                                            <th>Doanh thu gross</th>
                                            <th>Hoa hồng (15%)</th>
                                            <th>Doanh thu net</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tourRevenueTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Đang tải dữ liệu tours...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Bảng Đặt cọc -->
                        <div class="col-12">
                            <div class="data-table mb-4">
                                <h6 class="mb-3"><i class="fas fa-money-bill-wave text-info"></i> Đặt cọc</h6>
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Khách hàng</th>
                                            <th>Loại</th>
                                            <th>Số tiền cọc</th>
                                            <th>Ghi chú</th>
                                            <th>Trạng thái</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="depositTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Đang tải dữ liệu đặt cọc...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Bảng Ưu đãi -->
                        <div class="col-12">
                            <div class="data-table mb-4">
                                <h6 class="mb-3"><i class="fas fa-gift text-success"></i> Ưu đãi & Khuyến mãi</h6>
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Khách hàng</th>
                                            <th>Loại</th>
                                            <th>Giá gốc</th>
                                            <th>Giá sau ưu đãi</th>
                                            <th>Tiết kiệm</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="promotionTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Đang tải dữ liệu ưu đãi...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Hoa hồng -->
            <div id="commissionSection" class="content-section">
                <div class="finance-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-percent me-2"></i>Quản lý hoa hồng</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="processAllCommissions()">
                                <i class="fas fa-credit-card"></i> Thanh toán tất cả
                            </button>
                            <button class="btn btn-info btn-sm me-2" onclick="commissionSettings()">
                                <i class="fas fa-cog"></i> Cài đặt tỷ lệ
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="refreshCommissionData()">
                                <i class="fas fa-sync"></i> Làm mới dữ liệu
                            </button>
                        </div>
                    </div>

                    <!-- Thống kê hoa hồng realtime -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-info" id="pendingCommission">₫0</div>
                                <div class="stat-label">Chờ thanh toán</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-success" id="paidCommission">₫0</div>
                                <div class="stat-label">Đã thanh toán tháng này</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-warning" id="avgCommissionRate">15%</div>
                                <div class="stat-label">Tỷ lệ hoa hồng TB</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-primary" id="totalPartners">0</div>
                                <div class="stat-label">Khách sạn đối tác</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bảng hoa hồng realtime -->
                    <div class="data-table">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Khách sạn</th>
                                    <th>Tỷ lệ hoa hồng</th>
                                    <th>Doanh thu gốc</th>
                                    <th>Hoa hồng tích lũy</th>
                                    <th>Đã thanh toán</th>
                                    <th>Chưa thanh toán</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="commissionTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Đang tải dữ liệu hoa hồng...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section Đối soát -->
            <div id="reconciliationSection" class="content-section">
                <div class="finance-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-balance-scale me-2"></i>Đối soát tài chính</h5>
                        <div>
                            <button class="btn btn-warning btn-sm me-2" onclick="startReconciliation()">
                                <i class="fas fa-play"></i> Bắt đầu đối soát
                            </button>
                            <button class="btn btn-info btn-sm me-2" onclick="autoReconcile()">
                                <i class="fas fa-robot"></i> Tự động đối soát
                            </button>
                            <button class="btn btn-success btn-sm" onclick="updateReconciliationTable()">
                                <i class="fas fa-sync"></i> Làm mới dữ liệu
                            </button>
                        </div>
                    </div>

                    <!-- Thống kê đối soát -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-warning" id="pendingReconciliation">0</div>
                                <div class="stat-label">Chờ đối soát</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-success" id="completedReconciliation">0</div>
                                <div class="stat-label">Đã đối soát</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-danger" id="totalDiscrepancies">0</div>
                                <div class="stat-label">Chênh lệch</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-info" id="pendingAmount">₫0</div>
                                <div class="stat-label">Số tiền chờ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload file đối soát -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <h6><i class="fas fa-upload me-2"></i>Upload file từ khách sạn</h6>
                                <input type="file" class="form-control mb-2" accept=".xlsx,.csv" id="reconcileFile">
                                <button class="btn btn-primary btn-sm" onclick="uploadReconcileFile()">
                                    <i class="fas fa-cloud-upload-alt"></i> Tải lên
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <h6><i class="fas fa-download me-2"></i>Tải template</h6>
                                <p class="small mb-2">File Excel mẫu cho khách sạn gửi dữ liệu đối soát</p>
                                <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate()">
                                    <i class="fas fa-file-excel"></i> Tải template
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bảng đối soát -->
                    <div class="data-table">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Khách sạn/Tour</th>
                                    <th>Địa điểm</th>
                                    <th>Kỳ đối soát</th>
                                    <th>Doanh thu</th>
                                    <th>Tỷ lệ HH</th>
                                    <th>Hoa hồng</th>
                                    <th>Đã thanh toán</th>
                                    <th>Chưa thanh toán</th>
                                    <th>Chênh lệch</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="reconciliationTableBody">
                                <tr>
                                    <td colspan="11" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Đang tải dữ liệu đối soát...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section Báo cáo -->
            <div id="reportsSection" class="content-section">
                <div class="finance-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-file-alt me-2"></i>Báo cáo tài chính</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="generateFinanceReport()">
                                <i class="fas fa-plus"></i> Tạo báo cáo
                            </button>
                            <button class="btn btn-info btn-sm me-2" onclick="scheduleReport()">
                                <i class="fas fa-clock"></i> Lên lịch
                            </button>
                            <button class="btn btn-warning btn-sm me-2" onclick="testDataConnection()">
                                <i class="fas fa-database"></i> Test Data
                            </button>
                            <button class="btn btn-danger btn-sm me-2" onclick="checkFirebaseConnection()">
                                <i class="fas fa-fire"></i> Check Firebase
                            </button>
                            <button class="btn btn-secondary btn-sm me-2" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                                <i class="fas fa-sync"></i> Auto-refresh
                            </button>
                            <button class="btn btn-primary btn-sm me-2" onclick="showHotelTourStats()">
                                <i class="fas fa-chart-pie"></i> Hotel vs Tour
                            </button>
                        </div>
                    </div>

                    <!-- Thống kê realtime -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <i class="fas fa-calendar-alt fa-2x mb-2" style="color: var(--accent);"></i>
                                <h6>Thống kê tháng hiện tại</h6>
                                <div id="currentMonthStats">
                                    <div class="small text-muted">Đang tải...</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <i class="fas fa-credit-card fa-2x mb-2" style="color: #ffc107;"></i>
                                <h6>Giao dịch VNPay</h6>
                                <div id="vnpayStats">
                                    <div class="small text-muted">Đang tải...</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <i class="fas fa-hotel fa-2x mb-2" style="color: #28a745;"></i>
                                <h6>Booking khách sạn</h6>
                                <div id="hotelBookingStats">
                                    <div class="small text-muted">Đang tải...</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <i class="fas fa-map-marked-alt fa-2x mb-2" style="color: #17a2b8;"></i>
                                <h6>Booking tour</h6>
                                <div id="tourBookingStats">
                                    <div class="small text-muted">Đang tải...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Báo cáo có sẵn -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="metric-card text-center">
                                <i class="fas fa-chart-pie fa-2x mb-2" style="color: var(--accent);"></i>
                                <h6>Báo cáo doanh thu</h6>
                                <button class="btn btn-sm btn-primary" onclick="generateReport('revenue')">Tạo báo cáo</button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card text-center">
                                <i class="fas fa-coins fa-2x mb-2" style="color: #ffc107;"></i>
                                <h6>Báo cáo hoa hồng</h6>
                                <button class="btn btn-sm btn-warning" onclick="generateReport('commission')">Tạo báo cáo</button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card text-center">
                                <i class="fas fa-balance-scale fa-2x mb-2" style="color: #28a745;"></i>
                                <h6>Báo cáo đối soát</h6>
                                <button class="btn btn-sm btn-success" onclick="generateReport('reconciliation')">Tạo báo cáo</button>
                            </div>
                        </div>
                    </div>

                    <!-- Lịch sử báo cáo -->
                    <div class="data-table">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Tên báo cáo</th>
                                    <th>Loại</th>
                                    <th>Kỳ báo cáo</th>
                                    <th>Ngày tạo</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Báo cáo doanh thu tháng 7/2025</td>
                                    <td><span class="badge bg-primary">Doanh thu</span></td>
                                    <td>01/07 - 31/07/2025</td>
                                    <td>01/08/2025 09:00</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-info me-1" title="Xem"><i class="fas fa-eye"></i></button>
                                        <button class="btn btn-sm btn-success me-1" title="Tải"><i class="fas fa-download"></i></button>
                                        <button class="btn btn-sm btn-warning" title="Chia sẻ"><i class="fas fa-share"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Báo cáo hoa hồng Q2/2025</td>
                                    <td><span class="badge bg-warning">Hoa hồng</span></td>
                                    <td>01/04 - 30/06/2025</td>
                                    <td>02/07/2025 14:30</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-info me-1" title="Xem"><i class="fas fa-eye"></i></button>
                                        <button class="btn btn-sm btn-success me-1" title="Tải"><i class="fas fa-download"></i></button>
                                        <button class="btn btn-sm btn-warning" title="Chia sẻ"><i class="fas fa-share"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Báo cáo đối soát tuần 31</td>
                                    <td><span class="badge bg-success">Đối soát</span></td>
                                    <td>29/07 - 04/08/2025</td>
                                    <td>03/08/2025 16:45</td>
                                    <td><span class="badge bg-info">Processing</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary me-1" disabled title="Đang xử lý"><i class="fas fa-clock"></i></button>
                                        <button class="btn btn-sm btn-danger" title="Hủy" onclick="cancelReport('week31')"><i class="fas fa-times"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section Cài đặt -->
            <div id="settingsSection" class="content-section">
                <div class="finance-card">
                    <h5><i class="fas fa-cogs me-2"></i>Cài đặt tài chính</h5>
                    
                    <div class="row g-4">
                        <!-- Cài đặt hoa hồng -->
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h6><i class="fas fa-percent me-2"></i>Cài đặt tỷ lệ hoa hồng</h6>
                                <div class="mb-3">
                                    <label class="form-label">Tỷ lệ hoa hồng mặc định</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="defaultCommissionRate" value="15" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Hoa hồng tối thiểu</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="minCommissionRate" value="10" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="saveCommissionSettings()">Lưu cài đặt</button>
                                <button class="btn btn-info btn-sm ms-2" onclick="loadSettingsFromFirebase()">Tải từ Firebase</button>
                            </div>
                        </div>

                        <!-- Cài đặt thanh toán -->
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h6><i class="fas fa-credit-card me-2"></i>Cài đặt thanh toán</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="autoPayment" checked>
                                    <label class="form-check-label" for="autoPayment">
                                        Tự động thanh toán hoa hồng
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Chu kỳ thanh toán</label>
                                    <select class="form-select" id="paymentCycle">
                                        <option value="weekly">Hàng tuần</option>
                                        <option value="monthly" selected>Hàng tháng</option>
                                        <option value="quarterly">Hàng quý</option>
                                    </select>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="savePaymentSettings()">Cập nhật</button>
                            </div>
                        </div>
                    </div>

                    <!-- Quản lý đối tác từ Affiliate Manager -->
                    <div class="row g-4 mt-3">
                        <div class="col-md-12">
                            <div class="metric-card">
                                <h6><i class="fas fa-handshake me-2"></i>Quản lý đối tác từ Affiliate Manager</h6>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-muted">Dữ liệu đối tác từ hệ thống Affiliate</span>
                                    <button class="btn btn-info btn-sm" onclick="loadAffiliatePartners()">
                                        <i class="fas fa-sync"></i> Làm mới dữ liệu
                                    </button>
                                </div>
                                
                                <!-- Thống kê đối tác -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary" id="totalPartners">0</div>
                                            <div class="stat-label">Tổng đối tác</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success" id="activePartners">0</div>
                                            <div class="stat-label">Đang hợp tác</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning" id="avgCommission">0%</div>
                                            <div class="stat-label">Hoa hồng TB</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-info" id="totalRevenue">₫0</div>
                                            <div class="stat-label">Tổng doanh thu</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bảng đối tác -->
                                <div class="table-responsive">
                                    <table class="table table-dark table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tên đối tác</th>
                                                <th>Website</th>
                                                <th>Email</th>
                                                <th>Trạng thái</th>
                                                <th>Hoa hồng</th>
                                                <th>Doanh thu</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="affiliatePartnersTable">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    Đang tải dữ liệu đối tác...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cài đặt thông báo -->
                    <div class="row g-4 mt-2">
                        <div class="col-md-12">
                            <div class="metric-card">
                                <h6><i class="fas fa-bell me-2"></i>Cài đặt thông báo</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="revenueAlert" checked>
                                            <label class="form-check-label" for="revenueAlert">
                                                Cảnh báo doanh thu
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="reconcileAlert" checked>
                                            <label class="form-check-label" for="reconcileAlert">
                                                Cảnh báo đối soát
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="paymentAlert">
                                            <label class="form-check-label" for="paymentAlert">
                                                Nhắc nhở thanh toán
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-info btn-sm mt-3" onclick="saveNotificationSettings()">Lưu thông báo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Quản lý hiển thị section
        function showSection(sectionName) {
            try {
                // Ẩn tất cả sections
                const allSections = document.querySelectorAll('.content-section');
                if (allSections.length > 0) {
                    allSections.forEach(section => {
                        if (section && section.classList) {
                            section.classList.remove('active');
                        }
                    });
                }
                
                // Hiển thị section được chọn
                const targetSection = document.getElementById(sectionName + 'Section');
                if (targetSection && targetSection.classList) {
                    targetSection.classList.add('active');
                }
                
                // Cập nhật active state cho menu
                const navItems = document.querySelectorAll('.nav-item');
                if (navItems.length > 0) {
                    navItems.forEach(item => {
                        if (item && item.classList) {
                            item.classList.remove('active');
                        }
                    });
                }
                
                // Cập nhật tiêu đề header
                const titles = {
                    'role': 'Quản lý tài chính',
                    'dashboard': 'Finance Dashboard',
                    'revenue': 'Quản lý doanh thu',
                    'commission': 'Quản lý hoa hồng',
                    'reconciliation': 'Đối soát tài chính',
                    'reports': 'Báo cáo tài chính',
                    'settings': 'Cài đặt tài chính'
                };
                const headerTitle = document.querySelector('.main-header h1');
                if (headerTitle && titles[sectionName]) {
                    headerTitle.textContent = titles[sectionName];
                }
                
                console.log('✅ Section changed to:', sectionName);
            } catch (error) {
                console.error('❌ Error in showSection:', error);
            }
        }
        
        // Gán các hàm cần thiết vào window ngay lập tức
        window.showSection = showSection;
        window.logout = logout;
        window.debugData = debugData;
        window.loadSampleData = loadSampleData;
        window.loadRealtimeData = loadRealtimeData;
        window.showNotification = showNotification;
        window.formatCurrency = formatCurrency;
        window.addVNPayReportButton = addVNPayReportButton;
        window.startAutoRefresh = startAutoRefresh;
        window.refreshFirebaseData = refreshFirebaseData;
        window.generateVNPayReport = generateVNPayReport;
        window.showTimelineReport = showTimelineReport;
        window.viewBookingDetails = viewBookingDetails;
        window.reconcileHotel = reconcileHotel;
        window.processCommissions = processCommissions;
        window.exportRevenue = exportRevenue;
        window.refreshRevenue = refreshRevenue;
        window.filterRevenue = filterRevenue;
        window.processAllCommissions = processAllCommissions;
        window.commissionSettings = commissionSettings;
        window.payCommission = payCommission;
        window.startReconciliation = startReconciliation;
        window.autoReconcile = autoReconcile;
        window.uploadReconcileFile = uploadReconcileFile;
        window.downloadTemplate = downloadTemplate;
        window.investigateDiscrepancy = investigateDiscrepancy;
        window.markDispute = markDispute;
        window.requestData = requestData;
        window.generateFinanceReport = generateFinanceReport;
        window.scheduleReport = scheduleReport;
        window.generateReport = generateReport;
        window.cancelReport = cancelReport;
        window.testDataConnection = testDataConnection;
        window.checkFirebaseConnection = checkFirebaseConnection;
        window.retryFirebaseConnection = retryFirebaseConnection;
        window.toggleAutoRefresh = toggleAutoRefresh;
        window.showHotelTourStats = showHotelTourStats;
        window.updateRevenueSummary = updateRevenueSummary;
        window.updateCommissionTable = updateCommissionTable;
        window.viewCommissionDetails = viewCommissionDetails;
        window.refreshCommissionData = refreshCommissionData;
        window.loadAffiliatePartners = loadAffiliatePartners;
        window.viewPartnerDetails = viewPartnerDetails;
        window.editPartnerCommission = editPartnerCommission;
        window.saveCommissionSettings = saveCommissionSettings;
        window.savePaymentSettings = savePaymentSettings;
        window.saveNotificationSettings = saveNotificationSettings;
        window.generateReconciliationData = generateReconciliationData;
        window.updateReconciliationTable = updateReconciliationTable;
        window.reconcileItem = reconcileItem;
        window.viewReconciliationDetails = viewReconciliationDetails;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.appspot.com",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Khởi tạo Firebase
        let database;
        try {
            console.log('🔄 Initializing Firebase...');
            console.log('📦 Firebase SDK available:', typeof firebase !== 'undefined');
            console.log('🔧 Firebase App available:', typeof firebase !== 'undefined' && firebase.app);
            console.log('💾 Firebase Database available:', typeof firebase !== 'undefined' && firebase.database);
            
            // Kiểm tra xem Firebase có sẵn không
            if (typeof firebase !== 'undefined' && firebase.database) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('✅ Firebase initialized successfully');
                console.log('🔗 Database URL:', firebaseConfig.databaseURL);
                
                // Test connection
                database.ref('.info/connected').on('value', (snapshot) => {
                    console.log('🌐 Firebase connection status:', snapshot.val() ? 'Connected' : 'Disconnected');
                });
                
            } else {
                console.warn('⚠️ Firebase not available, using sample data');
                console.warn('❌ Firebase SDK missing or database module not loaded');
                database = null;
            }
        } catch (error) {
            console.error('❌ Firebase initialization error:', error);
            console.error('🔍 Error details:', error.message);
            database = null;
        }

        // Biến lưu trữ dữ liệu realtime
        let realtimeData = {
            bookings: {},
            payments: {},
            revenueStats: {
                totalRevenue: 0,
                hotelBookings: 0,
                tourBookings: 0,
                depositBookings: 0,
                vnpayPayments: 0,
                totalBookings: 0
            },
            monthlyStats: {
                currentMonth: 0,
                previousMonth: 0,
                growthRate: 0
            }
        };

        // Hàm format tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Hàm tính toán thống kê từ dữ liệu realtime
        function calculateRevenueStats() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            let totalRevenue = 0;
            let hotelBookings = 0;
            let tourBookings = 0;
            let depositBookings = 0;
            let vnpayPayments = 0;
            let currentMonthRevenue = 0;
            let previousMonthRevenue = 0;

            console.log('🔍 Calculating stats from:', Object.keys(realtimeData.bookings).length, 'bookings');

            // Tính toán từ bookings
            Object.values(realtimeData.bookings).forEach(booking => {
                if (!booking.createdAt) {
                    console.warn('⚠️ Booking missing createdAt:', booking);
                    return;
                }

                const bookingDate = new Date(booking.createdAt);
                const bookingMonth = bookingDate.getMonth();
                const bookingYear = bookingDate.getFullYear();
                
                if (booking.paymentStatus === 'paid') {
                    const bookingAmount = booking.totalPrice || 0;
                    totalRevenue += bookingAmount;
                    
                    if (booking.bookingType === 'hotel') {
                        hotelBookings++;
                    } else if (booking.bookingType === 'tour') {
                        tourBookings++;
                    } else if (booking.bookingType === 'deposit') {
                        depositBookings++;
                    }

                    // Tính doanh thu theo tháng
                    if (bookingMonth === currentMonth && bookingYear === currentYear) {
                        currentMonthRevenue += bookingAmount;
                    } else if (bookingMonth === (currentMonth - 1) && bookingYear === currentYear) {
                        previousMonthRevenue += bookingAmount;
                    }

                    console.log(`📊 Booking: ${booking.customerName} - ${booking.hotelName || booking.tourName} - ${formatCurrency(bookingAmount)}`);
                }
            });

            // Tính toán từ payments
            Object.values(realtimeData.payments).forEach(payment => {
                if (payment.method === 'VNPAY' && payment.status === 'success') {
                    vnpayPayments++;
                }
            });

            console.log('💰 Revenue calculation:');
            console.log('  - Total revenue:', formatCurrency(totalRevenue));
            console.log('  - Hotel bookings:', hotelBookings);
            console.log('  - Tour bookings:', tourBookings);
            console.log('  - Current month revenue:', formatCurrency(currentMonthRevenue));

            // Cập nhật thống kê
            realtimeData.revenueStats = {
                totalRevenue,
                hotelBookings,
                tourBookings,
                depositBookings,
                vnpayPayments,
                totalBookings: hotelBookings + tourBookings + depositBookings
            };

            realtimeData.monthlyStats = {
                currentMonth: currentMonthRevenue,
                previousMonth: previousMonthRevenue,
                growthRate: previousMonthRevenue > 0 ? ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100 : 0
            };

            // Cập nhật timestamp
            lastDataUpdate = Date.now();
            
            // Cập nhật UI
            updateRevenueUI();
            
            // Thông báo nếu có thay đổi đáng kể
            const previousTotal = realtimeData.revenueStats.totalRevenue || 0;
            if (totalRevenue > previousTotal) {
                const increase = totalRevenue - previousTotal;
                console.log(`📈 Revenue increased by ${formatCurrency(increase)}`);
            }
        }

        // Hàm cập nhật UI với dữ liệu realtime
        function updateRevenueUI() {
            const stats = realtimeData.revenueStats;
            const monthly = realtimeData.monthlyStats;

            console.log('🔄 Updating UI with stats:', stats);
            console.log('📅 Monthly stats:', monthly);

            // Cập nhật KPI Overview
            const kpiElements = document.querySelectorAll('.kpi-grid .stat-card .stat-number');
            if (kpiElements.length >= 4) {
                kpiElements[0].textContent = formatCurrency(monthly.currentMonth);
                kpiElements[1].textContent = formatCurrency(stats.totalRevenue * 0.15); // Hoa hồng 15%
                kpiElements[2].textContent = formatCurrency(stats.totalRevenue * 0.02); // Phí dịch vụ 2%
                kpiElements[3].textContent = '98.2%'; // Tỷ lệ đối soát
            }

            // Cập nhật Dashboard
            updateDashboard();

            // Cập nhật thống kê realtime trong Reports
            updateRealtimeStats();

            // Cập nhật bảng doanh thu
            updateRevenueTable();
            
            // Cập nhật bảng hoa hồng
            updateCommissionTable();
            
            // Cập nhật bảng đối soát
            updateReconciliationTable();
            
            // Load dữ liệu đối tác affiliate
            loadAffiliatePartners();
            
            // Load cài đặt
            loadSettings();
            
            // Hiển thị thống kê tổng hợp
            console.log('📊 Revenue Summary:');
            console.log(`  🏨 Hotel bookings: ${stats.hotelBookings} (${formatCurrency(stats.hotelBookings * 1000000)})`);
            console.log(`  🗺️ Tour bookings: ${stats.tourBookings} (${formatCurrency(stats.tourBookings * 500000)})`);
            console.log(`  💰 Total revenue: ${formatCurrency(stats.totalRevenue)}`);
            console.log(`  💳 VNPay transactions: ${stats.vnpayPayments}`);
        }

        // Hàm cập nhật thống kê realtime
        function updateRealtimeStats() {
            const stats = realtimeData.revenueStats;
            const monthly = realtimeData.monthlyStats;
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            // Thống kê tháng hiện tại
            const currentMonthStats = document.getElementById('currentMonthStats');
            if (currentMonthStats) {
                currentMonthStats.innerHTML = `
                    <div class="fw-bold text-success">${formatCurrency(monthly.currentMonth)}</div>
                    <div class="small text-muted">${stats.totalBookings} bookings</div>
                    <div class="small ${monthly.growthRate >= 0 ? 'text-success' : 'text-danger'}">
                        <i class="fas fa-arrow-${monthly.growthRate >= 0 ? 'up' : 'down'}"></i>
                        ${Math.abs(monthly.growthRate).toFixed(1)}% so tháng trước
                    </div>
                `;
            }

            // Thống kê VNPay
            const vnpayStats = document.getElementById('vnpayStats');
            if (vnpayStats) {
                const vnpayPayments = Object.values(realtimeData.payments).filter(
                    payment => payment.method === 'VNPAY' && payment.status === 'success'
                );
                const vnpayTotal = vnpayPayments.reduce((sum, p) => sum + p.amount, 0);
                
                vnpayStats.innerHTML = `
                    <div class="fw-bold text-warning">${vnpayPayments.length}</div>
                    <div class="small text-muted">${formatCurrency(vnpayTotal)}</div>
                    <div class="small text-muted">Giao dịch thành công</div>
                `;
            }

            // Thống kê booking khách sạn
            const hotelBookingStats = document.getElementById('hotelBookingStats');
            if (hotelBookingStats) {
                const hotelBookings = Object.values(realtimeData.bookings).filter(
                    booking => booking.bookingType === 'hotel' && booking.paymentStatus === 'paid'
                );
                const hotelRevenue = hotelBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
                
                hotelBookingStats.innerHTML = `
                    <div class="fw-bold text-success">${hotelBookings.length}</div>
                    <div class="small text-muted">${formatCurrency(hotelRevenue)}</div>
                    <div class="small text-muted">Đã thanh toán</div>
                `;
            }

            // Thống kê booking tour
            const tourBookingStats = document.getElementById('tourBookingStats');
            if (tourBookingStats) {
                const tourBookings = Object.values(realtimeData.bookings).filter(
                    booking => booking.bookingType === 'tour' && booking.paymentStatus === 'paid'
                );
                const tourRevenue = tourBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
                
                tourBookingStats.innerHTML = `
                    <div class="fw-bold text-info">${tourBookings.length}</div>
                    <div class="small text-muted">${formatCurrency(tourRevenue)}</div>
                    <div class="small text-muted">Đã thanh toán</div>
                `;
            }
        }

        // Hàm cập nhật bảng doanh thu với dữ liệu realtime
        function updateRevenueTable() {
            // Cập nhật thống kê tổng hợp
            updateRevenueSummary();
            
            // Cập nhật bảng Khách sạn
            updateHotelRevenueTable();
            
            // Cập nhật bảng Tours
            updateTourRevenueTable();
            
            // Cập nhật bảng Đặt cọc
            updateDepositTable();
            
            // Cập nhật bảng Ưu đãi
            updatePromotionTable();
        }

        // Hàm cập nhật bảng doanh thu Khách sạn
        function updateHotelRevenueTable() {
            const tableBody = document.getElementById('hotelRevenueTableBody');
            if (!tableBody) return;

            // Lọc booking khách sạn đã thanh toán
            const hotelBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.paymentStatus === 'paid' && booking.bookingType === 'hotel' && booking.hotelName
            );
            
            // Tạo dữ liệu theo khách sạn
            const hotelStats = {};
            
            hotelBookings.forEach(booking => {
                if (!hotelStats[booking.hotelName]) {
                    hotelStats[booking.hotelName] = {
                        bookings: 0,
                        grossRevenue: 0,
                        commission: 0,
                        netRevenue: 0,
                        lastBookingDate: null
                    };
                }
                
                hotelStats[booking.hotelName].bookings++;
                hotelStats[booking.hotelName].grossRevenue += booking.totalPrice || 0;
                
                // Cập nhật ngày booking mới nhất
                const bookingDate = new Date(booking.createdAt);
                if (!hotelStats[booking.hotelName].lastBookingDate || 
                    bookingDate > hotelStats[booking.hotelName].lastBookingDate) {
                    hotelStats[booking.hotelName].lastBookingDate = bookingDate;
                }
            });

            // Tính hoa hồng và doanh thu net
            Object.keys(hotelStats).forEach(hotelName => {
                const stats = hotelStats[hotelName];
                stats.commission = Math.round(stats.grossRevenue * 0.15); // 15% hoa hồng
                stats.netRevenue = stats.grossRevenue - stats.commission;
            });

            // Sắp xếp theo doanh thu giảm dần
            const sortedHotels = Object.keys(hotelStats).sort((a, b) => 
                hotelStats[b].grossRevenue - hotelStats[a].grossRevenue
            );

            // Tạo HTML cho bảng khách sạn
            let tableHTML = '';
            sortedHotels.forEach(hotelName => {
                const stats = hotelStats[hotelName];
                const bookingDate = stats.lastBookingDate ? 
                    stats.lastBookingDate.toLocaleDateString('vi-VN') : 
                    new Date().toLocaleDateString('vi-VN');
                
                tableHTML += `
                    <tr>
                        <td>${bookingDate}</td>
                        <td><i class="fas fa-hotel text-primary me-1"></i>${hotelName}</td>
                        <td>${stats.bookings} bookings</td>
                        <td class="fw-bold">${formatCurrency(stats.grossRevenue)}</td>
                        <td class="text-info">${formatCurrency(stats.commission)}</td>
                        <td class="text-success">${formatCurrency(stats.netRevenue)}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" title="Chi tiết" onclick="viewBookingDetails('${hotelName}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" title="Đối soát" onclick="reconcileHotel('${hotelName}')"><i class="fas fa-balance-scale"></i></button>
                        </td>
                    </tr>
                `;
            });

            // Nếu không có dữ liệu, hiển thị thông báo
            if (sortedHotels.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Chưa có dữ liệu booking khách sạn nào.
                        </td>
                    </tr>
                `;
            }

            tableBody.innerHTML = tableHTML;
        }

        // Hàm cập nhật bảng doanh thu Tours
        function updateTourRevenueTable() {
            const tableBody = document.getElementById('tourRevenueTableBody');
            if (!tableBody) return;

            // Lọc booking tour đã thanh toán
            const tourBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.paymentStatus === 'paid' && booking.bookingType === 'tour' && booking.tourName
            );
            
            // Tạo dữ liệu theo tour
            const tourStats = {};
            
            tourBookings.forEach(booking => {
                if (!tourStats[booking.tourName]) {
                    tourStats[booking.tourName] = {
                        bookings: 0,
                        grossRevenue: 0,
                        commission: 0,
                        netRevenue: 0,
                        lastBookingDate: null
                    };
                }
                
                tourStats[booking.tourName].bookings++;
                tourStats[booking.tourName].grossRevenue += booking.totalPrice || 0;
                
                // Cập nhật ngày booking mới nhất
                const bookingDate = new Date(booking.createdAt);
                if (!tourStats[booking.tourName].lastBookingDate || 
                    bookingDate > tourStats[booking.tourName].lastBookingDate) {
                    tourStats[booking.tourName].lastBookingDate = bookingDate;
                }
            });

            // Tính hoa hồng và doanh thu net
            Object.keys(tourStats).forEach(tourName => {
                const stats = tourStats[tourName];
                stats.commission = Math.round(stats.grossRevenue * 0.15); // 15% hoa hồng
                stats.netRevenue = stats.grossRevenue - stats.commission;
            });

            // Sắp xếp theo doanh thu giảm dần
            const sortedTours = Object.keys(tourStats).sort((a, b) => 
                tourStats[b].grossRevenue - tourStats[a].grossRevenue
            );

            // Tạo HTML cho bảng tour
            let tableHTML = '';
            sortedTours.forEach(tourName => {
                const stats = tourStats[tourName];
                const bookingDate = stats.lastBookingDate ? 
                    stats.lastBookingDate.toLocaleDateString('vi-VN') : 
                    new Date().toLocaleDateString('vi-VN');
                
                tableHTML += `
                    <tr>
                        <td>${bookingDate}</td>
                        <td><i class="fas fa-map-marked-alt text-warning me-1"></i>${tourName}</td>
                        <td>${stats.bookings} bookings</td>
                        <td class="fw-bold">${formatCurrency(stats.grossRevenue)}</td>
                        <td class="text-info">${formatCurrency(stats.commission)}</td>
                        <td class="text-success">${formatCurrency(stats.netRevenue)}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" title="Chi tiết" onclick="viewBookingDetails('${tourName}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" title="Đối soát" onclick="reconcileHotel('${tourName}')"><i class="fas fa-balance-scale"></i></button>
                        </td>
                    </tr>
                `;
            });

            // Nếu không có dữ liệu, hiển thị thông báo
            if (sortedTours.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Chưa có dữ liệu booking tour nào.
                        </td>
                    </tr>
                `;
            }

            tableBody.innerHTML = tableHTML;
        }

        // Hàm xem chi tiết booking theo khách sạn hoặc tour
        function viewBookingDetails(itemName) {
            const itemBookings = Object.values(realtimeData.bookings).filter(
                booking => (booking.hotelName === itemName || booking.tourName === itemName) && booking.paymentStatus === 'paid'
            );

            let detailsHTML = `
                <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi tiết booking - ${itemName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Booking ID</th>
                                                <th>Khách hàng</th>
                                                <th>Loại</th>
                                                <th>Số tiền</th>
                                                <th>Ngày tạo</th>
                                                <th>Ghi chú</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;

            itemBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt).toLocaleDateString('vi-VN');
                const typeIcon = booking.bookingType === 'hotel' ? '🏨' : '🗺️';
                const typeBadge = booking.bookingType === 'hotel' ? 'bg-primary' : 'bg-warning';
                
                detailsHTML += `
                    <tr>
                        <td>${booking.bookingType === 'hotel' ? 'H' : 'T'}-${booking.createdAt.toString().slice(-6)}</td>
                        <td>${booking.customerName}</td>
                        <td>
                            ${typeIcon} <span class="badge ${typeBadge}">${booking.bookingType.toUpperCase()}</span>
                        </td>
                        <td class="text-success">${formatCurrency(booking.totalPrice)}</td>
                        <td>${bookingDate}</td>
                        <td>${booking.note || '-'}</td>
                    </tr>
                `;
            });

            detailsHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('bookingDetailsModal');
            if (oldModal) oldModal.remove();

            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('bookingDetailsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    // Fallback: hiển thị thông tin trong alert
                    alert(`Chi tiết booking - ${itemName}\nSố booking: ${itemBookings.length}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Chi tiết booking - ${itemName}\nSố booking: ${itemBookings.length}`);
            }
        }

        // Hàm đối soát khách sạn hoặc tour
        function reconcileHotel(itemName) {
            const itemBookings = Object.values(realtimeData.bookings).filter(
                booking => (booking.hotelName === itemName || booking.tourName === itemName) && booking.paymentStatus === 'paid'
            );
            
            const totalAmount = itemBookings.reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
            const commission = totalAmount * 0.15;
            const itemType = itemBookings[0]?.bookingType === 'hotel' ? 'khách sạn' : 'tour';
            
            alert(`Đối soát ${itemName} (${itemType}):\nTổng doanh thu: ${formatCurrency(totalAmount)}\nHoa hồng (15%): ${formatCurrency(commission)}\nSố booking: ${itemBookings.length}`);
        }

        // Hàm lấy dữ liệu realtime từ Firebase
        function loadRealtimeData() {
            if (!database) {
                console.log('⚠️ Firebase not available, using sample data');
                loadSampleData();
                return;
            }

            let previousBookingCount = 0;
            let previousPaymentCount = 0;
            let lastUpdateTime = Date.now();

            try {
                console.log('🔄 Connecting to Firebase for real-time data...');
                
                // Lắng nghe thay đổi bookings với real-time updates
                database.ref('bookings').on('value', (snapshot) => {
                    const newBookings = snapshot.val() || {};
                    const currentBookingCount = Object.keys(newBookings).length;
                    const currentTime = Date.now();
                    
                    console.log('📊 Firebase Bookings loaded:', currentBookingCount, 'bookings');
                    
                    // Kiểm tra nếu có booking mới (trong 30 giây qua)
                    const recentBookings = Object.values(newBookings).filter(booking => 
                        booking.createdAt && (currentTime - booking.createdAt) < 30000
                    );
                    
                    if (recentBookings.length > 0) {
                        console.log('🆕 Recent bookings detected:', recentBookings.length);
                        recentBookings.forEach(booking => {
                            console.log(`📝 New booking: ${booking.customerName} - ${booking.hotelName || booking.tourName} - ${formatCurrency(booking.totalPrice)}`);
                            
                            // Hiển thị notification cho booking mới
                            showNotification(
                                `🆕 Booking mới: ${booking.customerName} - ${booking.hotelName || booking.tourName} (${formatCurrency(booking.totalPrice)})`,
                                'success'
                            );
                        });
                    }
                    
                    realtimeData.bookings = newBookings;
                    previousBookingCount = currentBookingCount;
                    
                    // Validate và sửa dữ liệu
                    validateAndFixData();
                    
                    // Tính toán thống kê và cập nhật UI ngay lập tức
                    calculateRevenueStats();
                    updateRevenueUI();
                    
                    // Hiển thị thông báo cập nhật
                    const paidBookings = Object.values(newBookings).filter(b => b.paymentStatus === 'paid');
                    const totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
                    
                    console.log('💰 Revenue updated:', formatCurrency(totalRevenue));
                    console.log('✅ UI updated automatically');
                    
                }, (error) => {
                    console.error('❌ Firebase bookings listener error:', error);
                    showNotification('Lỗi kết nối Firebase bookings', 'danger');
                });

                // Lắng nghe thay đổi payments với real-time updates
                database.ref('payments').on('value', (snapshot) => {
                    const newPayments = snapshot.val() || {};
                    const currentPaymentCount = Object.keys(newPayments).length;
                    const currentTime = Date.now();
                    
                    console.log('💰 Firebase Payments loaded:', currentPaymentCount, 'payments');
                    
                    // Kiểm tra nếu có payment mới (trong 30 giây qua)
                    const recentPayments = Object.values(newPayments).filter(payment => 
                        payment.date && (currentTime - payment.date) < 30000
                    );
                    
                    if (recentPayments.length > 0) {
                        console.log('💳 Recent payments detected:', recentPayments.length);
                        recentPayments.forEach(payment => {
                            console.log(`💳 New payment: ${payment.detail} - ${formatCurrency(payment.amount)}`);
                            
                            // Hiển thị notification cho payment mới
                            showNotification(
                                `💳 Giao dịch mới: ${payment.detail} (${formatCurrency(payment.amount)})`,
                                'info'
                            );
                        });
                    }
                    
                    realtimeData.payments = newPayments;
                    previousPaymentCount = currentPaymentCount;
                    
                    // Validate và sửa dữ liệu
                    validateAndFixData();
                    
                    // Tính toán thống kê và cập nhật UI ngay lập tức
                    calculateRevenueStats();
                    updateRevenueUI();
                    
                    console.log('✅ Payments updated automatically');
                    
                }, (error) => {
                    console.error('❌ Firebase payments listener error:', error);
                    showNotification('Lỗi kết nối Firebase payments', 'danger');
                });
                
                console.log('✅ Firebase real-time listeners set up successfully');
                showNotification('Đã kết nối Firebase real-time!', 'success');
                
            } catch (error) {
                console.error('❌ Firebase connection error:', error);
                showNotification('Lỗi kết nối Firebase', 'danger');
                loadSampleData();
            }
        }

        // Hàm debug để kiểm tra dữ liệu
        function debugData() {
            console.log('🔍 Debug Data:');
            console.log('📊 Total bookings:', Object.keys(realtimeData.bookings).length);
            console.log('💰 Total payments:', Object.keys(realtimeData.payments).length);
            
            const paidBookings = Object.values(realtimeData.bookings).filter(b => b.paymentStatus === 'paid');
            console.log('✅ Paid bookings:', paidBookings.length);
            
            const hotelBookings = paidBookings.filter(b => b.bookingType === 'hotel');
            const tourBookings = paidBookings.filter(b => b.bookingType === 'tour');
            
            console.log('🏨 Hotel bookings:', hotelBookings.length);
            console.log('🗺️ Tour bookings:', tourBookings.length);
            
            const totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            console.log('💵 Total revenue:', formatCurrency(totalRevenue));
            
            // Hiển thị thông báo với thông tin debug
            showNotification(
                `Debug: ${paidBookings.length} paid bookings, ${formatCurrency(totalRevenue)} total revenue`,
                'info'
            );
        }

        // Hàm load dữ liệu mẫu từ JSON local
        function loadSampleData() {
            console.log('🔄 Loading sample data...');
            
            // Dữ liệu mẫu từ file JSON
            const sampleBookings = {
                "-OWU-TTLBhqibLKUEeC7": {
                    "bookingType": "hotel",
                    "createdAt": 1753940617668,
                    "customerName": "Chức Nguyễn Tiến",
                    "hotelName": "Dakruco Hotel",
                    "paymentStatus": "paid",
                    "totalPrice": 1100000
                },
                "-OWU0jOK7V3E0F2SCgmE": {
                    "bookingType": "tour",
                    "createdAt": 1753940949131,
                    "customerName": "Chức Nguyễn Tiến",
                    "tourName": "Kayak và câu cá tại Vịnh Hạ Long",
                    "paymentStatus": "paid",
                    "totalPrice": 1200000
                },
                "-OWU14lysqE8zhmu6WlS": {
                    "bookingType": "hotel",
                    "createdAt": 1753941040818,
                    "customerName": "Chức Nguyễn Tiến",
                    "hotelName": "Combo Nghỉ Dưỡng Biển 5*",
                    "paymentStatus": "paid",
                    "totalPrice": 3200000
                },
                "-OWU2vIeIqHyqKyY-zM2": {
                    "bookingType": "hotel",
                    "createdAt": 1753941539233,
                    "customerName": "Chí Linh Trần",
                    "hotelName": "InterContinental Đà Nẵng Sun Peninsula Resort",
                    "paymentStatus": "paid",
                    "totalPrice": 3000000
                },
                "-OWUU8uc9KyMP6rpsxi4": {
                    "bookingType": "tour",
                    "createdAt": 1753948676845,
                    "customerName": "Chí Linh Trần",
                    "tourName": "Làm đèn lồng Hội An",
                    "paymentStatus": "paid",
                    "totalPrice": 500000
                },
                "-OWUUSSAIReOAFAYCUPL": {
                    "bookingType": "hotel",
                    "createdAt": 1753948756940,
                    "customerName": "Chí Linh Trần",
                    "hotelName": "Trốn Nóng Sapa Mờ Sương",
                    "paymentStatus": "paid",
                    "totalPrice": 2100000
                },
                "-OWU-DEPOSIT-001": {
                    "bookingType": "deposit",
                    "createdAt": 1753949000000,
                    "customerName": "Nguyễn Văn A",
                    "hotelName": "Luxury Resort Phú Quốc",
                    "paymentStatus": "paid",
                    "totalPrice": 500000,
                    "note": "Đặt cọc 50% cho booking tháng 12"
                },
                "-OWU-PROMO-001": {
                    "bookingType": "hotel",
                    "createdAt": 1753949100000,
                    "customerName": "Trần Thị B",
                    "hotelName": "Boutique Hotel Hội An",
                    "paymentStatus": "paid",
                    "totalPrice": 800000,
                    "note": "Ưu đãi mùa thấp điểm - giảm 30%"
                },
                "-OWU-DEPOSIT-002": {
                    "bookingType": "deposit",
                    "createdAt": 1753949200000,
                    "customerName": "Lê Văn C",
                    "tourName": "Tour Sapa 3 ngày 2 đêm",
                    "paymentStatus": "paid",
                    "totalPrice": 300000,
                    "note": "Đặt cọc tour Sapa"
                },
                "-OWU-PROMO-002": {
                    "bookingType": "tour",
                    "createdAt": 1753949300000,
                    "customerName": "Phạm Thị D",
                    "tourName": "Tour Đà Nẵng - Hội An",
                    "paymentStatus": "paid",
                    "totalPrice": 600000,
                    "note": "Promotion mùa hè - giảm 25%"
                }
            };

            const samplePayments = {
                "-OWU-ienEP52D-OxjrtB": {
                    "amount": 1100000,
                    "date": 1753940683998,
                    "detail": "Thanh toán đặt phòng/đặt tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "Đã cộng điểm thành viên: +11 điểm",
                    "status": "success",
                    "transactionId": "-OWU-TTLBhqibLKUEeC7"
                },
                "-OWU0zJ_QXWcR-4Ztpvo": {
                    "amount": 1200000,
                    "date": 1753941014353,
                    "detail": "Thanh toán đặt phòng/đặt tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "Đã cộng điểm thành viên: +12 điểm",
                    "status": "success",
                    "transactionId": "-OWU0jOK7V3E0F2SCgmE"
                },
                "-OWU1DB8y21-Kh7tV7oK": {
                    "amount": 3200000,
                    "date": 1753941075255,
                    "detail": "Thanh toán đặt phòng/đặt tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "Đã cộng điểm thành viên: +32 điểm",
                    "status": "success",
                    "transactionId": "-OWU14lysqE8zhmu6WlS"
                },
                "-OWU3MrjRmIWZ3E7ELDB": {
                    "amount": 3000000,
                    "date": 1753941656231,
                    "detail": "Thanh toán đặt phòng/đặt tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "Đã cộng điểm thành viên: +30 điểm",
                    "status": "success",
                    "transactionId": "-OWU2vIeIqHyqKyY-zM2"
                },
                "-OWUUImzReIpbzQeDIbN": {
                    "amount": 500000,
                    "date": 1753948717330,
                    "detail": "Thanh toán đặt phòng/đặt tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "Đã cộng điểm thành viên: +5 điểm",
                    "status": "success",
                    "transactionId": "-OWUU8uc9KyMP6rpsxi4"
                },
                "-OWUUcbi33FQHsLy6_ZM": {
                    "amount": 2100000,
                    "date": 1753948802681,
                    "detail": "Thanh toán đặt phòng/đặt tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "Đã cộng điểm thành viên: +21 điểm",
                    "status": "success",
                    "transactionId": "-OWUUSSAIReOAFAYCUPL"
                }
            };

            // Cập nhật dữ liệu realtime
            realtimeData.bookings = sampleBookings;
            realtimeData.payments = samplePayments;
            
            // Tính toán lại thống kê
            calculateRevenueStats();
            
            // Cập nhật UI ngay lập tức
            updateRevenueUI();
            
            showNotification('Đã load dữ liệu mẫu từ JSON local', 'success');
            console.log('📊 Sample data loaded:', Object.keys(sampleBookings).length, 'bookings');
            
            // Hiển thị dữ liệu trong console để debug
            console.log('�� Sample bookings:', sampleBookings);
            console.log('💰 Sample payments:', samplePayments);
            
            // Thông báo chi tiết về dữ liệu đã load
            const totalRevenue = Object.values(sampleBookings).reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
            const hotelCount = Object.values(sampleBookings).filter(b => b.bookingType === 'hotel').length;
            const tourCount = Object.values(sampleBookings).filter(b => b.bookingType === 'tour').length;
            
            console.log('📈 Data Summary:');
            console.log('  - Total Revenue:', formatCurrency(totalRevenue));
            console.log('  - Hotel Bookings:', hotelCount);
            console.log('  - Tour Bookings:', tourCount);
            console.log('  - Total Payments:', Object.keys(samplePayments).length);
            
            // Hiển thị thông báo chi tiết
            alert(`Dữ liệu đã được load thành công!\n\n📊 Tổng doanh thu: ${formatCurrency(totalRevenue)}\n🏨 Booking khách sạn: ${hotelCount}\n🗺️ Booking tour: ${tourCount}\n💰 Giao dịch VNPay: ${Object.keys(samplePayments).length}`);
        }

        // Hàm tạo báo cáo VNPay
        function generateVNPayReport() {
            const vnpayPayments = Object.values(realtimeData.payments).filter(
                payment => payment.method === 'VNPAY' && payment.status === 'success'
            );

            let reportHTML = `
                <div class="modal fade" id="vnpayReportModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Báo cáo giao dịch VNPay</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${vnpayPayments.length}</div>
                                            <div class="stat-label">Tổng giao dịch</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-info">${formatCurrency(vnpayPayments.reduce((sum, p) => sum + p.amount, 0))}</div>
                                            <div class="stat-label">Tổng tiền</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">${vnpayPayments.filter(p => p.detail.includes('đặt cọc')).length}</div>
                                            <div class="stat-label">Giao dịch cọc</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${vnpayPayments.filter(p => p.detail.includes('đặt phòng')).length}</div>
                                            <div class="stat-label">Giao dịch phòng</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Transaction ID</th>
                                                <th>Chi tiết</th>
                                                <th>Số tiền</th>
                                                <th>Ngày</th>
                                                <th>Ghi chú</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;

            vnpayPayments.forEach(payment => {
                const paymentDate = new Date(payment.date).toLocaleDateString('vi-VN');
                reportHTML += `
                    <tr>
                        <td>${payment.transactionId}</td>
                        <td>${payment.detail}</td>
                        <td class="text-success">${formatCurrency(payment.amount)}</td>
                        <td>${paymentDate}</td>
                        <td>${payment.note}</td>
                        <td><span class="badge bg-success">${payment.status}</span></td>
                    </tr>
                `;
            });

            reportHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('vnpayReportModal');
            if (oldModal) oldModal.remove();

            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', reportHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('vnpayReportModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    // Fallback: hiển thị thông tin trong alert
                    alert(`Báo cáo VNPay\nTổng giao dịch: ${vnpayPayments.length}\nTổng tiền: ${formatCurrency(vnpayPayments.reduce((sum, p) => sum + p.amount, 0))}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Báo cáo VNPay\nTổng giao dịch: ${vnpayPayments.length}\nTổng tiền: ${formatCurrency(vnpayPayments.reduce((sum, p) => sum + p.amount, 0))}`);
            }
        }

        // Thêm nút báo cáo VNPay vào section Reports
        function addVNPayReportButton() {
            const reportsSection = document.getElementById('reportsSection');
            const buttonContainer = reportsSection.querySelector('.d-flex.justify-content-between');
            
            if (buttonContainer) {
                const vnpayButton = document.createElement('button');
                vnpayButton.className = 'btn btn-warning btn-sm me-2';
                vnpayButton.innerHTML = '<i class="fas fa-credit-card"></i> Báo cáo VNPay';
                vnpayButton.onclick = generateVNPayReport;
                
                const timelineButton = document.createElement('button');
                timelineButton.className = 'btn btn-info btn-sm me-2';
                timelineButton.innerHTML = '<i class="fas fa-history"></i> Timeline';
                timelineButton.onclick = showTimelineReport;
                
                buttonContainer.querySelector('div').insertBefore(timelineButton, buttonContainer.querySelector('div').firstChild);
                buttonContainer.querySelector('div').insertBefore(vnpayButton, buttonContainer.querySelector('div').firstChild);
            }
        }

        // Hàm hiển thị timeline báo cáo
        function showTimelineReport() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            // Lọc dữ liệu theo tháng hiện tại
            const currentMonthBookings = Object.values(realtimeData.bookings).filter(booking => {
                const bookingDate = new Date(booking.createdAt);
                return bookingDate.getMonth() === currentMonth && 
                       bookingDate.getFullYear() === currentYear &&
                       booking.paymentStatus === 'paid';
            });

            const currentMonthPayments = Object.values(realtimeData.payments).filter(payment => {
                const paymentDate = new Date(payment.date);
                return paymentDate.getMonth() === currentMonth && 
                       paymentDate.getFullYear() === currentYear &&
                       payment.status === 'success';
            });

            // Sắp xếp theo thời gian
            const timelineData = [
                ...currentMonthBookings.map(booking => ({
                    type: 'booking',
                    data: booking,
                    timestamp: booking.createdAt
                })),
                ...currentMonthPayments.map(payment => ({
                    type: 'payment',
                    data: payment,
                    timestamp: payment.date
                }))
            ].sort((a, b) => b.timestamp - a.timestamp);

            let timelineHTML = `
                <div class="modal fade" id="timelineModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Timeline tháng ${currentMonth + 1}/${currentYear}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${currentMonthBookings.length}</div>
                                            <div class="stat-label">Booking tháng này</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${currentMonthPayments.length}</div>
                                            <div class="stat-label">Giao dịch thành công</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-info">${formatCurrency(currentMonthBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0))}</div>
                                            <div class="stat-label">Tổng doanh thu</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">${currentMonthPayments.filter(p => p.method === 'VNPAY').length}</div>
                                            <div class="stat-label">Giao dịch VNPay</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="timeline-container" style="max-height: 500px; overflow-y: auto;">
            `;

            timelineData.forEach(item => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
                
                if (item.type === 'booking') {
                    const booking = item.data;
                    timelineHTML += `
                        <div class="timeline-item mb-3 p-3 border-start border-3 border-primary" style="margin-left: 20px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fas fa-${booking.bookingType === 'hotel' ? 'hotel' : 'map-marked-alt'} text-primary"></i>
                                        Booking ${booking.bookingType === 'hotel' ? 'Khách sạn' : 'Tour'}
                                    </h6>
                                    <p class="mb-1"><strong>${booking.customerName}</strong> - ${booking.hotelName || booking.tourName}</p>
                                    <p class="mb-1 text-success"><strong>${formatCurrency(booking.totalPrice)}</strong></p>
                                    <small class="text-muted">${formattedDate}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">${booking.paymentStatus}</span>
                                    <br>
                                    <small class="text-muted">${booking.paymentMethod?.toUpperCase()}</small>
                                </div>
                            </div>
                            ${booking.note ? `<div class="mt-2"><small class="text-muted"><i class="fas fa-sticky-note"></i> ${booking.note}</small></div>` : ''}
                        </div>
                    `;
                } else {
                    const payment = item.data;
                    timelineHTML += `
                        <div class="timeline-item mb-3 p-3 border-start border-3 border-success" style="margin-left: 20px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fas fa-credit-card text-success"></i>
                                        Giao dịch ${payment.method}
                                    </h6>
                                    <p class="mb-1"><strong>${payment.detail}</strong></p>
                                    <p class="mb-1 text-success"><strong>${formatCurrency(payment.amount)}</strong></p>
                                    <small class="text-muted">${formattedDate}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">${payment.status}</span>
                                    <br>
                                    <small class="text-muted">Transaction ID: ${payment.transactionId}</small>
                                </div>
                            </div>
                            ${payment.note ? `<div class="mt-2"><small class="text-muted"><i class="fas fa-info-circle"></i> ${payment.note}</small></div>` : ''}
                        </div>
                    `;
                }
            });

            timelineHTML += `
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('timelineModal');
            if (oldModal) oldModal.remove();

            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', timelineHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('timelineModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    // Fallback: hiển thị thông tin trong alert
                    alert(`Timeline tháng ${currentMonth + 1}/${currentYear}\nBooking: ${currentMonthBookings.length}\nGiao dịch: ${currentMonthPayments.length}\nDoanh thu: ${formatCurrency(currentMonthBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0))}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Timeline tháng ${currentMonth + 1}/${currentYear}\nBooking: ${currentMonthBookings.length}\nGiao dịch: ${currentMonthPayments.length}\nDoanh thu: ${formatCurrency(currentMonthBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0))}`);
            }
        }

        // Định nghĩa các hàm global
        function processCommissions() {
            if (confirm('Xử lý thanh toán hoa hồng cho tất cả khách sạn đang chờ?')) {
                alert('Đang xử lý thanh toán hoa hồng...\nThời gian ước tính: 5-10 phút');
            }
        }

        function exportRevenue() {
            const stats = realtimeData.revenueStats;
            const monthly = realtimeData.monthlyStats;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Báo cáo doanh thu\n";
            csvContent += `Tổng doanh thu,${formatCurrency(stats.totalRevenue)}\n`;
            csvContent += `Doanh thu tháng hiện tại,${formatCurrency(monthly.currentMonth)}\n`;
            csvContent += `Số booking khách sạn,${stats.hotelBookings}\n`;
            csvContent += `Số booking tour,${stats.tourBookings}\n`;
            csvContent += `Số giao dịch VNPay,${stats.vnpayPayments}\n`;
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "bao_cao_doanh_thu.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function refreshRevenue() {
            if (database) {
                console.log('🔄 Refreshing revenue data from Firebase...');
                refreshFirebaseData();
            } else {
                alert('Đang làm mới dữ liệu doanh thu từ hệ thống...');
                setTimeout(() => {
                    alert('Dữ liệu đã được cập nhật!');
                }, 2000);
            }
        }

        function filterRevenue() {
            const hotel = document.getElementById('revenueHotel').value;
            const fromDate = document.getElementById('revenueFromDate').value;
            const toDate = document.getElementById('revenueToDate').value;
            alert(`Lọc dữ liệu:\nKhách sạn: ${hotel || 'Tất cả'}\nTừ: ${fromDate}\nĐến: ${toDate}`);
        }

        function processAllCommissions() {
            const commissionAmount = realtimeData.revenueStats.totalRevenue * 0.15;
            if (confirm(`Thanh toán hoa hồng cho tất cả khách sạn đang chờ (${formatCurrency(commissionAmount)})?`)) {
                alert('Đang xử lý thanh toán...\nThông báo sẽ được gửi đến các khách sạn');
            }
        }

        function commissionSettings() {
            alert('Mở modal cài đặt tỷ lệ hoa hồng cho từng khách sạn');
        }

        function payCommission(hotelId) {
            const hotelNames = {
                'luxury-hn': 'Luxury Hotel HN',
                'beach-dn': 'Beach Resort DN'
            };
            if (confirm(`Thanh toán hoa hồng cho ${hotelNames[hotelId]}?`)) {
                alert(`Đang xử lý thanh toán cho ${hotelNames[hotelId]}...`);
            }
        }

        function startReconciliation() {
            alert('Bắt đầu quy trình đối soát thủ công\nVui lòng chọn kỳ đối soát và khách sạn');
        }

        function autoReconcile() {
            if (confirm('Chạy tự động đối soát cho tất cả khách sạn?')) {
                alert('Đang chạy tự động đối soát...\nKết quả sẽ có trong 15-30 phút');
            }
        }

        function uploadReconcileFile() {
            const fileInput = document.getElementById('reconcileFile');
            if (fileInput.files.length === 0) {
                alert('Vui lòng chọn file để upload');
                return;
            }
            alert(`Đang upload file: ${fileInput.files[0].name}\nHệ thống sẽ xử lý và đối soát tự động`);
        }

        function downloadTemplate() {
            alert('Tải template Excel cho khách sạn\nFile chứa các cột: Booking ID, Date, Amount, Status');
        }

        function investigateDiscrepancy(bookingId) {
            alert(`Điều tra chênh lệch cho booking ${bookingId}\nMở chi tiết giao dịch và lịch sử thay đổi`);
        }

        function markDispute(bookingId) {
            if (confirm(`Đánh dấu dispute cho booking ${bookingId}?`)) {
                alert('Đã tạo ticket dispute và gửi thông báo đến khách sạn');
            }
        }

        function requestData(bookingId) {
            alert(`Gửi yêu cầu dữ liệu cho booking ${bookingId}\nEmail sẽ được gửi đến khách sạn`);
        }

        function generateFinanceReport() {
            alert('Mở form tạo báo cáo tài chính tùy chỉnh\nChọn loại báo cáo, kỳ báo cáo và định dạng');
        }

        function scheduleReport() {
            alert('Cài đặt lên lịch báo cáo tự động\nChọn tần suất: hàng ngày, tuần, tháng');
        }

        function generateReport(type) {
            const types = {
                'revenue': 'Báo cáo doanh thu',
                'commission': 'Báo cáo hoa hồng', 
                'reconciliation': 'Báo cáo đối soát'
            };
            alert(`Tạo ${types[type]} cho kỳ hiện tại\nBáo cáo sẽ được tạo trong 5-10 phút`);
        }

        function cancelReport(reportId) {
            if (confirm('Hủy báo cáo đang xử lý?')) {
                alert(`Đã hủy báo cáo ${reportId}`);
            }
        }

        // Hàm refresh dữ liệu từ Firebase
        function refreshFirebaseData() {
            if (!database) {
                alert('Firebase không khả dụng. Vui lòng kiểm tra kết nối.');
                return;
            }

            console.log('🔄 Refreshing data from Firebase...');
            
            // Lấy dữ liệu bookings mới nhất
            database.ref('bookings').once('value').then((snapshot) => {
                const newBookings = snapshot.val() || {};
                realtimeData.bookings = newBookings;
                console.log('📊 Fresh bookings loaded:', Object.keys(newBookings).length);
                
                // Lấy dữ liệu payments mới nhất
                return database.ref('payments').once('value');
            }).then((snapshot) => {
                const newPayments = snapshot.val() || {};
                realtimeData.payments = newPayments;
                console.log('💰 Fresh payments loaded:', Object.keys(newPayments).length);
                
                // Tính toán lại thống kê
                calculateRevenueStats();
                
                // Cập nhật UI
                updateRevenueUI();
                
                showNotification('Đã refresh dữ liệu từ Firebase thành công!', 'success');
                
                // Hiển thị thông tin chi tiết
                const totalBookings = Object.keys(realtimeData.bookings).length;
                const totalPayments = Object.keys(realtimeData.payments).length;
                const paidBookings = Object.values(realtimeData.bookings).filter(b => b.paymentStatus === 'paid');
                const totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
                
                alert(`Dữ liệu Firebase đã được cập nhật!\n\n📊 Tổng booking: ${totalBookings}\n✅ Đã thanh toán: ${paidBookings.length}\n💰 Tổng doanh thu: ${formatCurrency(totalRevenue)}\n💳 Giao dịch: ${totalPayments}`);
                
            }).catch((error) => {
                console.error('❌ Error refreshing Firebase data:', error);
                alert('Lỗi khi refresh dữ liệu từ Firebase. Vui lòng thử lại.');
            });
        }

        // Các hàm chức năng Dashboard
        window.processCommissions = processCommissions;

        // Gán các hàm vào window object
        window.exportRevenue = exportRevenue;
        window.refreshRevenue = refreshRevenue;
        window.filterRevenue = filterRevenue;
        window.processAllCommissions = processAllCommissions;
        window.commissionSettings = commissionSettings;
        window.payCommission = payCommission;
        window.startReconciliation = startReconciliation;
        window.autoReconcile = autoReconcile;
        window.uploadReconcileFile = uploadReconcileFile;
        window.downloadTemplate = downloadTemplate;
        window.investigateDiscrepancy = investigateDiscrepancy;
        window.markDispute = markDispute;
        window.requestData = requestData;
        window.generateFinanceReport = generateFinanceReport;
        window.scheduleReport = scheduleReport;
        window.generateReport = generateReport;
        window.cancelReport = cancelReport;
        window.testDataConnection = testDataConnection;
        window.checkFirebaseConnection = checkFirebaseConnection;
        window.retryFirebaseConnection = retryFirebaseConnection;
        window.toggleAutoRefresh = toggleAutoRefresh;
        window.logout = logout;
        window.showHotelTourStats = showHotelTourStats;
        window.updateRevenueSummary = updateRevenueSummary;
        window.updateCommissionTable = updateCommissionTable;
        window.viewCommissionDetails = viewCommissionDetails;
        window.refreshCommissionData = refreshCommissionData;

        // Simulate real-time updates
        function updateFinanceStats() {
            // Animate numbers slightly
            const stats = document.querySelectorAll('.stat-number');
            stats.forEach(stat => {
                stat.style.transition = 'color 0.3s ease';
                stat.style.color = '#00eaff';
                setTimeout(() => {
                    stat.style.color = '';
                }, 500);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Finance Manager initialized');
            
            // Show role section by default
            showSection('role');
            
            // Load realtime data from Firebase
            loadRealtimeData();
            
            // Add VNPay report button
            addVNPayReportButton();
            
            // Start auto-refresh system
            startAutoRefresh();
            
            // Start real-time monitoring
            monitorRealTimeChanges();
            
            // Update stats every 30 seconds
            setInterval(updateFinanceStats, 30000);
            
            // Ensure all functions are available globally
            window.showSection = showSection;
            window.loadRealtimeData = loadRealtimeData;
            window.debugData = debugData;
            window.loadSampleData = loadSampleData;
            window.refreshFirebaseData = refreshFirebaseData;
            window.generateVNPayReport = generateVNPayReport;
            window.showTimelineReport = showTimelineReport;
            window.viewBookingDetails = viewBookingDetails;
            window.reconcileHotel = reconcileHotel;
            window.processCommissions = processCommissions;
            window.exportRevenue = exportRevenue;
            window.refreshRevenue = refreshRevenue;
            window.filterRevenue = filterRevenue;
            window.processAllCommissions = processAllCommissions;
            window.commissionSettings = commissionSettings;
            window.payCommission = payCommission;
            window.startReconciliation = startReconciliation;
            window.autoReconcile = autoReconcile;
            window.uploadReconcileFile = uploadReconcileFile;
            window.downloadTemplate = downloadTemplate;
            window.investigateDiscrepancy = investigateDiscrepancy;
            window.markDispute = markDispute;
            window.requestData = requestData;
            window.generateFinanceReport = generateFinanceReport;
            window.scheduleReport = scheduleReport;
            window.generateReport = generateReport;
            window.cancelReport = cancelReport;
            window.testDataConnection = testDataConnection;
            window.checkFirebaseConnection = checkFirebaseConnection;
            window.retryFirebaseConnection = retryFirebaseConnection;
            window.toggleAutoRefresh = toggleAutoRefresh;
            window.logout = logout;
            window.showHotelTourStats = showHotelTourStats;
            window.updateRevenueSummary = updateRevenueSummary;
            window.updateCommissionTable = updateCommissionTable;
            window.viewCommissionDetails = viewCommissionDetails;
            window.refreshCommissionData = refreshCommissionData;
            window.loadAffiliatePartners = loadAffiliatePartners;
            window.viewPartnerDetails = viewPartnerDetails;
            window.editPartnerCommission = editPartnerCommission;
            window.saveCommissionSettings = saveCommissionSettings;
            window.savePaymentSettings = savePaymentSettings;
            window.saveNotificationSettings = saveNotificationSettings;
            window.updateAllAffiliateCommissions = updateAllAffiliateCommissions;
            window.loadSettingsFromFirebase = loadSettingsFromFirebase;
            window.loadSettingsFromLocal = loadSettingsFromLocal;
            window.updateDashboard = updateDashboard;
            window.updateDashboardStats = updateDashboardStats;
            window.updateTopHotels = updateTopHotels;
            window.updateTopPartners = updateTopPartners;
            window.updateRecentTransactions = updateRecentTransactions;
            window.updateRecentActivities = updateRecentActivities;
            window.generateReconciliationData = generateReconciliationData;
            window.updateReconciliationTable = updateReconciliationTable;
            window.reconcileItem = reconcileItem;
            window.viewReconciliationDetails = viewReconciliationDetails;
            window.loadAffiliatePartners = loadAffiliatePartners;
            window.viewPartnerDetails = viewPartnerDetails;
            window.editPartnerCommission = editPartnerCommission;
            window.saveCommissionSettings = saveCommissionSettings;
            window.savePaymentSettings = savePaymentSettings;
            window.saveNotificationSettings = saveNotificationSettings;
            
            console.log('✅ All functions registered globally');
            
            // Auto-load sample data immediately if Firebase not available
            if (!database) {
                console.log('🔄 Firebase not available, loading sample data immediately...');
                loadSampleData();
            } else {
                // Auto-load sample data if no data available after 2 seconds
                setTimeout(() => {
                    if (Object.keys(realtimeData.bookings).length === 0) {
                        console.log('🔄 Auto-loading sample data...');
                        loadSampleData();
                    }
                }, 2000);
            }
            
            // Force update UI after 1 second
            setTimeout(() => {
                console.log('🔄 Force updating UI...');
                updateRevenueUI();
            }, 1000);
            
            // Show connection status
            setTimeout(() => {
                if (database) {
                    showNotification('✅ Đã kết nối Firebase real-time!', 'success');
                } else {
                    showNotification('⚠️ Sử dụng dữ liệu mẫu - Auto-refresh mỗi 30s', 'warning');
                }
            }, 2000);
        });

        // Notification system
        function showNotification(message, type = 'info') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Auto-refresh dashboard data every 5 minutes
        setInterval(() => {
            if (document.getElementById('dashboardSection').classList.contains('active')) {
                showNotification('Dữ liệu dashboard đã được cập nhật', 'success');
            }
        }, 300000);

        // Đăng xuất với Firebase Auth
        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                // Kiểm tra xem Firebase Auth có sẵn không
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().signOut().then(() => {
                        console.log('Đăng xuất thành công');
                        window.location.href = '../auth.html';
                    }).catch((error) => {
                        console.error('Lỗi đăng xuất:', error);
                        // Vẫn chuyển trang nếu có lỗi
                        window.location.href = '../auth.html';
                    });
                } else {
                    // Fallback nếu Firebase không có
                    window.location.href = '../auth.html';
                }
            }
        }

        // Hàm kiểm tra và sửa dữ liệu từ Firebase
        function validateAndFixData() {
            console.log('🔍 Validating and fixing data...');
            
            // Kiểm tra bookings
            Object.keys(realtimeData.bookings).forEach(bookingId => {
                const booking = realtimeData.bookings[bookingId];
                
                // Đảm bảo có các trường cần thiết
                if (!booking.bookingType) {
                    booking.bookingType = 'hotel'; // Mặc định là hotel
                }
                if (!booking.paymentStatus) {
                    booking.paymentStatus = 'paid'; // Mặc định là đã thanh toán
                }
                if (!booking.totalPrice) {
                    booking.totalPrice = 0;
                }
                if (!booking.createdAt) {
                    booking.createdAt = Date.now();
                }
                
                console.log(`✅ Booking ${bookingId}: ${booking.customerName} - ${formatCurrency(booking.totalPrice)}`);
            });
            
            // Kiểm tra payments
            Object.keys(realtimeData.payments).forEach(paymentId => {
                const payment = realtimeData.payments[paymentId];
                
                // Đảm bảo có các trường cần thiết
                if (!payment.method) {
                    payment.method = 'VNPAY';
                }
                if (!payment.status) {
                    payment.status = 'success';
                }
                if (!payment.amount) {
                    payment.amount = 0;
                }
                if (!payment.date) {
                    payment.date = Date.now();
                }
                
                console.log(`✅ Payment ${paymentId}: ${payment.detail} - ${formatCurrency(payment.amount)}`);
            });
            
            console.log('✅ Data validation completed');
        }

        // Hàm debug để kiểm tra dữ liệu
        function debugData() {
            console.log('🔍 Debug Data:');
            console.log('📊 Total bookings:', Object.keys(realtimeData.bookings).length);
            console.log('💰 Total payments:', Object.keys(realtimeData.payments).length);
            
            const paidBookings = Object.values(realtimeData.bookings).filter(b => b.paymentStatus === 'paid');
            console.log('✅ Paid bookings:', paidBookings.length);
            
            const hotelBookings = paidBookings.filter(b => b.bookingType === 'hotel');
            const tourBookings = paidBookings.filter(b => b.bookingType === 'tour');
            
            console.log('🏨 Hotel bookings:', hotelBookings.length);
            console.log('🗺️ Tour bookings:', tourBookings.length);
            
            const totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            console.log('💵 Total revenue:', formatCurrency(totalRevenue));
            
            // Hiển thị thông báo với thông tin debug
            showNotification(
                `Debug: ${paidBookings.length} paid bookings, ${formatCurrency(totalRevenue)} total revenue`,
                'info'
            );
        }

        // Hàm test kết nối dữ liệu
        function testDataConnection() {
            console.log('🧪 Testing data connection...');
            
            let testResults = {
                firebase: database ? '✅ Connected' : '❌ Not available',
                bookings: Object.keys(realtimeData.bookings).length,
                payments: Object.keys(realtimeData.payments).length,
                paidBookings: 0,
                totalRevenue: 0,
                hotelBookings: 0,
                tourBookings: 0,
                vnpayPayments: 0
            };
            
            // Tính toán thống kê
            const paidBookings = Object.values(realtimeData.bookings).filter(b => b.paymentStatus === 'paid');
            testResults.paidBookings = paidBookings.length;
            testResults.totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            testResults.hotelBookings = paidBookings.filter(b => b.bookingType === 'hotel').length;
            testResults.tourBookings = paidBookings.filter(b => b.bookingType === 'tour').length;
            testResults.vnpayPayments = Object.values(realtimeData.payments).filter(p => p.method === 'VNPAY' && p.status === 'success').length;
            
            // Hiển thị kết quả
            const resultHTML = `
                <div class="modal fade" id="testDataModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Kết quả kiểm tra dữ liệu</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Kết nối Firebase:</h6>
                                        <p class="text-${testResults.firebase.includes('✅') ? 'success' : 'danger'}">${testResults.firebase}</p>
                                        
                                        <h6>Thống kê dữ liệu:</h6>
                                        <ul>
                                            <li>Tổng booking: ${testResults.bookings}</li>
                                            <li>Booking đã thanh toán: ${testResults.paidBookings}</li>
                                            <li>Booking khách sạn: ${testResults.hotelBookings}</li>
                                            <li>Booking tour: ${testResults.tourBookings}</li>
                                            <li>Tổng giao dịch: ${testResults.payments}</li>
                                            <li>Giao dịch VNPay: ${testResults.vnpayPayments}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Doanh thu:</h6>
                                        <p class="fw-bold text-success">${formatCurrency(testResults.totalRevenue)}</p>
                                        
                                        <h6>Chi tiết booking:</h6>
                                        <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            // Hiển thị chi tiết booking
            paidBookings.forEach((booking, index) => {
                if (index < 5) { // Chỉ hiển thị 5 booking đầu
                    resultHTML += `
                        <div class="small mb-1">
                            <strong>${booking.customerName}</strong> - 
                            ${booking.hotelName || booking.tourName} - 
                            <span class="text-success">${formatCurrency(booking.totalPrice)}</span>
                        </div>
                    `;
                }
            });
            
            if (paidBookings.length > 5) {
                resultHTML += `<div class="small text-muted">... và ${paidBookings.length - 5} booking khác</div>`;
            }
            
            resultHTML += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('testDataModal');
            if (oldModal) oldModal.remove();
            
            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', resultHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('testDataModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    // Fallback: hiển thị thông tin trong alert
                    alert(`Test Data Results:\nFirebase: ${testResults.firebase}\nBookings: ${testResults.bookings}\nRevenue: ${formatCurrency(testResults.totalRevenue)}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Test Data Results:\nFirebase: ${testResults.firebase}\nBookings: ${testResults.bookings}\nRevenue: ${formatCurrency(testResults.totalRevenue)}`);
            }
        }

        // Hàm kiểm tra kết nối Firebase
        function checkFirebaseConnection() {
            console.log('🔍 Checking Firebase connection...');
            
            let connectionStatus = {
                sdkLoaded: typeof firebase !== 'undefined',
                appAvailable: typeof firebase !== 'undefined' && firebase.app,
                databaseAvailable: typeof firebase !== 'undefined' && firebase.database,
                databaseInitialized: database !== null,
                configValid: false,
                connectionTest: false
            };
            
            // Kiểm tra config
            if (firebaseConfig && firebaseConfig.databaseURL) {
                connectionStatus.configValid = true;
            }
            
            // Test connection nếu database đã khởi tạo
            if (database) {
                try {
                    database.ref('.info/connected').once('value').then((snapshot) => {
                        connectionStatus.connectionTest = snapshot.val() === true;
                        console.log('🌐 Connection test result:', connectionStatus.connectionTest);
                    }).catch((error) => {
                        console.error('❌ Connection test failed:', error);
                        connectionStatus.connectionTest = false;
                    });
                } catch (error) {
                    console.error('❌ Connection test error:', error);
                    connectionStatus.connectionTest = false;
                }
            }
            
            // Hiển thị kết quả
            const statusHTML = `
                <div class="modal fade" id="firebaseStatusModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Firebase Connection Status</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>SDK Status:</h6>
                                        <ul>
                                            <li>Firebase SDK: <span class="text-${connectionStatus.sdkLoaded ? 'success' : 'danger'}">${connectionStatus.sdkLoaded ? '✅ Loaded' : '❌ Not loaded'}</span></li>
                                            <li>Firebase App: <span class="text-${connectionStatus.appAvailable ? 'success' : 'danger'}">${connectionStatus.appAvailable ? '✅ Available' : '❌ Not available'}</span></li>
                                            <li>Firebase Database: <span class="text-${connectionStatus.databaseAvailable ? 'success' : 'danger'}">${connectionStatus.databaseAvailable ? '✅ Available' : '❌ Not available'}</span></li>
                                            <li>Database Initialized: <span class="text-${connectionStatus.databaseInitialized ? 'success' : 'danger'}">${connectionStatus.databaseInitialized ? '✅ Yes' : '❌ No'}</span></li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Configuration:</h6>
                                        <ul>
                                            <li>Config Valid: <span class="text-${connectionStatus.configValid ? 'success' : 'danger'}">${connectionStatus.configValid ? '✅ Yes' : '❌ No'}</span></li>
                                            <li>Database URL: <code>${firebaseConfig.databaseURL || 'Not set'}</code></li>
                                            <li>Project ID: <code>${firebaseConfig.projectId || 'Not set'}</code></li>
                                            <li>Connection Test: <span class="text-${connectionStatus.connectionTest ? 'success' : 'warning'}">${connectionStatus.connectionTest ? '✅ Connected' : '⏳ Testing...'}</span></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Troubleshooting:</h6>
                                    <ul>
                                        <li>Check if Firebase SDK is loaded properly</li>
                                        <li>Verify database URL is correct</li>
                                        <li>Check network connection</li>
                                        <li>Verify Firebase project settings</li>
                                    </ul>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-primary btn-sm me-2" onclick="retryFirebaseConnection()">
                                        <i class="fas fa-redo"></i> Retry Connection
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="loadSampleData()">
                                        <i class="fas fa-database"></i> Use Sample Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('firebaseStatusModal');
            if (oldModal) oldModal.remove();
            
            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', statusHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('firebaseStatusModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    // Fallback: hiển thị thông tin trong alert
                    alert(`Firebase Status:\nSDK: ${connectionStatus.sdkLoaded ? 'Loaded' : 'Not loaded'}\nDatabase: ${connectionStatus.databaseAvailable ? 'Available' : 'Not available'}\nInitialized: ${connectionStatus.databaseInitialized ? 'Yes' : 'No'}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Firebase Status:\nSDK: ${connectionStatus.sdkLoaded ? 'Loaded' : 'Not loaded'}\nDatabase: ${connectionStatus.databaseAvailable ? 'Available' : 'Not available'}\nInitialized: ${connectionStatus.databaseInitialized ? 'Yes' : 'No'}`);
            }
        }

        // Hàm retry kết nối Firebase
        function retryFirebaseConnection() {
            console.log('🔄 Retrying Firebase connection...');
            
            // Đóng modal hiện tại
            const modal = bootstrap.Modal.getInstance(document.getElementById('firebaseStatusModal'));
            if (modal) modal.hide();
            
            // Thử khởi tạo lại Firebase
            try {
                if (typeof firebase !== 'undefined' && firebase.database) {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    console.log('✅ Firebase re-initialized successfully');
                    
                    // Load dữ liệu realtime
                    loadRealtimeData();
                    
                    showNotification('Firebase connection restored!', 'success');
                } else {
                    console.error('❌ Firebase SDK still not available');
                    showNotification('Firebase SDK not available', 'danger');
                }
            } catch (error) {
                console.error('❌ Firebase re-initialization failed:', error);
                showNotification('Failed to connect to Firebase', 'danger');
            }
        }

        // Hệ thống auto-refresh và monitoring
        let autoRefreshInterval;
        let lastDataUpdate = Date.now();
        
        function startAutoRefresh() {
            // Auto-refresh mỗi 30 giây nếu Firebase không khả dụng
            if (!database) {
                autoRefreshInterval = setInterval(() => {
                    console.log('🔄 Auto-refreshing data...');
                    loadSampleData();
                    showNotification('Dữ liệu đã được cập nhật tự động', 'info');
                }, 30000);
            }
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Hàm monitor real-time changes
        function monitorRealTimeChanges() {
            // Monitor mỗi 10 giây để kiểm tra có dữ liệu mới không
            setInterval(() => {
                const currentTime = Date.now();
                const timeSinceLastUpdate = currentTime - lastDataUpdate;
                
                // Nếu không có cập nhật trong 1 phút, thông báo
                if (timeSinceLastUpdate > 60000 && database) {
                    console.log('⚠️ No data updates in the last minute');
                    showNotification('Đang chờ dữ liệu mới...', 'warning');
                }
                
                // Cập nhật timestamp
                lastDataUpdate = currentTime;
            }, 10000);
        }

        // Hàm bật/tắt auto-refresh
        function toggleAutoRefresh() {
            const button = document.getElementById('autoRefreshBtn');
            if (autoRefreshInterval) {
                stopAutoRefresh();
                button.innerHTML = '<i class="fas fa-sync"></i> Auto-refresh OFF';
                button.className = 'btn btn-outline-secondary btn-sm me-2';
                showNotification('Auto-refresh đã tắt', 'warning');
            } else {
                startAutoRefresh();
                button.innerHTML = '<i class="fas fa-sync fa-spin"></i> Auto-refresh ON';
                button.className = 'btn btn-secondary btn-sm me-2';
                showNotification('Auto-refresh đã bật', 'success');
            }
        }

        // Hàm hiển thị thống kê Hotel vs Tour
        function showHotelTourStats() {
            const stats = realtimeData.revenueStats;
            
            // Tính toán chi tiết
            const hotelBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'hotel' && booking.paymentStatus === 'paid'
            );
            const tourBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'tour' && booking.paymentStatus === 'paid'
            );
            
            const hotelRevenue = hotelBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            const tourRevenue = tourBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            
            const totalBookings = stats.totalBookings;
            const hotelPercentage = totalBookings > 0 ? ((stats.hotelBookings / totalBookings) * 100).toFixed(1) : 0;
            const tourPercentage = totalBookings > 0 ? ((stats.tourBookings / totalBookings) * 100).toFixed(1) : 0;
            
            const statsHTML = `
                <div class="modal fade" id="hotelTourStatsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Thống kê Hotel vs Tour</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">🏨 ${stats.hotelBookings}</div>
                                            <div class="stat-label">Booking Khách sạn</div>
                                            <div class="small text-muted">${hotelPercentage}% của tổng</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">🗺️ ${stats.tourBookings}</div>
                                            <div class="stat-label">Booking Tour</div>
                                            <div class="small text-muted">${tourPercentage}% của tổng</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${formatCurrency(hotelRevenue)}</div>
                                            <div class="stat-label">Doanh thu Khách sạn</div>
                                            <div class="small text-muted">${hotelRevenue > 0 ? ((hotelRevenue / stats.totalRevenue) * 100).toFixed(1) : 0}% tổng doanh thu</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-info">${formatCurrency(tourRevenue)}</div>
                                            <div class="stat-label">Doanh thu Tour</div>
                                            <div class="small text-muted">${tourRevenue > 0 ? ((tourRevenue / stats.totalRevenue) * 100).toFixed(1) : 0}% tổng doanh thu</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Loại</th>
                                                <th>Số booking</th>
                                                <th>Doanh thu</th>
                                                <th>Trung bình/booking</th>
                                                <th>Tỷ lệ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><span class="badge bg-primary">🏨 HOTEL</span></td>
                                                <td>${stats.hotelBookings}</td>
                                                <td class="text-success">${formatCurrency(hotelRevenue)}</td>
                                                <td>${stats.hotelBookings > 0 ? formatCurrency(hotelRevenue / stats.hotelBookings) : '₫0'}</td>
                                                <td>${hotelPercentage}%</td>
                                            </tr>
                                            <tr>
                                                <td><span class="badge bg-warning">🗺️ TOUR</span></td>
                                                <td>${stats.tourBookings}</td>
                                                <td class="text-info">${formatCurrency(tourRevenue)}</td>
                                                <td>${stats.tourBookings > 0 ? formatCurrency(tourRevenue / stats.tourBookings) : '₫0'}</td>
                                                <td>${tourPercentage}%</td>
                                            </tr>
                                            <tr class="table-active">
                                                <td><strong>TỔNG CỘNG</strong></td>
                                                <td><strong>${totalBookings}</strong></td>
                                                <td class="text-success"><strong>${formatCurrency(stats.totalRevenue)}</strong></td>
                                                <td><strong>${totalBookings > 0 ? formatCurrency(stats.totalRevenue / totalBookings) : '₫0'}</strong></td>
                                                <td><strong>100%</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('hotelTourStatsModal');
            if (oldModal) oldModal.remove();
            
            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', statsHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('hotelTourStatsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    // Fallback: hiển thị thông tin trong alert
                    alert(`Hotel vs Tour Stats:\n🏨 Hotel: ${stats.hotelBookings} bookings, ${formatCurrency(hotelRevenue)}\n🗺️ Tour: ${stats.tourBookings} bookings, ${formatCurrency(tourRevenue)}\n💰 Total: ${formatCurrency(stats.totalRevenue)}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Hotel vs Tour Stats:\n🏨 Hotel: ${stats.hotelBookings} bookings, ${formatCurrency(hotelRevenue)}\n🗺️ Tour: ${stats.tourBookings} bookings, ${formatCurrency(tourRevenue)}\n💰 Total: ${formatCurrency(stats.totalRevenue)}`);
            }
        }

        // Hàm bật/tắt auto-refresh
        function toggleAutoRefresh() {
            const button = document.getElementById('autoRefreshBtn');
            if (autoRefreshInterval) {
                stopAutoRefresh();
                button.innerHTML = '<i class="fas fa-sync"></i> Auto-refresh OFF';
                button.className = 'btn btn-outline-secondary btn-sm me-2';
                showNotification('Auto-refresh đã tắt', 'warning');
            } else {
                startAutoRefresh();
                button.innerHTML = '<i class="fas fa-sync fa-spin"></i> Auto-refresh ON';
                button.className = 'btn btn-secondary btn-sm me-2';
                showNotification('Auto-refresh đã bật', 'success');
            }
        }

        // Hàm cập nhật thống kê tổng hợp
        function updateRevenueSummary() {
            const stats = realtimeData.revenueStats;
            
            // Tính toán chi tiết theo loại booking
            const hotelBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'hotel' && booking.paymentStatus === 'paid'
            );
            const tourBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'tour' && booking.paymentStatus === 'paid'
            );
            const depositBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'deposit' && booking.paymentStatus === 'paid'
            );
            const promotionBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.paymentStatus === 'paid' && (
                    booking.note?.includes('ưu đãi') || 
                    booking.note?.includes('promotion') || 
                    booking.note?.includes('discount') ||
                    booking.totalPrice < 1000000 // Giả sử booking dưới 1M là ưu đãi
                )
            );
            
            // Tính doanh thu từng loại
            const hotelRevenue = hotelBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            const tourRevenue = tourBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            const depositRevenue = depositBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            const promotionRevenue = promotionBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            
            const totalRevenue = hotelRevenue + tourRevenue + depositRevenue + promotionRevenue;
            const totalCommission = totalRevenue * 0.15;
            const averageRevenue = stats.totalBookings > 0 ? totalRevenue / stats.totalBookings : 0;
            
            // Cập nhật UI
            document.getElementById('totalHotelBookings').textContent = hotelBookings.length;
            document.getElementById('totalHotelRevenue').textContent = formatCurrency(hotelRevenue);
            document.getElementById('totalTourBookings').textContent = tourBookings.length;
            document.getElementById('totalTourRevenue').textContent = formatCurrency(tourRevenue);
            document.getElementById('totalDepositBookings').textContent = depositBookings.length;
            document.getElementById('totalDepositRevenue').textContent = formatCurrency(depositRevenue);
            document.getElementById('totalPromotionBookings').textContent = promotionBookings.length;
            document.getElementById('totalPromotionRevenue').textContent = formatCurrency(promotionRevenue);
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalCommission').textContent = `Hoa hồng: ${formatCurrency(totalCommission)}`;
            document.getElementById('totalBookings').textContent = stats.totalBookings;
            document.getElementById('averageRevenue').textContent = `TB: ${formatCurrency(averageRevenue)}/booking`;
            
            // Log chi tiết
            console.log('📊 Revenue Summary:');
            console.log(`  🏨 Hotel: ${hotelBookings.length} bookings, ${formatCurrency(hotelRevenue)}`);
            console.log(`  🗺️ Tour: ${tourBookings.length} bookings, ${formatCurrency(tourRevenue)}`);
            console.log(`  💰 Deposit: ${depositBookings.length} bookings, ${formatCurrency(depositRevenue)}`);
            console.log(`  🎁 Promotion: ${promotionBookings.length} bookings, ${formatCurrency(promotionRevenue)}`);
            console.log(`  💰 Total: ${formatCurrency(totalRevenue)}`);
        }

        // Hàm cập nhật bảng đặt cọc
        function updateDepositTable() {
            const tableBody = document.getElementById('depositTableBody');
            if (!tableBody) return;

            // Lọc booking đặt cọc
            const depositBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.bookingType === 'deposit' && booking.paymentStatus === 'paid'
            );

            let tableHTML = '';
            depositBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt).toLocaleDateString('vi-VN');
                const itemType = booking.hotelName ? 'Khách sạn' : 'Tour';
                const itemName = booking.hotelName || booking.tourName;
                
                tableHTML += `
                    <tr>
                        <td>${bookingDate}</td>
                        <td>${booking.customerName}</td>
                        <td><span class="badge bg-info">${itemType}</span> ${itemName}</td>
                        <td class="text-warning fw-bold">${formatCurrency(booking.totalPrice)}</td>
                        <td>${booking.note || '-'}</td>
                        <td><span class="badge bg-success">Đã thanh toán</span></td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" title="Chi tiết" onclick="viewBookingDetails('${itemName}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" title="Đối soát" onclick="reconcileHotel('${itemName}')"><i class="fas fa-balance-scale"></i></button>
                        </td>
                    </tr>
                `;
            });

            if (depositBookings.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Chưa có dữ liệu đặt cọc nào.
                        </td>
                    </tr>
                `;
            }

            tableBody.innerHTML = tableHTML;
        }

        // Hàm cập nhật bảng ưu đãi
        function updatePromotionTable() {
            const tableBody = document.getElementById('promotionTableBody');
            if (!tableBody) return;

            // Lọc booking có ưu đãi
            const promotionBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.paymentStatus === 'paid' && (
                    booking.note?.includes('ưu đãi') || 
                    booking.note?.includes('promotion') || 
                    booking.note?.includes('discount') ||
                    booking.totalPrice < 1000000
                )
            );

            let tableHTML = '';
            promotionBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt).toLocaleDateString('vi-VN');
                const itemType = booking.bookingType === 'hotel' ? 'Khách sạn' : 'Tour';
                const itemName = booking.hotelName || booking.tourName;
                
                // Ước tính giá gốc (tăng 30% so với giá hiện tại)
                const originalPrice = Math.round(booking.totalPrice * 1.3);
                const savings = originalPrice - booking.totalPrice;
                
                tableHTML += `
                    <tr>
                        <td>${bookingDate}</td>
                        <td>${booking.customerName}</td>
                        <td><span class="badge bg-${booking.bookingType === 'hotel' ? 'primary' : 'warning'}">${itemType}</span> ${itemName}</td>
                        <td class="text-muted"><del>${formatCurrency(originalPrice)}</del></td>
                        <td class="text-success fw-bold">${formatCurrency(booking.totalPrice)}</td>
                        <td class="text-danger">-${formatCurrency(savings)}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" title="Chi tiết" onclick="viewBookingDetails('${itemName}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" title="Đối soát" onclick="reconcileHotel('${itemName}')"><i class="fas fa-balance-scale"></i></button>
                        </td>
                    </tr>
                `;
            });

            if (promotionBookings.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Chưa có dữ liệu ưu đãi nào.
                        </td>
                    </tr>
                `;
            }

            tableBody.innerHTML = tableHTML;
        }

        // Hàm tính toán hoa hồng từ dữ liệu realtime
        function calculateCommissionData() {
            // Lọc booking khách sạn đã thanh toán
            const hotelBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.bookingType === 'hotel' && booking.paymentStatus === 'paid' && booking.hotelName
            );
            
            // Tạo dữ liệu hoa hồng theo khách sạn
            const commissionData = {};
            
            hotelBookings.forEach(booking => {
                const hotelName = booking.hotelName;
                
                if (!commissionData[hotelName]) {
                    commissionData[hotelName] = {
                        hotelName: hotelName,
                        totalRevenue: 0,
                        commissionRate: 15, // Mặc định 15%
                        totalCommission: 0,
                        paidCommission: 0,
                        pendingCommission: 0,
                        bookingCount: 0,
                        lastBookingDate: null
                    };
                }
                
                commissionData[hotelName].totalRevenue += booking.totalPrice || 0;
                commissionData[hotelName].bookingCount++;
                
                // Cập nhật ngày booking mới nhất
                const bookingDate = new Date(booking.createdAt);
                if (!commissionData[hotelName].lastBookingDate || 
                    bookingDate > commissionData[hotelName].lastBookingDate) {
                    commissionData[hotelName].lastBookingDate = bookingDate;
                }
            });
            
            // Tính hoa hồng cho từng khách sạn
            Object.keys(commissionData).forEach(hotelName => {
                const data = commissionData[hotelName];
                data.totalCommission = Math.round(data.totalRevenue * (data.commissionRate / 100));
                data.pendingCommission = data.totalCommission; // Mặc định chưa thanh toán
                data.paidCommission = 0; // Mặc định chưa thanh toán
            });
            
            return commissionData;
        }

        // Hàm cập nhật bảng hoa hồng
        function updateCommissionTable() {
            const commissionData = calculateCommissionData();
            const tableBody = document.getElementById('commissionTableBody');
            
            if (!tableBody) return;
            
            // Tính tổng thống kê
            let totalPendingCommission = 0;
            let totalPaidCommission = 0;
            let totalRevenue = 0;
            let totalCommission = 0;
            
            Object.values(commissionData).forEach(data => {
                totalPendingCommission += data.pendingCommission;
                totalPaidCommission += data.paidCommission;
                totalRevenue += data.totalRevenue;
                totalCommission += data.totalCommission;
            });
            
            const avgCommissionRate = totalRevenue > 0 ? ((totalCommission / totalRevenue) * 100).toFixed(1) : 15;
            
            // Cập nhật thống kê
            document.getElementById('pendingCommission').textContent = formatCurrency(totalPendingCommission);
            document.getElementById('paidCommission').textContent = formatCurrency(totalPaidCommission);
            document.getElementById('avgCommissionRate').textContent = avgCommissionRate + '%';
            document.getElementById('totalPartners').textContent = Object.keys(commissionData).length;
            
            // Tạo HTML cho bảng
            let tableHTML = '';
            const sortedHotels = Object.values(commissionData).sort((a, b) => b.totalCommission - a.totalCommission);
            
            sortedHotels.forEach(data => {
                const status = data.pendingCommission > 0 ? 'Pending' : 'Paid';
                const statusBadge = data.pendingCommission > 0 ? 'bg-warning' : 'bg-success';
                const remainingCommission = data.totalCommission - data.paidCommission;
                
                tableHTML += `
                    <tr>
                        <td><i class="fas fa-hotel text-primary me-1"></i>${data.hotelName}</td>
                        <td><span class="badge bg-info">${data.commissionRate}%</span></td>
                        <td class="fw-bold">${formatCurrency(data.totalRevenue)}</td>
                        <td class="text-warning fw-bold">${formatCurrency(data.totalCommission)}</td>
                        <td class="text-success">${formatCurrency(data.paidCommission)}</td>
                        <td class="text-danger">${formatCurrency(remainingCommission)}</td>
                        <td><span class="badge ${statusBadge}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success me-1" onclick="payCommission('${data.hotelName}')" title="Thanh toán" ${data.pendingCommission <= 0 ? 'disabled' : ''}>
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button class="btn btn-sm btn-info" title="Chi tiết" onclick="viewCommissionDetails('${data.hotelName}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            if (sortedHotels.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Chưa có dữ liệu hoa hồng nào.
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableHTML;
            
            // Log chi tiết
            console.log('💰 Commission Summary:');
            console.log(`  📊 Total hotels: ${Object.keys(commissionData).length}`);
            console.log(`  💰 Total revenue: ${formatCurrency(totalRevenue)}`);
            console.log(`  💸 Total commission: ${formatCurrency(totalCommission)}`);
            console.log(`  ⏳ Pending commission: ${formatCurrency(totalPendingCommission)}`);
            console.log(`  ✅ Paid commission: ${formatCurrency(totalPaidCommission)}`);
        }

        // Hàm xem chi tiết hoa hồng
        function viewCommissionDetails(hotelName) {
            const commissionData = calculateCommissionData();
            const hotelData = commissionData[hotelName];
            
            if (!hotelData) {
                alert('Không tìm thấy dữ liệu hoa hồng cho khách sạn này');
                return;
            }
            
            // Lọc booking của khách sạn này
            const hotelBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.hotelName === hotelName && booking.paymentStatus === 'paid'
            );
            
            let detailsHTML = `
                <div class="modal fade" id="commissionDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi tiết hoa hồng - ${hotelName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${hotelData.bookingCount}</div>
                                            <div class="stat-label">Số booking</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${formatCurrency(hotelData.totalRevenue)}</div>
                                            <div class="stat-label">Tổng doanh thu</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">${formatCurrency(hotelData.totalCommission)}</div>
                                            <div class="stat-label">Hoa hồng (${hotelData.commissionRate}%)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-info">${formatCurrency(hotelData.pendingCommission)}</div>
                                            <div class="stat-label">Chờ thanh toán</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Booking ID</th>
                                                <th>Khách hàng</th>
                                                <th>Ngày</th>
                                                <th>Doanh thu</th>
                                                <th>Hoa hồng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;
            
            hotelBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt).toLocaleDateString('vi-VN');
                const commission = Math.round((booking.totalPrice || 0) * (hotelData.commissionRate / 100));
                
                detailsHTML += `
                    <tr>
                        <td>H-${booking.createdAt.toString().slice(-6)}</td>
                        <td>${booking.customerName}</td>
                        <td>${bookingDate}</td>
                        <td class="text-success">${formatCurrency(booking.totalPrice)}</td>
                        <td class="text-warning">${formatCurrency(commission)}</td>
                    </tr>
                `;
            });
            
            detailsHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('commissionDetailsModal');
            if (oldModal) oldModal.remove();
            
            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('commissionDetailsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    alert(`Chi tiết hoa hồng - ${hotelName}\nTổng doanh thu: ${formatCurrency(hotelData.totalRevenue)}\nHoa hồng: ${formatCurrency(hotelData.totalCommission)}\nSố booking: ${hotelData.bookingCount}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Chi tiết hoa hồng - ${hotelName}\nTổng doanh thu: ${formatCurrency(hotelData.totalRevenue)}\nHoa hồng: ${formatCurrency(hotelData.totalCommission)}\nSố booking: ${hotelData.bookingCount}`);
            }
        }

        // Hàm refresh dữ liệu hoa hồng
        function refreshCommissionData() {
            console.log('🔄 Refreshing commission data...');
            updateCommissionTable();
            showNotification('Dữ liệu hoa hồng đã được cập nhật', 'success');
        }

        // Hàm cập nhật thống kê tổng hợp
        function updateReconciliationStats(reconciliationData, totalDiscrepancies, totalPendingAmount) {
            const totalHotels = Object.keys(reconciliationData.hotels).length;
            const totalTours = Object.keys(reconciliationData.tours).length;
            const totalItems = totalHotels + totalTours;
            const pendingItems = Object.values(reconciliationData.hotels).filter(h => h.status === 'Pending').length +
                               Object.values(reconciliationData.tours).filter(t => t.status === 'Pending').length;
            
            // Cập nhật các element thống kê nếu có
            const pendingElement = document.getElementById('pendingReconciliation');
            const completedElement = document.getElementById('completedReconciliation');
            const discrepancyElement = document.getElementById('totalDiscrepancies');
            const amountElement = document.getElementById('pendingAmount');
            
            if (pendingElement) pendingElement.textContent = pendingItems;
            if (completedElement) completedElement.textContent = totalItems - pendingItems;
            if (discrepancyElement) discrepancyElement.textContent = totalDiscrepancies;
            if (amountElement) amountElement.textContent = formatCurrency(totalPendingAmount);
        }

        // Hàm đối soát item
        function reconcileItem(itemName, type) {
            const reconciliationData = generateReconciliationData();
            let itemData;
            
            if (type === 'hotel') {
                itemData = reconciliationData.hotels[itemName];
            } else if (type === 'tour') {
                itemData = reconciliationData.tours[itemName];
            }
            
            if (!itemData) {
                alert('Không tìm thấy dữ liệu đối soát cho item này');
                return;
            }
            
            if (confirm(`Xác nhận đối soát cho ${itemName}?\nSố tiền: ${formatCurrency(itemData.totalCommission)}`)) {
                // Giả lập quá trình đối soát
                console.log(`🔄 Reconciling ${type}: ${itemName}`);
                
                // Cập nhật trạng thái
                itemData.status = 'Completed';
                itemData.paidCommission = itemData.totalCommission;
                itemData.pendingCommission = 0;
                itemData.lastReconciliation = new Date().toISOString().split('T')[0];
                
                // Hiển thị thông báo
                showNotification(`Đã đối soát thành công ${itemName}`, 'success');
                
                // Cập nhật bảng
                updateReconciliationTable();
            }
        }

        // Hàm xem chi tiết đối soát
        function viewReconciliationDetails(itemName, type) {
            const reconciliationData = generateReconciliationData();
            let itemData;
            
            if (type === 'hotel') {
                itemData = reconciliationData.hotels[itemName];
            } else if (type === 'tour') {
                itemData = reconciliationData.tours[itemName];
            }
            
            if (!itemData) {
                alert('Không tìm thấy dữ liệu đối soát cho item này');
                return;
            }
            
            // Tạo modal chi tiết
            let detailsHTML = `
                <div class="modal fade" id="reconciliationDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi tiết đối soát - ${itemName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${itemData.totalBookings}</div>
                                            <div class="stat-label">Số booking</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${formatCurrency(itemData.totalRevenue)}</div>
                                            <div class="stat-label">Tổng doanh thu</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">${formatCurrency(itemData.totalCommission)}</div>
                                            <div class="stat-label">Hoa hồng (${itemData.commissionRate}%)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-danger">${formatCurrency(itemData.pendingCommission)}</div>
                                            <div class="stat-label">Chờ thanh toán</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Thông tin</th>
                                                <th>Giá trị</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Loại</td>
                                                <td><span class="badge bg-${type === 'hotel' ? 'primary' : 'warning'}">${type === 'hotel' ? 'Khách sạn' : 'Tour'}</span></td>
                                            </tr>
                                            <tr>
                                                <td>Địa điểm</td>
                                                <td>${itemData.location}</td>
                                            </tr>
                                            <tr>
                                                <td>Kỳ đối soát</td>
                                                <td>${itemData.reconciliationPeriod}</td>
                                            </tr>
                                            <tr>
                                                <td>Lần đối soát cuối</td>
                                                <td>${itemData.lastReconciliation}</td>
                                            </tr>
                                            <tr>
                                                <td>Trạng thái</td>
                                                <td><span class="badge bg-${itemData.status === 'Pending' ? 'warning' : 'success'}">${itemData.status}</span></td>
                                            </tr>
                                            <tr>
                                                <td>Chênh lệch</td>
                                                <td class="${itemData.discrepancies > 0 ? 'text-danger' : 'text-success'}">${itemData.discrepancies}</td>
                                            </tr>
                                            <tr>
                                                <td>Ghi chú</td>
                                                <td>${itemData.notes}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('reconciliationDetailsModal');
            if (oldModal) oldModal.remove();
            
            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('reconciliationDetailsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    alert(`Chi tiết đối soát - ${itemName}\nDoanh thu: ${formatCurrency(itemData.totalRevenue)}\nHoa hồng: ${formatCurrency(itemData.totalCommission)}\nTrạng thái: ${itemData.status}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Chi tiết đối soát - ${itemName}\nDoanh thu: ${formatCurrency(itemData.totalRevenue)}\nHoa hồng: ${formatCurrency(itemData.totalCommission)}\nTrạng thái: ${itemData.status}`);
            }
        }

        // Hàm tạo dữ liệu đối soát từ file JSON
        function generateReconciliationData() {
            // Dữ liệu đối soát dựa trên bookings và payments từ JSON
            const reconciliationData = {
                hotels: {
                    "Dakruco Hotel": {
                        hotelName: "Dakruco Hotel",
                        location: "Buôn Ma Thuột",
                        reconciliationPeriod: "Tháng 12/2024",
                        totalBookings: 1,
                        totalRevenue: 1100000,
                        commissionRate: 15,
                        totalCommission: 165000,
                        paidCommission: 0,
                        pendingCommission: 165000,
                        status: "Pending",
                        lastReconciliation: "2024-11-30",
                        discrepancies: 0,
                        notes: "Khách sạn mới, chưa đối soát"
                    },
                    "Combo Nghỉ Dưỡng Biển 5*": {
                        hotelName: "Combo Nghỉ Dưỡng Biển 5*",
                        location: "Nha Trang",
                        reconciliationPeriod: "Tháng 12/2024",
                        totalBookings: 1,
                        totalRevenue: 3200000,
                        commissionRate: 15,
                        totalCommission: 480000,
                        paidCommission: 0,
                        pendingCommission: 480000,
                        status: "Pending",
                        lastReconciliation: "2024-11-30",
                        discrepancies: 0,
                        notes: "Flash sale booking, cần xác nhận"
                    },
                    "InterContinental Đà Nẵng Sun Peninsula Resort": {
                        hotelName: "InterContinental Đà Nẵng Sun Peninsula Resort",
                        location: "Đà Nẵng",
                        reconciliationPeriod: "Tháng 12/2024",
                        totalBookings: 1,
                        totalRevenue: 3000000,
                        commissionRate: 16,
                        totalCommission: 480000,
                        paidCommission: 0,
                        pendingCommission: 480000,
                        status: "Pending",
                        lastReconciliation: "2024-11-30",
                        discrepancies: 0,
                        notes: "Khách sạn 5 sao, tỷ lệ hoa hồng cao hơn"
                    }
                },
                tours: {
                    "Kayak và câu cá tại Vịnh Hạ Long": {
                        tourName: "Kayak và câu cá tại Vịnh Hạ Long",
                        location: "Hạ Long, Quảng Ninh",
                        reconciliationPeriod: "Tháng 12/2024",
                        totalBookings: 1,
                        totalRevenue: 1200000,
                        commissionRate: 12,
                        totalCommission: 144000,
                        paidCommission: 0,
                        pendingCommission: 144000,
                        status: "Pending",
                        lastReconciliation: "2024-11-30",
                        discrepancies: 0,
                        notes: "Tour trải nghiệm địa phương"
                    }
                },
                payments: {
                    "VNPAY Transactions": {
                        totalTransactions: 8,
                        totalAmount: 925000000, // Tổng từ payments trong JSON
                        successfulTransactions: 8,
                        failedTransactions: 0,
                        reconciliationStatus: "Completed",
                        lastReconciliation: "2024-12-15",
                        discrepancies: 0,
                        notes: "Tất cả giao dịch VNPAY đều thành công"
                    }
                },
                deposits: {
                    "Đặt cọc": {
                        totalDeposits: 2,
                        totalAmount: 25500000, // 19.5M + 6M từ payments
                        reconciledAmount: 0,
                        pendingAmount: 25500000,
                        status: "Pending",
                        notes: "Cần xác nhận với khách hàng"
                    }
                }
            };
            
            return reconciliationData;
        }

        // Hàm cập nhật bảng đối soát
        function updateReconciliationTable() {
            const reconciliationData = generateReconciliationData();
            const tableBody = document.getElementById('reconciliationTableBody');
            
            if (!tableBody) return;
            
            let tableHTML = '';
            let totalDiscrepancies = 0;
            let totalPendingAmount = 0;
            
            // Thêm dữ liệu khách sạn
            Object.values(reconciliationData.hotels).forEach(hotel => {
                const statusBadge = hotel.status === 'Pending' ? 'bg-warning' : 'bg-success';
                const discrepancyClass = hotel.discrepancies > 0 ? 'text-danger' : 'text-success';
                
                tableHTML += `
                    <tr>
                        <td><i class="fas fa-hotel text-primary me-1"></i>${hotel.hotelName}</td>
                        <td>${hotel.location}</td>
                        <td>${hotel.reconciliationPeriod}</td>
                        <td class="fw-bold">${formatCurrency(hotel.totalRevenue)}</td>
                        <td><span class="badge bg-info">${hotel.commissionRate}%</span></td>
                        <td class="text-warning fw-bold">${formatCurrency(hotel.totalCommission)}</td>
                        <td class="text-success">${formatCurrency(hotel.paidCommission)}</td>
                        <td class="text-danger">${formatCurrency(hotel.pendingCommission)}</td>
                        <td class="${discrepancyClass}">${hotel.discrepancies}</td>
                        <td><span class="badge ${statusBadge}">${hotel.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success me-1" onclick="reconcileItem('${hotel.hotelName}', 'hotel')" title="Đối soát">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                            <button class="btn btn-sm btn-info" title="Chi tiết" onclick="viewReconciliationDetails('${hotel.hotelName}', 'hotel')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                totalDiscrepancies += hotel.discrepancies;
                totalPendingAmount += hotel.pendingCommission;
            });
            
            // Thêm dữ liệu tour
            Object.values(reconciliationData.tours).forEach(tour => {
                const statusBadge = tour.status === 'Pending' ? 'bg-warning' : 'bg-success';
                const discrepancyClass = tour.discrepancies > 0 ? 'text-danger' : 'text-success';
                
                tableHTML += `
                    <tr>
                        <td><i class="fas fa-map-marked-alt text-warning me-1"></i>${tour.tourName}</td>
                        <td>${tour.location}</td>
                        <td>${tour.reconciliationPeriod}</td>
                        <td class="fw-bold">${formatCurrency(tour.totalRevenue)}</td>
                        <td><span class="badge bg-info">${tour.commissionRate}%</span></td>
                        <td class="text-warning fw-bold">${formatCurrency(tour.totalCommission)}</td>
                        <td class="text-success">${formatCurrency(tour.paidCommission)}</td>
                        <td class="text-danger">${formatCurrency(tour.pendingCommission)}</td>
                        <td class="${discrepancyClass}">${tour.discrepancies}</td>
                        <td><span class="badge ${statusBadge}">${tour.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success me-1" onclick="reconcileItem('${tour.tourName}', 'tour')" title="Đối soát">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                            <button class="btn btn-sm btn-info" title="Chi tiết" onclick="viewReconciliationDetails('${tour.tourName}', 'tour')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                totalDiscrepancies += tour.discrepancies;
                totalPendingAmount += tour.pendingCommission;
            });
            
            if (Object.keys(reconciliationData.hotels).length === 0 && Object.keys(reconciliationData.tours).length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Chưa có dữ liệu đối soát nào.
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableHTML;
            
            // Cập nhật thống kê đối soát
            updateReconciliationStats(reconciliationData, totalDiscrepancies, totalPendingAmount);
            
            console.log('📊 Reconciliation Summary:');
            console.log(`  🏨 Hotels: ${Object.keys(reconciliationData.hotels).length}`);
            console.log(`  🗺️ Tours: ${Object.keys(reconciliationData.tours).length}`);
            console.log(`  💰 Total pending: ${formatCurrency(totalPendingAmount)}`);
            console.log(`  ❌ Total discrepancies: ${totalDiscrepancies}`);
        }

        // ===== AFFILIATE PARTNERS MANAGEMENT =====
        
        // Biến lưu trữ dữ liệu đối tác từ Affiliate Manager
        let affiliatePartners = [];
        
        // Hàm load dữ liệu đối tác từ Affiliate Manager
        function loadAffiliatePartners() {
            console.log('🔄 Loading affiliate partners data...');
            
            if (!database) {
                console.warn('⚠️ Firebase not available, using sample data');
                loadSampleAffiliatePartners();
                return;
            }
            
            const partnersRef = database.ref('affiliatePartners');
            
            partnersRef.once('value', (snapshot) => {
                affiliatePartners = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const partner = childSnapshot.val();
                        partner.id = childSnapshot.key;
                        affiliatePartners.push(partner);
                    });
                    console.log(`✅ Loaded ${affiliatePartners.length} affiliate partners`);
                } else {
                    console.log('📝 No affiliate partners found, using sample data');
                    loadSampleAffiliatePartners();
                }
                
                updateAffiliatePartnersTable();
                updateAffiliatePartnersStats();
                
            }, (error) => {
                console.warn('⚠️ Cannot access Firebase affiliate partners:', error.code);
                loadSampleAffiliatePartners();
            });
        }
        
        // Hàm tạo dữ liệu mẫu cho đối tác affiliate
        function loadSampleAffiliatePartners() {
            affiliatePartners = [
                {
                    id: 'partner_001',
                    name: 'TravelNow',
                    website: 'travelnow.vn',
                    contactEmail: 'partner@travelnow.vn',
                    contactPhone: '0901-234-567',
                    status: 'Đang hợp tác',
                    commission: 8.5,
                    revenue: '95,000,000đ',
                    createdAt: '2024-01-15',
                    updatedAt: new Date().toISOString()
                },
                {
                    id: 'partner_002', 
                    name: 'HotelLink',
                    website: 'hotellink.com',
                    contactEmail: 'support@hotellink.vn',
                    contactPhone: '0902-345-678',
                    status: 'Đang hợp tác',
                    commission: 7.0,
                    revenue: '73,000,000đ',
                    createdAt: '2024-02-20',
                    updatedAt: new Date().toISOString()
                },
                {
                    id: 'partner_003',
                    name: 'BookingVN',
                    website: 'bookingvn.com',
                    contactEmail: 'partner@bookingvn.com',
                    contactPhone: '0903-456-789',
                    status: 'Đang hợp tác',
                    commission: 9.0,
                    revenue: '87,000,000đ',
                    createdAt: '2024-03-10',
                    updatedAt: new Date().toISOString()
                },
                {
                    id: 'partner_004',
                    name: 'StayEasy',
                    website: 'stayeasy.vn',
                    contactEmail: 'info@stayeasy.vn',
                    contactPhone: '0904-567-890',
                    status: 'Tạm dừng',
                    commission: 6.5,
                    revenue: '42,000,000đ',
                    createdAt: '2024-04-05',
                    updatedAt: new Date().toISOString()
                }
            ];
            
            updateAffiliatePartnersTable();
            updateAffiliatePartnersStats();
        }
        
        // Hàm cập nhật bảng đối tác affiliate
        function updateAffiliatePartnersTable() {
            const tableBody = document.getElementById('affiliatePartnersTable');
            
            if (!tableBody) return;
            
            let tableHTML = '';
            
            if (affiliatePartners.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Chưa có dữ liệu đối tác nào.
                        </td>
                    </tr>
                `;
            } else {
                affiliatePartners.forEach(partner => {
                    const statusBadge = partner.status === 'Đang hợp tác' ? 'bg-success' : 
                                      (partner.status === 'Tạm dừng' ? 'bg-warning' : 'bg-secondary');
                    
                    tableHTML += `
                        <tr>
                            <td><i class="fas fa-handshake text-primary me-1"></i>${partner.name}</td>
                            <td><a href="https://${partner.website}" target="_blank">${partner.website}</a></td>
                            <td><a href="mailto:${partner.contactEmail}">${partner.contactEmail}</a></td>
                            <td><span class="badge ${statusBadge}">${partner.status}</span></td>
                            <td><span class="badge bg-info">${partner.commission}%</span></td>
                            <td class="fw-bold">${partner.revenue}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="viewPartnerDetails('${partner.id}')" title="Chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editPartnerCommission('${partner.id}')" title="Sửa hoa hồng">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }
        
        // Hàm cập nhật thống kê đối tác affiliate
        function updateAffiliatePartnersStats() {
            const totalPartners = affiliatePartners.length;
            const activePartners = affiliatePartners.filter(p => p.status === 'Đang hợp tác').length;
            
            // Tính hoa hồng trung bình
            const totalCommission = affiliatePartners.reduce((sum, p) => sum + p.commission, 0);
            const avgCommission = totalPartners > 0 ? (totalCommission / totalPartners).toFixed(1) : 0;
            
            // Tính tổng doanh thu
            const totalRevenue = affiliatePartners.reduce((sum, p) => {
                const revenue = parseFloat(p.revenue.replace(/[^\d]/g, '')) || 0;
                return sum + revenue;
            }, 0);
            
            // Cập nhật UI
            document.getElementById('totalPartners').textContent = totalPartners;
            document.getElementById('activePartners').textContent = activePartners;
            document.getElementById('avgCommission').textContent = avgCommission + '%';
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            
            console.log('📊 Affiliate Partners Stats:');
            console.log(`  📈 Total partners: ${totalPartners}`);
            console.log(`  ✅ Active partners: ${activePartners}`);
            console.log(`  💰 Average commission: ${avgCommission}%`);
            console.log(`  💵 Total revenue: ${formatCurrency(totalRevenue)}`);
        }
        
        // Hàm xem chi tiết đối tác
        function viewPartnerDetails(partnerId) {
            const partner = affiliatePartners.find(p => p.id === partnerId);
            
            if (!partner) {
                alert('Không tìm thấy thông tin đối tác');
                return;
            }
            
            const detailsHTML = `
                <div class="modal fade" id="partnerDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi tiết đối tác - ${partner.name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${partner.commission}%</div>
                                            <div class="stat-label">Tỷ lệ hoa hồng</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${partner.revenue}</div>
                                            <div class="stat-label">Doanh thu</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <tbody>
                                            <tr>
                                                <td><strong>Tên đối tác:</strong></td>
                                                <td>${partner.name}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Website:</strong></td>
                                                <td><a href="https://${partner.website}" target="_blank">${partner.website}</a></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Email:</strong></td>
                                                <td><a href="mailto:${partner.contactEmail}">${partner.contactEmail}</a></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Điện thoại:</strong></td>
                                                <td><a href="tel:${partner.contactPhone}">${partner.contactPhone}</a></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Trạng thái:</strong></td>
                                                <td><span class="badge bg-${partner.status === 'Đang hợp tác' ? 'success' : 'warning'}">${partner.status}</span></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Ngày tạo:</strong></td>
                                                <td>${new Date(partner.createdAt).toLocaleDateString('vi-VN')}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Cập nhật cuối:</strong></td>
                                                <td>${new Date(partner.updatedAt).toLocaleDateString('vi-VN')}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('partnerDetailsModal');
            if (oldModal) oldModal.remove();
            
            // Thêm modal mới
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
            
            // Hiển thị modal
            try {
                const modalElement = document.getElementById('partnerDetailsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('⚠️ Bootstrap Modal not available');
                    alert(`Chi tiết đối tác - ${partner.name}\nWebsite: ${partner.website}\nEmail: ${partner.contactEmail}\nHoa hồng: ${partner.commission}%\nDoanh thu: ${partner.revenue}`);
                }
            } catch (error) {
                console.error('❌ Modal error:', error);
                alert(`Chi tiết đối tác - ${partner.name}\nWebsite: ${partner.website}\nEmail: ${partner.contactEmail}\nHoa hồng: ${partner.commission}%\nDoanh thu: ${partner.revenue}`);
            }
        }
        
        // Hàm sửa hoa hồng đối tác
        function editPartnerCommission(partnerId) {
            const partner = affiliatePartners.find(p => p.id === partnerId);
            
            if (!partner) {
                alert('Không tìm thấy thông tin đối tác');
                return;
            }
            
            const newCommission = prompt(`Nhập tỷ lệ hoa hồng mới cho ${partner.name} (hiện tại: ${partner.commission}%):`, partner.commission);
            
            if (newCommission && !isNaN(newCommission) && newCommission >= 0 && newCommission <= 100) {
                const commission = parseFloat(newCommission);
                
                if (!database) {
                    console.warn('⚠️ Firebase not available, updating local data only');
                    partner.commission = commission;
                    partner.updatedAt = new Date().toISOString();
                    updateAffiliatePartnersTable();
                    updateAffiliatePartnersStats();
                    showNotification(`Đã cập nhật hoa hồng cho ${partner.name} thành ${commission}%`, 'success');
                    return;
                }
                
                // Cập nhật lên Firebase
                database.ref(`affiliatePartners/${partnerId}`).update({
                    commission: commission,
                    updatedAt: new Date().toISOString()
                }).then(() => {
                    console.log(`✅ Updated commission for ${partner.name} to ${commission}%`);
                    showNotification(`Đã cập nhật hoa hồng cho ${partner.name} thành ${commission}%`, 'success');
                    loadAffiliatePartners(); // Reload data
                }).catch((error) => {
                    console.error('❌ Error updating commission:', error);
                    showNotification('Có lỗi khi cập nhật hoa hồng', 'error');
                });
            }
        }
        
        // Hàm lưu cài đặt hoa hồng
        function saveCommissionSettings() {
            const defaultRate = document.getElementById('defaultCommissionRate').value;
            const minRate = document.getElementById('minCommissionRate').value;
            
            if (!defaultRate || !minRate) {
                alert('Vui lòng nhập đầy đủ thông tin');
                return;
            }
            
            const settings = {
                defaultCommissionRate: parseFloat(defaultRate),
                minCommissionRate: parseFloat(minRate),
                updatedAt: new Date().toISOString()
            };
            
            // Lưu vào Firebase
            if (typeof database !== 'undefined' && database) {
                database.ref('settings/finance').set(settings)
                    .then(() => {
                        showNotification('Đã lưu cài đặt hoa hồng lên Firebase thành công', 'success');
                        console.log('💾 Commission settings saved to Firebase:', settings);
                        
                        // Hỏi người dùng có muốn cập nhật đồng loạt cho tất cả đối tác không
                        if (confirm(`Bạn có muốn cập nhật tỷ lệ hoa hồng ${defaultRate}% cho tất cả đối tác hiện tại không?`)) {
                            updateAllAffiliateCommissions(parseFloat(defaultRate));
                        }
                    })
                    .catch((error) => {
                        showNotification('Lỗi khi lưu cài đặt lên Firebase', 'error');
                        console.error('❌ Error saving to Firebase:', error);
                        
                        // Fallback: lưu vào localStorage
                        localStorage.setItem('financeSettings', JSON.stringify(settings));
                        showNotification('Đã lưu cài đặt hoa hồng (local)', 'warning');
                    });
            } else {
                // Fallback: lưu vào localStorage nếu Firebase không có
                localStorage.setItem('financeSettings', JSON.stringify(settings));
                showNotification('Đã lưu cài đặt hoa hồng (local)', 'warning');
                console.log('💾 Commission settings saved (local):', settings);
            }
        }
        
        // Hàm lưu cài đặt thanh toán
        function savePaymentSettings() {
            const autoPayment = document.getElementById('autoPayment').checked;
            const paymentCycle = document.getElementById('paymentCycle').value;
            
            const settings = {
                autoPayment: autoPayment,
                paymentCycle: paymentCycle,
                updatedAt: new Date().toISOString()
            };
            
            // Lưu vào localStorage
            localStorage.setItem('paymentSettings', JSON.stringify(settings));
            
            showNotification('Đã lưu cài đặt thanh toán thành công', 'success');
            console.log('💾 Payment settings saved:', settings);
        }
        
        // Hàm lưu cài đặt thông báo
        function saveNotificationSettings() {
            const revenueAlert = document.getElementById('revenueAlert').checked;
            const reconcileAlert = document.getElementById('reconcileAlert').checked;
            const paymentAlert = document.getElementById('paymentAlert').checked;
            
            const settings = {
                revenueAlert: revenueAlert,
                reconcileAlert: reconcileAlert,
                paymentAlert: paymentAlert,
                updatedAt: new Date().toISOString()
            };
            
            // Lưu vào localStorage
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            
            showNotification('Đã lưu cài đặt thông báo thành công', 'success');
            console.log('💾 Notification settings saved:', settings);
        }
        
        // Hàm cập nhật đồng loạt tỷ lệ hoa hồng cho tất cả đối tác
        function updateAllAffiliateCommissions(newRate) {
            if (typeof database !== 'undefined' && database) {
                console.log(`🔄 Updating commission rate to ${newRate}% for all affiliates...`);
                
                const partnersRef = database.ref('affiliatePartners');
                partnersRef.once('value', (snapshot) => {
                    const updates = {};
                    let updateCount = 0;
                    
                    snapshot.forEach((child) => {
                        updates[`${child.key}/commission`] = newRate;
                        updates[`${child.key}/updatedAt`] = new Date().toISOString();
                        updateCount++;
                    });
                    
                    if (updateCount > 0) {
                        partnersRef.update(updates)
                            .then(() => {
                                showNotification(`Đã cập nhật tỷ lệ hoa hồng ${newRate}% cho ${updateCount} đối tác`, 'success');
                                console.log(`✅ Updated ${updateCount} affiliates with ${newRate}% commission`);
                                
                                // Reload affiliate partners data
                                loadAffiliatePartners();
                            })
                            .catch((error) => {
                                showNotification('Lỗi khi cập nhật tỷ lệ hoa hồng cho đối tác', 'error');
                                console.error('❌ Error updating affiliate commissions:', error);
                            });
                    } else {
                        showNotification('Không có đối tác nào để cập nhật', 'warning');
                    }
                });
            } else {
                showNotification('Không thể kết nối Firebase để cập nhật đối tác', 'error');
            }
        }
        
        // Hàm load cài đặt từ Firebase
        function loadSettingsFromFirebase() {
            if (typeof database !== 'undefined' && database) {
                database.ref('settings/finance').once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const settings = snapshot.val();
                        console.log('📥 Loaded settings from Firebase:', settings);
                        
                        if (settings.defaultCommissionRate) {
                            document.getElementById('defaultCommissionRate').value = settings.defaultCommissionRate;
                        }
                        if (settings.minCommissionRate) {
                            document.getElementById('minCommissionRate').value = settings.minCommissionRate;
                        }
                        
                        showNotification('Đã tải cài đặt từ Firebase thành công', 'success');
                    } else {
                        console.log('📝 No settings found in Firebase, using local settings');
                        loadSettingsFromLocal();
                    }
                }).catch((error) => {
                    console.error('❌ Error loading settings from Firebase:', error);
                    loadSettingsFromLocal();
                });
            } else {
                loadSettingsFromLocal();
            }
        }
        
        // Hàm load cài đặt từ localStorage (fallback)
        function loadSettingsFromLocal() {
            const financeSettings = JSON.parse(localStorage.getItem('financeSettings') || '{}');
            if (financeSettings.defaultCommissionRate) {
                document.getElementById('defaultCommissionRate').value = financeSettings.defaultCommissionRate;
            }
            if (financeSettings.minCommissionRate) {
                document.getElementById('minCommissionRate').value = financeSettings.minCommissionRate;
            }
        }
        
        // Hàm cập nhật Dashboard
        function updateDashboard() {
            console.log('🔄 Updating dashboard...');
            
            // Cập nhật thống kê tổng quan
            updateDashboardStats();
            
            // Cập nhật top khách sạn
            updateTopHotels();
            
            // Cập nhật top đối tác
            updateTopPartners();
            
            // Cập nhật giao dịch gần đây
            updateRecentTransactions();
            
            // Cập nhật hoạt động gần đây
            updateRecentActivities();
        }
        
        // Hàm cập nhật thống kê Dashboard
        function updateDashboardStats() {
            const stats = realtimeData.revenueStats;
            const monthly = realtimeData.monthlyStats;
            
            // Doanh thu tháng này
            document.getElementById('monthlyRevenue').textContent = formatCurrency(monthly.currentMonth);
            
            // Tính tăng trưởng
            const growth = monthly.currentMonth > 0 ? ((monthly.currentMonth - monthly.previousMonth) / monthly.previousMonth * 100).toFixed(1) : 0;
            const growthText = growth >= 0 ? `+${growth}%` : `${growth}%`;
            document.getElementById('revenueGrowth').textContent = `${growthText} so với tháng trước`;
            
            // Hoa hồng chờ thanh toán
            const pendingCommission = stats.totalRevenue * 0.15; // 15% hoa hồng
            document.getElementById('pendingCommission').textContent = formatCurrency(pendingCommission);
            document.getElementById('commissionCount').textContent = `${Object.keys(affiliatePartners).length} khách sạn`;
            
            // Booking khách sạn
            document.getElementById('hotelBookings').textContent = stats.hotelBookings;
            const hotelRevenue = stats.hotelBookings * 1000000; // Ước tính
            document.getElementById('hotelRevenue').textContent = formatCurrency(hotelRevenue);
            
            // Booking tour
            document.getElementById('tourBookings').textContent = stats.tourBookings;
            const tourRevenue = stats.tourBookings * 500000; // Ước tính
            document.getElementById('tourRevenue').textContent = formatCurrency(tourRevenue);
            
            // Phân bố doanh thu
            const totalRevenue = stats.totalRevenue;
            const hotelPercentage = totalRevenue > 0 ? Math.round((hotelRevenue / totalRevenue) * 100) : 0;
            const tourPercentage = totalRevenue > 0 ? Math.round((tourRevenue / totalRevenue) * 100) : 0;
            
            document.getElementById('hotelPercentage').textContent = `${hotelPercentage}%`;
            document.getElementById('tourPercentage').textContent = `${tourPercentage}%`;
            
            // Progress bar
            const target = 2500000000; // 2.5 tỷ
            const progress = totalRevenue > 0 ? Math.min((totalRevenue / target) * 100, 100) : 0;
            document.getElementById('revenueProgress').style.width = `${progress}%`;
            
            // Giao dịch VNPay
            document.getElementById('vnpaySuccess').textContent = stats.vnpayPayments;
            document.getElementById('vnpayFailed').textContent = '0'; // Mặc định 0 thất bại
        }
        
        // Hàm cập nhật top khách sạn
        function updateTopHotels() {
            const topHotelsDiv = document.getElementById('topHotels');
            if (!topHotelsDiv) return;
            
            // Lấy top 3 khách sạn từ dữ liệu
            const hotelBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.bookingType === 'hotel' && booking.paymentStatus === 'paid'
            );
            
            const hotelStats = {};
            hotelBookings.forEach(booking => {
                const hotelName = booking.hotelName;
                if (!hotelStats[hotelName]) {
                    hotelStats[hotelName] = { revenue: 0, bookings: 0 };
                }
                hotelStats[hotelName].revenue += booking.totalPrice || 0;
                hotelStats[hotelName].bookings++;
            });
            
            const topHotels = Object.entries(hotelStats)
                .sort(([,a], [,b]) => b.revenue - a.revenue)
                .slice(0, 3);
            
            if (topHotels.length === 0) {
                topHotelsDiv.innerHTML = '<div class="text-center text-muted">Chưa có dữ liệu khách sạn</div>';
                return;
            }
            
            let html = '';
            topHotels.forEach(([hotelName, stats], index) => {
                const maxRevenue = topHotels[0][1].revenue;
                const percentage = maxRevenue > 0 ? (stats.revenue / maxRevenue * 100) : 0;
                const colors = ['var(--accent)', 'var(--accent2)', '#28a745'];
                
                html += `
                    <div class="metric-card">
                        <div class="d-flex justify-content-between">
                            <span>${hotelName}</span>
                            <span class="fw-bold">${formatCurrency(stats.revenue)}</span>
                        </div>
                        <div class="progress-custom mt-2">
                            <div class="progress-bar-custom" style="width: ${percentage}%; background: ${colors[index]};"></div>
                        </div>
                        <small class="text-muted">${stats.bookings} booking</small>
                    </div>
                `;
            });
            
            topHotelsDiv.innerHTML = html;
        }
        
        // Hàm cập nhật top đối tác
        function updateTopPartners() {
            const topPartnersDiv = document.getElementById('topPartners');
            if (!topPartnersDiv) return;
            
            if (affiliatePartners.length === 0) {
                topPartnersDiv.innerHTML = '<div class="text-center text-muted">Chưa có dữ liệu đối tác</div>';
                return;
            }
            
            const topPartners = affiliatePartners
                .sort((a, b) => {
                    const revenueA = parseFloat(a.revenue.replace(/[^\d]/g, '')) || 0;
                    const revenueB = parseFloat(b.revenue.replace(/[^\d]/g, '')) || 0;
                    return revenueB - revenueA;
                })
                .slice(0, 3);
            
            let html = '';
            topPartners.forEach((partner, index) => {
                const revenue = parseFloat(partner.revenue.replace(/[^\d]/g, '')) || 0;
                const maxRevenue = parseFloat(topPartners[0].revenue.replace(/[^\d]/g, '')) || 0;
                const percentage = maxRevenue > 0 ? (revenue / maxRevenue * 100) : 0;
                const colors = ['var(--accent)', 'var(--accent2)', '#28a745'];
                
                html += `
                    <div class="metric-card">
                        <div class="d-flex justify-content-between">
                            <span>${partner.name}</span>
                            <span class="fw-bold">${partner.revenue}</span>
                        </div>
                        <div class="progress-custom mt-2">
                            <div class="progress-bar-custom" style="width: ${percentage}%; background: ${colors[index]};"></div>
                        </div>
                        <small class="text-muted">${partner.commission}% hoa hồng</small>
                    </div>
                `;
            });
            
            topPartnersDiv.innerHTML = html;
        }
        
        // Hàm cập nhật giao dịch gần đây
        function updateRecentTransactions() {
            const tbody = document.getElementById('recentTransactions');
            if (!tbody) return;
            
            const allBookings = Object.values(realtimeData.bookings)
                .filter(booking => booking.paymentStatus === 'paid')
                .sort((a, b) => b.createdAt - a.createdAt)
                .slice(0, 5);
            
            if (allBookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Chưa có giao dịch nào</td></tr>';
                return;
            }
            
            let html = '';
            allBookings.forEach(booking => {
                const date = new Date(booking.createdAt);
                const timeStr = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const itemName = booking.hotelName || booking.tourName;
                const status = booking.paymentStatus === 'paid' ? 'bg-success' : 'bg-warning';
                const statusText = booking.paymentStatus === 'paid' ? 'Thành công' : 'Đang xử lý';
                
                html += `
                    <tr>
                        <td>${timeStr}</td>
                        <td>${itemName}</td>
                        <td>${booking.customerName}</td>
                        <td class="text-success">+${formatCurrency(booking.totalPrice)}</td>
                        <td><span class="badge ${status}">${statusText}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Hàm cập nhật hoạt động gần đây
        function updateRecentActivities() {
            const activitiesDiv = document.getElementById('recentActivities');
            if (!activitiesDiv) return;
            
            const activities = [
                {
                    icon: 'fas fa-check',
                    bgColor: 'bg-success',
                    title: 'Đối soát thành công',
                    time: '2 phút trước'
                },
                {
                    icon: 'fas fa-exclamation',
                    bgColor: 'bg-warning',
                    title: 'Chênh lệch phát hiện',
                    time: '15 phút trước'
                },
                {
                    icon: 'fas fa-credit-card',
                    bgColor: 'bg-info',
                    title: 'Thanh toán hoa hồng',
                    time: '1 giờ trước'
                },
                {
                    icon: 'fas fa-chart-line',
                    bgColor: 'bg-primary',
                    title: 'Báo cáo tháng được tạo',
                    time: '2 giờ trước'
                }
            ];
            
            let html = '';
            activities.forEach(activity => {
                html += `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.bgColor}">
                            <i class="${activity.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </div>
                `;
            });
            
            activitiesDiv.innerHTML = html;
        }
        
        // Hàm load cài đặt khi khởi tạo
        function loadSettings() {
            // Load commission settings from Firebase (with local fallback)
            loadSettingsFromFirebase();
            
            // Load payment settings
            const paymentSettings = JSON.parse(localStorage.getItem('paymentSettings') || '{}');
            if (paymentSettings.autoPayment !== undefined) {
                document.getElementById('autoPayment').checked = paymentSettings.autoPayment;
            }
            if (paymentSettings.paymentCycle) {
                document.getElementById('paymentCycle').value = paymentSettings.paymentCycle;
            }
            
            // Load notification settings
            const notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{}');
            if (notificationSettings.revenueAlert !== undefined) {
                document.getElementById('revenueAlert').checked = notificationSettings.revenueAlert;
            }
            if (notificationSettings.reconcileAlert !== undefined) {
                document.getElementById('reconcileAlert').checked = notificationSettings.reconcileAlert;
            }
            if (notificationSettings.paymentAlert !== undefined) {
                document.getElementById('paymentAlert').checked = notificationSettings.paymentAlert;
            }
        }
    </script>
</body>
</html>