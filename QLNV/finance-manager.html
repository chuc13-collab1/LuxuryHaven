<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω t√†i ch√≠nh (Finance Manager)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --main-bg: #181c2f; --sidebar-bg: #23244a; --card-bg: #23244a; --accent: #7c3aed; --accent2: #00eaff; --text: #f3f6fa; --text-muted: #b0b8d1; --border: #2e325a; --shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.15); }
        body { background: var(--main-bg); color: var(--text); font-family: 'Poppins', Arial, sans-serif; margin: 0; }
        .sidebar { width: 240px; background: var(--sidebar-bg); color: var(--text); min-height: 100vh; position: fixed; top: 0; left: 0; z-index: 100; display: flex; flex-direction: column; }
        .sidebar .logo { padding: 32px 0 24px 0; text-align: center; font-size: 1.6rem; font-weight: 700; letter-spacing: 2px; color: var(--accent); }
        .sidebar .nav-item { display: flex; align-items: center; padding: 14px 32px; color: var(--text-muted); text-decoration: none; font-size: 1.08rem; border-left: 4px solid transparent; transition: background 0.2s, color 0.2s, border-color 0.2s; }
        .sidebar .nav-item.active, .sidebar .nav-item:hover { background: #1a1d36; color: var(--accent2); border-left: 4px solid var(--accent); }
        .sidebar .nav-item i { margin-right: 14px; font-size: 1.2rem; }
        .sidebar-footer { margin-top: auto; padding: 24px 32px; }
        .sidebar-footer .btn { width: 100%; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-weight: 500; }
        .main-container { margin-left: 240px; min-height: 100vh; background: var(--main-bg); }
        .main-header { background: #1a1d36; border-bottom: 1px solid var(--border); padding: 20px 40px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
        .main-header .user-info { display: flex; align-items: center; gap: 14px; }
        .main-header .user-info img { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .content-wrapper { padding: 40px 32px 32px 32px; }
        .card-modern { background: var(--card-bg); border-radius: 18px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 32px; padding: 0; }
        .card-modern .card-body { padding: 32px 28px; }
        .card-modern .card-title { color: var(--accent2); font-weight: 600; font-size: 1.2rem; margin-bottom: 18px; }
        .profile-info { display: flex; align-items: center; gap: 32px; }
        .profile-info img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .profile-info .info { font-size: 1.1rem; }

        /* New styles for finance management */
        .content-section { display: none; }
        .content-section.active { display: block; }
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: 24px; border: 1px solid var(--border); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px; }
        .trend-up { color: #28a745; font-weight: 600; }
        .trend-down { color: #dc3545; font-weight: 600; }
        .trend-stable { color: #ffc107; font-weight: 600; }
        .finance-card { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border); padding: 24px; margin-bottom: 24px; }
        .finance-card h5 { color: var(--accent2); margin-bottom: 20px; font-weight: 600; }
        .data-table { background: var(--card-bg); border-radius: 12px; overflow: hidden; }
        .table-dark { --bs-table-bg: var(--card-bg); --bs-table-border-color: var(--border); }
        .form-control, .form-select { background: var(--main-bg); border: 1px solid var(--border); color: var(--text); }
        .form-control:focus, .form-select:focus { background: var(--main-bg); border-color: var(--accent); color: var(--text); box-shadow: 0 0 0 0.2rem rgba(124, 58, 237, 0.25); }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: #6d28d9; border-color: #6d28d9; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning:hover { background: #d39e00; }
        .btn-info:hover { background: #138496; }
        .btn-danger:hover { background: #c82333; }
        .progress-custom { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar-custom { height: 100%; transition: width 0.3s ease; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--border); }
        .modal-header { border-bottom: 1px solid var(--border); }
        .modal-footer { border-top: 1px solid var(--border); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .metric-card { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 16px; margin-bottom: 12px; }

        @media (max-width: 900px) { .sidebar { width: 80px; } .main-container { margin-left: 80px; } .sidebar .nav-item { padding: 12px 10px; font-size: 0.95rem; } .sidebar .logo { font-size: 1.1rem; } .kpi-grid { grid-template-columns: 1fr; } }
        @media (max-width: 700px) { .sidebar { display: none; } .main-container { margin-left: 0; } .main-header { padding: 12px 10px; } .content-wrapper { padding: 12px 4px; } }
        
        /* Activity items */
        .activity-item { display: flex; align-items: center; margin-bottom: 16px; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
        .activity-content { flex: 1; }
        .activity-title { font-weight: 500; margin-bottom: 4px; }
        .activity-time { font-size: 0.8rem; color: var(--text-muted); }
        
        /* Progress bars */
        .progress-custom { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .progress-bar-custom { height: 100%; transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-hotel"></i> LUXSTAFF
        </div>
        <a href="#dashboard" class="nav-item" onclick="showSection('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</a>
        <a href="#revenue" class="nav-item" onclick="showSection('revenue')"><i class="fas fa-dollar-sign"></i> Doanh thu</a>
        <a href="#commission" class="nav-item" onclick="showSection('commission')"><i class="fas fa-percent"></i> Hoa h·ªìng</a>
        <a href="#reconciliation" class="nav-item" onclick="showSection('reconciliation')"><i class="fas fa-balance-scale"></i> ƒê·ªëi so√°t</a>
        <a href="#settings" class="nav-item" onclick="showSection('settings')"><i class="fas fa-cogs"></i> C√†i ƒë·∫∑t</a>
        <div class="sidebar-footer">
            <button class="btn" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> ƒêƒÉng xu·∫•t</button>
        </div>
    </div>
    <div class="main-container">
        <header class="main-header">
            <h1 class="h4 mb-0" style="color:var(--accent2);">Qu·∫£n l√Ω t√†i ch√≠nh</h1>
            <div class="user-info">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar">
                <span><strong>Finance Manager</strong></span>
            </div>
        </header>
        <main class="content-wrapper">
            <!-- Section Vai tr√≤ (m·∫∑c ƒë·ªãnh) -->
            <div id="roleSection" class="content-section active">
                <!-- KPI Overview -->
                <section class="mb-4">
                    <div class="kpi-grid">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--accent2);">‚Ç´12.8B</div>
                            <div class="stat-label">T·ªïng doanh thu th√°ng</div>
                            <small class="trend-up"><i class="fas fa-arrow-up"></i> +18.5%</small>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #28a745;">‚Ç´890M</div>
                            <div class="stat-label">Hoa h·ªìng kh√°ch s·∫°n</div>
                            <small class="trend-up"><i class="fas fa-arrow-up"></i> +12.3%</small>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #ffc107;">‚Ç´156M</div>
                            <div class="stat-label">Ph√≠ d·ªãch v·ª•</div>
                            <small class="trend-stable"><i class="fas fa-minus"></i> 0.0%</small>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #17a2b8;">98.2%</div>
                            <div class="stat-label">T·ª∑ l·ªá ƒë·ªëi so√°t</div>
                            <small class="trend-up"><i class="fas fa-arrow-up"></i> +2.1%</small>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="card-modern mb-4">
                        <div class="card-body profile-info">
                            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar">
                            <div class="info">
                                <h4 class="mb-1" style="color:var(--accent2);">Qu·∫£n l√Ω t√†i ch√≠nh (Finance Manager)</h4>
                                <div><i class="fas fa-briefcase me-2"></i> ƒê·ªëi so√°t doanh thu, hoa h·ªìng gi·ªØa h·ªá th·ªëng v√† kh√°ch s·∫°n</div>
                                <hr style="border-color: var(--border); margin: 16px 0;">
                                <div>
                                    <strong style="color: var(--accent2);">Ch·ª©c nƒÉng ch√≠nh:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px;">
                                        <li>Theo d√µi doanh thu v√† hoa h·ªìng real-time</li>
                                        <li>ƒê·ªëi so√°t s·ªë li·ªáu v·ªõi c√°c kh√°ch s·∫°n ƒë·ªëi t√°c</li>
                                        <li>Qu·∫£n l√Ω thanh to√°n v√† refund</li>
                                        <li>B√°o c√°o t√†i ch√≠nh ƒë·ªãnh k·ª≥</li>
                                        <li>Ph√¢n t√≠ch xu h∆∞·ªõng v√† d·ª± b√°o</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Section Dashboard -->
            <div id="dashboardSection" class="content-section">
                <!-- Th·ªëng k√™ t·ªïng quan -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="finance-card">
                            <div class="text-center">
                                <i class="fas fa-chart-line fa-2x mb-2" style="color: var(--accent2);"></i>
                                <h6>Doanh thu th√°ng n√†y</h6>
                                <div class="stat-number text-success" id="monthlyRevenue">‚Ç´0</div>
                                <small class="text-muted" id="revenueGrowth">+0% so v·ªõi th√°ng tr∆∞·ªõc</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="finance-card">
                            <div class="text-center">
                                <i class="fas fa-coins fa-2x mb-2" style="color: #ffc107;"></i>
                                <h6>Hoa h·ªìng ch·ªù thanh to√°n</h6>
                                <div class="stat-number text-warning" id="pendingCommission">‚Ç´0</div>
                                <small class="text-muted" id="commissionCount">0 kh√°ch s·∫°n</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="finance-card">
                            <div class="text-center">
                                <i class="fas fa-hotel fa-2x mb-2" style="color: #28a745;"></i>
                                <h6>Booking kh√°ch s·∫°n</h6>
                                <div class="stat-number text-success" id="hotelBookings">0</div>
                                <small class="text-muted" id="hotelRevenue">‚Ç´0 doanh thu</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="finance-card">
                            <div class="text-center">
                                <i class="fas fa-map-marked-alt fa-2x mb-2" style="color: #17a2b8;"></i>
                                <h6>Booking tour</h6>
                                <div class="stat-number text-info" id="tourBookings">0</div>
                                <small class="text-muted" id="tourRevenue">‚Ç´0 doanh thu</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Th·ªëng k√™ chi ti·∫øt -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="finance-card">
                            <h5><i class="fas fa-chart-pie me-2"></i>Ph√¢n b·ªë doanh thu</h5>
                            <div class="row">
                                <div class="col-6">
                                    <div class="metric-card text-center">
                                        <div class="stat-number text-primary" id="hotelPercentage">0%</div>
                                        <div class="stat-label">Kh√°ch s·∫°n</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card text-center">
                                        <div class="stat-number text-warning" id="tourPercentage">0%</div>
                                        <div class="stat-label">Tour</div>
                                    </div>
                                </div>
                            </div>
                            <div class="progress-custom mt-3">
                                <div class="progress-bar-custom" id="revenueProgress" style="width: 0%; background: var(--accent);"></div>
                            </div>
                            <small class="text-muted">Target th√°ng: ‚Ç´2.5 t·ª∑</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="finance-card">
                            <h5><i class="fas fa-credit-card me-2"></i>Giao d·ªãch VNPay</h5>
                            <div class="row">
                                <div class="col-6">
                                    <div class="metric-card text-center">
                                        <div class="stat-number text-success" id="vnpaySuccess">0</div>
                                        <div class="stat-label">Th√†nh c√¥ng</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-card text-center">
                                        <div class="stat-number text-danger" id="vnpayFailed">0</div>
                                        <div class="stat-label">Th·∫•t b·∫°i</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-info btn-sm" onclick="generateVNPayReport()">
                                    <i class="fas fa-file-alt me-1"></i>B√°o c√°o VNPay
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top kh√°ch s·∫°n v√† ƒë·ªëi t√°c -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="finance-card">
                            <h5><i class="fas fa-trophy me-2"></i>Top kh√°ch s·∫°n theo doanh thu</h5>
                            <div id="topHotels">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="finance-card">
                            <h5><i class="fas fa-handshake me-2"></i>Top ƒë·ªëi t√°c affiliate</h5>
                            <div id="topPartners">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Giao d·ªãch g·∫ßn ƒë√¢y v√† ho·∫°t ƒë·ªông -->
                <div class="row g-4">
                    <div class="col-md-8">
                        <div class="finance-card">
                            <h5><i class="fas fa-history me-2"></i>Giao d·ªãch g·∫ßn ƒë√¢y</h5>
                            <div class="data-table">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>Th·ªùi gian</th>
                                            <th>Kh√°ch s·∫°n/Tour</th>
                                            <th>Kh√°ch h√†ng</th>
                                            <th>S·ªë ti·ªÅn</th>
                                            <th>Tr·∫°ng th√°i</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentTransactions">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="finance-card">
                            <h5><i class="fas fa-bell me-2"></i>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h5>
                            <div id="recentActivities">
                                <div class="activity-item">
                                    <div class="activity-icon bg-success">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">ƒê·ªëi so√°t th√†nh c√¥ng</div>
                                        <div class="activity-time">2 ph√∫t tr∆∞·ªõc</div>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon bg-warning">
                                        <i class="fas fa-exclamation"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">Ch√™nh l·ªách ph√°t hi·ªán</div>
                                        <div class="activity-time">15 ph√∫t tr∆∞·ªõc</div>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon bg-info">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">Thanh to√°n hoa h·ªìng</div>
                                        <div class="activity-time">1 gi·ªù tr∆∞·ªõc</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- N√∫t thao t√°c nhanh -->
                <div class="row g-4 mt-4">
                    <div class="col-12">
                        <div class="finance-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-bolt me-2"></i>Thao t√°c nhanh</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="updateDashboard()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh Dashboard
                                </button>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100 mb-2" onclick="showSection('revenue')">
                                        <i class="fas fa-dollar-sign me-1"></i>Xem doanh thu
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-warning w-100 mb-2" onclick="showSection('commission')">
                                        <i class="fas fa-coins me-1"></i>Qu·∫£n l√Ω hoa h·ªìng
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-info w-100 mb-2" onclick="showSection('reconciliation')">
                                        <i class="fas fa-balance-scale me-1"></i>ƒê·ªëi so√°t
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-success w-100 mb-2" onclick="showSection('settings')">
                                        <i class="fas fa-cogs me-1"></i>C√†i ƒë·∫∑t
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Doanh thu -->
            <div id="revenueSection" class="content-section">
                <div class="finance-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-dollar-sign me-2"></i>Qu·∫£n l√Ω doanh thu</h5>
                        <div>
                            <!-- <button class="btn btn-info btn-sm me-2" onclick="refreshFirebaseData()" title="Refresh t·ª´ Firebase">
                                <i class="fas fa-fire"></i> Refresh Firebase
                            </button> -->
                            <!-- <button class="btn btn-warning btn-sm me-2" onclick="loadSampleData()" title="Load d·ªØ li·ªáu m·∫´u">
                                <i class="fas fa-database"></i> Load Sample
                            </button> -->
                            <!-- <button class="btn btn-secondary btn-sm me-2" onclick="debugData()" title="Ki·ªÉm tra d·ªØ li·ªáu">
                                <i class="fas fa-bug"></i> Debug
                            </button> -->
                            <button class="btn btn-success btn-sm me-2" onclick="exportRevenue()">
                                <i class="fas fa-download"></i> Xu·∫•t Excel
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="refreshRevenue()">
                                <i class="fas fa-sync"></i> L√†m m·ªõi
                            </button>
                        </div>
                    </div>

                    <!-- B·ªô l·ªçc -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <select class="form-select" id="revenueHotel">
                                <option value="">T·∫•t c·∫£ kh√°ch s·∫°n</option>
                                <option value="luxury-hn">Luxury Hotel HN</option>
                                <option value="beach-dn">Beach Resort DN</option>
                                <option value="city-hcm">City Hotel HCM</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="revenueFromDate" value="2025-08-01">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="revenueToDate" value="2025-08-03">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary w-100" onclick="filterRevenue()">
                                <i class="fas fa-filter"></i> L·ªçc d·ªØ li·ªáu
                            </button>
                        </div>
                    </div>

                    <!-- B·∫£ng doanh thu -->
                    <div class="row mb-4">
                        <!-- Th·ªëng k√™ t·ªïng h·ª£p -->
                        <div class="col-12">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-primary">üè® <span id="totalHotelBookings">0</span></div>
                                        <div class="stat-label">Booking Kh√°ch s·∫°n</div>
                                        <div class="small text-muted" id="totalHotelRevenue">‚Ç´0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-warning">üó∫Ô∏è <span id="totalTourBookings">0</span></div>
                                        <div class="stat-label">Booking Tours</div>
                                        <div class="small text-muted" id="totalTourRevenue">‚Ç´0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-info">üí∞ <span id="totalDepositBookings">0</span></div>
                                        <div class="stat-label">ƒê·∫∑t c·ªçc</div>
                                        <div class="small text-muted" id="totalDepositRevenue">‚Ç´0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-success">üéÅ <span id="totalPromotionBookings">0</span></div>
                                        <div class="stat-label">∆Øu ƒë√£i</div>
                                        <div class="small text-muted" id="totalPromotionRevenue">‚Ç´0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-success">üí∞ <span id="totalRevenue">‚Ç´0</span></div>
                                        <div class="stat-label">T·ªïng doanh thu</div>
                                        <div class="small text-muted" id="totalCommission">Hoa h·ªìng: ‚Ç´0</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="stat-card">
                                        <div class="stat-number text-info">üìä <span id="totalBookings">0</span></div>
                                        <div class="stat-label">T·ªïng booking</div>
                                        <div class="small text-muted" id="averageRevenue">TB: ‚Ç´0/booking</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- B·∫£ng Kh√°ch s·∫°n (tr√™n) -->
                        <div class="col-12">
                            <div class="data-table mb-4">
                                <h6 class="mb-3"><i class="fas fa-hotel text-primary"></i> Doanh thu Kh√°ch s·∫°n</h6>
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>Kh√°ch s·∫°n</th>
                                            <th>S·ªë booking</th>
                                            <th>Doanh thu gross</th>
                                            <th>Hoa h·ªìng (15%)</th>
                                            <th>Doanh thu net</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hotelRevenueTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ƒêang t·∫£i d·ªØ li·ªáu kh√°ch s·∫°n...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- B·∫£ng Tours (d∆∞·ªõi) -->
                        <div class="col-12">
                            <div class="data-table mb-4">
                                <h6 class="mb-3"><i class="fas fa-map-marked-alt text-warning"></i> Doanh thu Tours</h6>
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>Tour</th>
                                            <th>S·ªë booking</th>
                                            <th>Doanh thu gross</th>
                                            <th>Hoa h·ªìng (15%)</th>
                                            <th>Doanh thu net</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tourRevenueTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ƒêang t·∫£i d·ªØ li·ªáu tours...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- B·∫£ng ƒê·∫∑t c·ªçc -->
                        <div class="col-12">
                            <div class="data-table mb-4">
                                <h6 class="mb-3"><i class="fas fa-money-bill-wave text-info"></i> ƒê·∫∑t c·ªçc</h6>
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>Kh√°ch h√†ng</th>
                                            <th>Lo·∫°i</th>
                                            <th>S·ªë ti·ªÅn c·ªçc</th>
                                            <th>Ghi ch√∫</th>
                                            <th>Tr·∫°ng th√°i</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="depositTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ƒêang t·∫£i d·ªØ li·ªáu ƒë·∫∑t c·ªçc...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- B·∫£ng ∆Øu ƒë√£i -->
                        <div class="col-12">
                            <div class="data-table mb-4">
                                <h6 class="mb-3"><i class="fas fa-gift text-success"></i> ∆Øu ƒë√£i & Khuy·∫øn m√£i</h6>
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>Kh√°ch h√†ng</th>
                                            <th>Lo·∫°i</th>
                                            <th>Gi√° g·ªëc</th>
                                            <th>Gi√° sau ∆∞u ƒë√£i</th>
                                            <th>Ti·∫øt ki·ªám</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="promotionTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                ƒêang t·∫£i d·ªØ li·ªáu ∆∞u ƒë√£i...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Hoa h·ªìng -->
            <div id="commissionSection" class="content-section">
                <div class="finance-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-percent me-2"></i>Qu·∫£n l√Ω hoa h·ªìng</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="processAllCommissions()">
                                <i class="fas fa-credit-card"></i> Thanh to√°n t·∫•t c·∫£
                            </button>
                            <button class="btn btn-info btn-sm me-2" onclick="commissionSettings()">
                                <i class="fas fa-cog"></i> C√†i ƒë·∫∑t t·ª∑ l·ªá
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="refreshCommissionData()">
                                <i class="fas fa-sync"></i> L√†m m·ªõi d·ªØ li·ªáu
                            </button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ hoa h·ªìng realtime -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-info" id="pendingCommission">‚Ç´0</div>
                                <div class="stat-label">Ch·ªù thanh to√°n</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-success" id="paidCommission">‚Ç´0</div>
                                <div class="stat-label">ƒê√£ thanh to√°n th√°ng n√†y</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-warning" id="avgCommissionRate">15%</div>
                                <div class="stat-label">T·ª∑ l·ªá hoa h·ªìng TB</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-primary" id="totalPartners">0</div>
                                <div class="stat-label">Kh√°ch s·∫°n ƒë·ªëi t√°c</div>
                            </div>
                        </div>
                    </div>

                    <!-- B·∫£ng hoa h·ªìng realtime -->
                    <div class="data-table">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Kh√°ch s·∫°n</th>
                                    <th>T·ª∑ l·ªá hoa h·ªìng</th>
                                    <th>Doanh thu g·ªëc</th>
                                    <th>Hoa h·ªìng t√≠ch l≈©y</th>
                                    <th>ƒê√£ thanh to√°n</th>
                                    <th>Ch∆∞a thanh to√°n</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="commissionTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        ƒêang t·∫£i d·ªØ li·ªáu hoa h·ªìng...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section ƒê·ªëi so√°t -->
            <div id="reconciliationSection" class="content-section">
                <div class="finance-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-balance-scale me-2"></i>ƒê·ªëi so√°t t√†i ch√≠nh</h5>
                        <div>
                            <button class="btn btn-warning btn-sm me-2" onclick="startReconciliation()">
                                <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu ƒë·ªëi so√°t
                            </button>
                            <button class="btn btn-info btn-sm me-2" onclick="autoReconcile()">
                                <i class="fas fa-robot"></i> T·ª± ƒë·ªông ƒë·ªëi so√°t
                            </button>
                            <button class="btn btn-success btn-sm" onclick="updateReconciliationTable()">
                                <i class="fas fa-sync"></i> L√†m m·ªõi d·ªØ li·ªáu
                            </button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ ƒë·ªëi so√°t -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-warning" id="pendingReconciliation">0</div>
                                <div class="stat-label">Ch·ªù ƒë·ªëi so√°t</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-success" id="completedReconciliation">0</div>
                                <div class="stat-label">ƒê√£ ƒë·ªëi so√°t</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-danger" id="totalDiscrepancies">0</div>
                                <div class="stat-label">Ch√™nh l·ªách</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number text-info" id="pendingAmount">‚Ç´0</div>
                                <div class="stat-label">S·ªë ti·ªÅn ch·ªù</div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload file ƒë·ªëi so√°t -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <h6><i class="fas fa-upload me-2"></i>Upload file t·ª´ kh√°ch s·∫°n</h6>
                                <input type="file" class="form-control mb-2" accept=".xlsx,.csv" id="reconcileFile">
                                <button class="btn btn-primary btn-sm" onclick="uploadReconcileFile()">
                                    <i class="fas fa-cloud-upload-alt"></i> T·∫£i l√™n
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <h6><i class="fas fa-download me-2"></i>T·∫£i template</h6>
                                <p class="small mb-2">File Excel m·∫´u cho kh√°ch s·∫°n g·ª≠i d·ªØ li·ªáu ƒë·ªëi so√°t</p>
                                <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate()">
                                    <i class="fas fa-file-excel"></i> T·∫£i template
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- B·∫£ng ƒë·ªëi so√°t -->
                    <div class="data-table">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Kh√°ch s·∫°n/Tour</th>
                                    <th>ƒê·ªãa ƒëi·ªÉm</th>
                                    <th>K·ª≥ ƒë·ªëi so√°t</th>
                                    <th>Doanh thu</th>
                                    <th>T·ª∑ l·ªá HH</th>
                                    <th>Hoa h·ªìng</th>
                                    <th>ƒê√£ thanh to√°n</th>
                                    <th>Ch∆∞a thanh to√°n</th>
                                    <th>Ch√™nh l·ªách</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="reconciliationTableBody">
                                <tr>
                                    <td colspan="11" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        ƒêang t·∫£i d·ªØ li·ªáu ƒë·ªëi so√°t...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section B√°o c√°o -->
            <div id="reportsSection" class="content-section">
                <div class="finance-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5><i class="fas fa-file-alt me-2"></i>B√°o c√°o t√†i ch√≠nh</h5>
                        <div>
                            <button class="btn btn-success btn-sm me-2" onclick="generateFinanceReport()">
                                <i class="fas fa-plus"></i> T·∫°o b√°o c√°o
                            </button>
                            <button class="btn btn-info btn-sm me-2" onclick="scheduleReport()">
                                <i class="fas fa-clock"></i> L√™n l·ªãch
                            </button>
                            <button class="btn btn-warning btn-sm me-2" onclick="testDataConnection()">
                                <i class="fas fa-database"></i> Test Data
                            </button>
                            <button class="btn btn-danger btn-sm me-2" onclick="checkFirebaseConnection()">
                                <i class="fas fa-fire"></i> Check Firebase
                            </button>
                            <button class="btn btn-secondary btn-sm me-2" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                                <i class="fas fa-sync"></i> Auto-refresh
                            </button>
                            <button class="btn btn-primary btn-sm me-2" onclick="showHotelTourStats()">
                                <i class="fas fa-chart-pie"></i> Hotel vs Tour
                            </button>
                        </div>
                    </div>

                    <!-- Th·ªëng k√™ realtime -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <i class="fas fa-calendar-alt fa-2x mb-2" style="color: var(--accent);"></i>
                                <h6>Th·ªëng k√™ th√°ng hi·ªán t·∫°i</h6>
                                <div id="currentMonthStats">
                                    <div class="small text-muted">ƒêang t·∫£i...</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <i class="fas fa-credit-card fa-2x mb-2" style="color: #ffc107;"></i>
                                <h6>Giao d·ªãch VNPay</h6>
                                <div id="vnpayStats">
                                    <div class="small text-muted">ƒêang t·∫£i...</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <i class="fas fa-hotel fa-2x mb-2" style="color: #28a745;"></i>
                                <h6>Booking kh√°ch s·∫°n</h6>
                                <div id="hotelBookingStats">
                                    <div class="small text-muted">ƒêang t·∫£i...</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <i class="fas fa-map-marked-alt fa-2x mb-2" style="color: #17a2b8;"></i>
                                <h6>Booking tour</h6>
                                <div id="tourBookingStats">
                                    <div class="small text-muted">ƒêang t·∫£i...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- B√°o c√°o c√≥ s·∫µn -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="metric-card text-center">
                                <i class="fas fa-chart-pie fa-2x mb-2" style="color: var(--accent);"></i>
                                <h6>B√°o c√°o doanh thu</h6>
                                <button class="btn btn-sm btn-primary" onclick="generateReport('revenue')">T·∫°o b√°o c√°o</button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card text-center">
                                <i class="fas fa-coins fa-2x mb-2" style="color: #ffc107;"></i>
                                <h6>B√°o c√°o hoa h·ªìng</h6>
                                <button class="btn btn-sm btn-warning" onclick="generateReport('commission')">T·∫°o b√°o c√°o</button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card text-center">
                                <i class="fas fa-balance-scale fa-2x mb-2" style="color: #28a745;"></i>
                                <h6>B√°o c√°o ƒë·ªëi so√°t</h6>
                                <button class="btn btn-sm btn-success" onclick="generateReport('reconciliation')">T·∫°o b√°o c√°o</button>
                            </div>
                        </div>
                    </div>

                    <!-- L·ªãch s·ª≠ b√°o c√°o -->
                    <div class="data-table">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>T√™n b√°o c√°o</th>
                                    <th>Lo·∫°i</th>
                                    <th>K·ª≥ b√°o c√°o</th>
                                    <th>Ng√†y t·∫°o</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>B√°o c√°o doanh thu th√°ng 7/2025</td>
                                    <td><span class="badge bg-primary">Doanh thu</span></td>
                                    <td>01/07 - 31/07/2025</td>
                                    <td>01/08/2025 09:00</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-info me-1" title="Xem"><i class="fas fa-eye"></i></button>
                                        <button class="btn btn-sm btn-success me-1" title="T·∫£i"><i class="fas fa-download"></i></button>
                                        <button class="btn btn-sm btn-warning" title="Chia s·∫ª"><i class="fas fa-share"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>B√°o c√°o hoa h·ªìng Q2/2025</td>
                                    <td><span class="badge bg-warning">Hoa h·ªìng</span></td>
                                    <td>01/04 - 30/06/2025</td>
                                    <td>02/07/2025 14:30</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-info me-1" title="Xem"><i class="fas fa-eye"></i></button>
                                        <button class="btn btn-sm btn-success me-1" title="T·∫£i"><i class="fas fa-download"></i></button>
                                        <button class="btn btn-sm btn-warning" title="Chia s·∫ª"><i class="fas fa-share"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>B√°o c√°o ƒë·ªëi so√°t tu·∫ßn 31</td>
                                    <td><span class="badge bg-success">ƒê·ªëi so√°t</span></td>
                                    <td>29/07 - 04/08/2025</td>
                                    <td>03/08/2025 16:45</td>
                                    <td><span class="badge bg-info">Processing</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary me-1" disabled title="ƒêang x·ª≠ l√Ω"><i class="fas fa-clock"></i></button>
                                        <button class="btn btn-sm btn-danger" title="H·ªßy" onclick="cancelReport('week31')"><i class="fas fa-times"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section C√†i ƒë·∫∑t -->
            <div id="settingsSection" class="content-section">
                <div class="finance-card">
                    <h5><i class="fas fa-cogs me-2"></i>C√†i ƒë·∫∑t t√†i ch√≠nh</h5>
                    
                    <div class="row g-4">
                        <!-- C√†i ƒë·∫∑t hoa h·ªìng -->
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h6><i class="fas fa-percent me-2"></i>C√†i ƒë·∫∑t t·ª∑ l·ªá hoa h·ªìng</h6>
                                <div class="mb-3">
                                    <label class="form-label">T·ª∑ l·ªá hoa h·ªìng m·∫∑c ƒë·ªãnh</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="defaultCommissionRate" value="15" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Hoa h·ªìng t·ªëi thi·ªÉu</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="minCommissionRate" value="10" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="saveCommissionSettings()">L∆∞u c√†i ƒë·∫∑t</button>
                                <button class="btn btn-info btn-sm ms-2" onclick="loadSettingsFromFirebase()">T·∫£i t·ª´ Firebase</button>
                            </div>
                        </div>

                        <!-- C√†i ƒë·∫∑t thanh to√°n -->
                        <div class="col-md-6">
                            <div class="metric-card">
                                <h6><i class="fas fa-credit-card me-2"></i>C√†i ƒë·∫∑t thanh to√°n</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="autoPayment" checked>
                                    <label class="form-check-label" for="autoPayment">
                                        T·ª± ƒë·ªông thanh to√°n hoa h·ªìng
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Chu k·ª≥ thanh to√°n</label>
                                    <select class="form-select" id="paymentCycle">
                                        <option value="weekly">H√†ng tu·∫ßn</option>
                                        <option value="monthly" selected>H√†ng th√°ng</option>
                                        <option value="quarterly">H√†ng qu√Ω</option>
                                    </select>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="savePaymentSettings()">C·∫≠p nh·∫≠t</button>
                            </div>
                        </div>
                    </div>

                    <!-- Qu·∫£n l√Ω ƒë·ªëi t√°c t·ª´ Affiliate Manager -->
                    <div class="row g-4 mt-3">
                        <div class="col-md-12">
                            <div class="metric-card">
                                <h6><i class="fas fa-handshake me-2"></i>Qu·∫£n l√Ω ƒë·ªëi t√°c t·ª´ Affiliate Manager</h6>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-muted">D·ªØ li·ªáu ƒë·ªëi t√°c t·ª´ h·ªá th·ªëng Affiliate</span>
                                    <button class="btn btn-info btn-sm" onclick="loadAffiliatePartners()">
                                        <i class="fas fa-sync"></i> L√†m m·ªõi d·ªØ li·ªáu
                                    </button>
                                </div>
                                
                                <!-- Th·ªëng k√™ ƒë·ªëi t√°c -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary" id="totalPartners">0</div>
                                            <div class="stat-label">T·ªïng ƒë·ªëi t√°c</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success" id="activePartners">0</div>
                                            <div class="stat-label">ƒêang h·ª£p t√°c</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning" id="avgCommission">0%</div>
                                            <div class="stat-label">Hoa h·ªìng TB</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-info" id="totalRevenue">‚Ç´0</div>
                                            <div class="stat-label">T·ªïng doanh thu</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- B·∫£ng ƒë·ªëi t√°c -->
                                <div class="table-responsive">
                                    <table class="table table-dark table-hover">
                                        <thead>
                                            <tr>
                                                <th>T√™n ƒë·ªëi t√°c</th>
                                                <th>Website</th>
                                                <th>Email</th>
                                                <th>Tr·∫°ng th√°i</th>
                                                <th>Hoa h·ªìng</th>
                                                <th>Doanh thu</th>
                                                <th>Thao t√°c</th>
                                            </tr>
                                        </thead>
                                        <tbody id="affiliatePartnersTable">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    ƒêang t·∫£i d·ªØ li·ªáu ƒë·ªëi t√°c...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- C√†i ƒë·∫∑t th√¥ng b√°o -->
                    <div class="row g-4 mt-2">
                        <div class="col-md-12">
                            <div class="metric-card">
                                <h6><i class="fas fa-bell me-2"></i>C√†i ƒë·∫∑t th√¥ng b√°o</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="revenueAlert" checked>
                                            <label class="form-check-label" for="revenueAlert">
                                                C·∫£nh b√°o doanh thu
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="reconcileAlert" checked>
                                            <label class="form-check-label" for="reconcileAlert">
                                                C·∫£nh b√°o ƒë·ªëi so√°t
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="paymentAlert">
                                            <label class="form-check-label" for="paymentAlert">
                                                Nh·∫Øc nh·ªü thanh to√°n
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-info btn-sm mt-3" onclick="saveNotificationSettings()">L∆∞u th√¥ng b√°o</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Qu·∫£n l√Ω hi·ªÉn th·ªã section
        function showSection(sectionName) {
            try {
                // ·∫®n t·∫•t c·∫£ sections
                const allSections = document.querySelectorAll('.content-section');
                if (allSections.length > 0) {
                    allSections.forEach(section => {
                        if (section && section.classList) {
                            section.classList.remove('active');
                        }
                    });
                }
                
                // Hi·ªÉn th·ªã section ƒë∆∞·ª£c ch·ªçn
                const targetSection = document.getElementById(sectionName + 'Section');
                if (targetSection && targetSection.classList) {
                    targetSection.classList.add('active');
                }
                
                // C·∫≠p nh·∫≠t active state cho menu
                const navItems = document.querySelectorAll('.nav-item');
                if (navItems.length > 0) {
                    navItems.forEach(item => {
                        if (item && item.classList) {
                            item.classList.remove('active');
                        }
                    });
                }
                
                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ header
                const titles = {
                    'role': 'Qu·∫£n l√Ω t√†i ch√≠nh',
                    'dashboard': 'Finance Dashboard',
                    'revenue': 'Qu·∫£n l√Ω doanh thu',
                    'commission': 'Qu·∫£n l√Ω hoa h·ªìng',
                    'reconciliation': 'ƒê·ªëi so√°t t√†i ch√≠nh',
                    'reports': 'B√°o c√°o t√†i ch√≠nh',
                    'settings': 'C√†i ƒë·∫∑t t√†i ch√≠nh'
                };
                const headerTitle = document.querySelector('.main-header h1');
                if (headerTitle && titles[sectionName]) {
                    headerTitle.textContent = titles[sectionName];
                }
                
                console.log('‚úÖ Section changed to:', sectionName);
            } catch (error) {
                console.error('‚ùå Error in showSection:', error);
            }
        }
        
        // G√°n c√°c h√†m c·∫ßn thi·∫øt v√†o window ngay l·∫≠p t·ª©c
        window.showSection = showSection;
        window.logout = logout;
        window.debugData = debugData;
        window.loadSampleData = loadSampleData;
        window.loadRealtimeData = loadRealtimeData;
        window.showNotification = showNotification;
        window.formatCurrency = formatCurrency;
        window.addVNPayReportButton = addVNPayReportButton;
        window.startAutoRefresh = startAutoRefresh;
        window.refreshFirebaseData = refreshFirebaseData;
        window.generateVNPayReport = generateVNPayReport;
        window.showTimelineReport = showTimelineReport;
        window.viewBookingDetails = viewBookingDetails;
        window.reconcileHotel = reconcileHotel;
        window.processCommissions = processCommissions;
        window.exportRevenue = exportRevenue;
        window.refreshRevenue = refreshRevenue;
        window.filterRevenue = filterRevenue;
        window.processAllCommissions = processAllCommissions;
        window.commissionSettings = commissionSettings;
        window.payCommission = payCommission;
        window.startReconciliation = startReconciliation;
        window.autoReconcile = autoReconcile;
        window.uploadReconcileFile = uploadReconcileFile;
        window.downloadTemplate = downloadTemplate;
        window.investigateDiscrepancy = investigateDiscrepancy;
        window.markDispute = markDispute;
        window.requestData = requestData;
        window.generateFinanceReport = generateFinanceReport;
        window.scheduleReport = scheduleReport;
        window.generateReport = generateReport;
        window.cancelReport = cancelReport;
        window.testDataConnection = testDataConnection;
        window.checkFirebaseConnection = checkFirebaseConnection;
        window.retryFirebaseConnection = retryFirebaseConnection;
        window.toggleAutoRefresh = toggleAutoRefresh;
        window.showHotelTourStats = showHotelTourStats;
        window.updateRevenueSummary = updateRevenueSummary;
        window.updateCommissionTable = updateCommissionTable;
        window.viewCommissionDetails = viewCommissionDetails;
        window.refreshCommissionData = refreshCommissionData;
        window.loadAffiliatePartners = loadAffiliatePartners;
        window.viewPartnerDetails = viewPartnerDetails;
        window.editPartnerCommission = editPartnerCommission;
        window.saveCommissionSettings = saveCommissionSettings;
        window.savePaymentSettings = savePaymentSettings;
        window.saveNotificationSettings = saveNotificationSettings;
        window.generateReconciliationData = generateReconciliationData;
        window.updateReconciliationTable = updateReconciliationTable;
        window.reconcileItem = reconcileItem;
        window.viewReconciliationDetails = viewReconciliationDetails;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.appspot.com",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Kh·ªüi t·∫°o Firebase
        let database;
        try {
            console.log('üîÑ Initializing Firebase...');
            console.log('üì¶ Firebase SDK available:', typeof firebase !== 'undefined');
            console.log('üîß Firebase App available:', typeof firebase !== 'undefined' && firebase.app);
            console.log('üíæ Firebase Database available:', typeof firebase !== 'undefined' && firebase.database);
            
            // Ki·ªÉm tra xem Firebase c√≥ s·∫µn kh√¥ng
            if (typeof firebase !== 'undefined' && firebase.database) {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('‚úÖ Firebase initialized successfully');
                console.log('üîó Database URL:', firebaseConfig.databaseURL);
                
                // Test connection
                database.ref('.info/connected').on('value', (snapshot) => {
                    console.log('üåê Firebase connection status:', snapshot.val() ? 'Connected' : 'Disconnected');
                });
                
            } else {
                console.warn('‚ö†Ô∏è Firebase not available, using sample data');
                console.warn('‚ùå Firebase SDK missing or database module not loaded');
                database = null;
            }
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            console.error('üîç Error details:', error.message);
            database = null;
        }

        // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu realtime
        let realtimeData = {
            bookings: {},
            payments: {},
            revenueStats: {
                totalRevenue: 0,
                hotelBookings: 0,
                tourBookings: 0,
                depositBookings: 0,
                vnpayPayments: 0,
                totalBookings: 0
            },
            monthlyStats: {
                currentMonth: 0,
                previousMonth: 0,
                growthRate: 0
            }
        };

        // H√†m format ti·ªÅn t·ªá
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // H√†m t√≠nh to√°n th·ªëng k√™ t·ª´ d·ªØ li·ªáu realtime
        function calculateRevenueStats() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            let totalRevenue = 0;
            let hotelBookings = 0;
            let tourBookings = 0;
            let depositBookings = 0;
            let vnpayPayments = 0;
            let currentMonthRevenue = 0;
            let previousMonthRevenue = 0;

            console.log('üîç Calculating stats from:', Object.keys(realtimeData.bookings).length, 'bookings');

            // T√≠nh to√°n t·ª´ bookings
            Object.values(realtimeData.bookings).forEach(booking => {
                if (!booking.createdAt) {
                    console.warn('‚ö†Ô∏è Booking missing createdAt:', booking);
                    return;
                }

                const bookingDate = new Date(booking.createdAt);
                const bookingMonth = bookingDate.getMonth();
                const bookingYear = bookingDate.getFullYear();
                
                if (booking.paymentStatus === 'paid') {
                    const bookingAmount = booking.totalPrice || 0;
                    totalRevenue += bookingAmount;
                    
                    if (booking.bookingType === 'hotel') {
                        hotelBookings++;
                    } else if (booking.bookingType === 'tour') {
                        tourBookings++;
                    } else if (booking.bookingType === 'deposit') {
                        depositBookings++;
                    }

                    // T√≠nh doanh thu theo th√°ng
                    if (bookingMonth === currentMonth && bookingYear === currentYear) {
                        currentMonthRevenue += bookingAmount;
                    } else if (bookingMonth === (currentMonth - 1) && bookingYear === currentYear) {
                        previousMonthRevenue += bookingAmount;
                    }

                    console.log(`üìä Booking: ${booking.customerName} - ${booking.hotelName || booking.tourName} - ${formatCurrency(bookingAmount)}`);
                }
            });

            // T√≠nh to√°n t·ª´ payments
            Object.values(realtimeData.payments).forEach(payment => {
                if (payment.method === 'VNPAY' && payment.status === 'success') {
                    vnpayPayments++;
                }
            });

            console.log('üí∞ Revenue calculation:');
            console.log('  - Total revenue:', formatCurrency(totalRevenue));
            console.log('  - Hotel bookings:', hotelBookings);
            console.log('  - Tour bookings:', tourBookings);
            console.log('  - Current month revenue:', formatCurrency(currentMonthRevenue));

            // C·∫≠p nh·∫≠t th·ªëng k√™
            realtimeData.revenueStats = {
                totalRevenue,
                hotelBookings,
                tourBookings,
                depositBookings,
                vnpayPayments,
                totalBookings: hotelBookings + tourBookings + depositBookings
            };

            realtimeData.monthlyStats = {
                currentMonth: currentMonthRevenue,
                previousMonth: previousMonthRevenue,
                growthRate: previousMonthRevenue > 0 ? ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100 : 0
            };

            // C·∫≠p nh·∫≠t timestamp
            lastDataUpdate = Date.now();
            
            // C·∫≠p nh·∫≠t UI
            updateRevenueUI();
            
            // Th√¥ng b√°o n·∫øu c√≥ thay ƒë·ªïi ƒë√°ng k·ªÉ
            const previousTotal = realtimeData.revenueStats.totalRevenue || 0;
            if (totalRevenue > previousTotal) {
                const increase = totalRevenue - previousTotal;
                console.log(`üìà Revenue increased by ${formatCurrency(increase)}`);
            }
        }

        // H√†m c·∫≠p nh·∫≠t UI v·ªõi d·ªØ li·ªáu realtime
        function updateRevenueUI() {
            const stats = realtimeData.revenueStats;
            const monthly = realtimeData.monthlyStats;

            console.log('üîÑ Updating UI with stats:', stats);
            console.log('üìÖ Monthly stats:', monthly);

            // C·∫≠p nh·∫≠t KPI Overview
            const kpiElements = document.querySelectorAll('.kpi-grid .stat-card .stat-number');
            if (kpiElements.length >= 4) {
                kpiElements[0].textContent = formatCurrency(monthly.currentMonth);
                kpiElements[1].textContent = formatCurrency(stats.totalRevenue * 0.15); // Hoa h·ªìng 15%
                kpiElements[2].textContent = formatCurrency(stats.totalRevenue * 0.02); // Ph√≠ d·ªãch v·ª• 2%
                kpiElements[3].textContent = '98.2%'; // T·ª∑ l·ªá ƒë·ªëi so√°t
            }

            // C·∫≠p nh·∫≠t Dashboard
            updateDashboard();

            // C·∫≠p nh·∫≠t th·ªëng k√™ realtime trong Reports
            updateRealtimeStats();

            // C·∫≠p nh·∫≠t b·∫£ng doanh thu
            updateRevenueTable();
            
            // C·∫≠p nh·∫≠t b·∫£ng hoa h·ªìng
            updateCommissionTable();
            
            // C·∫≠p nh·∫≠t b·∫£ng ƒë·ªëi so√°t
            updateReconciliationTable();
            
            // Load d·ªØ li·ªáu ƒë·ªëi t√°c affiliate
            loadAffiliatePartners();
            
            // Load c√†i ƒë·∫∑t
            loadSettings();
            
            // Hi·ªÉn th·ªã th·ªëng k√™ t·ªïng h·ª£p
            console.log('üìä Revenue Summary:');
            console.log(`  üè® Hotel bookings: ${stats.hotelBookings} (${formatCurrency(stats.hotelBookings * 1000000)})`);
            console.log(`  üó∫Ô∏è Tour bookings: ${stats.tourBookings} (${formatCurrency(stats.tourBookings * 500000)})`);
            console.log(`  üí∞ Total revenue: ${formatCurrency(stats.totalRevenue)}`);
            console.log(`  üí≥ VNPay transactions: ${stats.vnpayPayments}`);
        }

        // H√†m c·∫≠p nh·∫≠t th·ªëng k√™ realtime
        function updateRealtimeStats() {
            const stats = realtimeData.revenueStats;
            const monthly = realtimeData.monthlyStats;
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            // Th·ªëng k√™ th√°ng hi·ªán t·∫°i
            const currentMonthStats = document.getElementById('currentMonthStats');
            if (currentMonthStats) {
                currentMonthStats.innerHTML = `
                    <div class="fw-bold text-success">${formatCurrency(monthly.currentMonth)}</div>
                    <div class="small text-muted">${stats.totalBookings} bookings</div>
                    <div class="small ${monthly.growthRate >= 0 ? 'text-success' : 'text-danger'}">
                        <i class="fas fa-arrow-${monthly.growthRate >= 0 ? 'up' : 'down'}"></i>
                        ${Math.abs(monthly.growthRate).toFixed(1)}% so th√°ng tr∆∞·ªõc
                    </div>
                `;
            }

            // Th·ªëng k√™ VNPay
            const vnpayStats = document.getElementById('vnpayStats');
            if (vnpayStats) {
                const vnpayPayments = Object.values(realtimeData.payments).filter(
                    payment => payment.method === 'VNPAY' && payment.status === 'success'
                );
                const vnpayTotal = vnpayPayments.reduce((sum, p) => sum + p.amount, 0);
                
                vnpayStats.innerHTML = `
                    <div class="fw-bold text-warning">${vnpayPayments.length}</div>
                    <div class="small text-muted">${formatCurrency(vnpayTotal)}</div>
                    <div class="small text-muted">Giao d·ªãch th√†nh c√¥ng</div>
                `;
            }

            // Th·ªëng k√™ booking kh√°ch s·∫°n
            const hotelBookingStats = document.getElementById('hotelBookingStats');
            if (hotelBookingStats) {
                const hotelBookings = Object.values(realtimeData.bookings).filter(
                    booking => booking.bookingType === 'hotel' && booking.paymentStatus === 'paid'
                );
                const hotelRevenue = hotelBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
                
                hotelBookingStats.innerHTML = `
                    <div class="fw-bold text-success">${hotelBookings.length}</div>
                    <div class="small text-muted">${formatCurrency(hotelRevenue)}</div>
                    <div class="small text-muted">ƒê√£ thanh to√°n</div>
                `;
            }

            // Th·ªëng k√™ booking tour
            const tourBookingStats = document.getElementById('tourBookingStats');
            if (tourBookingStats) {
                const tourBookings = Object.values(realtimeData.bookings).filter(
                    booking => booking.bookingType === 'tour' && booking.paymentStatus === 'paid'
                );
                const tourRevenue = tourBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
                
                tourBookingStats.innerHTML = `
                    <div class="fw-bold text-info">${tourBookings.length}</div>
                    <div class="small text-muted">${formatCurrency(tourRevenue)}</div>
                    <div class="small text-muted">ƒê√£ thanh to√°n</div>
                `;
            }
        }

        // H√†m c·∫≠p nh·∫≠t b·∫£ng doanh thu v·ªõi d·ªØ li·ªáu realtime
        function updateRevenueTable() {
            // C·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng h·ª£p
            updateRevenueSummary();
            
            // C·∫≠p nh·∫≠t b·∫£ng Kh√°ch s·∫°n
            updateHotelRevenueTable();
            
            // C·∫≠p nh·∫≠t b·∫£ng Tours
            updateTourRevenueTable();
            
            // C·∫≠p nh·∫≠t b·∫£ng ƒê·∫∑t c·ªçc
            updateDepositTable();
            
            // C·∫≠p nh·∫≠t b·∫£ng ∆Øu ƒë√£i
            updatePromotionTable();
        }

        // H√†m c·∫≠p nh·∫≠t b·∫£ng doanh thu Kh√°ch s·∫°n
        function updateHotelRevenueTable() {
            const tableBody = document.getElementById('hotelRevenueTableBody');
            if (!tableBody) return;

            // L·ªçc booking kh√°ch s·∫°n ƒë√£ thanh to√°n
            const hotelBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.paymentStatus === 'paid' && booking.bookingType === 'hotel' && booking.hotelName
            );
            
            // T·∫°o d·ªØ li·ªáu theo kh√°ch s·∫°n
            const hotelStats = {};
            
            hotelBookings.forEach(booking => {
                if (!hotelStats[booking.hotelName]) {
                    hotelStats[booking.hotelName] = {
                        bookings: 0,
                        grossRevenue: 0,
                        commission: 0,
                        netRevenue: 0,
                        lastBookingDate: null
                    };
                }
                
                hotelStats[booking.hotelName].bookings++;
                hotelStats[booking.hotelName].grossRevenue += booking.totalPrice || 0;
                
                // C·∫≠p nh·∫≠t ng√†y booking m·ªõi nh·∫•t
                const bookingDate = new Date(booking.createdAt);
                if (!hotelStats[booking.hotelName].lastBookingDate || 
                    bookingDate > hotelStats[booking.hotelName].lastBookingDate) {
                    hotelStats[booking.hotelName].lastBookingDate = bookingDate;
                }
            });

            // T√≠nh hoa h·ªìng v√† doanh thu net
            Object.keys(hotelStats).forEach(hotelName => {
                const stats = hotelStats[hotelName];
                stats.commission = Math.round(stats.grossRevenue * 0.15); // 15% hoa h·ªìng
                stats.netRevenue = stats.grossRevenue - stats.commission;
            });

            // S·∫Øp x·∫øp theo doanh thu gi·∫£m d·∫ßn
            const sortedHotels = Object.keys(hotelStats).sort((a, b) => 
                hotelStats[b].grossRevenue - hotelStats[a].grossRevenue
            );

            // T·∫°o HTML cho b·∫£ng kh√°ch s·∫°n
            let tableHTML = '';
            sortedHotels.forEach(hotelName => {
                const stats = hotelStats[hotelName];
                const bookingDate = stats.lastBookingDate ? 
                    stats.lastBookingDate.toLocaleDateString('vi-VN') : 
                    new Date().toLocaleDateString('vi-VN');
                
                tableHTML += `
                    <tr>
                        <td>${bookingDate}</td>
                        <td><i class="fas fa-hotel text-primary me-1"></i>${hotelName}</td>
                        <td>${stats.bookings} bookings</td>
                        <td class="fw-bold">${formatCurrency(stats.grossRevenue)}</td>
                        <td class="text-info">${formatCurrency(stats.commission)}</td>
                        <td class="text-success">${formatCurrency(stats.netRevenue)}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" title="Chi ti·∫øt" onclick="viewBookingDetails('${hotelName}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" title="ƒê·ªëi so√°t" onclick="reconcileHotel('${hotelName}')"><i class="fas fa-balance-scale"></i></button>
                        </td>
                    </tr>
                `;
            });

            // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, hi·ªÉn th·ªã th√¥ng b√°o
            if (sortedHotels.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch∆∞a c√≥ d·ªØ li·ªáu booking kh√°ch s·∫°n n√†o.
                        </td>
                    </tr>
                `;
            }

            tableBody.innerHTML = tableHTML;
        }

        // H√†m c·∫≠p nh·∫≠t b·∫£ng doanh thu Tours
        function updateTourRevenueTable() {
            const tableBody = document.getElementById('tourRevenueTableBody');
            if (!tableBody) return;

            // L·ªçc booking tour ƒë√£ thanh to√°n
            const tourBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.paymentStatus === 'paid' && booking.bookingType === 'tour' && booking.tourName
            );
            
            // T·∫°o d·ªØ li·ªáu theo tour
            const tourStats = {};
            
            tourBookings.forEach(booking => {
                if (!tourStats[booking.tourName]) {
                    tourStats[booking.tourName] = {
                        bookings: 0,
                        grossRevenue: 0,
                        commission: 0,
                        netRevenue: 0,
                        lastBookingDate: null
                    };
                }
                
                tourStats[booking.tourName].bookings++;
                tourStats[booking.tourName].grossRevenue += booking.totalPrice || 0;
                
                // C·∫≠p nh·∫≠t ng√†y booking m·ªõi nh·∫•t
                const bookingDate = new Date(booking.createdAt);
                if (!tourStats[booking.tourName].lastBookingDate || 
                    bookingDate > tourStats[booking.tourName].lastBookingDate) {
                    tourStats[booking.tourName].lastBookingDate = bookingDate;
                }
            });

            // T√≠nh hoa h·ªìng v√† doanh thu net
            Object.keys(tourStats).forEach(tourName => {
                const stats = tourStats[tourName];
                stats.commission = Math.round(stats.grossRevenue * 0.15); // 15% hoa h·ªìng
                stats.netRevenue = stats.grossRevenue - stats.commission;
            });

            // S·∫Øp x·∫øp theo doanh thu gi·∫£m d·∫ßn
            const sortedTours = Object.keys(tourStats).sort((a, b) => 
                tourStats[b].grossRevenue - tourStats[a].grossRevenue
            );

            // T·∫°o HTML cho b·∫£ng tour
            let tableHTML = '';
            sortedTours.forEach(tourName => {
                const stats = tourStats[tourName];
                const bookingDate = stats.lastBookingDate ? 
                    stats.lastBookingDate.toLocaleDateString('vi-VN') : 
                    new Date().toLocaleDateString('vi-VN');
                
                tableHTML += `
                    <tr>
                        <td>${bookingDate}</td>
                        <td><i class="fas fa-map-marked-alt text-warning me-1"></i>${tourName}</td>
                        <td>${stats.bookings} bookings</td>
                        <td class="fw-bold">${formatCurrency(stats.grossRevenue)}</td>
                        <td class="text-info">${formatCurrency(stats.commission)}</td>
                        <td class="text-success">${formatCurrency(stats.netRevenue)}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" title="Chi ti·∫øt" onclick="viewBookingDetails('${tourName}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" title="ƒê·ªëi so√°t" onclick="reconcileHotel('${tourName}')"><i class="fas fa-balance-scale"></i></button>
                        </td>
                    </tr>
                `;
            });

            // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, hi·ªÉn th·ªã th√¥ng b√°o
            if (sortedTours.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch∆∞a c√≥ d·ªØ li·ªáu booking tour n√†o.
                        </td>
                    </tr>
                `;
            }

            tableBody.innerHTML = tableHTML;
        }

        // H√†m xem chi ti·∫øt booking theo kh√°ch s·∫°n ho·∫∑c tour
        function viewBookingDetails(itemName) {
            const itemBookings = Object.values(realtimeData.bookings).filter(
                booking => (booking.hotelName === itemName || booking.tourName === itemName) && booking.paymentStatus === 'paid'
            );

            let detailsHTML = `
                <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi ti·∫øt booking - ${itemName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Booking ID</th>
                                                <th>Kh√°ch h√†ng</th>
                                                <th>Lo·∫°i</th>
                                                <th>S·ªë ti·ªÅn</th>
                                                <th>Ng√†y t·∫°o</th>
                                                <th>Ghi ch√∫</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;

            itemBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt).toLocaleDateString('vi-VN');
                const typeIcon = booking.bookingType === 'hotel' ? 'üè®' : 'üó∫Ô∏è';
                const typeBadge = booking.bookingType === 'hotel' ? 'bg-primary' : 'bg-warning';
                
                detailsHTML += `
                    <tr>
                        <td>${booking.bookingType === 'hotel' ? 'H' : 'T'}-${booking.createdAt.toString().slice(-6)}</td>
                        <td>${booking.customerName}</td>
                        <td>
                            ${typeIcon} <span class="badge ${typeBadge}">${booking.bookingType.toUpperCase()}</span>
                        </td>
                        <td class="text-success">${formatCurrency(booking.totalPrice)}</td>
                        <td>${bookingDate}</td>
                        <td>${booking.note || '-'}</td>
                    </tr>
                `;
            });

            detailsHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('bookingDetailsModal');
            if (oldModal) oldModal.remove();

            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('bookingDetailsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    // Fallback: hi·ªÉn th·ªã th√¥ng tin trong alert
                    alert(`Chi ti·∫øt booking - ${itemName}\nS·ªë booking: ${itemBookings.length}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`Chi ti·∫øt booking - ${itemName}\nS·ªë booking: ${itemBookings.length}`);
            }
        }

        // H√†m ƒë·ªëi so√°t kh√°ch s·∫°n ho·∫∑c tour
        function reconcileHotel(itemName) {
            const itemBookings = Object.values(realtimeData.bookings).filter(
                booking => (booking.hotelName === itemName || booking.tourName === itemName) && booking.paymentStatus === 'paid'
            );
            
            const totalAmount = itemBookings.reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
            const commission = totalAmount * 0.15;
            const itemType = itemBookings[0]?.bookingType === 'hotel' ? 'kh√°ch s·∫°n' : 'tour';
            
            alert(`ƒê·ªëi so√°t ${itemName} (${itemType}):\nT·ªïng doanh thu: ${formatCurrency(totalAmount)}\nHoa h·ªìng (15%): ${formatCurrency(commission)}\nS·ªë booking: ${itemBookings.length}`);
        }

        // H√†m l·∫•y d·ªØ li·ªáu realtime t·ª´ Firebase
        function loadRealtimeData() {
            if (!database) {
                console.log('‚ö†Ô∏è Firebase not available, using sample data');
                loadSampleData();
                return;
            }

            let previousBookingCount = 0;
            let previousPaymentCount = 0;
            let lastUpdateTime = Date.now();

            try {
                console.log('üîÑ Connecting to Firebase for real-time data...');
                
                // L·∫Øng nghe thay ƒë·ªïi bookings v·ªõi real-time updates
                database.ref('bookings').on('value', (snapshot) => {
                    const newBookings = snapshot.val() || {};
                    const currentBookingCount = Object.keys(newBookings).length;
                    const currentTime = Date.now();
                    
                    console.log('üìä Firebase Bookings loaded:', currentBookingCount, 'bookings');
                    
                    // Ki·ªÉm tra n·∫øu c√≥ booking m·ªõi (trong 30 gi√¢y qua)
                    const recentBookings = Object.values(newBookings).filter(booking => 
                        booking.createdAt && (currentTime - booking.createdAt) < 30000
                    );
                    
                    if (recentBookings.length > 0) {
                        console.log('üÜï Recent bookings detected:', recentBookings.length);
                        recentBookings.forEach(booking => {
                            console.log(`üìù New booking: ${booking.customerName} - ${booking.hotelName || booking.tourName} - ${formatCurrency(booking.totalPrice)}`);
                            
                            // Hi·ªÉn th·ªã notification cho booking m·ªõi
                            showNotification(
                                `üÜï Booking m·ªõi: ${booking.customerName} - ${booking.hotelName || booking.tourName} (${formatCurrency(booking.totalPrice)})`,
                                'success'
                            );
                        });
                    }
                    
                    realtimeData.bookings = newBookings;
                    previousBookingCount = currentBookingCount;
                    
                    // Validate v√† s·ª≠a d·ªØ li·ªáu
                    validateAndFixData();
                    
                    // T√≠nh to√°n th·ªëng k√™ v√† c·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                    calculateRevenueStats();
                    updateRevenueUI();
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o c·∫≠p nh·∫≠t
                    const paidBookings = Object.values(newBookings).filter(b => b.paymentStatus === 'paid');
                    const totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
                    
                    console.log('üí∞ Revenue updated:', formatCurrency(totalRevenue));
                    console.log('‚úÖ UI updated automatically');
                    
                }, (error) => {
                    console.error('‚ùå Firebase bookings listener error:', error);
                    showNotification('L·ªói k·∫øt n·ªëi Firebase bookings', 'danger');
                });

                // L·∫Øng nghe thay ƒë·ªïi payments v·ªõi real-time updates
                database.ref('payments').on('value', (snapshot) => {
                    const newPayments = snapshot.val() || {};
                    const currentPaymentCount = Object.keys(newPayments).length;
                    const currentTime = Date.now();
                    
                    console.log('üí∞ Firebase Payments loaded:', currentPaymentCount, 'payments');
                    
                    // Ki·ªÉm tra n·∫øu c√≥ payment m·ªõi (trong 30 gi√¢y qua)
                    const recentPayments = Object.values(newPayments).filter(payment => 
                        payment.date && (currentTime - payment.date) < 30000
                    );
                    
                    if (recentPayments.length > 0) {
                        console.log('üí≥ Recent payments detected:', recentPayments.length);
                        recentPayments.forEach(payment => {
                            console.log(`üí≥ New payment: ${payment.detail} - ${formatCurrency(payment.amount)}`);
                            
                            // Hi·ªÉn th·ªã notification cho payment m·ªõi
                            showNotification(
                                `üí≥ Giao d·ªãch m·ªõi: ${payment.detail} (${formatCurrency(payment.amount)})`,
                                'info'
                            );
                        });
                    }
                    
                    realtimeData.payments = newPayments;
                    previousPaymentCount = currentPaymentCount;
                    
                    // Validate v√† s·ª≠a d·ªØ li·ªáu
                    validateAndFixData();
                    
                    // T√≠nh to√°n th·ªëng k√™ v√† c·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                    calculateRevenueStats();
                    updateRevenueUI();
                    
                    console.log('‚úÖ Payments updated automatically');
                    
                }, (error) => {
                    console.error('‚ùå Firebase payments listener error:', error);
                    showNotification('L·ªói k·∫øt n·ªëi Firebase payments', 'danger');
                });
                
                console.log('‚úÖ Firebase real-time listeners set up successfully');
                showNotification('ƒê√£ k·∫øt n·ªëi Firebase real-time!', 'success');
                
            } catch (error) {
                console.error('‚ùå Firebase connection error:', error);
                showNotification('L·ªói k·∫øt n·ªëi Firebase', 'danger');
                loadSampleData();
            }
        }

        // H√†m debug ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
        function debugData() {
            console.log('üîç Debug Data:');
            console.log('üìä Total bookings:', Object.keys(realtimeData.bookings).length);
            console.log('üí∞ Total payments:', Object.keys(realtimeData.payments).length);
            
            const paidBookings = Object.values(realtimeData.bookings).filter(b => b.paymentStatus === 'paid');
            console.log('‚úÖ Paid bookings:', paidBookings.length);
            
            const hotelBookings = paidBookings.filter(b => b.bookingType === 'hotel');
            const tourBookings = paidBookings.filter(b => b.bookingType === 'tour');
            
            console.log('üè® Hotel bookings:', hotelBookings.length);
            console.log('üó∫Ô∏è Tour bookings:', tourBookings.length);
            
            const totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            console.log('üíµ Total revenue:', formatCurrency(totalRevenue));
            
            // Hi·ªÉn th·ªã th√¥ng b√°o v·ªõi th√¥ng tin debug
            showNotification(
                `Debug: ${paidBookings.length} paid bookings, ${formatCurrency(totalRevenue)} total revenue`,
                'info'
            );
        }

        // H√†m load d·ªØ li·ªáu m·∫´u t·ª´ JSON local
        function loadSampleData() {
            console.log('üîÑ Loading sample data...');
            
            // D·ªØ li·ªáu m·∫´u t·ª´ file JSON
            const sampleBookings = {
                "-OWU-TTLBhqibLKUEeC7": {
                    "bookingType": "hotel",
                    "createdAt": 1753940617668,
                    "customerName": "Ch·ª©c Nguy·ªÖn Ti·∫øn",
                    "hotelName": "Dakruco Hotel",
                    "paymentStatus": "paid",
                    "totalPrice": 1100000
                },
                "-OWU0jOK7V3E0F2SCgmE": {
                    "bookingType": "tour",
                    "createdAt": 1753940949131,
                    "customerName": "Ch·ª©c Nguy·ªÖn Ti·∫øn",
                    "tourName": "Kayak v√† c√¢u c√° t·∫°i V·ªãnh H·∫° Long",
                    "paymentStatus": "paid",
                    "totalPrice": 1200000
                },
                "-OWU14lysqE8zhmu6WlS": {
                    "bookingType": "hotel",
                    "createdAt": 1753941040818,
                    "customerName": "Ch·ª©c Nguy·ªÖn Ti·∫øn",
                    "hotelName": "Combo Ngh·ªâ D∆∞·ª°ng Bi·ªÉn 5*",
                    "paymentStatus": "paid",
                    "totalPrice": 3200000
                },
                "-OWU2vIeIqHyqKyY-zM2": {
                    "bookingType": "hotel",
                    "createdAt": 1753941539233,
                    "customerName": "Ch√≠ Linh Tr·∫ßn",
                    "hotelName": "InterContinental ƒê√† N·∫µng Sun Peninsula Resort",
                    "paymentStatus": "paid",
                    "totalPrice": 3000000
                },
                "-OWUU8uc9KyMP6rpsxi4": {
                    "bookingType": "tour",
                    "createdAt": 1753948676845,
                    "customerName": "Ch√≠ Linh Tr·∫ßn",
                    "tourName": "L√†m ƒë√®n l·ªìng H·ªôi An",
                    "paymentStatus": "paid",
                    "totalPrice": 500000
                },
                "-OWUUSSAIReOAFAYCUPL": {
                    "bookingType": "hotel",
                    "createdAt": 1753948756940,
                    "customerName": "Ch√≠ Linh Tr·∫ßn",
                    "hotelName": "Tr·ªën N√≥ng Sapa M·ªù S∆∞∆°ng",
                    "paymentStatus": "paid",
                    "totalPrice": 2100000
                },
                "-OWU-DEPOSIT-001": {
                    "bookingType": "deposit",
                    "createdAt": 1753949000000,
                    "customerName": "Nguy·ªÖn VƒÉn A",
                    "hotelName": "Luxury Resort Ph√∫ Qu·ªëc",
                    "paymentStatus": "paid",
                    "totalPrice": 500000,
                    "note": "ƒê·∫∑t c·ªçc 50% cho booking th√°ng 12"
                },
                "-OWU-PROMO-001": {
                    "bookingType": "hotel",
                    "createdAt": 1753949100000,
                    "customerName": "Tr·∫ßn Th·ªã B",
                    "hotelName": "Boutique Hotel H·ªôi An",
                    "paymentStatus": "paid",
                    "totalPrice": 800000,
                    "note": "∆Øu ƒë√£i m√πa th·∫•p ƒëi·ªÉm - gi·∫£m 30%"
                },
                "-OWU-DEPOSIT-002": {
                    "bookingType": "deposit",
                    "createdAt": 1753949200000,
                    "customerName": "L√™ VƒÉn C",
                    "tourName": "Tour Sapa 3 ng√†y 2 ƒë√™m",
                    "paymentStatus": "paid",
                    "totalPrice": 300000,
                    "note": "ƒê·∫∑t c·ªçc tour Sapa"
                },
                "-OWU-PROMO-002": {
                    "bookingType": "tour",
                    "createdAt": 1753949300000,
                    "customerName": "Ph·∫°m Th·ªã D",
                    "tourName": "Tour ƒê√† N·∫µng - H·ªôi An",
                    "paymentStatus": "paid",
                    "totalPrice": 600000,
                    "note": "Promotion m√πa h√® - gi·∫£m 25%"
                }
            };

            const samplePayments = {
                "-OWU-ienEP52D-OxjrtB": {
                    "amount": 1100000,
                    "date": 1753940683998,
                    "detail": "Thanh to√°n ƒë·∫∑t ph√≤ng/ƒë·∫∑t tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "ƒê√£ c·ªông ƒëi·ªÉm th√†nh vi√™n: +11 ƒëi·ªÉm",
                    "status": "success",
                    "transactionId": "-OWU-TTLBhqibLKUEeC7"
                },
                "-OWU0zJ_QXWcR-4Ztpvo": {
                    "amount": 1200000,
                    "date": 1753941014353,
                    "detail": "Thanh to√°n ƒë·∫∑t ph√≤ng/ƒë·∫∑t tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "ƒê√£ c·ªông ƒëi·ªÉm th√†nh vi√™n: +12 ƒëi·ªÉm",
                    "status": "success",
                    "transactionId": "-OWU0jOK7V3E0F2SCgmE"
                },
                "-OWU1DB8y21-Kh7tV7oK": {
                    "amount": 3200000,
                    "date": 1753941075255,
                    "detail": "Thanh to√°n ƒë·∫∑t ph√≤ng/ƒë·∫∑t tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "ƒê√£ c·ªông ƒëi·ªÉm th√†nh vi√™n: +32 ƒëi·ªÉm",
                    "status": "success",
                    "transactionId": "-OWU14lysqE8zhmu6WlS"
                },
                "-OWU3MrjRmIWZ3E7ELDB": {
                    "amount": 3000000,
                    "date": 1753941656231,
                    "detail": "Thanh to√°n ƒë·∫∑t ph√≤ng/ƒë·∫∑t tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "ƒê√£ c·ªông ƒëi·ªÉm th√†nh vi√™n: +30 ƒëi·ªÉm",
                    "status": "success",
                    "transactionId": "-OWU2vIeIqHyqKyY-zM2"
                },
                "-OWUUImzReIpbzQeDIbN": {
                    "amount": 500000,
                    "date": 1753948717330,
                    "detail": "Thanh to√°n ƒë·∫∑t ph√≤ng/ƒë·∫∑t tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "ƒê√£ c·ªông ƒëi·ªÉm th√†nh vi√™n: +5 ƒëi·ªÉm",
                    "status": "success",
                    "transactionId": "-OWUU8uc9KyMP6rpsxi4"
                },
                "-OWUUcbi33FQHsLy6_ZM": {
                    "amount": 2100000,
                    "date": 1753948802681,
                    "detail": "Thanh to√°n ƒë·∫∑t ph√≤ng/ƒë·∫∑t tour qua VNPAY",
                    "method": "VNPAY",
                    "note": "ƒê√£ c·ªông ƒëi·ªÉm th√†nh vi√™n: +21 ƒëi·ªÉm",
                    "status": "success",
                    "transactionId": "-OWUUSSAIReOAFAYCUPL"
                }
            };

            // C·∫≠p nh·∫≠t d·ªØ li·ªáu realtime
            realtimeData.bookings = sampleBookings;
            realtimeData.payments = samplePayments;
            
            // T√≠nh to√°n l·∫°i th·ªëng k√™
            calculateRevenueStats();
            
            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
            updateRevenueUI();
            
            showNotification('ƒê√£ load d·ªØ li·ªáu m·∫´u t·ª´ JSON local', 'success');
            console.log('üìä Sample data loaded:', Object.keys(sampleBookings).length, 'bookings');
            
            // Hi·ªÉn th·ªã d·ªØ li·ªáu trong console ƒë·ªÉ debug
            console.log('ÔøΩÔøΩ Sample bookings:', sampleBookings);
            console.log('üí∞ Sample payments:', samplePayments);
            
            // Th√¥ng b√°o chi ti·∫øt v·ªÅ d·ªØ li·ªáu ƒë√£ load
            const totalRevenue = Object.values(sampleBookings).reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
            const hotelCount = Object.values(sampleBookings).filter(b => b.bookingType === 'hotel').length;
            const tourCount = Object.values(sampleBookings).filter(b => b.bookingType === 'tour').length;
            
            console.log('üìà Data Summary:');
            console.log('  - Total Revenue:', formatCurrency(totalRevenue));
            console.log('  - Hotel Bookings:', hotelCount);
            console.log('  - Tour Bookings:', tourCount);
            console.log('  - Total Payments:', Object.keys(samplePayments).length);
            
            // Hi·ªÉn th·ªã th√¥ng b√°o chi ti·∫øt
            alert(`D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c load th√†nh c√¥ng!\n\nüìä T·ªïng doanh thu: ${formatCurrency(totalRevenue)}\nüè® Booking kh√°ch s·∫°n: ${hotelCount}\nüó∫Ô∏è Booking tour: ${tourCount}\nüí∞ Giao d·ªãch VNPay: ${Object.keys(samplePayments).length}`);
        }

        // H√†m t·∫°o b√°o c√°o VNPay
        function generateVNPayReport() {
            const vnpayPayments = Object.values(realtimeData.payments).filter(
                payment => payment.method === 'VNPAY' && payment.status === 'success'
            );

            let reportHTML = `
                <div class="modal fade" id="vnpayReportModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">B√°o c√°o giao d·ªãch VNPay</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${vnpayPayments.length}</div>
                                            <div class="stat-label">T·ªïng giao d·ªãch</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-info">${formatCurrency(vnpayPayments.reduce((sum, p) => sum + p.amount, 0))}</div>
                                            <div class="stat-label">T·ªïng ti·ªÅn</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">${vnpayPayments.filter(p => p.detail.includes('ƒë·∫∑t c·ªçc')).length}</div>
                                            <div class="stat-label">Giao d·ªãch c·ªçc</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${vnpayPayments.filter(p => p.detail.includes('ƒë·∫∑t ph√≤ng')).length}</div>
                                            <div class="stat-label">Giao d·ªãch ph√≤ng</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Transaction ID</th>
                                                <th>Chi ti·∫øt</th>
                                                <th>S·ªë ti·ªÅn</th>
                                                <th>Ng√†y</th>
                                                <th>Ghi ch√∫</th>
                                                <th>Tr·∫°ng th√°i</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;

            vnpayPayments.forEach(payment => {
                const paymentDate = new Date(payment.date).toLocaleDateString('vi-VN');
                reportHTML += `
                    <tr>
                        <td>${payment.transactionId}</td>
                        <td>${payment.detail}</td>
                        <td class="text-success">${formatCurrency(payment.amount)}</td>
                        <td>${paymentDate}</td>
                        <td>${payment.note}</td>
                        <td><span class="badge bg-success">${payment.status}</span></td>
                    </tr>
                `;
            });

            reportHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('vnpayReportModal');
            if (oldModal) oldModal.remove();

            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', reportHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('vnpayReportModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    // Fallback: hi·ªÉn th·ªã th√¥ng tin trong alert
                    alert(`B√°o c√°o VNPay\nT·ªïng giao d·ªãch: ${vnpayPayments.length}\nT·ªïng ti·ªÅn: ${formatCurrency(vnpayPayments.reduce((sum, p) => sum + p.amount, 0))}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`B√°o c√°o VNPay\nT·ªïng giao d·ªãch: ${vnpayPayments.length}\nT·ªïng ti·ªÅn: ${formatCurrency(vnpayPayments.reduce((sum, p) => sum + p.amount, 0))}`);
            }
        }

        // Th√™m n√∫t b√°o c√°o VNPay v√†o section Reports
        function addVNPayReportButton() {
            const reportsSection = document.getElementById('reportsSection');
            const buttonContainer = reportsSection.querySelector('.d-flex.justify-content-between');
            
            if (buttonContainer) {
                const vnpayButton = document.createElement('button');
                vnpayButton.className = 'btn btn-warning btn-sm me-2';
                vnpayButton.innerHTML = '<i class="fas fa-credit-card"></i> B√°o c√°o VNPay';
                vnpayButton.onclick = generateVNPayReport;
                
                const timelineButton = document.createElement('button');
                timelineButton.className = 'btn btn-info btn-sm me-2';
                timelineButton.innerHTML = '<i class="fas fa-history"></i> Timeline';
                timelineButton.onclick = showTimelineReport;
                
                buttonContainer.querySelector('div').insertBefore(timelineButton, buttonContainer.querySelector('div').firstChild);
                buttonContainer.querySelector('div').insertBefore(vnpayButton, buttonContainer.querySelector('div').firstChild);
            }
        }

        // H√†m hi·ªÉn th·ªã timeline b√°o c√°o
        function showTimelineReport() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            // L·ªçc d·ªØ li·ªáu theo th√°ng hi·ªán t·∫°i
            const currentMonthBookings = Object.values(realtimeData.bookings).filter(booking => {
                const bookingDate = new Date(booking.createdAt);
                return bookingDate.getMonth() === currentMonth && 
                       bookingDate.getFullYear() === currentYear &&
                       booking.paymentStatus === 'paid';
            });

            const currentMonthPayments = Object.values(realtimeData.payments).filter(payment => {
                const paymentDate = new Date(payment.date);
                return paymentDate.getMonth() === currentMonth && 
                       paymentDate.getFullYear() === currentYear &&
                       payment.status === 'success';
            });

            // S·∫Øp x·∫øp theo th·ªùi gian
            const timelineData = [
                ...currentMonthBookings.map(booking => ({
                    type: 'booking',
                    data: booking,
                    timestamp: booking.createdAt
                })),
                ...currentMonthPayments.map(payment => ({
                    type: 'payment',
                    data: payment,
                    timestamp: payment.date
                }))
            ].sort((a, b) => b.timestamp - a.timestamp);

            let timelineHTML = `
                <div class="modal fade" id="timelineModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Timeline th√°ng ${currentMonth + 1}/${currentYear}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${currentMonthBookings.length}</div>
                                            <div class="stat-label">Booking th√°ng n√†y</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${currentMonthPayments.length}</div>
                                            <div class="stat-label">Giao d·ªãch th√†nh c√¥ng</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-info">${formatCurrency(currentMonthBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0))}</div>
                                            <div class="stat-label">T·ªïng doanh thu</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">${currentMonthPayments.filter(p => p.method === 'VNPAY').length}</div>
                                            <div class="stat-label">Giao d·ªãch VNPay</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="timeline-container" style="max-height: 500px; overflow-y: auto;">
            `;

            timelineData.forEach(item => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
                
                if (item.type === 'booking') {
                    const booking = item.data;
                    timelineHTML += `
                        <div class="timeline-item mb-3 p-3 border-start border-3 border-primary" style="margin-left: 20px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fas fa-${booking.bookingType === 'hotel' ? 'hotel' : 'map-marked-alt'} text-primary"></i>
                                        Booking ${booking.bookingType === 'hotel' ? 'Kh√°ch s·∫°n' : 'Tour'}
                                    </h6>
                                    <p class="mb-1"><strong>${booking.customerName}</strong> - ${booking.hotelName || booking.tourName}</p>
                                    <p class="mb-1 text-success"><strong>${formatCurrency(booking.totalPrice)}</strong></p>
                                    <small class="text-muted">${formattedDate}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">${booking.paymentStatus}</span>
                                    <br>
                                    <small class="text-muted">${booking.paymentMethod?.toUpperCase()}</small>
                                </div>
                            </div>
                            ${booking.note ? `<div class="mt-2"><small class="text-muted"><i class="fas fa-sticky-note"></i> ${booking.note}</small></div>` : ''}
                        </div>
                    `;
                } else {
                    const payment = item.data;
                    timelineHTML += `
                        <div class="timeline-item mb-3 p-3 border-start border-3 border-success" style="margin-left: 20px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fas fa-credit-card text-success"></i>
                                        Giao d·ªãch ${payment.method}
                                    </h6>
                                    <p class="mb-1"><strong>${payment.detail}</strong></p>
                                    <p class="mb-1 text-success"><strong>${formatCurrency(payment.amount)}</strong></p>
                                    <small class="text-muted">${formattedDate}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">${payment.status}</span>
                                    <br>
                                    <small class="text-muted">Transaction ID: ${payment.transactionId}</small>
                                </div>
                            </div>
                            ${payment.note ? `<div class="mt-2"><small class="text-muted"><i class="fas fa-info-circle"></i> ${payment.note}</small></div>` : ''}
                        </div>
                    `;
                }
            });

            timelineHTML += `
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('timelineModal');
            if (oldModal) oldModal.remove();

            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', timelineHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('timelineModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    // Fallback: hi·ªÉn th·ªã th√¥ng tin trong alert
                    alert(`Timeline th√°ng ${currentMonth + 1}/${currentYear}\nBooking: ${currentMonthBookings.length}\nGiao d·ªãch: ${currentMonthPayments.length}\nDoanh thu: ${formatCurrency(currentMonthBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0))}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`Timeline th√°ng ${currentMonth + 1}/${currentYear}\nBooking: ${currentMonthBookings.length}\nGiao d·ªãch: ${currentMonthPayments.length}\nDoanh thu: ${formatCurrency(currentMonthBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0))}`);
            }
        }

        // ƒê·ªãnh nghƒ©a c√°c h√†m global
        function processCommissions() {
            if (confirm('X·ª≠ l√Ω thanh to√°n hoa h·ªìng cho t·∫•t c·∫£ kh√°ch s·∫°n ƒëang ch·ªù?')) {
                alert('ƒêang x·ª≠ l√Ω thanh to√°n hoa h·ªìng...\nTh·ªùi gian ∆∞·ªõc t√≠nh: 5-10 ph√∫t');
            }
        }

        function exportRevenue() {
            const stats = realtimeData.revenueStats;
            const monthly = realtimeData.monthlyStats;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "B√°o c√°o doanh thu\n";
            csvContent += `T·ªïng doanh thu,${formatCurrency(stats.totalRevenue)}\n`;
            csvContent += `Doanh thu th√°ng hi·ªán t·∫°i,${formatCurrency(monthly.currentMonth)}\n`;
            csvContent += `S·ªë booking kh√°ch s·∫°n,${stats.hotelBookings}\n`;
            csvContent += `S·ªë booking tour,${stats.tourBookings}\n`;
            csvContent += `S·ªë giao d·ªãch VNPay,${stats.vnpayPayments}\n`;
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "bao_cao_doanh_thu.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function refreshRevenue() {
            if (database) {
                console.log('üîÑ Refreshing revenue data from Firebase...');
                refreshFirebaseData();
            } else {
                alert('ƒêang l√†m m·ªõi d·ªØ li·ªáu doanh thu t·ª´ h·ªá th·ªëng...');
                setTimeout(() => {
                    alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!');
                }, 2000);
            }
        }

        function filterRevenue() {
            const hotel = document.getElementById('revenueHotel').value;
            const fromDate = document.getElementById('revenueFromDate').value;
            const toDate = document.getElementById('revenueToDate').value;
            alert(`L·ªçc d·ªØ li·ªáu:\nKh√°ch s·∫°n: ${hotel || 'T·∫•t c·∫£'}\nT·ª´: ${fromDate}\nƒê·∫øn: ${toDate}`);
        }

        function processAllCommissions() {
            const commissionAmount = realtimeData.revenueStats.totalRevenue * 0.15;
            if (confirm(`Thanh to√°n hoa h·ªìng cho t·∫•t c·∫£ kh√°ch s·∫°n ƒëang ch·ªù (${formatCurrency(commissionAmount)})?`)) {
                alert('ƒêang x·ª≠ l√Ω thanh to√°n...\nTh√¥ng b√°o s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn c√°c kh√°ch s·∫°n');
            }
        }

        function commissionSettings() {
            alert('M·ªü modal c√†i ƒë·∫∑t t·ª∑ l·ªá hoa h·ªìng cho t·ª´ng kh√°ch s·∫°n');
        }

        function payCommission(hotelId) {
            const hotelNames = {
                'luxury-hn': 'Luxury Hotel HN',
                'beach-dn': 'Beach Resort DN'
            };
            if (confirm(`Thanh to√°n hoa h·ªìng cho ${hotelNames[hotelId]}?`)) {
                alert(`ƒêang x·ª≠ l√Ω thanh to√°n cho ${hotelNames[hotelId]}...`);
            }
        }

        function startReconciliation() {
            alert('B·∫Øt ƒë·∫ßu quy tr√¨nh ƒë·ªëi so√°t th·ªß c√¥ng\nVui l√≤ng ch·ªçn k·ª≥ ƒë·ªëi so√°t v√† kh√°ch s·∫°n');
        }

        function autoReconcile() {
            if (confirm('Ch·∫°y t·ª± ƒë·ªông ƒë·ªëi so√°t cho t·∫•t c·∫£ kh√°ch s·∫°n?')) {
                alert('ƒêang ch·∫°y t·ª± ƒë·ªông ƒë·ªëi so√°t...\nK·∫øt qu·∫£ s·∫Ω c√≥ trong 15-30 ph√∫t');
            }
        }

        function uploadReconcileFile() {
            const fileInput = document.getElementById('reconcileFile');
            if (fileInput.files.length === 0) {
                alert('Vui l√≤ng ch·ªçn file ƒë·ªÉ upload');
                return;
            }
            alert(`ƒêang upload file: ${fileInput.files[0].name}\nH·ªá th·ªëng s·∫Ω x·ª≠ l√Ω v√† ƒë·ªëi so√°t t·ª± ƒë·ªông`);
        }

        function downloadTemplate() {
            alert('T·∫£i template Excel cho kh√°ch s·∫°n\nFile ch·ª©a c√°c c·ªôt: Booking ID, Date, Amount, Status');
        }

        function investigateDiscrepancy(bookingId) {
            alert(`ƒêi·ªÅu tra ch√™nh l·ªách cho booking ${bookingId}\nM·ªü chi ti·∫øt giao d·ªãch v√† l·ªãch s·ª≠ thay ƒë·ªïi`);
        }

        function markDispute(bookingId) {
            if (confirm(`ƒê√°nh d·∫•u dispute cho booking ${bookingId}?`)) {
                alert('ƒê√£ t·∫°o ticket dispute v√† g·ª≠i th√¥ng b√°o ƒë·∫øn kh√°ch s·∫°n');
            }
        }

        function requestData(bookingId) {
            alert(`G·ª≠i y√™u c·∫ßu d·ªØ li·ªáu cho booking ${bookingId}\nEmail s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn kh√°ch s·∫°n`);
        }

        function generateFinanceReport() {
            alert('M·ªü form t·∫°o b√°o c√°o t√†i ch√≠nh t√πy ch·ªânh\nCh·ªçn lo·∫°i b√°o c√°o, k·ª≥ b√°o c√°o v√† ƒë·ªãnh d·∫°ng');
        }

        function scheduleReport() {
            alert('C√†i ƒë·∫∑t l√™n l·ªãch b√°o c√°o t·ª± ƒë·ªông\nCh·ªçn t·∫ßn su·∫•t: h√†ng ng√†y, tu·∫ßn, th√°ng');
        }

        function generateReport(type) {
            const types = {
                'revenue': 'B√°o c√°o doanh thu',
                'commission': 'B√°o c√°o hoa h·ªìng', 
                'reconciliation': 'B√°o c√°o ƒë·ªëi so√°t'
            };
            alert(`T·∫°o ${types[type]} cho k·ª≥ hi·ªán t·∫°i\nB√°o c√°o s·∫Ω ƒë∆∞·ª£c t·∫°o trong 5-10 ph√∫t`);
        }

        function cancelReport(reportId) {
            if (confirm('H·ªßy b√°o c√°o ƒëang x·ª≠ l√Ω?')) {
                alert(`ƒê√£ h·ªßy b√°o c√°o ${reportId}`);
            }
        }

        // H√†m refresh d·ªØ li·ªáu t·ª´ Firebase
        function refreshFirebaseData() {
            if (!database) {
                alert('Firebase kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
                return;
            }

            console.log('üîÑ Refreshing data from Firebase...');
            
            // L·∫•y d·ªØ li·ªáu bookings m·ªõi nh·∫•t
            database.ref('bookings').once('value').then((snapshot) => {
                const newBookings = snapshot.val() || {};
                realtimeData.bookings = newBookings;
                console.log('üìä Fresh bookings loaded:', Object.keys(newBookings).length);
                
                // L·∫•y d·ªØ li·ªáu payments m·ªõi nh·∫•t
                return database.ref('payments').once('value');
            }).then((snapshot) => {
                const newPayments = snapshot.val() || {};
                realtimeData.payments = newPayments;
                console.log('üí∞ Fresh payments loaded:', Object.keys(newPayments).length);
                
                // T√≠nh to√°n l·∫°i th·ªëng k√™
                calculateRevenueStats();
                
                // C·∫≠p nh·∫≠t UI
                updateRevenueUI();
                
                showNotification('ƒê√£ refresh d·ªØ li·ªáu t·ª´ Firebase th√†nh c√¥ng!', 'success');
                
                // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt
                const totalBookings = Object.keys(realtimeData.bookings).length;
                const totalPayments = Object.keys(realtimeData.payments).length;
                const paidBookings = Object.values(realtimeData.bookings).filter(b => b.paymentStatus === 'paid');
                const totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
                
                alert(`D·ªØ li·ªáu Firebase ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!\n\nüìä T·ªïng booking: ${totalBookings}\n‚úÖ ƒê√£ thanh to√°n: ${paidBookings.length}\nüí∞ T·ªïng doanh thu: ${formatCurrency(totalRevenue)}\nüí≥ Giao d·ªãch: ${totalPayments}`);
                
            }).catch((error) => {
                console.error('‚ùå Error refreshing Firebase data:', error);
                alert('L·ªói khi refresh d·ªØ li·ªáu t·ª´ Firebase. Vui l√≤ng th·ª≠ l·∫°i.');
            });
        }

        // C√°c h√†m ch·ª©c nƒÉng Dashboard
        window.processCommissions = processCommissions;

        // G√°n c√°c h√†m v√†o window object
        window.exportRevenue = exportRevenue;
        window.refreshRevenue = refreshRevenue;
        window.filterRevenue = filterRevenue;
        window.processAllCommissions = processAllCommissions;
        window.commissionSettings = commissionSettings;
        window.payCommission = payCommission;
        window.startReconciliation = startReconciliation;
        window.autoReconcile = autoReconcile;
        window.uploadReconcileFile = uploadReconcileFile;
        window.downloadTemplate = downloadTemplate;
        window.investigateDiscrepancy = investigateDiscrepancy;
        window.markDispute = markDispute;
        window.requestData = requestData;
        window.generateFinanceReport = generateFinanceReport;
        window.scheduleReport = scheduleReport;
        window.generateReport = generateReport;
        window.cancelReport = cancelReport;
        window.testDataConnection = testDataConnection;
        window.checkFirebaseConnection = checkFirebaseConnection;
        window.retryFirebaseConnection = retryFirebaseConnection;
        window.toggleAutoRefresh = toggleAutoRefresh;
        window.logout = logout;
        window.showHotelTourStats = showHotelTourStats;
        window.updateRevenueSummary = updateRevenueSummary;
        window.updateCommissionTable = updateCommissionTable;
        window.viewCommissionDetails = viewCommissionDetails;
        window.refreshCommissionData = refreshCommissionData;

        // Simulate real-time updates
        function updateFinanceStats() {
            // Animate numbers slightly
            const stats = document.querySelectorAll('.stat-number');
            stats.forEach(stat => {
                stat.style.transition = 'color 0.3s ease';
                stat.style.color = '#00eaff';
                setTimeout(() => {
                    stat.style.color = '';
                }, 500);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Finance Manager initialized');
            
            // Show role section by default
            showSection('role');
            
            // Load realtime data from Firebase
            loadRealtimeData();
            
            // Add VNPay report button
            addVNPayReportButton();
            
            // Start auto-refresh system
            startAutoRefresh();
            
            // Start real-time monitoring
            monitorRealTimeChanges();
            
            // Update stats every 30 seconds
            setInterval(updateFinanceStats, 30000);
            
            // Ensure all functions are available globally
            window.showSection = showSection;
            window.loadRealtimeData = loadRealtimeData;
            window.debugData = debugData;
            window.loadSampleData = loadSampleData;
            window.refreshFirebaseData = refreshFirebaseData;
            window.generateVNPayReport = generateVNPayReport;
            window.showTimelineReport = showTimelineReport;
            window.viewBookingDetails = viewBookingDetails;
            window.reconcileHotel = reconcileHotel;
            window.processCommissions = processCommissions;
            window.exportRevenue = exportRevenue;
            window.refreshRevenue = refreshRevenue;
            window.filterRevenue = filterRevenue;
            window.processAllCommissions = processAllCommissions;
            window.commissionSettings = commissionSettings;
            window.payCommission = payCommission;
            window.startReconciliation = startReconciliation;
            window.autoReconcile = autoReconcile;
            window.uploadReconcileFile = uploadReconcileFile;
            window.downloadTemplate = downloadTemplate;
            window.investigateDiscrepancy = investigateDiscrepancy;
            window.markDispute = markDispute;
            window.requestData = requestData;
            window.generateFinanceReport = generateFinanceReport;
            window.scheduleReport = scheduleReport;
            window.generateReport = generateReport;
            window.cancelReport = cancelReport;
            window.testDataConnection = testDataConnection;
            window.checkFirebaseConnection = checkFirebaseConnection;
            window.retryFirebaseConnection = retryFirebaseConnection;
            window.toggleAutoRefresh = toggleAutoRefresh;
            window.logout = logout;
            window.showHotelTourStats = showHotelTourStats;
            window.updateRevenueSummary = updateRevenueSummary;
            window.updateCommissionTable = updateCommissionTable;
            window.viewCommissionDetails = viewCommissionDetails;
            window.refreshCommissionData = refreshCommissionData;
            window.loadAffiliatePartners = loadAffiliatePartners;
            window.viewPartnerDetails = viewPartnerDetails;
            window.editPartnerCommission = editPartnerCommission;
            window.saveCommissionSettings = saveCommissionSettings;
            window.savePaymentSettings = savePaymentSettings;
            window.saveNotificationSettings = saveNotificationSettings;
            window.updateAllAffiliateCommissions = updateAllAffiliateCommissions;
            window.loadSettingsFromFirebase = loadSettingsFromFirebase;
            window.loadSettingsFromLocal = loadSettingsFromLocal;
            window.updateDashboard = updateDashboard;
            window.updateDashboardStats = updateDashboardStats;
            window.updateTopHotels = updateTopHotels;
            window.updateTopPartners = updateTopPartners;
            window.updateRecentTransactions = updateRecentTransactions;
            window.updateRecentActivities = updateRecentActivities;
            window.generateReconciliationData = generateReconciliationData;
            window.updateReconciliationTable = updateReconciliationTable;
            window.reconcileItem = reconcileItem;
            window.viewReconciliationDetails = viewReconciliationDetails;
            window.loadAffiliatePartners = loadAffiliatePartners;
            window.viewPartnerDetails = viewPartnerDetails;
            window.editPartnerCommission = editPartnerCommission;
            window.saveCommissionSettings = saveCommissionSettings;
            window.savePaymentSettings = savePaymentSettings;
            window.saveNotificationSettings = saveNotificationSettings;
            
            console.log('‚úÖ All functions registered globally');
            
            // Auto-load sample data immediately if Firebase not available
            if (!database) {
                console.log('üîÑ Firebase not available, loading sample data immediately...');
                loadSampleData();
            } else {
                // Auto-load sample data if no data available after 2 seconds
                setTimeout(() => {
                    if (Object.keys(realtimeData.bookings).length === 0) {
                        console.log('üîÑ Auto-loading sample data...');
                        loadSampleData();
                    }
                }, 2000);
            }
            
            // Force update UI after 1 second
            setTimeout(() => {
                console.log('üîÑ Force updating UI...');
                updateRevenueUI();
            }, 1000);
            
            // Show connection status
            setTimeout(() => {
                if (database) {
                    showNotification('‚úÖ ƒê√£ k·∫øt n·ªëi Firebase real-time!', 'success');
                } else {
                    showNotification('‚ö†Ô∏è S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u - Auto-refresh m·ªói 30s', 'warning');
                }
            }, 2000);
        });

        // Notification system
        function showNotification(message, type = 'info') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Auto-refresh dashboard data every 5 minutes
        setInterval(() => {
            if (document.getElementById('dashboardSection').classList.contains('active')) {
                showNotification('D·ªØ li·ªáu dashboard ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
            }
        }, 300000);

        // ƒêƒÉng xu·∫•t v·ªõi Firebase Auth
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                // Ki·ªÉm tra xem Firebase Auth c√≥ s·∫µn kh√¥ng
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().signOut().then(() => {
                        console.log('ƒêƒÉng xu·∫•t th√†nh c√¥ng');
                        window.location.href = '../auth.html';
                    }).catch((error) => {
                        console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
                        // V·∫´n chuy·ªÉn trang n·∫øu c√≥ l·ªói
                        window.location.href = '../auth.html';
                    });
                } else {
                    // Fallback n·∫øu Firebase kh√¥ng c√≥
                    window.location.href = '../auth.html';
                }
            }
        }

        // H√†m ki·ªÉm tra v√† s·ª≠a d·ªØ li·ªáu t·ª´ Firebase
        function validateAndFixData() {
            console.log('üîç Validating and fixing data...');
            
            // Ki·ªÉm tra bookings
            Object.keys(realtimeData.bookings).forEach(bookingId => {
                const booking = realtimeData.bookings[bookingId];
                
                // ƒê·∫£m b·∫£o c√≥ c√°c tr∆∞·ªùng c·∫ßn thi·∫øt
                if (!booking.bookingType) {
                    booking.bookingType = 'hotel'; // M·∫∑c ƒë·ªãnh l√† hotel
                }
                if (!booking.paymentStatus) {
                    booking.paymentStatus = 'paid'; // M·∫∑c ƒë·ªãnh l√† ƒë√£ thanh to√°n
                }
                if (!booking.totalPrice) {
                    booking.totalPrice = 0;
                }
                if (!booking.createdAt) {
                    booking.createdAt = Date.now();
                }
                
                console.log(`‚úÖ Booking ${bookingId}: ${booking.customerName} - ${formatCurrency(booking.totalPrice)}`);
            });
            
            // Ki·ªÉm tra payments
            Object.keys(realtimeData.payments).forEach(paymentId => {
                const payment = realtimeData.payments[paymentId];
                
                // ƒê·∫£m b·∫£o c√≥ c√°c tr∆∞·ªùng c·∫ßn thi·∫øt
                if (!payment.method) {
                    payment.method = 'VNPAY';
                }
                if (!payment.status) {
                    payment.status = 'success';
                }
                if (!payment.amount) {
                    payment.amount = 0;
                }
                if (!payment.date) {
                    payment.date = Date.now();
                }
                
                console.log(`‚úÖ Payment ${paymentId}: ${payment.detail} - ${formatCurrency(payment.amount)}`);
            });
            
            console.log('‚úÖ Data validation completed');
        }

        // H√†m debug ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
        function debugData() {
            console.log('üîç Debug Data:');
            console.log('üìä Total bookings:', Object.keys(realtimeData.bookings).length);
            console.log('üí∞ Total payments:', Object.keys(realtimeData.payments).length);
            
            const paidBookings = Object.values(realtimeData.bookings).filter(b => b.paymentStatus === 'paid');
            console.log('‚úÖ Paid bookings:', paidBookings.length);
            
            const hotelBookings = paidBookings.filter(b => b.bookingType === 'hotel');
            const tourBookings = paidBookings.filter(b => b.bookingType === 'tour');
            
            console.log('üè® Hotel bookings:', hotelBookings.length);
            console.log('üó∫Ô∏è Tour bookings:', tourBookings.length);
            
            const totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            console.log('üíµ Total revenue:', formatCurrency(totalRevenue));
            
            // Hi·ªÉn th·ªã th√¥ng b√°o v·ªõi th√¥ng tin debug
            showNotification(
                `Debug: ${paidBookings.length} paid bookings, ${formatCurrency(totalRevenue)} total revenue`,
                'info'
            );
        }

        // H√†m test k·∫øt n·ªëi d·ªØ li·ªáu
        function testDataConnection() {
            console.log('üß™ Testing data connection...');
            
            let testResults = {
                firebase: database ? '‚úÖ Connected' : '‚ùå Not available',
                bookings: Object.keys(realtimeData.bookings).length,
                payments: Object.keys(realtimeData.payments).length,
                paidBookings: 0,
                totalRevenue: 0,
                hotelBookings: 0,
                tourBookings: 0,
                vnpayPayments: 0
            };
            
            // T√≠nh to√°n th·ªëng k√™
            const paidBookings = Object.values(realtimeData.bookings).filter(b => b.paymentStatus === 'paid');
            testResults.paidBookings = paidBookings.length;
            testResults.totalRevenue = paidBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            testResults.hotelBookings = paidBookings.filter(b => b.bookingType === 'hotel').length;
            testResults.tourBookings = paidBookings.filter(b => b.bookingType === 'tour').length;
            testResults.vnpayPayments = Object.values(realtimeData.payments).filter(p => p.method === 'VNPAY' && p.status === 'success').length;
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const resultHTML = `
                <div class="modal fade" id="testDataModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">K·∫øt qu·∫£ ki·ªÉm tra d·ªØ li·ªáu</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>K·∫øt n·ªëi Firebase:</h6>
                                        <p class="text-${testResults.firebase.includes('‚úÖ') ? 'success' : 'danger'}">${testResults.firebase}</p>
                                        
                                        <h6>Th·ªëng k√™ d·ªØ li·ªáu:</h6>
                                        <ul>
                                            <li>T·ªïng booking: ${testResults.bookings}</li>
                                            <li>Booking ƒë√£ thanh to√°n: ${testResults.paidBookings}</li>
                                            <li>Booking kh√°ch s·∫°n: ${testResults.hotelBookings}</li>
                                            <li>Booking tour: ${testResults.tourBookings}</li>
                                            <li>T·ªïng giao d·ªãch: ${testResults.payments}</li>
                                            <li>Giao d·ªãch VNPay: ${testResults.vnpayPayments}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Doanh thu:</h6>
                                        <p class="fw-bold text-success">${formatCurrency(testResults.totalRevenue)}</p>
                                        
                                        <h6>Chi ti·∫øt booking:</h6>
                                        <div style="max-height: 200px; overflow-y: auto;">
            `;
            
            // Hi·ªÉn th·ªã chi ti·∫øt booking
            paidBookings.forEach((booking, index) => {
                if (index < 5) { // Ch·ªâ hi·ªÉn th·ªã 5 booking ƒë·∫ßu
                    resultHTML += `
                        <div class="small mb-1">
                            <strong>${booking.customerName}</strong> - 
                            ${booking.hotelName || booking.tourName} - 
                            <span class="text-success">${formatCurrency(booking.totalPrice)}</span>
                        </div>
                    `;
                }
            });
            
            if (paidBookings.length > 5) {
                resultHTML += `<div class="small text-muted">... v√† ${paidBookings.length - 5} booking kh√°c</div>`;
            }
            
            resultHTML += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('testDataModal');
            if (oldModal) oldModal.remove();
            
            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', resultHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('testDataModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    // Fallback: hi·ªÉn th·ªã th√¥ng tin trong alert
                    alert(`Test Data Results:\nFirebase: ${testResults.firebase}\nBookings: ${testResults.bookings}\nRevenue: ${formatCurrency(testResults.totalRevenue)}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`Test Data Results:\nFirebase: ${testResults.firebase}\nBookings: ${testResults.bookings}\nRevenue: ${formatCurrency(testResults.totalRevenue)}`);
            }
        }

        // H√†m ki·ªÉm tra k·∫øt n·ªëi Firebase
        function checkFirebaseConnection() {
            console.log('üîç Checking Firebase connection...');
            
            let connectionStatus = {
                sdkLoaded: typeof firebase !== 'undefined',
                appAvailable: typeof firebase !== 'undefined' && firebase.app,
                databaseAvailable: typeof firebase !== 'undefined' && firebase.database,
                databaseInitialized: database !== null,
                configValid: false,
                connectionTest: false
            };
            
            // Ki·ªÉm tra config
            if (firebaseConfig && firebaseConfig.databaseURL) {
                connectionStatus.configValid = true;
            }
            
            // Test connection n·∫øu database ƒë√£ kh·ªüi t·∫°o
            if (database) {
                try {
                    database.ref('.info/connected').once('value').then((snapshot) => {
                        connectionStatus.connectionTest = snapshot.val() === true;
                        console.log('üåê Connection test result:', connectionStatus.connectionTest);
                    }).catch((error) => {
                        console.error('‚ùå Connection test failed:', error);
                        connectionStatus.connectionTest = false;
                    });
                } catch (error) {
                    console.error('‚ùå Connection test error:', error);
                    connectionStatus.connectionTest = false;
                }
            }
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const statusHTML = `
                <div class="modal fade" id="firebaseStatusModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Firebase Connection Status</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>SDK Status:</h6>
                                        <ul>
                                            <li>Firebase SDK: <span class="text-${connectionStatus.sdkLoaded ? 'success' : 'danger'}">${connectionStatus.sdkLoaded ? '‚úÖ Loaded' : '‚ùå Not loaded'}</span></li>
                                            <li>Firebase App: <span class="text-${connectionStatus.appAvailable ? 'success' : 'danger'}">${connectionStatus.appAvailable ? '‚úÖ Available' : '‚ùå Not available'}</span></li>
                                            <li>Firebase Database: <span class="text-${connectionStatus.databaseAvailable ? 'success' : 'danger'}">${connectionStatus.databaseAvailable ? '‚úÖ Available' : '‚ùå Not available'}</span></li>
                                            <li>Database Initialized: <span class="text-${connectionStatus.databaseInitialized ? 'success' : 'danger'}">${connectionStatus.databaseInitialized ? '‚úÖ Yes' : '‚ùå No'}</span></li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Configuration:</h6>
                                        <ul>
                                            <li>Config Valid: <span class="text-${connectionStatus.configValid ? 'success' : 'danger'}">${connectionStatus.configValid ? '‚úÖ Yes' : '‚ùå No'}</span></li>
                                            <li>Database URL: <code>${firebaseConfig.databaseURL || 'Not set'}</code></li>
                                            <li>Project ID: <code>${firebaseConfig.projectId || 'Not set'}</code></li>
                                            <li>Connection Test: <span class="text-${connectionStatus.connectionTest ? 'success' : 'warning'}">${connectionStatus.connectionTest ? '‚úÖ Connected' : '‚è≥ Testing...'}</span></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Troubleshooting:</h6>
                                    <ul>
                                        <li>Check if Firebase SDK is loaded properly</li>
                                        <li>Verify database URL is correct</li>
                                        <li>Check network connection</li>
                                        <li>Verify Firebase project settings</li>
                                    </ul>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-primary btn-sm me-2" onclick="retryFirebaseConnection()">
                                        <i class="fas fa-redo"></i> Retry Connection
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="loadSampleData()">
                                        <i class="fas fa-database"></i> Use Sample Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('firebaseStatusModal');
            if (oldModal) oldModal.remove();
            
            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', statusHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('firebaseStatusModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    // Fallback: hi·ªÉn th·ªã th√¥ng tin trong alert
                    alert(`Firebase Status:\nSDK: ${connectionStatus.sdkLoaded ? 'Loaded' : 'Not loaded'}\nDatabase: ${connectionStatus.databaseAvailable ? 'Available' : 'Not available'}\nInitialized: ${connectionStatus.databaseInitialized ? 'Yes' : 'No'}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`Firebase Status:\nSDK: ${connectionStatus.sdkLoaded ? 'Loaded' : 'Not loaded'}\nDatabase: ${connectionStatus.databaseAvailable ? 'Available' : 'Not available'}\nInitialized: ${connectionStatus.databaseInitialized ? 'Yes' : 'No'}`);
            }
        }

        // H√†m retry k·∫øt n·ªëi Firebase
        function retryFirebaseConnection() {
            console.log('üîÑ Retrying Firebase connection...');
            
            // ƒê√≥ng modal hi·ªán t·∫°i
            const modal = bootstrap.Modal.getInstance(document.getElementById('firebaseStatusModal'));
            if (modal) modal.hide();
            
            // Th·ª≠ kh·ªüi t·∫°o l·∫°i Firebase
            try {
                if (typeof firebase !== 'undefined' && firebase.database) {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    console.log('‚úÖ Firebase re-initialized successfully');
                    
                    // Load d·ªØ li·ªáu realtime
                    loadRealtimeData();
                    
                    showNotification('Firebase connection restored!', 'success');
                } else {
                    console.error('‚ùå Firebase SDK still not available');
                    showNotification('Firebase SDK not available', 'danger');
                }
            } catch (error) {
                console.error('‚ùå Firebase re-initialization failed:', error);
                showNotification('Failed to connect to Firebase', 'danger');
            }
        }

        // H·ªá th·ªëng auto-refresh v√† monitoring
        let autoRefreshInterval;
        let lastDataUpdate = Date.now();
        
        function startAutoRefresh() {
            // Auto-refresh m·ªói 30 gi√¢y n·∫øu Firebase kh√¥ng kh·∫£ d·ª•ng
            if (!database) {
                autoRefreshInterval = setInterval(() => {
                    console.log('üîÑ Auto-refreshing data...');
                    loadSampleData();
                    showNotification('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông', 'info');
                }, 30000);
            }
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // H√†m monitor real-time changes
        function monitorRealTimeChanges() {
            // Monitor m·ªói 10 gi√¢y ƒë·ªÉ ki·ªÉm tra c√≥ d·ªØ li·ªáu m·ªõi kh√¥ng
            setInterval(() => {
                const currentTime = Date.now();
                const timeSinceLastUpdate = currentTime - lastDataUpdate;
                
                // N·∫øu kh√¥ng c√≥ c·∫≠p nh·∫≠t trong 1 ph√∫t, th√¥ng b√°o
                if (timeSinceLastUpdate > 60000 && database) {
                    console.log('‚ö†Ô∏è No data updates in the last minute');
                    showNotification('ƒêang ch·ªù d·ªØ li·ªáu m·ªõi...', 'warning');
                }
                
                // C·∫≠p nh·∫≠t timestamp
                lastDataUpdate = currentTime;
            }, 10000);
        }

        // H√†m b·∫≠t/t·∫Øt auto-refresh
        function toggleAutoRefresh() {
            const button = document.getElementById('autoRefreshBtn');
            if (autoRefreshInterval) {
                stopAutoRefresh();
                button.innerHTML = '<i class="fas fa-sync"></i> Auto-refresh OFF';
                button.className = 'btn btn-outline-secondary btn-sm me-2';
                showNotification('Auto-refresh ƒë√£ t·∫Øt', 'warning');
            } else {
                startAutoRefresh();
                button.innerHTML = '<i class="fas fa-sync fa-spin"></i> Auto-refresh ON';
                button.className = 'btn btn-secondary btn-sm me-2';
                showNotification('Auto-refresh ƒë√£ b·∫≠t', 'success');
            }
        }

        // H√†m hi·ªÉn th·ªã th·ªëng k√™ Hotel vs Tour
        function showHotelTourStats() {
            const stats = realtimeData.revenueStats;
            
            // T√≠nh to√°n chi ti·∫øt
            const hotelBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'hotel' && booking.paymentStatus === 'paid'
            );
            const tourBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'tour' && booking.paymentStatus === 'paid'
            );
            
            const hotelRevenue = hotelBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            const tourRevenue = tourBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            
            const totalBookings = stats.totalBookings;
            const hotelPercentage = totalBookings > 0 ? ((stats.hotelBookings / totalBookings) * 100).toFixed(1) : 0;
            const tourPercentage = totalBookings > 0 ? ((stats.tourBookings / totalBookings) * 100).toFixed(1) : 0;
            
            const statsHTML = `
                <div class="modal fade" id="hotelTourStatsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Th·ªëng k√™ Hotel vs Tour</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">üè® ${stats.hotelBookings}</div>
                                            <div class="stat-label">Booking Kh√°ch s·∫°n</div>
                                            <div class="small text-muted">${hotelPercentage}% c·ªßa t·ªïng</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">üó∫Ô∏è ${stats.tourBookings}</div>
                                            <div class="stat-label">Booking Tour</div>
                                            <div class="small text-muted">${tourPercentage}% c·ªßa t·ªïng</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${formatCurrency(hotelRevenue)}</div>
                                            <div class="stat-label">Doanh thu Kh√°ch s·∫°n</div>
                                            <div class="small text-muted">${hotelRevenue > 0 ? ((hotelRevenue / stats.totalRevenue) * 100).toFixed(1) : 0}% t·ªïng doanh thu</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-info">${formatCurrency(tourRevenue)}</div>
                                            <div class="stat-label">Doanh thu Tour</div>
                                            <div class="small text-muted">${tourRevenue > 0 ? ((tourRevenue / stats.totalRevenue) * 100).toFixed(1) : 0}% t·ªïng doanh thu</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Lo·∫°i</th>
                                                <th>S·ªë booking</th>
                                                <th>Doanh thu</th>
                                                <th>Trung b√¨nh/booking</th>
                                                <th>T·ª∑ l·ªá</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><span class="badge bg-primary">üè® HOTEL</span></td>
                                                <td>${stats.hotelBookings}</td>
                                                <td class="text-success">${formatCurrency(hotelRevenue)}</td>
                                                <td>${stats.hotelBookings > 0 ? formatCurrency(hotelRevenue / stats.hotelBookings) : '‚Ç´0'}</td>
                                                <td>${hotelPercentage}%</td>
                                            </tr>
                                            <tr>
                                                <td><span class="badge bg-warning">üó∫Ô∏è TOUR</span></td>
                                                <td>${stats.tourBookings}</td>
                                                <td class="text-info">${formatCurrency(tourRevenue)}</td>
                                                <td>${stats.tourBookings > 0 ? formatCurrency(tourRevenue / stats.tourBookings) : '‚Ç´0'}</td>
                                                <td>${tourPercentage}%</td>
                                            </tr>
                                            <tr class="table-active">
                                                <td><strong>T·ªîNG C·ªòNG</strong></td>
                                                <td><strong>${totalBookings}</strong></td>
                                                <td class="text-success"><strong>${formatCurrency(stats.totalRevenue)}</strong></td>
                                                <td><strong>${totalBookings > 0 ? formatCurrency(stats.totalRevenue / totalBookings) : '‚Ç´0'}</strong></td>
                                                <td><strong>100%</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('hotelTourStatsModal');
            if (oldModal) oldModal.remove();
            
            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', statsHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('hotelTourStatsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    // Fallback: hi·ªÉn th·ªã th√¥ng tin trong alert
                    alert(`Hotel vs Tour Stats:\nüè® Hotel: ${stats.hotelBookings} bookings, ${formatCurrency(hotelRevenue)}\nüó∫Ô∏è Tour: ${stats.tourBookings} bookings, ${formatCurrency(tourRevenue)}\nüí∞ Total: ${formatCurrency(stats.totalRevenue)}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`Hotel vs Tour Stats:\nüè® Hotel: ${stats.hotelBookings} bookings, ${formatCurrency(hotelRevenue)}\nüó∫Ô∏è Tour: ${stats.tourBookings} bookings, ${formatCurrency(tourRevenue)}\nüí∞ Total: ${formatCurrency(stats.totalRevenue)}`);
            }
        }

        // H√†m b·∫≠t/t·∫Øt auto-refresh
        function toggleAutoRefresh() {
            const button = document.getElementById('autoRefreshBtn');
            if (autoRefreshInterval) {
                stopAutoRefresh();
                button.innerHTML = '<i class="fas fa-sync"></i> Auto-refresh OFF';
                button.className = 'btn btn-outline-secondary btn-sm me-2';
                showNotification('Auto-refresh ƒë√£ t·∫Øt', 'warning');
            } else {
                startAutoRefresh();
                button.innerHTML = '<i class="fas fa-sync fa-spin"></i> Auto-refresh ON';
                button.className = 'btn btn-secondary btn-sm me-2';
                showNotification('Auto-refresh ƒë√£ b·∫≠t', 'success');
            }
        }

        // H√†m c·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng h·ª£p
        function updateRevenueSummary() {
            const stats = realtimeData.revenueStats;
            
            // T√≠nh to√°n chi ti·∫øt theo lo·∫°i booking
            const hotelBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'hotel' && booking.paymentStatus === 'paid'
            );
            const tourBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'tour' && booking.paymentStatus === 'paid'
            );
            const depositBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.bookingType === 'deposit' && booking.paymentStatus === 'paid'
            );
            const promotionBookings = Object.values(realtimeData.bookings).filter(
                booking => booking.paymentStatus === 'paid' && (
                    booking.note?.includes('∆∞u ƒë√£i') || 
                    booking.note?.includes('promotion') || 
                    booking.note?.includes('discount') ||
                    booking.totalPrice < 1000000 // Gi·∫£ s·ª≠ booking d∆∞·ªõi 1M l√† ∆∞u ƒë√£i
                )
            );
            
            // T√≠nh doanh thu t·ª´ng lo·∫°i
            const hotelRevenue = hotelBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            const tourRevenue = tourBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            const depositRevenue = depositBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            const promotionRevenue = promotionBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
            
            const totalRevenue = hotelRevenue + tourRevenue + depositRevenue + promotionRevenue;
            const totalCommission = totalRevenue * 0.15;
            const averageRevenue = stats.totalBookings > 0 ? totalRevenue / stats.totalBookings : 0;
            
            // C·∫≠p nh·∫≠t UI
            document.getElementById('totalHotelBookings').textContent = hotelBookings.length;
            document.getElementById('totalHotelRevenue').textContent = formatCurrency(hotelRevenue);
            document.getElementById('totalTourBookings').textContent = tourBookings.length;
            document.getElementById('totalTourRevenue').textContent = formatCurrency(tourRevenue);
            document.getElementById('totalDepositBookings').textContent = depositBookings.length;
            document.getElementById('totalDepositRevenue').textContent = formatCurrency(depositRevenue);
            document.getElementById('totalPromotionBookings').textContent = promotionBookings.length;
            document.getElementById('totalPromotionRevenue').textContent = formatCurrency(promotionRevenue);
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalCommission').textContent = `Hoa h·ªìng: ${formatCurrency(totalCommission)}`;
            document.getElementById('totalBookings').textContent = stats.totalBookings;
            document.getElementById('averageRevenue').textContent = `TB: ${formatCurrency(averageRevenue)}/booking`;
            
            // Log chi ti·∫øt
            console.log('üìä Revenue Summary:');
            console.log(`  üè® Hotel: ${hotelBookings.length} bookings, ${formatCurrency(hotelRevenue)}`);
            console.log(`  üó∫Ô∏è Tour: ${tourBookings.length} bookings, ${formatCurrency(tourRevenue)}`);
            console.log(`  üí∞ Deposit: ${depositBookings.length} bookings, ${formatCurrency(depositRevenue)}`);
            console.log(`  üéÅ Promotion: ${promotionBookings.length} bookings, ${formatCurrency(promotionRevenue)}`);
            console.log(`  üí∞ Total: ${formatCurrency(totalRevenue)}`);
        }

        // H√†m c·∫≠p nh·∫≠t b·∫£ng ƒë·∫∑t c·ªçc
        function updateDepositTable() {
            const tableBody = document.getElementById('depositTableBody');
            if (!tableBody) return;

            // L·ªçc booking ƒë·∫∑t c·ªçc
            const depositBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.bookingType === 'deposit' && booking.paymentStatus === 'paid'
            );

            let tableHTML = '';
            depositBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt).toLocaleDateString('vi-VN');
                const itemType = booking.hotelName ? 'Kh√°ch s·∫°n' : 'Tour';
                const itemName = booking.hotelName || booking.tourName;
                
                tableHTML += `
                    <tr>
                        <td>${bookingDate}</td>
                        <td>${booking.customerName}</td>
                        <td><span class="badge bg-info">${itemType}</span> ${itemName}</td>
                        <td class="text-warning fw-bold">${formatCurrency(booking.totalPrice)}</td>
                        <td>${booking.note || '-'}</td>
                        <td><span class="badge bg-success">ƒê√£ thanh to√°n</span></td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" title="Chi ti·∫øt" onclick="viewBookingDetails('${itemName}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" title="ƒê·ªëi so√°t" onclick="reconcileHotel('${itemName}')"><i class="fas fa-balance-scale"></i></button>
                        </td>
                    </tr>
                `;
            });

            if (depositBookings.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·∫∑t c·ªçc n√†o.
                        </td>
                    </tr>
                `;
            }

            tableBody.innerHTML = tableHTML;
        }

        // H√†m c·∫≠p nh·∫≠t b·∫£ng ∆∞u ƒë√£i
        function updatePromotionTable() {
            const tableBody = document.getElementById('promotionTableBody');
            if (!tableBody) return;

            // L·ªçc booking c√≥ ∆∞u ƒë√£i
            const promotionBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.paymentStatus === 'paid' && (
                    booking.note?.includes('∆∞u ƒë√£i') || 
                    booking.note?.includes('promotion') || 
                    booking.note?.includes('discount') ||
                    booking.totalPrice < 1000000
                )
            );

            let tableHTML = '';
            promotionBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt).toLocaleDateString('vi-VN');
                const itemType = booking.bookingType === 'hotel' ? 'Kh√°ch s·∫°n' : 'Tour';
                const itemName = booking.hotelName || booking.tourName;
                
                // ∆Ø·ªõc t√≠nh gi√° g·ªëc (tƒÉng 30% so v·ªõi gi√° hi·ªán t·∫°i)
                const originalPrice = Math.round(booking.totalPrice * 1.3);
                const savings = originalPrice - booking.totalPrice;
                
                tableHTML += `
                    <tr>
                        <td>${bookingDate}</td>
                        <td>${booking.customerName}</td>
                        <td><span class="badge bg-${booking.bookingType === 'hotel' ? 'primary' : 'warning'}">${itemType}</span> ${itemName}</td>
                        <td class="text-muted"><del>${formatCurrency(originalPrice)}</del></td>
                        <td class="text-success fw-bold">${formatCurrency(booking.totalPrice)}</td>
                        <td class="text-danger">-${formatCurrency(savings)}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" title="Chi ti·∫øt" onclick="viewBookingDetails('${itemName}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" title="ƒê·ªëi so√°t" onclick="reconcileHotel('${itemName}')"><i class="fas fa-balance-scale"></i></button>
                        </td>
                    </tr>
                `;
            });

            if (promotionBookings.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch∆∞a c√≥ d·ªØ li·ªáu ∆∞u ƒë√£i n√†o.
                        </td>
                    </tr>
                `;
            }

            tableBody.innerHTML = tableHTML;
        }

        // H√†m t√≠nh to√°n hoa h·ªìng t·ª´ d·ªØ li·ªáu realtime
        function calculateCommissionData() {
            // L·ªçc booking kh√°ch s·∫°n ƒë√£ thanh to√°n
            const hotelBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.bookingType === 'hotel' && booking.paymentStatus === 'paid' && booking.hotelName
            );
            
            // T·∫°o d·ªØ li·ªáu hoa h·ªìng theo kh√°ch s·∫°n
            const commissionData = {};
            
            hotelBookings.forEach(booking => {
                const hotelName = booking.hotelName;
                
                if (!commissionData[hotelName]) {
                    commissionData[hotelName] = {
                        hotelName: hotelName,
                        totalRevenue: 0,
                        commissionRate: 15, // M·∫∑c ƒë·ªãnh 15%
                        totalCommission: 0,
                        paidCommission: 0,
                        pendingCommission: 0,
                        bookingCount: 0,
                        lastBookingDate: null
                    };
                }
                
                commissionData[hotelName].totalRevenue += booking.totalPrice || 0;
                commissionData[hotelName].bookingCount++;
                
                // C·∫≠p nh·∫≠t ng√†y booking m·ªõi nh·∫•t
                const bookingDate = new Date(booking.createdAt);
                if (!commissionData[hotelName].lastBookingDate || 
                    bookingDate > commissionData[hotelName].lastBookingDate) {
                    commissionData[hotelName].lastBookingDate = bookingDate;
                }
            });
            
            // T√≠nh hoa h·ªìng cho t·ª´ng kh√°ch s·∫°n
            Object.keys(commissionData).forEach(hotelName => {
                const data = commissionData[hotelName];
                data.totalCommission = Math.round(data.totalRevenue * (data.commissionRate / 100));
                data.pendingCommission = data.totalCommission; // M·∫∑c ƒë·ªãnh ch∆∞a thanh to√°n
                data.paidCommission = 0; // M·∫∑c ƒë·ªãnh ch∆∞a thanh to√°n
            });
            
            return commissionData;
        }

        // H√†m c·∫≠p nh·∫≠t b·∫£ng hoa h·ªìng
        function updateCommissionTable() {
            const commissionData = calculateCommissionData();
            const tableBody = document.getElementById('commissionTableBody');
            
            if (!tableBody) return;
            
            // T√≠nh t·ªïng th·ªëng k√™
            let totalPendingCommission = 0;
            let totalPaidCommission = 0;
            let totalRevenue = 0;
            let totalCommission = 0;
            
            Object.values(commissionData).forEach(data => {
                totalPendingCommission += data.pendingCommission;
                totalPaidCommission += data.paidCommission;
                totalRevenue += data.totalRevenue;
                totalCommission += data.totalCommission;
            });
            
            const avgCommissionRate = totalRevenue > 0 ? ((totalCommission / totalRevenue) * 100).toFixed(1) : 15;
            
            // C·∫≠p nh·∫≠t th·ªëng k√™
            document.getElementById('pendingCommission').textContent = formatCurrency(totalPendingCommission);
            document.getElementById('paidCommission').textContent = formatCurrency(totalPaidCommission);
            document.getElementById('avgCommissionRate').textContent = avgCommissionRate + '%';
            document.getElementById('totalPartners').textContent = Object.keys(commissionData).length;
            
            // T·∫°o HTML cho b·∫£ng
            let tableHTML = '';
            const sortedHotels = Object.values(commissionData).sort((a, b) => b.totalCommission - a.totalCommission);
            
            sortedHotels.forEach(data => {
                const status = data.pendingCommission > 0 ? 'Pending' : 'Paid';
                const statusBadge = data.pendingCommission > 0 ? 'bg-warning' : 'bg-success';
                const remainingCommission = data.totalCommission - data.paidCommission;
                
                tableHTML += `
                    <tr>
                        <td><i class="fas fa-hotel text-primary me-1"></i>${data.hotelName}</td>
                        <td><span class="badge bg-info">${data.commissionRate}%</span></td>
                        <td class="fw-bold">${formatCurrency(data.totalRevenue)}</td>
                        <td class="text-warning fw-bold">${formatCurrency(data.totalCommission)}</td>
                        <td class="text-success">${formatCurrency(data.paidCommission)}</td>
                        <td class="text-danger">${formatCurrency(remainingCommission)}</td>
                        <td><span class="badge ${statusBadge}">${status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success me-1" onclick="payCommission('${data.hotelName}')" title="Thanh to√°n" ${data.pendingCommission <= 0 ? 'disabled' : ''}>
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button class="btn btn-sm btn-info" title="Chi ti·∫øt" onclick="viewCommissionDetails('${data.hotelName}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            if (sortedHotels.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch∆∞a c√≥ d·ªØ li·ªáu hoa h·ªìng n√†o.
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableHTML;
            
            // Log chi ti·∫øt
            console.log('üí∞ Commission Summary:');
            console.log(`  üìä Total hotels: ${Object.keys(commissionData).length}`);
            console.log(`  üí∞ Total revenue: ${formatCurrency(totalRevenue)}`);
            console.log(`  üí∏ Total commission: ${formatCurrency(totalCommission)}`);
            console.log(`  ‚è≥ Pending commission: ${formatCurrency(totalPendingCommission)}`);
            console.log(`  ‚úÖ Paid commission: ${formatCurrency(totalPaidCommission)}`);
        }

        // H√†m xem chi ti·∫øt hoa h·ªìng
        function viewCommissionDetails(hotelName) {
            const commissionData = calculateCommissionData();
            const hotelData = commissionData[hotelName];
            
            if (!hotelData) {
                alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu hoa h·ªìng cho kh√°ch s·∫°n n√†y');
                return;
            }
            
            // L·ªçc booking c·ªßa kh√°ch s·∫°n n√†y
            const hotelBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.hotelName === hotelName && booking.paymentStatus === 'paid'
            );
            
            let detailsHTML = `
                <div class="modal fade" id="commissionDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi ti·∫øt hoa h·ªìng - ${hotelName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${hotelData.bookingCount}</div>
                                            <div class="stat-label">S·ªë booking</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${formatCurrency(hotelData.totalRevenue)}</div>
                                            <div class="stat-label">T·ªïng doanh thu</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">${formatCurrency(hotelData.totalCommission)}</div>
                                            <div class="stat-label">Hoa h·ªìng (${hotelData.commissionRate}%)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-number text-info">${formatCurrency(hotelData.pendingCommission)}</div>
                                            <div class="stat-label">Ch·ªù thanh to√°n</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Booking ID</th>
                                                <th>Kh√°ch h√†ng</th>
                                                <th>Ng√†y</th>
                                                <th>Doanh thu</th>
                                                <th>Hoa h·ªìng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;
            
            hotelBookings.forEach(booking => {
                const bookingDate = new Date(booking.createdAt).toLocaleDateString('vi-VN');
                const commission = Math.round((booking.totalPrice || 0) * (hotelData.commissionRate / 100));
                
                detailsHTML += `
                    <tr>
                        <td>H-${booking.createdAt.toString().slice(-6)}</td>
                        <td>${booking.customerName}</td>
                        <td>${bookingDate}</td>
                        <td class="text-success">${formatCurrency(booking.totalPrice)}</td>
                        <td class="text-warning">${formatCurrency(commission)}</td>
                    </tr>
                `;
            });
            
            detailsHTML += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('commissionDetailsModal');
            if (oldModal) oldModal.remove();
            
            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('commissionDetailsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    alert(`Chi ti·∫øt hoa h·ªìng - ${hotelName}\nT·ªïng doanh thu: ${formatCurrency(hotelData.totalRevenue)}\nHoa h·ªìng: ${formatCurrency(hotelData.totalCommission)}\nS·ªë booking: ${hotelData.bookingCount}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`Chi ti·∫øt hoa h·ªìng - ${hotelName}\nT·ªïng doanh thu: ${formatCurrency(hotelData.totalRevenue)}\nHoa h·ªìng: ${formatCurrency(hotelData.totalCommission)}\nS·ªë booking: ${hotelData.bookingCount}`);
            }
        }

        // H√†m refresh d·ªØ li·ªáu hoa h·ªìng
        function refreshCommissionData() {
            console.log('üîÑ Refreshing commission data...');
            updateCommissionTable();
            showNotification('D·ªØ li·ªáu hoa h·ªìng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
        }

        // H√†m c·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng h·ª£p
        function updateReconciliationStats(reconciliationData, totalDiscrepancies, totalPendingAmount) {
            const totalHotels = Object.keys(reconciliationData.hotels).length;
            const totalTours = Object.keys(reconciliationData.tours).length;
            const totalItems = totalHotels + totalTours;
            const pendingItems = Object.values(reconciliationData.hotels).filter(h => h.status === 'Pending').length +
                               Object.values(reconciliationData.tours).filter(t => t.status === 'Pending').length;
            
            // C·∫≠p nh·∫≠t c√°c element th·ªëng k√™ n·∫øu c√≥
            const pendingElement = document.getElementById('pendingReconciliation');
            const completedElement = document.getElementById('completedReconciliation');
            const discrepancyElement = document.getElementById('totalDiscrepancies');
            const amountElement = document.getElementById('pendingAmount');
            
            if (pendingElement) pendingElement.textContent = pendingItems;
            if (completedElement) completedElement.textContent = totalItems - pendingItems;
            if (discrepancyElement) discrepancyElement.textContent = totalDiscrepancies;
            if (amountElement) amountElement.textContent = formatCurrency(totalPendingAmount);
        }

        // H√†m ƒë·ªëi so√°t item
        function reconcileItem(itemName, type) {
            const reconciliationData = generateReconciliationData();
            let itemData;
            
            if (type === 'hotel') {
                itemData = reconciliationData.hotels[itemName];
            } else if (type === 'tour') {
                itemData = reconciliationData.tours[itemName];
            }
            
            if (!itemData) {
                alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªëi so√°t cho item n√†y');
                return;
            }
            
            if (confirm(`X√°c nh·∫≠n ƒë·ªëi so√°t cho ${itemName}?\nS·ªë ti·ªÅn: ${formatCurrency(itemData.totalCommission)}`)) {
                // Gi·∫£ l·∫≠p qu√° tr√¨nh ƒë·ªëi so√°t
                console.log(`üîÑ Reconciling ${type}: ${itemName}`);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                itemData.status = 'Completed';
                itemData.paidCommission = itemData.totalCommission;
                itemData.pendingCommission = 0;
                itemData.lastReconciliation = new Date().toISOString().split('T')[0];
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                showNotification(`ƒê√£ ƒë·ªëi so√°t th√†nh c√¥ng ${itemName}`, 'success');
                
                // C·∫≠p nh·∫≠t b·∫£ng
                updateReconciliationTable();
            }
        }

        // H√†m xem chi ti·∫øt ƒë·ªëi so√°t
        function viewReconciliationDetails(itemName, type) {
            const reconciliationData = generateReconciliationData();
            let itemData;
            
            if (type === 'hotel') {
                itemData = reconciliationData.hotels[itemName];
            } else if (type === 'tour') {
                itemData = reconciliationData.tours[itemName];
            }
            
            if (!itemData) {
                alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªëi so√°t cho item n√†y');
                return;
            }
            
            // T·∫°o modal chi ti·∫øt
            let detailsHTML = `
                <div class="modal fade" id="reconciliationDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi ti·∫øt ƒë·ªëi so√°t - ${itemName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${itemData.totalBookings}</div>
                                            <div class="stat-label">S·ªë booking</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${formatCurrency(itemData.totalRevenue)}</div>
                                            <div class="stat-label">T·ªïng doanh thu</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-warning">${formatCurrency(itemData.totalCommission)}</div>
                                            <div class="stat-label">Hoa h·ªìng (${itemData.commissionRate}%)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-danger">${formatCurrency(itemData.pendingCommission)}</div>
                                            <div class="stat-label">Ch·ªù thanh to√°n</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th>Th√¥ng tin</th>
                                                <th>Gi√° tr·ªã</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Lo·∫°i</td>
                                                <td><span class="badge bg-${type === 'hotel' ? 'primary' : 'warning'}">${type === 'hotel' ? 'Kh√°ch s·∫°n' : 'Tour'}</span></td>
                                            </tr>
                                            <tr>
                                                <td>ƒê·ªãa ƒëi·ªÉm</td>
                                                <td>${itemData.location}</td>
                                            </tr>
                                            <tr>
                                                <td>K·ª≥ ƒë·ªëi so√°t</td>
                                                <td>${itemData.reconciliationPeriod}</td>
                                            </tr>
                                            <tr>
                                                <td>L·∫ßn ƒë·ªëi so√°t cu·ªëi</td>
                                                <td>${itemData.lastReconciliation}</td>
                                            </tr>
                                            <tr>
                                                <td>Tr·∫°ng th√°i</td>
                                                <td><span class="badge bg-${itemData.status === 'Pending' ? 'warning' : 'success'}">${itemData.status}</span></td>
                                            </tr>
                                            <tr>
                                                <td>Ch√™nh l·ªách</td>
                                                <td class="${itemData.discrepancies > 0 ? 'text-danger' : 'text-success'}">${itemData.discrepancies}</td>
                                            </tr>
                                            <tr>
                                                <td>Ghi ch√∫</td>
                                                <td>${itemData.notes}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('reconciliationDetailsModal');
            if (oldModal) oldModal.remove();
            
            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('reconciliationDetailsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    alert(`Chi ti·∫øt ƒë·ªëi so√°t - ${itemName}\nDoanh thu: ${formatCurrency(itemData.totalRevenue)}\nHoa h·ªìng: ${formatCurrency(itemData.totalCommission)}\nTr·∫°ng th√°i: ${itemData.status}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`Chi ti·∫øt ƒë·ªëi so√°t - ${itemName}\nDoanh thu: ${formatCurrency(itemData.totalRevenue)}\nHoa h·ªìng: ${formatCurrency(itemData.totalCommission)}\nTr·∫°ng th√°i: ${itemData.status}`);
            }
        }

        // H√†m t·∫°o d·ªØ li·ªáu ƒë·ªëi so√°t t·ª´ file JSON
        function generateReconciliationData() {
            // D·ªØ li·ªáu ƒë·ªëi so√°t d·ª±a tr√™n bookings v√† payments t·ª´ JSON
            const reconciliationData = {
                hotels: {
                    "Dakruco Hotel": {
                        hotelName: "Dakruco Hotel",
                        location: "Bu√¥n Ma Thu·ªôt",
                        reconciliationPeriod: "Th√°ng 12/2024",
                        totalBookings: 1,
                        totalRevenue: 1100000,
                        commissionRate: 15,
                        totalCommission: 165000,
                        paidCommission: 0,
                        pendingCommission: 165000,
                        status: "Pending",
                        lastReconciliation: "2024-11-30",
                        discrepancies: 0,
                        notes: "Kh√°ch s·∫°n m·ªõi, ch∆∞a ƒë·ªëi so√°t"
                    },
                    "Combo Ngh·ªâ D∆∞·ª°ng Bi·ªÉn 5*": {
                        hotelName: "Combo Ngh·ªâ D∆∞·ª°ng Bi·ªÉn 5*",
                        location: "Nha Trang",
                        reconciliationPeriod: "Th√°ng 12/2024",
                        totalBookings: 1,
                        totalRevenue: 3200000,
                        commissionRate: 15,
                        totalCommission: 480000,
                        paidCommission: 0,
                        pendingCommission: 480000,
                        status: "Pending",
                        lastReconciliation: "2024-11-30",
                        discrepancies: 0,
                        notes: "Flash sale booking, c·∫ßn x√°c nh·∫≠n"
                    },
                    "InterContinental ƒê√† N·∫µng Sun Peninsula Resort": {
                        hotelName: "InterContinental ƒê√† N·∫µng Sun Peninsula Resort",
                        location: "ƒê√† N·∫µng",
                        reconciliationPeriod: "Th√°ng 12/2024",
                        totalBookings: 1,
                        totalRevenue: 3000000,
                        commissionRate: 16,
                        totalCommission: 480000,
                        paidCommission: 0,
                        pendingCommission: 480000,
                        status: "Pending",
                        lastReconciliation: "2024-11-30",
                        discrepancies: 0,
                        notes: "Kh√°ch s·∫°n 5 sao, t·ª∑ l·ªá hoa h·ªìng cao h∆°n"
                    }
                },
                tours: {
                    "Kayak v√† c√¢u c√° t·∫°i V·ªãnh H·∫° Long": {
                        tourName: "Kayak v√† c√¢u c√° t·∫°i V·ªãnh H·∫° Long",
                        location: "H·∫° Long, Qu·∫£ng Ninh",
                        reconciliationPeriod: "Th√°ng 12/2024",
                        totalBookings: 1,
                        totalRevenue: 1200000,
                        commissionRate: 12,
                        totalCommission: 144000,
                        paidCommission: 0,
                        pendingCommission: 144000,
                        status: "Pending",
                        lastReconciliation: "2024-11-30",
                        discrepancies: 0,
                        notes: "Tour tr·∫£i nghi·ªám ƒë·ªãa ph∆∞∆°ng"
                    }
                },
                payments: {
                    "VNPAY Transactions": {
                        totalTransactions: 8,
                        totalAmount: 925000000, // T·ªïng t·ª´ payments trong JSON
                        successfulTransactions: 8,
                        failedTransactions: 0,
                        reconciliationStatus: "Completed",
                        lastReconciliation: "2024-12-15",
                        discrepancies: 0,
                        notes: "T·∫•t c·∫£ giao d·ªãch VNPAY ƒë·ªÅu th√†nh c√¥ng"
                    }
                },
                deposits: {
                    "ƒê·∫∑t c·ªçc": {
                        totalDeposits: 2,
                        totalAmount: 25500000, // 19.5M + 6M t·ª´ payments
                        reconciledAmount: 0,
                        pendingAmount: 25500000,
                        status: "Pending",
                        notes: "C·∫ßn x√°c nh·∫≠n v·ªõi kh√°ch h√†ng"
                    }
                }
            };
            
            return reconciliationData;
        }

        // H√†m c·∫≠p nh·∫≠t b·∫£ng ƒë·ªëi so√°t
        function updateReconciliationTable() {
            const reconciliationData = generateReconciliationData();
            const tableBody = document.getElementById('reconciliationTableBody');
            
            if (!tableBody) return;
            
            let tableHTML = '';
            let totalDiscrepancies = 0;
            let totalPendingAmount = 0;
            
            // Th√™m d·ªØ li·ªáu kh√°ch s·∫°n
            Object.values(reconciliationData.hotels).forEach(hotel => {
                const statusBadge = hotel.status === 'Pending' ? 'bg-warning' : 'bg-success';
                const discrepancyClass = hotel.discrepancies > 0 ? 'text-danger' : 'text-success';
                
                tableHTML += `
                    <tr>
                        <td><i class="fas fa-hotel text-primary me-1"></i>${hotel.hotelName}</td>
                        <td>${hotel.location}</td>
                        <td>${hotel.reconciliationPeriod}</td>
                        <td class="fw-bold">${formatCurrency(hotel.totalRevenue)}</td>
                        <td><span class="badge bg-info">${hotel.commissionRate}%</span></td>
                        <td class="text-warning fw-bold">${formatCurrency(hotel.totalCommission)}</td>
                        <td class="text-success">${formatCurrency(hotel.paidCommission)}</td>
                        <td class="text-danger">${formatCurrency(hotel.pendingCommission)}</td>
                        <td class="${discrepancyClass}">${hotel.discrepancies}</td>
                        <td><span class="badge ${statusBadge}">${hotel.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success me-1" onclick="reconcileItem('${hotel.hotelName}', 'hotel')" title="ƒê·ªëi so√°t">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                            <button class="btn btn-sm btn-info" title="Chi ti·∫øt" onclick="viewReconciliationDetails('${hotel.hotelName}', 'hotel')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                totalDiscrepancies += hotel.discrepancies;
                totalPendingAmount += hotel.pendingCommission;
            });
            
            // Th√™m d·ªØ li·ªáu tour
            Object.values(reconciliationData.tours).forEach(tour => {
                const statusBadge = tour.status === 'Pending' ? 'bg-warning' : 'bg-success';
                const discrepancyClass = tour.discrepancies > 0 ? 'text-danger' : 'text-success';
                
                tableHTML += `
                    <tr>
                        <td><i class="fas fa-map-marked-alt text-warning me-1"></i>${tour.tourName}</td>
                        <td>${tour.location}</td>
                        <td>${tour.reconciliationPeriod}</td>
                        <td class="fw-bold">${formatCurrency(tour.totalRevenue)}</td>
                        <td><span class="badge bg-info">${tour.commissionRate}%</span></td>
                        <td class="text-warning fw-bold">${formatCurrency(tour.totalCommission)}</td>
                        <td class="text-success">${formatCurrency(tour.paidCommission)}</td>
                        <td class="text-danger">${formatCurrency(tour.pendingCommission)}</td>
                        <td class="${discrepancyClass}">${tour.discrepancies}</td>
                        <td><span class="badge ${statusBadge}">${tour.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success me-1" onclick="reconcileItem('${tour.tourName}', 'tour')" title="ƒê·ªëi so√°t">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                            <button class="btn btn-sm btn-info" title="Chi ti·∫øt" onclick="viewReconciliationDetails('${tour.tourName}', 'tour')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                totalDiscrepancies += tour.discrepancies;
                totalPendingAmount += tour.pendingCommission;
            });
            
            if (Object.keys(reconciliationData.hotels).length === 0 && Object.keys(reconciliationData.tours).length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="11" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªëi so√°t n√†o.
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableHTML;
            
            // C·∫≠p nh·∫≠t th·ªëng k√™ ƒë·ªëi so√°t
            updateReconciliationStats(reconciliationData, totalDiscrepancies, totalPendingAmount);
            
            console.log('üìä Reconciliation Summary:');
            console.log(`  üè® Hotels: ${Object.keys(reconciliationData.hotels).length}`);
            console.log(`  üó∫Ô∏è Tours: ${Object.keys(reconciliationData.tours).length}`);
            console.log(`  üí∞ Total pending: ${formatCurrency(totalPendingAmount)}`);
            console.log(`  ‚ùå Total discrepancies: ${totalDiscrepancies}`);
        }

        // ===== AFFILIATE PARTNERS MANAGEMENT =====
        
        // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu ƒë·ªëi t√°c t·ª´ Affiliate Manager
        let affiliatePartners = [];
        
        // H√†m load d·ªØ li·ªáu ƒë·ªëi t√°c t·ª´ Affiliate Manager
        function loadAffiliatePartners() {
            console.log('üîÑ Loading affiliate partners data...');
            
            if (!database) {
                console.warn('‚ö†Ô∏è Firebase not available, using sample data');
                loadSampleAffiliatePartners();
                return;
            }
            
            const partnersRef = database.ref('affiliatePartners');
            
            partnersRef.once('value', (snapshot) => {
                affiliatePartners = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const partner = childSnapshot.val();
                        partner.id = childSnapshot.key;
                        affiliatePartners.push(partner);
                    });
                    console.log(`‚úÖ Loaded ${affiliatePartners.length} affiliate partners`);
                } else {
                    console.log('üìù No affiliate partners found, using sample data');
                    loadSampleAffiliatePartners();
                }
                
                updateAffiliatePartnersTable();
                updateAffiliatePartnersStats();
                
            }, (error) => {
                console.warn('‚ö†Ô∏è Cannot access Firebase affiliate partners:', error.code);
                loadSampleAffiliatePartners();
            });
        }
        
        // H√†m t·∫°o d·ªØ li·ªáu m·∫´u cho ƒë·ªëi t√°c affiliate
        function loadSampleAffiliatePartners() {
            affiliatePartners = [
                {
                    id: 'partner_001',
                    name: 'TravelNow',
                    website: 'travelnow.vn',
                    contactEmail: 'partner@travelnow.vn',
                    contactPhone: '0901-234-567',
                    status: 'ƒêang h·ª£p t√°c',
                    commission: 8.5,
                    revenue: '95,000,000ƒë',
                    createdAt: '2024-01-15',
                    updatedAt: new Date().toISOString()
                },
                {
                    id: 'partner_002', 
                    name: 'HotelLink',
                    website: 'hotellink.com',
                    contactEmail: 'support@hotellink.vn',
                    contactPhone: '0902-345-678',
                    status: 'ƒêang h·ª£p t√°c',
                    commission: 7.0,
                    revenue: '73,000,000ƒë',
                    createdAt: '2024-02-20',
                    updatedAt: new Date().toISOString()
                },
                {
                    id: 'partner_003',
                    name: 'BookingVN',
                    website: 'bookingvn.com',
                    contactEmail: 'partner@bookingvn.com',
                    contactPhone: '0903-456-789',
                    status: 'ƒêang h·ª£p t√°c',
                    commission: 9.0,
                    revenue: '87,000,000ƒë',
                    createdAt: '2024-03-10',
                    updatedAt: new Date().toISOString()
                },
                {
                    id: 'partner_004',
                    name: 'StayEasy',
                    website: 'stayeasy.vn',
                    contactEmail: 'info@stayeasy.vn',
                    contactPhone: '0904-567-890',
                    status: 'T·∫°m d·ª´ng',
                    commission: 6.5,
                    revenue: '42,000,000ƒë',
                    createdAt: '2024-04-05',
                    updatedAt: new Date().toISOString()
                }
            ];
            
            updateAffiliatePartnersTable();
            updateAffiliatePartnersStats();
        }
        
        // H√†m c·∫≠p nh·∫≠t b·∫£ng ƒë·ªëi t√°c affiliate
        function updateAffiliatePartnersTable() {
            const tableBody = document.getElementById('affiliatePartnersTable');
            
            if (!tableBody) return;
            
            let tableHTML = '';
            
            if (affiliatePartners.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªëi t√°c n√†o.
                        </td>
                    </tr>
                `;
            } else {
                affiliatePartners.forEach(partner => {
                    const statusBadge = partner.status === 'ƒêang h·ª£p t√°c' ? 'bg-success' : 
                                      (partner.status === 'T·∫°m d·ª´ng' ? 'bg-warning' : 'bg-secondary');
                    
                    tableHTML += `
                        <tr>
                            <td><i class="fas fa-handshake text-primary me-1"></i>${partner.name}</td>
                            <td><a href="https://${partner.website}" target="_blank">${partner.website}</a></td>
                            <td><a href="mailto:${partner.contactEmail}">${partner.contactEmail}</a></td>
                            <td><span class="badge ${statusBadge}">${partner.status}</span></td>
                            <td><span class="badge bg-info">${partner.commission}%</span></td>
                            <td class="fw-bold">${partner.revenue}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="viewPartnerDetails('${partner.id}')" title="Chi ti·∫øt">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editPartnerCommission('${partner.id}')" title="S·ª≠a hoa h·ªìng">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }
        
        // H√†m c·∫≠p nh·∫≠t th·ªëng k√™ ƒë·ªëi t√°c affiliate
        function updateAffiliatePartnersStats() {
            const totalPartners = affiliatePartners.length;
            const activePartners = affiliatePartners.filter(p => p.status === 'ƒêang h·ª£p t√°c').length;
            
            // T√≠nh hoa h·ªìng trung b√¨nh
            const totalCommission = affiliatePartners.reduce((sum, p) => sum + p.commission, 0);
            const avgCommission = totalPartners > 0 ? (totalCommission / totalPartners).toFixed(1) : 0;
            
            // T√≠nh t·ªïng doanh thu
            const totalRevenue = affiliatePartners.reduce((sum, p) => {
                const revenue = parseFloat(p.revenue.replace(/[^\d]/g, '')) || 0;
                return sum + revenue;
            }, 0);
            
            // C·∫≠p nh·∫≠t UI
            document.getElementById('totalPartners').textContent = totalPartners;
            document.getElementById('activePartners').textContent = activePartners;
            document.getElementById('avgCommission').textContent = avgCommission + '%';
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            
            console.log('üìä Affiliate Partners Stats:');
            console.log(`  üìà Total partners: ${totalPartners}`);
            console.log(`  ‚úÖ Active partners: ${activePartners}`);
            console.log(`  üí∞ Average commission: ${avgCommission}%`);
            console.log(`  üíµ Total revenue: ${formatCurrency(totalRevenue)}`);
        }
        
        // H√†m xem chi ti·∫øt ƒë·ªëi t√°c
        function viewPartnerDetails(partnerId) {
            const partner = affiliatePartners.find(p => p.id === partnerId);
            
            if (!partner) {
                alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·ªëi t√°c');
                return;
            }
            
            const detailsHTML = `
                <div class="modal fade" id="partnerDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi ti·∫øt ƒë·ªëi t√°c - ${partner.name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-primary">${partner.commission}%</div>
                                            <div class="stat-label">T·ª∑ l·ªá hoa h·ªìng</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card">
                                            <div class="stat-number text-success">${partner.revenue}</div>
                                            <div class="stat-label">Doanh thu</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark table-sm">
                                        <tbody>
                                            <tr>
                                                <td><strong>T√™n ƒë·ªëi t√°c:</strong></td>
                                                <td>${partner.name}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Website:</strong></td>
                                                <td><a href="https://${partner.website}" target="_blank">${partner.website}</a></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Email:</strong></td>
                                                <td><a href="mailto:${partner.contactEmail}">${partner.contactEmail}</a></td>
                                            </tr>
                                            <tr>
                                                <td><strong>ƒêi·ªán tho·∫°i:</strong></td>
                                                <td><a href="tel:${partner.contactPhone}">${partner.contactPhone}</a></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Tr·∫°ng th√°i:</strong></td>
                                                <td><span class="badge bg-${partner.status === 'ƒêang h·ª£p t√°c' ? 'success' : 'warning'}">${partner.status}</span></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Ng√†y t·∫°o:</strong></td>
                                                <td>${new Date(partner.createdAt).toLocaleDateString('vi-VN')}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>C·∫≠p nh·∫≠t cu·ªëi:</strong></td>
                                                <td>${new Date(partner.updatedAt).toLocaleDateString('vi-VN')}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // X√≥a modal c≈© n·∫øu c√≥
            const oldModal = document.getElementById('partnerDetailsModal');
            if (oldModal) oldModal.remove();
            
            // Th√™m modal m·ªõi
            document.body.insertAdjacentHTML('beforeend', detailsHTML);
            
            // Hi·ªÉn th·ªã modal
            try {
                const modalElement = document.getElementById('partnerDetailsModal');
                if (modalElement && typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.warn('‚ö†Ô∏è Bootstrap Modal not available');
                    alert(`Chi ti·∫øt ƒë·ªëi t√°c - ${partner.name}\nWebsite: ${partner.website}\nEmail: ${partner.contactEmail}\nHoa h·ªìng: ${partner.commission}%\nDoanh thu: ${partner.revenue}`);
                }
            } catch (error) {
                console.error('‚ùå Modal error:', error);
                alert(`Chi ti·∫øt ƒë·ªëi t√°c - ${partner.name}\nWebsite: ${partner.website}\nEmail: ${partner.contactEmail}\nHoa h·ªìng: ${partner.commission}%\nDoanh thu: ${partner.revenue}`);
            }
        }
        
        // H√†m s·ª≠a hoa h·ªìng ƒë·ªëi t√°c
        function editPartnerCommission(partnerId) {
            const partner = affiliatePartners.find(p => p.id === partnerId);
            
            if (!partner) {
                alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·ªëi t√°c');
                return;
            }
            
            const newCommission = prompt(`Nh·∫≠p t·ª∑ l·ªá hoa h·ªìng m·ªõi cho ${partner.name} (hi·ªán t·∫°i: ${partner.commission}%):`, partner.commission);
            
            if (newCommission && !isNaN(newCommission) && newCommission >= 0 && newCommission <= 100) {
                const commission = parseFloat(newCommission);
                
                if (!database) {
                    console.warn('‚ö†Ô∏è Firebase not available, updating local data only');
                    partner.commission = commission;
                    partner.updatedAt = new Date().toISOString();
                    updateAffiliatePartnersTable();
                    updateAffiliatePartnersStats();
                    showNotification(`ƒê√£ c·∫≠p nh·∫≠t hoa h·ªìng cho ${partner.name} th√†nh ${commission}%`, 'success');
                    return;
                }
                
                // C·∫≠p nh·∫≠t l√™n Firebase
                database.ref(`affiliatePartners/${partnerId}`).update({
                    commission: commission,
                    updatedAt: new Date().toISOString()
                }).then(() => {
                    console.log(`‚úÖ Updated commission for ${partner.name} to ${commission}%`);
                    showNotification(`ƒê√£ c·∫≠p nh·∫≠t hoa h·ªìng cho ${partner.name} th√†nh ${commission}%`, 'success');
                    loadAffiliatePartners(); // Reload data
                }).catch((error) => {
                    console.error('‚ùå Error updating commission:', error);
                    showNotification('C√≥ l·ªói khi c·∫≠p nh·∫≠t hoa h·ªìng', 'error');
                });
            }
        }
        
        // H√†m l∆∞u c√†i ƒë·∫∑t hoa h·ªìng
        function saveCommissionSettings() {
            const defaultRate = document.getElementById('defaultCommissionRate').value;
            const minRate = document.getElementById('minCommissionRate').value;
            
            if (!defaultRate || !minRate) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }
            
            const settings = {
                defaultCommissionRate: parseFloat(defaultRate),
                minCommissionRate: parseFloat(minRate),
                updatedAt: new Date().toISOString()
            };
            
            // L∆∞u v√†o Firebase
            if (typeof database !== 'undefined' && database) {
                database.ref('settings/finance').set(settings)
                    .then(() => {
                        showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t hoa h·ªìng l√™n Firebase th√†nh c√¥ng', 'success');
                        console.log('üíæ Commission settings saved to Firebase:', settings);
                        
                        // H·ªèi ng∆∞·ªùi d√πng c√≥ mu·ªën c·∫≠p nh·∫≠t ƒë·ªìng lo·∫°t cho t·∫•t c·∫£ ƒë·ªëi t√°c kh√¥ng
                        if (confirm(`B·∫°n c√≥ mu·ªën c·∫≠p nh·∫≠t t·ª∑ l·ªá hoa h·ªìng ${defaultRate}% cho t·∫•t c·∫£ ƒë·ªëi t√°c hi·ªán t·∫°i kh√¥ng?`)) {
                            updateAllAffiliateCommissions(parseFloat(defaultRate));
                        }
                    })
                    .catch((error) => {
                        showNotification('L·ªói khi l∆∞u c√†i ƒë·∫∑t l√™n Firebase', 'error');
                        console.error('‚ùå Error saving to Firebase:', error);
                        
                        // Fallback: l∆∞u v√†o localStorage
                        localStorage.setItem('financeSettings', JSON.stringify(settings));
                        showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t hoa h·ªìng (local)', 'warning');
                    });
            } else {
                // Fallback: l∆∞u v√†o localStorage n·∫øu Firebase kh√¥ng c√≥
                localStorage.setItem('financeSettings', JSON.stringify(settings));
                showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t hoa h·ªìng (local)', 'warning');
                console.log('üíæ Commission settings saved (local):', settings);
            }
        }
        
        // H√†m l∆∞u c√†i ƒë·∫∑t thanh to√°n
        function savePaymentSettings() {
            const autoPayment = document.getElementById('autoPayment').checked;
            const paymentCycle = document.getElementById('paymentCycle').value;
            
            const settings = {
                autoPayment: autoPayment,
                paymentCycle: paymentCycle,
                updatedAt: new Date().toISOString()
            };
            
            // L∆∞u v√†o localStorage
            localStorage.setItem('paymentSettings', JSON.stringify(settings));
            
            showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t thanh to√°n th√†nh c√¥ng', 'success');
            console.log('üíæ Payment settings saved:', settings);
        }
        
        // H√†m l∆∞u c√†i ƒë·∫∑t th√¥ng b√°o
        function saveNotificationSettings() {
            const revenueAlert = document.getElementById('revenueAlert').checked;
            const reconcileAlert = document.getElementById('reconcileAlert').checked;
            const paymentAlert = document.getElementById('paymentAlert').checked;
            
            const settings = {
                revenueAlert: revenueAlert,
                reconcileAlert: reconcileAlert,
                paymentAlert: paymentAlert,
                updatedAt: new Date().toISOString()
            };
            
            // L∆∞u v√†o localStorage
            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            
            showNotification('ƒê√£ l∆∞u c√†i ƒë·∫∑t th√¥ng b√°o th√†nh c√¥ng', 'success');
            console.log('üíæ Notification settings saved:', settings);
        }
        
        // H√†m c·∫≠p nh·∫≠t ƒë·ªìng lo·∫°t t·ª∑ l·ªá hoa h·ªìng cho t·∫•t c·∫£ ƒë·ªëi t√°c
        function updateAllAffiliateCommissions(newRate) {
            if (typeof database !== 'undefined' && database) {
                console.log(`üîÑ Updating commission rate to ${newRate}% for all affiliates...`);
                
                const partnersRef = database.ref('affiliatePartners');
                partnersRef.once('value', (snapshot) => {
                    const updates = {};
                    let updateCount = 0;
                    
                    snapshot.forEach((child) => {
                        updates[`${child.key}/commission`] = newRate;
                        updates[`${child.key}/updatedAt`] = new Date().toISOString();
                        updateCount++;
                    });
                    
                    if (updateCount > 0) {
                        partnersRef.update(updates)
                            .then(() => {
                                showNotification(`ƒê√£ c·∫≠p nh·∫≠t t·ª∑ l·ªá hoa h·ªìng ${newRate}% cho ${updateCount} ƒë·ªëi t√°c`, 'success');
                                console.log(`‚úÖ Updated ${updateCount} affiliates with ${newRate}% commission`);
                                
                                // Reload affiliate partners data
                                loadAffiliatePartners();
                            })
                            .catch((error) => {
                                showNotification('L·ªói khi c·∫≠p nh·∫≠t t·ª∑ l·ªá hoa h·ªìng cho ƒë·ªëi t√°c', 'error');
                                console.error('‚ùå Error updating affiliate commissions:', error);
                            });
                    } else {
                        showNotification('Kh√¥ng c√≥ ƒë·ªëi t√°c n√†o ƒë·ªÉ c·∫≠p nh·∫≠t', 'warning');
                    }
                });
            } else {
                showNotification('Kh√¥ng th·ªÉ k·∫øt n·ªëi Firebase ƒë·ªÉ c·∫≠p nh·∫≠t ƒë·ªëi t√°c', 'error');
            }
        }
        
        // H√†m load c√†i ƒë·∫∑t t·ª´ Firebase
        function loadSettingsFromFirebase() {
            if (typeof database !== 'undefined' && database) {
                database.ref('settings/finance').once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const settings = snapshot.val();
                        console.log('üì• Loaded settings from Firebase:', settings);
                        
                        if (settings.defaultCommissionRate) {
                            document.getElementById('defaultCommissionRate').value = settings.defaultCommissionRate;
                        }
                        if (settings.minCommissionRate) {
                            document.getElementById('minCommissionRate').value = settings.minCommissionRate;
                        }
                        
                        showNotification('ƒê√£ t·∫£i c√†i ƒë·∫∑t t·ª´ Firebase th√†nh c√¥ng', 'success');
                    } else {
                        console.log('üìù No settings found in Firebase, using local settings');
                        loadSettingsFromLocal();
                    }
                }).catch((error) => {
                    console.error('‚ùå Error loading settings from Firebase:', error);
                    loadSettingsFromLocal();
                });
            } else {
                loadSettingsFromLocal();
            }
        }
        
        // H√†m load c√†i ƒë·∫∑t t·ª´ localStorage (fallback)
        function loadSettingsFromLocal() {
            const financeSettings = JSON.parse(localStorage.getItem('financeSettings') || '{}');
            if (financeSettings.defaultCommissionRate) {
                document.getElementById('defaultCommissionRate').value = financeSettings.defaultCommissionRate;
            }
            if (financeSettings.minCommissionRate) {
                document.getElementById('minCommissionRate').value = financeSettings.minCommissionRate;
            }
        }
        
        // H√†m c·∫≠p nh·∫≠t Dashboard
        function updateDashboard() {
            console.log('üîÑ Updating dashboard...');
            
            // C·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng quan
            updateDashboardStats();
            
            // C·∫≠p nh·∫≠t top kh√°ch s·∫°n
            updateTopHotels();
            
            // C·∫≠p nh·∫≠t top ƒë·ªëi t√°c
            updateTopPartners();
            
            // C·∫≠p nh·∫≠t giao d·ªãch g·∫ßn ƒë√¢y
            updateRecentTransactions();
            
            // C·∫≠p nh·∫≠t ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
            updateRecentActivities();
        }
        
        // H√†m c·∫≠p nh·∫≠t th·ªëng k√™ Dashboard
        function updateDashboardStats() {
            const stats = realtimeData.revenueStats;
            const monthly = realtimeData.monthlyStats;
            
            // Doanh thu th√°ng n√†y
            document.getElementById('monthlyRevenue').textContent = formatCurrency(monthly.currentMonth);
            
            // T√≠nh tƒÉng tr∆∞·ªüng
            const growth = monthly.currentMonth > 0 ? ((monthly.currentMonth - monthly.previousMonth) / monthly.previousMonth * 100).toFixed(1) : 0;
            const growthText = growth >= 0 ? `+${growth}%` : `${growth}%`;
            document.getElementById('revenueGrowth').textContent = `${growthText} so v·ªõi th√°ng tr∆∞·ªõc`;
            
            // Hoa h·ªìng ch·ªù thanh to√°n
            const pendingCommission = stats.totalRevenue * 0.15; // 15% hoa h·ªìng
            document.getElementById('pendingCommission').textContent = formatCurrency(pendingCommission);
            document.getElementById('commissionCount').textContent = `${Object.keys(affiliatePartners).length} kh√°ch s·∫°n`;
            
            // Booking kh√°ch s·∫°n
            document.getElementById('hotelBookings').textContent = stats.hotelBookings;
            const hotelRevenue = stats.hotelBookings * 1000000; // ∆Ø·ªõc t√≠nh
            document.getElementById('hotelRevenue').textContent = formatCurrency(hotelRevenue);
            
            // Booking tour
            document.getElementById('tourBookings').textContent = stats.tourBookings;
            const tourRevenue = stats.tourBookings * 500000; // ∆Ø·ªõc t√≠nh
            document.getElementById('tourRevenue').textContent = formatCurrency(tourRevenue);
            
            // Ph√¢n b·ªë doanh thu
            const totalRevenue = stats.totalRevenue;
            const hotelPercentage = totalRevenue > 0 ? Math.round((hotelRevenue / totalRevenue) * 100) : 0;
            const tourPercentage = totalRevenue > 0 ? Math.round((tourRevenue / totalRevenue) * 100) : 0;
            
            document.getElementById('hotelPercentage').textContent = `${hotelPercentage}%`;
            document.getElementById('tourPercentage').textContent = `${tourPercentage}%`;
            
            // Progress bar
            const target = 2500000000; // 2.5 t·ª∑
            const progress = totalRevenue > 0 ? Math.min((totalRevenue / target) * 100, 100) : 0;
            document.getElementById('revenueProgress').style.width = `${progress}%`;
            
            // Giao d·ªãch VNPay
            document.getElementById('vnpaySuccess').textContent = stats.vnpayPayments;
            document.getElementById('vnpayFailed').textContent = '0'; // M·∫∑c ƒë·ªãnh 0 th·∫•t b·∫°i
        }
        
        // H√†m c·∫≠p nh·∫≠t top kh√°ch s·∫°n
        function updateTopHotels() {
            const topHotelsDiv = document.getElementById('topHotels');
            if (!topHotelsDiv) return;
            
            // L·∫•y top 3 kh√°ch s·∫°n t·ª´ d·ªØ li·ªáu
            const hotelBookings = Object.values(realtimeData.bookings).filter(booking => 
                booking.bookingType === 'hotel' && booking.paymentStatus === 'paid'
            );
            
            const hotelStats = {};
            hotelBookings.forEach(booking => {
                const hotelName = booking.hotelName;
                if (!hotelStats[hotelName]) {
                    hotelStats[hotelName] = { revenue: 0, bookings: 0 };
                }
                hotelStats[hotelName].revenue += booking.totalPrice || 0;
                hotelStats[hotelName].bookings++;
            });
            
            const topHotels = Object.entries(hotelStats)
                .sort(([,a], [,b]) => b.revenue - a.revenue)
                .slice(0, 3);
            
            if (topHotels.length === 0) {
                topHotelsDiv.innerHTML = '<div class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu kh√°ch s·∫°n</div>';
                return;
            }
            
            let html = '';
            topHotels.forEach(([hotelName, stats], index) => {
                const maxRevenue = topHotels[0][1].revenue;
                const percentage = maxRevenue > 0 ? (stats.revenue / maxRevenue * 100) : 0;
                const colors = ['var(--accent)', 'var(--accent2)', '#28a745'];
                
                html += `
                    <div class="metric-card">
                        <div class="d-flex justify-content-between">
                            <span>${hotelName}</span>
                            <span class="fw-bold">${formatCurrency(stats.revenue)}</span>
                        </div>
                        <div class="progress-custom mt-2">
                            <div class="progress-bar-custom" style="width: ${percentage}%; background: ${colors[index]};"></div>
                        </div>
                        <small class="text-muted">${stats.bookings} booking</small>
                    </div>
                `;
            });
            
            topHotelsDiv.innerHTML = html;
        }
        
        // H√†m c·∫≠p nh·∫≠t top ƒë·ªëi t√°c
        function updateTopPartners() {
            const topPartnersDiv = document.getElementById('topPartners');
            if (!topPartnersDiv) return;
            
            if (affiliatePartners.length === 0) {
                topPartnersDiv.innerHTML = '<div class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªëi t√°c</div>';
                return;
            }
            
            const topPartners = affiliatePartners
                .sort((a, b) => {
                    const revenueA = parseFloat(a.revenue.replace(/[^\d]/g, '')) || 0;
                    const revenueB = parseFloat(b.revenue.replace(/[^\d]/g, '')) || 0;
                    return revenueB - revenueA;
                })
                .slice(0, 3);
            
            let html = '';
            topPartners.forEach((partner, index) => {
                const revenue = parseFloat(partner.revenue.replace(/[^\d]/g, '')) || 0;
                const maxRevenue = parseFloat(topPartners[0].revenue.replace(/[^\d]/g, '')) || 0;
                const percentage = maxRevenue > 0 ? (revenue / maxRevenue * 100) : 0;
                const colors = ['var(--accent)', 'var(--accent2)', '#28a745'];
                
                html += `
                    <div class="metric-card">
                        <div class="d-flex justify-content-between">
                            <span>${partner.name}</span>
                            <span class="fw-bold">${partner.revenue}</span>
                        </div>
                        <div class="progress-custom mt-2">
                            <div class="progress-bar-custom" style="width: ${percentage}%; background: ${colors[index]};"></div>
                        </div>
                        <small class="text-muted">${partner.commission}% hoa h·ªìng</small>
                    </div>
                `;
            });
            
            topPartnersDiv.innerHTML = html;
        }
        
        // H√†m c·∫≠p nh·∫≠t giao d·ªãch g·∫ßn ƒë√¢y
        function updateRecentTransactions() {
            const tbody = document.getElementById('recentTransactions');
            if (!tbody) return;
            
            const allBookings = Object.values(realtimeData.bookings)
                .filter(booking => booking.paymentStatus === 'paid')
                .sort((a, b) => b.createdAt - a.createdAt)
                .slice(0, 5);
            
            if (allBookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
                return;
            }
            
            let html = '';
            allBookings.forEach(booking => {
                const date = new Date(booking.createdAt);
                const timeStr = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const itemName = booking.hotelName || booking.tourName;
                const status = booking.paymentStatus === 'paid' ? 'bg-success' : 'bg-warning';
                const statusText = booking.paymentStatus === 'paid' ? 'Th√†nh c√¥ng' : 'ƒêang x·ª≠ l√Ω';
                
                html += `
                    <tr>
                        <td>${timeStr}</td>
                        <td>${itemName}</td>
                        <td>${booking.customerName}</td>
                        <td class="text-success">+${formatCurrency(booking.totalPrice)}</td>
                        <td><span class="badge ${status}">${statusText}</span></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // H√†m c·∫≠p nh·∫≠t ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
        function updateRecentActivities() {
            const activitiesDiv = document.getElementById('recentActivities');
            if (!activitiesDiv) return;
            
            const activities = [
                {
                    icon: 'fas fa-check',
                    bgColor: 'bg-success',
                    title: 'ƒê·ªëi so√°t th√†nh c√¥ng',
                    time: '2 ph√∫t tr∆∞·ªõc'
                },
                {
                    icon: 'fas fa-exclamation',
                    bgColor: 'bg-warning',
                    title: 'Ch√™nh l·ªách ph√°t hi·ªán',
                    time: '15 ph√∫t tr∆∞·ªõc'
                },
                {
                    icon: 'fas fa-credit-card',
                    bgColor: 'bg-info',
                    title: 'Thanh to√°n hoa h·ªìng',
                    time: '1 gi·ªù tr∆∞·ªõc'
                },
                {
                    icon: 'fas fa-chart-line',
                    bgColor: 'bg-primary',
                    title: 'B√°o c√°o th√°ng ƒë∆∞·ª£c t·∫°o',
                    time: '2 gi·ªù tr∆∞·ªõc'
                }
            ];
            
            let html = '';
            activities.forEach(activity => {
                html += `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.bgColor}">
                            <i class="${activity.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </div>
                `;
            });
            
            activitiesDiv.innerHTML = html;
        }
        
        // H√†m load c√†i ƒë·∫∑t khi kh·ªüi t·∫°o
        function loadSettings() {
            // Load commission settings from Firebase (with local fallback)
            loadSettingsFromFirebase();
            
            // Load payment settings
            const paymentSettings = JSON.parse(localStorage.getItem('paymentSettings') || '{}');
            if (paymentSettings.autoPayment !== undefined) {
                document.getElementById('autoPayment').checked = paymentSettings.autoPayment;
            }
            if (paymentSettings.paymentCycle) {
                document.getElementById('paymentCycle').value = paymentSettings.paymentCycle;
            }
            
            // Load notification settings
            const notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{}');
            if (notificationSettings.revenueAlert !== undefined) {
                document.getElementById('revenueAlert').checked = notificationSettings.revenueAlert;
            }
            if (notificationSettings.reconcileAlert !== undefined) {
                document.getElementById('reconcileAlert').checked = notificationSettings.reconcileAlert;
            }
            if (notificationSettings.paymentAlert !== undefined) {
                document.getElementById('paymentAlert').checked = notificationSettings.paymentAlert;
            }
        }
    </script>
</body>
</html>