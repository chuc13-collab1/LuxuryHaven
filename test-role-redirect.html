<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Role Redirect Logic</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <h1>Test Role Redirect Logic</h1>
    <div id="test-results"></div>

    <script>
        // Firebase cấu hình
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.appspot.com",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);

        // Hàm ánh xạ chức vụ với trang tương ứng (copy từ auth.html)
        function getPageByRole(role) {
            const rolePageMap = {
                // Ánh xạ theo tên chức vụ đầy đủ
                'Quản lý đối tác': 'QLNV/affiliate-manager.html',
                'Kiểm duyệt đặt phòng': 'QLNV/booking-moderator.html',
                'Tuân thủ pháp lý': 'QLNV/compliance-officer.html',
                'Quản lý nội dung': 'QLNV/content-admin.html',
                'Hỗ trợ khách hàng': 'QLNV/customer-support.html',
                'Phân tích dữ liệu': 'QLNV/data-analyst.html',
                'Quản lý tài chính': 'QLNV/finance-manager.html',
                'Marketing & SEO': 'QLNV/marketing-seo.html',
                'Dashboard nhân viên': 'QLNV/staff-dashboard.html',
                'Phát triển web': 'QLNV/web-developer.html',
                'Lễ tân (Front Desk)': 'QLNV/staff-dashboard.html',
                'Nhân viên lễ tân': 'QLNV/staff-dashboard.html',
                'nhân viên': 'QLNV/staff-dashboard.html',
                'trưởng phòng': 'QLNV/staff-dashboard.html',
                'phó trưởng phòng': 'QLNV/staff-dashboard.html',
                
                // Ánh xạ theo code chức vụ từ Firebase
                'LT0001': 'QLNV/staff-dashboard.html', // Nhân viên lễ tân
                'QL01': 'QLNV/affiliate-manager.html', // Quản lý đối tác
                'KD01': 'QLNV/booking-moderator.html', // Kiểm duyệt đặt phòng
                'PL01': 'QLNV/compliance-officer.html', // Tuân thủ pháp lý
                'HT01': 'QLNV/customer-support.html', // Hỗ trợ khách hàng
                'PT01': 'QLNV/data-analyst.html', // Phân tích dữ liệu
                'QLTC01': 'QLNV/finance-manager.html', // Quản lý tài chính
                'MK01': 'QLNV/marketing-seo.html', // Marketing & SEO
                'NV01': 'QLNV/staff-dashboard.html', // nhân viên
                'PTW01': 'QLNV/web-developer.html', // Phát triển web
                'QL02': 'QLNV/affiliate-manager.html', // phó trưởng phòng
                'Pl1': 'QLNV/compliance-officer.html', // trưởng phòng pháp lý
                
                // Department codes (fallback)
                '01': 'QLNV/staff-dashboard.html', // Lễ tân
                
                // Ánh xạ theo code chức vụ (legacy)
                'cskh': 'QLNV/customer-support.html',
                'manager': 'QLNV/staff-dashboard.html',
                'marketing': 'QLNV/marketing-seo.html',
                'kythuat': 'QLNV/web-developer.html',
                'admin': 'admin-dashboard.html',
                'receptionist': 'QLNV/staff-dashboard.html',
                'housekeeping': 'QLNV/staff-dashboard.html',
                'affiliate': 'QLNV/affiliate-manager.html',
                'content': 'QLNV/content-admin.html',
                'finance': 'QLNV/finance-manager.html',
                'analyst': 'QLNV/data-analyst.html',
                'compliance': 'QLNV/compliance-officer.html',
                'booking': 'QLNV/booking-moderator.html'
            };
            return rolePageMap[role] || 'index.html';
        }

        // Hàm kiểm tra chức vụ từ Firebase và chuyển hướng (copy từ auth.html)
        function checkUserRoleAndRedirect(email) {
            // Kiểm tra admin trước
            if (email === 'quantrikhachsan@gmail.com') {
                return Promise.resolve('admin-dashboard.html');
            }

            // Tìm kiếm trong danh sách nhân viên
            return Promise.all([
                firebase.database().ref('staff').once('value'),
                firebase.database().ref('roles').once('value')
            ])
                .then(([staffSnapshot, rolesSnapshot]) => {
                    const staffData = staffSnapshot.val();
                    const rolesData = rolesSnapshot.val();
                    
                    if (!staffData) {
                        console.log('Không tìm thấy dữ liệu nhân viên');
                        return 'index.html';
                    }

                    // Tạo map role code -> role name
                    const roleCodeToName = {};
                    if (rolesData) {
                        Object.values(rolesData).forEach(role => {
                            if (role.code && role.name) {
                                roleCodeToName[role.code] = role.name;
                            }
                        });
                    }

                    // Tìm nhân viên có email khớp
                    for (let staffId in staffData) {
                        const staff = staffData[staffId];
                        // Kiểm tra cả email và êmmail (typo)
                        const staffEmail = staff.email || staff.êmmail || staff['êmmail'];
                        if (staffEmail === email) {
                            console.log('Tìm thấy nhân viên:', staff);
                            
                            let role = staff.role || staff.chucVu;
                            if (role) {
                                // Nếu role là code, chuyển đổi thành tên đầy đủ
                                const fullRoleName = roleCodeToName[role] || role;
                                console.log('Role code:', role, 'Full name:', fullRoleName);
                                
                                // Thử với cả tên đầy đủ và code
                                const page = getPageByRole(fullRoleName) !== 'index.html' 
                                    ? getPageByRole(fullRoleName) 
                                    : getPageByRole(role);
                                
                                console.log('Chuyển hướng đến:', page);
                                return page;
                            }
                            break;
                        }
                    }
                    
                    console.log('Không tìm thấy chức vụ, chuyển về index');
                    return 'index.html';
                })
                .catch((error) => {
                    console.error('Lỗi khi kiểm tra chức vụ:', error);
                    return 'index.html';
                });
        }

        // Test function
        async function testRedirectLogic() {
            const testEmails = [
                'quantrikhachsan@gmail.com', // Admin
                'cheesleenh021@gmail.com', // Staff có trong Firebase với role LT0001
                'nhanvien1@luxuryhaven.com', // Test
                'nonexistent@email.com' // Không tồn tại
            ];

            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h2>Kết quả test:</h2>';

            for (let email of testEmails) {
                try {
                    const redirectPage = await checkUserRoleAndRedirect(email);
                    resultsDiv.innerHTML += `<p><strong>${email}</strong> → ${redirectPage}</p>`;
                } catch (error) {
                    resultsDiv.innerHTML += `<p><strong>${email}</strong> → Error: ${error.message}</p>`;
                }
            }
        }

        // Chạy test khi trang load
        window.addEventListener('load', () => {
            setTimeout(testRedirectLogic, 1000); // Đợi Firebase khởi tạo
        });
    </script>
</body>
</html>
