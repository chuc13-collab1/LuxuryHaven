<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang c√° nh√¢n - Luxury Haven Travel</title>
    <link rel="icon" type="image/x-icon" href="images/LuxuryHavenTravel.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Th√™m SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="css/member.css">
    <link rel="stylesheet" href="css\chatbox.css">
    <script type="module" src="js/search.js"></script>
    <script src="js/mobile.js"></script>
    <link rel="stylesheet" href="css\mobile.css">
    <link rel="stylesheet" href="css/loading.css">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
    <script src="js/loading.js"></script>
    <style>
    
    .loyalty-container {
      max-width: 600px;
      margin: 40px auto 0 auto;
      background: #fffbe6;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.10);
      padding: 32px 24px 24px 24px;
    }
    .loyalty-header {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    .loyalty-box {
      min-width: 160px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 18px 24px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .loyalty-box.point {
      background: #fff3e0;
    }
    .loyalty-box.rank {
      background: #e3f2fd;
    }
    .loyalty-box i {
      font-size: 2.2em;
      margin-bottom: 6px;
    }
    .loyalty-value {
      font-size: 2em;
      font-weight: 700;
      color: #e67e22;
    }
    .loyalty-box.rank .loyalty-value {
      color: #1a237e;
    }
    .loyalty-label {
      font-size: 1em;
      color: #888;
      margin-top: 2px;
    }
    .barcode-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      padding: 24px 12px 16px 12px;
      margin-top: 12px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #user-barcode {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
    }
    .barcode-label {
      font-size: 1em;
      color: #888;
      margin-top: 8px;
    }
    @media (max-width: 700px) {
      .loyalty-header {
        flex-direction: column;
        gap: 16px;
      }
      .loyalty-container {
        padding: 16px 4px 12px 4px;
      }
      .barcode-card {
        padding: 16px 2px 10px 2px;
      }
    }
    @media (max-width: 768px) {
      #mobile-tab-menu {
        display: flex !important;
        gap: 2px;
        padding: 0 2px;
        height: 54px;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      }
      .mobile-tab-link {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 64px;
        padding: 0 10px;
        height: 54px;
        color: #1a237e;
        font-size: 0.92em;
        text-decoration: none;
        border-bottom: 2px solid transparent;
        background: none;
        transition: color 0.2s, border 0.2s;
      }
      .mobile-tab-link.active, .mobile-tab-link:active, .mobile-tab-link:focus {
        color: #e67e22;
        border-bottom: 2px solid #e67e22;
        background: #f9f9f9;
      }
      .mobile-tab-link i {
        font-size: 1.2em;
        margin-bottom: 2px;
      }
      .mobile-tab-link span {
        font-size: 0.85em;
        line-height: 1;
      }
      /* ·∫®n menu d·ªçc sidebar tr√™n mobile */
      .col-md-3 .list-group { display: none !important; }
    }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <dotlottie-wc 
            src="https://lottie.host/22866d75-292a-42dc-ae8a-72f6f903386d/dwhv5hvZ72.lottie" 
            style="width: 300px; height: 300px" 
            speed="1" 
            autoplay 
            loop>
        </dotlottie-wc>
        <div class="loading-text">LuxuryHavenTravel</div>
        <div class="loading-subtext">ƒêang t·∫£i n·ªôi dung...</div>
    </div>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-flex">
                <!-- Logo -->
                <a class="navbar-brand" href="#">
                    <img src="images/LuxuryHavenTravel.png" alt="LuxuryHaven Logo">
                </a>
                <!-- Mobile Menu Button -->
                <button class="mobile-menu-btn" id="mobile-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <!-- Search Box -->
<div class="nav-search">
    <div class="search-input-group">
        <input type="text" placeholder="T√¨m ki·∫øm..." id="main-search-input" autocomplete="off">
        <button type="button" id="main-search-btn">
            <i class="fas fa-search"></i>
        </button>
    </div>
</div>
                <div class="nav-right">
                    <ul class="nav-links" id="nav-links">
                        <li><a href="index.html" class="active">Trang ch·ªß</a></li>
                        <li><a href="hotel.html">Kh√°ch s·∫°n</a></li>

                        <li class="dropdown"><a href="tours.html">Tours</a></li>

                        <li class="dropdown"><a href="prioritize.html">∆Øu ƒë√£i</a></li>
                        <li class="dropdown"><a href="travel_guide.html">C·∫©m nang du l·ªãch</a></li>
                        <li class="dropdown"><a href="about_us.html">V·ªÅ ch√∫ng t√¥i</a></li>
                        <!-- <li class="dropdown"><a href="vuichoi.html">üåê</a></li> -->
                        <li>
                            <div class="d-flex align-items-center">
                                <div class="dropdown" id="user-dropdown" style="display:none;">
                                    <button class="btn btn-outline-primary dropdown-toggle" type="button"
                                        id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-user"></i> <span id="user-name"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                        <li><a class="dropdown-item" href="member.html"><i
                                                    class="fas fa-user-circle"></i> T√†i kho·∫£n</a></li>
                                        <li><a class="dropdown-item" href="#" id="logout-btn"><i
                                                    class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
                                    </ul>
                                </div>
                                <a href="auth.html" class="btn btn-outline-primary me-2" id="login-btn">
                                    <i class="fas fa-user"></i> ƒêƒÉng nh·∫≠p
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <div class="container" style="margin-top: 120px;">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div class="avatar-wrapper mb-3">
                                    <img id="sidebar-avatar" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y"
                                        alt="Avatar" class="rounded-circle"
                                        style="width: 100px; height: 100px; object-fit: cover;"
                                        onerror="this.src='https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y'">
                                    <label for="sidebar-avatar-upload" style="position:absolute;bottom:0;right:0;cursor:pointer;background:#fff;border-radius:50%;padding:4px;">
                                        <i class="fas fa-camera" style="font-size:18px;color:#1a237e;"></i>
                                    </label>
                                    <input type="file" id="sidebar-avatar-upload" accept="image/*" style="display:none;">
                                </div>
                                <h5 class="mb-1" id="sidebar-user-name">T√™n ng∆∞·ªùi d√πng</h5>
                                <p class="text-muted" id="sidebar-user-email">email@example.com</p>
                                <div id="sidebar-memberLevel" style="font-weight:600;color:#1a237e;"></div>
                                <div id="sidebar-loyaltyPoints" style="color:#e67e22;"></div>
                            </div>
                            <div class="list-group">
                                <a href="#profile" class="list-group-item list-group-item-action active"
                                    data-bs-toggle="list">
                                    <i class="fas fa-user me-2"></i> Th√¥ng tin c√° nh√¢n
                                </a>
                                <a href="#bookings" class="list-group-item list-group-item-action"
                                    data-bs-toggle="list">
                                    <i class="fas fa-calendar-alt me-2"></i> L·ªãch s·ª≠
                                </a>
                                <a href="#loyalty" class="list-group-item list-group-item-action"
                                    data-bs-toggle="list">
                                    <i class="fas fa-star me-2"></i> ƒêi·ªÉm th√†nh vi√™n
                                </a>
                                <a href="#favorites" class="list-group-item list-group-item-action"
                                    data-bs-toggle="list">
                                    <i class="fas fa-heart me-2"></i> Danh s√°ch y√™u th√≠ch
                                </a>
                                <a href="#reviews" class="list-group-item list-group-item-action" data-bs-toggle="list">
                                    <i class="fas fa-star me-2"></i> ƒê√°nh gi√° c·ªßa t√¥i
                                </a>
                                <a href="#settings" class="list-group-item list-group-item-action"
                                    data-bs-toggle="list">
                                    <i class="fas fa-cog me-2"></i> C√†i ƒë·∫∑t t√†i kho·∫£n
                                </a>
                                <li><a href="#payments" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-file-invoice-dollar me-2"></i> L·ªãch s·ª≠ thanh to√°n</a></li>
                                <!-- <li><a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-bell me-2"></i> Th√¥ng b√°o</a></li> -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-9">
                    <div class="tab-content">
                        <!-- Profile Tab -->
                        <div class="tab-pane fade show active" id="profile">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">Th√¥ng tin c√° nh√¢n</h4>
                                    <form id="profile-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">H·ªç v√† t√™n</label>
                                                <input type="text" class="form-control" id="profile-name">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" id="profile-email" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                                <input type="tel" class="form-control" id="profile-phone">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Ng√†y sinh</label>
                                                <input type="date" class="form-control" id="profile-birthday">
                                            </div>
                                            <div class="col-12 mb-3">
                                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                                <textarea class="form-control" id="profile-address" rows="2"></textarea>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Gi·ªõi t√≠nh</label>
                                                <select class="form-control" id="profile-gender">
                                                    <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                                    <option value="Nam">Nam</option>
                                                    <option value="N·ªØ">N·ªØ</option>
                                                    <option value="Kh√°c">Kh√°c</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Qu·ªëc t·ªãch</label>
                                                <input type="text" class="form-control" id="profile-nationality">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">S·ªë CMND/CCCD</label>
                                                <input type="text" class="form-control" id="profile-identityNumber">
                                            </div>
                                           
                                            <div class="col-12">
                                                <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Loyalty Tab (ƒêi·ªÉm th√†nh vi√™n) -->
                        <div class="tab-pane fade" id="loyalty">
                            <div class="loyalty-container">
                                <div class="loyalty-header">
                                    <div class="loyalty-box point">
                                        <i class="fas fa-star"></i>
                                        <span class="loyalty-value" id="profile-loyaltyPoints">0</span>
                                        <div class="loyalty-label">ƒêi·ªÉm th√†nh vi√™n</div>
                                    </div>
                                    <div class="loyalty-box rank">
                                        <i class="fas fa-medal"></i>
                                        <span class="loyalty-value" id="profile-memberLevel"></span>
                                        <div class="loyalty-label">H·∫°ng th√†nh vi√™n</div>
                                    </div>
                                </div>
                                <div class="barcode-card">
                                    <svg id="user-barcode"></svg>
                                    <div class="barcode-label">M√£ v·∫°ch c√° nh√¢n - Qu√©t t·∫°i qu·∫ßy ƒë·ªÉ t√≠ch ƒëi·ªÉm</div>
                                </div>
                            </div>
                        </div>

                        <!-- Bookings Tab -->
                        <div class="tab-pane fade" id="bookings">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">L·ªãch s·ª≠ ƒë·∫∑t ph√≤ng kh√°ch s·∫°n</h4>
                                    <div class="table-responsive">
                                        <button id="delete-selected-hotel" class="btn btn-danger btn-sm my-2" style="display:none;">X√≥a ƒë√£ ch·ªçn</button>
                                        <table class="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th><input type="checkbox" id="select-all-hotel"></th>
                                                    <th>Kh√°ch s·∫°n</th>
                                                    <th>Th√¥ng tin ph√≤ng</th>
                                                    <th>Th·ªùi gian</th>
                                                    <th>Th√¥ng tin kh√°ch</th>
                                                    <th>Tr·∫°ng th√°i</th>
                                                    <th>Thao t√°c</th>
                                                </tr>
                                            </thead>
                                            <tbody id="bookings-table-hotel">
                                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="card mt-4">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">L·ªãch s·ª≠ ƒë·∫∑t tour</h4>
                                    <div class="table-responsive">
                                        <button id="delete-selected-tour" class="btn btn-danger btn-sm my-2" style="display:none;">X√≥a ƒë√£ ch·ªçn</button>
                                        <table class="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th><input type="checkbox" id="select-all-tour"></th>
                                                    <th>T√™n tour</th>
                                                    <th>Ng√†y kh·ªüi h√†nh</th>
                                                    <th>S·ªë ng∆∞·ªùi</th>
                                                    <th>T√™n kh√°ch h√†ng</th>
                                                    <th>Tr·∫°ng th√°i</th>
                                                    <th>Thao t√°c</th>
                                                </tr>
                                            </thead>
                                            <tbody id="bookings-table-tour">
                                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Favorites Tab -->
                        <div class="tab-pane fade" id="favorites">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">Danh s√°ch y√™u th√≠ch</h4>
                                    <div class="row" id="favorites-list">
                                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reviews Tab -->
                        <div class="tab-pane fade" id="reviews">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">ƒê√°nh gi√° c·ªßa t√¥i</h4>
                                    <div id="reviews-list">
                                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Tab -->
                        <div class="tab-pane fade" id="settings">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">C√†i ƒë·∫∑t t√†i kho·∫£n</h4>
                                    <form id="settings-form">
                                        <div class="mb-3">
                                            <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                            <input type="password" class="form-control" id="current-password">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
                                            <input type="password" class="form-control" id="new-password">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                            <input type="password" class="form-control" id="confirm-password">
                                        </div>
                                        <button type="submit" class="btn btn-primary">ƒê·ªïi m·∫≠t kh·∫©u</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Payments Tab -->
                        <div class="tab-pane fade" id="payments">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">L·ªãch s·ª≠ thanh to√°n/giao d·ªãch</h4>
                                    <div class="table-responsive">
                                        <table class="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th>M√£ giao d·ªãch</th>
                                                    <th>Ng√†y</th>
                                                    <th>S·ªë ti·ªÅn</th>
                                                    <th>Ph∆∞∆°ng th·ª©c</th>
                                                    <th>Tr·∫°ng th√°i</th>
                                                    <th>H√≥a ƒë∆°n</th>
                                                </tr>
                                            </thead>
                                            <tbody id="payments-table">
                                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notifications Tab -->
                        <!-- <div class="tab-pane fade" id="notifications">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">Th√¥ng b√°o c√° nh√¢n</h4>
                                    <ul class="list-group" id="notifications-list">
                                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                    <!-- </ul>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- End Contact Section -->

   
    

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content"
            style="max-width: 400px; padding: 32px 28px 24px 28px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.18);">
            <span class="close" id="close-auth-modal" style="right: 18px; top: 12px; font-size: 32px;">&times;</span>

            <div id="auth-forms">
                <form id="login-form" class="auth-form" style="text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="login-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="email" id="login-email" placeholder="e.g. elon@tesla.com" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="login-password" style="font-weight: 500;">M·∫≠t kh·∫©u</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="login-password" placeholder="e.g. ilovemangools123" required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">ƒêƒÉng nh·∫≠p</button>
                    <div class="login-links">
                        <a href="#" id="to-register">Kh√¥ng c√≥ t√†i kho·∫£n?</a>
                        <a href="#" id="to-forgot">Qu√™n m·∫≠t kh·∫©u?</a>
                    </div>
                </form>

                <form id="register-form" class="auth-form" style="display: none; text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-username" style="font-weight: 500;">T√™n ng∆∞·ªùi d√πng</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="register-username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="register-email" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-password" style="font-weight: 500;">M·∫≠t kh·∫©u</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="register-password" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-confirm-password" style="font-weight: 500;">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="register-confirm-password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                                required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">ƒêƒÉng k√Ω</button>
                    <div class="login-links">
                        <a href="#" id="to-login">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</a>
                    </div>
                </form>

                <form id="forgot-form" class="auth-form" style="display: none; text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="forgot-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="forgot-email" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">G·ª≠i y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
                    <div class="login-links">
                        <a href="#" id="back-to-login">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.appspot.com",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);

        // H√†m t·∫°o m√£ v·∫°ch c√° nh√¢n cho user
        function updateUserBarcode(user) {
            if (!user) return;
            var barcodeEl = document.getElementById('user-barcode');
            if (barcodeEl) {
                JsBarcode(barcodeEl, user.uid, {
                    format: "CODE128",
                    lineColor: "#1a237e",
                    width: 2,
                    height: 60,
                    displayValue: true,
                    fontSize: 16
                });
            }
        }
        // H√†m ƒë·ªìng b·ªô ƒëi·ªÉm v√† h·∫°ng th√†nh vi√™n v√†o tab loyalty
        function syncLoyaltyToBarcodeBox(userData) {
            document.getElementById('profile-loyaltyPoints').textContent = userData.loyaltyPoints || 0;
            document.getElementById('profile-memberLevel').textContent = userData.memberLevel || '';
        }

        // Theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√† c·∫≠p nh·∫≠t UI
        firebase.auth().onAuthStateChanged(function (user) {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // Ki·ªÉm tra v√† refresh token n·∫øu c·∫ßn
            user.getIdToken(true).then(() => {
                console.log('User authenticated:', user.uid);
                
                // C·∫≠p nh·∫≠t UI ƒëƒÉng nh·∫≠p
                updateUserUI(user);

                // L·∫•y v√† hi·ªÉn th·ªã d·ªØ li·ªáu
                loadUserData(user);
                loadBookings(user);
                loadFavorites(user);
                loadReviews(user);
                loadPayments(user);
                loadNotifications(user);
                updateUserBarcode(user); // G·ªçi updateUserBarcode khi user ƒëƒÉng nh·∫≠p
            }).catch(error => {
                console.error('Authentication error:', error);
                Swal.fire('L·ªói x√°c th·ª±c', 'Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error').then(() => {
                    firebase.auth().signOut().then(() => {
                        window.location.href = 'index.html';
                    });
                });
            });
        });

        // H√†m c·∫≠p nh·∫≠t UI ng∆∞·ªùi d√πng
        function updateUserUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userDropdown = document.getElementById('user-dropdown');
            const userName = document.getElementById('user-name');
            const sidebarName = document.getElementById('sidebar-user-name');
            const sidebarEmail = document.getElementById('sidebar-user-email');

            if (loginBtn) loginBtn.style.display = 'none';
            if (userDropdown) {
                userDropdown.style.display = 'block';
                if (userName) userName.textContent = user.displayName || user.email;
            }

            if (sidebarName) sidebarName.textContent = user.displayName || 'Ch∆∞a c·∫≠p nh·∫≠t';
            if (sidebarEmail) sidebarEmail.textContent = user.email;
        }

        // H√†m ƒë·ªìng b·ªô avatar cho t·∫•t c·∫£ ph·∫ßn t·ª≠
        function syncAllAvatars(avatarUrl) {
            const defaultAvatar = 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';
            const src = avatarUrl || defaultAvatar;
            
            // Desktop avatar
            const sidebarAvatar = document.getElementById('sidebar-avatar');
            if (sidebarAvatar) sidebarAvatar.src = src;
            
            // Mobile avatars
            const mobileAvatarImg = document.getElementById('mobile-avatar-img');
            if (mobileAvatarImg) mobileAvatarImg.src = src;
            
            const mobileSidebarAvatar = document.getElementById('mobile-sidebar-avatar');
            if (mobileSidebarAvatar) mobileSidebarAvatar.src = src;
        }

        // H√†m l·∫•y th√¥ng tin ng∆∞·ªùi d√πng
        function loadUserData(user) {
            const userRef = firebase.database().ref('users/' + user.uid);
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val() || {};

                document.getElementById('profile-name').value = userData.name || user.displayName || '';
                document.getElementById('profile-email').value = user.email;
                document.getElementById('profile-phone').value = userData.phone || '';
                document.getElementById('profile-birthday').value = userData.birthday || '';
                document.getElementById('profile-address').value = userData.address || '';
                document.getElementById('profile-gender').value = userData.gender || '';
                document.getElementById('profile-nationality').value = userData.nationality || '';
                document.getElementById('profile-identityNumber').value = userData.identityNumber || '';
                document.getElementById('profile-loyaltyPoints').textContent = userData.loyaltyPoints || 0;
                document.getElementById('profile-memberLevel').textContent = userData.memberLevel || '';

                // Sidebar
                document.getElementById('sidebar-user-name').textContent = userData.name || user.displayName || 'Ch∆∞a c·∫≠p nh·∫≠t';
                document.getElementById('sidebar-user-email').textContent = user.email;
                // Thay ƒë·ªïi d√≤ng n√†y ƒë·ªÉ c√≥ icon:
                document.getElementById('sidebar-memberLevel').innerHTML = userData.memberLevel ? getMemberLevelIcon(userData.memberLevel) : '';
                document.getElementById('sidebar-loyaltyPoints').textContent = userData.loyaltyPoints ? `ƒêi·ªÉm: ${userData.loyaltyPoints}` : '';
                
                // ƒê·ªìng b·ªô avatar cho t·∫•t c·∫£ ph·∫ßn t·ª≠ (desktop v√† mobile)
                syncAllAvatars(userData.avatar);

                // G·ªçi ph√¢n h·∫°ng t·ª± ƒë·ªông
                updateMemberLevel(user);
                syncLoyaltyToBarcodeBox(userData); // ƒê·ªìng b·ªô ƒëi·ªÉm v√† h·∫°ng th√†nh vi√™n v√†o barcode box
                
                // ƒê·ªìng b·ªô avatar cho mobile sidebar
                syncMobileSidebar(userData);
            });

            // X·ª≠ l√Ω form c·∫≠p nh·∫≠t th√¥ng tin
            document.getElementById('profile-form').addEventListener('submit', function (e) {
                e.preventDefault();
                // Ki·ªÉm tra d·ªØ li·ªáu nh·∫≠p v√†o
                const name = document.getElementById('profile-name').value.trim();
                const phone = document.getElementById('profile-phone').value.trim();
                const birthday = document.getElementById('profile-birthday').value.trim();
                const address = document.getElementById('profile-address').value.trim();
                const gender = document.getElementById('profile-gender').value.trim();
                const nationality = document.getElementById('profile-nationality').value.trim();
                const identity = document.getElementById('profile-identityNumber').value.trim();

                // Regex ki·ªÉm tra ƒë·ªãnh d·∫°ng
                const phoneRegex = /^(0[3-9][0-9]{8,9})$/;
                const identityRegex = /^\d{9,12}$/;
                const nameRegex = /^[a-zA-Z√Ä-·ªπ\s'.-]{2,}$/u;
                // ƒê·ªãa ch·ªâ: cho ph√©p nh·∫≠p t·ª± do, ch·ªâ ki·ªÉm tra kh√¥ng r·ªóng
                function isValidVietnamAddress(address) {
                    return !!address && address.length > 0;
                }
                const today = new Date();
                let valid = true;
                let msg = '';

                if (!name || !nameRegex.test(name)) {
                    valid = false;
                    msg = 'Vui l√≤ng nh·∫≠p h·ªç t√™n th·∫≠t, kh√¥ng ch·ª©a k√Ω t·ª± ƒë·∫∑c bi·ªát v√† t·ªëi thi·ªÉu 2 k√Ω t·ª±.';
                } else if (!phone || !phoneRegex.test(phone)) {
                    valid = false;
                    msg = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë Vi·ªát Nam h·ª£p l·ªá.';
                } else if (!birthday) {
                    valid = false;
                    msg = 'Vui l√≤ng nh·∫≠p ng√†y sinh.';
                } else if (new Date(birthday) > today) {
                    valid = false;
                    msg = 'Ng√†y sinh kh√¥ng h·ª£p l·ªá.';
                } else if (!address || !isValidVietnamAddress(address)) {
                    valid = false;
                    msg = 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ.';
                } else if (!nationality) {
                    valid = false;
                    msg = 'Vui l√≤ng nh·∫≠p qu·ªëc t·ªãch.';
                } else if (!identity || !identityRegex.test(identity)) {
                    valid = false;
                    msg = 'S·ªë CMND/CCCD ph·∫£i l√† 9-12 ch·ªØ s·ªë.';
                }

                if (!valid) {
                    Swal.fire({
                        title: 'Th√¥ng tin kh√¥ng h·ª£p l·ªá!',
                        text: msg,
                        icon: 'warning',
                        confirmButtonColor: '#1a237e'
                    });
                    return;
                }
                updateProfile(user, userRef);
            });
        }

        // H√†m l·∫•y l·ªãch s·ª≠ ƒë·∫∑t ph√≤ng
        function loadBookings(user) {
            const bookingsRef = firebase.database().ref('bookings');
            // T√¨m ki·∫øm theo userId thay v√¨ customerEmail ƒë·ªÉ ƒë·∫£m b·∫£o quy·ªÅn truy c·∫≠p
            bookingsRef.orderByChild('userId').equalTo(user.uid).on('value', (snapshot) => {
                const hotelTable = document.getElementById('bookings-table-hotel');
                const tourTable = document.getElementById('bookings-table-tour');
                if (!hotelTable || !tourTable) return;
                hotelTable.innerHTML = '';
                tourTable.innerHTML = '';
                if (snapshot.exists()) {
                    let bookings = [];
                    snapshot.forEach((bookingSnapshot) => {
                        bookings.push({
                            id: bookingSnapshot.key,
                            ...bookingSnapshot.val()
                        });
                    });
                    // S·∫Øp x·∫øp theo th·ªùi gian t·∫°o m·ªõi nh·∫•t
                    bookings.sort((a, b) => b.createdAt - a.createdAt);
                    let hasHotel = false, hasTour = false;
                    bookings.forEach(booking => {
                        if (booking.bookingType === 'tour') {
                            addTourBookingRow(booking, tourTable);
                            hasTour = true;
                        } else {
                            addBookingRow(booking, hotelTable);
                            hasHotel = true;
                        }
                    });
                    if (!hasHotel) hotelTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t ph√≤ng kh√°ch s·∫°n</td></tr>';
                    if (!hasTour) tourTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t tour</td></tr>';
                } else {
                    hotelTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t ph√≤ng kh√°ch s·∫°n</td></tr>';
                    tourTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t tour</td></tr>';
                }
            });
        }

        // H√†m th√™m h√†ng ƒë·∫∑t ph√≤ng v√†o b·∫£ng
        function addBookingRow(booking, table) {
            const row = document.createElement('tr');
            const bookingDate = new Date(booking.createdAt);
            const today = new Date();
            const checkInDate = new Date(booking.checkIn);

            // X√°c ƒë·ªãnh tr·∫°ng th√°i ƒë·∫∑t ph√≤ng
            let status = '';
            let statusClass = '';
            let refundInfo = '';
            
            if (booking.status === 'cancelled') {
                status = 'ƒê√£ h·ªßy';
                statusClass = 'secondary';
                
                // Th√™m th√¥ng tin ho√†n ti·ªÅn n·∫øu c√≥
                if (booking.refundStatus) {
                    const refundAmount = booking.refundAmount || 0;
                    const totalPrice = booking.totalPrice || booking.roomPrice || 0;
                    const refundStatus = getRefundStatusText(booking.refundStatus);
                    
                    refundInfo = `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-money-bill-wave me-1"></i>
                                Ho√†n ti·ªÅn: ${refundAmount.toLocaleString()} VNƒê 
                                <span class="badge bg-${getRefundStatusClass(booking.refundStatus)} ms-1">${refundStatus}</span>
                            </small>
                        </div>
                    `;
                }
            } else if (checkInDate < today) {
                status = 'ƒê√£ ho√†n th√†nh';
                statusClass = 'success';
            } else if (checkInDate > today) {
                status = 'S·∫Øp t·ªõi';
                statusClass = 'warning';
            } else {
                status = 'ƒêang di·ªÖn ra';
                statusClass = 'primary';
            }

            let actionButtons = `
                <button class="btn btn-sm btn-outline-primary" onclick="viewBookingDetails('${booking.id}')">
                    <i class="fas fa-info-circle me-1"></i> Chi ti·∫øt
                </button>
                <button class="btn btn-sm btn-outline-warning ms-1" onclick="editBooking('${booking.id}', 'hotel')">
                    <i class="fas fa-edit me-1"></i> S·ª≠a
                </button>
            `;
            // N√∫t H·ªßy: ch·ªâ hi·ªÉn th·ªã n·∫øu ch∆∞a b·ªã h·ªßy v√† ch∆∞a ho√†n th√†nh
            if (booking.status !== 'cancelled' && checkInDate > today) {
                actionButtons += `
                    <button class="btn btn-sm btn-outline-danger cancel-btn ms-1" onclick="cancelBooking('${booking.id}', 'hotel')">
                        <i class="fas fa-times-circle me-1"></i> H·ªßy
                    </button>
                `;
            }

            row.innerHTML = `
                <td><input type="checkbox" class="select-booking-hotel" value="${booking.id}"></td>
                <td><div class="fw-semibold">${booking.hotelName || booking.hotelId}</div></td>
                <td><div class="mb-1">${booking.roomId}</div></td>
                <td><div class="mb-1">Check-in: ${formatDate(booking.checkIn)}</div><div>Check-out: ${formatDate(booking.checkOut)}</div><small class="text-muted">ƒê·∫∑t ng√†y: ${formatDateTime(booking.createdAt)}</small></td>
                <td><div class="mb-1">Kh√°ch: ${booking.guests} ng∆∞·ªùi</div><div class="mb-1">T√™n: ${booking.customerName}</div><div>SƒêT: ${booking.customerPhone}</div></td>
                <td>
                    <span class="badge bg-${statusClass}">${status}</span>
                    ${refundInfo}
                </td>
                <td>${actionButtons}</td>
            `;
            table.appendChild(row);
        }

        // H√†m th√™m h√†ng ƒë·∫∑t tour v√†o b·∫£ng
        function addTourBookingRow(booking, table) {
            const row = document.createElement('tr');
            const departureDate = new Date(booking.checkIn);
            const today = new Date();
            let status = '';
            let statusClass = '';
            let refundInfo = '';
            
            if (booking.status === 'cancelled') {
                status = 'ƒê√£ h·ªßy';
                statusClass = 'secondary';
                
                // Th√™m th√¥ng tin ho√†n ti·ªÅn n·∫øu c√≥
                if (booking.refundStatus) {
                    const refundAmount = booking.refundAmount || 0;
                    const totalPrice = booking.totalPrice || booking.tourPrice || 0;
                    const refundStatus = getRefundStatusText(booking.refundStatus);
                    
                    refundInfo = `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-money-bill-wave me-1"></i>
                                Ho√†n ti·ªÅn: ${refundAmount.toLocaleString()} VNƒê 
                                <span class="badge bg-${getRefundStatusClass(booking.refundStatus)} ms-1">${refundStatus}</span>
                            </small>
                        </div>
                    `;
                }
            } else if (departureDate < today) {
                status = 'ƒê√£ ho√†n th√†nh';
                statusClass = 'success';
            } else if (departureDate.toDateString() === today.toDateString()) {
                status = 'ƒêang di·ªÖn ra';
                statusClass = 'primary';
            } else {
                status = 'S·∫Øp t·ªõi';
                statusClass = 'warning';
            }

            let actionButtons = `
                <button class="btn btn-sm btn-outline-primary" onclick="viewBookingDetails('${booking.id}')">
                    <i class="fas fa-info-circle me-1"></i> Chi ti·∫øt
                </button>
                <button class="btn btn-sm btn-outline-warning ms-1" onclick="editBooking('${booking.id}', 'tour')">
                    <i class="fas fa-edit me-1"></i> S·ª≠a
                </button>
            `;
            // N√∫t H·ªßy: ch·ªâ hi·ªÉn th·ªã n·∫øu ch∆∞a b·ªã h·ªßy v√† ch∆∞a ho√†n th√†nh
            if (booking.status !== 'cancelled' && departureDate > today) {
                actionButtons += `
                    <button class="btn btn-sm btn-outline-danger cancel-btn ms-1" onclick="cancelBooking('${booking.id}', 'tour')">
                        <i class="fas fa-times-circle me-1"></i> H·ªßy
                    </button>
                `;
            }

            row.innerHTML = `
                <td><input type="checkbox" class="select-booking-tour" value="${booking.id}"></td>
                <td><div class="fw-semibold">${booking.tourName || booking.hotelName || 'N/A'}</div><small class="text-muted">${booking.tourLocation || ''}</small></td>
                <td><div>${formatDate(booking.checkIn)}</div><small class="text-muted">ƒê·∫∑t ng√†y: ${formatDateTime(booking.createdAt)}</small></td>
                <td>${booking.numberOfGuests || booking.guests || 1}</td>
                <td>${booking.customerName || 'N/A'}</td>
                <td>
                    <span class="badge bg-${statusClass}">${status}</span>
                    ${refundInfo}
                </td>
                <td>${actionButtons}</td>
            `;
            table.appendChild(row);
        }

        // H√†m h·ªó tr·ª£ format ng√†y th√°ng
        function formatDate(dateString) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('vi-VN', options);
        }

        function formatDateTime(timestamp) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(timestamp).toLocaleDateString('vi-VN', options);
        }

        // H√†m helper cho tr·∫°ng th√°i ho√†n ti·ªÅn
        function getRefundStatusText(status) {
            const statusMap = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'processing': 'ƒêang x·ª≠ l√Ω',
                'completed': 'ƒê√£ ho√†n ti·ªÅn',
                'failed': 'Th·∫•t b·∫°i'
            };
            return statusMap[status] || 'Kh√¥ng x√°c ƒë·ªãnh';
        }

        function getRefundStatusClass(status) {
            const classMap = {
                'pending': 'warning',
                'processing': 'info',
                'completed': 'success',
                'failed': 'danger'
            };
            return classMap[status] || 'secondary';
        }

        // H√†m l·∫•y danh s√°ch y√™u th√≠ch
        function loadFavorites(user) {
            const favoritesRef = firebase.database().ref('favorites/' + user.uid);
            favoritesRef.on('value', (snapshot) => {
                const favoritesList = document.getElementById('favorites-list');
                if (!favoritesList) return;

                favoritesList.innerHTML = '';

                if (snapshot.exists()) {
                    snapshot.forEach((favoriteSnapshot) => {
                        const favorite = favoriteSnapshot.val();
                        addFavoriteItem(favorite, favoritesList);
                    });
                } else {
                    favoritesList.innerHTML = '<div class="col-12 text-center">Ch∆∞a c√≥ kh√°ch s·∫°n y√™u th√≠ch</div>';
                }
            });
        }

        // H√†m th√™m item y√™u th√≠ch
        function addFavoriteItem(favorite, container) {
            const col = document.createElement('div');
            col.className = 'col-md-4';
            col.innerHTML = `
            <div class="favorite-item">
                <img src="${favorite.image || 'https://placehold.co/300x200?text=Hotel+Image'}" 
     alt="${favorite.name}" 
     onerror="this.src='https://placehold.co/300x200?text=Hotel+Image'">
                <div class="overlay">
                    <h5>${favorite.name || 'Kh√¥ng c√≥ t√™n'}</h5>
                    <p>${favorite.location || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ'}</p>
                </div>
            </div>
        `;
            container.appendChild(col);
        }

        // H√†m l·∫•y ƒë√°nh gi√°
        function loadReviews(user) {
            const reviewsRef = firebase.database().ref('reviews');
            const bookingsRef = firebase.database().ref('bookings');
            const reviewsList = document.getElementById('reviews-list');
            if (!reviewsList) return;
            reviewsList.innerHTML = '';
            // L·∫•y t·∫•t c·∫£ review c·ªßa user
            reviewsRef.orderByChild('userId').equalTo(user.uid).once('value', (reviewSnap) => {
                let reviewedBookingIds = [];
                let reviewsArr = [];
                if (reviewSnap.exists()) {
                    reviewSnap.forEach((reviewSnapshot) => {
                        const review = reviewSnapshot.val();
                        reviewedBookingIds.push(reviewSnapshot.key);
                        reviewsArr.push(review);
                    });
                }
                // Hi·ªÉn th·ªã c√°c review ƒë√£ c√≥
                if (reviewsArr.length > 0) {
                    reviewsArr.forEach(review => addReviewItem(review, reviewsList));
                }
                // L·∫•y c√°c booking ƒë√£ ho√†n th√†nh nh∆∞ng ch∆∞a ƒë√°nh gi√°
                bookingsRef.orderByChild('customerEmail').equalTo(user.email).once('value', (bookingSnap) => {
                    let hasPending = false;
                    if (bookingSnap.exists()) {
                        bookingSnap.forEach((bookingSnapshot) => {
                            const booking = bookingSnapshot.val();
                            const bookingId = bookingSnapshot.key;
                            const checkInDate = new Date(booking.checkIn);
                            const today = new Date();
                            if (checkInDate < today && !reviewedBookingIds.includes(bookingId)) {
                                // Ch·ªâ l·∫•y booking kh√°ch s·∫°n (kh√¥ng ph·∫£i tour)
                                if (!booking.bookingType || booking.bookingType === 'hotel') {
                                    hasPending = true;
                                    // Th√™m v√†o danh s√°ch ch·ªù ƒë√°nh gi√° v·ªõi form ƒë√°nh gi√° tr·ª±c ti·∫øp
                                    const div = document.createElement('div');
                                    div.className = 'review-item';
                                    div.innerHTML = `
                                        <div><strong>${booking.hotelName || booking.hotelId}</strong></div>
                                        <div>Check-in: ${formatDate(booking.checkIn)}</div>
                                        <div>Check-out: ${formatDate(booking.checkOut)}</div>
                                        <div class="inline-review-form" id="review-form-${bookingId}">
                                            <div class="star-rating" style="font-size:2em; color:#ccc; cursor:pointer; margin-bottom:8px;">
                                                <span data-value="1">&#9733;</span>
                                                <span data-value="2">&#9733;</span>
                                                <span data-value="3">&#9733;</span>
                                                <span data-value="4">&#9733;</span>
                                                <span data-value="5">&#9733;</span>
                                            </div>
                                            <textarea class="form-control mb-2" rows="3" placeholder="Nh·∫≠n x√©t c·ªßa b·∫°n..."></textarea>
                                            <button class="btn btn-primary btn-sm submit-inline-review">G·ª≠i ƒë√°nh gi√°</button>
                                        </div>
                                    `;
                                    reviewsList.appendChild(div);
                                    // G·∫Øn s·ª± ki·ªán ch·ªçn sao v√† g·ª≠i ƒë√°nh gi√°
                                    setTimeout(() => {
                                        let selected = 0;
                                        const formDiv = document.getElementById(`review-form-${bookingId}`);
                                        const stars = formDiv.querySelectorAll('.star-rating span');
                                        const textarea = formDiv.querySelector('textarea');
                                        const submitBtn = formDiv.querySelector('.submit-inline-review');
                                        stars.forEach(star => {
                                            star.addEventListener('click', function() {
                                                selected = this.dataset.value;
                                                stars.forEach(s => {
                                                    s.style.color = s.dataset.value <= selected ? 'gold' : '#ccc';
                                                });
                                            });
                                        });
                                        submitBtn.addEventListener('click', function() {
                                            if (selected == 0) {
                                                Swal.fire('Vui l√≤ng ch·ªçn s·ªë sao!');
                                                return;
                                            }
                                            const comment = textarea.value;
                                            if (!comment.trim()) {
                                                Swal.fire('Vui l√≤ng nh·∫≠p nh·∫≠n x√©t!');
                                                return;
                                            }
                                            // L·∫•y userId t·ª´ user.uid ƒë·ªÉ ƒë√∫ng rule Firebase
                                            const userId = user.uid;
                                            const reviewData = {
                                                userId: userId,
                                                hotelId: booking.hotelId,
                                                rating: Number(selected),
                                                comment: comment,
                                                date: firebase.database.ServerValue.TIMESTAMP,
                                                userName: user.displayName || user.email
                                            };
                                            // Log d·ªØ li·ªáu g·ª≠i l√™n ƒë·ªÉ debug
                                            console.log('Review g·ª≠i l√™n:', reviewData);
                                            firebase.database().ref('reviews/' + bookingId).set(reviewData)
                                                .then(() => {
                                                    Swal.fire('ƒê√°nh gi√° th√†nh c√¥ng!');
                                                    loadReviews(user);
                                                })
                                                .catch(err => {
                                                    Swal.fire('L·ªói: ' + err.message);
                                                });
                                        });
                                    }, 0);
                                }
                            }
                        });
                    }
                    if (!hasPending && reviewsArr.length === 0) {
                        reviewsList.innerHTML = '<div class="text-center">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</div>';
                    }
                });
            });
        }

        // H√†m th√™m item ƒë√°nh gi√°
        function addReviewItem(review, container) {
            const div = document.createElement('div');
            div.className = 'review-item';
            div.innerHTML = `
            <div class="rating">
                ${'‚òÖ'.repeat(review.rating || 0)}${'‚òÜ'.repeat(5 - (review.rating || 0))}
            </div>
            <h5>${review.hotelName || 'Kh√¥ng c√≥ t√™n kh√°ch s·∫°n'}</h5>
            <p>${review.comment || 'Kh√¥ng c√≥ n·ªôi dung'}</p>
            <span class="date">${new Date(review.date).toLocaleDateString('vi-VN')}</span>
        `;
            container.appendChild(div);
        }

        // H√†m c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n
        function updateProfile(user, userRef) {
            const updates = {
                name: document.getElementById('profile-name').value,
                phone: document.getElementById('profile-phone').value,
                birthday: document.getElementById('profile-birthday').value,
                address: document.getElementById('profile-address').value,
                gender: document.getElementById('profile-gender').value,
                nationality: document.getElementById('profile-nationality').value,
                identityNumber: document.getElementById('profile-identityNumber').value,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            Swal.fire({
                title: 'ƒêang c·∫≠p nh·∫≠t...',
                text: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            user.updateProfile({
                displayName: updates.name,
                photoURL: updates.avatar
            }).then(() => {
                return userRef.update(updates);
            }).then(() => {
                Swal.fire({
                    title: 'Th√†nh c√¥ng!',
                    text: 'Th√¥ng tin c√° nh√¢n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                    icon: 'success',
                    confirmButtonColor: '#1a237e'
                });

                document.getElementById('sidebar-user-name').textContent = updates.name;
                document.getElementById('user-name').textContent = updates.name;
                
                // C·∫≠p nh·∫≠t mobile sidebar v·ªõi t√™n m·ªõi  
                document.getElementById('mobile-sidebar-user-name').textContent = updates.name;
                
                // ƒê·ªìng b·ªô avatar n·∫øu c√≥
                if (updates.avatar) {
                    syncAllAvatars(updates.avatar);
                }
                
                updateUserBarcode(user); // C·∫≠p nh·∫≠t barcode khi c·∫≠p nh·∫≠t th√¥ng tin
            }).catch((error) => {
                console.error('L·ªói c·∫≠p nh·∫≠t:', error);
                Swal.fire({
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i sau.',
                    icon: 'error',
                    confirmButtonColor: '#1a237e'
                });
            });
        }

        // H√†m xem chi ti·∫øt ƒë·∫∑t ph√≤ng
        function viewBookingDetails(bookingId) {
            const bookingRef = firebase.database().ref('bookings/' + bookingId);
            bookingRef.once('value').then((snapshot) => {
                const booking = snapshot.val();
                if (booking) {
                    // This function now correctly handles both tour and hotel bookings
                    const isTour = booking.bookingType === 'tour';
                    const title = isTour ? 'Chi ti·∫øt ƒë·∫∑t tour' : 'Chi ti·∫øt ƒë·∫∑t ph√≤ng';

                    let detailsHtml = '';

                    if (isTour) {
                        detailsHtml = `
                            <div class="mb-3">
                                <h5 class="mb-2">Th√¥ng tin tour</h5>
                                <p class="mb-1"><strong>T√™n tour:</strong> ${booking.tourName || booking.hotelName || ''}</p>
                                <p class="mb-1"><strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${booking.tourLocation || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                                <p class="mb-1"><strong>Th·ªùi gian:</strong> ${booking.tourDuration || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                            </div>
                            <div class="mb-3">
                                <h5 class="mb-2">L·ªãch tr√¨nh</h5>
                                <p class="mb-1"><strong>Ng√†y kh·ªüi h√†nh:</strong> ${formatDate(booking.checkIn)}</p>
                                <p class="mb-1"><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDateTime(booking.createdAt)}</p>
                            </div>
                        `;
                    } else {
                        detailsHtml = `
                            <div class="mb-3">
                                <h5 class="mb-2">Th√¥ng tin kh√°ch s·∫°n</h5>
                                <p class="mb-1"><strong>Kh√°ch s·∫°n:</strong> ${booking.hotelName || booking.hotelId}</p>
                                <p class="mb-1"><strong>Lo·∫°i ph√≤ng:</strong> ${booking.roomId}</p>
                            </div>
                            <div class="mb-3">
                                <h5 class="mb-2">Th·ªùi gian</h5>
                                <p class="mb-1"><strong>Nh·∫≠n ph√≤ng:</strong> ${formatDate(booking.checkIn)}</p>
                                <p class="mb-1"><strong>Tr·∫£ ph√≤ng:</strong> ${formatDate(booking.checkOut)}</p>
                                <p class="mb-1"><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDateTime(booking.createdAt)}</p>
                            </div>
                        `;
                    }

                    detailsHtml += `
                        <div class="mb-3">
                            <h5 class="mb-2">Th√¥ng tin kh√°ch h√†ng</h5>
                            <p class="mb-1"><strong>H·ªç t√™n:</strong> ${booking.customerName || ''}</p>
                            <p class="mb-1"><strong>Email:</strong> ${booking.customerEmail || ''}</p>
                            <p class="mb-1"><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${booking.customerPhone || ''}</p>
                            <p class="mb-1"><strong>S·ªë kh√°ch:</strong> ${booking.numberOfGuests || booking.guests || 1} ng∆∞·ªùi</p>
                            <p class="mb-1"><strong>Ghi ch√∫:</strong> ${booking.note || 'Kh√¥ng c√≥'}</p>
                        </div>
                    `;

                    // Th√™m th√¥ng tin h·ªßy ƒë·∫∑t ph√≤ng v√† ho√†n ti·ªÅn n·∫øu c√≥
                    if (booking.status === 'cancelled') {
                        const cancelledDate = booking.cancelledAt ? new Date(booking.cancelledAt).toLocaleString('vi-VN') : 'Kh√¥ng x√°c ƒë·ªãnh';
                        const totalPrice = booking.totalPrice || booking.roomPrice || booking.tourPrice || 0;
                        
                        detailsHtml += `
                            <div class="mb-3">
                                <h5 class="mb-2 text-danger">Th√¥ng tin h·ªßy ƒë·∫∑t ph√≤ng</h5>
                                <p class="mb-1"><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-secondary">ƒê√£ h·ªßy</span></p>
                                <p class="mb-1"><strong>Ng√†y h·ªßy:</strong> ${cancelledDate}</p>
                                <p class="mb-1"><strong>Ng∆∞·ªùi h·ªßy:</strong> ${booking.cancelledBy === 'customer' ? 'Kh√°ch h√†ng' : 'H·ªá th·ªëng'}</p>
                        `;
                        
                        // Th√™m th√¥ng tin ho√†n ti·ªÅn n·∫øu c√≥
                        if (booking.refundStatus) {
                            const refundAmount = booking.refundAmount || 0;
                            const refundPercentage = booking.refundPercentage || 0;
                            const refundStatus = getRefundStatusText(booking.refundStatus);
                            const refundStatusClass = getRefundStatusClass(booking.refundStatus);
                            const completedDate = booking.refundCompletedAt ? new Date(booking.refundCompletedAt).toLocaleString('vi-VN') : 'Ch∆∞a ho√†n ti·ªÅn';
                            
                            detailsHtml += `
                                <hr>
                                <h5 class="mb-2 text-primary">Th√¥ng tin ho√†n ti·ªÅn</h5>
                                <p class="mb-1"><strong>T·ªïng ti·ªÅn:</strong> ${totalPrice.toLocaleString()} VNƒê</p>
                                <p class="mb-1"><strong>S·ªë ti·ªÅn ho√†n:</strong> ${refundAmount.toLocaleString()} VNƒê</p>
                                <p class="mb-1"><strong>Ph·∫ßn trƒÉm ho√†n:</strong> ${refundPercentage}%</p>
                                <p class="mb-1"><strong>Tr·∫°ng th√°i ho√†n ti·ªÅn:</strong> <span class="badge bg-${refundStatusClass}">${refundStatus}</span></p>
                                <p class="mb-1"><strong>Ph∆∞∆°ng th·ª©c ho√†n:</strong> ${booking.refundMethod || 'Chuy·ªÉn kho·∫£n'}</p>
                                <p class="mb-1"><strong>Ng√†y ho√†n ti·ªÅn:</strong> ${completedDate}</p>
                                <p class="mb-1"><strong>Ghi ch√∫:</strong> ${booking.refundNote || 'Kh√¥ng c√≥'}</p>
                            `;
                        }
                        
                        detailsHtml += `</div>`;
                    }

                    Swal.fire({
                        title: title,
                        html: `<div class="text-start">${detailsHtml}</div>`,
                        confirmButtonColor: '#1a237e',
                        confirmButtonText: 'ƒê√≥ng',
                        customClass: {
                            container: 'booking-detail-modal'
                        }
                    });
                }
            });
        }

        // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
        document.getElementById('logout-btn').addEventListener('click', function (e) {
            e.preventDefault();
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
                Swal.fire({
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t. Vui l√≤ng th·ª≠ l·∫°i sau.',
                    icon: 'error',
                    confirmButtonColor: '#1a237e'
                });
            });
        });

        function viewTourBookingDetails(bookingId) {
            // This function is now merged into viewBookingDetails
            viewBookingDetails(bookingId);
        }

        // H√†m l·∫•y l·ªãch s·ª≠ thanh to√°n
        function loadPayments(user) {
            const paymentsRef = firebase.database().ref('payments');
            paymentsRef.orderByChild('userId').equalTo(user.uid).on('value', (snapshot) => {
                const paymentsTable = document.getElementById('payments-table');
                if (!paymentsTable) return;
                paymentsTable.innerHTML = '';
                if (snapshot.exists()) {
                    let payments = [];
                    snapshot.forEach((paymentSnapshot) => {
                        payments.push({
                            id: paymentSnapshot.key,
                            ...paymentSnapshot.val()
                        });
                    });
                    // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t
                    payments.sort((a, b) => b.date - a.date);
                    payments.forEach(payment => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${payment.transactionId || payment.id}</td>
                            <td>${payment.date ? new Date(payment.date).toLocaleString('vi-VN') : ''}</td>
                            <td>${payment.amount ? payment.amount.toLocaleString('vi-VN') + ' ƒë' : ''}</td>
                            <td>${payment.method || ''}</td>
                            <td><span class="badge bg-${payment.status === 'success' ? 'success' : 'danger'}">${payment.status === 'success' ? 'Th√†nh c√¥ng' : 'Th·∫•t b·∫°i'}</span></td>
                            <td>${payment.note || ''}</td>
                        `;
                        paymentsTable.appendChild(row);
                    });
                } else {
                    paymentsTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ thanh to√°n</td></tr>';
                }
            });
        }

        // Mobile Menu Toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const navLinks = document.getElementById('nav-links');

        if (mobileMenuBtn && navLinks) {
            mobileMenuBtn.addEventListener('click', function () {
                this.classList.toggle('active');
                navLinks.classList.toggle('active');
            });

            // Close mobile menu when clicking on links
            navLinks.addEventListener('click', function (e) {
                if (e.target.tagName === 'A') {
                    mobileMenuBtn.classList.remove('active');
                    navLinks.classList.remove('active');
                }
            });

            // Close mobile menu when clicking outside
            document.addEventListener('click', function (e) {
                if (!mobileMenuBtn.contains(e.target) && !navLinks.contains(e.target)) {
                    mobileMenuBtn.classList.remove('active');
                    navLinks.classList.remove('active');
                }
            });
        }

        const sidebarAvatarUpload = document.getElementById('sidebar-avatar-upload');
        if (sidebarAvatarUpload) {
            sidebarAvatarUpload.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;
                const user = firebase.auth().currentUser;
                if (!user) return;

                // Hi·ªÉn th·ªã ·∫£nh ngay l·∫≠p t·ª©c
                const reader = new FileReader();
                reader.onload = function (event) {
                    document.getElementById('sidebar-avatar').src = event.target.result;
                };
                reader.readAsDataURL(file);

                // Upload l√™n Cloudinary
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'nguyentienchuc'); // preset unsigned

                Swal.fire({
                    title: 'ƒêang t·∫£i ·∫£nh l√™n Cloudinary...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                fetch('https://api.cloudinary.com/v1_1/dwrc3ig9e/image/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.secure_url) {
                        // ƒê·ªìng b·ªô avatar cho t·∫•t c·∫£ ph·∫ßn t·ª≠
                        syncAllAvatars(data.secure_url);
                        
                        return firebase.database().ref('users/' + user.uid).update({
                            avatar: data.secure_url,
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    } else {
                        throw new Error('Upload th·∫•t b·∫°i');
                    }
                })
                .then(() => {
                    Swal.fire({
                        title: 'Th√†nh c√¥ng!',
                        text: '·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                        icon: 'success',
                        confirmButtonColor: '#1a237e'
                    });
                })
                .catch(error => {
                    Swal.fire({
                        title: 'L·ªói!',
                        text: 'Kh√¥ng th·ªÉ t·∫£i ·∫£nh l√™n Cloudinary. Vui l√≤ng th·ª≠ l·∫°i.',
                        icon: 'error',
                        confirmButtonColor: '#1a237e'
                    });
                    console.error('Upload avatar error:', error);
                });
            });
        }

        function viewInvoice(paymentId) {
            const paymentRef = firebase.database().ref('payments/' + paymentId);
            paymentRef.once('value').then(snapshot => {
                const payment = snapshot.val();
                if (payment) {
                    Swal.fire({
                        title: 'Chi ti·∫øt h√≥a ƒë∆°n',
                        html: `
                            <div class="text-start">
                                <p><strong>M√£ giao d·ªãch:</strong> ${payment.transactionId || ''}</p>
                                <p><strong>Ng√†y:</strong> ${payment.date ? new Date(payment.date).toLocaleDateString('vi-VN') : ''}</p>
                                <p><strong>S·ªë ti·ªÅn:</strong> ${payment.amount ? payment.amount.toLocaleString('vi-VN') + '‚Ç´' : ''}</p>
                                <p><strong>Ph∆∞∆°ng th·ª©c:</strong> ${payment.method || ''}</p>
                                <p><strong>Tr·∫°ng th√°i:</strong> ${payment.status === 'success' ? 'Th√†nh c√¥ng' : 'Th·∫•t b·∫°i'}</p>
                                <p><strong>Chi ti·∫øt:</strong> ${payment.detail || ''}</p>
                            </div>
                        `,
                        confirmButtonColor: '#1a237e'
                    });
                }
            });
        }

        function loadNotifications(user) {
            const notificationsRef = firebase.database().ref('notifications/' + user.uid);
            notificationsRef.on('value', (snapshot) => {
                const list = document.getElementById('notifications-list');
                if (!list) return;
                list.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((notiSnapshot) => {
                        const noti = notiSnapshot.val();
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `
                            <div>
                                <strong>${noti.title || 'Th√¥ng b√°o'}</strong>
                                <span class="badge bg-${noti.read ? 'secondary' : 'warning'} float-end">${noti.read ? 'ƒê√£ ƒë·ªçc' : 'M·ªõi'}</span>
                            </div>
                            <div>${noti.content || ''}</div>
                            <small class="text-muted">${noti.date ? new Date(noti.date).toLocaleString('vi-VN') : ''}</small>
                        `;
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li class="list-group-item text-center">Ch∆∞a c√≥ th√¥ng b√°o n√†o</li>';
                }
            });
        }

        function editBooking(bookingId, type) {
            const bookingRef = firebase.database().ref('bookings/' + bookingId);
            bookingRef.once('value').then(snapshot => {
                const booking = snapshot.val();
                if (!booking) return;
                let html = '';
                if (type === 'hotel') {
                    html = `
                        <input id="edit-hotelName" class="swal2-input" placeholder="T√™n kh√°ch s·∫°n" value="${booking.hotelName || ''}">
                        <input id="edit-roomId" class="swal2-input" placeholder="Lo·∫°i ph√≤ng" value="${booking.roomId || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-checkOut" class="swal2-input" type="date" value="${booking.checkOut ? booking.checkOut.split('T')[0] : ''}">
                        <input id="edit-guests" class="swal2-input" type="number" placeholder="S·ªë kh√°ch" value="${booking.guests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="SƒêT" value="${booking.customerPhone || ''}">
                    `;
                } else {
                    html = `
                        <input id="edit-tourName" class="swal2-input" placeholder="T√™n tour" value="${booking.tourName || ''}">
                        <input id="edit-tourLocation" class="swal2-input" placeholder="ƒê·ªãa ƒëi·ªÉm" value="${booking.tourLocation || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-numberOfGuests" class="swal2-input" type="number" placeholder="S·ªë kh√°ch" value="${booking.numberOfGuests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="SƒêT" value="${booking.customerPhone || ''}">
                    `;
                }
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin',
                    html: html,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        if (type === 'hotel') {
                            return {
                                hotelName: document.getElementById('edit-hotelName').value,
                                roomId: document.getElementById('edit-roomId').value,
                                checkIn: document.getElementById('edit-checkIn').value,
                                checkOut: document.getElementById('edit-checkOut').value,
                                guests: parseInt(document.getElementById('edit-guests').value),
                                customerName: document.getElementById('edit-customerName').value,
                                customerPhone: document.getElementById('edit-customerPhone').value
                            };
                        } else {
                            return {
                                tourName: document.getElementById('edit-tourName').value,
                                tourLocation: document.getElementById('edit-tourLocation').value,
                                checkIn: document.getElementById('edit-checkIn').value,
                                numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value),
                                customerName: document.getElementById('edit-customerName').value,
                                customerPhone: document.getElementById('edit-customerPhone').value
                            };
                        }
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        bookingRef.update(result.value).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                        });
                    }
                });
            });
        }

        function cancelBooking(bookingId, type) {
            // Ki·ªÉm tra x√°c th·ª±c tr∆∞·ªõc
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire('L·ªói!', 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y.', 'error');
                return;
            }

            console.log('User UID:', user.uid);
            console.log('Booking ID:', bookingId);

            const bookingRef = firebase.database().ref('bookings/' + bookingId);
            bookingRef.once('value').then((snapshot) => {
                const booking = snapshot.val();
                if (!booking) {
                    Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng.', 'error');
                    return;
                }

                console.log('Booking data:', booking);
                console.log('Booking userId:', booking.userId);
                console.log('Current user UID:', user.uid);
                console.log('Booking status:', booking.status || 'undefined');
                console.log('Booking has status field:', booking.hasOwnProperty('status'));

                // Ki·ªÉm tra xem booking c√≥ thu·ªôc v·ªÅ ng∆∞·ªùi d√πng hi·ªán t·∫°i kh√¥ng
                if (booking.userId !== user.uid) {
                    Swal.fire('L·ªói!', 'B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy ƒë·∫∑t ph√≤ng n√†y.', 'error');
                    return;
                }

                // Ki·ªÉm tra xem booking ƒë√£ b·ªã h·ªßy ch∆∞a
                if (booking.status === 'cancelled') {
                    Swal.fire('ƒê√£ h·ªßy!', 'ƒê·∫∑t ph√≤ng n√†y ƒë√£ ƒë∆∞·ª£c h·ªßy tr∆∞·ªõc ƒë√≥.', 'info');
                    return;
                }

                // N·∫øu booking kh√¥ng c√≥ tr·∫°ng th√°i, ƒë·∫∑t m·∫∑c ƒë·ªãnh l√† 'pending'
                if (!booking.status) {
                    console.log('Booking kh√¥ng c√≥ tr·∫°ng th√°i, ƒë·∫∑t m·∫∑c ƒë·ªãnh l√† pending');
                }

                const checkInDate = new Date(booking.checkIn);
                const today = new Date();
                const timeDiff = checkInDate.getTime() - today.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                // Ki·ªÉm tra xem c√≥ th·ªÉ h·ªßy kh√¥ng
                if (checkInDate < today) {
                    Swal.fire('Kh√¥ng th·ªÉ h·ªßy!', 'ƒê·∫∑t ph√≤ng ƒë√£ ho√†n th√†nh, kh√¥ng th·ªÉ h·ªßy.', 'warning');
                    return;
                }

                // T√≠nh to√°n th√¥ng tin ho√†n ti·ªÅn
                const totalPrice = booking.totalPrice || booking.roomPrice || 0;
                let cancelMessage = '';
                let refundInfo = '';
                let refundPercentage = 100;
                let refundAmount = totalPrice;

                if (type === 'hotel') {
                    if (daysDiff <= 1) {
                        cancelMessage = 'H·ªßy trong v√≤ng 24h tr∆∞·ªõc check-in: Ph√≠ h·ªßy 50% gi√° ph√≤ng';
                        refundInfo = 'B·∫°n s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i 50% s·ªë ti·ªÅn ƒë√£ thanh to√°n.';
                        refundPercentage = 50;
                    } else if (daysDiff <= 3) {
                        cancelMessage = 'H·ªßy trong v√≤ng 3 ng√†y tr∆∞·ªõc check-in: Ph√≠ h·ªßy 30% gi√° ph√≤ng';
                        refundInfo = 'B·∫°n s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i 70% s·ªë ti·ªÅn ƒë√£ thanh to√°n.';
                        refundPercentage = 70;
                    } else {
                        cancelMessage = 'H·ªßy tr∆∞·ªõc 3 ng√†y: Ho√†n ti·ªÅn 100%';
                        refundInfo = 'B·∫°n s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i to√†n b·ªô s·ªë ti·ªÅn ƒë√£ thanh to√°n.';
                        refundPercentage = 100;
                    }
                } else {
                    if (daysDiff <= 1) {
                        cancelMessage = 'H·ªßy trong v√≤ng 24h tr∆∞·ªõc kh·ªüi h√†nh: Ph√≠ h·ªßy 50% gi√° tour';
                        refundInfo = 'B·∫°n s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i 50% s·ªë ti·ªÅn ƒë√£ thanh to√°n.';
                        refundPercentage = 50;
                    } else if (daysDiff <= 7) {
                        cancelMessage = 'H·ªßy trong v√≤ng 7 ng√†y tr∆∞·ªõc kh·ªüi h√†nh: Ph√≠ h·ªßy 30% gi√° tour';
                        refundInfo = 'B·∫°n s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i 70% s·ªë ti·ªÅn ƒë√£ thanh to√°n.';
                        refundPercentage = 70;
                    } else {
                        cancelMessage = 'H·ªßy tr∆∞·ªõc 7 ng√†y: Ho√†n ti·ªÅn 100%';
                        refundInfo = 'B·∫°n s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i to√†n b·ªô s·ªë ti·ªÅn ƒë√£ thanh to√°n.';
                        refundPercentage = 100;
                    }
                }

                // T√≠nh s·ªë ti·ªÅn ho√†n l·∫°i
                refundAmount = Math.round(totalPrice * refundPercentage / 100);

                Swal.fire({
                    title: 'X√°c nh·∫≠n h·ªßy ƒë·∫∑t ph√≤ng',
                    html: `
                        <div class="text-start">
                            <p><strong>Th√¥ng tin ƒë·∫∑t ph√≤ng:</strong></p>
                            <p>‚Ä¢ ${type === 'hotel' ? 'Kh√°ch s·∫°n' : 'Tour'}: ${booking.hotelName || booking.tourName || 'N/A'}</p>
                            <p>‚Ä¢ Ng√†y ${type === 'hotel' ? 'check-in' : 'kh·ªüi h√†nh'}: ${formatDate(booking.checkIn)}</p>
                            <p>‚Ä¢ C√≤n l·∫°i: ${daysDiff} ng√†y</p>
                            <p>‚Ä¢ T·ªïng ti·ªÅn: ${totalPrice.toLocaleString()} VNƒê</p>
                            <hr>
                            <p><strong>Ch√≠nh s√°ch h·ªßy:</strong></p>
                            <p>${cancelMessage}</p>
                            <p><strong>${refundInfo}</strong></p>
                            <p><strong>S·ªë ti·ªÅn ho√†n l·∫°i: ${refundAmount.toLocaleString()} VNƒê</strong></p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'X√°c nh·∫≠n h·ªßy',
                    cancelButtonText: 'Kh√¥ng h·ªßy',
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d'
                }).then(result => {
                    if (result.isConfirmed) {
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë·∫∑t ph√≤ng th√†nh "ƒê√£ h·ªßy" v√† th√¥ng tin ho√†n ti·ªÅn
                        const updateData = {
                            status: 'cancelled',
                            cancelledAt: Date.now(),
                            cancelledBy: 'customer',
                            updatedAt: Date.now(),
                            refundAmount: refundAmount,
                            refundPercentage: refundPercentage,
                            refundStatus: 'pending', // pending, processing, completed, failed
                            refundMethod: 'bank_transfer', // bank_transfer, vnpay_refund, etc.
                            refundNote: refundInfo
                        };
                        
                        // Tr·ª´ ƒëi·ªÉm th√†nh vi√™n n·∫øu ƒë√£ ƒë∆∞·ª£c c·ªông ƒëi·ªÉm khi thanh to√°n
                        const userRef = firebase.database().ref('users/' + user.uid);
                        userRef.once('value').then((userSnapshot) => {
                            const userData = userSnapshot.val();
                            const currentPoints = userData.loyaltyPoints || 0;
                            
                            // T√≠nh ƒëi·ªÉm c·∫ßn tr·ª´ (d·ª±a tr√™n t·ªïng ti·ªÅn booking)
                            const pointsToDeduct = Math.floor(totalPrice / 1000); // 1 ƒëi·ªÉm cho m·ªói 1000 VNƒê
                            const newPoints = Math.max(0, currentPoints - pointsToDeduct);
                            
                            // C·∫≠p nh·∫≠t ƒëi·ªÉm th√†nh vi√™n
                            userRef.update({
                                loyaltyPoints: newPoints
                            }).then(() => {
                                // Sau ƒë√≥ c·∫≠p nh·∫≠t tr·∫°ng th√°i booking
                                return bookingRef.update(updateData);
                            }).then(() => {
                                Swal.fire({
                                    title: 'ƒê√£ h·ªßy th√†nh c√¥ng!',
                                    html: `
                                        <div class="text-start">
                                            <p>ƒê·∫∑t ph√≤ng ƒë√£ ƒë∆∞·ª£c h·ªßy th√†nh c√¥ng.</p>
                                            <p><strong>Th√¥ng tin ho√†n ti·ªÅn:</strong></p>
                                            <p>${refundInfo}</p>
                                            <p><strong>S·ªë ti·ªÅn ho√†n l·∫°i: ${refundAmount.toLocaleString()} VNƒê</strong></p>
                                            <p><small>Ch√∫ng t√¥i s·∫Ω x·ª≠ l√Ω ho√†n ti·ªÅn trong v√≤ng 3-5 ng√†y l√†m vi·ªác.</small></p>
                                            <p><small>Tr·∫°ng th√°i: ƒêang ch·ªù x·ª≠ l√Ω</small></p>
                                            <hr>
                                            <p><strong>ƒêi·ªÉm th√†nh vi√™n:</strong></p>
                                            <p>‚Ä¢ ƒêi·ªÉm ƒë√£ tr·ª´: ${pointsToDeduct} ƒëi·ªÉm</p>
                                            <p>‚Ä¢ ƒêi·ªÉm hi·ªán t·∫°i: ${newPoints} ƒëi·ªÉm</p>
                                        </div>
                                    `,
                                    icon: 'success',
                                    confirmButtonText: 'ƒê√≥ng'
                                });
                                
                                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒëi·ªÉm th√†nh vi√™n tr√™n giao di·ªán
                                updateLoyaltyDisplay(newPoints);
                            });
                        }).catch(error => {
                            console.error('L·ªói khi h·ªßy ƒë·∫∑t ph√≤ng:', error);
                            let errorMessage = 'Kh√¥ng th·ªÉ h·ªßy ƒë·∫∑t ph√≤ng. Vui l√≤ng th·ª≠ l·∫°i sau.';
                            
                            if (error.code === 'PERMISSION_DENIED') {
                                errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                            } else if (error.message) {
                                errorMessage = `L·ªói: ${error.message}`;
                            }
                            
                            Swal.fire('L·ªói!', errorMessage, 'error');
                        });
                    }
                });
            });
        }

        // H√†m c·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒëi·ªÉm th√†nh vi√™n
        function updateLoyaltyDisplay(newPoints) {
            // C·∫≠p nh·∫≠t ƒëi·ªÉm trong sidebar
            const sidebarPoints = document.getElementById('sidebar-loyaltyPoints');
            if (sidebarPoints) {
                sidebarPoints.textContent = `ƒêi·ªÉm: ${newPoints}`;
            }
            
            // C·∫≠p nh·∫≠t ƒëi·ªÉm trong tab loyalty
            const profilePoints = document.getElementById('profile-loyaltyPoints');
            if (profilePoints) {
                profilePoints.textContent = newPoints;
            }
        }

        function deleteBooking(bookingId) {
            // Ki·ªÉm tra x√°c th·ª±c tr∆∞·ªõc
            const user = firebase.auth().currentUser;
            if (!user) {
                Swal.fire('L·ªói!', 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y.', 'error');
                return;
            }

            // Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu tr∆∞·ªõc khi x√≥a
            firebase.database().ref('bookings/' + bookingId).once('value').then((snapshot) => {
                const booking = snapshot.val();
                if (!booking) {
                    Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng.', 'error');
                    return;
                }

                if (booking.userId !== user.uid) {
                    Swal.fire('L·ªói!', 'B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a ƒë·∫∑t ph√≤ng n√†y.', 'error');
                    return;
                }

                Swal.fire({
                    title: 'X√≥a ƒë·∫∑t ph√≤ng?',
                    text: 'B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªãch s·ª≠ n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'X√≥a',
                    cancelButtonText: 'H·ªßy'
                }).then(result => {
                    if (result.isConfirmed) {
                        firebase.database().ref('bookings/' + bookingId).remove().then(() => {
                            Swal.fire('ƒê√£ x√≥a!', 'L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        }).catch(error => {
                            console.error('L·ªói khi x√≥a ƒë·∫∑t ph√≤ng:', error);
                            Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a ƒë·∫∑t ph√≤ng. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
                        });
                    }
                });
            }).catch(error => {
                console.error('L·ªói khi ki·ªÉm tra quy·ªÅn:', error);
                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ ki·ªÉm tra quy·ªÅn. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
            });
        }

        // H√†m tr·∫£ v·ªÅ icon + t√™n h·∫°ng th√†nh vi√™n
function getMemberLevelIcon(level) {
    switch(level) {
        case 'ƒê·ªìng':
            return '<i class="fas fa-medal" style="color:#b87333"></i> ƒê·ªìng';
        case 'B·∫°c':
            return '<i class="fas fa-medal" style="color:#b0c4de"></i> B·∫°c';
        case 'V√†ng':
            return '<i class="fas fa-medal" style="color:#ffd700"></i> V√†ng';
        case 'Kim c∆∞∆°ng':
            return '<i class="fas fa-gem" style="color:#00bcd4"></i> Kim c∆∞∆°ng';
        case 'L∆∞u ly':
            return '<i class="fas fa-crown" style="color:#8e24aa"></i> L∆∞u ly';
        default:
            return level || '';
    }
}

// Th√™m h√†m ph√¢n h·∫°ng v√† c·∫≠p nh·∫≠t memberLevel
function updateMemberLevel() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    const userRef = firebase.database().ref('users/' + user.uid);
    userRef.once('value').then(snapshot => {
        const data = snapshot.val() || {};
        const points = data.loyaltyPoints || 0;
        let level = 'ƒê·ªìng';
        if (points >= 10000) level = 'Kim c∆∞∆°ng';
        else if (points >= 5000) level = 'V√†ng';
        else if (points >= 1000) level = 'B·∫°c';
        if (data.memberLevel !== level) {
            userRef.update({ memberLevel: level });
        }
        // Hi·ªÉn th·ªã quy·ªÅn l·ª£i khi hover
        const sidebarLevel = document.getElementById('sidebar-memberLevel');
        if (sidebarLevel) {
            sidebarLevel.title =
                'ƒê·ªìng: C∆° b·∫£n\n' +
                'B·∫°c: Gi·∫£m gi√° 5%\n' +
                'V√†ng: Gi·∫£m gi√° 10%, ∆∞u ti√™n h·ªó tr·ª£\n' +
                'Kim c∆∞∆°ng: Gi·∫£m gi√° 15%, qu√† t·∫∑ng ƒë·∫∑c bi·ªát';
        }
    });
}

// H√†m reset l·∫°i ƒëi·ªÉm th√†nh vi√™n d·ª±a tr√™n c√°c payment th√†nh c√¥ng
function resetLoyaltyPoints(user) {
    Swal.fire({
        title: 'X√°c nh·∫≠n',
        text: 'B·∫°n c√≥ ch·∫Øc mu·ªën reset v√† t√≠nh l·∫°i ƒëi·ªÉm th√†nh vi√™n? ƒêi·ªÉm s·∫Ω ƒë∆∞·ª£c t√≠nh l·∫°i theo c√°c giao d·ªãch th√†nh c√¥ng!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ƒê·ªìng √Ω',
        cancelButtonText: 'H·ªßy'
    }).then((result) => {
        if (!result.isConfirmed) return;
        // Reset ƒëi·ªÉm v·ªÅ 0
        const userRef = firebase.database().ref('users/' + user.uid);
        userRef.update({ loyaltyPoints: 0 }).then(() => {
            // L·∫•y t·∫•t c·∫£ payment th√†nh c√¥ng
            firebase.database().ref('payments').orderByChild('userId').equalTo(user.uid).once('value', (snapshot) => {
                let totalPoints = 0;
                let updates = {};
                snapshot.forEach((paymentSnapshot) => {
                    const payment = paymentSnapshot.val();
                    if (payment.status === 'success') {
                        // 100.000ƒë = 10 ƒëi·ªÉm
                        const points = Math.floor((payment.amount || 0) / 100000) * 10;
                        if (points > 0) {
                            totalPoints += points;
                        }
                        // ƒê√°nh d·∫•u ƒë√£ c·ªông ƒëi·ªÉm
                        if (!payment.loyaltyAdded) {
                            updates[paymentSnapshot.key + '/loyaltyAdded'] = true;
                        }
                    }
                });
                // C·∫≠p nh·∫≠t ƒëi·ªÉm v√† loyaltyAdded
                const updatesObj = {};
                updatesObj['users/' + user.uid + '/loyaltyPoints'] = totalPoints;
                Object.keys(updates).forEach(k => {
                    updatesObj['payments/' + k] = true;
                });
                firebase.database().ref().update(updatesObj).then(() => {
                    // C·∫≠p nh·∫≠t ph√¢n h·∫°ng
                    updateMemberLevelCustom(user, totalPoints);
                    Swal.fire('Th√†nh c√¥ng!', 'ƒêi·ªÉm th√†nh vi√™n ƒë√£ ƒë∆∞·ª£c reset v√† t√≠nh l·∫°i: ' + totalPoints + ' ƒëi·ªÉm.', 'success');
                });
            });
        });
    });
}

// H√†m ph√¢n h·∫°ng m·ªõi (c√≥ th√™m L∆∞u ly)
function updateMemberLevelCustom(user, points) {
    let level = 'ƒê·ªìng';
    if (points >= 20000) level = 'L∆∞u ly';
    else if (points >= 10000) level = 'Kim c∆∞∆°ng';
    else if (points >= 5000) level = 'V√†ng';
    else if (points >= 1000) level = 'B·∫°c';
    firebase.database().ref('users/' + user.uid + '/memberLevel').set(level);
}

    </script>
    <!-- <script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/684e312c6b65fa190ea6f4dd/1iton06be';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
End of Tawk.to Script -->

    <script>
        // Hi·ªÉn th·ªã ·∫£nh v·ª´a ch·ªçn l√™n avatar ngay l·∫≠p t·ª©c
        document.addEventListener('DOMContentLoaded', function() {
            var avatarInput = document.getElementById('sidebar-avatar-upload');
            var avatarImg = document.getElementById('sidebar-avatar');
            if (avatarInput && avatarImg) {
                avatarInput.addEventListener('change', function(event) {
                    var file = event.target.files[0];
                    if (file) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            avatarImg.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    </script>
   
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" style="max-width:700px; min-width:500px;">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="reviewModalLabel">ƒê√°nh gi√° kh√°ch s·∫°n</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
          </div>
          <div class="modal-body">
            <div id="star-rating" style="font-size:2.8em; color:#ccc; cursor:pointer; margin-bottom:18px; text-align:center;">
              <span data-value="1">&#9733;</span>
              <span data-value="2">&#9733;</span>
              <span data-value="3">&#9733;</span>
              <span data-value="4">&#9733;</span>
              <span data-value="5">&#9733;</span>
            </div>
            <textarea id="reviewComment" class="form-control mb-3" rows="4" style="font-size:1.1em;" placeholder="Nh·∫≠n x√©t c·ªßa b·∫°n..."></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="button" class="btn btn-primary" id="submitReview">G·ª≠i ƒë√°nh gi√°</button>
          </div>
        </div>
      </div>
    </div>
    <script>
        let selectedRating = 0;
        let currentBookingId = '';
        let currentHotelId = '';
        let currentHotelName = '';
        
        function openReviewModal(bookingId, hotelId, hotelName) {
  currentBookingId = bookingId;
  currentHotelId = hotelId;
  currentHotelName = hotelName;
  selectedRating = 0;
  document.getElementById('reviewComment').value = '';
  document.querySelectorAll('#star-rating span').forEach(s => s.style.color = '#ccc');
  // Ki·ªÉm tra ƒë√£ ƒë√°nh gi√° ch∆∞a
  firebase.database().ref('reviews/' + bookingId).once('value').then(snap => {
    if (snap.exists()) {
      Swal.fire('B·∫°n ƒë√£ ƒë√°nh gi√° ƒë∆°n n√†y!');
      return;
    }
    // ƒê√≥ng SweetAlert2 n·∫øu ƒëang m·ªü
    if (Swal.isVisible()) Swal.close();
    // M·ªü modal Bootstrap
    var reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
    reviewModal.show();
  });
}
        
        document.addEventListener('DOMContentLoaded', function() {
          // G·∫Øn s·ª± ki·ªán ch·ªçn sao
          document.querySelectorAll('#star-rating span').forEach(star => {
            star.addEventListener('click', function() {
              selectedRating = this.dataset.value;
              document.querySelectorAll('#star-rating span').forEach(s => {
                s.style.color = s.dataset.value <= selectedRating ? 'gold' : '#ccc';
              });
            });
          });
          // G·∫Øn s·ª± ki·ªán submitReview qua delegation ƒë·ªÉ tr√°nh l·ªói null
          document.body.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'submitReview') {
              const comment = document.getElementById('reviewComment').value;
              if (selectedRating == 0) {
                Swal.fire('Vui l√≤ng ch·ªçn s·ªë sao!');
                return;
              }
              const user = firebase.auth().currentUser;
              if (!user) {
                Swal.fire('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°!');
                return;
              }
              // L∆∞u ƒë√°nh gi√° v√†o reviews/bookingId
              const reviewData = {
                userId: user.uid,
                hotelId: currentHotelId,
                hotelName: currentHotelName,
                rating: Number(selectedRating),
                comment: comment,
                date: firebase.database.ServerValue.TIMESTAMP,
                userName: user.displayName || user.email
              };
              firebase.database().ref('reviews/' + currentBookingId).set(reviewData)
                .then(() => {
                  Swal.fire('ƒê√°nh gi√° th√†nh c√¥ng!');
                  var reviewModal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
                  if (reviewModal) reviewModal.hide();
                  if (typeof loadBookings === 'function') loadBookings(user);
                })
                .catch(err => {
                  Swal.fire('L·ªói: ' + err.message);
                });
            }
          });
        });
        </script>

    <script>
        // Th√™m script x·ª≠ l√Ω ch·ªçn/x√≥a nhi·ªÅu booking
        document.addEventListener('DOMContentLoaded', function() {
            // Hotel
            const hotelTable = document.getElementById('bookings-table-hotel');
            const selectAllHotel = document.getElementById('select-all-hotel');
            const deleteSelectedHotel = document.getElementById('delete-selected-hotel');
            hotelTable && hotelTable.addEventListener('change', function() {
                const checked = document.querySelectorAll('.select-booking-hotel:checked');
                if (deleteSelectedHotel) deleteSelectedHotel.style.display = checked.length > 0 ? 'inline-block' : 'none';
            });
            selectAllHotel && selectAllHotel.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.select-booking-hotel');
                checkboxes.forEach(cb => cb.checked = selectAllHotel.checked);
                const checked = document.querySelectorAll('.select-booking-hotel:checked');
                if (deleteSelectedHotel) deleteSelectedHotel.style.display = checked.length > 0 ? 'inline-block' : 'none';
            });
            deleteSelectedHotel && deleteSelectedHotel.addEventListener('click', function() {
                const checked = document.querySelectorAll('.select-booking-hotel:checked');
                if (checked.length === 0) return;
                Swal.fire({
                    title: 'X√≥a c√°c ƒë·∫∑t ph√≤ng ƒë√£ ch·ªçn?',
                    text: `B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ${checked.length} ƒë·∫∑t ph√≤ng ƒë√£ ch·ªçn?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'X√≥a',
                    cancelButtonText: 'H·ªßy'
                }).then(result => {
                    if (result.isConfirmed) {
                        checked.forEach(cb => {
                            firebase.database().ref('bookings/' + cb.value).remove();
                        });
                        Swal.fire('ƒê√£ x√≥a!', 'C√°c ƒë·∫∑t ph√≤ng ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                    }
                });
            });
            // Tour
            const tourTable = document.getElementById('bookings-table-tour');
            const selectAllTour = document.getElementById('select-all-tour');
            const deleteSelectedTour = document.getElementById('delete-selected-tour');
            tourTable && tourTable.addEventListener('change', function() {
                const checked = document.querySelectorAll('.select-booking-tour:checked');
                if (deleteSelectedTour) deleteSelectedTour.style.display = checked.length > 0 ? 'inline-block' : 'none';
            });
            selectAllTour && selectAllTour.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.select-booking-tour');
                checkboxes.forEach(cb => cb.checked = selectAllTour.checked);
                const checked = document.querySelectorAll('.select-booking-tour:checked');
                if (deleteSelectedTour) deleteSelectedTour.style.display = checked.length > 0 ? 'inline-block' : 'none';
            });
            deleteSelectedTour && deleteSelectedTour.addEventListener('click', function() {
                const checked = document.querySelectorAll('.select-booking-tour:checked');
                if (checked.length === 0) return;
                Swal.fire({
                    title: 'X√≥a c√°c ƒë·∫∑t tour ƒë√£ ch·ªçn?',
                    text: `B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ${checked.length} ƒë·∫∑t tour ƒë√£ ch·ªçn?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'X√≥a',
                    cancelButtonText: 'H·ªßy'
                }).then(result => {
                    if (result.isConfirmed) {
                        checked.forEach(cb => {
                            firebase.database().ref('bookings/' + cb.value).remove();
                        });
                        Swal.fire('ƒê√£ x√≥a!', 'C√°c ƒë·∫∑t tour ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                    }
                });
            });
        });
    </script>
    <!-- Bottom Navigation Bar for Mobile -->
    <nav class="bottom-nav d-md-none d-lg-none">
        <a href="index.html" class="bottom-nav-item ">
            <i class="fas fa-home"></i>
            <span>Trang ch·ªß</span>
        </a>
        <a href="hotel.html" class="bottom-nav-item">
            <i class="fas fa-hotel"></i>
            <span>Kh√°ch s·∫°n</span>
        </a>
        <a href="tours.html" class="bottom-nav-item">
            <i class="fas fa-map-marked-alt"></i>
            <span>Tours</span>
        </a>
        <a href="prioritize.html" class="bottom-nav-item">
            <i class="fas fa-gift"></i>
            <span>∆Øu ƒë√£i</span>
        </a>
        <a href="travel_guide.html" class="bottom-nav-item">
            <i class="fas fa-map-marked-alt"></i>
            <span>C·∫©m nang</span>
        <a href="about_us.html" class="bottom-nav-item">
            <i class="fas fa-phone"></i>
            <span>Li√™n h·ªá</span>
        </a>
        <a href="member.html" class="bottom-nav-item active">
            <i class="fas fa-user"></i>
            <span>T√†i kho·∫£n</span>
        </a>
        
        </a>
    </nav>

    <!-- Avatar button for mobile (hi·ªán ·ªü g√≥c tr√™n b√™n ph·∫£i tr√™n mobile) -->
    <div id="mobile-avatar-btn" style="display:none; position:fixed; top:16px; right:16px; z-index:1201;">
      <img id="mobile-avatar-img" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" alt="Avatar" style="width:42px; height:42px; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,0.15); border:2px solid #fff; cursor:pointer; transition: transform 0.2s ease;">
    </div>
    <!-- Off-canvas sidebar cho mobile -->
    <div id="mobile-sidebar-offcanvas" style="display:none; position:fixed; top:0; left:0; width:80vw; max-width:320px; height:100vh; background:#fff; z-index:1300; box-shadow:2px 0 16px rgba(0,0,0,0.18); overflow-y:auto; transition:transform 0.3s; transform:translateX(-100%);">
      <div style="padding:24px 16px 12px 16px; text-align:center; border-bottom:1px solid #eee;">
        <img id="mobile-sidebar-avatar" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" alt="Avatar" style="width:72px; height:72px; border-radius:50%; margin-bottom:8px;">
        <h5 id="mobile-sidebar-user-name" style="margin-bottom:4px; font-size:1.1em;"></h5>
        <div id="mobile-sidebar-user-email" style="font-size:0.95em; color:#888; margin-bottom:6px;"></div>
        <div id="mobile-sidebar-memberLevel" style="font-weight:600; color:#1a237e; margin-bottom:2px;"></div>
        <div id="mobile-sidebar-loyaltyPoints" style="color:#e67e22; font-size:0.98em;"></div>
        <button id="mobile-sidebar-close" style="position:absolute; top:12px; right:12px; background:none; border:none; font-size:1.8em; color:#888;">&times;</button>
      </div>
      <div style="padding:12px 0;">
        <a href="#profile" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-user me-2"></i> Th√¥ng tin c√° nh√¢n</a>
        <a href="#bookings" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-calendar-alt me-2"></i> L·ªãch s·ª≠</a>
        <a href="#loyalty" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-star me-2"></i> ƒêi·ªÉm th√†nh vi√™n</a>
        <a href="#favorites" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-heart me-2"></i> Y√™u th√≠ch</a>
        <a href="#reviews" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-star me-2"></i> ƒê√°nh gi√°</a>
        <a href="#settings" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-cog me-2"></i> C√†i ƒë·∫∑t</a>
        <a href="#payments" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-file-invoice-dollar me-2"></i> Thanh to√°n</a>
      </div>
    </div>
    <div id="mobile-sidebar-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1299;"></div>

    <script>
    // ... existing code ...
    // Mobile sidebar logic
    function showMobileSidebar() {
      document.getElementById('mobile-sidebar-offcanvas').style.display = 'block';
      document.getElementById('mobile-sidebar-overlay').style.display = 'block';
      setTimeout(()=>{
        document.getElementById('mobile-sidebar-offcanvas').style.transform = 'translateX(0)';
      }, 10);
    }
    function hideMobileSidebar() {
      document.getElementById('mobile-sidebar-offcanvas').style.transform = 'translateX(-100%)';
      setTimeout(()=>{
        document.getElementById('mobile-sidebar-offcanvas').style.display = 'none';
        document.getElementById('mobile-sidebar-overlay').style.display = 'none';
      }, 300);
    }
    document.addEventListener('DOMContentLoaded', function() {
      // Hi·ªán n√∫t avatar tr√™n mobile, ·∫©n sidebar g·ªëc
      function handleMobileSidebarDisplay() {
        if(window.innerWidth <= 768) {
          document.getElementById('mobile-avatar-btn').style.display = 'block';
          var sidebar = document.querySelector('.col-md-3');
          if(sidebar) sidebar.style.display = 'none';
        } else {
          document.getElementById('mobile-avatar-btn').style.display = 'none';
          var sidebar = document.querySelector('.col-md-3');
          if(sidebar) sidebar.style.display = '';
          hideMobileSidebar();
        }
      }
      handleMobileSidebarDisplay();
      window.addEventListener('resize', handleMobileSidebarDisplay);
      // G·∫Øn s·ª± ki·ªán m·ªü/ƒë√≥ng
      document.getElementById('mobile-avatar-btn').onclick = showMobileSidebar;
      document.getElementById('mobile-sidebar-close').onclick = hideMobileSidebar;
      document.getElementById('mobile-sidebar-overlay').onclick = hideMobileSidebar;
      
      // Th√™m hi·ªáu ·ª©ng hover cho mobile avatar button
      const mobileAvatarBtn = document.getElementById('mobile-avatar-btn');
      const mobileAvatarImg = document.getElementById('mobile-avatar-img');
      
      mobileAvatarBtn.addEventListener('touchstart', function() {
        mobileAvatarImg.style.transform = 'scale(0.95)';
      });
      
      mobileAvatarBtn.addEventListener('touchend', function() {
        mobileAvatarImg.style.transform = 'scale(1)';
      });
      
      // ƒê·ªìng b·ªô th√¥ng tin user v√†o mobile sidebar
      function syncMobileSidebar(userData) {
        // ƒê·ªìng b·ªô avatar cho t·∫•t c·∫£ ph·∫ßn t·ª≠
        syncAllAvatars(userData.avatar);
        
        // C·∫≠p nh·∫≠t th√¥ng tin user kh√°c
        document.getElementById('mobile-sidebar-user-name').textContent = userData.name || userData.displayName || '';
        document.getElementById('mobile-sidebar-user-email').textContent = userData.email || firebase.auth().currentUser?.email || '';
        document.getElementById('mobile-sidebar-memberLevel').innerHTML = userData.memberLevel ? getMemberLevelIcon(userData.memberLevel) : '';
        document.getElementById('mobile-sidebar-loyaltyPoints').textContent = userData.loyaltyPoints ? `ƒêi·ªÉm: ${userData.loyaltyPoints}` : '';
      }
      // G·ªçi h√†m n√†y sau khi loadUserData
      // V√≠ d·ª•: trong loadUserData(user) => syncMobileSidebar(userData)
      // ...
    });
    // ... existing code ...
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      function handleMobileTabMenu() {
        if(window.innerWidth <= 768) {
          document.getElementById('mobile-tab-menu').style.display = 'flex';
        } else {
          document.getElementById('mobile-tab-menu').style.display = 'none';
        }
      }
      handleMobileTabMenu();
      window.addEventListener('resize', handleMobileTabMenu);
      // Active tab highlight
      document.querySelectorAll('.mobile-tab-link').forEach(link => {
        link.addEventListener('click', function() {
          document.querySelectorAll('.mobile-tab-link').forEach(l=>l.classList.remove('active'));
          this.classList.add('active');
        });
      });
    });
    </script>

    <script>
    // ... existing code ...
    document.addEventListener('DOMContentLoaded', function() {
      // ... existing code ...
      // X·ª≠ l√Ω click menu trong mobile sidebar ƒë·ªÉ chuy·ªÉn tab (d√πng Bootstrap Tab API)
      document.querySelectorAll('#mobile-sidebar-offcanvas [data-bs-toggle="list"]').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          var target = this.getAttribute('href');
          var tabTrigger = document.querySelector('.list-group-item-action[data-bs-toggle="list"][href="' + target + '"]')
            || document.querySelector('.mobile-tab-link[href="' + target + '"]');
          if(tabTrigger) {
            if (typeof bootstrap !== 'undefined' && bootstrap.Tab) {
              var tab = new bootstrap.Tab(tabTrigger);
              tab.show();
            } else {
              tabTrigger.click();
            }
          }
          hideMobileSidebar();
        });
      });
    });
    // ... existing code ...
    </script>
</body>

</html>