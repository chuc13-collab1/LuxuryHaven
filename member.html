<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxuryHavenTravel - ƒê·∫∑t Ph√≤ng Kh√°ch S·∫°n Tr·ª±c Tuy·∫øn</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Th√™m SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="css/member.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-flex">
                <!-- Logo -->
                <a class="navbar-brand" href="#">
                    <img src="images/LuxuryHavenTravel.png" alt="LuxuryHaven Logo">
                </a>
                <!-- Mobile Menu Button -->
                <button class="mobile-menu-btn" id="mobile-menu-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="nav-search">
                    <div class="search-input-group">
                        <input type="text" placeholder="T√¨m ki·∫øm...">
                        <button type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="nav-right">
                    <ul class="nav-links" id="nav-links">
                        <li><a href="index.html" class="active">Trang ch·ªß</a></li>
                        <li><a href="hotel.html">Kh√°ch s·∫°n</a></li>

                        <li class="dropdown"><a href="tours.html">Tours</a></li>

                        <li class="dropdown"><a href="prioritize.html">∆Øu ƒë√£i</a></li>
                        <li class="dropdown"><a href="travel_guide.html">C·∫©m nang du l·ªãch</a></li>
                        <li class="dropdown"><a href="about_us.html">V·ªÅ ch√∫ng t√¥i</a></li>
                        <!-- <li class="dropdown"><a href="vuichoi.html">üåê</a></li> -->
                        <li>
                            <div class="d-flex align-items-center">
                                <div class="dropdown" id="user-dropdown" style="display:none;">
                                    <button class="btn btn-outline-primary dropdown-toggle" type="button"
                                        id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-user"></i> <span id="user-name"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                        <li><a class="dropdown-item" href="member.html"><i
                                                    class="fas fa-user-circle"></i> T√†i kho·∫£n</a></li>
                                        <li><a class="dropdown-item" href="#" id="logout-btn"><i
                                                    class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
                                    </ul>
                                </div>
                                <a href="#" class="btn btn-outline-primary me-2" id="open-login-modal">
                                    <i class="fas fa-user"></i> ƒêƒÉng nh·∫≠p
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <div class="container" style="margin-top: 120px;">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div class="avatar-wrapper mb-3">
                                    <img id="sidebar-avatar" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y"
                                        alt="Avatar" class="rounded-circle"
                                        style="width: 100px; height: 100px; object-fit: cover;"
                                        onerror="this.src='https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y'">
                                    <label for="sidebar-avatar-upload" style="position:absolute;bottom:0;right:0;cursor:pointer;background:#fff;border-radius:50%;padding:4px;">
                                        <i class="fas fa-camera" style="font-size:18px;color:#1a237e;"></i>
                                    </label>
                                    <input type="file" id="sidebar-avatar-upload" accept="image/*" style="display:none;">
                                </div>
                                <h5 class="mb-1" id="sidebar-user-name">T√™n ng∆∞·ªùi d√πng</h5>
                                <p class="text-muted" id="sidebar-user-email">email@example.com</p>
                                <div id="sidebar-memberLevel" style="font-weight:600;color:#1a237e;"></div>
                                <div id="sidebar-loyaltyPoints" style="color:#e67e22;"></div>
                            </div>
                            <div class="list-group">
                                <a href="#profile" class="list-group-item list-group-item-action active"
                                    data-bs-toggle="list">
                                    <i class="fas fa-user me-2"></i> Th√¥ng tin c√° nh√¢n
                                </a>
                                <a href="#bookings" class="list-group-item list-group-item-action"
                                    data-bs-toggle="list">
                                    <i class="fas fa-calendar-alt me-2"></i> L·ªãch s·ª≠
                                </a>
                                <a href="#favorites" class="list-group-item list-group-item-action"
                                    data-bs-toggle="list">
                                    <i class="fas fa-heart me-2"></i> Danh s√°ch y√™u th√≠ch
                                </a>
                                <a href="#reviews" class="list-group-item list-group-item-action" data-bs-toggle="list">
                                    <i class="fas fa-star me-2"></i> ƒê√°nh gi√° c·ªßa t√¥i
                                </a>
                                <a href="#settings" class="list-group-item list-group-item-action"
                                    data-bs-toggle="list">
                                    <i class="fas fa-cog me-2"></i> C√†i ƒë·∫∑t t√†i kho·∫£n
                                </a>
                                <li><a href="#payments" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-file-invoice-dollar me-2"></i> L·ªãch s·ª≠ thanh to√°n</a></li>
                                <!-- <li><a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list"><i class="fas fa-bell me-2"></i> Th√¥ng b√°o</a></li> -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-9">
                    <div class="tab-content">
                        <!-- Profile Tab -->
                        <div class="tab-pane fade show active" id="profile">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">Th√¥ng tin c√° nh√¢n</h4>
                                    <form id="profile-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">H·ªç v√† t√™n</label>
                                                <input type="text" class="form-control" id="profile-name">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" id="profile-email" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                                <input type="tel" class="form-control" id="profile-phone">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Ng√†y sinh</label>
                                                <input type="date" class="form-control" id="profile-birthday">
                                            </div>
                                            <div class="col-12 mb-3">
                                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                                <textarea class="form-control" id="profile-address" rows="2"></textarea>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Gi·ªõi t√≠nh</label>
                                                <select class="form-control" id="profile-gender">
                                                    <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                                    <option value="Nam">Nam</option>
                                                    <option value="N·ªØ">N·ªØ</option>
                                                    <option value="Kh√°c">Kh√°c</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Qu·ªëc t·ªãch</label>
                                                <input type="text" class="form-control" id="profile-nationality">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">S·ªë CMND/CCCD</label>
                                                <input type="text" class="form-control" id="profile-identityNumber">
                                            </div>
                                           
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">ƒêi·ªÉm th√†nh vi√™n</label>
                                                <input type="number" class="form-control" id="profile-loyaltyPoints" readonly>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">H·∫°ng th√†nh vi√™n</label>
                                                <input type="text" class="form-control" id="profile-memberLevel" readonly>
                                            </div>
                                            <div class="col-12">
                                                <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Bookings Tab -->
                        <div class="tab-pane fade" id="bookings">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">L·ªãch s·ª≠ ƒë·∫∑t ph√≤ng kh√°ch s·∫°n</h4>
                                    <div class="table-responsive">
                                        <table class="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Kh√°ch s·∫°n</th>
                                                    <th>Th√¥ng tin ph√≤ng</th>
                                                    <th>Th·ªùi gian</th>
                                                    <th>Th√¥ng tin kh√°ch</th>
                                                    <th>Tr·∫°ng th√°i</th>
                                                    <th>Thao t√°c</th>
                                                </tr>
                                            </thead>
                                            <tbody id="bookings-table-hotel">
                                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="card mt-4">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">L·ªãch s·ª≠ ƒë·∫∑t tour</h4>
                                    <div class="table-responsive">
                                        <table class="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th>T√™n tour</th>
                                                    <th>Ng√†y kh·ªüi h√†nh</th>
                                                    <th>S·ªë ng∆∞·ªùi</th>
                                                    <th>T√™n kh√°ch h√†ng</th>
                                                    <th>Tr·∫°ng th√°i</th>
                                                    <th>Thao t√°c</th>
                                                </tr>
                                            </thead>
                                            <tbody id="bookings-table-tour">
                                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Favorites Tab -->
                        <div class="tab-pane fade" id="favorites">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">Danh s√°ch y√™u th√≠ch</h4>
                                    <div class="row" id="favorites-list">
                                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reviews Tab -->
                        <div class="tab-pane fade" id="reviews">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">ƒê√°nh gi√° c·ªßa t√¥i</h4>
                                    <div id="reviews-list">
                                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Tab -->
                        <div class="tab-pane fade" id="settings">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">C√†i ƒë·∫∑t t√†i kho·∫£n</h4>
                                    <form id="settings-form">
                                        <div class="mb-3">
                                            <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                            <input type="password" class="form-control" id="current-password">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
                                            <input type="password" class="form-control" id="new-password">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                            <input type="password" class="form-control" id="confirm-password">
                                        </div>
                                        <button type="submit" class="btn btn-primary">ƒê·ªïi m·∫≠t kh·∫©u</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Payments Tab -->
                        <div class="tab-pane fade" id="payments">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">L·ªãch s·ª≠ thanh to√°n/giao d·ªãch</h4>
                                    <div class="table-responsive">
                                        <table class="table align-middle">
                                            <thead>
                                                <tr>
                                                    <th>M√£ giao d·ªãch</th>
                                                    <th>Ng√†y</th>
                                                    <th>S·ªë ti·ªÅn</th>
                                                    <th>Ph∆∞∆°ng th·ª©c</th>
                                                    <th>Tr·∫°ng th√°i</th>
                                                    <th>H√≥a ƒë∆°n</th>
                                                </tr>
                                            </thead>
                                            <tbody id="payments-table">
                                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notifications Tab -->
                        <!-- <div class="tab-pane fade" id="notifications">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-4">Th√¥ng b√°o c√° nh√¢n</h4>
                                    <ul class="list-group" id="notifications-list">
                                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                                    <!-- </ul>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- End Contact Section -->

   
    

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content"
            style="max-width: 400px; padding: 32px 28px 24px 28px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.18);">
            <span class="close" id="close-auth-modal" style="right: 18px; top: 12px; font-size: 32px;">&times;</span>

            <div id="auth-forms">
                <form id="login-form" class="auth-form" style="text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="login-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="email" id="login-email" placeholder="e.g. elon@tesla.com" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="login-password" style="font-weight: 500;">M·∫≠t kh·∫©u</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="login-password" placeholder="e.g. ilovemangools123" required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">ƒêƒÉng nh·∫≠p</button>
                    <div class="login-links">
                        <a href="#" id="to-register">Kh√¥ng c√≥ t√†i kho·∫£n?</a>
                        <a href="#" id="to-forgot">Qu√™n m·∫≠t kh·∫©u?</a>
                    </div>
                </form>

                <form id="register-form" class="auth-form" style="display: none; text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-username" style="font-weight: 500;">T√™n ng∆∞·ªùi d√πng</label>
                        <div class="input-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="register-username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="register-email" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-password" style="font-weight: 500;">M·∫≠t kh·∫©u</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="register-password" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" required />
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="register-confirm-password" style="font-weight: 500;">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                        <div class="input-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="register-confirm-password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                                required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">ƒêƒÉng k√Ω</button>
                    <div class="login-links">
                        <a href="#" id="to-login">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</a>
                    </div>
                </form>

                <form id="forgot-form" class="auth-form" style="display: none; text-align:center;">
                    <div class="form-group" style="margin-bottom: 18px; text-align:left;">
                        <label for="forgot-email" style="font-weight: 500;">Email</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="forgot-email" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required />
                        </div>
                    </div>
                    <button type="submit" class="btn-gradient">G·ª≠i y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
                    <div class="login-links">
                        <a href="#" id="back-to-login">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.appspot.com",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);

        // Theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√† c·∫≠p nh·∫≠t UI
        firebase.auth().onAuthStateChanged(function (user) {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // C·∫≠p nh·∫≠t UI ƒëƒÉng nh·∫≠p
            updateUserUI(user);

            // L·∫•y v√† hi·ªÉn th·ªã d·ªØ li·ªáu
            loadUserData(user);
            loadBookings(user);
            loadFavorites(user);
            loadReviews(user);
            loadPayments(user);
            loadNotifications(user);
        });

        // H√†m c·∫≠p nh·∫≠t UI ng∆∞·ªùi d√πng
        function updateUserUI(user) {
            const loginBtn = document.getElementById('open-login-modal');
            const userDropdown = document.getElementById('user-dropdown');
            const userName = document.getElementById('user-name');
            const sidebarName = document.getElementById('sidebar-user-name');
            const sidebarEmail = document.getElementById('sidebar-user-email');

            if (loginBtn) loginBtn.style.display = 'none';
            if (userDropdown) {
                userDropdown.style.display = 'block';
                if (userName) userName.textContent = user.displayName || user.email;
            }

            if (sidebarName) sidebarName.textContent = user.displayName || 'Ch∆∞a c·∫≠p nh·∫≠t';
            if (sidebarEmail) sidebarEmail.textContent = user.email;
        }

        // H√†m l·∫•y th√¥ng tin ng∆∞·ªùi d√πng
        function loadUserData(user) {
            const userRef = firebase.database().ref('users/' + user.uid);
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val() || {};

                document.getElementById('profile-name').value = userData.name || user.displayName || '';
                document.getElementById('profile-email').value = user.email;
                document.getElementById('profile-phone').value = userData.phone || '';
                document.getElementById('profile-birthday').value = userData.birthday || '';
                document.getElementById('profile-address').value = userData.address || '';
                document.getElementById('profile-gender').value = userData.gender || '';
                document.getElementById('profile-nationality').value = userData.nationality || '';
                document.getElementById('profile-identityNumber').value = userData.identityNumber || '';
                document.getElementById('profile-loyaltyPoints').value = userData.loyaltyPoints || 0;
                document.getElementById('profile-memberLevel').value = userData.memberLevel || '';

                // Sidebar
                document.getElementById('sidebar-user-name').textContent = userData.name || user.displayName || 'Ch∆∞a c·∫≠p nh·∫≠t';
                document.getElementById('sidebar-user-email').textContent = user.email;
                // Thay ƒë·ªïi d√≤ng n√†y ƒë·ªÉ c√≥ icon:
                document.getElementById('sidebar-memberLevel').innerHTML = userData.memberLevel ? getMemberLevelIcon(userData.memberLevel) : '';
                document.getElementById('sidebar-loyaltyPoints').textContent = userData.loyaltyPoints ? `ƒêi·ªÉm: ${userData.loyaltyPoints}` : '';
                const avatarImg = document.getElementById('sidebar-avatar');
                if (avatarImg) avatarImg.src = userData.avatar || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';

                // G·ªçi ph√¢n h·∫°ng t·ª± ƒë·ªông
                updateMemberLevel(user);
            });

            // X·ª≠ l√Ω form c·∫≠p nh·∫≠t th√¥ng tin
            document.getElementById('profile-form').addEventListener('submit', function (e) {
                e.preventDefault();
                // Ki·ªÉm tra d·ªØ li·ªáu nh·∫≠p v√†o
                const name = document.getElementById('profile-name').value.trim();
                const phone = document.getElementById('profile-phone').value.trim();
                const birthday = document.getElementById('profile-birthday').value.trim();
                const address = document.getElementById('profile-address').value.trim();
                const gender = document.getElementById('profile-gender').value.trim();
                const nationality = document.getElementById('profile-nationality').value.trim();
                const identity = document.getElementById('profile-identityNumber').value.trim();

                // Regex ki·ªÉm tra ƒë·ªãnh d·∫°ng
                const phoneRegex = /^(0[3-9][0-9]{8,9})$/;
                const identityRegex = /^\d{9,12}$/;
                const nameRegex = /^[a-zA-Z√Ä-·ªπ\s'.-]{2,}$/u;
                // ƒê·ªãa ch·ªâ: cho ph√©p nh·∫≠p t·ª± do, ch·ªâ ki·ªÉm tra kh√¥ng r·ªóng
                function isValidVietnamAddress(address) {
                    return !!address && address.length > 0;
                }
                const today = new Date();
                let valid = true;
                let msg = '';

                if (!name || !nameRegex.test(name)) {
                    valid = false;
                    msg = 'Vui l√≤ng nh·∫≠p h·ªç t√™n th·∫≠t, kh√¥ng ch·ª©a k√Ω t·ª± ƒë·∫∑c bi·ªát v√† t·ªëi thi·ªÉu 2 k√Ω t·ª±.';
                } else if (!phone || !phoneRegex.test(phone)) {
                    valid = false;
                    msg = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë Vi·ªát Nam h·ª£p l·ªá.';
                } else if (!birthday) {
                    valid = false;
                    msg = 'Vui l√≤ng nh·∫≠p ng√†y sinh.';
                } else if (new Date(birthday) > today) {
                    valid = false;
                    msg = 'Ng√†y sinh kh√¥ng h·ª£p l·ªá.';
                } else if (!address || !isValidVietnamAddress(address)) {
                    valid = false;
                    msg = 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ.';
                } else if (!nationality) {
                    valid = false;
                    msg = 'Vui l√≤ng nh·∫≠p qu·ªëc t·ªãch.';
                } else if (!identity || !identityRegex.test(identity)) {
                    valid = false;
                    msg = 'S·ªë CMND/CCCD ph·∫£i l√† 9-12 ch·ªØ s·ªë.';
                }

                if (!valid) {
                    Swal.fire({
                        title: 'Th√¥ng tin kh√¥ng h·ª£p l·ªá!',
                        text: msg,
                        icon: 'warning',
                        confirmButtonColor: '#1a237e'
                    });
                    return;
                }
                updateProfile(user, userRef);
            });
        }

        // H√†m l·∫•y l·ªãch s·ª≠ ƒë·∫∑t ph√≤ng
        function loadBookings(user) {
            const bookingsRef = firebase.database().ref('bookings');
            bookingsRef.orderByChild('customerEmail').equalTo(user.email).on('value', (snapshot) => {
                const hotelTable = document.getElementById('bookings-table-hotel');
                const tourTable = document.getElementById('bookings-table-tour');
                if (!hotelTable || !tourTable) return;
                hotelTable.innerHTML = '';
                tourTable.innerHTML = '';
                if (snapshot.exists()) {
                    let bookings = [];
                    snapshot.forEach((bookingSnapshot) => {
                        bookings.push({
                            id: bookingSnapshot.key,
                            ...bookingSnapshot.val()
                        });
                    });
                    // S·∫Øp x·∫øp theo th·ªùi gian t·∫°o m·ªõi nh·∫•t
                    bookings.sort((a, b) => b.createdAt - a.createdAt);
                    let hasHotel = false, hasTour = false;
                    bookings.forEach(booking => {
                        if (booking.bookingType === 'tour') {
                            addTourBookingRow(booking, tourTable);
                            hasTour = true;
                        } else {
                            addBookingRow(booking, hotelTable);
                            hasHotel = true;
                        }
                    });
                    if (!hasHotel) hotelTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t ph√≤ng kh√°ch s·∫°n</td></tr>';
                    if (!hasTour) tourTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t tour</td></tr>';
                } else {
                    hotelTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t ph√≤ng kh√°ch s·∫°n</td></tr>';
                    tourTable.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·∫∑t tour</td></tr>';
                }
            });
        }

        // H√†m th√™m h√†ng ƒë·∫∑t ph√≤ng v√†o b·∫£ng
        function addBookingRow(booking, table) {
            const row = document.createElement('tr');
            const bookingDate = new Date(booking.createdAt);
            const today = new Date();
            const checkInDate = new Date(booking.checkIn);

            // X√°c ƒë·ªãnh tr·∫°ng th√°i ƒë·∫∑t ph√≤ng
            let status = '';
            let statusClass = '';

            if (checkInDate < today) {
                status = 'ƒê√£ ho√†n th√†nh';
                statusClass = 'success';
            } else if (checkInDate > today) {
                status = 'S·∫Øp t·ªõi';
                statusClass = 'warning';
            } else {
                status = 'ƒêang di·ªÖn ra';
                statusClass = 'primary';
            }

            row.innerHTML = `
            <td>
                <div class="fw-semibold">${booking.hotelName || booking.hotelId}</div>
            </td>
            <td>
                <div class="mb-1">${booking.roomId}</div>
            </td>
            <td>
                <div class="mb-1">Check-in: ${formatDate(booking.checkIn)}</div>
                <div>Check-out: ${formatDate(booking.checkOut)}</div>
                <small class="text-muted">ƒê·∫∑t ng√†y: ${formatDateTime(booking.createdAt)}</small>
            </td>
            <td>
                <div class="mb-1">Kh√°ch: ${booking.guests} ng∆∞·ªùi</div>
                <div class="mb-1">T√™n: ${booking.customerName}</div>
                <div>SƒêT: ${booking.customerPhone}</div>
            </td>
            <td>
                <span class="badge bg-${statusClass}">${status}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewBookingDetails('${booking.id}')">
                    <i class="fas fa-info-circle me-1"></i> Chi ti·∫øt
                </button>
                <button class="btn btn-sm btn-outline-warning ms-1" onclick="editBooking('${booking.id}', 'hotel')">
                    <i class="fas fa-edit me-1"></i> S·ª≠a
                </button>
                <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteBooking('${booking.id}')">
                    <i class="fas fa-trash-alt me-1"></i> X√≥a
                </button>
            </td>
        `;
            table.appendChild(row);
        }

        // H√†m h·ªó tr·ª£ format ng√†y th√°ng
        function formatDate(dateString) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('vi-VN', options);
        }

        function formatDateTime(timestamp) {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(timestamp).toLocaleDateString('vi-VN', options);
        }

        // H√†m l·∫•y danh s√°ch y√™u th√≠ch
        function loadFavorites(user) {
            const favoritesRef = firebase.database().ref('favorites/' + user.uid);
            favoritesRef.on('value', (snapshot) => {
                const favoritesList = document.getElementById('favorites-list');
                if (!favoritesList) return;

                favoritesList.innerHTML = '';

                if (snapshot.exists()) {
                    snapshot.forEach((favoriteSnapshot) => {
                        const favorite = favoriteSnapshot.val();
                        addFavoriteItem(favorite, favoritesList);
                    });
                } else {
                    favoritesList.innerHTML = '<div class="col-12 text-center">Ch∆∞a c√≥ kh√°ch s·∫°n y√™u th√≠ch</div>';
                }
            });
        }

        // H√†m th√™m item y√™u th√≠ch
        function addFavoriteItem(favorite, container) {
            const col = document.createElement('div');
            col.className = 'col-md-4';
            col.innerHTML = `
            <div class="favorite-item">
                <img src="${favorite.image || 'https://placehold.co/300x200?text=Hotel+Image'}" 
     alt="${favorite.name}" 
     onerror="this.src='https://placehold.co/300x200?text=Hotel+Image'">
                <div class="overlay">
                    <h5>${favorite.name || 'Kh√¥ng c√≥ t√™n'}</h5>
                    <p>${favorite.location || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ'}</p>
                </div>
            </div>
        `;
            container.appendChild(col);
        }

        // H√†m l·∫•y ƒë√°nh gi√°
        function loadReviews(user) {
            const reviewsRef = firebase.database().ref('reviews');
            reviewsRef.orderByChild('userId').equalTo(user.uid).on('value', (snapshot) => {
                const reviewsList = document.getElementById('reviews-list');
                if (!reviewsList) return;

                reviewsList.innerHTML = '';

                if (snapshot.exists()) {
                    snapshot.forEach((reviewSnapshot) => {
                        const review = reviewSnapshot.val();
                        addReviewItem(review, reviewsList);
                    });
                } else {
                    reviewsList.innerHTML = '<div class="text-center">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</div>';
                }
            });
        }

        // H√†m th√™m item ƒë√°nh gi√°
        function addReviewItem(review, container) {
            const div = document.createElement('div');
            div.className = 'review-item';
            div.innerHTML = `
            <div class="rating">
                ${'‚òÖ'.repeat(review.rating || 0)}${'‚òÜ'.repeat(5 - (review.rating || 0))}
            </div>
            <h5>${review.hotelName || 'Kh√¥ng c√≥ t√™n kh√°ch s·∫°n'}</h5>
            <p>${review.comment || 'Kh√¥ng c√≥ n·ªôi dung'}</p>
            <span class="date">${new Date(review.date).toLocaleDateString('vi-VN')}</span>
        `;
            container.appendChild(div);
        }

        // H√†m c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n
        function updateProfile(user, userRef) {
            const updates = {
                name: document.getElementById('profile-name').value,
                phone: document.getElementById('profile-phone').value,
                birthday: document.getElementById('profile-birthday').value,
                address: document.getElementById('profile-address').value,
                gender: document.getElementById('profile-gender').value,
                nationality: document.getElementById('profile-nationality').value,
                identityNumber: document.getElementById('profile-identityNumber').value,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            Swal.fire({
                title: 'ƒêang c·∫≠p nh·∫≠t...',
                text: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            user.updateProfile({
                displayName: updates.name,
                photoURL: updates.avatar
            }).then(() => {
                return userRef.update(updates);
            }).then(() => {
                Swal.fire({
                    title: 'Th√†nh c√¥ng!',
                    text: 'Th√¥ng tin c√° nh√¢n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                    icon: 'success',
                    confirmButtonColor: '#1a237e'
                });

                document.getElementById('sidebar-user-name').textContent = updates.name;
                document.getElementById('user-name').textContent = updates.name;
                document.getElementById('sidebar-avatar').src = updates.avatar || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';
            }).catch((error) => {
                console.error('L·ªói c·∫≠p nh·∫≠t:', error);
                Swal.fire({
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i sau.',
                    icon: 'error',
                    confirmButtonColor: '#1a237e'
                });
            });
        }

        // H√†m xem chi ti·∫øt ƒë·∫∑t ph√≤ng
        function viewBookingDetails(bookingId) {
            const bookingRef = firebase.database().ref('bookings/' + bookingId);
            bookingRef.once('value').then((snapshot) => {
                const booking = snapshot.val();
                if (booking) {
                    // This function now correctly handles both tour and hotel bookings
                    const isTour = booking.bookingType === 'tour';
                    const title = isTour ? 'Chi ti·∫øt ƒë·∫∑t tour' : 'Chi ti·∫øt ƒë·∫∑t ph√≤ng';

                    let detailsHtml = '';

                    if (isTour) {
                        detailsHtml = `
                            <div class="mb-3">
                                <h5 class="mb-2">Th√¥ng tin tour</h5>
                                <p class="mb-1"><strong>T√™n tour:</strong> ${booking.tourName || booking.hotelName || ''}</p>
                                <p class="mb-1"><strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${booking.tourLocation || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                                <p class="mb-1"><strong>Th·ªùi gian:</strong> ${booking.tourDuration || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                            </div>
                            <div class="mb-3">
                                <h5 class="mb-2">L·ªãch tr√¨nh</h5>
                                <p class="mb-1"><strong>Ng√†y kh·ªüi h√†nh:</strong> ${formatDate(booking.checkIn)}</p>
                                <p class="mb-1"><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDateTime(booking.createdAt)}</p>
                            </div>
                        `;
                    } else {
                        detailsHtml = `
                            <div class="mb-3">
                                <h5 class="mb-2">Th√¥ng tin kh√°ch s·∫°n</h5>
                                <p class="mb-1"><strong>Kh√°ch s·∫°n:</strong> ${booking.hotelName || booking.hotelId}</p>
                                <p class="mb-1"><strong>Lo·∫°i ph√≤ng:</strong> ${booking.roomId}</p>
                            </div>
                            <div class="mb-3">
                                <h5 class="mb-2">Th·ªùi gian</h5>
                                <p class="mb-1"><strong>Nh·∫≠n ph√≤ng:</strong> ${formatDate(booking.checkIn)}</p>
                                <p class="mb-1"><strong>Tr·∫£ ph√≤ng:</strong> ${formatDate(booking.checkOut)}</p>
                                <p class="mb-1"><strong>Ng√†y ƒë·∫∑t:</strong> ${formatDateTime(booking.createdAt)}</p>
                            </div>
                        `;
                    }

                    detailsHtml += `
                        <div class="mb-3">
                            <h5 class="mb-2">Th√¥ng tin kh√°ch h√†ng</h5>
                            <p class="mb-1"><strong>H·ªç t√™n:</strong> ${booking.customerName || ''}</p>
                            <p class="mb-1"><strong>Email:</strong> ${booking.customerEmail || ''}</p>
                            <p class="mb-1"><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${booking.customerPhone || ''}</p>
                            <p class="mb-1"><strong>S·ªë kh√°ch:</strong> ${booking.numberOfGuests || booking.guests || 1} ng∆∞·ªùi</p>
                            <p class="mb-1"><strong>Ghi ch√∫:</strong> ${booking.note || 'Kh√¥ng c√≥'}</p>
                        </div>
                    `;

                    Swal.fire({
                        title: title,
                        html: `<div class="text-start">${detailsHtml}</div>`,
                        confirmButtonColor: '#1a237e',
                        confirmButtonText: 'ƒê√≥ng',
                        customClass: {
                            container: 'booking-detail-modal'
                        }
                    });
                }
            });
        }

        // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
        document.getElementById('logout-btn').addEventListener('click', function (e) {
            e.preventDefault();
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
                Swal.fire({
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t. Vui l√≤ng th·ª≠ l·∫°i sau.',
                    icon: 'error',
                    confirmButtonColor: '#1a237e'
                });
            });
        });

        function addTourBookingRow(booking, table) {
            const row = document.createElement('tr');
            const departureDate = new Date(booking.checkIn);
            const today = new Date();
            let status = '';
            let statusClass = '';

            if (departureDate < today) {
                status = 'ƒê√£ ho√†n th√†nh';
                statusClass = 'success';
            } else if (departureDate.toDateString() === today.toDateString()) {
                status = 'ƒêang di·ªÖn ra';
                statusClass = 'primary';
            } else {
                status = 'S·∫Øp t·ªõi';
                statusClass = 'warning';
            }

            row.innerHTML = `
                <td>
                    <div class="fw-semibold">${booking.tourName || booking.hotelName || 'N/A'}</div>
                    <small class="text-muted">${booking.tourLocation || ''}</small>
                </td>
                <td>
                    <div>${formatDate(booking.checkIn)}</div>
                    <small class="text-muted">ƒê·∫∑t ng√†y: ${formatDateTime(booking.createdAt)}</small>
                </td>
                <td>${booking.numberOfGuests || booking.guests || 1}</td>
                <td>${booking.customerName || 'N/A'}</td>
                <td>
                    <span class="badge bg-${statusClass}">${status}</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewBookingDetails('${booking.id}')">
                        <i class="fas fa-info-circle me-1"></i> Chi ti·∫øt
                    </button>
                    <button class="btn btn-sm btn-outline-warning ms-1" onclick="editBooking('${booking.id}', 'tour')">
                        <i class="fas fa-edit me-1"></i> S·ª≠a
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteBooking('${booking.id}')">
                        <i class="fas fa-trash-alt me-1"></i> X√≥a
                    </button>
                </td>
            `;
            table.appendChild(row);
        }

        function viewTourBookingDetails(bookingId) {
            // This function is now merged into viewBookingDetails
            viewBookingDetails(bookingId);
        }

        // Mobile Menu Toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const navLinks = document.getElementById('nav-links');

        if (mobileMenuBtn && navLinks) {
            mobileMenuBtn.addEventListener('click', function () {
                this.classList.toggle('active');
                navLinks.classList.toggle('active');
            });

            // Close mobile menu when clicking on links
            navLinks.addEventListener('click', function (e) {
                if (e.target.tagName === 'A') {
                    mobileMenuBtn.classList.remove('active');
                    navLinks.classList.remove('active');
                }
            });

            // Close mobile menu when clicking outside
            document.addEventListener('click', function (e) {
                if (!mobileMenuBtn.contains(e.target) && !navLinks.contains(e.target)) {
                    mobileMenuBtn.classList.remove('active');
                    navLinks.classList.remove('active');
                }
            });
        }

        const sidebarAvatarUpload = document.getElementById('sidebar-avatar-upload');
        if (sidebarAvatarUpload) {
            sidebarAvatarUpload.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;
                const user = firebase.auth().currentUser;
                if (!user) return;

                // Hi·ªÉn th·ªã ·∫£nh ngay l·∫≠p t·ª©c
                const reader = new FileReader();
                reader.onload = function (event) {
                    document.getElementById('sidebar-avatar').src = event.target.result;
                };
                reader.readAsDataURL(file);

                // Upload l√™n Cloudinary
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'nguyentienchuc'); // preset unsigned

                Swal.fire({
                    title: 'ƒêang t·∫£i ·∫£nh l√™n Cloudinary...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                fetch('https://api.cloudinary.com/v1_1/dwrc3ig9e/image/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.secure_url) {
                        document.getElementById('sidebar-avatar').src = data.secure_url;
                        return firebase.database().ref('users/' + user.uid).update({
                            avatar: data.secure_url,
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    } else {
                        throw new Error('Upload th·∫•t b·∫°i');
                    }
                })
                .then(() => {
                    Swal.fire({
                        title: 'Th√†nh c√¥ng!',
                        text: '·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                        icon: 'success',
                        confirmButtonColor: '#1a237e'
                    });
                })
                .catch(error => {
                    Swal.fire({
                        title: 'L·ªói!',
                        text: 'Kh√¥ng th·ªÉ t·∫£i ·∫£nh l√™n Cloudinary. Vui l√≤ng th·ª≠ l·∫°i.',
                        icon: 'error',
                        confirmButtonColor: '#1a237e'
                    });
                    console.error('Upload avatar error:', error);
                });
            });
        }

        if (payment.status === 'success' && !payment.loyaltyAdded) {
    const paymentRef = paymentSnapshot.ref;
    paymentRef.transaction(function(currentPayment) {
        if (currentPayment && currentPayment.status === 'success' && !currentPayment.loyaltyAdded) {
            currentPayment.loyaltyAdded = true;
            return currentPayment;
        }
        return;
    }, function(error, committed, snap) {
        if (error) {
            console.error('Transaction failed:', error);
        } else if (committed) {
            // Ch·ªâ khi loyaltyAdded v·ª´a ƒë∆∞·ª£c set th√†nh c√¥ng m·ªõi c·ªông ƒëi·ªÉm
            const points = Math.floor((payment.amount || 0) / 1000);
            if (points > 0) {
                const userRef = firebase.database().ref('users/' + user.uid + '/loyaltyPoints');
                userRef.transaction(function(currentPoints) {
                    return (currentPoints || 0) + points;
                }, function(err, committed2, snap2) {
                    if (committed2) {
                        // Sau khi c·ªông ƒëi·ªÉm th√†nh c√¥ng, c·∫≠p nh·∫≠t note
                        paymentRef.update({
                            note: `ƒê√£ c·ªông ƒëi·ªÉm th√†nh vi√™n: +${points} ƒëi·ªÉm`
                        });
                    }
                });
            } else {
                // N·∫øu kh√¥ng c√≥ ƒëi·ªÉm, v·∫´n ghi note
                paymentRef.update({
                    note: `Thanh to√°n th√†nh c√¥ng nh∆∞ng s·ªë ti·ªÅn kh√¥ng ƒë·ªß ƒë·ªÉ c·ªông ƒëi·ªÉm th√†nh vi√™n`
                });
            }
        }
    });
}
        function viewInvoice(paymentId) {
            const paymentRef = firebase.database().ref('payments/' + paymentId);
            paymentRef.once('value').then(snapshot => {
                const payment = snapshot.val();
                if (payment) {
                    Swal.fire({
                        title: 'Chi ti·∫øt h√≥a ƒë∆°n',
                        html: `
                            <div class="text-start">
                                <p><strong>M√£ giao d·ªãch:</strong> ${payment.transactionId || ''}</p>
                                <p><strong>Ng√†y:</strong> ${payment.date ? new Date(payment.date).toLocaleDateString('vi-VN') : ''}</p>
                                <p><strong>S·ªë ti·ªÅn:</strong> ${payment.amount ? payment.amount.toLocaleString('vi-VN') + '‚Ç´' : ''}</p>
                                <p><strong>Ph∆∞∆°ng th·ª©c:</strong> ${payment.method || ''}</p>
                                <p><strong>Tr·∫°ng th√°i:</strong> ${payment.status === 'success' ? 'Th√†nh c√¥ng' : 'Th·∫•t b·∫°i'}</p>
                                <p><strong>Chi ti·∫øt:</strong> ${payment.detail || ''}</p>
                            </div>
                        `,
                        confirmButtonColor: '#1a237e'
                    });
                }
            });
        }

        function loadNotifications(user) {
            const notificationsRef = firebase.database().ref('notifications/' + user.uid);
            notificationsRef.on('value', (snapshot) => {
                const list = document.getElementById('notifications-list');
                if (!list) return;
                list.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((notiSnapshot) => {
                        const noti = notiSnapshot.val();
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `
                            <div>
                                <strong>${noti.title || 'Th√¥ng b√°o'}</strong>
                                <span class="badge bg-${noti.read ? 'secondary' : 'warning'} float-end">${noti.read ? 'ƒê√£ ƒë·ªçc' : 'M·ªõi'}</span>
                            </div>
                            <div>${noti.content || ''}</div>
                            <small class="text-muted">${noti.date ? new Date(noti.date).toLocaleString('vi-VN') : ''}</small>
                        `;
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li class="list-group-item text-center">Ch∆∞a c√≥ th√¥ng b√°o n√†o</li>';
                }
            });
        }

        function editBooking(bookingId, type) {
            const bookingRef = firebase.database().ref('bookings/' + bookingId);
            bookingRef.once('value').then(snapshot => {
                const booking = snapshot.val();
                if (!booking) return;
                let html = '';
                if (type === 'hotel') {
                    html = `
                        <input id="edit-hotelName" class="swal2-input" placeholder="T√™n kh√°ch s·∫°n" value="${booking.hotelName || ''}">
                        <input id="edit-roomId" class="swal2-input" placeholder="Lo·∫°i ph√≤ng" value="${booking.roomId || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-checkOut" class="swal2-input" type="date" value="${booking.checkOut ? booking.checkOut.split('T')[0] : ''}">
                        <input id="edit-guests" class="swal2-input" type="number" placeholder="S·ªë kh√°ch" value="${booking.guests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="SƒêT" value="${booking.customerPhone || ''}">
                    `;
                } else {
                    html = `
                        <input id="edit-tourName" class="swal2-input" placeholder="T√™n tour" value="${booking.tourName || ''}">
                        <input id="edit-tourLocation" class="swal2-input" placeholder="ƒê·ªãa ƒëi·ªÉm" value="${booking.tourLocation || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-numberOfGuests" class="swal2-input" type="number" placeholder="S·ªë kh√°ch" value="${booking.numberOfGuests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="SƒêT" value="${booking.customerPhone || ''}">
                    `;
                }
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin',
                    html: html,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        if (type === 'hotel') {
                            return {
                                hotelName: document.getElementById('edit-hotelName').value,
                                roomId: document.getElementById('edit-roomId').value,
                                checkIn: document.getElementById('edit-checkIn').value,
                                checkOut: document.getElementById('edit-checkOut').value,
                                guests: parseInt(document.getElementById('edit-guests').value),
                                customerName: document.getElementById('edit-customerName').value,
                                customerPhone: document.getElementById('edit-customerPhone').value
                            };
                        } else {
                            return {
                                tourName: document.getElementById('edit-tourName').value,
                                tourLocation: document.getElementById('edit-tourLocation').value,
                                checkIn: document.getElementById('edit-checkIn').value,
                                numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value),
                                customerName: document.getElementById('edit-customerName').value,
                                customerPhone: document.getElementById('edit-customerPhone').value
                            };
                        }
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        bookingRef.update(result.value).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                        });
                    }
                });
            });
        }

        function deleteBooking(bookingId) {
            Swal.fire({
                title: 'X√≥a ƒë·∫∑t ph√≤ng?',
                text: 'B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªãch s·ª≠ n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then(result => {
                if (result.isConfirmed) {
                    firebase.database().ref('bookings/' + bookingId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                    });
                }
            });
        }

        // H√†m tr·∫£ v·ªÅ icon + t√™n h·∫°ng th√†nh vi√™n
function getMemberLevelIcon(level) {
    switch(level) {
        case 'ƒê·ªìng':
            return '<i class="fas fa-medal" style="color:#b87333"></i> ƒê·ªìng';
        case 'B·∫°c':
            return '<i class="fas fa-medal" style="color:#b0c4de"></i> B·∫°c';
        case 'V√†ng':
            return '<i class="fas fa-medal" style="color:#ffd700"></i> V√†ng';
        case 'Kim c∆∞∆°ng':
            return '<i class="fas fa-gem" style="color:#00bcd4"></i> Kim c∆∞∆°ng';
        case 'L∆∞u ly':
            return '<i class="fas fa-crown" style="color:#8e24aa"></i> L∆∞u ly';
        default:
            return level || '';
    }
}

// Th√™m h√†m ph√¢n h·∫°ng v√† c·∫≠p nh·∫≠t memberLevel
function updateMemberLevel() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    const userRef = firebase.database().ref('users/' + user.uid);
    userRef.once('value').then(snapshot => {
        const data = snapshot.val() || {};
        const points = data.loyaltyPoints || 0;
        let level = 'ƒê·ªìng';
        if (points >= 10000) level = 'Kim c∆∞∆°ng';
        else if (points >= 5000) level = 'V√†ng';
        else if (points >= 1000) level = 'B·∫°c';
        if (data.memberLevel !== level) {
            userRef.update({ memberLevel: level });
        }
        // Hi·ªÉn th·ªã quy·ªÅn l·ª£i khi hover
        const sidebarLevel = document.getElementById('sidebar-memberLevel');
        if (sidebarLevel) {
            sidebarLevel.title =
                'ƒê·ªìng: C∆° b·∫£n\n' +
                'B·∫°c: Gi·∫£m gi√° 5%\n' +
                'V√†ng: Gi·∫£m gi√° 10%, ∆∞u ti√™n h·ªó tr·ª£\n' +
                'Kim c∆∞∆°ng: Gi·∫£m gi√° 15%, qu√† t·∫∑ng ƒë·∫∑c bi·ªát';
        }
    });
}

// H√†m reset l·∫°i ƒëi·ªÉm th√†nh vi√™n d·ª±a tr√™n c√°c payment th√†nh c√¥ng
function resetLoyaltyPoints(user) {
    Swal.fire({
        title: 'X√°c nh·∫≠n',
        text: 'B·∫°n c√≥ ch·∫Øc mu·ªën reset v√† t√≠nh l·∫°i ƒëi·ªÉm th√†nh vi√™n? ƒêi·ªÉm s·∫Ω ƒë∆∞·ª£c t√≠nh l·∫°i theo c√°c giao d·ªãch th√†nh c√¥ng!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ƒê·ªìng √Ω',
        cancelButtonText: 'H·ªßy'
    }).then((result) => {
        if (!result.isConfirmed) return;
        // Reset ƒëi·ªÉm v·ªÅ 0
        const userRef = firebase.database().ref('users/' + user.uid);
        userRef.update({ loyaltyPoints: 0 }).then(() => {
            // L·∫•y t·∫•t c·∫£ payment th√†nh c√¥ng
            firebase.database().ref('payments').orderByChild('userId').equalTo(user.uid).once('value', (snapshot) => {
                let totalPoints = 0;
                let updates = {};
                snapshot.forEach((paymentSnapshot) => {
                    const payment = paymentSnapshot.val();
                    if (payment.status === 'success') {
                        // 100.000ƒë = 10 ƒëi·ªÉm
                        const points = Math.floor((payment.amount || 0) / 100000) * 10;
                        if (points > 0) {
                            totalPoints += points;
                        }
                        // ƒê√°nh d·∫•u ƒë√£ c·ªông ƒëi·ªÉm
                        if (!payment.loyaltyAdded) {
                            updates[paymentSnapshot.key + '/loyaltyAdded'] = true;
                        }
                    }
                });
                // C·∫≠p nh·∫≠t ƒëi·ªÉm v√† loyaltyAdded
                const updatesObj = {};
                updatesObj['users/' + user.uid + '/loyaltyPoints'] = totalPoints;
                Object.keys(updates).forEach(k => {
                    updatesObj['payments/' + k] = true;
                });
                firebase.database().ref().update(updatesObj).then(() => {
                    // C·∫≠p nh·∫≠t ph√¢n h·∫°ng
                    updateMemberLevelCustom(user, totalPoints);
                    Swal.fire('Th√†nh c√¥ng!', 'ƒêi·ªÉm th√†nh vi√™n ƒë√£ ƒë∆∞·ª£c reset v√† t√≠nh l·∫°i: ' + totalPoints + ' ƒëi·ªÉm.', 'success');
                });
            });
        });
    });
}

// H√†m ph√¢n h·∫°ng m·ªõi (c√≥ th√™m L∆∞u ly)
function updateMemberLevelCustom(user, points) {
    let level = 'ƒê·ªìng';
    if (points >= 20000) level = 'L∆∞u ly';
    else if (points >= 10000) level = 'Kim c∆∞∆°ng';
    else if (points >= 5000) level = 'V√†ng';
    else if (points >= 1000) level = 'B·∫°c';
    firebase.database().ref('users/' + user.uid + '/memberLevel').set(level);
}

// Th√™m n√∫t v√†o tab L·ªãch s·ª≠ thanh to√°n
// setTimeout(() => {
//     const paymentsTab = document.querySelector('#payments .card-body');
//     if (paymentsTab && !document.getElementById('reset-loyalty-btn')) {
//         const btn = document.createElement('button');
//         btn.id = 'reset-loyalty-btn';
//         btn.className = 'btn btn-warning mb-3';
//         btn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Reset & T√≠nh l·∫°i ƒëi·ªÉm th√†nh vi√™n';
//         btn.onclick = function() {
//             const user = firebase.auth().currentUser;
//             if (user) resetLoyaltyPoints(user);
//         };
//         paymentsTab.prepend(btn);
//     }
// }, 1000);
    </script>
    <script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/684e312c6b65fa190ea6f4dd/1iton06be';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
End of Tawk.to Script

    <script>
        // Hi·ªÉn th·ªã ·∫£nh v·ª´a ch·ªçn l√™n avatar ngay l·∫≠p t·ª©c
        document.addEventListener('DOMContentLoaded', function() {
            var avatarInput = document.getElementById('sidebar-avatar-upload');
            var avatarImg = document.getElementById('sidebar-avatar');
            if (avatarInput && avatarImg) {
                avatarInput.addEventListener('change', function(event) {
                    var file = event.target.files[0];
                    if (file) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            avatarImg.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    </script>
</body>

</html>