<!DOCTYPE html>
<html lang="vi">
    

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxuryHavenTravel Admin Dashboard</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Local CSS -->
    <link rel="stylesheet" href="css/admin-dashboard.css">
    <link rel="stylesheet" href="css/admin-dashboard-mobile.css">
    <link rel="stylesheet" href="css/mobile.css">
    
    <!-- Custom CSS for table responsiveness -->
    <style>
        .table-responsive {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table-responsive table {
            min-width: 1000px; /* Ensure minimum width for all columns */
        }
        
        .table thead th {
            background-color: #f8f9fa !important;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .table tbody td {
            vertical-align: middle;
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Custom scrollbar for table */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .btn-group-sm .btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body class="admin-body">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-brand">
                <!-- <i class="fas fa-gem me-2"></i> Example Logo Icon -->
                <span>ADMIN LuxuryHavenTravel</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-group">
                <span class="nav-group-title">MAIN</span>
            <a href="#dashboard" class="nav-item active">
                    <i class="fas fa-home-alt"></i> <span>Dashboard</span>
            </a>
            </div>
            <div class="nav-group">
                <span class="nav-group-title">QU·∫¢N L√ù</span>
            <a href="#staff-management" class="nav-item">
            <i class="fas fa-users-cog"></i><span>Qu·∫£n l√Ω nh√¢n vi√™n</span>
         </a>
            <a href="#roles-management" class="nav-item">
                <i class="fas fa-user-shield"></i> <span>Qu·∫£n l√Ω ch·ª©c v·ª•</span>
            </a>
            <a href="#departments-management" class="nav-item">
                <i class="fas fa-building"></i> <span>Qu·∫£n l√Ω ph√≤ng ban</span>
            </a>
            <a href="#bookings" class="nav-item">
                <i class="fas fa-bed"></i><span>ƒê·∫∑t ph√≤ng</span>
             </a>
            <a href="#bookings-tours" class="nav-item">
                <i class="fas fa-route"></i> <span>ƒê·∫∑t tours</span>
            </a>
            <a href="#hotels" class="nav-item">
                    <i class="fas fa-hotel"></i> <span>Kh√°ch s·∫°n</span>
            </a>
            <a href="#users" class="nav-item">
                    <i class="fas fa-users"></i> <span>Ng∆∞·ªùi d√πng</span>
            </a>
            <a href="#tours" class="nav-item">
                    <i class="fas fa-map-marked-alt"></i> <span>Tours</span>
            </a>
            <a href="#refunds" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i> <span>Qu·∫£n l√Ω ho√†n ti·ªÅn</span>
            </a>
            <a href="#deals" class="nav-item">
                    <i class="fas fa-tags"></i> <span>∆Øu ƒë√£i</span>
                </a>
                <a href="#travel-guides" class="nav-item">
                    <i class="fas fa-book-open"></i> <span>C·∫©m nang du l·ªãch</span>
                </a>
                <a href="#contributions" class="nav-item">
                    <i class="fas fa-user-edit"></i> <span>Duy·ªát c·∫©m nang</span>
                    <span id="pending-contributions-badge" class="badge bg-danger ms-2" style="display: none;">0</span>
                </a>
            </div>
             <div class="nav-group">
                <span class="nav-group-title">H·ªÜ TH·ªêNG</span>
            <a href="#settings" class="nav-item">
                    <i class="fas fa-cog"></i> <span>C√†i ƒë·∫∑t</span>
            </a>
            </div>
        </nav>
        <div class="sidebar-footer">
            <button class="btn btn-danger w-100" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Main Header -->
        <header class="main-header">
             <div class="header-left">
                <button class="mobile-toggle" id="mobile-toggle">
                    <i class="fas fa-bars"></i>
                    </button>
                <h1 class="page-title" id="page-title-header">Dashboard</h1>
                </div>
            <div class="header-right">
                <div class="header-search" id="headerSearchContainer" style="display: none;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="globalSearchInput" placeholder="Search...">
            </div>
                <div class="header-actions">
                    <div class="notification-wrapper">
                        <button class="btn-icon" id="notificationBell">
                            <i class="fas fa-bell"></i>
                            <span class="badge-dot" style="display: none;"></span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h6 class="mb-0">Th√¥ng b√°o</h6>
                                <a href="#" class="btn-link" id="markAllAsReadBtn">ƒê√°nh d·∫•u t·∫•t c·∫£ l√† ƒë√£ ƒë·ªçc</a>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
                                 </div>
                            </div>
                             <div class="notification-footer">
                                <a href="#">Xem t·∫•t c·∫£ th√¥ng b√°o</a>
                            </div>
                        </div>
                    </div>
                    <!-- <button class="btn-icon"><i class="fas fa-cog"></i></button> -->
                </div>
                <!-- <div class="user-profile">
                    <span class="user-name">Omar Ali</span>
                    <span class="user-role">Company Owner</span>
                    <img src="https://i.pravatar.cc/40" alt="User Avatar">
                </div> -->
            </div>
        </header>
        
        <main class="content-wrapper">
        <!-- Roles Management Section (Dynamic) -->
        <div id="roles-management" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Qu·∫£n l√Ω ch·ª©c v·ª•</h5>
                        <input type="text" id="roleSearchInput" class="form-control form-control-sm" style="max-width:220px;" placeholder="T√¨m ki·∫øm t√™n ch·ª©c v·ª•..." oninput="filterAndDisplayRoles()">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="addRole()">
                        <i class="fas fa-plus"></i> Th√™m ch·ª©c v·ª•
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0 table-bordered">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="min-width: 120px;">Ph√≤ng ban</th>
                                    <th style="min-width: 150px;">T√™n ch·ª©c v·ª•</th>
                                    <th style="min-width: 100px;">M√£ ch·ª©c v·ª•</th>
                                    <th style="min-width: 200px;">M√¥ t·∫£</th>
                                    <th style="min-width: 120px;">L∆∞∆°ng c∆° b·∫£n</th>
                                    <th style="min-width: 120px;">Ph·ª• c·∫•p</th>
                                    <th style="min-width: 150px;">Quy·ªÅn h·∫°n</th>
                                    <th style="min-width: 120px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="rolesTable">
                                <!-- Role data will be rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Departments Management Section -->
        <div id="departments-management" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <h5 class="mb-0"><i class="fas fa-building me-2"></i>Qu·∫£n l√Ω ph√≤ng ban</h5>
                        <input type="text" id="departmentSearchInput" class="form-control form-control-sm" style="max-width:220px;" placeholder="T√¨m ki·∫øm t√™n ph√≤ng ban..." oninput="filterAndDisplayDepartments()">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="addDepartment()">
                        <i class="fas fa-plus"></i> Th√™m ph√≤ng ban
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0 table-bordered">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="min-width: 150px;">T√™n ph√≤ng ban</th>
                                    <th style="min-width: 100px;">M√£ ph√≤ng ban</th>
                                    <th style="min-width: 200px;">M√¥ t·∫£</th>
                                    <th style="min-width: 120px;">Tr∆∞·ªüng ph√≤ng</th>
                                    <th style="min-width: 100px;">S·ªë nh√¢n vi√™n</th>
                                    <th style="min-width: 120px;">Ng√¢n s√°ch</th>
                                    <th style="min-width: 100px;">Tr·∫°ng th√°i</th>
                                    <th style="min-width: 150px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="departmentsTable">
                                <!-- Department data will be rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Staff Management Section -->
        <div id="staff-management" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>Qu·∫£n l√Ω nh√¢n vi√™n</h5>
                        <input type="text" id="staffSearchInput" class="form-control form-control-sm" style="max-width:220px;" placeholder="T√¨m ki·∫øm t√™n, email..." oninput="filterAndDisplayStaff()">
                        <select id="staffRoleFilter" class="form-select form-select-sm" style="max-width:160px;" onchange="filterAndDisplayStaff()">
                            <option value="all">T·∫•t c·∫£ vai tr√≤</option>
                            <!-- Dynamic role options will be loaded here -->
                        </select>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="addStaff()">
                        <i class="fas fa-plus"></i> Th√™m nh√¢n vi√™n
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Avatar</th>
                                    <th>T√™n</th>
                                    <th>Email</th>
                                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                    <th>Vai tr√≤</th>
                                    <th>Ng√†y tham gia</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="staffTable">
                                <!-- Staff data will be rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section">
            <!-- Th√™m v√†o sau header, tr∆∞·ªõc ph·∫ßn th·ªëng k√™ cards -->
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="stat-month" class="form-label">Ch·ªçn th√°ng</label>
                <select id="stat-month" class="form-select">
                  <option value="1">Th√°ng 1</option>
                  <option value="2">Th√°ng 2</option>
                  <option value="3">Th√°ng 3</option>
                  <option value="4">Th√°ng 4</option>
                  <option value="5">Th√°ng 5</option>
                  <option value="6">Th√°ng 6</option>
                  <option value="7">Th√°ng 7</option>
                  <option value="8">Th√°ng 8</option>
                  <option value="9">Th√°ng 9</option>
                  <option value="10">Th√°ng 10</option>
                  <option value="11">Th√°ng 11</option>
                  <option value="12">Th√°ng 12</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="stat-year" class="form-label">Ch·ªçn nƒÉm</label>
                <input type="number" id="stat-year" class="form-control" min="2020" max="2100" value="2025">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success w-100" id="export-excel-btn"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</button>
              </div>
            </div>
            <div class="dashboard-greeting mb-4">
              <h2 style="font-weight:700; font-size:2rem; margin-bottom:0.2em;">Xin ch√†o, <span id="admin-greeting-name">Admin</span>!</h2>
              <div style="color:#1976d2; font-size:1.1rem; font-weight:500;">Ch√∫c b·∫°n m·ªôt ng√†y l√†m vi·ªác hi·ªáu qu·∫£ v√† doanh thu b·ª©t ph√° üöÄ</div>
            </div>
            <div class="stats-summary-cards">
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#1976d2 0%,#64b5f6 100%)"><i class="fas fa-user-plus"></i></div>
                <div>
                  <div class="stats-summary-label">Kh√°ch m·ªõi <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="S·ªë ng∆∞·ªùi d√πng m·ªõi ƒëƒÉng k√Ω trong th√°ng n√†y."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-new-users">0</div>
                    <span id="stat-new-users-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">trong th√°ng <span id="stat-month-label"></span>/<span id="stat-year-label"></span></div>
                </div>
              </div>
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#ff9800 0%,#ffc107 100%)"><i class="fas fa-bed"></i></div>
                <div>
                  <div class="stats-summary-label">Ph√≤ng c√≥ ng∆∞·ªùi <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="S·ªë ph√≤ng ƒë√£ c√≥ booking x√°c nh·∫≠n ho·∫∑c ho√†n th√†nh trong th√°ng n√†y."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-rooms-booked">0</div>
                    <span id="stat-rooms-booked-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">ƒë√£ ƒë·∫∑t trong th√°ng</div>
                </div>
              </div>
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#e91e63 0%,#f48fb1 100%)"><i class="fas fa-venus-mars"></i></div>
                <div>
                  <div class="stats-summary-label">Gi·ªõi t√≠nh <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="T·ªïng s·ªë kh√°ch c√≥ booking trong th√°ng n√†y, ph√¢n theo Nam/N·ªØ/Kh√°c."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-gender">0/0/0</div>
                    <span id="stat-gender-male-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">Nam / N·ªØ / Kh√°c</div>
                </div>
              </div>
              <div class="stats-summary-card revenue">
                <div class="stats-summary-icon"><i class="fas fa-coins"></i></div>
                <div>
                  <div class="stats-summary-label">Doanh thu <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="T·ªïng doanh thu t·ª´ c√°c booking ƒë√£ x√°c nh·∫≠n/ho√†n th√†nh trong th√°ng n√†y."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-revenue">0</div>
                    <span id="stat-revenue-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">VNƒê trong th√°ng</div>
                  <canvas id="mini-revenue-chart" height="36" style="margin-top:8px;max-width:180px;"></canvas>
                </div>
              </div>
            </div>
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #e3f2fd; color: #1976d2;">
                            <i class="fas fa-hotel"></i>
                        </div>
                        <div class="title">T·ªïng kh√°ch s·∫°n</div>
                        <div class="value" id="totalHotels">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #e8f5e9; color: #2e7d32;">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="title">ƒê·∫∑t ph√≤ng h√¥m nay</div>
                        <div class="value" id="todayBookings">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #fff3e0; color: #e65100;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="title">T·ªïng ng∆∞·ªùi d√πng</div>
                        <div class="value" id="totalUsers">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #f3e5f5; color: #7b1fa2;">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="title">∆Øu ƒë√£i ƒëang c√≥</div>
                        <div class="value" id="activeDeals">0</div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="bookingTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="newUsersChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookings" class="content-section" style="display: none;">
            <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0">Danh s√°ch ƒë·∫∑t ph√≤ng</h5>
                        
                        <div id="bulk-action-container" class="d-none align-items-center">
                            <span id="selected-count" class="fw-bold me-3"></span>
                            <button class="btn btn-sm btn-secondary" onclick="updateSelectedStatus()">
                                <i class="fas fa-edit me-1"></i> ƒê·ªïi tr·∫°ng th√°i
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelectedBookings()">
                                <i class="fas fa-trash me-1"></i> X√≥a
                            </button>
                        </div>

                        <div class="ms-auto"> <!-- Push the add button to the right -->
                    <button class="btn btn-primary btn-sm" onclick="addBooking()">
                        <i class="fas fa-plus-circle me-1"></i> Th√™m ƒë·∫∑t ph√≤ng
                    </button>
                        </div>
                    </div>
                    <div class="card-body p-3 border-bottom">
                         <div class="row g-2 justify-content-end">
                            <div class="col-md-4">
                                <select id="bookingStatusFilter" class="form-select">
                                    <option value="all" selected>T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                    <option value="pending">Ch·ªù x√°c nh·∫≠n</option>
                                    <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                                    <option value="cancelled">ƒê√£ h·ªßy</option>
                                    <option value="completed">Ho√†n th√†nh</option>
                                </select>
                            </div>
                        </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover align-middle">
                        <thead class="table-light">
                          <tr>
                                    <th>ID</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>Email</th>
                                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>Kh√°ch s·∫°n</th>
                            <th>D·ªãch v·ª•</th>
                            <th>Check-in</th>
                            <th>Check-out</th>
                                    <th>S·ªë kh√°ch</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTable">
                          <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Tours Section -->
        <div id="bookings-tours" class="content-section" style="display: none;">
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h5 class="mb-0">Danh s√°ch ƒë·∫∑t tours</h5>
              <button class="btn btn-primary btn-sm" onclick="addTourBooking()">
                <i class="fas fa-plus-circle me-1"></i> Th√™m ƒë·∫∑t tours
              </button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Kh√°ch h√†ng</th>
                      <th>Email</th>
                      <th>S·ªë ƒëi·ªán tho·∫°i</th>
                      <th>T√™n tour</th>
                      <th>ƒêi·ªÉm ƒë·∫øn</th>
                      <th>Check-in</th>
                      <th>S·ªë kh√°ch</th>
                      <th>Tr·∫°ng th√°i</th>
                      <th>Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody id="bookingsToursTable">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hotels Section -->
        <div id="hotels" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh s√°ch kh√°ch s·∫°n</h5>
                    <button class="btn btn-primary btn-sm" onclick="addHotel()">
                        <i class="fas fa-plus"></i> Th√™m kh√°ch s·∫°n
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="hotelsGrid">
                        <!-- Hotel cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Danh s√°ch ng∆∞·ªùi d√πng</h5>
                        <input type="text" id="userSearchInput" class="form-control form-control-sm" style="max-width:250px;" placeholder="T√¨m ki·∫øm t√™n, email, SƒêT..." oninput="filterAndDisplayUsers()">
                    </div>
                    <div class="d-flex gap-2">
                        <select id="userStatusFilter" class="form-select form-select-sm" style="max-width:150px;" onchange="filterAndDisplayUsers()">
                            <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
                            <option value="inactive">T·∫°m kh√≥a</option>
                            <option value="banned">B·ªã c·∫•m</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="addUser()">
                            <i class="fas fa-plus"></i> Th√™m ng∆∞·ªùi d√πng
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">Avatar</th>
                                    <th>Th√¥ng tin c√° nh√¢n</th>
                                    <th>Li√™n h·ªá</th>
                                    <th>Gi·ªõi t√≠nh</th>
                                    <th>ƒê·ªãa ch·ªâ</th>
                                    <th>Qu·ªëc t·ªãch</th>
                                    <th>Ng√†y sinh</th>
                                    <th>Ng√†y tham gia</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tours Section -->
        <div id="tours" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh s√°ch tours</h5>
                    <button class="btn btn-primary btn-sm" onclick="addTour()">
                        <i class="fas fa-plus"></i> Th√™m tour
                    </button>
                </div>
                <div class="card-body">
                    <div class="accordion" id="toursAccordion">
                        <!-- Accordion for tour categories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Refunds Management Section -->
        <div id="refunds" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Qu·∫£n l√Ω ho√†n ti·ªÅn</h5>
                    <button class="btn btn-success btn-sm" onclick="loadRefunds()">
                        <i class="fas fa-sync-alt"></i> L√†m m·ªõi
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>Email</th>
                                    <th>D·ªãch v·ª•</th>
                                    <th>T·ªïng ti·ªÅn</th>
                                    <th>S·ªë ti·ªÅn ho√†n</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="refundsTable">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deals Management Section -->
        <div id="deals" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh s√°ch ∆Øu ƒë√£i</h5>
                    <button class="btn btn-primary btn-sm" onclick="addDeal()">
                        <i class="fas fa-plus"></i> Th√™m ∆∞u ƒë√£i
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ti√™u ƒë·ªÅ</th>
                                <th>Gi√° m·ªõi</th>
                                <th>Gi√° c≈©</th>
                                <th>Ng√†y k·∫øt th√∫c</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="dealsTableBody">
                            <!-- Deal rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


            <!-- Travel Guides Section -->
            <div id="travel-guides" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Danh s√°ch b√†i vi·∫øt</h5>
                        <button class="btn btn-primary btn-sm" onclick="addTravelGuide()">
                            <i class="fas fa-plus"></i> Th√™m b√†i vi·∫øt
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>H√¨nh ·∫£nh</th>
                                    <th>Ti√™u ƒë·ªÅ</th>
                                    <th>T√°c gi·∫£</th>
                                    <th>Ng√†y ƒëƒÉng</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="travelGuidesTableBody">
                                <!-- Travel guide rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Contributions Section -->
        <div id="contributions" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>C·∫©m nang ch·ªù duy·ªát
                        <span id="contributions-count-badge" class="badge bg-warning ms-2">0</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="filterContributions('all')">
                            <i class="fas fa-list"></i> T·∫•t c·∫£
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="filterContributions('pending')">
                            <i class="fas fa-clock"></i> Ch·ªù duy·ªát
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="filterContributions('approved')">
                            <i class="fas fa-check"></i> ƒê√£ duy·ªát
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="filterContributions('rejected')">
                            <i class="fas fa-times"></i> T·ª´ ch·ªëi
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="contributions-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch c·∫©m nang...</p>
                    </div>
                    
                    <div id="contributions-empty" class="text-center py-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Kh√¥ng c√≥ c·∫©m nang n√†o</h5>
                        <p class="text-muted">Ch∆∞a c√≥ c·∫©m nang n√†o ƒë∆∞·ª£c g·ª≠i t·ª´ members.</p>
                    </div>
                    
                    <div id="contributions-list">
                        <!-- Contributions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>


        <!-- Settings Section -->
        <div id="settings" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">C√†i ƒë·∫∑t h·ªá th·ªëng</h5>
                </div>
                <div class="card-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label class="form-label">T√™n website</label>
                                <input type="text" class="form-control" id="settingWebsiteName" value="LuxuryHavenTravel">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email li√™n h·ªá</label>
                                <input type="email" class="form-control" id="settingContactEmail" value="LuxuryHavenTravel@gmail.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="settingPhoneNumber" value="0837 918 274 - 0912 38 4956 ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <textarea class="form-control" id="settingAddress" rows="3">L·∫ßu 5, T√≤a nh√† ABC, 456 ƒê∆∞·ªùng L√™ Lai, Ph∆∞·ªùng B·∫øn Th√†nh, Qu·∫≠n 1, TP. H·ªì Ch√≠ Minh, Vi·ªát Nam</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                    </form>
                </div>
            </div>
        </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Roles Management Section Logic
        let allRoles = [];
        function loadRoles() {
            const rolesTable = document.getElementById('rolesTable');
            rolesTable.innerHTML = '<tr><td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            db.ref('roles').on('value', (snapshot) => {
                allRoles = [];
                if (snapshot.exists()) {
                    snapshot.forEach((roleSnapshot) => {
                        const role = roleSnapshot.val();
                        role.id = roleSnapshot.key;
                        allRoles.push(role);
                    });
                }
                filterAndDisplayRoles();
            }, (error) => {
                rolesTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
            });
        }

        function filterAndDisplayRoles() {
            let filteredRoles = [...allRoles];
            const searchTerm = document.getElementById('roleSearchInput')?.value.toLowerCase().trim() || '';
            if (searchTerm) {
                filteredRoles = filteredRoles.filter(r =>
                    (r.name && r.name.toLowerCase().includes(searchTerm)) ||
                    (r.code && r.code.toLowerCase().includes(searchTerm)) ||
                    (r.description && r.description.toLowerCase().includes(searchTerm)) ||
                    (r.department && r.department.toLowerCase().includes(searchTerm)) ||
                    (r.permissions && r.permissions.toLowerCase().includes(searchTerm))
                );
            }
            renderRolesTable(filteredRoles);
        }

        function renderRolesTable(roleList) {
            const rolesTable = document.getElementById('rolesTable');
            rolesTable.innerHTML = '';
            if (roleList.length === 0) {
                rolesTable.innerHTML = '<tr><td colspan="8" class="text-center py-5">Kh√¥ng t√¨m th·∫•y ch·ª©c v·ª• ph√π h·ª£p.</td></tr>';
                return;
            }
            roleList.forEach(role => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge bg-primary">${role.department || 'N/A'}</span></td>
                    <td><strong>${role.name || 'N/A'}</strong></td>
                    <td>${role.code || 'N/A'}</td>
                    <td>${role.description || ''}</td>
                    <td>${role.salary ? role.salary.toLocaleString('vi-VN') + ' VNƒê' : ''}</td>
                    <td>${role.allowance ? role.allowance.toLocaleString('vi-VN') + ' VNƒê' : ''}</td>
                    <td>${role.permissions || ''}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-warning" onclick="editRole('${role.id}')" title="Ch·ªânh s·ª≠a" data-bs-toggle="tooltip">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteRole('${role.id}')" title="X√≥a" data-bs-toggle="tooltip">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                rolesTable.appendChild(row);
            });
        }

        function addRole() {
            // Debug: ki·ªÉm tra authentication
            const currentUser = auth.currentUser;
            console.log('Current user:', currentUser);
            console.log('User email:', currentUser?.email);
            
            // ƒê·∫£m b·∫£o load departments tr∆∞·ªõc khi hi·ªÉn th·ªã form
            console.log('Loading departments for role form...');
            
            // Load danh s√°ch ph√≤ng ban tr·ª±c ti·∫øp t·ª´ Firebase ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·∫ßy ƒë·ªß v√† m·ªõi nh·∫•t
            db.ref('departments').once('value').then((snapshot) => {
                console.log('Departments snapshot received:', snapshot.val());
                
                let departmentOptions = '<option value="">Ch·ªçn ph√≤ng ban *</option>';
                
                if (snapshot.exists()) {
                    console.log('Found departments in Firebase');
                    snapshot.forEach((deptSnapshot) => {
                        const dept = deptSnapshot.val();
                        console.log('Processing department:', dept);
                        if (dept.name && dept.code) {
                            departmentOptions += `<option value="${dept.name}">${dept.name} (${dept.code})</option>`;
                        }
                    });
                } else {
                    console.log('No departments found in Firebase, using fallback');
                    // Fallback n·∫øu kh√¥ng c√≥ departments trong database
                    departmentOptions += `
                        <option value="L·ªÖ t√¢n (Front Desk)">L·ªÖ t√¢n (Front Desk) (01)</option>
                        <option value="Quan l√Ω ƒë·ªëi t√°c">Quan l√Ω ƒë·ªëi t√°c (QL01)</option>
                        <option value="Ki·ªÉm duy·ªát ƒë·∫∑t ph√≤ng">Ki·ªÉm duy·ªát ƒë·∫∑t ph√≤ng (KD01)</option>
                        <option value="ChƒÉm s√≥c kh√°ch h√†ng">ChƒÉm s√≥c kh√°ch h√†ng (CSKH)</option>
                        <option value="Marketing">Marketing (MKT)</option>
                        <option value="K·ªπ thu·∫≠t">K·ªπ thu·∫≠t (KT)</option>
                        <option value="T√†i ch√≠nh">T√†i ch√≠nh (TC)</option>
                        <option value="Nh√¢n s·ª±">Nh√¢n s·ª± (NS)</option>
                        <option value="B·∫£o v·ªá">B·∫£o v·ªá (BV)</option>
                        <option value="Bu·ªìng ph√≤ng">Bu·ªìng ph√≤ng (BP)</option>
                    `;
                }
                
                console.log('Department options generated:', departmentOptions);
                console.log('departmentOptions length:', departmentOptions.length);
                console.log('departmentOptions content:', departmentOptions);
                
                // Th√™m debug ƒë·ªÉ ki·ªÉm tra n·ªôi dung options
                if (departmentOptions.includes('<option')) {
                    console.log('‚úÖ Options found in departmentOptions');
                } else {
                    console.log('‚ùå No options found in departmentOptions');
                }
                
                Swal.fire({
                    title: 'Th√™m ch·ª©c v·ª• m·ªõi',
                    html: `
                        <div class="row">
                            <div class="col-md-6">
                                <select id="roleDepartment" class="form-select mb-2">
                                    ${departmentOptions}
                                </select>
                                <input type="text" id="roleName" class="form-control mb-2" placeholder="T√™n ch·ª©c v·ª•">
                                <input type="text" id="roleCode" class="form-control mb-2" placeholder="M√£ ch·ª©c v·ª• (v√≠ d·ª•: cskh, marketing, ...)">
                                <textarea id="roleDesc" class="form-control mb-2" rows="3" placeholder="M√¥ t·∫£ ch·ª©c v·ª•"></textarea>
                            </div>
                            <div class="col-md-6">
                                <input type="number" id="roleSalary" class="form-control mb-2" placeholder="L∆∞∆°ng c∆° b·∫£n (VNƒê)" min="0">
                                <input type="number" id="roleAllowance" class="form-control mb-2" placeholder="Ph·ª• c·∫•p (VNƒê)" min="0">
                                <textarea id="rolePermissions" class="form-control mb-2" rows="3" placeholder="Quy·ªÅn h·∫°n (v√≠ d·ª•: Qu·∫£n l√Ω nh√¢n vi√™n, Xem b√°o c√°o, ...)"></textarea>
                            </div>
                        </div>
                    `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                didOpen: () => {
                    // Debug: ki·ªÉm tra dropdown sau khi modal m·ªü
                    console.log('Modal opened, checking dropdown...');
                    const dropdown = document.getElementById('roleDepartment');
                    if (dropdown) {
                        console.log('Dropdown found:', dropdown);
                        console.log('Dropdown innerHTML:', dropdown.innerHTML);
                        console.log('Number of options:', dropdown.options.length);
                        
                        // Log t·ª´ng option
                        for (let i = 0; i < dropdown.options.length; i++) {
                            console.log(`Option ${i}:`, dropdown.options[i].value, dropdown.options[i].text);
                        }
                        
                        // Th√™m event listener cho dropdown ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin
                        dropdown.addEventListener('change', function() {
                            const selectedDept = this.value;
                            console.log('Department selected:', selectedDept);
                            
                            if (selectedDept) {
                                // T·ª± ƒë·ªông t·∫°o m√£ ch·ª©c v·ª• d·ª±a tr√™n t√™n ph√≤ng ban
                                const deptCode = selectedDept.toLowerCase()
                                    .replace(/\s+/g, '')
                                    .replace(/[()]/g, '')
                                    .substring(0, 10);
                                
                                // ƒê·∫∑t focus v√†o t√™n ch·ª©c v·ª• ƒë·ªÉ user d·ªÖ nh·∫≠p
                                const roleNameInput = document.getElementById('roleName');
                                if (roleNameInput) {
                                    roleNameInput.focus();
                                    roleNameInput.placeholder = `Nh·∫≠p t√™n ch·ª©c v·ª• cho ${selectedDept}`;
                                }
                                
                                // ƒê·∫∑t placeholder cho m√£ ch·ª©c v·ª•
                                const roleCodeInput = document.getElementById('roleCode');
                                if (roleCodeInput) {
                                    roleCodeInput.placeholder = `V√≠ d·ª•: ${deptCode}_manager, ${deptCode}_staff...`;
                                }
                                
                                // T·ª± ƒë·ªông ƒëi·ªÅn m√¥ t·∫£ d·ª±a tr√™n ph√≤ng ban
                                const roleDescInput = document.getElementById('roleDesc');
                                if (roleDescInput && !roleDescInput.value) {
                                    let defaultDesc = '';
                                    if (selectedDept.includes('L·ªÖ t√¢n')) {
                                        defaultDesc = 'Ch·ªãu tr√°ch nhi·ªám ti·∫øp ƒë√≥n kh√°ch, check-in/check-out, h·ªó tr·ª£ kh√°ch h√†ng t·∫°i qu·∫ßy l·ªÖ t√¢n';
                                    } else if (selectedDept.includes('Marketing')) {
                                        defaultDesc = 'Th·ª±c hi·ªán c√°c chi·∫øn l∆∞·ª£c marketing, qu·∫£ng b√° th∆∞∆°ng hi·ªáu, t·ªëi ∆∞u SEO';
                                    } else if (selectedDept.includes('Qu·∫£n l√Ω ƒë·ªëi t√°c')) {
                                        defaultDesc = 'Qu·∫£n l√Ω m·ªëi quan h·ªá ƒë·ªëi t√°c, li√™n k·∫øt v·ªõi c√°c website/ƒë·∫°i l√Ω kh√°c';
                                    } else if (selectedDept.includes('H·ªó tr·ª£ kh√°ch h√†ng')) {
                                        defaultDesc = 'H·ªó tr·ª£ kh√°ch h√†ng ƒë·∫∑t ph√≤ng, gi·∫£i quy·∫øt khi·∫øu n·∫°i, x·ª≠ l√Ω ho√†n ti·ªÅn';
                                    } else if (selectedDept.includes('Ki·ªÉm duy·ªát')) {
                                        defaultDesc = 'Ki·ªÉm duy·ªát ƒë·∫∑t ph√≤ng, x·ª≠ l√Ω tranh ch·∫•p gi·ªØa kh√°ch h√†ng v√† kh√°ch s·∫°n';
                                    } else {
                                        defaultDesc = `Th·ª±c hi·ªán c√°c nhi·ªám v·ª• li√™n quan ƒë·∫øn ${selectedDept}`;
                                    }
                                    roleDescInput.value = defaultDesc;
                                }
                                
                                // ƒê·∫∑t l∆∞∆°ng m·∫∑c ƒë·ªãnh d·ª±a tr√™n ph√≤ng ban
                                const roleSalaryInput = document.getElementById('roleSalary');
                                if (roleSalaryInput && !roleSalaryInput.value) {
                                    let defaultSalary = 15000000; // M·∫∑c ƒë·ªãnh 15 tri·ªáu
                                    if (selectedDept.includes('Marketing') || selectedDept.includes('Qu·∫£n l√Ω')) {
                                        defaultSalary = 20000000; // 20 tri·ªáu cho v·ªã tr√≠ cao
                                    } else if (selectedDept.includes('L·ªÖ t√¢n') || selectedDept.includes('H·ªó tr·ª£')) {
                                        defaultSalary = 12000000; // 12 tri·ªáu cho v·ªã tr√≠ entry
                                    }
                                    roleSalaryInput.value = defaultSalary;
                                }
                                
                                console.log('‚úÖ Department selection processed with auto-fill');
                            }
                        });
                    } else {
                        console.log('‚ùå Dropdown not found in DOM');
                    }
                },
                preConfirm: () => {
                    const department = document.getElementById('roleDepartment').value.trim();
                    const name = document.getElementById('roleName').value.trim();
                    const code = document.getElementById('roleCode').value.trim();
                    const description = document.getElementById('roleDesc').value.trim();
                    const salary = parseInt(document.getElementById('roleSalary').value) || 0;
                    const allowance = parseInt(document.getElementById('roleAllowance').value) || 0;
                    const permissions = document.getElementById('rolePermissions').value.trim();
                    
                    if (!name || !code) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p t√™n v√† m√£ ch·ª©c v·ª•');
                        return false;
                    }
                    
                    if (!department) {
                        Swal.showValidationMessage('Vui l√≤ng ch·ªçn ph√≤ng ban');
                        return false;
                    }
                    
                    return { 
                        department, 
                        name, 
                        code, 
                        description, 
                        salary, 
                        allowance, 
                        permissions,
                        createdAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newRole = result.value;
                    console.log('Attempting to create role:', newRole);
                    console.log('Current user email:', auth.currentUser?.email);
                    
                    db.ref('roles').push(newRole).then(() => {
                        loadRoles();
                        Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m ch·ª©c v·ª• m·ªõi!', 'success');
                    }).catch((error) => {
                        console.error('Error creating role:', error);
                        Swal.fire('L·ªói', `Kh√¥ng th·ªÉ th√™m ch·ª©c v·ª•: ${error.message}`, 'error');
                    });
                }
            });
            
            }).catch((error) => {
                console.error('Error loading departments for role form:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph√≤ng ban. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            });
        }

        function editRole(roleId) {
            const role = allRoles.find(r => r.id === roleId);
            if (!role) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ch·ª©c v·ª• n√†y.', 'error');
                return;
            }
            
            console.log('Editing role:', role);
            console.log('Loading departments for role edit form...');
            
            // Load danh s√°ch ph√≤ng ban tr·ª±c ti·∫øp t·ª´ Firebase ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·∫ßy ƒë·ªß v√† m·ªõi nh·∫•t
            db.ref('departments').once('value').then((snapshot) => {
                console.log('Departments snapshot for edit received:', snapshot.val());
                
                let departmentOptions = '<option value="">Ch·ªçn ph√≤ng ban *</option>';
                
                if (snapshot.exists()) {
                    console.log('Found departments in Firebase for edit');
                    snapshot.forEach((deptSnapshot) => {
                        const dept = deptSnapshot.val();
                        console.log('Processing department for edit:', dept);
                        if (dept.name && dept.code) {
                            const selected = role.department === dept.name ? 'selected' : '';
                            departmentOptions += `<option value="${dept.name}" ${selected}>${dept.name} (${dept.code})</option>`;
                        }
                    });
                } else {
                    console.log('No departments found in Firebase for edit, using fallback');
                    // Fallback n·∫øu kh√¥ng c√≥ departments trong database
                    const fallbackDepartments = [
                        'L·ªÖ t√¢n (Front Desk)', 'Quan l√Ω ƒë·ªëi t√°c', 'Ki·ªÉm duy·ªát ƒë·∫∑t ph√≤ng',
                        'ChƒÉm s√≥c kh√°ch h√†ng', 'Marketing', 'K·ªπ thu·∫≠t', 
                        'T√†i ch√≠nh', 'Nh√¢n s·ª±', 'B·∫£o v·ªá', 'Bu·ªìng ph√≤ng'
                    ];
                    
                    fallbackDepartments.forEach(deptName => {
                        const selected = role.department === deptName ? 'selected' : '';
                        departmentOptions += `<option value="${deptName}" ${selected}>${deptName}</option>`;
                    });
                }
                
                console.log('Department options for edit generated:', departmentOptions);
            
            Swal.fire({
                title: 'Ch·ªânh s·ª≠a ch·ª©c v·ª•',
                html: `
                    <div class="row">
                        <div class="col-md-6">
                            <select id="editRoleDepartment" class="form-select mb-2">
                                <option value="">Ch·ªçn ph√≤ng ban *</option>
                                ${departmentOptions}
                            </select>
                            <input type="text" id="editRoleName" class="form-control mb-2" value="${role.name || ''}" placeholder="T√™n ch·ª©c v·ª•">
                            <input type="text" id="editRoleCode" class="form-control mb-2" value="${role.code || ''}" placeholder="M√£ ch·ª©c v·ª•">
                            <textarea id="editRoleDesc" class="form-control mb-2" rows="3" placeholder="M√¥ t·∫£ ch·ª©c v·ª•">${role.description || ''}</textarea>
                        </div>
                        <div class="col-md-6">
                            <input type="number" id="editRoleSalary" class="form-control mb-2" value="${role.salary || ''}" placeholder="L∆∞∆°ng c∆° b·∫£n (VNƒê)" min="0">
                            <input type="number" id="editRoleAllowance" class="form-control mb-2" value="${role.allowance || ''}" placeholder="Ph·ª• c·∫•p (VNƒê)" min="0">
                            <textarea id="editRolePermissions" class="form-control mb-2" rows="3" placeholder="Quy·ªÅn h·∫°n (v√≠ d·ª•: Qu·∫£n l√Ω nh√¢n vi√™n, Xem b√°o c√°o, ...)">${role.permissions || ''}</textarea>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const department = document.getElementById('editRoleDepartment').value.trim();
                    const name = document.getElementById('editRoleName').value.trim();
                    const code = document.getElementById('editRoleCode').value.trim();
                    const description = document.getElementById('editRoleDesc').value.trim();
                    const salary = parseInt(document.getElementById('editRoleSalary').value) || 0;
                    const allowance = parseInt(document.getElementById('editRoleAllowance').value) || 0;
                    const permissions = document.getElementById('editRolePermissions').value.trim();
                    
                    if (!name || !code) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p t√™n v√† m√£ ch·ª©c v·ª•');
                        return false;
                    }
                    
                    if (!department) {
                        Swal.showValidationMessage('Vui l√≤ng ch·ªçn ph√≤ng ban');
                        return false;
                    }
                    
                    return { 
                        department, 
                        name, 
                        code, 
                        description, 
                        salary, 
                        allowance, 
                        permissions,
                        updatedAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedRole = result.value;
                    db.ref('roles/' + roleId).update(updatedRole).then(() => {
                        loadRoles();
                        Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t ch·ª©c v·ª•!', 'success');
                    }).catch((error) => {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ch·ª©c v·ª•.', 'error');
                    });
                }
            });
            
            }).catch((error) => {
                console.error('Error loading departments for role edit form:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph√≤ng ban. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            });
        }

        function deleteRole(roleId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('roles/' + roleId).remove().then(() => {
                        loadRoles();
                        Swal.fire('ƒê√£ x√≥a', 'Ch·ª©c v·ª• ƒë√£ b·ªã x√≥a.', 'success');
                    }).catch((error) => {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√≥a ch·ª©c v·ª•.', 'error');
                    });
                }
            });
        }

        // Test function ƒë·ªÉ ki·ªÉm tra Firebase Rules
        function testFirebaseRules() {
            console.log('=== FIREBASE RULES TEST STARTED ===');
            console.log('Current user:', auth.currentUser);
            console.log('User email:', auth.currentUser?.email);
            console.log('User UID:', auth.currentUser?.uid);
            console.log('User emailVerified:', auth.currentUser?.emailVerified);
            console.log('User metadata:', auth.currentUser?.metadata);
            
            if (!auth.currentUser) {
                console.log('‚ùå No user logged in');
                return;
            }
            
            // Ki·ªÉm tra ƒë·∫∑c bi·ªát v·ªÅ email verification
            if (!auth.currentUser.emailVerified) {
                console.log('‚ö†Ô∏è WARNING: Email not verified! This might cause permission issues.');
                console.log('Email verification status:', auth.currentUser.emailVerified);
            }
            
            // Test 1: Ki·ªÉm tra connection
            console.log('Test 1: Checking Firebase connection...');
            db.ref('.info/connected').once('value').then((snapshot) => {
                if (snapshot.val() === true) {
                    console.log('‚úÖ Firebase connected successfully');
                } else {
                    console.log('‚ùå Firebase not connected');
                }
            }).catch((error) => {
                console.log('‚ùå Firebase connection test failed:', error);
            });
            
            // Test 2: Read departments permission
            console.log('Test 2: Testing read departments permission...');
            db.ref('departments').once('value').then((snapshot) => {
                console.log('‚úÖ Read departments permission: SUCCESS');
                console.log('Departments data:', snapshot.val());
            }).catch((error) => {
                console.log('‚ùå Read departments permission: FAILED');
                console.log('Error code:', error.code);
                console.log('Error message:', error.message);
            });
            
            // Test 3: Write departments permission v·ªõi data t·ªëi thi·ªÉu
            console.log('Test 3: Testing write departments permission...');
            const testDepartment = {
                name: 'Test Department',
                code: 'TEST',
                status: 'active',
                createdAt: Date.now()
            };
            
            console.log('Test data:', testDepartment);
            
            db.ref('departments').push(testDepartment).then((ref) => {
                console.log('‚úÖ Write departments permission: SUCCESS');
                console.log('Created test department with ID:', ref.key);
                
                // X√≥a test data
                ref.remove().then(() => {
                    console.log('‚úÖ Cleaned up test department');
                }).catch((cleanupError) => {
                    console.log('‚ö†Ô∏è Failed to cleanup test department:', cleanupError);
                });
            }).catch((error) => {
                console.log('‚ùå Write departments permission: FAILED');
                console.log('Error code:', error.code);
                console.log('Error message:', error.message);
                console.log('Full error object:', error);
            });
            
            // Test 4: Ki·ªÉm tra token claims
            auth.currentUser.getIdTokenResult().then((idTokenResult) => {
                console.log('=== TOKEN ANALYSIS ===');
                console.log('Token claims:', idTokenResult.claims);
                console.log('Token email:', idTokenResult.claims.email);
                console.log('Token email verified:', idTokenResult.claims.email_verified);
                console.log('Token auth time:', idTokenResult.authTime);
                console.log('Token issued at:', idTokenResult.issuedAtTime);
                console.log('Token expiration:', idTokenResult.expirationTime);
                console.log('Token sign-in provider:', idTokenResult.signInProvider);
                console.log('User UID in token:', idTokenResult.claims.user_id || idTokenResult.claims.sub);
                
                // Test ƒë·∫∑c bi·ªát v·ªÅ email verification
                if (idTokenResult.claims.email !== 'quantrikhachsan@gmail.com') {
                    console.log('‚ùå EMAIL MISMATCH in token!');
                    console.log('Expected: quantrikhachsan@gmail.com');
                    console.log('Got in token:', idTokenResult.claims.email);
                }
                
                if (!idTokenResult.claims.email_verified) {
                    console.log('‚ö†Ô∏è WARNING: email_verified is false in token!');
                    console.log('This might cause permission issues in Firebase Rules');
                }
                
                // Test v·ªõi fresh token
                console.log('Getting fresh token...');
                return auth.currentUser.getIdToken(true);
            }).then((freshToken) => {
                console.log('Fresh token obtained (first 100 chars):', freshToken.substring(0, 100) + '...');
                
                // Decode token ƒë·ªÉ xem claims (ch·ªâ ƒë·ªÉ debug - kh√¥ng an to√†n trong production)
                try {
                    const tokenParts = freshToken.split('.');
                    const payload = JSON.parse(atob(tokenParts[1]));
                    console.log('Fresh token payload:', payload);
                    console.log('Fresh token email:', payload.email);
                    console.log('Fresh token email_verified:', payload.email_verified);
                    console.log('Fresh token exp:', new Date(payload.exp * 1000));
                } catch (decodeError) {
                    console.log('Could not decode token for debugging:', decodeError);
                }
                
            }).catch((tokenError) => {
                console.log('‚ùå Failed to get token claims:', tokenError);
            });
            
            console.log('=== FIREBASE RULES TEST COMPLETED ===');
        }
        
        // Th√™m button test v√†o console (c√≥ th·ªÉ g·ªçi b·∫±ng c√°ch g√µ testFirebaseRules() trong console)
        window.testFirebaseRules = testFirebaseRules;
        
        // Function ƒë·ªÉ verify email n·∫øu c·∫ßn
        function verifyEmail() {
            if (!auth.currentUser) {
                console.log('‚ùå No user logged in');
                return;
            }
            
            if (auth.currentUser.emailVerified) {
                console.log('‚úÖ Email already verified');
                return;
            }
            
            console.log('Sending email verification...');
            auth.currentUser.sendEmailVerification().then(() => {
                console.log('‚úÖ Email verification sent');
                Swal.fire({
                    icon: 'info',
                    title: 'Email verification sent',
                    text: 'Please check your email and click the verification link.'
                });
            }).catch((error) => {
                console.error('‚ùå Failed to send email verification:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Failed to send verification',
                    text: error.message
                });
            });
        }
        
        // Function ƒë·ªÉ reload user ƒë·ªÉ c·∫≠p nh·∫≠t emailVerified status
        function reloadUser() {
            if (!auth.currentUser) {
                console.log('‚ùå No user logged in');
                return;
            }
            
            console.log('Reloading user...');
            auth.currentUser.reload().then(() => {
                console.log('‚úÖ User reloaded');
                console.log('Email verified status:', auth.currentUser.emailVerified);
                
                if (auth.currentUser.emailVerified) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Email verified!',
                        text: 'You can now try adding departments again.'
                    });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Email not verified yet',
                        text: 'Please check your email for verification link.'
                    });
                }
            }).catch((error) => {
                console.error('‚ùå Failed to reload user:', error);
            });
        }
        
        // Th√™m functions v√†o console
        window.verifyEmail = verifyEmail;
        window.reloadUser = reloadUser;
        
        // Debug function ƒë·ªÉ ki·ªÉm tra allDepartments
        function debugDepartments() {
            console.log('=== DEPARTMENTS DEBUG ===');
            console.log('allDepartments array:', allDepartments);
            console.log('Number of departments:', allDepartments.length);
            
            if (allDepartments.length > 0) {
                console.log('First department:', allDepartments[0]);
                allDepartments.forEach((dept, index) => {
                    console.log(`Department ${index + 1}:`, {
                        name: dept.name,
                        code: dept.code,
                        id: dept.id
                    });
                });
            } else {
                console.log('‚ùå No departments found in allDepartments array');
            }
            
            // Test dropdown generation
            if (allDepartments.length > 0) {
                const testOptions = allDepartments.map(dept => 
                    `<option value="${dept.name}">${dept.name} (${dept.code})</option>`
                ).join('');
                console.log('Generated dropdown options:', testOptions);
            }
            
            console.log('=== END DEPARTMENTS DEBUG ===');
        }
        
        // Th√™m debug function v√†o console
        window.debugDepartments = debugDepartments;

        // T·ª± ƒë·ªông load roles khi v√†o trang
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - initializing...');
            
            // Load t·∫•t c·∫£ data c·∫ßn thi·∫øt
            loadDepartments(); // Load departments tr∆∞·ªõc ƒë·ªÉ c√≥ s·∫µn cho roles
            loadRoles();
            loadStaff(); // Load staff data
            loadStaffRoleFilter(); // Load dynamic role filter options
            
            // Initialize navigation
            initializeNavigation();
            
            console.log('All initialization completed');
        });
        
        // Navigation handling
        function initializeNavigation() {
            // Add click handlers for navigation items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all nav items
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Hide all content sections
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show target section
                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        
                        // Update page title
                        const titleElement = document.getElementById('page-title-header');
                        if (titleElement) {
                            titleElement.textContent = this.querySelector('span').textContent;
                        }
                        
                        // Load data for specific sections
                        switch(targetId) {
                            case 'departments-management':
                                loadDepartments();
                                break;
                            case 'roles-management':
                                loadRoles();
                                // ƒê·∫£m b·∫£o departments ƒë∆∞·ª£c load tr∆∞·ªõc khi v√†o section roles
                                loadDepartments();
                                break;
                            case 'staff-management':
                                loadStaff();
                                break;
                        }
                    }
                });
            });
        }

        // Departments Management Section Logic
        let allDepartments = [];
        
        function loadDepartments() {
            console.log('loadDepartments() called');
            const departmentsTable = document.getElementById('departmentsTable');
            if (!departmentsTable) {
                console.log('No departmentsTable found, but continuing to load data for allDepartments');
            } else {
                departmentsTable.innerHTML = '<tr><td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            }
            
            // Load data from Firebase
            console.log('Loading departments from Firebase...');
            db.ref('departments').on('value', (snapshot) => {
                console.log('Departments snapshot received in loadDepartments:', snapshot.val());
                allDepartments = [];
                if (snapshot.exists()) {
                    console.log('Departments exist in Firebase');
                    snapshot.forEach((deptSnapshot) => {
                        const department = deptSnapshot.val();
                        department.id = deptSnapshot.key;
                        allDepartments.push(department);
                        console.log('Added department to allDepartments:', department);
                    });
                } else {
                    // Add sample data if no departments exist
                    console.log('No departments found in Firebase, using sample data');
                    allDepartments = [
                        {
                            id: 'sample1',
                            name: 'L·ªÖ t√¢n (Front Desk)',
                            code: '01',
                            description: 'Qu·∫£n l√Ω check-in/check-out, ti·∫øp kh√°ch',
                            manager: 'Nguy·ªÖn Ti·∫øn Ch√∫c',
                            staffCount: 0,
                            budget: 150000000,
                            status: 'active',
                            location: 'T·∫ßng tr·ªát',
                            email: 'frontdesk@luxuryhaven.com',
                            phone: '0123456789'
                        },
                        {
                            id: 'sample2', 
                            name: 'Quan l√Ω ƒë·ªëi t√°c',
                            code: 'QL01',
                            description: 'Qu·∫£n l√Ω li√™n k·∫øt v·ªõi ƒë·∫°i l√Ω/website kh√°c',
                            manager: 'Nguy·ªÖn VƒÉn B',
                            staffCount: 0,
                            budget: 120000000,
                            status: 'active',
                            location: 'T·∫ßng 2',
                            email: 'partner@luxuryhaven.com',
                            phone: '0123456790'
                        },
                        {
                            id: 'sample3',
                            name: 'Ki·ªÉm duy·ªát ƒë·∫∑t ph√≤ng',
                            code: 'KD01',
                            description: 'Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ gi·ªØa kh√°ch & kh√°ch s·∫°n',
                            manager: 'Nguy·ªÖn VƒÉn C',
                            staffCount: 0,
                            budget: 100000000,
                            status: 'active',
                            location: 'T·∫ßng 2',
                            email: 'booking@luxuryhaven.com',
                            phone: '0123456791'
                        }
                    ];
                }
                
                console.log('Final allDepartments array:', allDepartments);
                console.log('Number of departments loaded:', allDepartments.length);
                
                filterAndDisplayDepartments();
            }, (error) => {
                console.error('Error loading departments:', error);
                departmentsTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message + '</td></tr>';
            });
        }

        function filterAndDisplayDepartments() {
            let filteredDepartments = [...allDepartments];
            const searchTerm = document.getElementById('departmentSearchInput')?.value.toLowerCase().trim() || '';
            
            if (searchTerm) {
                filteredDepartments = filteredDepartments.filter(d =>
                    (d.name && d.name.toLowerCase().includes(searchTerm)) ||
                    (d.code && d.code.toLowerCase().includes(searchTerm)) ||
                    (d.description && d.description.toLowerCase().includes(searchTerm)) ||
                    (d.manager && d.manager.toLowerCase().includes(searchTerm))
                );
            }
            renderDepartmentsTable(filteredDepartments);
        }

        function renderDepartmentsTable(departmentList) {
            const departmentsTable = document.getElementById('departmentsTable');
            if (!departmentsTable) return;
            
            departmentsTable.innerHTML = '';
            if (departmentList.length === 0) {
                departmentsTable.innerHTML = '<tr><td colspan="8" class="text-center py-5"><i class="fas fa-inbox fa-2x text-muted mb-2"></i><br>Kh√¥ng t√¨m th·∫•y ph√≤ng ban ph√π h·ª£p.</td></tr>';
                return;
            }
            
            departmentList.forEach(department => {
                const budget = department.budget ? department.budget.toLocaleString('vi-VN') + ' VNƒê' : '<span class="text-muted">Ch∆∞a c√≥</span>';
                const staffCount = department.staffCount || 0;
                const status = department.status === 'active' ? 
                    '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Ho·∫°t ƒë·ªông</span>' : 
                    '<span class="badge bg-secondary"><i class="fas fa-pause-circle"></i> Kh√¥ng ho·∫°t ƒë·ªông</span>';
                
                const manager = department.manager || '<span class="text-muted">Ch∆∞a c√≥</span>';
                const description = department.description ? 
                    (department.description.length > 50 ? 
                        `<span title="${department.description}">${department.description.substring(0, 50)}...</span>` : 
                        department.description) : 
                    '<span class="text-muted">Kh√¥ng c√≥</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong class="text-primary">${department.name || 'N/A'}</strong></td>
                    <td><span class="badge bg-info">${department.code || 'N/A'}</span></td>
                    <td>${description}</td>
                    <td>${manager}</td>
                    <td><span class="badge bg-secondary"><i class="fas fa-users"></i> ${staffCount} ng∆∞·ªùi</span></td>
                    <td>${budget}</td>
                    <td>${status}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-info" onclick="viewDepartment('${department.id}')" title="Xem chi ti·∫øt" data-bs-toggle="tooltip">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="editDepartment('${department.id}')" title="Ch·ªânh s·ª≠a" data-bs-toggle="tooltip">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteDepartment('${department.id}')" title="X√≥a" data-bs-toggle="tooltip">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                departmentsTable.appendChild(row);
            });
            
            // Initialize tooltips after rendering
            setTimeout(() => {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }, 100);
        }

        function addDepartment() {
            console.log('=== ADD DEPARTMENT FUNCTION CALLED ===');
            
            // Ki·ªÉm tra authentication tr∆∞·ªõc khi t·∫°o department
            const currentUser = auth.currentUser;
            console.log('Current user:', currentUser);
            console.log('User email:', currentUser?.email);
            console.log('User UID:', currentUser?.uid);
            console.log('User emailVerified:', currentUser?.emailVerified);
            
            if (!currentUser) {
                console.log('‚ùå No user logged in - auth.currentUser is null/undefined');
                Swal.fire('L·ªói', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y.', 'error');
                return;
            }
            
            if (currentUser.email !== 'quantrikhachsan@gmail.com') {
                console.log('‚ùå Unauthorized user:', currentUser.email);
                console.log('Expected: quantrikhachsan@gmail.com');
                Swal.fire('L·ªói', 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n admin.', 'error');
                return;
            }
            
            console.log('‚úÖ Admin authorization confirmed');
            
            Swal.fire({
                title: 'Th√™m ph√≤ng ban m·ªõi',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="deptName" class="form-control mb-2" placeholder="T√™n ph√≤ng ban *" required>
                                <input type="text" id="deptCode" class="form-control mb-2" placeholder="M√£ ph√≤ng ban *" required>
                                <textarea id="deptDescription" class="form-control mb-2" rows="3" placeholder="M√¥ t·∫£ ph√≤ng ban"></textarea>
                                <input type="text" id="deptManager" class="form-control mb-2" placeholder="Tr∆∞·ªüng ph√≤ng">
                            </div>
                            <div class="col-md-6">
                                <input type="number" id="deptBudget" class="form-control mb-2" placeholder="Ng√¢n s√°ch (VNƒê)" min="0">
                                <input type="text" id="deptLocation" class="form-control mb-2" placeholder="ƒê·ªãa ƒëi·ªÉm">
                                <input type="email" id="deptEmail" class="form-control mb-2" placeholder="Email ph√≤ng ban">
                                <input type="text" id="deptPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                                <select id="deptStatus" class="form-select mb-2">
                                    <option value="active">Ho·∫°t ƒë·ªông</option>
                                    <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const name = document.getElementById('deptName').value.trim();
                    const code = document.getElementById('deptCode').value.trim();
                    
                    if (!name || !code) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p t√™n v√† m√£ ph√≤ng ban');
                        return false;
                    }
                    
                    return {
                        name: name,
                        code: code,
                        description: document.getElementById('deptDescription').value.trim(),
                        manager: document.getElementById('deptManager').value.trim(),
                        budget: parseInt(document.getElementById('deptBudget').value) || 0,
                        location: document.getElementById('deptLocation').value.trim(),
                        email: document.getElementById('deptEmail').value.trim(),
                        phone: document.getElementById('deptPhone').value.trim(),
                        status: document.getElementById('deptStatus').value,
                        staffCount: 0,
                        createdAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log('=== SAVING DEPARTMENT DATA ===');
                    
                    const newDepartment = result.value;
                    console.log('Department data to save:', newDepartment);
                    console.log('Current user auth state:', {
                        uid: auth.currentUser?.uid,
                        email: auth.currentUser?.email,
                        emailVerified: auth.currentUser?.emailVerified
                    });
                    
                    // Test Firebase connection tr∆∞·ªõc
                    console.log('Testing Firebase connection...');
                    db.ref('.info/connected').once('value').then((snapshot) => {
                        console.log('Firebase connection status:', snapshot.val());
                        
                        if (snapshot.val() === true) {
                            console.log('‚úÖ Firebase connected successfully');
                            
                            // Get fresh token tr∆∞·ªõc khi save
                            return auth.currentUser.getIdToken(true).then((token) => {
                                console.log('Fresh ID token obtained (first 50 chars):', token.substring(0, 50) + '...');
                                
                                // Th·ª≠ t·∫°o department
                                console.log('Attempting to save to: departments/');
                                const savePromise = db.ref('departments').push(newDepartment);
                                console.log('Save promise created, waiting for result...');
                                
                                return savePromise;
                            });
                        } else {
                            throw new Error('Firebase not connected');
                        }
                    }).then((ref) => {
                        console.log('‚úÖ Department created successfully!');
                        console.log('New department ID:', ref.key);
                        console.log('Full reference path:', ref.toString());
                        
                        loadDepartments();
                        Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m ph√≤ng ban m·ªõi!', 'success');
                    }).catch((error) => {
                        console.error('‚ùå ERROR SAVING DEPARTMENT');
                        console.error('Error object:', error);
                        console.error('Error code:', error.code);
                        console.error('Error message:', error.message);
                        console.error('Error stack:', error.stack);
                        
                        // Log th√™m th√¥ng tin debug
                        console.error('Current user at time of error:', {
                            uid: auth.currentUser?.uid,
                            email: auth.currentUser?.email,
                            emailVerified: auth.currentUser?.emailVerified
                        });
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói',
                            html: `
                                <p>Kh√¥ng th·ªÉ th√™m ph√≤ng ban:</p>
                                <p><strong>M√£ l·ªói:</strong> ${error.code}</p>
                                <p><strong>Th√¥ng ƒëi·ªáp:</strong> ${error.message}</p>
                                <p><em>Ki·ªÉm tra Console ƒë·ªÉ xem chi ti·∫øt</em></p>
                            `
                        });
                    });
                }
            });
        }

        function editDepartment(deptId) {
            const department = allDepartments.find(d => d.id === deptId);
            if (!department) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ph√≤ng ban n√†y.', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Ch·ªânh s·ª≠a ph√≤ng ban',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="editDeptName" class="form-control mb-2" value="${department.name || ''}" placeholder="T√™n ph√≤ng ban *" required>
                                <input type="text" id="editDeptCode" class="form-control mb-2" value="${department.code || ''}" placeholder="M√£ ph√≤ng ban *" required>
                                <textarea id="editDeptDescription" class="form-control mb-2" rows="3" placeholder="M√¥ t·∫£ ph√≤ng ban">${department.description || ''}</textarea>
                                <input type="text" id="editDeptManager" class="form-control mb-2" value="${department.manager || ''}" placeholder="Tr∆∞·ªüng ph√≤ng">
                            </div>
                            <div class="col-md-6">
                                <input type="number" id="editDeptBudget" class="form-control mb-2" value="${department.budget || ''}" placeholder="Ng√¢n s√°ch (VNƒê)" min="0">
                                <input type="text" id="editDeptLocation" class="form-control mb-2" value="${department.location || ''}" placeholder="ƒê·ªãa ƒëi·ªÉm">
                                <input type="email" id="editDeptEmail" class="form-control mb-2" value="${department.email || ''}" placeholder="Email ph√≤ng ban">
                                <input type="text" id="editDeptPhone" class="form-control mb-2" value="${department.phone || ''}" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                                <select id="editDeptStatus" class="form-select mb-2">
                                    <option value="active" ${department.status === 'active' ? 'selected' : ''}>Ho·∫°t ƒë·ªông</option>
                                    <option value="inactive" ${department.status === 'inactive' ? 'selected' : ''}>Kh√¥ng ho·∫°t ƒë·ªông</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const name = document.getElementById('editDeptName').value.trim();
                    const code = document.getElementById('editDeptCode').value.trim();
                    
                    if (!name || !code) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p t√™n v√† m√£ ph√≤ng ban');
                        return false;
                    }
                    
                    return {
                        name: name,
                        code: code,
                        description: document.getElementById('editDeptDescription').value.trim(),
                        manager: document.getElementById('editDeptManager').value.trim(),
                        budget: parseInt(document.getElementById('editDeptBudget').value) || 0,
                        location: document.getElementById('editDeptLocation').value.trim(),
                        email: document.getElementById('editDeptEmail').value.trim(),
                        phone: document.getElementById('editDeptPhone').value.trim(),
                        status: document.getElementById('editDeptStatus').value,
                        updatedAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedDepartment = result.value;
                    db.ref('departments/' + deptId).update(updatedDepartment).then(() => {
                        loadDepartments();
                        Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t ph√≤ng ban!', 'success');
                    }).catch((error) => {
                        console.error('Error updating department:', error);
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ph√≤ng ban.', 'error');
                    });
                }
            });
        }

        function viewDepartment(deptId) {
            const department = allDepartments.find(d => d.id === deptId);
            if (!department) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ph√≤ng ban n√†y.', 'error');
                return;
            }
            
            const budget = department.budget ? department.budget.toLocaleString('vi-VN') + ' VNƒê' : 'Ch∆∞a c√≥';
            const created = department.createdAt ? new Date(department.createdAt).toLocaleDateString('vi-VN') : 'N/A';
            const updated = department.updatedAt ? new Date(department.updatedAt).toLocaleDateString('vi-VN') : 'N/A';
            
            Swal.fire({
                title: `Chi ti·∫øt ph√≤ng ban: ${department.name}`,
                html: `
                    <div class="container-fluid text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle"></i> Th√¥ng tin c∆° b·∫£n</h6>
                                <p><strong>T√™n ph√≤ng ban:</strong> ${department.name}</p>
                                <p><strong>M√£ ph√≤ng ban:</strong> ${department.code}</p>
                                <p><strong>M√¥ t·∫£:</strong> ${department.description || 'Kh√¥ng c√≥'}</p>
                                <p><strong>Tr∆∞·ªüng ph√≤ng:</strong> ${department.manager || 'Ch∆∞a c√≥'}</p>
                                <p><strong>S·ªë nh√¢n vi√™n:</strong> ${department.staffCount || 0} ng∆∞·ªùi</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-contact-card"></i> Th√¥ng tin li√™n h·ªá</h6>
                                <p><strong>Ng√¢n s√°ch:</strong> ${budget}</p>
                                <p><strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${department.location || 'Kh√¥ng c√≥'}</p>
                                <p><strong>Email:</strong> ${department.email || 'Kh√¥ng c√≥'}</p>
                                <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${department.phone || 'Kh√¥ng c√≥'}</p>
                                <p><strong>Tr·∫°ng th√°i:</strong> ${department.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</p>
                                <p><strong>Ng√†y t·∫°o:</strong> ${created}</p>
                                <p><strong>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</strong> ${updated}</p>
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                confirmButtonText: 'ƒê√≥ng'
            });
        }

        function deleteDepartment(deptId) {
            const department = allDepartments.find(d => d.id === deptId);
            if (!department) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ph√≤ng ban n√†y.', 'error');
                return;
            }
            
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng ban "${department.name}"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('departments/' + deptId).remove().then(() => {
                        loadDepartments();
                        Swal.fire('ƒê√£ x√≥a', 'Ph√≤ng ban ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.', 'success');
                    }).catch((error) => {
                        console.error('Error deleting department:', error);
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√≥a ph√≤ng ban.', 'error');
                    });
                }
            });
        }

        // Staff Management Section Logic - Booking.com style
        function filterAndDisplayStaff() {
            let filteredStaff = [...allStaff];
            const searchTerm = document.getElementById('staffSearchInput')?.value.toLowerCase().trim() || '';
            const roleFilter = document.getElementById('staffRoleFilter')?.value || 'all';
            if (searchTerm) {
                filteredStaff = filteredStaff.filter(s =>
                    (s.name && s.name.toLowerCase().includes(searchTerm)) ||
                    (s.email && s.email.toLowerCase().includes(searchTerm)) ||
                    (s.phone && s.phone.includes(searchTerm))
                );
            }
            if (roleFilter !== 'all') {
                filteredStaff = filteredStaff.filter(s => s.role === roleFilter);
            }
            renderStaffTable(filteredStaff);
        }

        function loadStaff() {
            const staffTable = document.getElementById('staffTable');
            staffTable.innerHTML = '<tr><td colspan="7" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
            db.ref('staff').on('value', (snapshot) => {
                allStaff = [];
                if (snapshot.exists()) {
                    snapshot.forEach((staffSnapshot) => {
                        const staff = staffSnapshot.val();
                        staff.id = staffSnapshot.key;
                        allStaff.push(staff);
                    });
                }
                filterAndDisplayStaff();
            }, (error) => {
                staffTable.innerHTML = '<tr><td colspan="7" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
            });
        }

        function loadStaffRoleFilter() {
            const roleFilter = document.getElementById('staffRoleFilter');
            if (!roleFilter) return;
            
            // L∆∞u gi√° tr·ªã hi·ªán t·∫°i
            const currentValue = roleFilter.value;
            
            // Load roles t·ª´ Firebase
            db.ref('roles').once('value').then((snapshot) => {
                // Reset filter v·ªõi option "T·∫•t c·∫£ vai tr√≤"
                roleFilter.innerHTML = '<option value="all">T·∫•t c·∫£ vai tr√≤</option>';
                
                if (snapshot.exists()) {
                    snapshot.forEach((roleSnapshot) => {
                        const role = roleSnapshot.val();
                        if (role.name && role.code) {
                            const option = document.createElement('option');
                            option.value = role.code;
                            option.textContent = role.name;
                            roleFilter.appendChild(option);
                        }
                    });
                } else {
                    // Fallback options n·∫øu kh√¥ng c√≥ roles trong database
                    const fallbackRoles = [
                        {code: 'admin', name: 'Qu·∫£n tr·ªã vi√™n'},
                        {code: 'cskh', name: 'ChƒÉm s√≥c kh√°ch h√†ng'},
                        {code: 'manager', name: 'Qu·∫£n l√Ω kh√°ch s·∫°n'},
                        {code: 'marketing', name: 'Marketing'},
                        {code: 'kythuat', name: 'K·ªπ thu·∫≠t'},
                        {code: 'receptionist', name: 'L·ªÖ t√¢n'},
                        {code: 'housekeeping', name: 'Bu·ªìng ph√≤ng'},
                        {code: 'security', name: 'B·∫£o v·ªá'},
                        {code: 'finance', name: 'K·∫ø to√°n'},
                        {code: 'hr', name: 'Nh√¢n s·ª±'}
                    ];
                    
                    fallbackRoles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.code;
                        option.textContent = role.name;
                        roleFilter.appendChild(option);
                    });
                }
                
                // Kh√¥i ph·ª•c gi√° tr·ªã ƒë√£ ch·ªçn (n·∫øu c√≥)
                if (currentValue) {
                    roleFilter.value = currentValue;
                }
                
            }).catch((error) => {
                console.error('Error loading roles for filter:', error);
                // S·ª≠ d·ª•ng fallback n·∫øu c√≥ l·ªói
                roleFilter.innerHTML = `
                    <option value="all">T·∫•t c·∫£ vai tr√≤</option>
                    <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
                    <option value="cskh">ChƒÉm s√≥c kh√°ch h√†ng</option>
                    <option value="manager">Qu·∫£n l√Ω kh√°ch s·∫°n</option>
                    <option value="marketing">Marketing</option>
                    <option value="kythuat">K·ªπ thu·∫≠t</option>
                    <option value="receptionist">L·ªÖ t√¢n</option>
                    <option value="housekeeping">Bu·ªìng ph√≤ng</option>
                    <option value="security">B·∫£o v·ªá</option>
                    <option value="finance">K·∫ø to√°n</option>
                    <option value="hr">Nh√¢n s·ª±</option>
                `;
            });
        }

        function loadDepartmentOptions(selectElementId) {
            const departmentSelect = document.getElementById(selectElementId);
            if (!departmentSelect) return Promise.resolve();
            
            return db.ref('departments').once('value').then((snapshot) => {
                // L∆∞u gi√° tr·ªã hi·ªán t·∫°i
                const currentValue = departmentSelect.value;
                
                // Reset v·ªõi option m·∫∑c ƒë·ªãnh
                departmentSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng ban</option>';
                
                if (snapshot.exists()) {
                    snapshot.forEach((deptSnapshot) => {
                        const department = deptSnapshot.val();
                        if (department.name && department.status === 'active') {
                            const option = document.createElement('option');
                            option.value = department.code || department.name;
                            option.textContent = department.name;
                            departmentSelect.appendChild(option);
                        }
                    });
                } else {
                    // Fallback options n·∫øu kh√¥ng c√≥ departments trong database
                    const fallbackDepartments = [
                        'Operations',
                        'Sales & Marketing', 
                        'Human Resources',
                        'Finance',
                        'IT',
                        'Customer Service'
                    ];
                    
                    fallbackDepartments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        option.textContent = dept;
                        departmentSelect.appendChild(option);
                    });
                }
                
                // Kh√¥i ph·ª•c gi√° tr·ªã ƒë√£ ch·ªçn (n·∫øu c√≥)
                if (currentValue) {
                    departmentSelect.value = currentValue;
                }
                
            }).catch((error) => {
                console.error('Error loading departments:', error);
                // S·ª≠ d·ª•ng fallback n·∫øu c√≥ l·ªói
                departmentSelect.innerHTML = `
                    <option value="">Ch·ªçn ph√≤ng ban</option>
                    <option value="Operations">V·∫≠n h√†nh</option>
                    <option value="Sales & Marketing">Kinh doanh & Marketing</option>
                    <option value="Human Resources">Nh√¢n s·ª±</option>
                    <option value="Finance">T√†i ch√≠nh</option>
                    <option value="IT">C√¥ng ngh·ªá th√¥ng tin</option>
                    <option value="Customer Service">ChƒÉm s√≥c kh√°ch h√†ng</option>
                `;
            });
        }

        function renderStaffTable(staffList) {
            const staffTable = document.getElementById('staffTable');
            staffTable.innerHTML = '';
            if (staffList.length === 0) {
                staffTable.innerHTML = '<tr><td colspan="7" class="text-center py-5">Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n ph√π h·ª£p.</td></tr>';
                return;
            }
            staffList.forEach(staff => {
                const avatar = staff.avatar ? `<img src="${staff.avatar}" alt="avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : '<span class="avatar-placeholder" style="display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;background-color:#e9ecef;border-radius:50%;color:#6c757d;"><i class="fas fa-user"></i></span>';
                const joined = staff.joinedAt ? new Date(staff.joinedAt).toLocaleDateString('vi-VN') : 'N/A';
                
                // Dynamic role display t·ª´ Firebase
                let roleDisplay = 'Ch∆∞a ph√¢n vai tr√≤';
                if (staff.role) {
                    // T√¨m role t·ª´ allRoles (Firebase data)
                    const roleData = allRoles.find(r => r.code === staff.role);
                    if (roleData && roleData.name) {
                        roleDisplay = roleData.name;
                    } else {
                        // Fallback mapping n·∫øu kh√¥ng t√¨m th·∫•y trong Firebase
                        const roleDisplayNames = {
                            'cskh': 'ChƒÉm s√≥c kh√°ch h√†ng',
                            'manager': 'Qu·∫£n l√Ω kh√°ch s·∫°n',
                            'marketing': 'Marketing',
                            'kythuat': 'K·ªπ thu·∫≠t',
                            'admin': 'Qu·∫£n tr·ªã vi√™n',
                            'receptionist': 'L·ªÖ t√¢n',
                            'housekeeping': 'Bu·ªìng ph√≤ng',
                            'security': 'B·∫£o v·ªá',
                            'finance': 'K·∫ø to√°n',
                            'hr': 'Nh√¢n s·ª±'
                        };
                        roleDisplay = roleDisplayNames[staff.role] || staff.role;
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${avatar}</td>
                    <td>
                        <div class="fw-bold">${staff.name || 'N/A'}</div>
                        <small class="text-muted">${staff.employeeId || 'N/A'}</small>
                    </td>
                    <td>${staff.email || 'N/A'}</td>
                    <td>${staff.phone || 'N/A'}</td>
                    <td>
                        <span class="badge bg-primary">${roleDisplay}</span>
                    </td>
                    <td>${joined}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info" onclick="viewStaff('${staff.id}')" title="Xem chi ti·∫øt">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editStaff('${staff.id}')" title="Ch·ªânh s·ª≠a">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStaff('${staff.id}')" title="X√≥a">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                staffTable.appendChild(row);
            });
        }

        function addStaff() {
            // Load danh s√°ch users, roles v√† departments t·ª´ Firebase tr∆∞·ªõc khi hi·ªÉn th·ªã modal
            Promise.all([
                db.ref('users').once('value'),
                db.ref('roles').once('value'),
                db.ref('departments').once('value')
            ]).then(([usersSnapshot, rolesSnapshot, departmentsSnapshot]) => {
                let usersOptions = '<option value="">-- Nh·∫≠p th·ªß c√¥ng ho·∫∑c ch·ªçn t·ª´ danh s√°ch --</option>';
                let rolesOptions = '<option value="">Ch·ªçn ch·ª©c v·ª• *</option>';
                let departmentsOptions = '<option value="">Ch·ªçn ph√≤ng ban</option>';
                
                // Load users options
                if (usersSnapshot.exists()) {
                    usersSnapshot.forEach((userSnapshot) => {
                        const user = userSnapshot.val();
                        const userId = userSnapshot.key;
                        if (user.name && user.phone) {
                            usersOptions += `<option value="${userId}" data-user='${JSON.stringify(user)}'>${user.name} - ${user.phone}</option>`;
                        }
                    });
                }
                
                // Load roles options
                window.rolesData = {}; // Kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng l∆∞u tr·ªØ th√¥ng tin roles
                if (rolesSnapshot.exists()) {
                    rolesSnapshot.forEach((roleSnapshot) => {
                        const role = roleSnapshot.val();
                        const roleId = roleSnapshot.key;
                        if (role.name && role.code) {
                            // L∆∞u th√¥ng tin role v√†o window.rolesData
                            window.rolesData[role.code] = role;
                            
                            const salary = role.salary ? ` - ${role.salary.toLocaleString('vi-VN')} VNƒê` : '';
                            const allowance = role.allowance ? ` + ${role.allowance.toLocaleString('vi-VN')} VNƒê ph·ª• c·∫•p` : '';
                            rolesOptions += `<option value="${role.code}" data-role='${JSON.stringify(role)}'>${role.name} (${role.code})${salary}${allowance}</option>`;
                        }
                    });
                } else {
                    // Fallback options n·∫øu kh√¥ng c√≥ roles trong database
                    rolesOptions += `
                        <option value="cskh">ChƒÉm s√≥c kh√°ch h√†ng</option>
                        <option value="manager">Qu·∫£n l√Ω kh√°ch s·∫°n</option>
                        <option value="marketing">Marketing</option>
                        <option value="kythuat">K·ªπ thu·∫≠t</option>
                        <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
                        <option value="receptionist">L·ªÖ t√¢n</option>
                        <option value="housekeeping">Bu·ªìng ph√≤ng</option>
                        <option value="security">B·∫£o v·ªá</option>
                        <option value="finance">K·∫ø to√°n</option>
                        <option value="hr">Nh√¢n s·ª±</option>
                    `;
                }
                
                // Load departments options
                if (departmentsSnapshot.exists()) {
                    departmentsSnapshot.forEach((deptSnapshot) => {
                        const department = deptSnapshot.val();
                        if (department.name && department.status === 'active') {
                            departmentsOptions += `<option value="${department.code || department.name}">${department.name}</option>`;
                        }
                    });
                } else {
                    // Fallback options n·∫øu kh√¥ng c√≥ departments trong database
                    departmentsOptions += `
                        <option value="Operations">V·∫≠n h√†nh</option>
                        <option value="Sales & Marketing">Kinh doanh & Marketing</option>
                        <option value="Human Resources">Nh√¢n s·ª±</option>
                        <option value="Finance">T√†i ch√≠nh</option>
                        <option value="IT">C√¥ng ngh·ªá th√¥ng tin</option>
                        <option value="Customer Service">ChƒÉm s√≥c kh√°ch h√†ng</option>
                    `;
                }
                
                Swal.fire({
                title: 'Th√™m nh√¢n vi√™n m·ªõi',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Th√¥ng tin c√° nh√¢n</h6>
                                <div class="mb-2">
                                    <label class="form-label">Ch·ªçn t·ª´ kh√°ch h√†ng hi·ªán c√≥ (t√πy ch·ªçn)</label>
                                    <select id="staffUserSelect" class="form-select" onchange="fillUserData()">
                                        ${usersOptions}
                                    </select>
                                </div>
                                <input type="text" id="staffName" class="form-control mb-2" placeholder="H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß *" required>
                                <input type="date" id="staffBirthDate" class="form-control mb-2" placeholder="Ng√†y sinh">
                                <select id="staffGender" class="form-select mb-2">
                                    <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                    <option value="Nam">Nam</option>
                                    <option value="N·ªØ">N·ªØ</option>
                                    <option value="Kh√°c">Kh√°c</option>
                                </select>
                                <input type="text" id="staffIdCard" class="form-control mb-2" placeholder="S·ªë CCCD/CMND *" required>
                                <input type="date" id="staffIdCardDate" class="form-control mb-2" placeholder="Ng√†y c·∫•p CCCD">
                                <input type="text" id="staffIdCardPlace" class="form-control mb-2" placeholder="N∆°i c·∫•p CCCD">
                                <input type="text" id="staffNationality" class="form-control mb-2" placeholder="Qu·ªëc t·ªãch" value="Vi·ªát Nam">
                                <input type="text" id="staffEthnicity" class="form-control mb-2" placeholder="D√¢n t·ªôc" value="Kinh">
                                <input type="text" id="staffReligion" class="form-control mb-2" placeholder="T√¥n gi√°o">
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-address-card"></i> Th√¥ng tin li√™n h·ªá</h6>
                                <input type="email" id="staffEmail" class="form-control mb-2" placeholder="Email c√¥ng ty *" required>
                                <input type="text" id="staffPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i *" required>
                                <input type="text" id="staffPersonalPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i c√° nh√¢n">
                                <textarea id="staffAddress" class="form-control mb-2" rows="2" placeholder="ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫"></textarea>
                                <textarea id="staffTempAddress" class="form-control mb-2" rows="2" placeholder="ƒê·ªãa ch·ªâ t·∫°m tr√∫ (n·∫øu kh√°c)"></textarea>
                                <input type="text" id="staffEmergencyContact" class="form-control mb-2" placeholder="Ng∆∞·ªùi li√™n h·ªá kh·∫©n c·∫•p">
                                <input type="text" id="staffEmergencyPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i kh·∫©n c·∫•p">
                                <input type="text" id="staffRelationship" class="form-control mb-2" placeholder="M·ªëi quan h·ªá (Cha/M·∫π/Anh/Ch·ªã/...)">

                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3"><i class="fas fa-graduation-cap"></i> H·ªçc v·∫•n & Kinh nghi·ªám</h6>
                                <select id="staffEducation" class="form-select mb-2">
                                    <option value="">Tr√¨nh ƒë·ªô h·ªçc v·∫•n</option>
                                    <option value="Ti·ªÉu h·ªçc">Ti·ªÉu h·ªçc</option>
                                    <option value="Trung h·ªçc c∆° s·ªü">Trung h·ªçc c∆° s·ªü</option>
                                    <option value="Trung h·ªçc ph·ªï th√¥ng">Trung h·ªçc ph·ªï th√¥ng</option>
                                    <option value="Trung c·∫•p">Trung c·∫•p</option>
                                    <option value="Cao ƒë·∫≥ng">Cao ƒë·∫≥ng</option>
                                    <option value="ƒê·∫°i h·ªçc">ƒê·∫°i h·ªçc</option>
                                    <option value="Th·∫°c sƒ©">Th·∫°c sƒ©</option>
                                    <option value="Ti·∫øn sƒ©">Ti·∫øn sƒ©</option>
                                </select>
                                <input type="text" id="staffMajor" class="form-control mb-2" placeholder="Chuy√™n ng√†nh">
                                <input type="text" id="staffSchool" class="form-control mb-2" placeholder="Tr∆∞·ªùng h·ªçc/ƒê·∫°i h·ªçc">
                                <input type="number" id="staffExperience" class="form-control mb-2" placeholder="S·ªë nƒÉm kinh nghi·ªám" min="0">
                                <textarea id="staffSkills" class="form-control mb-2" rows="2" placeholder="K·ªπ nƒÉng chuy√™n m√¥n"></textarea>
                                <textarea id="staffCertificates" class="form-control mb-2" rows="2" placeholder="Ch·ª©ng ch·ªâ/B·∫±ng c·∫•p kh√°c"></textarea>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-briefcase"></i> Th√¥ng tin c√¥ng vi·ªác</h6>
                                <select id="staffRole" class="form-select mb-2" required onchange="fillRoleData()">
                                    ${rolesOptions}
                                </select>
                                <div id="roleDetails" class="mb-2 p-2 bg-light rounded" style="display: none;">
                                    <small class="text-muted">
                                        <div><strong>M√¥ t·∫£:</strong> <span id="roleDescription"></span></div>
                                        <div><strong>Quy·ªÅn h·∫°n:</strong> <span id="rolePermissions"></span></div>
                                        <div><strong>L∆∞∆°ng c∆° b·∫£n:</strong> <span id="roleSalary"></span></div>
                                        <div><strong>Ph·ª• c·∫•p:</strong> <span id="roleAllowance"></span></div>
                                    </small>
                                </div>
                                <select id="staffDepartment" class="form-select mb-2">
                                    ${departmentsOptions}
                                </select>
                                <input type="date" id="staffStartDate" class="form-control mb-2" placeholder="Ng√†y b·∫Øt ƒë·∫ßu l√†m vi·ªác">
                                <select id="staffEmploymentType" class="form-select mb-2">
                                    <option value="To√†n th·ªùi gian">To√†n th·ªùi gian</option>
                                    <option value="B√°n th·ªùi gian">B√°n th·ªùi gian</option>
                                    <option value="Th·ª≠ vi·ªác">Th·ª≠ vi·ªác</option>
                                    <option value="Th·ª±c t·∫≠p">Th·ª±c t·∫≠p</option>
                                    <option value="H·ª£p ƒë·ªìng">H·ª£p ƒë·ªìng</option>
                                </select>
                                <input type="number" id="staffBasicSalary" class="form-control mb-2" placeholder="L∆∞∆°ng c∆° b·∫£n (VNƒê)" min="0">
                                <input type="text" id="staffBankAccount" class="form-control mb-2" placeholder="S·ªë t√†i kho·∫£n ng√¢n h√†ng">
                                <input type="text" id="staffBankName" class="form-control mb-2" placeholder="T√™n ng√¢n h√†ng">
                                <textarea id="staffNote" class="form-control mb-2" rows="2" placeholder="Ghi ch√∫ th√™m"></textarea>
                            </div>
                        </div>
                    </div>
                `,
                width: '90%',
                showCancelButton: true,
                confirmButtonText: 'Th√™m nh√¢n vi√™n',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const name = document.getElementById('staffName').value.trim();
                    const email = document.getElementById('staffEmail').value.trim();
                    const phone = document.getElementById('staffPhone').value.trim();
                    const idCard = document.getElementById('staffIdCard').value.trim();
                    const role = document.getElementById('staffRole').value;
                    
                    if (!name || !email || !phone || !idCard || !role) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√°c th√¥ng tin b·∫Øt bu·ªôc (*)');
                        return false;
                    }
                    
                    // Validate email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        Swal.showValidationMessage('Email kh√¥ng h·ª£p l·ªá');
                        return false;
                    }
                    
                    // Validate phone
                    const phoneRegex = /^[0-9]{10,11}$/;
                    if (!phoneRegex.test(phone)) {
                        Swal.showValidationMessage('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë');
                        return false;
                    }
                    
                    // Validate ID Card
                    const idCardRegex = /^[0-9]{9,12}$/;
                    if (!idCardRegex.test(idCard)) {
                        Swal.showValidationMessage('S·ªë CCCD/CMND kh√¥ng h·ª£p l·ªá');
                        return false;
                    }
                    
                    return {
                        // Th√¥ng tin c√° nh√¢n
                        name: name,
                        birthDate: (document.getElementById('staffBirthDate') || {}).value || '',
                        gender: (document.getElementById('staffGender') || {}).value || '',
                        idCard: idCard,
                        idCardDate: (document.getElementById('staffIdCardDate') || {}).value || '',
                        idCardPlace: (document.getElementById('staffIdCardPlace') || {}).value || '',
                        nationality: (document.getElementById('staffNationality') || {}).value || 'Vi·ªát Nam',
                        ethnicity: (document.getElementById('staffEthnicity') || {}).value || 'Kinh',
                        religion: (document.getElementById('staffReligion') || {}).value || '',
                        
                        // Th√¥ng tin li√™n h·ªá
                        email: email,
                        phone: phone,
                        personalPhone: (document.getElementById('staffPersonalPhone') || {}).value || '',
                        address: (document.getElementById('staffAddress') || {}).value || '',
                        tempAddress: (document.getElementById('staffTempAddress') || {}).value || '',
                        emergencyContact: (document.getElementById('staffEmergencyContact') || {}).value || '',
                        emergencyPhone: (document.getElementById('staffEmergencyPhone') || {}).value || '',
                        relationship: (document.getElementById('staffRelationship') || {}).value || '',
                        
                        // H·ªçc v·∫•n & Kinh nghi·ªám
                        education: (document.getElementById('staffEducation') || {}).value || '',
                        major: (document.getElementById('staffMajor') || {}).value || '',
                        school: (document.getElementById('staffSchool') || {}).value || '',
                        experience: parseInt((document.getElementById('staffExperience') || {}).value) || 0,
                        skills: (document.getElementById('staffSkills') || {}).value || '',
                        certificates: (document.getElementById('staffCertificates') || {}).value || '',
                        
                        // Th√¥ng tin c√¥ng vi·ªác
                        role: role,
                        department: (document.getElementById('staffDepartment') || {}).value || '',
                        startDate: (document.getElementById('staffStartDate') || {}).value || '',
                        employmentType: (document.getElementById('staffEmploymentType') || {}).value || 'To√†n th·ªùi gian',
                        basicSalary: parseInt((document.getElementById('staffBasicSalary') || {}).value) || 0,
                        bankAccount: (document.getElementById('staffBankAccount') || {}).value || '',
                        bankName: (document.getElementById('staffBankName') || {}).value || '',
                        note: (document.getElementById('staffNote') || {}).value || ''
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newStaff = result.value;
                    console.log('New staff data:', newStaff); // Debug log
                    
                    newStaff.joinedAt = Date.now();
                    newStaff.createdAt = Date.now();
                    newStaff.status = 'active';
                    newStaff.employeeId = 'EMP' + Date.now().toString().slice(-8); // T·∫°o m√£ nh√¢n vi√™n
                    
                    console.log('Attempting to save staff to Firebase...'); // Debug log
                    
                    db.ref('staff').push(newStaff).then(() => {
                        console.log('Staff saved successfully!'); // Debug log
                        loadStaff();
                        Swal.fire({
                            icon: 'success',
                            title: 'Th√†nh c√¥ng!',
                            text: `ƒê√£ th√™m nh√¢n vi√™n m·ªõi: ${newStaff.name}`,
                            timer: 2000
                        });
                    }).catch((error) => {
                        console.error('Error saving staff:', error); // Debug log
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ th√™m nh√¢n vi√™n: ' + error.message, 'error');
                    });
                }
            });
            }).catch((error) => {
                console.error('Error loading users for staff dropdown:', error);
                // N·∫øu l·ªói load users, v·∫´n hi·ªÉn th·ªã modal nh∆∞ng kh√¥ng c√≥ dropdown
                Swal.fire({
                    title: 'Th√™m nh√¢n vi√™n m·ªõi',
                    text: 'L·ªói t·∫£i danh s√°ch kh√°ch h√†ng, vui l√≤ng nh·∫≠p th·ªß c√¥ng.',
                    icon: 'warning'
                });
            });
        }

        // Function ƒë·ªÉ ƒëi·ªÅn d·ªØ li·ªáu t·ª´ user ƒë√£ ch·ªçn
        function fillUserData() {
            const select = document.getElementById('staffUserSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value && selectedOption.dataset.user) {
                const userData = JSON.parse(selectedOption.dataset.user);
                
                // ƒêi·ªÅn th√¥ng tin c√° nh√¢n
                if (userData.name) document.getElementById('staffName').value = userData.name;
                if (userData.birthday) document.getElementById('staffBirthDate').value = userData.birthday;
                if (userData.gender) document.getElementById('staffGender').value = userData.gender;
                if (userData.identityNumber) document.getElementById('staffIdCard').value = userData.identityNumber;
                if (userData.nationality) document.getElementById('staffNationality').value = userData.nationality;
                
                // ƒêi·ªÅn th√¥ng tin li√™n h·ªá (n·∫øu c√≥ email trong d·ªØ li·ªáu user)
                if (userData.email) document.getElementById('staffEmail').value = userData.email;
                if (userData.phone) document.getElementById('staffPhone').value = userData.phone;
                if (userData.address) document.getElementById('staffAddress').value = userData.address;
                
                // T·ª± ƒë·ªông ƒëi·ªÅn m·ªôt s·ªë th√¥ng tin m·∫∑c ƒë·ªãnh
                document.getElementById('staffEmploymentType').value = 'To√†n th·ªùi gian';
                document.getElementById('staffStartDate').value = new Date().toISOString().split('T')[0];
                
                Swal.showValidationMessage('ƒê√£ ƒëi·ªÅn th√¥ng tin t·ª´ kh√°ch h√†ng: ' + userData.name);
                setTimeout(() => {
                    Swal.resetValidationMessage();
                }, 2000);
            }
        }

        // H√†m ƒëi·ªÅn th√¥ng tin ch·ª©c v·ª• khi ch·ªçn
        function fillRoleData() {
            const roleSelect = document.getElementById('staffRole');
            const roleDetails = document.getElementById('roleDetails');
            const roleValue = roleSelect.value;

            console.log('fillRoleData called with:', roleValue); // Debug log
            console.log('rolesData:', window.rolesData); // Debug log

            if (roleValue && window.rolesData && window.rolesData[roleValue]) {
                const roleData = window.rolesData[roleValue];
                console.log('Selected role data:', roleData); // Debug log
                
                // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt ch·ª©c v·ª•
                document.getElementById('roleDescription').textContent = roleData.description || 'Ch∆∞a c√≥ m√¥ t·∫£';
                
                // X·ª≠ l√Ω permissions - c√≥ th·ªÉ l√† string ho·∫∑c array
                let permissionsText = 'Ch∆∞a c√≥ quy·ªÅn h·∫°n';
                if (roleData.permissions) {
                    if (Array.isArray(roleData.permissions)) {
                        permissionsText = roleData.permissions.join(', ');
                    } else {
                        permissionsText = roleData.permissions;
                    }
                }
                document.getElementById('rolePermissions').textContent = permissionsText;
                
                document.getElementById('roleSalary').textContent = roleData.salary ? formatCurrency(roleData.salary) : 'Ch∆∞a c√≥ th√¥ng tin';
                document.getElementById('roleAllowance').textContent = roleData.allowance ? formatCurrency(roleData.allowance) : 'Ch∆∞a c√≥ th√¥ng tin';
                
                roleDetails.style.display = 'block';
                
                // T·ª± ƒë·ªông ƒëi·ªÅn l∆∞∆°ng c∆° b·∫£n v√†o form v·ªõi delay nh·ªè
                setTimeout(() => {
                    const salaryField = document.getElementById('staffBasicSalary');
                    console.log('Salary field found:', salaryField); // Debug log
                    
                    if (roleData.salary && salaryField) {
                        salaryField.value = roleData.salary;
                        console.log('Salary filled:', roleData.salary); // Debug log
                        
                        // Trigger change event ƒë·ªÉ ƒë·∫£m b·∫£o UI update
                        salaryField.dispatchEvent(new Event('change'));
                    }
                }, 100);
                
                // T·∫°o m·ªôt th√¥ng b√°o nh·ªè v·ªÅ ph·ª• c·∫•p (v√¨ kh√¥ng c√≥ field ri√™ng cho ph·ª• c·∫•p)
                setTimeout(() => {
                    if (roleData.allowance) {
                        const noteField = document.getElementById('staffNote');
                        if (noteField) {
                            const currentNote = noteField.value;
                            const allowanceNote = `Ph·ª• c·∫•p ch·ª©c v·ª•: ${formatCurrency(roleData.allowance)}`;
                            
                            if (!currentNote.includes('Ph·ª• c·∫•p ch·ª©c v·ª•:')) {
                                noteField.value = currentNote ? `${currentNote}\n${allowanceNote}` : allowanceNote;
                                console.log('Allowance note added:', allowanceNote); // Debug log
                            }
                        }
                    }
                }, 100);
                
            } else {
                roleDetails.style.display = 'none';
                // X√≥a gi√° tr·ªã l∆∞∆°ng c∆° b·∫£n n·∫øu kh√¥ng c√≥ ch·ª©c v·ª•
                setTimeout(() => {
                    const salaryField = document.getElementById('staffBasicSalary');
                    if (salaryField) {
                        salaryField.value = '';
                    }
                    
                    // X√≥a th√¥ng tin ph·ª• c·∫•p kh·ªèi ghi ch√∫
                    const noteField = document.getElementById('staffNote');
                    if (noteField && noteField.value.includes('Ph·ª• c·∫•p ch·ª©c v·ª•:')) {
                        noteField.value = noteField.value.replace(/Ph·ª• c·∫•p ch·ª©c v·ª•:.*?\n?/g, '').trim();
                    }
                }, 100);
            }
        }

        // H√†m format ti·ªÅn t·ªá
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function viewStaff(staffId) {
            const staff = allStaff.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†y.', 'error');
                return;
            }
            
            Swal.fire({
                title: `<i class="fas fa-user-circle"></i> Th√¥ng tin nh√¢n vi√™n: ${staff.name}`,
                html: `
                    <div class="container-fluid text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="fas fa-user"></i> Th√¥ng tin c√° nh√¢n</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>M√£ nh√¢n vi√™n:</strong> ${staff.employeeId || 'N/A'}</p>
                                        <p><strong>H·ªç v√† t√™n:</strong> ${staff.name || 'N/A'}</p>
                                        <p><strong>Ng√†y sinh:</strong> ${staff.birthDate ? new Date(staff.birthDate).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        <p><strong>Gi·ªõi t√≠nh:</strong> ${staff.gender || 'N/A'}</p>
                                        <p><strong>CCCD/CMND:</strong> ${staff.idCard || 'N/A'}</p>
                                        <p><strong>Ng√†y c·∫•p:</strong> ${staff.idCardDate ? new Date(staff.idCardDate).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        <p><strong>N∆°i c·∫•p:</strong> ${staff.idCardPlace || 'N/A'}</p>
                                        <p><strong>Qu·ªëc t·ªãch:</strong> ${staff.nationality || 'N/A'}</p>
                                        <p><strong>D√¢n t·ªôc:</strong> ${staff.ethnicity || 'N/A'}</p>
                                        <p><strong>T√¥n gi√°o:</strong> ${staff.religion || 'N/A'}</p>
                                    </div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-address-card"></i> Th√¥ng tin li√™n h·ªá</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Email c√¥ng ty:</strong> ${staff.email || 'N/A'}</p>
                                        <p><strong>ƒêi·ªán tho·∫°i:</strong> ${staff.phone || 'N/A'}</p>
                                        <p><strong>ƒêi·ªán tho·∫°i c√° nh√¢n:</strong> ${staff.personalPhone || 'N/A'}</p>
                                        <p><strong>ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫:</strong> ${staff.address || 'N/A'}</p>
                                        <p><strong>ƒê·ªãa ch·ªâ t·∫°m tr√∫:</strong> ${staff.tempAddress || 'N/A'}</p>
                                        <p><strong>Li√™n h·ªá kh·∫©n c·∫•p:</strong> ${staff.emergencyContact || 'N/A'}</p>
                                        <p><strong>SƒêT kh·∫©n c·∫•p:</strong> ${staff.emergencyPhone || 'N/A'}</p>
                                        <p><strong>M·ªëi quan h·ªá:</strong> ${staff.relationship || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fas fa-graduation-cap"></i> H·ªçc v·∫•n & Kinh nghi·ªám</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Tr√¨nh ƒë·ªô h·ªçc v·∫•n:</strong> ${staff.education || 'N/A'}</p>
                                        <p><strong>Chuy√™n ng√†nh:</strong> ${staff.major || 'N/A'}</p>
                                        <p><strong>Tr∆∞·ªùng h·ªçc:</strong> ${staff.school || 'N/A'}</p>
                                        <p><strong>Kinh nghi·ªám:</strong> ${staff.experience || 0} nƒÉm</p>
                                        <p><strong>K·ªπ nƒÉng:</strong> ${staff.skills || 'N/A'}</p>
                                        <p><strong>Ch·ª©ng ch·ªâ:</strong> ${staff.certificates || 'N/A'}</p>
                                    </div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-briefcase"></i> Th√¥ng tin c√¥ng vi·ªác</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Ch·ª©c v·ª•:</strong> ${staff.role || 'N/A'}</p>
                                        <p><strong>Ph√≤ng ban:</strong> ${staff.department || 'N/A'}</p>
                                        <p><strong>Ng√†y b·∫Øt ƒë·∫ßu:</strong> ${staff.startDate ? new Date(staff.startDate).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        <p><strong>Lo·∫°i h·ª£p ƒë·ªìng:</strong> ${staff.employmentType || 'N/A'}</p>
                                        <p><strong>L∆∞∆°ng c∆° b·∫£n:</strong> ${staff.basicSalary ? staff.basicSalary.toLocaleString('vi-VN') + ' VNƒê' : 'N/A'}</p>
                                        <p><strong>T√†i kho·∫£n ng√¢n h√†ng:</strong> ${staff.bankAccount || 'N/A'}</p>
                                        <p><strong>Ng√¢n h√†ng:</strong> ${staff.bankName || 'N/A'}</p>
                                        <p><strong>Tr·∫°ng th√°i:</strong> 
                                            <span class="badge ${staff.status === 'active' ? 'bg-success' : staff.status === 'inactive' ? 'bg-secondary' : 'bg-warning'}">
                                                ${staff.status === 'active' ? 'ƒêang l√†m vi·ªác' : staff.status === 'inactive' ? 'ƒê√£ ngh·ªâ vi·ªác' : 'T·∫°m ngh·ªâ'}
                                            </span>
                                        </p>
                                        <p><strong>Ghi ch√∫:</strong> ${staff.note || 'N/A'}</p>
                                        <p><strong>Ng√†y t·∫°o:</strong> ${staff.createdAt ? new Date(staff.createdAt).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                width: '90%',
                showCloseButton: true,
                focusConfirm: false,
                confirmButtonText: 'ƒê√≥ng'
            });
        }

        function editStaff(staffId) {
            const staff = allStaff.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†y.', 'error');
                return;
            }
            
            // Load roles v√† departments t·ª´ Firebase tr∆∞·ªõc khi hi·ªÉn th·ªã modal
            Promise.all([
                db.ref('roles').once('value'),
                db.ref('departments').once('value')
            ]).then(([rolesSnapshot, departmentsSnapshot]) => {
                let rolesOptions = '<option value="">Ch·ªçn ch·ª©c v·ª• *</option>';
                let departmentsOptions = '<option value="">Ph√≤ng ban</option>';
                
                if (rolesSnapshot.exists()) {
                    rolesSnapshot.forEach((roleSnapshot) => {
                        const role = roleSnapshot.val();
                        const roleId = roleSnapshot.key;
                        if (role.name && role.code) {
                            const salary = role.salary ? ` - ${role.salary.toLocaleString('vi-VN')} VNƒê` : '';
                            const allowance = role.allowance ? ` + ${role.allowance.toLocaleString('vi-VN')} VNƒê ph·ª• c·∫•p` : '';
                            const isSelected = staff.role === role.code ? 'selected' : '';
                            rolesOptions += `<option value="${role.code}" ${isSelected} data-salary="${role.salary || 0}" data-allowance="${role.allowance || 0}" data-description="${role.description || ''}" data-permissions="${role.permissions || ''}">${role.name} (${role.code})${salary}${allowance}</option>`;
                        }
                    });
                } else {
                    // Fallback options n·∫øu kh√¥ng c√≥ roles trong database
                    rolesOptions += `
                        <option value="cskh" ${staff.role === 'cskh' ? 'selected' : ''}>ChƒÉm s√≥c kh√°ch h√†ng</option>
                        <option value="manager" ${staff.role === 'manager' ? 'selected' : ''}>Qu·∫£n l√Ω kh√°ch s·∫°n</option>
                        <option value="marketing" ${staff.role === 'marketing' ? 'selected' : ''}>Marketing</option>
                        <option value="kythuat" ${staff.role === 'kythuat' ? 'selected' : ''}>K·ªπ thu·∫≠t</option>
                        <option value="admin" ${staff.role === 'admin' ? 'selected' : ''}>Qu·∫£n tr·ªã vi√™n</option>
                        <option value="receptionist" ${staff.role === 'receptionist' ? 'selected' : ''}>L·ªÖ t√¢n</option>
                        <option value="housekeeping" ${staff.role === 'housekeeping' ? 'selected' : ''}>Bu·ªìng ph√≤ng</option>
                        <option value="security" ${staff.role === 'security' ? 'selected' : ''}>B·∫£o v·ªá</option>
                        <option value="finance" ${staff.role === 'finance' ? 'selected' : ''}>K·∫ø to√°n</option>
                        <option value="hr" ${staff.role === 'hr' ? 'selected' : ''}>Nh√¢n s·ª±</option>
                    `;
                }
                
                // Load departments options
                if (departmentsSnapshot.exists()) {
                    departmentsSnapshot.forEach((deptSnapshot) => {
                        const department = deptSnapshot.val();
                        if (department.name && department.status === 'active') {
                            const isSelected = staff.department === (department.code || department.name) ? 'selected' : '';
                            departmentsOptions += `<option value="${department.code || department.name}" ${isSelected}>${department.name}</option>`;
                        }
                    });
                } else {
                    // Fallback options n·∫øu kh√¥ng c√≥ departments trong database
                    departmentsOptions += `
                        <option value="Operations" ${staff.department === 'Operations' ? 'selected' : ''}>V·∫≠n h√†nh</option>
                        <option value="Sales & Marketing" ${staff.department === 'Sales & Marketing' ? 'selected' : ''}>Kinh doanh & Marketing</option>
                        <option value="Human Resources" ${staff.department === 'Human Resources' ? 'selected' : ''}>Nh√¢n s·ª±</option>
                        <option value="Finance" ${staff.department === 'Finance' ? 'selected' : ''}>T√†i ch√≠nh</option>
                        <option value="IT" ${staff.department === 'IT' ? 'selected' : ''}>C√¥ng ngh·ªá th√¥ng tin</option>
                        <option value="Customer Service" ${staff.department === 'Customer Service' ? 'selected' : ''}>ChƒÉm s√≥c kh√°ch h√†ng</option>
                    `;
                }
            
            Swal.fire({
                title: 'Ch·ªânh s·ª≠a th√¥ng tin nh√¢n vi√™n',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Th√¥ng tin c√° nh√¢n</h6>
                                <input type="text" id="editStaffName" class="form-control mb-2" placeholder="H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß *" value="${staff.name || ''}" required>
                                <input type="date" id="editStaffBirthDate" class="form-control mb-2" value="${staff.birthDate || ''}">
                                <select id="editStaffGender" class="form-select mb-2">
                                    <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                    <option value="Nam" ${staff.gender === 'Nam' ? 'selected' : ''}>Nam</option>
                                    <option value="N·ªØ" ${staff.gender === 'N·ªØ' ? 'selected' : ''}>N·ªØ</option>
                                    <option value="Kh√°c" ${staff.gender === 'Kh√°c' ? 'selected' : ''}>Kh√°c</option>
                                </select>
                                <input type="text" id="editStaffIdCard" class="form-control mb-2" placeholder="S·ªë CCCD/CMND *" value="${staff.idCard || ''}" required>
                                <input type="date" id="editStaffIdCardDate" class="form-control mb-2" value="${staff.idCardDate || ''}">
                                <input type="text" id="editStaffIdCardPlace" class="form-control mb-2" placeholder="N∆°i c·∫•p CCCD" value="${staff.idCardPlace || ''}">
                                <input type="text" id="editStaffNationality" class="form-control mb-2" placeholder="Qu·ªëc t·ªãch" value="${staff.nationality || 'Vi·ªát Nam'}">
                                <input type="text" id="editStaffEthnicity" class="form-control mb-2" placeholder="D√¢n t·ªôc" value="${staff.ethnicity || 'Kinh'}">
                                <input type="text" id="editStaffReligion" class="form-control mb-2" placeholder="T√¥n gi√°o" value="${staff.religion || ''}">
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-address-card"></i> Th√¥ng tin li√™n h·ªá</h6>
                                <input type="email" id="editStaffEmail" class="form-control mb-2" placeholder="Email c√¥ng ty *" value="${staff.email || ''}" required>
                                <input type="text" id="editStaffPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i *" value="${staff.phone || ''}" required>
                                <input type="text" id="editStaffPersonalPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i c√° nh√¢n" value="${staff.personalPhone || ''}">
                                <textarea id="editStaffAddress" class="form-control mb-2" rows="2" placeholder="ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫">${staff.address || ''}</textarea>
                                <textarea id="editStaffTempAddress" class="form-control mb-2" rows="2" placeholder="ƒê·ªãa ch·ªâ t·∫°m tr√∫">${staff.tempAddress || ''}</textarea>
                                <input type="text" id="editStaffEmergencyContact" class="form-control mb-2" placeholder="Ng∆∞·ªùi li√™n h·ªá kh·∫©n c·∫•p" value="${staff.emergencyContact || ''}">
                                <input type="text" id="editStaffEmergencyPhone" class="form-control mb-2" placeholder="SƒêT ng∆∞·ªùi li√™n h·ªá kh·∫©n c·∫•p" value="${staff.emergencyPhone || ''}">
                                <input type="text" id="editStaffRelationship" class="form-control mb-2" placeholder="M·ªëi quan h·ªá" value="${staff.relationship || ''}">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3"><i class="fas fa-graduation-cap"></i> H·ªçc v·∫•n & Kinh nghi·ªám</h6>
                                <select id="editStaffEducation" class="form-select mb-2">
                                    <option value="">Tr√¨nh ƒë·ªô h·ªçc v·∫•n</option>
                                    <option value="Ti·ªÉu h·ªçc" ${staff.education === 'Ti·ªÉu h·ªçc' ? 'selected' : ''}>Ti·ªÉu h·ªçc</option>
                                    <option value="Trung h·ªçc c∆° s·ªü" ${staff.education === 'Trung h·ªçc c∆° s·ªü' ? 'selected' : ''}>Trung h·ªçc c∆° s·ªü</option>
                                    <option value="Trung h·ªçc ph·ªï th√¥ng" ${staff.education === 'Trung h·ªçc ph·ªï th√¥ng' ? 'selected' : ''}>Trung h·ªçc ph·ªï th√¥ng</option>
                                    <option value="Trung c·∫•p" ${staff.education === 'Trung c·∫•p' ? 'selected' : ''}>Trung c·∫•p</option>
                                    <option value="Cao ƒë·∫≥ng" ${staff.education === 'Cao ƒë·∫≥ng' ? 'selected' : ''}>Cao ƒë·∫≥ng</option>
                                    <option value="ƒê·∫°i h·ªçc" ${staff.education === 'ƒê·∫°i h·ªçc' ? 'selected' : ''}>ƒê·∫°i h·ªçc</option>
                                    <option value="Th·∫°c sƒ©" ${staff.education === 'Th·∫°c sƒ©' ? 'selected' : ''}>Th·∫°c sƒ©</option>
                                    <option value="Ti·∫øn sƒ©" ${staff.education === 'Ti·∫øn sƒ©' ? 'selected' : ''}>Ti·∫øn sƒ©</option>
                                </select>
                                <input type="text" id="editStaffMajor" class="form-control mb-2" placeholder="Chuy√™n ng√†nh" value="${staff.major || ''}">
                                <input type="text" id="editStaffSchool" class="form-control mb-2" placeholder="Tr∆∞·ªùng h·ªçc/ƒê·∫°i h·ªçc" value="${staff.school || ''}">
                                <input type="number" id="editStaffExperience" class="form-control mb-2" placeholder="S·ªë nƒÉm kinh nghi·ªám" min="0" value="${staff.experience || 0}">
                                <textarea id="editStaffSkills" class="form-control mb-2" rows="2" placeholder="K·ªπ nƒÉng chuy√™n m√¥n">${staff.skills || ''}</textarea>
                                <textarea id="editStaffCertificates" class="form-control mb-2" rows="2" placeholder="Ch·ª©ng ch·ªâ/B·∫±ng c·∫•p kh√°c">${staff.certificates || ''}</textarea>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-briefcase"></i> Th√¥ng tin c√¥ng vi·ªác</h6>
                                <select id="editStaffRole" class="form-select mb-2" required onchange="updateEditRoleInfo()">
                                    ${rolesOptions}
                                </select>
                                <div id="editRoleDetails" class="mb-2 p-2 bg-light rounded" style="display: none;">
                                    <small class="text-muted">
                                        <div><strong>M√¥ t·∫£:</strong> <span id="editRoleDescription"></span></div>
                                        <div><strong>Quy·ªÅn h·∫°n:</strong> <span id="editRolePermissions"></span></div>
                                        <div><strong>L∆∞∆°ng c∆° b·∫£n:</strong> <span id="editRoleSalary"></span></div>
                                        <div><strong>Ph·ª• c·∫•p:</strong> <span id="editRoleAllowance"></span></div>
                                    </small>
                                </div>
                                <select id="editStaffDepartment" class="form-select mb-2">
                                    ${departmentsOptions}
                                </select>
                                <input type="date" id="editStaffStartDate" class="form-control mb-2" value="${staff.startDate || ''}">
                                <select id="editStaffEmploymentType" class="form-select mb-2">
                                    <option value="To√†n th·ªùi gian" ${staff.employmentType === 'To√†n th·ªùi gian' ? 'selected' : ''}>To√†n th·ªùi gian</option>
                                    <option value="B√°n th·ªùi gian" ${staff.employmentType === 'B√°n th·ªùi gian' ? 'selected' : ''}>B√°n th·ªùi gian</option>
                                    <option value="Th·ª≠ vi·ªác" ${staff.employmentType === 'Th·ª≠ vi·ªác' ? 'selected' : ''}>Th·ª≠ vi·ªác</option>
                                    <option value="Th·ª±c t·∫≠p" ${staff.employmentType === 'Th·ª±c t·∫≠p' ? 'selected' : ''}>Th·ª±c t·∫≠p</option>
                                    <option value="H·ª£p ƒë·ªìng" ${staff.employmentType === 'H·ª£p ƒë·ªìng' ? 'selected' : ''}>H·ª£p ƒë·ªìng</option>
                                </select>
                                <input type="number" id="editStaffBasicSalary" class="form-control mb-2" placeholder="L∆∞∆°ng c∆° b·∫£n (VNƒê)" min="0" value="${staff.basicSalary || ''}">
                                <input type="text" id="editStaffBankAccount" class="form-control mb-2" placeholder="S·ªë t√†i kho·∫£n ng√¢n h√†ng" value="${staff.bankAccount || ''}">
                                <input type="text" id="editStaffBankName" class="form-control mb-2" placeholder="T√™n ng√¢n h√†ng" value="${staff.bankName || ''}">
                                <select id="editStaffStatus" class="form-select mb-2">
                                    <option value="active" ${staff.status === 'active' ? 'selected' : ''}>ƒêang l√†m vi·ªác</option>
                                    <option value="inactive" ${staff.status === 'inactive' ? 'selected' : ''}>ƒê√£ ngh·ªâ vi·ªác</option>
                                    <option value="leave" ${staff.status === 'leave' ? 'selected' : ''}>T·∫°m ngh·ªâ</option>
                                </select>
                                <textarea id="editStaffNote" class="form-control mb-2" rows="2" placeholder="Ghi ch√∫ th√™m">${staff.note || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `,
                width: '90%',
                showCancelButton: true,
                confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                cancelButtonText: 'H·ªßy',
                didOpen: () => {
                    // Hi·ªÉn th·ªã th√¥ng tin role hi·ªán t·∫°i n·∫øu c√≥
                    updateEditRoleInfo();
                },
                preConfirm: () => {
                    const name = document.getElementById('editStaffName').value.trim();
                    const email = document.getElementById('editStaffEmail').value.trim();
                    const phone = document.getElementById('editStaffPhone').value.trim();
                    const idCard = document.getElementById('editStaffIdCard').value.trim();
                    const role = document.getElementById('editStaffRole').value;
                    
                    if (!name || !email || !phone || !idCard || !role) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√°c th√¥ng tin b·∫Øt bu·ªôc (*)');
                        return false;
                    }
                    
                    // Validate email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        Swal.showValidationMessage('Email kh√¥ng h·ª£p l·ªá');
                        return false;
                    }
                    
                    // Validate phone
                    const phoneRegex = /^[0-9]{10,11}$/;
                    if (!phoneRegex.test(phone)) {
                        Swal.showValidationMessage('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë');
                        return false;
                    }
                    
                    // Validate ID Card
                    const idCardRegex = /^[0-9]{9,12}$/;
                    if (!idCardRegex.test(idCard)) {
                        Swal.showValidationMessage('S·ªë CCCD/CMND kh√¥ng h·ª£p l·ªá');
                        return false;
                    }
                    
                    return {
                        // Th√¥ng tin c√° nh√¢n
                        name: name,
                        birthDate: document.getElementById('editStaffBirthDate').value,
                        gender: document.getElementById('editStaffGender').value,
                        idCard: idCard,
                        idCardDate: document.getElementById('editStaffIdCardDate').value,
                        idCardPlace: document.getElementById('editStaffIdCardPlace').value,
                        nationality: document.getElementById('editStaffNationality').value || 'Vi·ªát Nam',
                        ethnicity: document.getElementById('editStaffEthnicity').value || 'Kinh',
                        religion: document.getElementById('editStaffReligion').value,
                        
                        // Th√¥ng tin li√™n h·ªá
                        email: email,
                        phone: phone,
                        personalPhone: document.getElementById('editStaffPersonalPhone').value,
                        address: document.getElementById('editStaffAddress').value,
                        tempAddress: document.getElementById('editStaffTempAddress').value,
                        emergencyContact: document.getElementById('editStaffEmergencyContact').value,
                        emergencyPhone: document.getElementById('editStaffEmergencyPhone').value,
                        relationship: document.getElementById('editStaffRelationship').value,
                        
                        // H·ªçc v·∫•n & Kinh nghi·ªám
                        education: document.getElementById('editStaffEducation').value,
                        major: document.getElementById('editStaffMajor').value,
                        school: document.getElementById('editStaffSchool').value,
                        experience: parseInt(document.getElementById('editStaffExperience').value) || 0,
                        skills: document.getElementById('editStaffSkills').value,
                        certificates: document.getElementById('editStaffCertificates').value,
                        
                        // Th√¥ng tin c√¥ng vi·ªác
                        role: role,
                        department: document.getElementById('editStaffDepartment').value,
                        startDate: document.getElementById('editStaffStartDate').value,
                        employmentType: document.getElementById('editStaffEmploymentType').value || 'To√†n th·ªùi gian',
                        basicSalary: parseInt(document.getElementById('editStaffBasicSalary').value) || 0,
                        bankAccount: document.getElementById('editStaffBankAccount').value,
                        bankName: document.getElementById('editStaffBankName').value,
                        status: document.getElementById('editStaffStatus').value,
                        note: document.getElementById('editStaffNote').value,
                        updatedAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedStaff = result.value;
                    db.ref('staff/' + staffId).update(updatedStaff).then(() => {
                        loadStaff();
                        Swal.fire({
                            icon: 'success',
                            title: 'Th√†nh c√¥ng!',
                            text: 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n!',
                            timer: 2000
                        });
                    }).catch((error) => {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t nh√¢n vi√™n: ' + error.message, 'error');
                    });
                }
            });
            
            }).catch((error) => {
                console.error('Error loading roles for edit:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ch·ª©c v·ª•: ' + error.message, 'error');
            });
        }

        function updateEditRoleInfo() {
            const roleSelect = document.getElementById('editStaffRole');
            const selectedOption = roleSelect.options[roleSelect.selectedIndex];
            const roleDetails = document.getElementById('editRoleDetails');
            
            if (selectedOption && selectedOption.value && selectedOption.hasAttribute('data-description')) {
                // Hi·ªÉn th·ªã th√¥ng tin role
                const description = selectedOption.getAttribute('data-description') || 'Kh√¥ng c√≥ m√¥ t·∫£';
                const permissions = selectedOption.getAttribute('data-permissions') || 'Kh√¥ng c√≥ quy·ªÅn h·∫°n';
                const salary = selectedOption.getAttribute('data-salary') || '0';
                const allowance = selectedOption.getAttribute('data-allowance') || '0';
                
                document.getElementById('editRoleDescription').textContent = description;
                document.getElementById('editRolePermissions').textContent = permissions;
                document.getElementById('editRoleSalary').textContent = parseInt(salary) ? parseInt(salary).toLocaleString('vi-VN') + ' VNƒê' : 'Ch∆∞a c·∫•u h√¨nh';
                document.getElementById('editRoleAllowance').textContent = parseInt(allowance) ? parseInt(allowance).toLocaleString('vi-VN') + ' VNƒê' : 'Kh√¥ng c√≥';
                
                roleDetails.style.display = 'block';
            } else {
                roleDetails.style.display = 'none';
            }
        }

        function deleteStaff(staffId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('staff/' + staffId).remove().then(() => {
                        loadStaff();
                        Swal.fire('ƒê√£ x√≥a', 'Nh√¢n vi√™n ƒë√£ b·ªã x√≥a.', 'success');
                    }).catch((error) => {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√≥a nh√¢n vi√™n.', 'error');
                    });
                }
            });
        }

        function changeStaffRole(staffId, newRole) {
            db.ref('staff/' + staffId).update({ role: newRole }).then(() => {
                loadStaff();
            }).catch((error) => {
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t vai tr√≤.', 'error');
            });
        }
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.firebasestorage.app",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u c√°c th·ªÉ hi·ªán c·ªßa bi·ªÉu ƒë·ªì
        let revenueChartInstance, bookingTypeChartInstance, newUsersChartInstance, locationChartInstance;
        // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu g·ªëc
        let allBookings = [], allUsers = [], allHotels = [], allTours = [], allDeals = [], allTravelGuides = [], allStaff = [];
        let miniRevenueChartInstance;

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† quy·ªÅn admin/nh√¢n vi√™n
        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                console.log('Auth state changed:', user);
                
                if (!user) {
                    console.log('‚ùå No user authenticated - redirecting');
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('‚úÖ User authenticated:', user.email);
                console.log('User UID:', user.uid);
                
                // Cho ph√©p c·∫£ admin v√† nh√¢n vi√™n truy c·∫≠p dashboard
                const isAdmin = user.email === 'quantrikhachsan@gmail.com';
                const isStaff = user.email === 'nhanvien2@luxuryhaven.com';
                
                console.log('Is Admin:', isAdmin);
                console.log('Is Staff:', isStaff);
                
                if (!isAdmin && !isStaff) {
                    console.log('‚ùå Access denied for user:', user.email);
                    Swal.fire({
                        icon: 'error',
                        title: 'Truy c·∫≠p b·ªã t·ª´ ch·ªëi',
                        text: 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y'
                    }).then(() => {
                        auth.signOut();
                        window.location.href = 'index.html';
                    });
                    return;
                }
                
                console.log('‚úÖ Access granted for user:', user.email);
                
                // Test Firebase Rules ngay sau khi x√°c th·ª±c
                if (isAdmin) {
                    setTimeout(() => {
                        console.log('Running Firebase Rules test...');
                        testFirebaseRules();
                    }, 2000);
                }
                // Ph√¢n quy·ªÅn giao di·ªán cho nh√¢n vi√™n theo b·∫£ng ph√¢n quy·ªÅn
                if (isStaff) {
                    // ·∫®n c√°c m·ª•c kh√¥ng ƒë∆∞·ª£c ph√©p truy c·∫≠p
                    const dealsNav = document.querySelector('a[href="#deals"]');
                    const guidesNav = document.querySelector('a[href="#travel-guides"]');
                    const settingsNav = document.querySelector('a[href="#settings"]');
                    if (dealsNav) dealsNav.style.display = 'none';
                    if (guidesNav) guidesNav.style.display = 'none';
                    if (settingsNav) settingsNav.style.display = 'none';
                    // Main content sections
                    const dealsSection = document.getElementById('deals');
                    const guidesSection = document.getElementById('travel-guides');
                    const settingsSection = document.getElementById('settings');
                    if (dealsSection) dealsSection.style.display = 'none';
                    if (guidesSection) guidesSection.style.display = 'none';
                    if (settingsSection) settingsSection.style.display = 'none';
                    // Cho ph√©p xem th√¥ng b√°o
                    const notifBell = document.getElementById('notificationBell');
                    if (notifBell) notifBell.style.display = 'block';
                    // Kh√°ch s·∫°n: ch·ªâ cho xem, kh√¥ng cho th√™m/s·ª≠a/x√≥a
                    const addHotelBtn = document.querySelector('#hotels .btn.btn-primary');
                    if (addHotelBtn) addHotelBtn.style.display = 'none';
                    // Ng∆∞·ªùi d√πng: ch·ªâ cho xem, kh√¥ng cho s·ª≠a/x√≥a
                    const usersTable = document.getElementById('usersTable');
                    if (usersTable) {
                        usersTable.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => btn.style.display = 'none');
                    }
                    // Tours: ch·ªâ cho xem, kh√¥ng cho th√™m/s·ª≠a/x√≥a
                    const addTourBtn = document.querySelector('#tours .btn.btn-primary');
                    if (addTourBtn) addTourBtn.style.display = 'none';
                    // Dashboard: cho xu·∫•t file
                    const exportExcelBtn = document.getElementById('export-excel-btn');
                    if (exportExcelBtn) exportExcelBtn.style.display = 'block';
                }
            });
        }

        // ƒêƒÉng xu·∫•t
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
            });
        }

        // Load statistics
        function loadStatistics() {
            // Load total hotels
            db.ref('location').once('value').then((snapshot) => {
                let totalHotels = 0;
                snapshot.forEach((locationSnapshot) => {
                    totalHotels += locationSnapshot.child('hotels').numChildren();
                });
                document.getElementById('totalHotels').textContent = totalHotels;
            });

            // Load today's bookings (bookings CREATED today)
            const startOfDay = new Date();
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date();
            endOfDay.setHours(23, 59, 59, 999);

            db.ref('bookings')
                .orderByChild('createdAt')
                .startAt(startOfDay.getTime())
                .endAt(endOfDay.getTime())
                .once('value')
                .then((snapshot) => {
                document.getElementById('todayBookings').textContent = snapshot.numChildren();
            });

            // Load total users
            db.ref('users').on('value', (snapshot) => {
                document.getElementById('totalUsers').textContent = snapshot.numChildren();
            });

            // Load active deals
            db.ref('specialOffers').once('value').then((snapshot) => {
                document.getElementById('activeDeals').textContent = snapshot.numChildren();
            });

            // Load chart data v·ªõi delay ƒë·ªÉ tr√°nh conflict
            try {
                setTimeout(() => loadRevenueChart(), 100);
                setTimeout(() => loadBookingTypeChart(), 200);
                setTimeout(() => loadNewUsersChart(), 300);
                setTimeout(() => loadLocationChart(), 400);
            } catch (error) {
                console.error('L·ªói khi load charts:', error);
            }
        }

        // Load bookings data
        function loadBookings() {
            const bookingsRef = db.ref('bookings');
            bookingsRef.on('value', (snapshot) => {
                allBookings = [];
                snapshot.forEach((childSnapshot) => {
                    const booking = childSnapshot.val();
                    booking.id = childSnapshot.key;
                    allBookings.push(booking);
                });
                allBookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by most recent
                filterAndDisplayBookings(); 
            }, (error) => {
                console.error("Error loading bookings:", error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·∫∑t ph√≤ng.', 'error');
            });
        }
        
        function filterAndDisplayBookings() {
            let filteredBookings = [...allBookings];
            const searchContainer = document.getElementById('headerSearchContainer');

            if (searchContainer && searchContainer.style.display !== 'none') {
                 // 1. Search term filter
                const searchTerm = document.getElementById('globalSearchInput').value.toLowerCase().trim();
                if (searchTerm) {
                    filteredBookings = filteredBookings.filter(b => 
                        (b.id && b.id.toLowerCase().includes(searchTerm)) ||
                        (b.customerName && b.customerName.toLowerCase().includes(searchTerm)) ||
                        (b.customerEmail && b.customerEmail.toLowerCase().includes(searchTerm)) ||
                        (b.customerPhone && b.customerPhone.includes(searchTerm))
                    );
                }
            }

            // 2. Status filter
            const statusFilter = document.getElementById('bookingStatusFilter').value;
            if (statusFilter !== 'all') {
                filteredBookings = filteredBookings.filter(b => b.status === statusFilter);
            }

            // L·ªçc ch·ªâ booking kh√°ch s·∫°n, lo·∫°i b·ªè ho√†n to√†n booking tour
            filteredBookings = filteredBookings.filter(b => (!b.type && !b.bookingType) || b.type === 'hotel' || b.bookingType === 'hotel');
            
            renderBookingsTable(filteredBookings);
        }

        function renderBookingsTable(bookings) {
            const tableBody = document.getElementById('bookingsTable');
            tableBody.innerHTML = '';
            if (bookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" class="text-center py-5">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</td></tr>';
                return;
            }
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                // Status Badge
                const statusBadge = `<span class="status status-${booking.status || 'pending'}">${booking.status || 'Ch·ªù x√°c nh·∫≠n'}</span>`;
                // Service Details
                let serviceDetails = '';
                if (booking.type === 'hotel' || booking.roomId || booking.roomName) {
                    serviceDetails = `
                        <strong title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</strong><br>
                        <small class="text-muted" title="${booking.roomId || booking.roomName || ''}">${booking.roomId || booking.roomName || 'N/A'}</small>
                    `;
                } else if (booking.type === 'tour') {
                    serviceDetails = `
                        <strong title="${booking.tourName || ''}">${booking.tourName || 'Tour'}</strong><br>
                        <small class="text-muted">Tour</small>
                    `;
                } else {
                    serviceDetails = 'Kh√¥ng x√°c ƒë·ªãnh';
                }
                row.innerHTML = `
                    <td title="${booking.id}">${booking.id}</td>
                    <td title="${booking.customerName || ''}">${booking.customerName || 'N/A'}</td>
                    <td title="${booking.customerEmail || ''}">${booking.customerEmail || 'N/A'}</td>
                    <td title="${booking.customerPhone || ''}">${booking.customerPhone || 'N/A'}</td>
                    <td title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</td>
                    <td>${serviceDetails}</td>
                    <td title="${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : ''}">${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td title="${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : ''}">${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td title="${booking.guests || ''}">${booking.guests || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editBooking('${booking.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load users data
        function loadUsers() {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '<tr><td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('users').on('value', (snapshot) => {
                allUsers = []; // Reset
                if (snapshot.exists()) {
                    snapshot.forEach((userSnapshot) => {
                        const user = userSnapshot.val();
                        user.id = userSnapshot.key;
                        allUsers.push(user);
                    });
                }
                // Initial render after loading.
                filterAndDisplayUsers();
            }, (error) => {
                console.error('Error loading users:', error);
                usersTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
            });
        }
        
        function renderUsersTable(users) {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '';

            if (users.length === 0) {
                usersTable.innerHTML = '<tr><td colspan="10" class="text-center py-5">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ph√π h·ª£p.</td></tr>';
                return;
            }

            // Debug log ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
            console.log('Rendering users:', users);

            users.forEach(user => {
                const avatar = user.avatar ? `<img src="${user.avatar}" alt="avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : '<span class="avatar-placeholder" style="display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;background-color:#e9ecef;border-radius:50%;color:#6c757d;"><i class="fas fa-user"></i></span>';
                
                const birthday = user.birthday || user.birthdate || '';
                const formattedBirthday = birthday ? new Date(birthday).toLocaleDateString('vi-VN') : 'N/A';
                
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : (user.updatedAt ? new Date(user.updatedAt).toLocaleDateString('vi-VN') : 'N/A');
                
                const memberLevel = user.memberLevel || 'ƒê·ªìng';
                const loyaltyPoints = user.loyaltyPoints || 0;
                
                // Gi·ªõi t√≠nh v·ªõi icon
                const genderIcon = user.gender === 'Nam' ? '<i class="fas fa-mars text-info"></i>' : user.gender === 'N·ªØ' ? '<i class="fas fa-venus text-danger"></i>' : '<i class="fas fa-genderless text-muted"></i>';
                const genderDisplay = user.gender ? `${genderIcon} ${user.gender}` : 'N/A';
                
                // Tr·∫°ng th√°i t√†i kho·∫£n
                const status = user.status || 'active';
                const statusBadge = status === 'active' ? '<span class="badge bg-success">Ho·∫°t ƒë·ªông</span>' : 
                                   status === 'inactive' ? '<span class="badge bg-warning">T·∫°m kh√≥a</span>' :
                                   status === 'banned' ? '<span class="badge bg-danger">B·ªã c·∫•m</span>' :
                                   '<span class="badge bg-secondary">Kh√¥ng x√°c ƒë·ªãnh</span>';
                
                // Qu·ªëc t·ªãch v·ªõi c·ªù
                const nationality = user.nationality || 'Vi·ªát Nam';
                const flagIcon = nationality === 'Vi·ªát Nam' ? 'üáªüá≥' : 'üè≥Ô∏è';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${avatar}</td>
                    <td>
                        <div class="fw-bold">${user.name || 'N/A'}</div>
                        <small class="text-muted">
                            <i class="fas fa-crown text-warning"></i> ${memberLevel} 
                            <span class="badge bg-light text-dark ms-1">${loyaltyPoints} ƒëi·ªÉm</span>
                        </small>
                    </td>
                    <td>
                        <div>${user.email || 'N/A'}</div>
                        <small class="text-muted">
                            <i class="fas fa-phone text-success"></i> ${user.phone || 'N/A'}
                        </small>
                    </td>
                    <td>${genderDisplay}</td>
                    <td>
                        <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${user.address || 'N/A'}">
                            ${user.address || 'N/A'}
                        </div>
                    </td>
                    <td>${flagIcon} ${nationality}</td>
                    <td>${formattedBirthday}</td>
                    <td>
                        <div>${createdAt}</div>
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('vi-VN') : 'Ch∆∞a ƒëƒÉng nh·∫≠p'}
                        </small>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info" onclick="viewUser('${user.id}')" title="Xem chi ti·∫øt">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editUser('${user.id}')" title="Ch·ªânh s·ª≠a">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')" title="X√≥a">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm ${status === 'active' ? 'btn-secondary' : 'btn-success'}" onclick="toggleUserStatus('${user.id}', '${status}')" title="${status === 'active' ? 'Kh√≥a t√†i kho·∫£n' : 'K√≠ch ho·∫°t t√†i kho·∫£n'}">
                                <i class="fas ${status === 'active' ? 'fa-lock' : 'fa-unlock'}"></i>
                            </button>
                        </div>
                    </td>
                `;
                usersTable.appendChild(row);
            });
        }
        
        function filterAndDisplayUsers() {
            let filteredUsers = [...allUsers];
            
            // L·∫•y t·ª´ kh√≥a t√¨m ki·∫øm t·ª´ input ri√™ng cho users
            const searchTerm = (document.getElementById('userSearchInput') || {}).value ? 
                             document.getElementById('userSearchInput').value.toLowerCase().trim() : 
                             (document.getElementById('globalSearchInput') || {}).value ? 
                             document.getElementById('globalSearchInput').value.toLowerCase().trim() : '';

            // L·ªçc theo t·ª´ kh√≥a t√¨m ki·∫øm
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u =>
                    (u.name && u.name.toLowerCase().includes(searchTerm)) ||
                    (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                    (u.phone && u.phone.includes(searchTerm)) ||
                    (u.address && u.address.toLowerCase().includes(searchTerm)) ||
                    (u.nationality && u.nationality.toLowerCase().includes(searchTerm))
                );
            }
            
            // L·ªçc theo tr·∫°ng th√°i
            const statusFilter = (document.getElementById('userStatusFilter') || {}).value || 'all';
            if (statusFilter !== 'all') {
                filteredUsers = filteredUsers.filter(u => (u.status || 'active') === statusFilter);
            }
            
            renderUsersTable(filteredUsers);
        }

        // Load hotels data
        function loadHotels() {
            const hotelsGrid = document.getElementById('hotelsGrid');
            hotelsGrid.innerHTML = '<div class="col-12 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            db.ref('location').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    hotelsGrid.innerHTML = '<div class="col-12 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
                    return;
                }

                hotelsGrid.innerHTML = '';
                snapshot.forEach((locationSnapshot) => {
                    const hotels = locationSnapshot.child('hotels').val();
                    if (!hotels) return;

                    Object.entries(hotels).forEach(([hotelId, hotel]) => {
                        const hotelCard = document.createElement('div');
                        hotelCard.className = 'col-md-4 mb-4';
                        hotelCard.innerHTML = `
                            <div class="card h-100">
                                <img src="${hotel.chiTiet.image || 'images/default-hotel.jpg'}" class="card-img-top" alt="${hotel.tenKhachSan}">
                                <div class="card-body">
                                    <h5 class="card-title">${hotel.tenKhachSan}</h5>
                                    <p class="card-text">${(hotel.moTa || '').substring(0, 100)}...</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">${hotel.xepHangSao} sao</span>
                                        <div>
                                            <button class="btn btn-action btn-view" onclick="viewHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-action btn-edit" onclick="editHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-action btn-delete" onclick="deleteHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        hotelsGrid.appendChild(hotelCard);
                    });
                });
            }).catch(error => {
                console.error('Error loading hotels:', error);
                hotelsGrid.innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            });
        }

        // Load tours data
        function loadTours() {
            const toursAccordion = document.getElementById('toursAccordion');
            toursAccordion.innerHTML = '<div class="col-12 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            const tourCategoryNames = {
                amThucVaVanHoa: '·∫®m th·ª±c v√† VƒÉn h√≥a',
                hoatDongGanBan: 'Ho·∫°t ƒë·ªông g·∫ßn b·∫°n',
                traiNghiemDiaPhuong: 'Tr·∫£i nghi·ªám ƒë·ªãa ph∆∞∆°ng'
            };

            db.ref('specialTours').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    toursAccordion.innerHTML = '<div class="col-12 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
                    return;
                }

                toursAccordion.innerHTML = '';
                const allToursData = snapshot.val();

                Object.keys(tourCategoryNames).forEach((categoryKey, index) => {
                    const categoryName = tourCategoryNames[categoryKey];
                    const toursInCategory = allToursData[categoryKey];

                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';

                    let tourCardsHtml = '<div class="row">';
                    if (toursInCategory && typeof toursInCategory === 'object') {
                        Object.entries(toursInCategory).forEach(([tourId, tourData]) => {
                            tourCardsHtml += `
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100">
                                        <img src="${tourData.image || 'images/default-tour.jpg'}" class="card-img-top" alt="${tourData.name}">
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title">${tourData.name}</h5>
                                            <p class="card-text flex-grow-1">${(tourData.description || '').substring(0, 80)}...</p>
                                            <p class="tour-price mb-2"><b>Gi√°:</b> ${tourData.price ? tourData.price.toLocaleString('vi-VN') + ' ƒë' : 'Ch∆∞a c√≥'}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-primary">${tourData.duration}</span>
                                                <div>
                                                    <button class="btn btn-action btn-view" onclick="viewTour('${categoryKey}', '${tourId}')"><i class="fas fa-eye"></i></button>
                                                    <button class="btn btn-action btn-edit" onclick="editTour('${categoryKey}', '${tourId}')"><i class="fas fa-edit"></i></button>
                                                    <button class="btn btn-action btn-delete" onclick="deleteTour('${categoryKey}', '${tourId}')"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        tourCardsHtml += '<p class="text-muted col-12">Ch∆∞a c√≥ tour n√†o trong danh m·ª•c n√†y.</p>';
                    }
                    tourCardsHtml += '</div>'; // Close .row

                    accordionItem.innerHTML = `
                        <h2 class="accordion-header" id="heading-${categoryKey}">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${categoryKey}" aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse-${categoryKey}">
                                ${categoryName}
                            </button>
                        </h2>
                        <div id="collapse-${categoryKey}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading-${categoryKey}" data-bs-parent="#toursAccordion">
                            <div class="accordion-body">
                                ${tourCardsHtml}
                            </div>
                        </div>
                    `;

                    toursAccordion.appendChild(accordionItem);
                });

            }).catch(error => {
                console.error('Error loading tours:', error);
                toursAccordion.innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            });
        }

        // === VOUCHERS CRUD ===
        function loadVouchers() {
            const vouchersGrid = document.getElementById('vouchersGrid');
            vouchersGrid.innerHTML = '<div class="col-12 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            db.ref('vouchers').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    vouchersGrid.innerHTML = '<div class="col-12 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
                    return;
                }

                vouchersGrid.innerHTML = '';
                snapshot.forEach((voucherSnapshot) => {
                    const voucher = voucherSnapshot.val();
                    const voucherId = voucherSnapshot.key;
                    const voucherCard = document.createElement('div');
                    voucherCard.className = 'col-md-4 mb-4';
                    voucherCard.innerHTML = `
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${voucher.title || 'Voucher'}</h5>
                                <p class="card-text">${voucher.description || ''}</p>
                                <div>
                                    <span class="badge bg-success">${voucher.code || ''}</span>
                                    <span class="badge bg-info">${voucher.discount ? voucher.discount + '%' : ''}</span>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-action btn-edit" onclick="editVoucher('${voucherId}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-action btn-delete" onclick="deleteVoucher('${voucherId}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    vouchersGrid.appendChild(voucherCard);
                });
            }).catch(error => {
                vouchersGrid.innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            });
        }

        function addVoucher() {
            Swal.fire({
                title: 'Th√™m voucher m·ªõi',
                html: `
                    <form id="addVoucherForm" class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Ti√™u ƒë·ªÅ</label>
                            <input type="text" class="form-control" id="addVoucherTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√£ voucher</label>
                            <input type="text" class="form-control" id="addVoucherCode" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gi·∫£m gi√° (%)</label>
                            <input type="number" class="form-control" id="addVoucherDiscount" min="1" max="100" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√¥ t·∫£</label>
                            <textarea class="form-control" id="addVoucherDesc"></textarea>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const form = document.getElementById('addVoucherForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    return {
                        title: document.getElementById('addVoucherTitle').value,
                        code: document.getElementById('addVoucherCode').value,
                        discount: parseInt(document.getElementById('addVoucherDiscount').value, 10),
                        description: document.getElementById('addVoucherDesc').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newVoucher = result.value;
                    db.ref('vouchers').push(newVoucher).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Th√†nh c√¥ng!',
                            text: 'Voucher m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.',
                            timer: 1500
                        });
                        loadVouchers();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói!',
                            text: 'Kh√¥ng th·ªÉ th√™m voucher: ' + error.message
                        });
                    });
                }
            });
        }

        function editVoucher(voucherId) {
            db.ref('vouchers/' + voucherId).once('value').then((snapshot) => {
                const voucher = snapshot.val();
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a voucher',
                    html: `
                        <form id="editVoucherForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">Ti√™u ƒë·ªÅ</label>
                                <input type="text" class="form-control" id="editVoucherTitle" value="${voucher.title || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√£ voucher</label>
                                <input type="text" class="form-control" id="editVoucherCode" value="${voucher.code || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Gi·∫£m gi√° (%)</label>
                                <input type="number" class="form-control" id="editVoucherDiscount" value="${voucher.discount || ''}" min="1" max="100" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="editVoucherDesc">${voucher.description || ''}</textarea>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('editVoucherForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            title: document.getElementById('editVoucherTitle').value,
                            code: document.getElementById('editVoucherCode').value,
                            discount: parseInt(document.getElementById('editVoucherDiscount').value, 10),
                            description: document.getElementById('editVoucherDesc').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedVoucher = result.value;
                        db.ref('vouchers/' + voucherId).update(updatedVoucher).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Voucher ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                            loadVouchers();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t voucher: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteVoucher(voucherId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('vouchers/' + voucherId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'Voucher ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        loadVouchers();
                    });
                }
            });
        }

        // View booking details
        function viewBooking(bookingId) {
            db.ref('bookings/' + bookingId).once('value').then((snapshot) => {
                const booking = snapshot.val();
                Swal.fire({
                    title: 'Chi ti·∫øt ƒë·∫∑t ph√≤ng',
                    html: `
                        <div class="text-start">
                            <p><strong>Kh√°ch h√†ng:</strong> ${booking.name}</p>
                            <p><strong>Email:</strong> ${booking.email}</p>
                            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${booking.phone}</p>
                            <p><strong>Kh√°ch s·∫°n:</strong> ${booking.hotelId}</p>
                            <p><strong>Ph√≤ng:</strong> ${booking.roomId}</p>
                            <p><strong>Check-in:</strong> ${booking.checkIn}</p>
                            <p><strong>Check-out:</strong> ${booking.checkOut}</p>
                            <p><strong>S·ªë kh√°ch:</strong> ${booking.guests}</p>
                        </div>
                    `,
                    width: '600px'
                });
            });
        }

        // Edit booking
        function editBooking(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ƒë·∫∑t ph√≤ng n√†y.', 'error');
                return;
            }
            // Danh s√°ch c√°c tr∆∞·ªùng h·ª£p l·ªá theo rule
            const allowedFields = [
                'bookingType', 'checkIn', 'checkOut', 'createdAt', 'customerEmail', 'customerName', 'customerPhone', 'email',
                'guests', 'hotelId', 'hotelName', 'nights', 'note', 'paymentMethod', 'paymentStatus', 'roomId', 'roomName',
                'roomPrice', 'status', 'totalPrice', 'updatedAt', 'userId',
                // C√°c tr∆∞·ªùng cho tour
                'numberOfGuests', 'tourId', 'tourName', 'tourCategory', 'tourLocation', 'tourDuration', 'tourImage', 'tourType',
                'tourPrice', 'tourDescription', 'tourIncludes', 'tourExcludes', 'tourRating', 'tourReviewsCount'
            ];
            // N·∫øu l√† booking tour
            if (booking.type === 'tour' || booking.bookingType === 'tour') {
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin ƒë·∫∑t tour',
                    html: `
                        <input id="edit-tourName" class="swal2-input" placeholder="T√™n tour" value="${booking.tourName || ''}">
                        <input id="edit-tourLocation" class="swal2-input" placeholder="ƒêi·ªÉm ƒë·∫øn" value="${booking.tourLocation || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="${booking.numberOfGuests || booking.guests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${booking.customerPhone || ''}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        return {
                            tourName: document.getElementById('edit-tourName').value,
                            tourLocation: document.getElementById('edit-tourLocation').value,
                            checkIn: document.getElementById('edit-checkIn').value,
                            numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value),
                            customerName: document.getElementById('edit-customerName').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // L·ªçc d·ªØ li·ªáu c≈© ch·ªâ l·∫•y c√°c tr∆∞·ªùng h·ª£p l·ªá
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // G·ªôp v·ªõi d·ªØ li·ªáu m·ªõi
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('D·ªØ li·ªáu g·ª≠i l√™n Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                            loadBookingsTours();
                            loadBookings(); // ƒê·ªÉ ƒë·ªìng b·ªô n·∫øu c√≥ thay ƒë·ªïi
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        });
                    }
                });
            } else {
                // Booking kh√°ch s·∫°n gi·ªØ nh∆∞ c≈©
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin ƒë·∫∑t ph√≤ng',
                    html: `
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerEmail" class="swal2-input" placeholder="Email" value="${booking.customerEmail || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${booking.customerPhone || ''}">
                        <input id="edit-hotelName" class="swal2-input" placeholder="Kh√°ch s·∫°n" value="${booking.hotelName || ''}">
                        <input id="edit-roomId" class="swal2-input" placeholder="Ph√≤ng" value="${booking.roomId || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-checkOut" class="swal2-input" type="date" value="${booking.checkOut ? booking.checkOut.split('T')[0] : ''}">
                        <input id="edit-guests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="${booking.guests || 1}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const roomIdValue = document.getElementById('edit-roomId').value;
                        return {
                            customerName: document.getElementById('edit-customerName').value,
                            customerEmail: document.getElementById('edit-customerEmail').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            hotelName: document.getElementById('edit-hotelName').value,
                            roomId: roomIdValue,
                            roomName: roomIdValue,
                            checkIn: document.getElementById('edit-checkIn').value,
                            checkOut: document.getElementById('edit-checkOut').value,
                            guests: parseInt(document.getElementById('edit-guests').value),
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // L·ªçc d·ªØ li·ªáu c≈© ch·ªâ l·∫•y c√°c tr∆∞·ªùng h·ª£p l·ªá
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // G·ªôp v·ªõi d·ªØ li·ªáu m·ªõi
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('D·ªØ li·ªáu g·ª≠i l√™n Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        });
                    }
                });
            }
        }

        // Delete booking
        function deleteBooking(bookingId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: "B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('bookings/' + bookingId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'ƒê·∫∑t ph√≤ng ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        generateNotification('fas fa-trash', 'bg-danger', `ƒê√£ x√≥a ƒë·∫∑t ph√≤ng #${bookingId.substring(0, 6)}...`);
                        loadBookings();
                    });
                }
            });
        }

        // Revenue Chart
        function loadRevenueChart() {
            try {
                // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                    revenueChartInstance = null;
                }

                const canvas = document.getElementById('revenueChart');
                if (!canvas) {
                    console.warn('Canvas revenueChart kh√¥ng t·ªìn t·∫°i');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas revenueChart');
                    return;
                }

                db.ref('bookings').once('value').then(snapshot => {
                    const monthlyRevenue = Array(12).fill(0);
                    const monthLabels = [];
                    const now = new Date();

                    for (let i = 11; i >= 0; i--) {
                        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        monthLabels.push(`T${d.getMonth() + 1}/${d.getFullYear().toString().slice(-2)}`);
                    }

                    if (snapshot.exists()) {
                        snapshot.forEach(bookingSnapshot => {
                            const booking = bookingSnapshot.val();
                            // S·ª≠a logic: T√≠nh doanh thu cho c·∫£ ƒë∆°n "confirmed" v√† "completed"
                            if ((booking.status === 'completed' || booking.status === 'confirmed') && typeof booking.totalPrice === 'number' && booking.createdAt) {
                                const date = new Date(booking.createdAt);
                                const monthDiff = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());
                                if (monthDiff >= 0 && monthDiff < 12) {
                                    monthlyRevenue[11 - monthDiff] += booking.totalPrice;
                                }
                            }
                        });
                    }
                    const revenueInMillions = monthlyRevenue.map(r => (r / 1000000).toFixed(2));

                    // Ki·ªÉm tra l·∫°i canvas tr∆∞·ªõc khi t·∫°o chart m·ªõi
                    if (canvas && !revenueChartInstance) {
                        revenueChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Doanh thu (tri·ªáu VNƒê)',
                                    data: revenueInMillions,
                                    borderColor: '#1a237e',
                                    backgroundColor: 'rgba(26, 35, 126, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Doanh thu theo th√°ng (12 th√°ng g·∫ßn nh·∫•t)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function (value) {
                                                return value + 'tr';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('L·ªói khi load revenue chart:', error);
                });
            } catch (error) {
                console.error('L·ªói trong loadRevenueChart:', error);
            }
        }

        // Booking Type Chart
        function loadBookingTypeChart() {
            try {
                // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
                if (bookingTypeChartInstance) {
                    bookingTypeChartInstance.destroy();
                    bookingTypeChartInstance = null;
                }

                const canvas = document.getElementById('bookingTypeChart');
                if (!canvas) {
                    console.warn('Canvas bookingTypeChart kh√¥ng t·ªìn t·∫°i');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas bookingTypeChart');
                    return;
                }

                db.ref('bookings').once('value').then(snapshot => {
                    let hotelCount = 0;
                    let tourCount = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(bookingSnapshot => {
                            const booking = bookingSnapshot.val();
                            if (booking.bookingType === 'hotel') {
                                hotelCount++;
                            } else if (booking.bookingType === 'tour') {
                                tourCount++;
                            }
                        });
                    }

                    // Ki·ªÉm tra l·∫°i canvas tr∆∞·ªõc khi t·∫°o chart m·ªõi
                    if (canvas && !bookingTypeChartInstance) {
                        bookingTypeChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['ƒê·∫∑t ph√≤ng kh√°ch s·∫°n', 'ƒê·∫∑t tour'],
                                datasets: [{
                                    data: [hotelCount, tourCount],
                                    backgroundColor: [
                                        '#1a237e',
                                        '#1976d2'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'T·ª∑ l·ªá lo·∫°i h√¨nh ƒë·∫∑t ph√≤ng'
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('L·ªói khi load booking type chart:', error);
                });
            } catch (error) {
                console.error('L·ªói trong loadBookingTypeChart:', error);
            }
        }

        // New Users Chart
        function loadNewUsersChart() {
            try {
                // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
                if (newUsersChartInstance) {
                    newUsersChartInstance.destroy();
                    newUsersChartInstance = null;
                }

                const canvas = document.getElementById('newUsersChart');
                if (!canvas) {
                    console.warn('Canvas newUsersChart kh√¥ng t·ªìn t·∫°i');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas newUsersChart');
                    return;
                }

                const weekLabels = ['6 tu·∫ßn tr∆∞·ªõc', '5 tu·∫ßn tr∆∞·ªõc', '4 tu·∫ßn tr∆∞·ªõc', '3 tu·∫ßn tr∆∞·ªõc', '2 tu·∫ßn tr∆∞·ªõc', 'Tu·∫ßn tr∆∞·ªõc', 'Tu·∫ßn n√†y'];
                const weeklyNewUsers = Array(7).fill(0);
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

                db.ref('users').orderByChild('createdAt').startAt(todayStart - 6 * 7 * 24 * 3600 * 1000).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(userSnapshot => {
                            const user = userSnapshot.val();
                            if (user.createdAt) {
                                const joinDate = new Date(user.createdAt);
                                const weeksAgo = Math.floor((todayStart - joinDate.getTime()) / (7 * 24 * 3600 * 1000));
                                if (weeksAgo >= 0 && weeksAgo < 7) {
                                    weeklyNewUsers[6 - weeksAgo]++;
                                }
                            }
                        });
                    }

                    // Ki·ªÉm tra l·∫°i canvas tr∆∞·ªõc khi t·∫°o chart m·ªõi
                    if (canvas && !newUsersChartInstance) {
                        newUsersChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: weekLabels,
                                datasets: [{
                                    label: 'Ng∆∞·ªùi d√πng m·ªõi',
                                    data: weeklyNewUsers,
                                    backgroundColor: '#2e7d32'
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false,
                                    },
                                    title: {
                                        display: true,
                                        text: 'Ng∆∞·ªùi d√πng m·ªõi (7 tu·∫ßn g·∫ßn nh·∫•t)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('L·ªói khi load new users chart:', error);
                });
            } catch (error) {
                console.error('L·ªói trong loadNewUsersChart:', error);
            }
        }

        // Location Chart (Number of hotels per location)
        function loadLocationChart() {
            try {
                // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
                if (locationChartInstance) {
                    locationChartInstance.destroy();
                    locationChartInstance = null;
                }

                const canvas = document.getElementById('locationChart');
                if (!canvas) {
                    console.warn('Canvas locationChart kh√¥ng t·ªìn t·∫°i');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas');
                    return;
                }

                db.ref('location').once('value').then(snapshot => {
                    const locationLabels = [];
                    const hotelCounts = [];
                    // B·∫£ng m√†u m·ªõi, c√≥ ƒë·ªô t∆∞∆°ng ph·∫£n cao ƒë·ªÉ d·ªÖ ph√¢n bi·ªát
                    const backgroundColors = [
                        '#3366CC', '#DC3912', '#FF9900', '#109618', '#990099',
                        '#0099C6', '#DD4477', '#66AA00', '#B82E2E', '#316395'
                    ];
                    let colorIndex = 0;

                    if (snapshot.exists()) {
                        snapshot.forEach(locationSnapshot => {
                            const locationKey = locationSnapshot.key;
                            const locationName = locationKey.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                            const hotels = locationSnapshot.child('hotels').val();
                            const count = hotels ? Object.keys(hotels).length : 0;
                            if (count > 0) {
                                locationLabels.push(locationName);
                                hotelCounts.push(count);
                            }
                        });
                    }

                    // Ki·ªÉm tra l·∫°i canvas tr∆∞·ªõc khi t·∫°o chart m·ªõi
                    if (canvas && !locationChartInstance) {
                        locationChartInstance = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: locationLabels,
                                datasets: [{
                                    data: hotelCounts,
                                    backgroundColor: locationLabels.map(() => backgroundColors[colorIndex++ % backgroundColors.length])
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Ph√¢n b·ªï kh√°ch s·∫°n theo khu v·ª±c'
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('L·ªói khi load location chart:', error);
                });
            } catch (error) {
                console.error('L·ªói trong loadLocationChart:', error);
            }
        }

        // Th√™m ƒë·∫∑t ph√≤ng m·ªõi
        function addBooking() {
            // L·∫•y danh s√°ch kh√°ch s·∫°n
            db.ref('location').once('value').then(snapshot => {
                let hotelOptions = '';
                let hotelsData = [];
                snapshot.forEach(locationSnap => {
                    const location = locationSnap.val();
                    if (location.hotels) {
                        Object.entries(location.hotels).forEach(([hotelKey, hotel]) => {
                            hotelsData.push({
                                id: hotelKey,
                                name: hotel.tenKhachSan,
                                rooms: hotel.chiTiet && hotel.chiTiet.rooms ? hotel.chiTiet.rooms : [],
                                locationId: locationSnap.key
                            });
                            hotelOptions += `<option value="${locationSnap.key}__${hotelKey}">${hotel.tenKhachSan}</option>`;
                        });
                    }
                });
                Swal.fire({
                    title: 'Th√™m ƒë·∫∑t ph√≤ng m·ªõi',
                    html: `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <input id="add-customerName" class="swal2-input" placeholder="T√™n kh√°ch">
                            <input id="add-customerEmail" class="swal2-input" placeholder="Email">
                            <input id="add-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                            <select id="add-hotelSelect" class="swal2-input" style="width: 100%"><option value="">Ch·ªçn kh√°ch s·∫°n</option>${hotelOptions}</select>
                            <select id="add-roomSelect" class="swal2-input" style="width: 100%" disabled><option value="">Ch·ªçn ph√≤ng</option></select>
                            <input id="add-checkIn" class="swal2-input" type="date">
                            <input id="add-checkOut" class="swal2-input" type="date">
                            <input id="add-guests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="1">
                            <select id="add-status" class="swal2-input" style="width: 100%">
                                <option value="pending">Ch·ªù x√°c nh·∫≠n</option>
                                <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                                <option value="cancelled">ƒê√£ h·ªßy</option>
                                <option value="completed">Ho√†n th√†nh</option>
                            </select>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    didOpen: () => {
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const roomSelect = document.getElementById('add-roomSelect');
                        hotelSelect.addEventListener('change', function() {
                            const value = this.value;
                            roomSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng</option>';
                            roomSelect.disabled = true;
                            if (!value) return;
                            const [locationId, hotelKey] = value.split('__');
                            const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                            if (hotel && Array.isArray(hotel.rooms)) {
                                hotel.rooms.forEach(room => {
                                    if (room && room.name) {
                                        const option = document.createElement('option');
                                        option.value = room.name;
                                        option.textContent = room.name;
                                        roomSelect.appendChild(option);
                                    }
                                });
                                roomSelect.disabled = false;
                            }
                        });
                    },
                    preConfirm: () => {
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const roomSelect = document.getElementById('add-roomSelect');
                        const hotelValue = hotelSelect.value;
                        const [locationId, hotelKey] = hotelValue.split('__');
                        const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                        return {
                            userId: 'admin-created', // Admin t·∫°o booking cho kh√°ch
                            customerName: document.getElementById('add-customerName').value,
                            customerEmail: document.getElementById('add-customerEmail').value,
                            customerPhone: document.getElementById('add-customerPhone').value,
                            hotelName: hotel ? hotel.name : '',
                            roomId: roomSelect.value,
                            roomName: roomSelect.value,
                            checkIn: document.getElementById('add-checkIn').value,
                            checkOut: document.getElementById('add-checkOut').value,
                            guests: parseInt(document.getElementById('add-guests').value),
                            status: document.getElementById('add-status').value,
                            type: 'hotel',
                            bookingType: 'hotel',
                            createdAt: new Date().toISOString()
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        db.ref('bookings').push(result.value).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m ƒë·∫∑t ph√≤ng m·ªõi!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ th√™m ƒë·∫∑t ph√≤ng.', 'error');
                        });
                    }
                });
            });
        }

        // Load danh s√°ch kh√°ch s·∫°n v√† ph√≤ng
        function loadHotelsAndRooms() {
            const hotelSelect = document.getElementById('newHotelId');
            const roomSelect = document.getElementById('newRoomId');
            if (!hotelSelect || !roomSelect) return;

            db.ref('location').once('value').then((snapshot) => {
                hotelSelect.innerHTML = '<option value="">Ch·ªçn kh√°ch s·∫°n</option>';
                snapshot.forEach((locationSnapshot) => {
                    const location = locationSnapshot.val();
                    location.hotels.forEach((hotel, index) => {
                        const option = document.createElement('option');
                        option.value = `${locationSnapshot.key}_${index}`;
                        option.textContent = hotel.tenKhachSan;
                        hotelSelect.appendChild(option);
                    });
                });
            });

            // C·∫≠p nh·∫≠t danh s√°ch ph√≤ng khi ch·ªçn kh√°ch s·∫°n
            hotelSelect.addEventListener('change', (e) => {
                const [locationId, hotelIndex] = e.target.value.split('_');
                if (!locationId || !hotelIndex) {
                    roomSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng</option>';
                    return;
                }

                db.ref(`location/${locationId}/hotels/${hotelIndex}/chiTiet/rooms`).once('value').then((snapshot) => {
                    roomSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng</option>';
                    const rooms = snapshot.val();
                    console.log('Rooms data:', rooms); // Th√™m d√≤ng n√†y ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu

                    let found = false;
                    if (Array.isArray(rooms)) {
                        rooms.forEach((room, idx) => {
                            if (room) {
                                found = true;
                                const option = document.createElement('option');
                                option.value = idx;
                                option.textContent = `${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}ƒë`;
                                roomSelect.appendChild(option);
                            }
                        });
                    } else if (rooms && typeof rooms === 'object') {
                        Object.entries(rooms).forEach(([key, room]) => {
                            if (room) {
                                found = true;
                                const option = document.createElement('option');
                                option.value = key;
                                option.textContent = `${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}ƒë`;
                                roomSelect.appendChild(option);
                            }
                        });
                    }
                    if (!found) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Kh√¥ng c√≥ ph√≤ng n√†o';
                        roomSelect.appendChild(option);
                    }
                });
            });
        }

        // H√†m helper ƒë·ªÉ l·∫•y class cho badge tr·∫°ng th√°i
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning';
                case 'confirmed': return 'bg-success';
                case 'cancelled': return 'bg-danger';
                case 'completed': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        // H√†m helper ƒë·ªÉ l·∫•y text tr·∫°ng th√°i
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'Ch·ªù x√°c nh·∫≠n';
                case 'confirmed': return 'ƒê√£ x√°c nh·∫≠n';
                case 'cancelled': return 'ƒê√£ h·ªßy';
                case 'completed': return 'Ho√†n th√†nh';
                default: return 'Kh√¥ng x√°c ƒë·ªãnh';
            }
        }

        function handleGlobalSearch() {
            const activeSection = document.querySelector('.content-section:not([style*="display: none"])');
            if (!activeSection) return;

            const sectionId = activeSection.id;
            switch (sectionId) {
                case 'bookings':
                    filterAndDisplayBookings();
                    break;
                case 'users':
                    filterAndDisplayUsers();
                    break;
                // Add cases for other sections here in the future
                // case 'hotels':
                //     filterAndDisplayHotels();
                //     break;
            }
        }

        // Destroy all charts
        function destroyAllCharts() {
            try {
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                    revenueChartInstance = null;
                }
                if (bookingTypeChartInstance) {
                    bookingTypeChartInstance.destroy();
                    bookingTypeChartInstance = null;
                }
                if (newUsersChartInstance) {
                    newUsersChartInstance.destroy();
                    newUsersChartInstance = null;
                }
                if (locationChartInstance) {
                    locationChartInstance.destroy();
                    locationChartInstance = null;
                }
            } catch (error) {
                console.error('L·ªói khi destroy charts:', error);
            }
        }

        // Update showContent function to load data when switching sections
        function showContent(contentId) {
            // Destroy all charts before switching sections
            destroyAllCharts();
            
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected content
            document.getElementById(contentId).style.display = 'block';

            // Update active menu item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[href="#${contentId}"]`).classList.add('active');

            // Update page title
            const pageTitle = document.querySelector(`[href="#${contentId}"]`).textContent.trim();
            document.getElementById('page-title-header').textContent = pageTitle;


            // Handle search bar visibility and placeholder
            const searchContainer = document.getElementById('headerSearchContainer');
            const searchInput = document.getElementById('globalSearchInput');
            
            const searchableSections = {
                'bookings': 'T√¨m theo ID, T√™n, Email, SƒêT...',
                'users': 'T√¨m theo T√™n, Email, SƒêT...',
                'hotels': 'T√¨m theo t√™n kh√°ch s·∫°n...',
                'tours': 'T√¨m theo t√™n tour...',
                'deals': 'T√¨m theo ti√™u ƒë·ªÅ ∆∞u ƒë√£i...',
                'travel-guides': 'T√¨m theo ti√™u ƒë·ªÅ b√†i vi·∫øt...',
                'contributions': 'T√¨m theo ti√™u ƒë·ªÅ, t√°c gi·∫£, ƒë·ªãa ƒëi·ªÉm...'
            };

            if (searchableSections[contentId]) {
                searchContainer.style.display = 'flex';
                searchInput.placeholder = searchableSections[contentId];
            } else {
                searchContainer.style.display = 'none';
            }
            searchInput.value = ''; // Clear search on tab switch


            // Load data for the selected section
            switch (contentId) {
                case 'dashboard':
                    loadStatistics();
                    break;
                case 'bookings':
                    loadBookings();
                    break;
                case 'bookings-tours':
                    loadBookingsTours();
                    break;
                case 'hotels':
                    loadHotels();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'tours':
                    loadTours();
                    break;
                case 'vouchers':
                    loadVouchers();
                    break;
                case 'deals':
                    loadDeals();
                    break;
                case 'travel-guides':
                    loadTravelGuides();
                    break;
                case 'contributions':
                    loadContributions();
                    break;
                case 'refunds':
                    loadRefunds();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                // Add more cases for other sections
            }

        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p khi trang ƒë∆∞·ª£c t·∫£i
            checkAuth();

            // Th√™m s·ª± ki·ªán click cho n√∫t ƒëƒÉng xu·∫•t
            const logoutBtn = document.querySelector('.btn-danger.w-100');
            if (logoutBtn && logoutBtn.onclick === null) { // Add listener only if no onclick is present
                logoutBtn.addEventListener('click', logout);
            }

            // Add click event listeners to menu items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const contentId = item.getAttribute('href').substring(1);
                    showContent(contentId);
                });
            });

            // Add event listener for settings form
            const settingsForm = document.getElementById('settingsForm');
            if (settingsForm) {
                settingsForm.addEventListener('submit', saveSettings);
            }
            
            // Add event listener for booking status filter
            const bookingStatusFilter = document.getElementById('bookingStatusFilter');
            if(bookingStatusFilter) {
                bookingStatusFilter.addEventListener('change', filterAndDisplayBookings);
            }

            // Add event listener for mobile toggle
            const mobileToggle = document.getElementById('mobile-toggle');
            if(mobileToggle) {
                mobileToggle.addEventListener('click', toggleSidebar);
            }

            // Show dashboard by default
            showContent('dashboard');

            // Load pending contributions count for sidebar badge
            loadPendingContributionsCount();

             // Initialize global search
            const globalSearchInput = document.getElementById('globalSearchInput');
            if(globalSearchInput) {
                globalSearchInput.addEventListener('input', handleGlobalSearch);
            }

            // Initialize notifications
            const notifBell = document.getElementById('notificationBell');
            const notifDropdown = document.getElementById('notificationDropdown');
            const markAllReadBtn = document.getElementById('markAllAsReadBtn');

            if(notifBell && notifDropdown) {
                notifBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notifDropdown.classList.toggle('show');
                    // Mark as read when opening
                    if (notifDropdown.classList.contains('show')) {
                        markNotificationsAsRead();
                    }
                });

                markAllReadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    markNotificationsAsRead();
                });

                document.addEventListener('click', (e) => {
                    if (!notifDropdown.contains(e.target) && !notifBell.contains(e.target)) {
                        notifDropdown.classList.remove('show');
                    }
                });
            }
            
            loadNotifications();

            // Set th√°ng/nƒÉm m·∫∑c ƒë·ªãnh l√† hi·ªán t·∫°i
            const now = new Date();
            document.getElementById('stat-month').value = (now.getMonth() + 1).toString();
            document.getElementById('stat-year').value = now.getFullYear();
            updateMonthlyStatsUI();
        });

        // Xem chi ti·∫øt kh√°ch s·∫°n
        function viewHotel(locationId, hotelId) {
            db.ref(`location/${locationId}/hotels/${hotelId}`).once('value').then((snapshot) => {
                const hotel = snapshot.val();
                if (!hotel) return;

                const chiTiet = hotel.chiTiet || {};
                const rooms = chiTiet.rooms || {};
                let roomList = '<li>Kh√¥ng c√≥ ph√≤ng n√†o</li>';
                if(Object.keys(rooms).length > 0){
                    roomList = Object.values(rooms).map(room => `<li>${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}ƒë</li>`).join('');
                }

                Swal.fire({
                    title: hotel.tenKhachSan,
                    html: `
                        <img src="${chiTiet.image || 'images/default-hotel.jpg'}" alt="H√¨nh ·∫£nh kh√°ch s·∫°n" class="img-fluid mb-3" style="max-height:200px;">
                        <p><strong>M√¥ t·∫£:</strong> ${hotel.moTa || ''}</p>
                        <p><strong>X·∫øp h·∫°ng sao:</strong> ${hotel.xepHangSao || ''}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${hotel.diaChi || ''}</p>
                        <p><strong>ƒêi·ªán tho·∫°i:</strong> ${hotel.phone || ''}</p>
                        <p><strong>Ph√≠ d·ªãch v·ª•:</strong> ${hotel.serviceFee ? hotel.serviceFee.toLocaleString('vi-VN') + ' ƒë' : ''}</p>
                        <p><strong>Ti·ªán nghi:</strong> ${(chiTiet.facilities || []).join(', ')}</p>
                        <p><strong>Danh s√°ch ph√≤ng:</strong></p>
                        <ul>${roomList}</ul>
                    `,
                    width: '700px'
                });
            });
        }

        function editHotel(locationId, hotelId) {
            db.ref(`location/${locationId}/hotels/${hotelId}`).once('value').then((snapshot) => {
                const hotel = snapshot.val();
                 if (!hotel) {
                     Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y kh√°ch s·∫°n!', 'error');
                     return;
                 }
                const chiTiet = hotel.chiTiet || {};
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a kh√°ch s·∫°n',
                    html: `
                        <form id="editHotelForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">T√™n kh√°ch s·∫°n</label>
                                <input type="text" class="form-control" id="editHotelName" value="${hotel.tenKhachSan || ''}" required>
                            </div>
                             <div class="mb-3">
                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <input type="text" class="form-control" id="editHotelAddress" value="${hotel.diaChi || ''}" required>
                            </div>
                             <div class="mb-3">
                                <label class="form-label">ƒêi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="editHotelPhone" value="${hotel.phone || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="editHotelDesc">${hotel.moTa || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">H√¨nh ·∫£nh (URL)</label>
                                <input type="text" class="form-control" id="editHotelImage" value="${chiTiet.image || ''}">
                            </div>
                             <div class="mb-3">
                                <label class="form-label">Ph√≠ d·ªãch v·ª•</label>
                                <input type="number" class="form-control" id="editHotelServiceFee" value="${hotel.serviceFee || 0}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">X·∫øp h·∫°ng sao</label>
                                <input type="number" class="form-control" id="editHotelStar" value="${hotel.xepHangSao || ''}" min="1" max="5">
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('editHotelForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            tenKhachSan: document.getElementById('editHotelName').value,
                            diaChi: document.getElementById('editHotelAddress').value,
                            phone: document.getElementById('editHotelPhone').value,
                            moTa: document.getElementById('editHotelDesc').value,
                            serviceFee: parseInt(document.getElementById('editHotelServiceFee').value, 10),
                            xepHangSao: parseInt(document.getElementById('editHotelStar').value, 10),
                            'chiTiet/image': document.getElementById('editHotelImage').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedHotel = result.value;
                        db.ref(`location/${locationId}/hotels/${hotelId}`).update(updatedHotel).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Kh√°ch s·∫°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                             generateNotification('fas fa-hotel', 'bg-info', `ƒê√£ c·∫≠p nh·∫≠t kh√°ch s·∫°n ${updatedHotel.tenKhachSan}.`);
                            loadHotels();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t kh√°ch s·∫°n: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteHotel(locationId, hotelId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`location/${locationId}/hotels/${hotelId}`).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'Kh√°ch s·∫°n ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        generateNotification('fas fa-trash', 'bg-danger', `ƒê√£ x√≥a m·ªôt kh√°ch s·∫°n.`);
                        loadHotels();
                    }).catch(error => {
                        Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a kh√°ch s·∫°n: ' + error.message, 'error');
                    });
                }
            });
        }

        // Th√™m kh√°ch s·∫°n m·ªõi
        function addHotel() {
            db.ref('location').once('value').then((snapshot) => {
                const locations = [];
                snapshot.forEach((locationSnapshot) => {
                    locations.push(locationSnapshot.key);
                });
                Swal.fire({
                    title: 'Th√™m kh√°ch s·∫°n m·ªõi',
                    html: `
                        <form id="addHotelForm" class="text-start">
                             <div class="mb-3">
                                <label class="form-label">T·ªânh/Th√†nh ph·ªë</label>
                                <select class="form-control" id="addHotelLocation" required>
                                    <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
                                    ${locations.map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">T√™n kh√°ch s·∫°n</label>
                                <input type="text" class="form-control" id="addHotelName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <input type="text" class="form-control" id="addHotelAddress" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒêi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="addHotelPhone" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="addHotelDesc" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">H√¨nh ·∫£nh (URL)</label>
                                <input type="text" class="form-control" id="addHotelImage" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ph√≠ d·ªãch v·ª• (VNƒê)</label>
                                <input type="number" class="form-control" id="addHotelServiceFee" value="0" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">X·∫øp h·∫°ng sao</label>
                                <input type="number" class="form-control" id="addHotelStar" value="3" min="1" max="5" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ti·ªán nghi (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                                <input type="text" class="form-control" id="addHotelFacilities" required>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Th√™m m·ªõi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('addHotelForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        const location = document.getElementById('addHotelLocation').value;
                        if (!location) {
                           Swal.showValidationMessage('Vui l√≤ng ch·ªçn T·ªânh/Th√†nh ph·ªë');
                           return false;
                        }
                        return {
                            location: location,
                            tenKhachSan: document.getElementById('addHotelName').value,
                            diaChi: document.getElementById('addHotelAddress').value,
                            phone: document.getElementById('addHotelPhone').value,
                            moTa: document.getElementById('addHotelDesc').value,
                            location: location,
                            tenKhachSan: document.getElementById('addHotelName').value,
                            diaChi: document.getElementById('addHotelAddress').value,
                            phone: document.getElementById('addHotelPhone').value,
                            moTa: document.getElementById('addHotelDesc').value,
                            serviceFee: parseInt(document.getElementById('addHotelServiceFee').value, 10),
                            xepHangSao: parseInt(document.getElementById('addHotelStar').value, 10),
                            chiTiet: {
                                image: document.getElementById('addHotelImage').value,
                                facilities: document.getElementById('addHotelFacilities').value.split(',').map(f => f.trim()),
                                rooms: {} // Kh·ªüi t·∫°o v·ªõi danh s√°ch ph√≤ng r·ªóng
                            }
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const data = result.value;
                        const location = data.location;
                        // X√≥a location kh·ªèi object tr∆∞·ªõc khi push
                        delete data.location;

                        db.ref(`location/${location}/hotels`).push(data).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Kh√°ch s·∫°n m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.',
                                timer: 1500
                            });
                            generateNotification('fas fa-plus', 'bg-success', `ƒê√£ th√™m kh√°ch s·∫°n m·ªõi: ${data.tenKhachSan}`);
                            loadHotels();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ th√™m kh√°ch s·∫°n: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function viewUser(userId) {
            db.ref('users/' + userId).once('value').then((snapshot) => {
                const user = snapshot.val();
                const memberLevel = user.memberLevel || 'ƒê·ªìng';
                const loyaltyPoints = user.loyaltyPoints || 0;
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                const updatedAt = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString('vi-VN') : 'N/A';
                
                Swal.fire({
                    title: user.name || 'Th√¥ng tin ng∆∞·ªùi d√πng',
                    html: `
                        <div class="text-start">
                            <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${user.phone || 'N/A'}</p>
                            <p><strong>ƒê·ªãa ch·ªâ:</strong> ${user.address || 'N/A'}</p>
                            <p><strong>C·∫•p ƒë·ªô th√†nh vi√™n:</strong> <span class="badge bg-primary">${memberLevel}</span></p>
                            <p><strong>ƒêi·ªÉm t√≠ch l≈©y:</strong> <span class="badge bg-success">${loyaltyPoints} ƒëi·ªÉm</span></p>
                            <p><strong>Ng√†y tham gia:</strong> ${createdAt}</p>
                            <p><strong>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</strong> ${updatedAt}</p>
                        </div>
                    `,
                    width: '600px'
                });
            });
        }

        function editUser(userId) {
            db.ref('users/' + userId).once('value').then((snapshot) => {
                const user = snapshot.val();
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng',
                    html: `
                        <form id="editUserForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">T√™n</label>
                                <input type="text" class="form-control" id="editUserName" value="${user.name || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="editUserEmail" value="${user.email || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="editUserPhone" value="${user.phone || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <input type="text" class="form-control" id="editUserAddress" value="${user.address || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">C·∫•p ƒë·ªô th√†nh vi√™n</label>
                                <select class="form-control" id="editUserMemberLevel">
                                    <option value="ƒê·ªìng" ${user.memberLevel === 'ƒê·ªìng' ? 'selected' : ''}>ƒê·ªìng</option>
                                    <option value="B·∫°c" ${user.memberLevel === 'B·∫°c' ? 'selected' : ''}>B·∫°c</option>
                                    <option value="V√†ng" ${user.memberLevel === 'V√†ng' ? 'selected' : ''}>V√†ng</option>
                                    <option value="Kim c∆∞∆°ng" ${user.memberLevel === 'Kim c∆∞∆°ng' ? 'selected' : ''}>Kim c∆∞∆°ng</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒêi·ªÉm t√≠ch l≈©y</label>
                                <input type="number" class="form-control" id="editUserLoyaltyPoints" value="${user.loyaltyPoints || 0}" min="0">
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('editUserForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            name: document.getElementById('editUserName').value,
                            email: document.getElementById('editUserEmail').value,
                            phone: document.getElementById('editUserPhone').value,
                            address: document.getElementById('editUserAddress').value,
                            memberLevel: document.getElementById('editUserMemberLevel').value,
                            loyaltyPoints: parseInt(document.getElementById('editUserLoyaltyPoints').value, 10),
                            updatedAt: Date.now()
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedUser = result.value;
                        db.ref('users/' + userId).update(updatedUser).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                             generateNotification('fas fa-user-edit', 'bg-info', `ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng ${updatedUser.name}.`);
                            loadUsers();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        // H√†m xem chi ti·∫øt ng∆∞·ªùi d√πng
        function viewUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†y.', 'error');
                return;
            }
            
            const avatar = user.avatar ? `<img src="${user.avatar}" alt="avatar" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">` : '<div style="width:80px;height:80px;border-radius:50%;background-color:#e9ecef;display:flex;align-items:center;justify-content:center;"><i class="fas fa-user fa-2x text-muted"></i></div>';
            const memberLevel = user.memberLevel || 'ƒê·ªìng';
            const loyaltyPoints = user.loyaltyPoints || 0;
            const status = user.status || 'active';
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('vi-VN') : 'Ch∆∞a ƒëƒÉng nh·∫≠p';
            
            Swal.fire({
                title: `<i class="fas fa-user-circle"></i> Th√¥ng tin chi ti·∫øt ng∆∞·ªùi d√πng`,
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-12 text-center mb-3">
                                ${avatar}
                                <h5 class="mt-2 mb-1">${user.name || 'N/A'}</h5>
                                <div class="mb-2">
                                    <span class="badge bg-warning text-dark"><i class="fas fa-crown"></i> ${memberLevel}</span>
                                    <span class="badge bg-info ms-1">${loyaltyPoints} ƒëi·ªÉm th∆∞·ªüng</span>
                                    <span class="badge ${status === 'active' ? 'bg-success' : status === 'inactive' ? 'bg-warning' : 'bg-danger'} ms-1">
                                        ${status === 'active' ? 'Ho·∫°t ƒë·ªông' : status === 'inactive' ? 'T·∫°m kh√≥a' : 'B·ªã c·∫•m'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Th√¥ng tin c√° nh√¢n</h6>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${user.phone || 'N/A'}</p>
                                <p><strong>Gi·ªõi t√≠nh:</strong> ${user.gender || 'N/A'}</p>
                                <p><strong>Ng√†y sinh:</strong> ${user.birthday ? new Date(user.birthday).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                <p><strong>Qu·ªëc t·ªãch:</strong> ${user.nationality || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-map-marker-alt"></i> Th√¥ng tin kh√°c</h6>
                                <p><strong>ƒê·ªãa ch·ªâ:</strong> ${user.address || 'N/A'}</p>
                                <p><strong>S·ªë CCCD:</strong> ${user.identityNumber || 'N/A'}</p>
                                <p><strong>Ng√†y tham gia:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                <p><strong>L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi:</strong> ${lastLogin}</p>
                                <p><strong>T·ªïng s·ªë booking:</strong> ${user.totalBookings || 0}</p>
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCloseButton: true,
                focusConfirm: false,
                confirmButtonText: 'ƒê√≥ng'
            });
        }

        // H√†m ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†y.', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Ch·ªânh s·ª≠a th√¥ng tin ng∆∞·ªùi d√πng',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="editUserName" class="form-control mb-2" placeholder="H·ªç v√† t√™n" value="${user.name || ''}">
                                <input type="email" id="editUserEmail" class="form-control mb-2" placeholder="Email" value="${user.email || ''}">
                                <input type="text" id="editUserPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${user.phone || ''}">
                                <input type="date" id="editUserBirthday" class="form-control mb-2" value="${user.birthday || ''}">
                                <select id="editUserGender" class="form-select mb-2">
                                    <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                    <option value="Nam" ${user.gender === 'Nam' ? 'selected' : ''}>Nam</option>
                                    <option value="N·ªØ" ${user.gender === 'N·ªØ' ? 'selected' : ''}>N·ªØ</option>
                                    <option value="Kh√°c" ${user.gender === 'Kh√°c' ? 'selected' : ''}>Kh√°c</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <textarea id="editUserAddress" class="form-control mb-2" rows="2" placeholder="ƒê·ªãa ch·ªâ">${user.address || ''}</textarea>
                                <input type="text" id="editUserNationality" class="form-control mb-2" placeholder="Qu·ªëc t·ªãch" value="${user.nationality || 'Vi·ªát Nam'}">
                                <input type="text" id="editUserIdentityNumber" class="form-control mb-2" placeholder="S·ªë CCCD" value="${user.identityNumber || ''}">
                                <select id="editUserMemberLevel" class="form-select mb-2">
                                    <option value="ƒê·ªìng" ${user.memberLevel === 'ƒê·ªìng' ? 'selected' : ''}>ƒê·ªìng</option>
                                    <option value="B·∫°c" ${user.memberLevel === 'B·∫°c' ? 'selected' : ''}>B·∫°c</option>
                                    <option value="V√†ng" ${user.memberLevel === 'V√†ng' ? 'selected' : ''}>V√†ng</option>
                                    <option value="Kim c∆∞∆°ng" ${user.memberLevel === 'Kim c∆∞∆°ng' ? 'selected' : ''}>Kim c∆∞∆°ng</option>
                                </select>
                                <input type="number" id="editUserLoyaltyPoints" class="form-control mb-2" placeholder="ƒêi·ªÉm th∆∞·ªüng" value="${user.loyaltyPoints || 0}" min="0">
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const name = document.getElementById('editUserName').value.trim();
                    const email = document.getElementById('editUserEmail').value.trim();
                    const phone = document.getElementById('editUserPhone').value.trim();
                    
                    if (!name || !email || !phone) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n, email v√† s·ªë ƒëi·ªán tho·∫°i');
                        return false;
                    }
                    
                    return {
                        name: name,
                        email: email,
                        phone: phone,
                        birthday: document.getElementById('editUserBirthday').value,
                        gender: document.getElementById('editUserGender').value,
                        address: document.getElementById('editUserAddress').value.trim(),
                        nationality: document.getElementById('editUserNationality').value.trim(),
                        identityNumber: document.getElementById('editUserIdentityNumber').value.trim(),
                        memberLevel: document.getElementById('editUserMemberLevel').value,
                        loyaltyPoints: parseInt(document.getElementById('editUserLoyaltyPoints').value) || 0
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedUser = result.value;
                    db.ref('users/' + userId).update(updatedUser).then(() => {
                        Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng!', 'success');
                        loadUsers();
                    }).catch((error) => {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng: ' + error.message, 'error');
                    });
                }
            });
        }

        // H√†m th√™m ng∆∞·ªùi d√πng m·ªõi
        function addUser() {
            Swal.fire({
                title: 'Th√™m ng∆∞·ªùi d√πng m·ªõi',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="newUserName" class="form-control mb-2" placeholder="H·ªç v√† t√™n *" required>
                                <input type="email" id="newUserEmail" class="form-control mb-2" placeholder="Email *" required>
                                <input type="text" id="newUserPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i *" required>
                                <input type="date" id="newUserBirthday" class="form-control mb-2">
                                <select id="newUserGender" class="form-select mb-2">
                                    <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                    <option value="Nam">Nam</option>
                                    <option value="N·ªØ">N·ªØ</option>
                                    <option value="Kh√°c">Kh√°c</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <textarea id="newUserAddress" class="form-control mb-2" rows="2" placeholder="ƒê·ªãa ch·ªâ"></textarea>
                                <input type="text" id="newUserNationality" class="form-control mb-2" placeholder="Qu·ªëc t·ªãch" value="Vi·ªát Nam">
                                <input type="text" id="newUserIdentityNumber" class="form-control mb-2" placeholder="S·ªë CCCD">
                                <select id="newUserMemberLevel" class="form-select mb-2">
                                    <option value="ƒê·ªìng" selected>ƒê·ªìng</option>
                                    <option value="B·∫°c">B·∫°c</option>
                                    <option value="V√†ng">V√†ng</option>
                                    <option value="Kim c∆∞∆°ng">Kim c∆∞∆°ng</option>
                                </select>
                                <input type="number" id="newUserLoyaltyPoints" class="form-control mb-2" placeholder="ƒêi·ªÉm th∆∞·ªüng" value="0" min="0">
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Th√™m ng∆∞·ªùi d√πng',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const name = document.getElementById('newUserName').value.trim();
                    const email = document.getElementById('newUserEmail').value.trim();
                    const phone = document.getElementById('newUserPhone').value.trim();
                    
                    if (!name || !email || !phone) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n, email v√† s·ªë ƒëi·ªán tho·∫°i');
                        return false;
                    }
                    
                    // Validate email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        Swal.showValidationMessage('Email kh√¥ng h·ª£p l·ªá');
                        return false;
                    }
                    
                    return {
                        name: name,
                        email: email,
                        phone: phone,
                        birthday: document.getElementById('newUserBirthday').value,
                        gender: document.getElementById('newUserGender').value,
                        address: document.getElementById('newUserAddress').value.trim(),
                        nationality: document.getElementById('newUserNationality').value.trim(),
                        identityNumber: document.getElementById('newUserIdentityNumber').value.trim(),
                        memberLevel: document.getElementById('newUserMemberLevel').value,
                        loyaltyPoints: parseInt(document.getElementById('newUserLoyaltyPoints').value) || 0,
                        status: 'active',
                        createdAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newUser = result.value;
                    db.ref('users').push(newUser).then(() => {
                        Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m ng∆∞·ªùi d√πng m·ªõi!', 'success');
                        loadUsers();
                    }).catch((error) => {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ th√™m ng∆∞·ªùi d√πng: ' + error.message, 'error');
                    });
                }
            });
        }

        // H√†m chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng
        function toggleUserStatus(userId, currentStatus) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†y.', 'error');
                return;
            }
            
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'k√≠ch ho·∫°t' : 'kh√≥a';
            
            Swal.fire({
                title: `X√°c nh·∫≠n ${action} t√†i kho·∫£n?`,
                text: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${action} t√†i kho·∫£n c·ªßa ${user.name}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: newStatus === 'active' ? '#28a745' : '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: `${action.charAt(0).toUpperCase() + action.slice(1)}`,
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('users/' + userId).update({ status: newStatus }).then(() => {
                        Swal.fire('Th√†nh c√¥ng', `ƒê√£ ${action} t√†i kho·∫£n th√†nh c√¥ng!`, 'success');
                        loadUsers();
                    }).catch((error) => {
                        Swal.fire('L·ªói', `Kh√¥ng th·ªÉ ${action} t√†i kho·∫£n: ` + error.message, 'error');
                    });
                }
            });
        }

        function deleteUser(userId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('users/' + userId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        generateNotification('fas fa-user-slash', 'bg-danger', `ƒê√£ x√≥a m·ªôt ng∆∞·ªùi d√πng.`);
                        loadUsers();
                    });
                }
            });
        }

        function viewTour(tourType, tourId) {
            db.ref(`specialTours/${tourType}/${tourId}`).once('value').then((snapshot) => {
                const tour = snapshot.val();
                 if(!tour) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y tour!', 'error');
                    return;
                }
                Swal.fire({
                    title: tour.name || 'Th√¥ng tin tour',
                    html: `
                        <img src="${tour.image || 'images/default-tour.jpg'}" alt="H√¨nh ·∫£nh tour" class="img-fluid mb-3" style="max-height:200px;">
                        <p><strong>M√¥ t·∫£:</strong> ${tour.description || ''}</p>
                        <p><strong>Th·ªùi l∆∞·ª£ng:</strong> ${tour.duration || ''}</p>
                        <p><strong>Gi√°:</strong> ${tour.price ? tour.price.toLocaleString('vi-VN') + ' ƒë' : 'Ch∆∞a c√≥'}</p>
                    `,
                    width: '600px'
                });
            });
        }

        function editTour(tourType, tourId) {
            db.ref(`specialTours/${tourType}/${tourId}`).once('value').then((snapshot) => {
                const tour = snapshot.val();
                if(!tour) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y tour!', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a tour',
                    html: `
                        <form id="editTourForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">T√™n tour</label>
                                <input type="text" class="form-control" id="editTourName" value="${tour.name || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="editTourDesc">${tour.description || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">H√¨nh ·∫£nh (URL)</label>
                                <input type="text" class="form-control" id="editTourImage" value="${tour.image || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Th·ªùi l∆∞·ª£ng</label>
                                <input type="text" class="form-control" id="editTourDuration" value="${tour.duration || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Gi√° ti·ªÅn (VNƒê)</label>
                                <input type="number" class="form-control" id="editTourPrice" value="${tour.price || ''}" min="0" required>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('editTourForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            name: document.getElementById('editTourName').value,
                            description: document.getElementById('editTourDesc').value,
                            image: document.getElementById('editTourImage').value,
                            duration: document.getElementById('editTourDuration').value,
                            price: parseInt(document.getElementById('editTourPrice').value, 10)
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedTour = result.value;
                        db.ref(`specialTours/${tourType}/${tourId}`).update(updatedTour).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Tour ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                            loadTours();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tour: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteTour(tourType, tourId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`specialTours/${tourType}/${tourId}`).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'Tour ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        loadTours();
                    }).catch(error => {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√≥a tour: ' + error.message, 'error');
                    });
                }
            });
        }

        function addTour() {
            const tourTypes = ['amThucVaVanHoa', 'hoatDongGanBan', 'traiNghiemDiaPhuong'];
            Swal.fire({
                title: 'Th√™m tour m·ªõi',
                html: `
                    <form id="addTourForm" class="text-start">
                         <div class="mb-3">
                            <label class="form-label">Lo·∫°i tour</label>
                            <select class="form-control" id="addTourType" required>
                                <option value="">Ch·ªçn lo·∫°i tour</option>
                                ${tourTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">T√™n tour</label>
                            <input type="text" class="form-control" id="addTourName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√¥ t·∫£</label>
                            <textarea class="form-control" id="addTourDesc" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">H√¨nh ·∫£nh (URL)</label>
                            <input type="text" class="form-control" id="addTourImage" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Th·ªùi l∆∞·ª£ng</label>
                            <input type="text" class="form-control" id="addTourDuration" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gi√° ti·ªÅn (VNƒê)</label>
                            <input type="number" class="form-control" id="addTourPrice" min="0" required>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const form = document.getElementById('addTourForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                     const tourType = document.getElementById('addTourType').value;
                     if (!tourType) {
                        Swal.showValidationMessage('Vui l√≤ng ch·ªçn lo·∫°i tour');
                        return false;
                     }
                    return {
                        tourType: tourType,
                        name: document.getElementById('addTourName').value,
                        description: document.getElementById('addTourDesc').value,
                        image: document.getElementById('addTourImage').value,
                        duration: document.getElementById('addTourDuration').value,
                        price: parseInt(document.getElementById('addTourPrice').value, 10)
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newTourData = result.value;
                    const tourType = newTourData.tourType;
                    delete newTourData.tourType; // X√≥a key t·∫°m th·ªùi

                    db.ref(`specialTours/${tourType}`).push(newTourData).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Th√†nh c√¥ng!',
                            text: 'Tour m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.',
                            timer: 1500
                        });
                        loadTours();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói!',
                            text: 'Kh√¥ng th·ªÉ th√™m tour: ' + error.message
                        });
                    });
                }
            });
        }

        window.viewHotel = viewHotel;
        window.editHotel = editHotel;
        window.deleteHotel = deleteHotel;
        window.addHotel = addHotel;
        window.viewUser = viewUser;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.viewTour = viewTour;
        window.editTour = editTour;
        window.deleteTour = deleteTour;
        window.addTour = addTour;
        window.editVoucher = editVoucher; window.deleteVoucher = deleteVoucher;
        window.addVoucher = addVoucher;
        window.addDeal = addDeal;
        window.editDeal = editDeal;
        window.deleteDeal = deleteDeal;
        window.addTravelGuide = addTravelGuide;
        window.editTravelGuide = editTravelGuide;
        window.deleteTravelGuide = deleteTravelGuide;

        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function (event) {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.mobile-toggle');

            if (window.innerWidth <= 768 &&
                !sidebar.contains(event.target) &&
                !toggleBtn.contains(event.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        window.toggleSidebar = toggleSidebar;

        // Load deals data
        function loadDeals() {
            const dealsTableBody = document.getElementById('dealsTableBody');
            dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('specialOffers').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }

                dealsTableBody.innerHTML = '';
                snapshot.forEach((dealSnapshot) => {
                    const deal = dealSnapshot.val();
                    const dealId = dealSnapshot.key;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${deal.title || 'N/A'}</td>
                        <td><span class="badge bg-success">${deal.newPrice || 'N/A'}</span></td>
                        <td><span style="text-decoration: line-through;">${deal.oldPrice || 'N/A'}</span></td>
                        <td>${deal.stayEndDate ? new Date(deal.stayEndDate).toLocaleDateString('vi-VN') : 'Kh√¥ng c√≥'}</td>
                        <td>
                            <button class="btn btn-action btn-edit" onclick="editDeal('${dealId}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-action btn-delete" onclick="deleteDeal('${dealId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    dealsTableBody.appendChild(row);
                });
            }).catch(error => {
                dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</div></tr>';
            });
        }

        function addDeal() {
            Swal.fire({
                title: 'Th√™m ∆∞u ƒë√£i m·ªõi',
                html: `
                    <form id="addDealForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                        <div class="mb-3"><label class="form-label">Ti√™u ƒë·ªÅ</label><input type="text" class="form-control" id="dealTitle" required></div>
                        <div class="mb-3"><label class="form-label">M√¥ t·∫£</label><textarea class="form-control" id="dealDesc" required></textarea></div>
                        <div class="mb-3"><label class="form-label">Nh√£n</label><input type="text" class="form-control" id="dealLabel" placeholder="VD: Flash Sale, Hot..."></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Gi√° m·ªõi</label><input type="text" class="form-control" id="dealNewPrice" placeholder="VD: 3.200.000ƒë" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Gi√° c≈©</label><input type="text" class="form-control" id="dealOldPrice" placeholder="VD: 5.000.000ƒë" required></div>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" class="form-control" id="dealStayStart" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Ng√†y k·∫øt th√∫c</label><input type="date" class="form-control" id="dealStayEnd" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">H√¨nh ·∫£nh (URL)</label><input type="url" class="form-control" id="dealImage" required></div>
                        <div class="row">
                           <div class="col-md-6 mb-3"><label class="form-label">S·ªë ƒë√™m</label><input type="number" class="form-control" id="dealNights" min="1" required></div>
                           <div class="col-md-6 mb-3"><label class="form-label">S·ªë kh√°ch</label><input type="number" class="form-control" id="dealGuests" min="1" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">T√¨nh tr·∫°ng</label><input type="text" class="form-control" id="dealAvailability" placeholder="VD: Ch·ªâ c√≤n 50 ph√≤ng"></div>
                        <div class="mb-3"><label class="form-label">ƒê·∫∑c ƒëi·ªÉm (m·ªói ƒë·∫∑c ƒëi·ªÉm m·ªôt d√≤ng)</label><textarea class="form-control" id="dealFeatures" rows="3"></textarea></div>
                        <div class="mb-3"><label class="form-label">Ghi ch√∫</label><textarea class="form-control" id="dealNote"></textarea></div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                width: '800px',
                preConfirm: () => {
                    const form = document.getElementById('addDealForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    return {
                        title: document.getElementById('dealTitle').value,
                        desc: document.getElementById('dealDesc').value,
                        label: document.getElementById('dealLabel').value,
                        newPrice: document.getElementById('dealNewPrice').value,
                        oldPrice: document.getElementById('dealOldPrice').value,
                        stayStartDate: document.getElementById('dealStayStart').value,
                        stayEndDate: document.getElementById('dealStayEnd').value,
                        image: document.getElementById('dealImage').value,
                        nights: parseInt(document.getElementById('dealNights').value),
                        guests: parseInt(document.getElementById('dealGuests').value),
                        availability: document.getElementById('dealAvailability').value,
                        features: document.getElementById('dealFeatures').value.split('\\n').map(f => f.trim()).filter(f => f),
                        note: document.getElementById('dealNote').value,
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newDealRef = db.ref('specialOffers').push();
                    const newDeal = {
                        ...result.value,
                        id: newDealRef.key
                    };
                    
                    newDealRef.set(newDeal).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Th√†nh c√¥ng!',
                            text: '∆Øu ƒë√£i m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.',
                            timer: 1500
                        });
                        loadDeals();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói!',
                            text: 'Kh√¥ng th·ªÉ th√™m ∆∞u ƒë√£i: ' + error.message
                        });
                    });
                }
            });
        }

        function editDeal(dealId) {
            db.ref('specialOffers/' + dealId).once('value').then((snapshot) => {
                const deal = snapshot.val();
                if (!deal) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ∆∞u ƒë√£i n√†y!', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a ∆∞u ƒë√£i',
                    html: `
                       <form id="editDealForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                            <div class="mb-3"><label class="form-label">Ti√™u ƒë·ªÅ</label><input type="text" class="form-control" id="dealTitle" value="${deal.title || ''}" required></div>
                            <div class="mb-3"><label class="form-label">M√¥ t·∫£</label><textarea class="form-control" id="dealDesc" required>${deal.desc || ''}</textarea></div>
                            <div class="mb-3"><label class="form-label">Nh√£n</label><input type="text" class="form-control" id="dealLabel" value="${deal.label || ''}" placeholder="VD: Flash Sale, Hot..."></div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Gi√° m·ªõi</label><input type="text" class="form-control" id="dealNewPrice" value="${deal.newPrice || ''}" placeholder="VD: 3.200.000ƒë" required></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Gi√° c≈©</label><input type="text" class="form-control" id="dealOldPrice" value="${deal.oldPrice || ''}" placeholder="VD: 5.000.000ƒë" required></div>
                            </div>
                             <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" class="form-control" id="dealStayStart" value="${deal.stayStartDate || ''}" required></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Ng√†y k·∫øt th√∫c</label><input type="date" class="form-control" id="dealStayEnd" value="${deal.stayEndDate || ''}" required></div>
                            </div>
                            <div class="mb-3"><label class="form-label">H√¨nh ·∫£nh (URL)</label><input type="url" class="form-control" id="dealImage" value="${deal.image || ''}" required></div>
                            <div class="row">
                               <div class="col-md-6 mb-3"><label class="form-label">S·ªë ƒë√™m</label><input type="number" class="form-control" id="dealNights" value="${deal.nights || 1}" min="1" required></div>
                               <div class="col-md-6 mb-3"><label class="form-label">S·ªë kh√°ch</label><input type="number" class="form-control" id="dealGuests" value="${deal.guests || 1}" min="1" required></div>
                            </div>
                            <div class="mb-3"><label class="form-label">T√¨nh tr·∫°ng</label><input type="text" class="form-control" id="dealAvailability" value="${deal.availability || ''}" placeholder="VD: Ch·ªâ c√≤n 50 ph√≤ng"></div>
                            <div class="mb-3"><label class="form-label">ƒê·∫∑c ƒëi·ªÉm (m·ªói ƒë·∫∑c ƒëi·ªÉm m·ªôt d√≤ng)</label><textarea class="form-control" id="dealFeatures" rows="3">${(deal.features || []).join('\\n')}</textarea></div>
                            <div class="mb-3"><label class="form-label">Ghi ch√∫</label><textarea class="form-control" id="dealNote">${deal.note || ''}</textarea></div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    width: '800px',
                    preConfirm: () => {
                        const form = document.getElementById('editDealForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            title: document.getElementById('dealTitle').value,
                            desc: document.getElementById('dealDesc').value,
                            label: document.getElementById('dealLabel').value,
                            newPrice: document.getElementById('dealNewPrice').value,
                            oldPrice: document.getElementById('dealOldPrice').value,
                            stayStartDate: document.getElementById('dealStayStart').value,
                            stayEndDate: document.getElementById('dealStayEnd').value,
                            image: document.getElementById('dealImage').value,
                            nights: parseInt(document.getElementById('dealNights').value),
                            guests: parseInt(document.getElementById('dealGuests').value),
                            availability: document.getElementById('dealAvailability').value,
                            features: document.getElementById('dealFeatures').value.split('\\n').map(f => f.trim()).filter(f => f),
                            note: document.getElementById('dealNote').value,
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedDeal = {
                            ...result.value,
                            id: dealId // Make sure ID is preserved
                        };
                        db.ref('specialOffers/' + dealId).update(updatedDeal).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: '∆Øu ƒë√£i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                            loadDeals();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ∆∞u ƒë√£i: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteDeal(dealId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('specialOffers/' + dealId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', '∆Øu ƒë√£i ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        loadDeals();
                    });
                }
            });
        }

        // Travel Guide CRUD
        function loadTravelGuides() {
            const travelGuidesTableBody = document.getElementById('travelGuidesTableBody');
            travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('travelGuides').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }

                travelGuidesTableBody.innerHTML = '';
                snapshot.forEach((guideSnapshot) => {
                    const guide = guideSnapshot.val();
                    const guideId = guideSnapshot.key;
                    
                    // Helper to create a title from the key
                    const title = guideId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    const displayDate = guide.last_updated ? new Date(guide.last_updated).toLocaleDateString('vi-VN') : 'N/A';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${guide.main_image || 'images/default-tour.jpg'}" alt="guide-image" style="width: 100px; object-fit: cover;"></td>
                        <td>${title}</td>
                        <td>${guide.author || 'N/A'}</td>
                        <td>${displayDate}</td>
                        <td>
                            <button class="btn btn-action btn-edit" onclick="editTravelGuide('${guideId}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-action btn-delete" onclick="deleteTravelGuide('${guideId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    travelGuidesTableBody.appendChild(row);
                });
            }).catch(error => {
                travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
            });
        }

        function addTravelGuide() {
            Swal.fire({
                title: 'Th√™m b√†i vi·∫øt c·∫©m nang',
                html: `
                    <form id="addTravelGuideForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                        <div class="mb-3">
                            <label class="form-label">Ti√™u ƒë·ªÅ b√†i vi·∫øt</label>
                            <input type="text" class="form-control" id="guideTitle" placeholder="VD: Kh√°m Ph√° ƒê√† N·∫µng" required>
                            <small class="form-text text-muted">Ti√™u ƒë·ªÅ s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ t·∫°o ID duy nh·∫•t (VD: kham-pha-da-nang).</small>
                        </div>
                        <div class="mb-3"><label class="form-label">T√°c gi·∫£</label><input type="text" class="form-control" id="guideAuthor" required></div>
                        <div class="mb-3"><label class="form-label">Ng√†y ƒëƒÉng</label><input type="date" class="form-control" id="guideDate" required></div>
                        <div class="mb-3"><label class="form-label">H√¨nh ·∫£nh ch√≠nh (URL)</label><input type="url" class="form-control" id="guideImage" required></div>
                        <div class="mb-3"><label class="form-label">M√¥ t·∫£ t·ªïng quan</label><textarea class="form-control" id="guideOverview" rows="5" required></textarea></div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                width: '800px',
                preConfirm: () => {
                    const form = document.getElementById('addTravelGuideForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    const title = document.getElementById('guideTitle').value;
                    // A simple slugify function
                    const slugify = (text) => {
                        const a = '√†√°√¢√£√®√©√™√¨√≠√≤√≥√¥√µ√π√∫ƒÉƒëƒ©≈©∆°∆∞ƒÉ·∫°·∫£·∫•·∫ß·∫©·∫´·∫≠·∫Ø·∫±·∫≥·∫µ·∫∑·∫π·∫ª·∫Ω·ªÅ·ªÅ·ªÉ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ªÖ·ªá·ªâ·ªã·ªç·ªè·ªë·ªì·ªï·ªó·ªô·ªõ·ªù·ªü·ª°·ª£·ª•·ªß·ª©·ª´·ª¨·ªÆ·ª∞·ª≤·ª¥√ù·ª∂·ª∏·ª≠·ªØ·ª±·ª≥·ªµ·ª∑·ªπ';
                        const b = 'aaaaaaaaeeeeiiooooouuadiuouaaaaaaaaaaaaaaaeeeeeeeeeeIIOOOOOOOOOOOOOOOOOOUUUUUeeeeeeiiooooooooooooooooouuuuuUUUUUYYYYYuuuuuyyyyy';
                        const p = new RegExp(a.split('').join('|'), 'g');

                        return text.toString().toLowerCase()
                            .replace(p, c => b.charAt(a.indexOf(c)))
                            .replace(/\s+/g, '-')
                            .replace(/[^\w\-]+/g, '')
                            .replace(/\-\-+/g, '-')
                            .replace(/^-+/, '')
                            .replace(/-+$/, '');
                    };
                    const guideId = slugify(title);

                    if (!guideId) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ h·ª£p l·ªá.');
                        return false;
                    }

                    return {
                        guideId: guideId,
                        author: document.getElementById('guideAuthor').value,
                        last_updated: document.getElementById('guideDate').value,
                        main_image: document.getElementById('guideImage').value,
                        overview: document.getElementById('guideOverview').value,
                        // S·ª¨A L·ªñI: Kh·ªüi t·∫°o sections v√† related_destinations d∆∞·ªõi d·∫°ng ƒë·ªëi t∆∞·ª£ng thay v√¨ m·∫£ng
                        sections: { "0": { "heading": "N·ªôi dung ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t..." } },
                        related_destinations: { "0": "" },
                        is_featured_on_homepage: false,
                        id: 'guide_' + guideId.replace(/-/g, '_')
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newGuideData = result.value;
                    const guideId = newGuideData.guideId;
                    delete newGuideData.guideId;

                    db.ref('travelGuides/' + guideId).once('value').then(snapshot => {
                        if (snapshot.exists()) {
                            Swal.fire('L·ªói!', 'Ti√™u ƒë·ªÅ n√†y ƒë√£ t·ªìn t·∫°i, vui l√≤ng ch·ªçn ti√™u ƒë·ªÅ kh√°c.', 'error');
                        } else {
                            db.ref('travelGuides/' + guideId).set(newGuideData).then(() => {
                                Swal.fire('Th√†nh c√¥ng!', 'B√†i vi·∫øt m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.', 'success');
                                loadTravelGuides();
                            }).catch((error) => {
                                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ th√™m b√†i vi·∫øt: ' + error.message, 'error');
                            });
                        }
                    });
                }
            });
        }

        function editTravelGuide(guideId) {
            db.ref('travelGuides/' + guideId).once('value').then((snapshot) => {
                const guide = snapshot.val();
                if (!guide) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†y!', 'error');
                    return;
                }
                const title = guideId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a b√†i vi·∫øt c·∫©m nang',
                    html: `
                        <form id="editTravelGuideForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                            <div class="mb-3"><label class="form-label">Ti√™u ƒë·ªÅ (ID)</label><input type="text" class="form-control" value="${title}" disabled></div>
                            <div class="mb-3"><label class="form-label">T√°c gi·∫£</label><input type="text" class="form-control" id="guideAuthor" value="${guide.author || ''}" required></div>
                            <div class="mb-3"><label class="form-label">Ng√†y c·∫≠p nh·∫≠t</label><input type="date" class="form-control" id="guideDate" value="${guide.last_updated || ''}" required></div>
                            <div class="mb-3"><label class="form-label">H√¨nh ·∫£nh ch√≠nh (URL)</label><input type="url" class="form-control" id="guideImage" value="${guide.main_image || ''}" required></div>
                            <div class="mb-3"><label class="form-label">M√¥ t·∫£ t·ªïng quan</label><textarea class="form-control" id="guideOverview" rows="5" required>${guide.overview || ''}</textarea></div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    width: '800px',
                    preConfirm: () => {
                        const form = document.getElementById('editTravelGuideForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            author: document.getElementById('guideAuthor').value,
                            last_updated: document.getElementById('guideDate').value,
                            main_image: document.getElementById('guideImage').value,
                            overview: document.getElementById('guideOverview').value,
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        db.ref('travelGuides/' + guideId).update(result.value).then(() => {
                            Swal.fire('Th√†nh c√¥ng!', 'B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
                            loadTravelGuides();
                        }).catch((error) => {
                            Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t b√†i vi·∫øt: ' + error.message, 'error');
                        });
                    }
                });
            });
        }

        function deleteTravelGuide(guideId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('travelGuides/' + guideId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        loadTravelGuides();
                    }).catch(error => {
                        Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt: ' + error.message, 'error');
                    });
                }
            });
        }

        // =================== CONTRIBUTIONS MANAGEMENT ===================
        
        let currentContributions = [];
        let currentFilter = 'all';

        // Load contributions from Firebase
        function loadContributions() {
            const loadingElement = document.getElementById('contributions-loading');
            const emptyElement = document.getElementById('contributions-empty');
            const listElement = document.getElementById('contributions-list');

            // Show loading
            loadingElement.style.display = 'block';
            emptyElement.style.display = 'none';
            listElement.innerHTML = '';

            db.ref('userContributions').once('value').then((snapshot) => {
                loadingElement.style.display = 'none';

                if (!snapshot.exists()) {
                    emptyElement.style.display = 'block';
                    updateContributionsCount(0);
                    return;
                }

                currentContributions = [];
                snapshot.forEach((contributionSnapshot) => {
                    const contribution = contributionSnapshot.val();
                    contribution.id = contributionSnapshot.key;
                    currentContributions.push(contribution);
                });

                // S·∫Øp x·∫øp theo th·ªùi gian g·ª≠i (m·ªõi nh·∫•t tr∆∞·ªõc)
                currentContributions.sort((a, b) => (b.submittedAt || 0) - (a.submittedAt || 0));

                updateContributionsCount(currentContributions.length);
                displayContributions(currentContributions);

                // Update pending count badge
                const pendingCount = currentContributions.filter(c => c.status === 'pending').length;
                updatePendingBadge(pendingCount);

            }).catch(error => {
                loadingElement.style.display = 'none';
                listElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}
                    </div>
                `;
            });
        }

        // Display contributions with current filter
        function displayContributions(contributions) {
            const listElement = document.getElementById('contributions-list');
            
            // Filter contributions based on current filter
            let filteredContributions = contributions;
            if (currentFilter !== 'all') {
                filteredContributions = contributions.filter(c => c.status === currentFilter);
            }

            if (filteredContributions.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">Kh√¥ng c√≥ c·∫©m nang n√†o v·ªõi tr·∫°ng th√°i "${getStatusText(currentFilter)}"</h6>
                    </div>
                `;
                return;
            }

            listElement.innerHTML = '';
            filteredContributions.forEach(contribution => {
                const contributionCard = createContributionCard(contribution);
                listElement.appendChild(contributionCard);
            });
        }

        // Create contribution card element
        function createContributionCard(contribution) {
            const div = document.createElement('div');
            div.className = 'card mb-4 contribution-card';

            const status = contribution.status || 'pending';
            const statusBadge = getStatusBadge(status);
            const submittedDate = contribution.submittedAt ? new Date(contribution.submittedAt).toLocaleString('vi-VN') : 'Kh√¥ng r√µ';
            const hotelCount = contribution.hotelRecommendations ? contribution.hotelRecommendations.length : 0;

            div.innerHTML = `
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <img src="${contribution.main_image || '/images/default-guide.jpg'}" 
                                 alt="·∫¢nh c·∫©m nang" class="img-fluid rounded" style="height: 150px; object-fit: cover; width: 100%;">
                        </div>
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-1">${contribution.title}</h5>
                                ${statusBadge}
                            </div>
                            
                            <div class="row text-muted small mb-2">
                                <div class="col-md-6">
                                    <i class="fas fa-user"></i> <strong>T√°c gi·∫£:</strong> ${contribution.authorName}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-envelope"></i> ${contribution.authorEmail}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-map-marker-alt"></i> <strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${contribution.location}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-tag"></i> <strong>Danh m·ª•c:</strong> ${contribution.category}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-clock"></i> <strong>Th·ªùi gian:</strong> ${contribution.duration || 'Kh√¥ng r√µ'}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-hotel"></i> <strong>Kh√°ch s·∫°n g·ª£i √Ω:</strong> ${hotelCount} kh√°ch s·∫°n
                                </div>
                                <div class="col-12 mt-2">
                                    <i class="fas fa-calendar"></i> <strong>G·ª≠i l√∫c:</strong> ${submittedDate}
                                </div>
                            </div>
                            
                            <p class="card-text text-muted">${contribution.summary}</p>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="viewContribution('${contribution.id}')">
                                    <i class="fas fa-eye"></i> Xem chi ti·∫øt
                                </button>
                                ${status === 'pending' ? `
                                    <button class="btn btn-success btn-sm" onclick="quickApproveContribution('${contribution.id}')">
                                        <i class="fas fa-check"></i> Duy·ªát nhanh
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="quickRejectContribution('${contribution.id}')">
                                        <i class="fas fa-times"></i> T·ª´ ch·ªëi
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Ch·ªù duy·ªát</span>',
                'approved': '<span class="badge bg-success"><i class="fas fa-check"></i> ƒê√£ duy·ªát</span>',
                'rejected': '<span class="badge bg-danger"><i class="fas fa-times"></i> T·ª´ ch·ªëi</span>'
            };
            return badges[status] || badges['pending'];
        }

        // Get status text
        function getStatusText(status) {
            const texts = {
                'all': 't·∫•t c·∫£',
                'pending': 'ch·ªù duy·ªát',
                'approved': 'ƒë√£ duy·ªát', 
                'rejected': 't·ª´ ch·ªëi'
            };
            return texts[status] || 'kh√¥ng r√µ';
        }

        // Filter contributions
        function filterContributions(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('[onclick^="filterContributions"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');

            displayContributions(currentContributions);
        }

        // Update contributions count
        function updateContributionsCount(count) {
            const badge = document.getElementById('contributions-count-badge');
            if (badge) {
                badge.textContent = count;
            }
        }

        // Update pending badge in sidebar
        function updatePendingBadge(count) {
            const badge = document.getElementById('pending-contributions-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Load pending contributions count for sidebar
        function loadPendingContributionsCount() {
            db.ref('userContributions').orderByChild('status').equalTo('pending').once('value').then((snapshot) => {
                const pendingCount = snapshot.numChildren();
                updatePendingBadge(pendingCount);
            }).catch(error => {
                console.error('Error loading pending contributions count:', error);
            });
        }

        // View contribution details
        function viewContribution(contributionId) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y c·∫©m nang n√†y!', 'error');
                return;
            }

            // Store current contribution for approval/rejection
            window.currentContribution = contribution;

            const modalContent = document.getElementById('contribution-detail-content');
            const submittedDate = contribution.submittedAt ? new Date(contribution.submittedAt).toLocaleString('vi-VN') : 'Kh√¥ng r√µ';
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h3>${contribution.title}</h3>
                        <div class="mb-3">
                            ${getStatusBadge(contribution.status || 'pending')}
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong><i class="fas fa-user"></i> T√°c gi·∫£:</strong> ${contribution.authorName}<br>
                                <strong><i class="fas fa-envelope"></i> Email:</strong> ${contribution.authorEmail}<br>
                                <strong><i class="fas fa-map-marker-alt"></i> ƒê·ªãa ƒëi·ªÉm:</strong> ${contribution.location}<br>
                                <strong><i class="fas fa-tag"></i> Danh m·ª•c:</strong> ${contribution.category}
                            </div>
                            <div class="col-md-6">
                                <strong><i class="fas fa-clock"></i> Th·ªùi gian:</strong> ${contribution.duration || 'Kh√¥ng r√µ'}<br>
                                <strong><i class="fas fa-dollar-sign"></i> Ng√¢n s√°ch:</strong> ${contribution.budget || 'Kh√¥ng r√µ'}<br>
                                <strong><i class="fas fa-calendar"></i> M√πa th√≠ch h·ª£p:</strong> ${contribution.season || 'Kh√¥ng r√µ'}<br>
                                <strong><i class="fas fa-calendar-plus"></i> G·ª≠i l√∫c:</strong> ${submittedDate}
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5><i class="fas fa-align-left"></i> T√≥m t·∫Øt</h5>
                            <p class="bg-light p-3 rounded">${contribution.summary}</p>
                        </div>

                        <div class="mb-4">
                            <h5><i class="fas fa-file-alt"></i> N·ªôi dung chi ti·∫øt</h5>
                            <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                                ${contribution.content.replace(/\n/g, '<br>')}
                            </div>
                        </div>

                        ${contribution.hotelRecommendations && contribution.hotelRecommendations.length > 0 ? `
                            <div class="mb-4">
                                <h5><i class="fas fa-hotel"></i> Kh√°ch s·∫°n g·ª£i √Ω (${contribution.hotelRecommendations.length})</h5>
                                ${contribution.hotelRecommendations.map(hotel => `
                                    <div class="card mb-2">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">${hotel.name}</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small><strong>ƒê√°nh gi√°:</strong> ${hotel.rating ? '‚≠ê'.repeat(hotel.rating) : 'Ch∆∞a ƒë√°nh gi√°'}</small><br>
                                                    <small><strong>Gi√°:</strong> ${hotel.price || 'Ch∆∞a c√≥ th√¥ng tin'}</small><br>
                                                    <small><strong>V·ªã tr√≠:</strong> ${hotel.location || 'Ch∆∞a c√≥ th√¥ng tin'}</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small><strong>G·ª£i √Ω:</strong> ${getRecommendationText(hotel.recommendation)}</small>
                                                </div>
                                            </div>
                                            ${hotel.review ? `<p class="mt-2 mb-0"><small><strong>Nh·∫≠n x√©t:</strong> ${hotel.review}</small></p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <img src="${contribution.main_image || '/images/default-guide.jpg'}" 
                                 alt="·∫¢nh c·∫©m nang" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Th√¥ng tin th√™m</h6>
                            </div>
                            <div class="card-body">
                                <small>
                                    <strong>ID:</strong> ${contribution.id}<br>
                                    <strong>Slug:</strong> ${contribution.slug || 'Ch∆∞a t·∫°o'}<br>
                                    <strong>Tr·∫°ng th√°i:</strong> ${getStatusText(contribution.status || 'pending')}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Show/hide action buttons based on status
            const approveBtn = document.getElementById('approveContributionBtn');
            const rejectBtn = document.getElementById('rejectContributionBtn');
            
            if (contribution.status === 'pending') {
                approveBtn.style.display = 'inline-block';
                rejectBtn.style.display = 'inline-block';
            } else {
                approveBtn.style.display = 'none';
                rejectBtn.style.display = 'none';
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('contributionDetailModal'));
            modal.show();
        }

        // Get recommendation text
        function getRecommendationText(recommendation) {
            const texts = {
                'highly-recommended': 'üî• R·∫•t khuy·∫øn kh√≠ch',
                'recommended': 'üëç Khuy·∫øn kh√≠ch',
                'okay': 'üòê T·∫°m ƒë∆∞·ª£c',
                'not-recommended': 'üëé Kh√¥ng khuy·∫øn kh√≠ch'
            };
            return texts[recommendation] || 'Ch∆∞a ƒë√°nh gi√°';
        }

        // Quick approve contribution
        function quickApproveContribution(contributionId) {
            Swal.fire({
                title: 'Duy·ªát c·∫©m nang?',
                text: 'C·∫©m nang s·∫Ω ƒë∆∞·ª£c c√¥ng b·ªë tr√™n website ngay l·∫≠p t·ª©c.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Duy·ªát',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    approveContribution(contributionId);
                }
            });
        }

        // Quick reject contribution
        function quickRejectContribution(contributionId) {
            Swal.fire({
                title: 'T·ª´ ch·ªëi c·∫©m nang',
                input: 'textarea',
                inputLabel: 'L√Ω do t·ª´ ch·ªëi',
                inputPlaceholder: 'Nh·∫≠p l√Ω do t·ª´ ch·ªëi ƒë·ªÉ g·ª≠i ph·∫£n h·ªìi cho t√°c gi·∫£...',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi!';
                    }
                },
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'T·ª´ ch·ªëi',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    rejectContribution(contributionId, result.value);
                }
            });
        }

        // Approve contribution
        function approveContribution(contributionId) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y c·∫©m nang n√†y!', 'error');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'ƒêang x·ª≠ l√Ω...',
                text: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Generate guide data for travelGuides collection
            const slugId = contribution.slug || generateSlug(contribution.title);
            const guideData = {
                title: contribution.title,
                author: contribution.authorName,
                main_image: contribution.main_image || '/images/default-guide.jpg',
                overview: contribution.summary,
                last_updated: new Date().toISOString().split('T')[0],
                is_featured_on_homepage: false,
                id: slugId,
                slug: slugId, // Th√™m slug ƒë·ªÉ hi·ªÉn th·ªã tr√™n travel_guide.html
                sections: {
                    "0": {
                        "heading": "Th√¥ng tin chi ti·∫øt",
                        "content": contribution.content
                    }
                },
                related_destinations: { "0": contribution.location },
                category: contribution.category,
                location: contribution.location,
                duration: contribution.duration,
                budget: contribution.budget,
                season: contribution.season,
                hotelRecommendations: contribution.hotelRecommendations || [],
                originalContributionId: contributionId
            };

            // Save to travelGuides and update contribution status
            Promise.all([
                db.ref('travelGuides/' + slugId).set(guideData),
                db.ref('userContributions/' + contributionId + '/status').set('approved'),
                db.ref('userContributions/' + contributionId + '/approvedAt').set(firebase.database.ServerValue.TIMESTAMP),
                db.ref('userContributions/' + contributionId + '/publishedGuideId').set(slugId)
            ]).then(() => {
                // Send approval email
                return emailjs.send("service_6spwxxw", "template_vcjlg02", {
                    to_email: contribution.authorEmail,
                    from_name: "Admin LuxuryHavenTravel",
                    title: "C·∫©m nang ƒë√£ ƒë∆∞·ª£c duy·ªát",
                    message: `Ch√∫c m·ª´ng! C·∫©m nang "${contribution.title}" c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c duy·ªát v√† c√¥ng b·ªë tr√™n website. C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p n·ªôi dung ch·∫•t l∆∞·ª£ng cho c·ªông ƒë·ªìng du l·ªãch.`,
                    timestamp: new Date().toLocaleString('vi-VN')
                });
            }).then(() => {
                Swal.fire({
                    title: 'Th√†nh c√¥ng!',
                    text: 'C·∫©m nang ƒë√£ ƒë∆∞·ª£c duy·ªát v√† c√¥ng b·ªë tr√™n website.',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
                
                // Reload contributions
                loadContributions();
                
                // Close modal if open
                const modal = bootstrap.Modal.getInstance(document.getElementById('contributionDetailModal'));
                if (modal) modal.hide();
                
            }).catch(error => {
                Swal.fire({
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ duy·ªát c·∫©m nang: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
                console.error('Error approving contribution:', error);
            });
        }

        // Reject contribution
        function rejectContribution(contributionId, reason) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y c·∫©m nang n√†y!', 'error');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'ƒêang x·ª≠ l√Ω...',
                text: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Update contribution status and add rejection reason
            Promise.all([
                db.ref('userContributions/' + contributionId + '/status').set('rejected'),
                db.ref('userContributions/' + contributionId + '/rejectedAt').set(firebase.database.ServerValue.TIMESTAMP),
                db.ref('userContributions/' + contributionId + '/rejectionReason').set(reason)
            ]).then(() => {
                // Send rejection email
                return emailjs.send("service_6spwxxw", "template_vcjlg02", {
                    to_email: contribution.authorEmail,
                    from_name: "Admin LuxuryHavenTravel",
                    title: "C·∫©m nang c·∫ßn ch·ªânh s·ª≠a",
                    message: `C·∫©m nang "${contribution.title}" c·ªßa b·∫°n c·∫ßn ƒë∆∞·ª£c ch·ªânh s·ª≠a theo ph·∫£n h·ªìi sau:\n\n${reason}\n\nVui l√≤ng ch·ªânh s·ª≠a v√† g·ª≠i l·∫°i c·∫©m nang. C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p!`,
                    timestamp: new Date().toLocaleString('vi-VN')
                });
            }).then(() => {
                Swal.fire({
                    title: 'ƒê√£ t·ª´ ch·ªëi!',
                    text: 'Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn t√°c gi·∫£ qua email.',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
                
                // Reload contributions
                loadContributions();
                
                // Close modal if open
                const modal = bootstrap.Modal.getInstance(document.getElementById('contributionDetailModal'));
                if (modal) modal.hide();
                
            }).catch(error => {
                Swal.fire({
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ t·ª´ ch·ªëi c·∫©m nang: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
                console.error('Error rejecting contribution:', error);
            });
        }

        // Generate slug from title
        function generateSlug(title) {
            return title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/[ƒëƒê]/g, 'd')
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Remove multiple hyphens
                .trim('-'); // Remove leading/trailing hyphens
        }

        // Event listeners for contribution modals
        document.addEventListener('DOMContentLoaded', function() {
            // Approve button in detail modal
            const approveBtn = document.getElementById('approveContributionBtn');
            if (approveBtn) {
                approveBtn.addEventListener('click', function() {
                    if (window.currentContribution) {
                        approveContribution(window.currentContribution.id);
                    }
                });
            }

            // Reject button in detail modal
            const rejectBtn = document.getElementById('rejectContributionBtn');
            if (rejectBtn) {
                rejectBtn.addEventListener('click', function() {
                    if (window.currentContribution) {
                        const modal = new bootstrap.Modal(document.getElementById('rejectContributionModal'));
                        modal.show();
                    }
                });
            }

            // Confirm reject button in reject modal
            const confirmRejectBtn = document.getElementById('confirmRejectBtn');
            if (confirmRejectBtn) {
                confirmRejectBtn.addEventListener('click', function() {
                    const reason = document.getElementById('rejectReason').value.trim();
                    if (reason && window.currentContribution) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('rejectContributionModal'));
                        modal.hide();
                        rejectContribution(window.currentContribution.id, reason);
                    }
                });
            }
        });

        // --- Settings Management ---
        function loadSettings() {
            db.ref('settings').once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    document.getElementById('settingWebsiteName').value = settings.websiteName || '';
                    document.getElementById('settingContactEmail').value = settings.contactEmail || '';
                    document.getElementById('settingPhoneNumber').value = settings.phoneNumber || '';
                    document.getElementById('settingAddress').value = settings.address || '';
                } else {
                    console.log("No settings found in Firebase. Using default form values.");
                }
            }).catch(error => {
                console.error("Error loading settings:", error);
                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ t·∫£i c√†i ƒë·∫∑t: ' + error.message, 'error');
            });
        }

        function saveSettings(event) {
            event.preventDefault(); // Prevent form from submitting traditionally
            const settingsData = {
                websiteName: document.getElementById('settingWebsiteName').value,
                contactEmail: document.getElementById('settingContactEmail').value,
                phoneNumber: document.getElementById('settingPhoneNumber').value,
                address: document.getElementById('settingAddress').value
            };

            db.ref('settings').update(settingsData).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: 'C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c l∆∞u.',
                    timer: 1500
                });
            }).catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t: ' + error.message
                });
            });
        }

        // Initialize
        loadLocationChart();
        loadBookings();
        loadHotels();
        loadTours();
        loadDeals();
        loadUsers();
        loadTravelGuides();

        // Initialize things that should only run once
        function initializeApp() {

            // Add event listeners for booking filters
            document.getElementById('bookingSearchInput').addEventListener('input', filterAndDisplayBookings);
            document.getElementById('bookingStatusFilter').addEventListener('change', filterAndDisplayBookings);
            
            // Add event listeners for bulk actions
            document.getElementById('selectAllBookings').addEventListener('change', handleSelectAllBookings);
            document.getElementById('bookingsTable').addEventListener('change', (e) => {
                if (e.target.classList.contains('booking-checkbox')) {
                    updateBulkActionUI();
                }
            });

            document.getElementById('mobile-toggle').addEventListener('click', () => {
                 document.getElementById('sidebar').classList.toggle('active');
            });
            
            updateBulkActionUI(); // Update UI in case filters change selection state
        }

        // --- Bulk Actions for Bookings ---
        function getSelectedBookingIds() {
            return Array.from(document.querySelectorAll('.booking-checkbox:checked')).map(cb => cb.dataset.id);
        }

        function updateBulkActionUI() {
            const selectedIds = getSelectedBookingIds();
            const bulkActionContainer = document.getElementById('bulk-action-container');
            const selectedCountEl = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('selectAllBookings');

            if (selectedIds.length > 0) {
                selectedCountEl.textContent = `${selectedIds.length} ƒë√£ ch·ªçn`;
                bulkActionContainer.classList.remove('d-none');
                bulkActionContainer.classList.add('d-flex');
            } else {
                bulkActionContainer.classList.add('d-none');
                bulkActionContainer.classList.remove('d-flex');
            }

            // Update the "select all" checkbox state
            const totalCheckboxes = document.querySelectorAll('.booking-checkbox').length;
            selectAllCheckbox.checked = totalCheckboxes > 0 && selectedIds.length === totalCheckboxes;
        }
        
        function handleSelectAllBookings(e) {
            const isChecked = e.target.checked;
            document.querySelectorAll('.booking-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkActionUI();
        }

        async function deleteSelectedBookings() {
            const selectedIds = getSelectedBookingIds();
            if (selectedIds.length === 0) {
                Swal.fire("Ch∆∞a ch·ªçn m·ª•c n√†o", "Vui l√≤ng ch·ªçn c√°c m·ª•c b·∫°n mu·ªën x√≥a.", "info");
                return;
            }

            const result = await Swal.fire({
                title: `B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selectedIds.length} m·ª•c?`,
                text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ƒê·ªìng √Ω x√≥a!',
                cancelButtonText: 'H·ªßy'
            });

            if (result.isConfirmed) {
                const deletePromises = selectedIds.map(id => db.ref('bookings/' + id).remove());
                try {
                    await Promise.all(deletePromises);
                    Swal.fire('ƒê√£ x√≥a!', `${selectedIds.length} m·ª•c ƒë√£ ƒë∆∞·ª£c x√≥a.`, 'success');
                    // Data will refresh automatically via the 'on' listener
                } catch (error) {
                    console.error("Error deleting selected bookings: ", error);
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a c√°c m·ª•c ƒë√£ ch·ªçn.', 'error');
                }
            }
        }

        async function updateSelectedStatus() {
            const selectedIds = getSelectedBookingIds();
             if (selectedIds.length === 0) {
                Swal.fire("Ch∆∞a ch·ªçn m·ª•c n√†o", "Vui l√≤ng ch·ªçn c√°c m·ª•c b·∫°n mu·ªën c·∫≠p nh·∫≠t.", "info");
                return;
            }

            const { value: newStatus } = await Swal.fire({
                title: 'Ch·ªçn tr·∫°ng th√°i m·ªõi',
                input: 'select',
                inputOptions: {
                    'pending': 'Ch·ªù x√°c nh·∫≠n',
                    'confirmed': 'ƒê√£ x√°c nh·∫≠n',
                    'cancelled': 'ƒê√£ h·ªßy',
                    'completed': 'Ho√†n th√†nh'
                },
                inputPlaceholder: 'Ch·ªçn m·ªôt tr·∫°ng th√°i',
                showCancelButton: true,
                confirmButtonText: 'C·∫≠p nh·∫≠t',
                cancelButtonText: 'H·ªßy'
            });

            if (newStatus) {
                const updates = {};
                selectedIds.forEach(id => {
                    updates[`/bookings/${id}/status`] = newStatus;
                });

                try {
                    await db.ref().update(updates);
                    Swal.fire('Th√†nh c√¥ng!', `ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i cho ${selectedIds.length} m·ª•c.`, 'success');
                } catch (error) {
                     console.error("Error updating selected statuses: ", error);
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i.', 'error');
                }
            }
        }

        function editBooking(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ƒë·∫∑t ph√≤ng n√†y.', 'error');
                return;
            }
            // Danh s√°ch c√°c tr∆∞·ªùng h·ª£p l·ªá theo rule
            const allowedFields = [
                'bookingType', 'checkIn', 'checkOut', 'createdAt', 'customerEmail', 'customerName', 'customerPhone', 'email',
                'guests', 'hotelId', 'hotelName', 'nights', 'note', 'paymentMethod', 'paymentStatus', 'roomId', 'roomName',
                'roomPrice', 'status', 'totalPrice', 'updatedAt', 'userId',
                // C√°c tr∆∞·ªùng cho tour
                'numberOfGuests', 'tourId', 'tourName', 'tourCategory', 'tourLocation', 'tourDuration', 'tourImage', 'tourType',
                'tourPrice', 'tourDescription', 'tourIncludes', 'tourExcludes', 'tourRating', 'tourReviewsCount'
            ];
            // N·∫øu l√† booking tour
            if (booking.type === 'tour' || booking.bookingType === 'tour') {
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin ƒë·∫∑t tour',
                    html: `
                        <input id="edit-tourName" class="swal2-input" placeholder="T√™n tour" value="${booking.tourName || ''}">
                        <input id="edit-tourLocation" class="swal2-input" placeholder="ƒêi·ªÉm ƒë·∫øn" value="${booking.tourLocation || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="${booking.numberOfGuests || booking.guests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${booking.customerPhone || ''}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        return {
                            tourName: document.getElementById('edit-tourName').value,
                            tourLocation: document.getElementById('edit-tourLocation').value,
                            checkIn: document.getElementById('edit-checkIn').value,
                            numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value),
                            customerName: document.getElementById('edit-customerName').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // L·ªçc d·ªØ li·ªáu c≈© ch·ªâ l·∫•y c√°c tr∆∞·ªùng h·ª£p l·ªá
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // G·ªôp v·ªõi d·ªØ li·ªáu m·ªõi
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('D·ªØ li·ªáu g·ª≠i l√™n Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                            loadBookingsTours();
                            loadBookings(); // ƒê·ªÉ ƒë·ªìng b·ªô n·∫øu c√≥ thay ƒë·ªïi
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        });
                    }
                });
            } else {
                // Booking kh√°ch s·∫°n gi·ªØ nh∆∞ c≈©
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin ƒë·∫∑t ph√≤ng',
                    html: `
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerEmail" class="swal2-input" placeholder="Email" value="${booking.customerEmail || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${booking.customerPhone || ''}">
                        <input id="edit-hotelName" class="swal2-input" placeholder="Kh√°ch s·∫°n" value="${booking.hotelName || ''}">
                        <input id="edit-roomId" class="swal2-input" placeholder="Ph√≤ng" value="${booking.roomId || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-checkOut" class="swal2-input" type="date" value="${booking.checkOut ? booking.checkOut.split('T')[0] : ''}">
                        <input id="edit-guests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="${booking.guests || 1}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const roomIdValue = document.getElementById('edit-roomId').value;
                        return {
                            customerName: document.getElementById('edit-customerName').value,
                            customerEmail: document.getElementById('edit-customerEmail').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            hotelName: document.getElementById('edit-hotelName').value,
                            roomId: roomIdValue,
                            roomName: roomIdValue,
                            checkIn: document.getElementById('edit-checkIn').value,
                            checkOut: document.getElementById('edit-checkOut').value,
                            guests: parseInt(document.getElementById('edit-guests').value),
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // L·ªçc d·ªØ li·ªáu c≈© ch·ªâ l·∫•y c√°c tr∆∞·ªùng h·ª£p l·ªá
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // G·ªôp v·ªõi d·ªØ li·ªáu m·ªõi
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('D·ªØ li·ªáu g·ª≠i l√™n Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        });
                    }
                });
            }
        }

        // === NOTIFICATIONS ===
        function generateNotification(icon, color, text, link = '#') {
            const newNotif = {
                icon: icon, // e.g., 'fas fa-plus'
                color: color, // e.g., 'bg-success'
                text: text,
                link: link,
                read: false,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            db.ref('notifications').push(newNotif);
        }

        function loadNotifications() {
            const notifList = document.getElementById('notificationList');
            const badge = document.getElementById('notificationBell').querySelector('.badge-dot');

            const notificationsRef = db.ref('notifications').orderByChild('timestamp').limitToLast(15);
            
            notificationsRef.on('value', (snapshot) => {
                notifList.innerHTML = '';
                const notifications = [];
                let hasUnread = false;

                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const notif = childSnapshot.val();
                        notif.id = childSnapshot.key;
                        notifications.push(notif);
                        if (!notif.read) {
                            hasUnread = true;
                        }
                    });

                    notifications.reverse(); // Show newest first

                    notifications.forEach(notif => {
                        const item = document.createElement('a');
                        item.href = notif.link || '#';
                        item.className = 'notification-item' + (notif.read ? '' : ' unread');
                        item.dataset.id = notif.id;

                        item.innerHTML = `
                            <div class="icon ${notif.color || 'bg-primary'}">
                                <i class="${notif.icon || 'fas fa-info'}"></i>
                            </div>
                            <div class="content">
                                <p>${notif.text}</p>
                                <span class="timestamp">${new Date(notif.timestamp).toLocaleString('vi-VN')}</span>
                            </div>
                        `;
                        notifList.appendChild(item);
                    });

                } else {
                     notifList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No new notifications</p>
                         </div>`;
                }
                
                // Update badge visibility
                badge.style.display = hasUnread ? 'block' : 'none';
            });
        }

        function markNotificationsAsRead() {
            const notificationsRef = db.ref('notifications');
            notificationsRef.orderByChild('read').equalTo(false).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const updates = {};
                    snapshot.forEach(childSnapshot => {
                        updates[childSnapshot.key + '/read'] = true;
                    });
                    notificationsRef.update(updates);
                }
            });
        }

        function updateMissingRoomId() {
          Swal.fire({
            title: 'C·∫≠p nh·∫≠t d·ªØ li·ªáu ph√≤ng?',
            text: 'T·ª± ƒë·ªông c·∫≠p nh·∫≠t t·∫•t c·∫£ booking b·ªã thi·∫øu tr∆∞·ªùng Ph√≤ng th√†nh "Ch∆∞a c·∫≠p nh·∫≠t". B·∫°n c√≥ ch·∫Øc mu·ªën th·ª±c hi·ªán?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'C·∫≠p nh·∫≠t',
            cancelButtonText: 'H·ªßy'
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').once('value').then(snapshot => {
                let count = 0;
                snapshot.forEach(child => {
                  const data = child.val();
                  if (!data.roomId || !String(data.roomId).trim()) {
                    db.ref('bookings/' + child.key).update({ roomId: 'Ch∆∞a c·∫≠p nh·∫≠t' });
                    count++;
                  }
                });
                Swal.fire('Th√†nh c√¥ng', `ƒê√£ c·∫≠p nh·∫≠t ${count} booking b·ªã thi·∫øu tr∆∞·ªùng Ph√≤ng!`, 'success');
                loadBookings();
              });
            }
          });
        }

        function updateRoomIdKhongXacDinh() {
          Swal.fire({
            title: 'C·∫≠p nh·∫≠t ph√≤ng "Kh√¥ng x√°c ƒë·ªãnh"?',
            text: 'T·ª± ƒë·ªông c·∫≠p nh·∫≠t t·∫•t c·∫£ booking c√≥ tr∆∞·ªùng Ph√≤ng l√† "Kh√¥ng x√°c ƒë·ªãnh" th√†nh "Ph√≤ng ch∆∞a ƒë·∫∑t". B·∫°n c√≥ ch·∫Øc mu·ªën th·ª±c hi·ªán?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'C·∫≠p nh·∫≠t',
            cancelButtonText: 'H·ªßy'
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').once('value').then(snapshot => {
                let count = 0;
                snapshot.forEach(child => {
                  const data = child.val();
                  if (data.roomId && data.roomId.trim() === 'Kh√¥ng x√°c ƒë·ªãnh') {
                    db.ref('bookings/' + child.key).update({ roomId: 'Ph√≤ng ch∆∞a ƒë·∫∑t' });
                    count++;
                  }
                });
                Swal.fire('Th√†nh c√¥ng', `ƒê√£ c·∫≠p nh·∫≠t ${count} booking c√≥ ph√≤ng "Kh√¥ng x√°c ƒë·ªãnh"!`, 'success');
                loadBookings();
              });
                }
            });
        }

        // JS: Th√™m h√†m loadBookingsTours ƒë·ªÉ l·ªçc v√† render c√°c booking tour
        function loadBookingsTours() {
          const tableBody = document.getElementById('bookingsToursTable');
          tableBody.innerHTML = '';
          // L·ªçc booking tour theo c·∫£ type v√† bookingType
          const tourBookings = allBookings.filter(b => b.type === 'tour' || b.bookingType === 'tour');
          if (tourBookings.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-5">Kh√¥ng c√≥ booking tour n√†o.</td></tr>';
            return;
          }
          tourBookings.forEach(booking => {
            const row = document.createElement('tr');
            const statusBadge = `<span class="status status-${booking.status || 'pending'}">${booking.status || 'Ch·ªù x√°c nh·∫≠n'}</span>`;
            row.innerHTML = `
              <td>${booking.id}</td>
              <td>${booking.customerName || 'N/A'}</td>
              <td>${booking.customerEmail || 'N/A'}</td>
              <td>${booking.customerPhone || 'N/A'}</td>
              <td>${booking.tourName || 'Tour'}</td>
              <td>${booking.tourLocation || 'N/A'}</td>
              <td>${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</td>
              <td>${booking.numberOfGuests || booking.guests || 'N/A'}</td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="editBooking('${booking.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking.id}')"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        }

        // JS: Th√™m h√†m addTourBooking
        function addTourBooking() {
          db.ref('specialTours').once('value').then(snapshot => {
            const tours = [];
            snapshot.forEach(groupSnap => {
              const group = groupSnap.val();
              Object.values(group).forEach(tour => {
                tours.push({
                  name: tour.name || '',
                  location: tour.location || ''
                });
              });
            });
            showAddTourBookingPopup(tours);
          });
        }

        function showAddTourBookingPopup(tours) {
          let tourOptions = tours.map(t => `<option value="${t.name}" data-location="${t.location}">${t.name}</option>`).join('');
          Swal.fire({
            title: 'Th√™m ƒë·∫∑t tour m·ªõi',
            html: `
              <div style="display: flex; flex-direction: column; gap: 12px;">
                <select id="add-tourName" class="swal2-input" style="width: 100%"><option value="">Ch·ªçn tour</option>${tourOptions}</select>
                <input id="add-tourLocation" class="swal2-input" placeholder="ƒêi·ªÉm ƒë·∫øn" readonly>
                <input id="add-checkIn" class="swal2-input" type="date">
                <input id="add-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="1">
                <input id="add-customerName" class="swal2-input" placeholder="T√™n kh√°ch">
                <input id="add-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                <select id="add-status" class="swal2-input" style="width: 100%">
                  <option value="pending">Ch·ªù x√°c nh·∫≠n</option>
                  <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                  <option value="cancelled">ƒê√£ h·ªßy</option>
                  <option value="completed">Ho√†n th√†nh</option>
                </select>
              </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'L∆∞u',
            cancelButtonText: 'H·ªßy',
            didOpen: () => {
              const tourSelect = document.getElementById('add-tourName');
              const locationInput = document.getElementById('add-tourLocation');
              tourSelect.addEventListener('change', function() {
                const selected = tourSelect.options[tourSelect.selectedIndex];
                locationInput.value = selected.getAttribute('data-location') || '';
              });
            },
            preConfirm: () => {
              const tourSelect = document.getElementById('add-tourName');
              const locationInput = document.getElementById('add-tourLocation');
              return {
                tourName: tourSelect.value,
                tourLocation: locationInput.value,
                checkIn: document.getElementById('add-checkIn').value,
                numberOfGuests: parseInt(document.getElementById('add-numberOfGuests').value),
                customerName: document.getElementById('add-customerName').value,
                customerPhone: document.getElementById('add-customerPhone').value,
                status: document.getElementById('add-status').value,
                type: 'tour',
                createdAt: new Date().toISOString()
              };
            }
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').push(result.value).then(() => {
                Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m ƒë·∫∑t tour m·ªõi!', 'success');
                loadBookingsTours();
              }).catch(() => {
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ th√™m ƒë·∫∑t tour.', 'error');
              });
                }
            });
        }

        // ===== QU·∫¢N L√ù HO√ÄN TI·ªÄN =====
        function loadRefunds() {
            const refundsTable = document.getElementById('refundsTable');
            if (!refundsTable) return;

            refundsTable.innerHTML = '<tr><td colspan="8" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>';

            db.ref('bookings').orderByChild('status').equalTo('cancelled').once('value').then(snapshot => {
                const refunds = [];
                snapshot.forEach(child => {
                    const booking = child.val();
                    if (booking.refundStatus) { // Ch·ªâ hi·ªÉn th·ªã booking c√≥ th√¥ng tin ho√†n ti·ªÅn
                        refunds.push({
                            id: child.key,
                            ...booking
                        });
                    }
                });

                // S·∫Øp x·∫øp theo th·ªùi gian h·ªßy m·ªõi nh·∫•t
                refunds.sort((a, b) => b.cancelledAt - a.cancelledAt);

                if (refunds.length === 0) {
                    refundsTable.innerHTML = '<tr><td colspan="8" class="text-center py-4">Kh√¥ng c√≥ y√™u c·∫ßu ho√†n ti·ªÅn n√†o.</td></tr>';
                    return;
                }

                refundsTable.innerHTML = '';
                                    refunds.forEach(refund => {
                        const row = document.createElement('tr');
                        const statusBadge = getRefundStatusBadge(refund.refundStatus);
                        const refundAmount = refund.refundAmount || 0;
                        const totalPrice = refund.totalPrice || refund.roomPrice || 0;
                        
                        // T·∫°o n√∫t thao t√°c ph√π h·ª£p v·ªõi tr·∫°ng th√°i
                        let actionButtons = '';
                        if (refund.refundStatus === 'pending') {
                            actionButtons = `
                                <button class="btn btn-sm btn-success" onclick="processRefund('${refund.id}')" title="X·ª≠ l√Ω ho√†n ti·ªÅn">
                                    <i class="fas fa-money-bill-wave"></i> X·ª≠ l√Ω
                                </button>
                            `;
                        } else if (refund.refundStatus === 'processing') {
                            actionButtons = `
                                <button class="btn btn-sm btn-warning" disabled title="ƒêang x·ª≠ l√Ω">
                                    <i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω
                                </button>
                            `;
                        } else if (refund.refundStatus === 'failed') {
                            actionButtons = `
                                <button class="btn btn-sm btn-success" onclick="processRefund('${refund.id}')" title="Th·ª≠ l·∫°i">
                                    <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
                                </button>
                            `;
                        } else if (refund.refundStatus === 'completed') {
                            actionButtons = `
                                <button class="btn btn-sm btn-secondary" disabled title="ƒê√£ ho√†n ti·ªÅn">
                                    <i class="fas fa-check-circle"></i> ƒê√£ ho√†n
                                </button>
                            `;
                        }
                        
                        row.innerHTML = `
                            <td>${refund.id}</td>
                            <td>${refund.customerName || refund.userName || 'N/A'}</td>
                            <td>${refund.customerEmail || refund.email || 'N/A'}</td>
                            <td>${refund.hotelName || refund.tourName || 'N/A'}</td>
                            <td>${totalPrice.toLocaleString()} VNƒê</td>
                            <td>${refundAmount.toLocaleString()} VNƒê</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${actionButtons}
                                <button class="btn btn-sm btn-info" onclick="viewRefundDetails('${refund.id}')" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i> Chi ti·∫øt
                                </button>
                            </td>
                        `;
                        refundsTable.appendChild(row);
                    });
            });
        }

        function getRefundStatusBadge(status) {
            const statusMap = {
                'pending': '<span class="badge bg-warning">Ch·ªù x·ª≠ l√Ω</span>',
                'processing': '<span class="badge bg-info">ƒêang x·ª≠ l√Ω</span>',
                'completed': '<span class="badge bg-success">ƒê√£ ho√†n ti·ªÅn</span>',
                'failed': '<span class="badge bg-danger">Th·∫•t b·∫°i</span>'
            };
            return statusMap[status] || '<span class="badge bg-secondary">Kh√¥ng x√°c ƒë·ªãnh</span>';
        }

        function getRefundStatusText(status) {
            const statusMap = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'processing': 'ƒêang x·ª≠ l√Ω',
                'completed': 'ƒê√£ ho√†n ti·ªÅn',
                'failed': 'Th·∫•t b·∫°i'
            };
            return statusMap[status] || 'Kh√¥ng x√°c ƒë·ªãnh';
        }

        function processRefund(bookingId) {
            Swal.fire({
                title: 'Ch·ªçn ph∆∞∆°ng th·ª©c ho√†n ti·ªÅn',
                text: 'B·∫°n mu·ªën ho√†n ti·ªÅn b·∫±ng ph∆∞∆°ng th·ª©c n√†o?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ho√†n ti·ªÅn t·ª± ƒë·ªông (VNPay)',
                cancelButtonText: 'Ho√†n ti·ªÅn th·ªß c√¥ng',
                showDenyButton: true,
                denyButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Ho√†n ti·ªÅn t·ª± ƒë·ªông qua VNPay
                    processAutomaticRefund(bookingId);
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    // Ho√†n ti·ªÅn th·ªß c√¥ng
                    processManualRefund(bookingId);
                }
            });
        }

        // Ho√†n ti·ªÅn t·ª± ƒë·ªông qua VNPay
        async function processAutomaticRefund(bookingId) {
            try {
                Swal.fire({
                    title: 'ƒêang x·ª≠ l√Ω ho√†n ti·ªÅn...',
                    text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // L·∫•y th√¥ng tin booking
                const snapshot = await db.ref('bookings/' + bookingId).once('value');
                const booking = snapshot.val();

                if (!booking) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin booking');
                }

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh processing
                await db.ref('bookings/' + bookingId).update({
                    refundStatus: 'processing',
                    refundProcessingAt: Date.now()
                });

                // Gi·∫£ l·∫≠p ho√†n ti·ªÅn VNPay (trong th·ª±c t·∫ø s·∫Ω g·ªçi API VNPay)
                await new Promise(resolve => setTimeout(resolve, 2000)); // Gi·∫£ l·∫≠p delay

                // Gi·∫£ l·∫≠p k·∫øt qu·∫£ th√†nh c√¥ng (lu√¥n th√†nh c√¥ng cho demo)
                const success = true; // Lu√¥n th√†nh c√¥ng cho demo

                if (success) {
                    await db.ref('bookings/' + bookingId).update({
                        refundStatus: 'completed',
                        refundCompletedAt: Date.now(),
                        refundTransactionId: `VNPAY_${Date.now()}`,
                        refundMethod: 'vnpay_automatic'
                    });

                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ ho√†n ti·ªÅn t·ª± ƒë·ªông qua VNPay!', 'success');
                } else {
                    await db.ref('bookings/' + bookingId).update({
                        refundStatus: 'failed',
                        refundFailedAt: Date.now(),
                        refundErrorMessage: 'Ho√†n ti·ªÅn th·∫•t b·∫°i - Vui l√≤ng th·ª≠ l·∫°i'
                    });

                    Swal.fire('Th·∫•t b·∫°i', 'Ho√†n ti·ªÅn t·ª± ƒë·ªông th·∫•t b·∫°i. Vui l√≤ng th·ª≠ ho√†n ti·ªÅn th·ªß c√¥ng.', 'error');
                }

                loadRefunds();
            } catch (error) {
                console.error('L·ªói khi ho√†n ti·ªÅn t·ª± ƒë·ªông:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x·ª≠ l√Ω ho√†n ti·ªÅn t·ª± ƒë·ªông: ' + error.message, 'error');
            }
        }

        // Ho√†n ti·ªÅn th·ªß c√¥ng
        async function processManualRefund(bookingId) {
            try {
                Swal.fire({
                    title: 'X√°c nh·∫≠n ho√†n ti·ªÅn th·ªß c√¥ng?',
                    text: 'B·∫°n c√≥ ch·∫Øc ƒë√£ ho√†n ti·ªÅn cho kh√°ch h√†ng?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'X√°c nh·∫≠n',
                    cancelButtonText: 'H·ªßy'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await db.ref('bookings/' + bookingId).update({
                            refundStatus: 'completed',
                            refundCompletedAt: Date.now(),
                            refundMethod: 'manual_bank_transfer',
                            refundNote: 'Admin x√°c nh·∫≠n ƒë√£ ho√†n ti·ªÅn th·ªß c√¥ng'
                        });

                        Swal.fire('Th√†nh c√¥ng', 'ƒê√£ x√°c nh·∫≠n ho√†n ti·ªÅn th·ªß c√¥ng!', 'success');
                        loadRefunds();
                    }
                });
            } catch (error) {
                console.error('L·ªói khi ho√†n ti·ªÅn th·ªß c√¥ng:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n ti·ªÅn.', 'error');
            }
        }

        function viewRefundDetails(bookingId) {
            db.ref('bookings/' + bookingId).once('value').then(snapshot => {
                const booking = snapshot.val();
                if (!booking) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y th√¥ng tin booking.', 'error');
                    return;
                }

                const refundAmount = booking.refundAmount || 0;
                const totalPrice = booking.totalPrice || booking.roomPrice || 0;
                const refundPercentage = totalPrice > 0 ? ((refundAmount / totalPrice) * 100).toFixed(1) : 0;
                
                // Th√¥ng tin th·ªùi gian
                const cancelledDate = booking.cancelledAt ? new Date(booking.cancelledAt).toLocaleString('vi-VN') : 'N/A';
                const processingDate = booking.refundProcessingAt ? new Date(booking.refundProcessingAt).toLocaleString('vi-VN') : 'N/A';
                const completedDate = booking.refundCompletedAt ? new Date(booking.refundCompletedAt).toLocaleString('vi-VN') : 'N/A';
                const failedDate = booking.refundFailedAt ? new Date(booking.refundFailedAt).toLocaleString('vi-VN') : 'N/A';
                
                // Th√¥ng tin ph∆∞∆°ng th·ª©c ho√†n ti·ªÅn
                const refundMethod = booking.refundMethod || 'Ch∆∞a x√°c ƒë·ªãnh';
                const transactionId = booking.refundTransactionId || 'N/A';
                const errorMessage = booking.refundErrorMessage || '';
                const refundNote = booking.refundNote || 'N/A';

                Swal.fire({
                    title: 'Chi ti·∫øt ho√†n ti·ªÅn',
                    html: `
                        <div class="text-left">
                            <h6 class="mb-3">Th√¥ng tin booking</h6>
                            <p><strong>Booking ID:</strong> ${bookingId}</p>
                            <p><strong>Kh√°ch h√†ng:</strong> ${booking.customerName || booking.userName || 'N/A'}</p>
                            <p><strong>Email:</strong> ${booking.customerEmail || booking.email || 'N/A'}</p>
                            <p><strong>D·ªãch v·ª•:</strong> ${booking.hotelName || booking.tourName || 'N/A'}</p>
                            <p><strong>T·ªïng ti·ªÅn:</strong> ${totalPrice.toLocaleString()} VNƒê</p>
                            
                            <hr>
                            <h6 class="mb-3">Th√¥ng tin ho√†n ti·ªÅn</h6>
                            <p><strong>S·ªë ti·ªÅn ho√†n:</strong> ${refundAmount.toLocaleString()} VNƒê (${refundPercentage}%)</p>
                            <p><strong>Tr·∫°ng th√°i:</strong> ${getRefundStatusText(booking.refundStatus)}</p>
                            <p><strong>Ph∆∞∆°ng th·ª©c:</strong> ${refundMethod}</p>
                            <p><strong>M√£ giao d·ªãch:</strong> ${transactionId}</p>
                            
                            <hr>
                            <h6 class="mb-3">Th·ªùi gian</h6>
                            <p><strong>Ng√†y h·ªßy:</strong> ${cancelledDate}</p>
                            <p><strong>B·∫Øt ƒë·∫ßu x·ª≠ l√Ω:</strong> ${processingDate}</p>
                            <p><strong>Ho√†n th√†nh:</strong> ${completedDate}</p>
                            <p><strong>Th·∫•t b·∫°i:</strong> ${failedDate}</p>
                            
                            ${errorMessage ? `
                                <hr>
                                <h6 class="mb-3">L·ªói</h6>
                                <p class="text-danger"><strong>L·ªói:</strong> ${errorMessage}</p>
                            ` : ''}
                            
                            ${refundNote !== 'N/A' ? `
                                <hr>
                                <h6 class="mb-3">Ghi ch√∫</h6>
                                <p><strong>Ghi ch√∫:</strong> ${refundNote}</p>
                            ` : ''}
                        </div>
                    `,
                    width: '600px',
                    icon: 'info',
                    confirmButtonText: 'ƒê√≥ng'
                });
            });
        }

        // H√†m t·ªïng h·ª£p s·ªë li·ªáu theo th√°ng (tr·∫£ v·ªÅ object)
        async function getMonthlyStats(month, year) {
          const start = new Date(year, month - 1, 1).getTime();
          const end = new Date(year, month, 0, 23, 59, 59, 999).getTime();
          // 1. L·∫•y users
          const usersSnap = await db.ref('users').once('value');
          let newUsers = 0;
          usersSnap.forEach(userSnap => {
            const user = userSnap.val();
            if (user.createdAt && user.createdAt >= start && user.createdAt <= end) newUsers++;
          });
          // 2. L·∫•y bookings
          const bookingsSnap = await db.ref('bookings').once('value');
          const roomSet = new Set();
          const userIds = new Set();
          let revenue = 0;
          bookingsSnap.forEach(bookingSnap => {
            const booking = bookingSnap.val();
            if (booking.createdAt >= start && booking.createdAt <= end) {
              userIds.add(booking.userId);
              if ((booking.status === 'confirmed' || booking.status === 'completed')) {
                roomSet.add(`${booking.hotelId}_${booking.roomId}`);
                revenue += booking.totalPrice || 0;
              }
            }
          });
          // 3. Th·ªëng k√™ gi·ªõi t√≠nh
          let male = 0, female = 0, other = 0;
          userIds.forEach(uid => {
            const user = usersSnap.child(uid).val();
            if (user && user.gender) {
              if (user.gender === 'Nam') male++;
              else if (user.gender === 'N·ªØ') female++;
              else other++;
            } else {
              other++;
            }
          });
          return {
            newUsers,
            roomsBooked: roomSet.size,
            gender: { male, female, other },
            revenue
          };
        }

        // H√†m t√≠nh % thay ƒë·ªïi so v·ªõi th√°ng tr∆∞·ªõc
        function calcChange(current, prev) {
          if (prev === 0 && current === 0) return {percent: 0, up: false};
          if (prev === 0) return {percent: 100, up: true};
          const percent = Math.round(((current - prev) / prev) * 100);
          return {percent: Math.abs(percent), up: current >= prev};
        }

        // C·∫≠p nh·∫≠t giao di·ªán th·ªëng k√™ v√† so s√°nh th√°ng tr∆∞·ªõc
        async function updateMonthlyStatsUI() {
          const month = parseInt(document.getElementById('stat-month').value);
          const year = parseInt(document.getElementById('stat-year').value);
          document.getElementById('stat-month-label').textContent = month;
          document.getElementById('stat-year-label').textContent = year;
          const stats = await getMonthlyStats(month, year);
          // Th√°ng tr∆∞·ªõc
          let prevMonth = month - 1, prevYear = year;
          if (prevMonth === 0) { prevMonth = 12; prevYear = year - 1; }
          const prevStats = await getMonthlyStats(prevMonth, prevYear);
          // Hi·ªÉn th·ªã s·ªë li·ªáu hi·ªán t·∫°i
          document.getElementById('stat-new-users').textContent = stats.newUsers;
          document.getElementById('stat-rooms-booked').textContent = stats.roomsBooked;
          document.getElementById('stat-gender').textContent = `${stats.gender.male}/${stats.gender.female}/${stats.gender.other}`;
          document.getElementById('stat-revenue').textContent = stats.revenue.toLocaleString('vi-VN');
          // Hi·ªÉn th·ªã % thay ƒë·ªïi
          function renderChange(el, change) {
            if (!el) return;
            if (change.percent === 0) {
              el.innerHTML = '<span style="color:#888">0%</span>';
            } else {
              el.innerHTML = `<span style="color:${change.up ? '#43a047' : '#e53935'};font-weight:600"><i class="fas fa-arrow-${change.up ? 'up' : 'down'}"></i> ${change.percent}%</span>`;
            }
          }
          renderChange(document.getElementById('stat-new-users-change'), calcChange(stats.newUsers, prevStats.newUsers));
          renderChange(document.getElementById('stat-rooms-booked-change'), calcChange(stats.roomsBooked, prevStats.roomsBooked));
          renderChange(document.getElementById('stat-gender-male-change'), calcChange(stats.gender.male, prevStats.gender.male));
          renderChange(document.getElementById('stat-revenue-change'), calcChange(stats.revenue, prevStats.revenue));
          // L∆∞u l·∫°i ƒë·ªÉ xu·∫•t Excel
          window._lastMonthlyStats = { month, year, ...stats };
          // K√≠ch ho·∫°t tooltip Bootstrap
          if (window.bootstrap && window.bootstrap.Tooltip) {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
              new bootstrap.Tooltip(el);
            });
          }
          // V·∫Ω mini chart doanh thu 12 th√°ng g·∫ßn nh·∫•t
          await renderMiniRevenueChart(month, year);
        }

        document.getElementById('stat-month').addEventListener('change', updateMonthlyStatsUI);
        document.getElementById('stat-year').addEventListener('change', updateMonthlyStatsUI);
        window.addEventListener('DOMContentLoaded', updateMonthlyStatsUI);

        // Xu·∫•t Excel
        function exportStatsToExcel() {
          const stats = window._lastMonthlyStats;
          if (!stats) return;
          const wsData = [
            ['Th·ªëng k√™ th√°ng', `${stats.month}/${stats.year}`],
            ['S·ªë kh√°ch m·ªõi', stats.newUsers],
            ['S·ªë ph√≤ng c√≥ ng∆∞·ªùi ƒë·∫∑t', stats.roomsBooked],
            ['Gi·ªõi t√≠nh (Nam/N·ªØ/Kh√°c)', `${stats.gender.male}/${stats.gender.female}/${stats.gender.other}`],
            ['Doanh thu (VNƒê)', stats.revenue]
          ];
          const ws = XLSX.utils.aoa_to_sheet(wsData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Th·ªëng k√™');
          XLSX.writeFile(wb, `ThongKe_${stats.month}_${stats.year}.xlsx`);
        }
        document.getElementById('export-excel-btn').addEventListener('click', exportStatsToExcel);

        // V·∫Ω mini chart doanh thu 12 th√°ng g·∫ßn nh·∫•t
        async function renderMiniRevenueChart(selectedMonth, selectedYear) {
          const canvas = document.getElementById('mini-revenue-chart');
          if (!canvas) return;
          if (miniRevenueChartInstance) { miniRevenueChartInstance.destroy(); miniRevenueChartInstance = null; }
          // L·∫•y d·ªØ li·ªáu 12 th√°ng g·∫ßn nh·∫•t
          const now = new Date(selectedYear, selectedMonth - 1);
          const labels = [];
          const data = [];
          for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            labels.push(`${d.getMonth() + 1}/${d.getFullYear().toString().slice(-2)}`);
            const stats = await getMonthlyStats(d.getMonth() + 1, d.getFullYear());
            data.push(Math.round(stats.revenue / 1000000)); // Tri·ªáu VNƒê
          }
          const ctx = canvas.getContext('2d');
          miniRevenueChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                data,
                borderColor: '#43e97b',
                backgroundColor: 'rgba(67,233,123,0.08)',
                tension: 0.4,
                pointRadius: 0,
                fill: true,
                borderWidth: 2
              }]
            },
            options: {
              plugins: { legend: { display: false } },
              scales: { x: { display: false }, y: { display: false } },
              elements: { line: { borderJoinStyle: 'round' } },
              responsive: false,
              maintainAspectRatio: false
            }
          });
        }

        // Popup chi ti·∫øt doanh thu t·ª´ng ng√†y khi click v√†o card doanh thu
        const revenueCard = document.querySelector('.stats-summary-card.revenue');
        if (revenueCard) {
          revenueCard.style.cursor = 'pointer';
          revenueCard.addEventListener('click', async () => {
            const month = parseInt(document.getElementById('stat-month').value);
            const year = parseInt(document.getElementById('stat-year').value);
            // L·∫•y doanh thu t·ª´ng ng√†y trong th√°ng
            const start = new Date(year, month - 1, 1).getTime();
            const end = new Date(year, month, 0, 23, 59, 59, 999).getTime();
            const bookingsSnap = await db.ref('bookings').once('value');
            const dailyRevenue = {};
            for (let d = 1; d <= new Date(year, month, 0).getDate(); d++) dailyRevenue[d] = 0;
            bookingsSnap.forEach(bookingSnap => {
              const booking = bookingSnap.val();
              if (
                booking.createdAt >= start && booking.createdAt <= end &&
                (booking.status === 'confirmed' || booking.status === 'completed')
              ) {
                const date = new Date(booking.createdAt);
                const day = date.getDate();
                dailyRevenue[day] += booking.totalPrice || 0;
              }
            });
            // Hi·ªÉn th·ªã popup v·ªõi bi·ªÉu ƒë·ªì c·ªôt
            const days = Object.keys(dailyRevenue);
            const values = Object.values(dailyRevenue).map(v => Math.round(v / 1000)); // Ngh√¨n VNƒê
            const popupId = 'popup-daily-revenue-chart';
            Swal.fire({
              title: `Chi ti·∫øt doanh thu t·ª´ng ng√†y th√°ng ${month}/${year}`,
              html: `<canvas id="${popupId}" height="220"></canvas>`,
              width: 700,
              showCloseButton: true,
              didOpen: () => {
                const ctx = document.getElementById(popupId).getContext('2d');
                new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: days,
                    datasets: [{
                      label: 'Doanh thu (ngh√¨n VNƒê)',
                      data: values,
                      backgroundColor: '#43e97b',
                      borderRadius: 6
                    }]
                  },
                  options: {
                    plugins: { legend: { display: false } },
                    scales: { x: { title: { display: true, text: 'Ng√†y' } }, y: { title: { display: true, text: 'Ngh√¨n VNƒê' } } },
                    responsive: true,
                    maintainAspectRatio: false
                  }
                });
              }
            });
          });
        }

        // S·ª± ki·ªán click card 'Ph√≤ng c√≥ ng∆∞·ªùi'
        document.querySelector('.stats-summary-card .fa-bed').closest('.stats-summary-card').addEventListener('click', async function() {
          const month = parseInt(document.getElementById('stat-month').value);
          const year = parseInt(document.getElementById('stat-year').value);
          // T√≠nh ng√†y ƒë·∫ßu v√† cu·ªëi th√°ng d·∫°ng YYYY-MM-DD
          const startDate = new Date(year, month - 1, 1);
          const endDate = new Date(year, month, 0);
          function parseDate(str) {
            // str: YYYY-MM-DD
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
          }
          // L·∫•y bookings h·ª£p l·ªá (ch·ªâ lo·∫°i tr·ª´ cancelled/rejected)
          const bookingsSnap = await db.ref('bookings').once('value');
          const bookings = [];
          bookingsSnap.forEach(snap => {
            const b = snap.val();
            const status = (b.status || '').toLowerCase();
            if (status !== 'cancelled' && status !== 'rejected' && b.checkIn) {
              let checkInDate;
              if (typeof b.checkIn === 'string' && b.checkIn.match(/^\d{4}-\d{2}-\d{2}$/)) {
                checkInDate = parseDate(b.checkIn);
              } else if (typeof b.checkIn === 'number') {
                checkInDate = new Date(b.checkIn);
              }
              if (checkInDate && checkInDate >= startDate && checkInDate <= endDate) {
                bookings.push({...b, id: snap.key});
              }
            }
          });
          // L·∫•y th√¥ng tin kh√°ch s·∫°n/ph√≤ng
          const hotelNames = {};
          const roomNames = {};
          for (const b of bookings) {
            if (b.hotelId && !hotelNames[b.hotelId]) {
              const hSnap = await db.ref('hotels/' + b.hotelId).once('value');
              hotelNames[b.hotelId] = hSnap.exists() ? hSnap.val().name : (b.hotelName || b.hotelId);
            }
            if (b.roomId && !roomNames[b.roomId]) {
              roomNames[b.roomId] = b.roomId;
            }
          }
          // Render b·∫£ng
          const tbody = document.getElementById('occupiedRoomsTableBody');
          tbody.innerHTML = bookings.map(b => `
            <tr>
              <td>${b.hotelId ? (hotelNames[b.hotelId] || b.hotelName || b.hotelId) : '<span class="text-danger">Thi·∫øu d·ªØ li·ªáu</span>'}</td>
              <td>${b.roomId ? (roomNames[b.roomId] || b.roomId) : '<span class="text-danger">Thi·∫øu d·ªØ li·ªáu</span>'}</td>
              <td>${b.customerName || b.guestName || ''}</td>
              <td>${b.checkIn ? (typeof b.checkIn === 'string' ? b.checkIn : (new Date(b.checkIn)).toLocaleDateString()) : '<span class="text-danger">Thi·∫øu d·ªØ li·ªáu</span>'}</td>
              <td>${b.checkOut ? (typeof b.checkOut === 'string' ? b.checkOut : (new Date(b.checkOut)).toLocaleDateString()) : ''}</td>
              <td>${b.status || ''}</td>
            </tr>
          `).join('');
          // M·ªü modal
          const modal = new bootstrap.Modal(document.getElementById('occupiedRoomsModal'));
          modal.show();
        });
    </script>

    <!-- Modal chi ti·∫øt c·∫©m nang -->
    <div class="modal fade" id="contributionDetailModal" tabindex="-1" aria-labelledby="contributionDetailModalLabel">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contributionDetailModalLabel">Chi ti·∫øt c·∫©m nang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    <div id="contribution-detail-content">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-danger" id="rejectContributionBtn">
                        <i class="fas fa-times"></i> T·ª´ ch·ªëi
                    </button>
                    <button type="button" class="btn btn-success" id="approveContributionBtn">
                        <i class="fas fa-check"></i> Duy·ªát & C√¥ng b·ªë
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal t·ª´ ch·ªëi c·∫©m nang -->
    <div class="modal fade" id="rejectContributionModal" tabindex="-1" aria-labelledby="rejectContributionModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectContributionModalLabel">T·ª´ ch·ªëi c·∫©m nang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">L√Ω do t·ª´ ch·ªëi *</label>
                        <textarea class="form-control" id="rejectReason" rows="4" 
                            placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi ƒë·ªÉ g·ª≠i ph·∫£n h·ªìi cho t√°c gi·∫£..."></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>L∆∞u √Ω:</strong> L√Ω do t·ª´ ch·ªëi s·∫Ω ƒë∆∞·ª£c g·ª≠i email cho t√°c gi·∫£ ƒë·ªÉ h·ªç c√≥ th·ªÉ ch·ªânh s·ª≠a v√† g·ª≠i l·∫°i.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                        <i class="fas fa-times"></i> X√°c nh·∫≠n t·ª´ ch·ªëi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chi ti·∫øt ph√≤ng c√≥ ng∆∞·ªùi -->
    <div class="modal fade" id="occupiedRoomsModal" tabindex="-1" aria-labelledby="occupiedRoomsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="occupiedRoomsModalLabel">Danh s√°ch ph√≤ng c√≥ ng∆∞·ªùi ƒë·∫∑t trong th√°ng</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>T√™n kh√°ch s·∫°n</th>
                    <th>S·ªë ph√≤ng</th>
                    <th>T√™n kh√°ch</th>
                    <th>Ng√†y nh·∫≠n</th>
                    <th>Ng√†y tr·∫£</th>
                    <th>Tr·∫°ng th√°i</th>
                  </tr>
                </thead>
                <tbody id="occupiedRoomsTableBody">
                  <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mobile JavaScript -->
    <script src="js/mobile.js"></script>
</body>

</html>