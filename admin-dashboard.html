<!DOCTYPE html>
<html lang="vi">
    

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxuryHavenTravel Admin Dashboard</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Local CSS -->
    <link rel="stylesheet" href="css/admin-dashboard.css">
    <link rel="stylesheet" href="css/admin-dashboard-mobile.css">
    <link rel="stylesheet" href="css/mobile.css">
    
    <!-- Custom CSS for table responsiveness -->
    <style>
        .table-responsive {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table-responsive table {
            min-width: 1000px; /* Ensure minimum width for all columns */
        }
        
        .table thead th {
            background-color: #f8f9fa !important;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .table tbody td {
            vertical-align: middle;
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Custom scrollbar for table */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .btn-group-sm .btn {
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body class="admin-body">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-brand">
                <!-- <i class="fas fa-gem me-2"></i> Example Logo Icon -->
                <span>ADMIN LuxuryHavenTravel</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-group">
                <span class="nav-group-title">MAIN</span>
            <a href="#dashboard" class="nav-item active">
                    <i class="fas fa-home-alt"></i> <span>Dashboard</span>
            </a>
            </div>
            <div class="nav-group">
                <span class="nav-group-title">QUẢN LÝ</span>
            <a href="#staff-management" class="nav-item">
            <i class="fas fa-users-cog"></i><span>Quản lý nhân viên</span>
         </a>
            <a href="#roles-management" class="nav-item">
                <i class="fas fa-user-shield"></i> <span>Quản lý chức vụ</span>
            </a>
            <a href="#departments-management" class="nav-item">
                <i class="fas fa-building"></i> <span>Quản lý phòng ban</span>
            </a>
            <a href="#bookings" class="nav-item">
                <i class="fas fa-bed"></i><span>Đặt phòng</span>
             </a>
            <a href="#bookings-tours" class="nav-item">
                <i class="fas fa-route"></i> <span>Đặt tours</span>
            </a>
            <a href="#hotels" class="nav-item">
                    <i class="fas fa-hotel"></i> <span>Khách sạn</span>
            </a>
            <a href="#users" class="nav-item">
                    <i class="fas fa-users"></i> <span>Người dùng</span>
            </a>
            <a href="#tours" class="nav-item">
                    <i class="fas fa-map-marked-alt"></i> <span>Tours</span>
            </a>
            <a href="#refunds" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i> <span>Quản lý hoàn tiền</span>
            </a>
            <a href="#deals" class="nav-item">
                    <i class="fas fa-tags"></i> <span>Ưu đãi</span>
                </a>
                <a href="#travel-guides" class="nav-item">
                    <i class="fas fa-book-open"></i> <span>Cẩm nang du lịch</span>
                </a>
                <a href="#contributions" class="nav-item">
                    <i class="fas fa-user-edit"></i> <span>Duyệt cẩm nang</span>
                    <span id="pending-contributions-badge" class="badge bg-danger ms-2" style="display: none;">0</span>
                </a>
            </div>
             <div class="nav-group">
                <span class="nav-group-title">HỆ THỐNG</span>
            <a href="#settings" class="nav-item">
                    <i class="fas fa-cog"></i> <span>Cài đặt</span>
            </a>
            </div>
        </nav>
        <div class="sidebar-footer">
            <button class="btn btn-danger w-100" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i> Đăng xuất
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Main Header -->
        <header class="main-header">
             <div class="header-left">
                <button class="mobile-toggle" id="mobile-toggle">
                    <i class="fas fa-bars"></i>
                    </button>
                <h1 class="page-title" id="page-title-header">Dashboard</h1>
                </div>
            <div class="header-right">
                <div class="header-search" id="headerSearchContainer" style="display: none;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="globalSearchInput" placeholder="Search...">
            </div>
                <div class="header-actions">
                    <div class="notification-wrapper">
                        <button class="btn-icon" id="notificationBell">
                            <i class="fas fa-bell"></i>
                            <span class="badge-dot" style="display: none;"></span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h6 class="mb-0">Thông báo</h6>
                                <a href="#" class="btn-link" id="markAllAsReadBtn">Đánh dấu tất cả là đã đọc</a>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>Không có thông báo mới</p>
                                 </div>
                            </div>
                             <div class="notification-footer">
                                <a href="#">Xem tất cả thông báo</a>
                            </div>
                        </div>
                    </div>
                    <!-- <button class="btn-icon"><i class="fas fa-cog"></i></button> -->
                </div>
                <!-- <div class="user-profile">
                    <span class="user-name">Omar Ali</span>
                    <span class="user-role">Company Owner</span>
                    <img src="https://i.pravatar.cc/40" alt="User Avatar">
                </div> -->
            </div>
        </header>
        
        <main class="content-wrapper">
        <!-- Roles Management Section (Dynamic) -->
        <div id="roles-management" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Quản lý chức vụ</h5>
                        <input type="text" id="roleSearchInput" class="form-control form-control-sm" style="max-width:220px;" placeholder="Tìm kiếm tên chức vụ..." oninput="filterAndDisplayRoles()">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="addRole()">
                        <i class="fas fa-plus"></i> Thêm chức vụ
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0 table-bordered">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="min-width: 120px;">Phòng ban</th>
                                    <th style="min-width: 150px;">Tên chức vụ</th>
                                    <th style="min-width: 100px;">Mã chức vụ</th>
                                    <th style="min-width: 200px;">Mô tả</th>
                                    <th style="min-width: 120px;">Lương cơ bản</th>
                                    <th style="min-width: 120px;">Phụ cấp</th>
                                    <th style="min-width: 150px;">Quyền hạn</th>
                                    <th style="min-width: 120px;">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="rolesTable">
                                <!-- Role data will be rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Departments Management Section -->
        <div id="departments-management" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <h5 class="mb-0"><i class="fas fa-building me-2"></i>Quản lý phòng ban</h5>
                        <input type="text" id="departmentSearchInput" class="form-control form-control-sm" style="max-width:220px;" placeholder="Tìm kiếm tên phòng ban..." oninput="filterAndDisplayDepartments()">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="addDepartment()">
                        <i class="fas fa-plus"></i> Thêm phòng ban
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0 table-bordered">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="min-width: 150px;">Tên phòng ban</th>
                                    <th style="min-width: 100px;">Mã phòng ban</th>
                                    <th style="min-width: 200px;">Mô tả</th>
                                    <th style="min-width: 120px;">Trưởng phòng</th>
                                    <th style="min-width: 100px;">Số nhân viên</th>
                                    <th style="min-width: 120px;">Ngân sách</th>
                                    <th style="min-width: 100px;">Trạng thái</th>
                                    <th style="min-width: 150px;">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="departmentsTable">
                                <!-- Department data will be rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Staff Management Section -->
        <div id="staff-management" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>Quản lý nhân viên</h5>
                        <input type="text" id="staffSearchInput" class="form-control form-control-sm" style="max-width:220px;" placeholder="Tìm kiếm tên, email..." oninput="filterAndDisplayStaff()">
                        <select id="staffRoleFilter" class="form-select form-select-sm" style="max-width:160px;" onchange="filterAndDisplayStaff()">
                            <option value="all">Tất cả vai trò</option>
                            <!-- Dynamic role options will be loaded here -->
                        </select>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="addStaff()">
                        <i class="fas fa-plus"></i> Thêm nhân viên
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Avatar</th>
                                    <th>Tên</th>
                                    <th>Email</th>
                                    <th>Số điện thoại</th>
                                    <th>Vai trò</th>
                                    <th>Ngày tham gia</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="staffTable">
                                <!-- Staff data will be rendered by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section">
            <!-- Thêm vào sau header, trước phần thống kê cards -->
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="stat-month" class="form-label">Chọn tháng</label>
                <select id="stat-month" class="form-select">
                  <option value="1">Tháng 1</option>
                  <option value="2">Tháng 2</option>
                  <option value="3">Tháng 3</option>
                  <option value="4">Tháng 4</option>
                  <option value="5">Tháng 5</option>
                  <option value="6">Tháng 6</option>
                  <option value="7">Tháng 7</option>
                  <option value="8">Tháng 8</option>
                  <option value="9">Tháng 9</option>
                  <option value="10">Tháng 10</option>
                  <option value="11">Tháng 11</option>
                  <option value="12">Tháng 12</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="stat-year" class="form-label">Chọn năm</label>
                <input type="number" id="stat-year" class="form-control" min="2020" max="2100" value="2025">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success w-100" id="export-excel-btn"><i class="fas fa-file-excel"></i> Xuất Excel</button>
              </div>
            </div>
            <div class="dashboard-greeting mb-4">
              <h2 style="font-weight:700; font-size:2rem; margin-bottom:0.2em;">Xin chào, <span id="admin-greeting-name">Admin</span>!</h2>
              <div style="color:#1976d2; font-size:1.1rem; font-weight:500;">Chúc bạn một ngày làm việc hiệu quả và doanh thu bứt phá 🚀</div>
            </div>
            <div class="stats-summary-cards">
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#1976d2 0%,#64b5f6 100%)"><i class="fas fa-user-plus"></i></div>
                <div>
                  <div class="stats-summary-label">Khách mới <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="Số người dùng mới đăng ký trong tháng này."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-new-users">0</div>
                    <span id="stat-new-users-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">trong tháng <span id="stat-month-label"></span>/<span id="stat-year-label"></span></div>
                </div>
              </div>
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#ff9800 0%,#ffc107 100%)"><i class="fas fa-bed"></i></div>
                <div>
                  <div class="stats-summary-label">Phòng có người <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="Số phòng đã có booking xác nhận hoặc hoàn thành trong tháng này."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-rooms-booked">0</div>
                    <span id="stat-rooms-booked-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">đã đặt trong tháng</div>
                </div>
              </div>
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#e91e63 0%,#f48fb1 100%)"><i class="fas fa-venus-mars"></i></div>
                <div>
                  <div class="stats-summary-label">Giới tính <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="Tổng số khách có booking trong tháng này, phân theo Nam/Nữ/Khác."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-gender">0/0/0</div>
                    <span id="stat-gender-male-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">Nam / Nữ / Khác</div>
                </div>
              </div>
              <div class="stats-summary-card revenue">
                <div class="stats-summary-icon"><i class="fas fa-coins"></i></div>
                <div>
                  <div class="stats-summary-label">Doanh thu <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="Tổng doanh thu từ các booking đã xác nhận/hoàn thành trong tháng này."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-revenue">0</div>
                    <span id="stat-revenue-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">VNĐ trong tháng</div>
                  <canvas id="mini-revenue-chart" height="36" style="margin-top:8px;max-width:180px;"></canvas>
                </div>
              </div>
            </div>
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #e3f2fd; color: #1976d2;">
                            <i class="fas fa-hotel"></i>
                        </div>
                        <div class="title">Tổng khách sạn</div>
                        <div class="value" id="totalHotels">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #e8f5e9; color: #2e7d32;">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="title">Đặt phòng hôm nay</div>
                        <div class="value" id="todayBookings">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #fff3e0; color: #e65100;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="title">Tổng người dùng</div>
                        <div class="value" id="totalUsers">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #f3e5f5; color: #7b1fa2;">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="title">Ưu đãi đang có</div>
                        <div class="value" id="activeDeals">0</div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="bookingTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="newUsersChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookings" class="content-section" style="display: none;">
            <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0">Danh sách đặt phòng</h5>
                        
                        <div id="bulk-action-container" class="d-none align-items-center">
                            <span id="selected-count" class="fw-bold me-3"></span>
                            <button class="btn btn-sm btn-secondary" onclick="updateSelectedStatus()">
                                <i class="fas fa-edit me-1"></i> Đổi trạng thái
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelectedBookings()">
                                <i class="fas fa-trash me-1"></i> Xóa
                            </button>
                        </div>

                        <div class="ms-auto"> <!-- Push the add button to the right -->
                    <button class="btn btn-primary btn-sm" onclick="addBooking()">
                        <i class="fas fa-plus-circle me-1"></i> Thêm đặt phòng
                    </button>
                        </div>
                    </div>
                    <div class="card-body p-3 border-bottom">
                         <div class="row g-2 justify-content-end">
                            <div class="col-md-4">
                                <select id="bookingStatusFilter" class="form-select">
                                    <option value="all" selected>Tất cả trạng thái</option>
                                    <option value="pending">Chờ xác nhận</option>
                                    <option value="confirmed">Đã xác nhận</option>
                                    <option value="cancelled">Đã hủy</option>
                                    <option value="completed">Hoàn thành</option>
                                </select>
                            </div>
                        </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover align-middle">
                        <thead class="table-light">
                          <tr>
                                    <th>ID</th>
                                    <th>Khách hàng</th>
                                    <th>Email</th>
                                    <th>Số điện thoại</th>
                            <th>Khách sạn</th>
                            <th>Dịch vụ</th>
                            <th>Check-in</th>
                            <th>Check-out</th>
                                    <th>Số khách</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTable">
                          <!-- Dữ liệu sẽ được render bằng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Tours Section -->
        <div id="bookings-tours" class="content-section" style="display: none;">
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h5 class="mb-0">Danh sách đặt tours</h5>
              <button class="btn btn-primary btn-sm" onclick="addTourBooking()">
                <i class="fas fa-plus-circle me-1"></i> Thêm đặt tours
              </button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Khách hàng</th>
                      <th>Email</th>
                      <th>Số điện thoại</th>
                      <th>Tên tour</th>
                      <th>Điểm đến</th>
                      <th>Check-in</th>
                      <th>Số khách</th>
                      <th>Trạng thái</th>
                      <th>Thao tác</th>
                    </tr>
                  </thead>
                  <tbody id="bookingsToursTable">
                    <!-- Dữ liệu sẽ được render bằng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hotels Section -->
        <div id="hotels" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh sách khách sạn</h5>
                    <button class="btn btn-primary btn-sm" onclick="addHotel()">
                        <i class="fas fa-plus"></i> Thêm khách sạn
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="hotelsGrid">
                        <!-- Hotel cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Danh sách người dùng</h5>
                        <input type="text" id="userSearchInput" class="form-control form-control-sm" style="max-width:250px;" placeholder="Tìm kiếm tên, email, SĐT..." oninput="filterAndDisplayUsers()">
                    </div>
                    <div class="d-flex gap-2">
                        <select id="userStatusFilter" class="form-select form-select-sm" style="max-width:150px;" onchange="filterAndDisplayUsers()">
                            <option value="all">Tất cả trạng thái</option>
                            <option value="active">Đang hoạt động</option>
                            <option value="inactive">Tạm khóa</option>
                            <option value="banned">Bị cấm</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="addUser()">
                            <i class="fas fa-plus"></i> Thêm người dùng
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">Avatar</th>
                                    <th>Thông tin cá nhân</th>
                                    <th>Liên hệ</th>
                                    <th>Giới tính</th>
                                    <th>Địa chỉ</th>
                                    <th>Quốc tịch</th>
                                    <th>Ngày sinh</th>
                                    <th>Ngày tham gia</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tours Section -->
        <div id="tours" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh sách tours</h5>
                    <button class="btn btn-primary btn-sm" onclick="addTour()">
                        <i class="fas fa-plus"></i> Thêm tour
                    </button>
                </div>
                <div class="card-body">
                    <div class="accordion" id="toursAccordion">
                        <!-- Accordion for tour categories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Refunds Management Section -->
        <div id="refunds" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Quản lý hoàn tiền</h5>
                    <button class="btn btn-success btn-sm" onclick="loadRefunds()">
                        <i class="fas fa-sync-alt"></i> Làm mới
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Khách hàng</th>
                                    <th>Email</th>
                                    <th>Dịch vụ</th>
                                    <th>Tổng tiền</th>
                                    <th>Số tiền hoàn</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="refundsTable">
                                <!-- Dữ liệu sẽ được render bằng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deals Management Section -->
        <div id="deals" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh sách Ưu đãi</h5>
                    <button class="btn btn-primary btn-sm" onclick="addDeal()">
                        <i class="fas fa-plus"></i> Thêm ưu đãi
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tiêu đề</th>
                                <th>Giá mới</th>
                                <th>Giá cũ</th>
                                <th>Ngày kết thúc</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="dealsTableBody">
                            <!-- Deal rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


            <!-- Travel Guides Section -->
            <div id="travel-guides" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Danh sách bài viết</h5>
                        <button class="btn btn-primary btn-sm" onclick="addTravelGuide()">
                            <i class="fas fa-plus"></i> Thêm bài viết
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Hình ảnh</th>
                                    <th>Tiêu đề</th>
                                    <th>Tác giả</th>
                                    <th>Ngày đăng</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="travelGuidesTableBody">
                                <!-- Travel guide rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Contributions Section -->
        <div id="contributions" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>Cẩm nang chờ duyệt
                        <span id="contributions-count-badge" class="badge bg-warning ms-2">0</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="filterContributions('all')">
                            <i class="fas fa-list"></i> Tất cả
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="filterContributions('pending')">
                            <i class="fas fa-clock"></i> Chờ duyệt
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="filterContributions('approved')">
                            <i class="fas fa-check"></i> Đã duyệt
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="filterContributions('rejected')">
                            <i class="fas fa-times"></i> Từ chối
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="contributions-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2 text-muted">Đang tải danh sách cẩm nang...</p>
                    </div>
                    
                    <div id="contributions-empty" class="text-center py-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Không có cẩm nang nào</h5>
                        <p class="text-muted">Chưa có cẩm nang nào được gửi từ members.</p>
                    </div>
                    
                    <div id="contributions-list">
                        <!-- Contributions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>


        <!-- Settings Section -->
        <div id="settings" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Cài đặt hệ thống</h5>
                </div>
                <div class="card-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label class="form-label">Tên website</label>
                                <input type="text" class="form-control" id="settingWebsiteName" value="LuxuryHavenTravel">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email liên hệ</label>
                                <input type="email" class="form-control" id="settingContactEmail" value="LuxuryHavenTravel@gmail.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="settingPhoneNumber" value="0837 918 274 - 0912 38 4956 ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Địa chỉ</label>
                                <textarea class="form-control" id="settingAddress" rows="3">Lầu 5, Tòa nhà ABC, 456 Đường Lê Lai, Phường Bến Thành, Quận 1, TP. Hồ Chí Minh, Việt Nam</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </form>
                </div>
            </div>
        </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Roles Management Section Logic
        let allRoles = [];
        function loadRoles() {
            const rolesTable = document.getElementById('rolesTable');
            rolesTable.innerHTML = '<tr><td colspan="8" class="text-center">Đang tải dữ liệu...</td></tr>';
            db.ref('roles').on('value', (snapshot) => {
                allRoles = [];
                if (snapshot.exists()) {
                    snapshot.forEach((roleSnapshot) => {
                        const role = roleSnapshot.val();
                        role.id = roleSnapshot.key;
                        allRoles.push(role);
                    });
                }
                filterAndDisplayRoles();
            }, (error) => {
                rolesTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>';
            });
        }

        function filterAndDisplayRoles() {
            let filteredRoles = [...allRoles];
            const searchTerm = document.getElementById('roleSearchInput')?.value.toLowerCase().trim() || '';
            if (searchTerm) {
                filteredRoles = filteredRoles.filter(r =>
                    (r.name && r.name.toLowerCase().includes(searchTerm)) ||
                    (r.code && r.code.toLowerCase().includes(searchTerm)) ||
                    (r.description && r.description.toLowerCase().includes(searchTerm)) ||
                    (r.department && r.department.toLowerCase().includes(searchTerm)) ||
                    (r.permissions && r.permissions.toLowerCase().includes(searchTerm))
                );
            }
            renderRolesTable(filteredRoles);
        }

        function renderRolesTable(roleList) {
            const rolesTable = document.getElementById('rolesTable');
            rolesTable.innerHTML = '';
            if (roleList.length === 0) {
                rolesTable.innerHTML = '<tr><td colspan="8" class="text-center py-5">Không tìm thấy chức vụ phù hợp.</td></tr>';
                return;
            }
            roleList.forEach(role => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge bg-primary">${role.department || 'N/A'}</span></td>
                    <td><strong>${role.name || 'N/A'}</strong></td>
                    <td>${role.code || 'N/A'}</td>
                    <td>${role.description || ''}</td>
                    <td>${role.salary ? role.salary.toLocaleString('vi-VN') + ' VNĐ' : ''}</td>
                    <td>${role.allowance ? role.allowance.toLocaleString('vi-VN') + ' VNĐ' : ''}</td>
                    <td>${role.permissions || ''}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-warning" onclick="editRole('${role.id}')" title="Chỉnh sửa" data-bs-toggle="tooltip">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteRole('${role.id}')" title="Xóa" data-bs-toggle="tooltip">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                rolesTable.appendChild(row);
            });
        }

        function addRole() {
            // Debug: kiểm tra authentication
            const currentUser = auth.currentUser;
            console.log('Current user:', currentUser);
            console.log('User email:', currentUser?.email);
            
            // Đảm bảo load departments trước khi hiển thị form
            console.log('Loading departments for role form...');
            
            // Load danh sách phòng ban trực tiếp từ Firebase để đảm bảo đầy đủ và mới nhất
            db.ref('departments').once('value').then((snapshot) => {
                console.log('Departments snapshot received:', snapshot.val());
                
                let departmentOptions = '<option value="">Chọn phòng ban *</option>';
                
                if (snapshot.exists()) {
                    console.log('Found departments in Firebase');
                    snapshot.forEach((deptSnapshot) => {
                        const dept = deptSnapshot.val();
                        console.log('Processing department:', dept);
                        if (dept.name && dept.code) {
                            departmentOptions += `<option value="${dept.name}">${dept.name} (${dept.code})</option>`;
                        }
                    });
                } else {
                    console.log('No departments found in Firebase, using fallback');
                    // Fallback nếu không có departments trong database
                    departmentOptions += `
                        <option value="Lễ tân (Front Desk)">Lễ tân (Front Desk) (01)</option>
                        <option value="Quan lý đối tác">Quan lý đối tác (QL01)</option>
                        <option value="Kiểm duyệt đặt phòng">Kiểm duyệt đặt phòng (KD01)</option>
                        <option value="Chăm sóc khách hàng">Chăm sóc khách hàng (CSKH)</option>
                        <option value="Marketing">Marketing (MKT)</option>
                        <option value="Kỹ thuật">Kỹ thuật (KT)</option>
                        <option value="Tài chính">Tài chính (TC)</option>
                        <option value="Nhân sự">Nhân sự (NS)</option>
                        <option value="Bảo vệ">Bảo vệ (BV)</option>
                        <option value="Buồng phòng">Buồng phòng (BP)</option>
                    `;
                }
                
                console.log('Department options generated:', departmentOptions);
                console.log('departmentOptions length:', departmentOptions.length);
                console.log('departmentOptions content:', departmentOptions);
                
                // Thêm debug để kiểm tra nội dung options
                if (departmentOptions.includes('<option')) {
                    console.log('✅ Options found in departmentOptions');
                } else {
                    console.log('❌ No options found in departmentOptions');
                }
                
                Swal.fire({
                    title: 'Thêm chức vụ mới',
                    html: `
                        <div class="row">
                            <div class="col-md-6">
                                <select id="roleDepartment" class="form-select mb-2">
                                    ${departmentOptions}
                                </select>
                                <input type="text" id="roleName" class="form-control mb-2" placeholder="Tên chức vụ">
                                <input type="text" id="roleCode" class="form-control mb-2" placeholder="Mã chức vụ (ví dụ: cskh, marketing, ...)">
                                <textarea id="roleDesc" class="form-control mb-2" rows="3" placeholder="Mô tả chức vụ"></textarea>
                            </div>
                            <div class="col-md-6">
                                <input type="number" id="roleSalary" class="form-control mb-2" placeholder="Lương cơ bản (VNĐ)" min="0">
                                <input type="number" id="roleAllowance" class="form-control mb-2" placeholder="Phụ cấp (VNĐ)" min="0">
                                <textarea id="rolePermissions" class="form-control mb-2" rows="3" placeholder="Quyền hạn (ví dụ: Quản lý nhân viên, Xem báo cáo, ...)"></textarea>
                            </div>
                        </div>
                    `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Thêm mới',
                cancelButtonText: 'Hủy',
                didOpen: () => {
                    // Debug: kiểm tra dropdown sau khi modal mở
                    console.log('Modal opened, checking dropdown...');
                    const dropdown = document.getElementById('roleDepartment');
                    if (dropdown) {
                        console.log('Dropdown found:', dropdown);
                        console.log('Dropdown innerHTML:', dropdown.innerHTML);
                        console.log('Number of options:', dropdown.options.length);
                        
                        // Log từng option
                        for (let i = 0; i < dropdown.options.length; i++) {
                            console.log(`Option ${i}:`, dropdown.options[i].value, dropdown.options[i].text);
                        }
                        
                        // Thêm event listener cho dropdown để tự động điền thông tin
                        dropdown.addEventListener('change', function() {
                            const selectedDept = this.value;
                            console.log('Department selected:', selectedDept);
                            
                            if (selectedDept) {
                                // Tự động tạo mã chức vụ dựa trên tên phòng ban
                                const deptCode = selectedDept.toLowerCase()
                                    .replace(/\s+/g, '')
                                    .replace(/[()]/g, '')
                                    .substring(0, 10);
                                
                                // Đặt focus vào tên chức vụ để user dễ nhập
                                const roleNameInput = document.getElementById('roleName');
                                if (roleNameInput) {
                                    roleNameInput.focus();
                                    roleNameInput.placeholder = `Nhập tên chức vụ cho ${selectedDept}`;
                                }
                                
                                // Đặt placeholder cho mã chức vụ
                                const roleCodeInput = document.getElementById('roleCode');
                                if (roleCodeInput) {
                                    roleCodeInput.placeholder = `Ví dụ: ${deptCode}_manager, ${deptCode}_staff...`;
                                }
                                
                                // Tự động điền mô tả dựa trên phòng ban
                                const roleDescInput = document.getElementById('roleDesc');
                                if (roleDescInput && !roleDescInput.value) {
                                    let defaultDesc = '';
                                    if (selectedDept.includes('Lễ tân')) {
                                        defaultDesc = 'Chịu trách nhiệm tiếp đón khách, check-in/check-out, hỗ trợ khách hàng tại quầy lễ tân';
                                    } else if (selectedDept.includes('Marketing')) {
                                        defaultDesc = 'Thực hiện các chiến lược marketing, quảng bá thương hiệu, tối ưu SEO';
                                    } else if (selectedDept.includes('Quản lý đối tác')) {
                                        defaultDesc = 'Quản lý mối quan hệ đối tác, liên kết với các website/đại lý khác';
                                    } else if (selectedDept.includes('Hỗ trợ khách hàng')) {
                                        defaultDesc = 'Hỗ trợ khách hàng đặt phòng, giải quyết khiếu nại, xử lý hoàn tiền';
                                    } else if (selectedDept.includes('Kiểm duyệt')) {
                                        defaultDesc = 'Kiểm duyệt đặt phòng, xử lý tranh chấp giữa khách hàng và khách sạn';
                                    } else {
                                        defaultDesc = `Thực hiện các nhiệm vụ liên quan đến ${selectedDept}`;
                                    }
                                    roleDescInput.value = defaultDesc;
                                }
                                
                                // Đặt lương mặc định dựa trên phòng ban
                                const roleSalaryInput = document.getElementById('roleSalary');
                                if (roleSalaryInput && !roleSalaryInput.value) {
                                    let defaultSalary = 15000000; // Mặc định 15 triệu
                                    if (selectedDept.includes('Marketing') || selectedDept.includes('Quản lý')) {
                                        defaultSalary = 20000000; // 20 triệu cho vị trí cao
                                    } else if (selectedDept.includes('Lễ tân') || selectedDept.includes('Hỗ trợ')) {
                                        defaultSalary = 12000000; // 12 triệu cho vị trí entry
                                    }
                                    roleSalaryInput.value = defaultSalary;
                                }
                                
                                console.log('✅ Department selection processed with auto-fill');
                            }
                        });
                    } else {
                        console.log('❌ Dropdown not found in DOM');
                    }
                },
                preConfirm: () => {
                    const department = document.getElementById('roleDepartment').value.trim();
                    const name = document.getElementById('roleName').value.trim();
                    const code = document.getElementById('roleCode').value.trim();
                    const description = document.getElementById('roleDesc').value.trim();
                    const salary = parseInt(document.getElementById('roleSalary').value) || 0;
                    const allowance = parseInt(document.getElementById('roleAllowance').value) || 0;
                    const permissions = document.getElementById('rolePermissions').value.trim();
                    
                    if (!name || !code) {
                        Swal.showValidationMessage('Vui lòng nhập tên và mã chức vụ');
                        return false;
                    }
                    
                    if (!department) {
                        Swal.showValidationMessage('Vui lòng chọn phòng ban');
                        return false;
                    }
                    
                    return { 
                        department, 
                        name, 
                        code, 
                        description, 
                        salary, 
                        allowance, 
                        permissions,
                        createdAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newRole = result.value;
                    console.log('Attempting to create role:', newRole);
                    console.log('Current user email:', auth.currentUser?.email);
                    
                    db.ref('roles').push(newRole).then(() => {
                        loadRoles();
                        Swal.fire('Thành công', 'Đã thêm chức vụ mới!', 'success');
                    }).catch((error) => {
                        console.error('Error creating role:', error);
                        Swal.fire('Lỗi', `Không thể thêm chức vụ: ${error.message}`, 'error');
                    });
                }
            });
            
            }).catch((error) => {
                console.error('Error loading departments for role form:', error);
                Swal.fire('Lỗi', 'Không thể tải danh sách phòng ban. Vui lòng thử lại.', 'error');
            });
        }

        function editRole(roleId) {
            const role = allRoles.find(r => r.id === roleId);
            if (!role) {
                Swal.fire('Lỗi', 'Không tìm thấy chức vụ này.', 'error');
                return;
            }
            
            console.log('Editing role:', role);
            console.log('Loading departments for role edit form...');
            
            // Load danh sách phòng ban trực tiếp từ Firebase để đảm bảo đầy đủ và mới nhất
            db.ref('departments').once('value').then((snapshot) => {
                console.log('Departments snapshot for edit received:', snapshot.val());
                
                let departmentOptions = '<option value="">Chọn phòng ban *</option>';
                
                if (snapshot.exists()) {
                    console.log('Found departments in Firebase for edit');
                    snapshot.forEach((deptSnapshot) => {
                        const dept = deptSnapshot.val();
                        console.log('Processing department for edit:', dept);
                        if (dept.name && dept.code) {
                            const selected = role.department === dept.name ? 'selected' : '';
                            departmentOptions += `<option value="${dept.name}" ${selected}>${dept.name} (${dept.code})</option>`;
                        }
                    });
                } else {
                    console.log('No departments found in Firebase for edit, using fallback');
                    // Fallback nếu không có departments trong database
                    const fallbackDepartments = [
                        'Lễ tân (Front Desk)', 'Quan lý đối tác', 'Kiểm duyệt đặt phòng',
                        'Chăm sóc khách hàng', 'Marketing', 'Kỹ thuật', 
                        'Tài chính', 'Nhân sự', 'Bảo vệ', 'Buồng phòng'
                    ];
                    
                    fallbackDepartments.forEach(deptName => {
                        const selected = role.department === deptName ? 'selected' : '';
                        departmentOptions += `<option value="${deptName}" ${selected}>${deptName}</option>`;
                    });
                }
                
                console.log('Department options for edit generated:', departmentOptions);
            
            Swal.fire({
                title: 'Chỉnh sửa chức vụ',
                html: `
                    <div class="row">
                        <div class="col-md-6">
                            <select id="editRoleDepartment" class="form-select mb-2">
                                <option value="">Chọn phòng ban *</option>
                                ${departmentOptions}
                            </select>
                            <input type="text" id="editRoleName" class="form-control mb-2" value="${role.name || ''}" placeholder="Tên chức vụ">
                            <input type="text" id="editRoleCode" class="form-control mb-2" value="${role.code || ''}" placeholder="Mã chức vụ">
                            <textarea id="editRoleDesc" class="form-control mb-2" rows="3" placeholder="Mô tả chức vụ">${role.description || ''}</textarea>
                        </div>
                        <div class="col-md-6">
                            <input type="number" id="editRoleSalary" class="form-control mb-2" value="${role.salary || ''}" placeholder="Lương cơ bản (VNĐ)" min="0">
                            <input type="number" id="editRoleAllowance" class="form-control mb-2" value="${role.allowance || ''}" placeholder="Phụ cấp (VNĐ)" min="0">
                            <textarea id="editRolePermissions" class="form-control mb-2" rows="3" placeholder="Quyền hạn (ví dụ: Quản lý nhân viên, Xem báo cáo, ...)">${role.permissions || ''}</textarea>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Lưu thay đổi',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const department = document.getElementById('editRoleDepartment').value.trim();
                    const name = document.getElementById('editRoleName').value.trim();
                    const code = document.getElementById('editRoleCode').value.trim();
                    const description = document.getElementById('editRoleDesc').value.trim();
                    const salary = parseInt(document.getElementById('editRoleSalary').value) || 0;
                    const allowance = parseInt(document.getElementById('editRoleAllowance').value) || 0;
                    const permissions = document.getElementById('editRolePermissions').value.trim();
                    
                    if (!name || !code) {
                        Swal.showValidationMessage('Vui lòng nhập tên và mã chức vụ');
                        return false;
                    }
                    
                    if (!department) {
                        Swal.showValidationMessage('Vui lòng chọn phòng ban');
                        return false;
                    }
                    
                    return { 
                        department, 
                        name, 
                        code, 
                        description, 
                        salary, 
                        allowance, 
                        permissions,
                        updatedAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedRole = result.value;
                    db.ref('roles/' + roleId).update(updatedRole).then(() => {
                        loadRoles();
                        Swal.fire('Thành công', 'Đã cập nhật chức vụ!', 'success');
                    }).catch((error) => {
                        Swal.fire('Lỗi', 'Không thể cập nhật chức vụ.', 'error');
                    });
                }
            });
            
            }).catch((error) => {
                console.error('Error loading departments for role edit form:', error);
                Swal.fire('Lỗi', 'Không thể tải danh sách phòng ban. Vui lòng thử lại.', 'error');
            });
        }

        function deleteRole(roleId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn không thể hoàn tác sau khi xóa!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('roles/' + roleId).remove().then(() => {
                        loadRoles();
                        Swal.fire('Đã xóa', 'Chức vụ đã bị xóa.', 'success');
                    }).catch((error) => {
                        Swal.fire('Lỗi', 'Không thể xóa chức vụ.', 'error');
                    });
                }
            });
        }

        // Test function để kiểm tra Firebase Rules
        function testFirebaseRules() {
            console.log('=== FIREBASE RULES TEST STARTED ===');
            console.log('Current user:', auth.currentUser);
            console.log('User email:', auth.currentUser?.email);
            console.log('User UID:', auth.currentUser?.uid);
            console.log('User emailVerified:', auth.currentUser?.emailVerified);
            console.log('User metadata:', auth.currentUser?.metadata);
            
            if (!auth.currentUser) {
                console.log('❌ No user logged in');
                return;
            }
            
            // Kiểm tra đặc biệt về email verification
            if (!auth.currentUser.emailVerified) {
                console.log('⚠️ WARNING: Email not verified! This might cause permission issues.');
                console.log('Email verification status:', auth.currentUser.emailVerified);
            }
            
            // Test 1: Kiểm tra connection
            console.log('Test 1: Checking Firebase connection...');
            db.ref('.info/connected').once('value').then((snapshot) => {
                if (snapshot.val() === true) {
                    console.log('✅ Firebase connected successfully');
                } else {
                    console.log('❌ Firebase not connected');
                }
            }).catch((error) => {
                console.log('❌ Firebase connection test failed:', error);
            });
            
            // Test 2: Read departments permission
            console.log('Test 2: Testing read departments permission...');
            db.ref('departments').once('value').then((snapshot) => {
                console.log('✅ Read departments permission: SUCCESS');
                console.log('Departments data:', snapshot.val());
            }).catch((error) => {
                console.log('❌ Read departments permission: FAILED');
                console.log('Error code:', error.code);
                console.log('Error message:', error.message);
            });
            
            // Test 3: Write departments permission với data tối thiểu
            console.log('Test 3: Testing write departments permission...');
            const testDepartment = {
                name: 'Test Department',
                code: 'TEST',
                status: 'active',
                createdAt: Date.now()
            };
            
            console.log('Test data:', testDepartment);
            
            db.ref('departments').push(testDepartment).then((ref) => {
                console.log('✅ Write departments permission: SUCCESS');
                console.log('Created test department with ID:', ref.key);
                
                // Xóa test data
                ref.remove().then(() => {
                    console.log('✅ Cleaned up test department');
                }).catch((cleanupError) => {
                    console.log('⚠️ Failed to cleanup test department:', cleanupError);
                });
            }).catch((error) => {
                console.log('❌ Write departments permission: FAILED');
                console.log('Error code:', error.code);
                console.log('Error message:', error.message);
                console.log('Full error object:', error);
            });
            
            // Test 4: Kiểm tra token claims
            auth.currentUser.getIdTokenResult().then((idTokenResult) => {
                console.log('=== TOKEN ANALYSIS ===');
                console.log('Token claims:', idTokenResult.claims);
                console.log('Token email:', idTokenResult.claims.email);
                console.log('Token email verified:', idTokenResult.claims.email_verified);
                console.log('Token auth time:', idTokenResult.authTime);
                console.log('Token issued at:', idTokenResult.issuedAtTime);
                console.log('Token expiration:', idTokenResult.expirationTime);
                console.log('Token sign-in provider:', idTokenResult.signInProvider);
                console.log('User UID in token:', idTokenResult.claims.user_id || idTokenResult.claims.sub);
                
                // Test đặc biệt về email verification
                if (idTokenResult.claims.email !== 'quantrikhachsan@gmail.com') {
                    console.log('❌ EMAIL MISMATCH in token!');
                    console.log('Expected: quantrikhachsan@gmail.com');
                    console.log('Got in token:', idTokenResult.claims.email);
                }
                
                if (!idTokenResult.claims.email_verified) {
                    console.log('⚠️ WARNING: email_verified is false in token!');
                    console.log('This might cause permission issues in Firebase Rules');
                }
                
                // Test với fresh token
                console.log('Getting fresh token...');
                return auth.currentUser.getIdToken(true);
            }).then((freshToken) => {
                console.log('Fresh token obtained (first 100 chars):', freshToken.substring(0, 100) + '...');
                
                // Decode token để xem claims (chỉ để debug - không an toàn trong production)
                try {
                    const tokenParts = freshToken.split('.');
                    const payload = JSON.parse(atob(tokenParts[1]));
                    console.log('Fresh token payload:', payload);
                    console.log('Fresh token email:', payload.email);
                    console.log('Fresh token email_verified:', payload.email_verified);
                    console.log('Fresh token exp:', new Date(payload.exp * 1000));
                } catch (decodeError) {
                    console.log('Could not decode token for debugging:', decodeError);
                }
                
            }).catch((tokenError) => {
                console.log('❌ Failed to get token claims:', tokenError);
            });
            
            console.log('=== FIREBASE RULES TEST COMPLETED ===');
        }
        
        // Thêm button test vào console (có thể gọi bằng cách gõ testFirebaseRules() trong console)
        window.testFirebaseRules = testFirebaseRules;
        
        // Function để verify email nếu cần
        function verifyEmail() {
            if (!auth.currentUser) {
                console.log('❌ No user logged in');
                return;
            }
            
            if (auth.currentUser.emailVerified) {
                console.log('✅ Email already verified');
                return;
            }
            
            console.log('Sending email verification...');
            auth.currentUser.sendEmailVerification().then(() => {
                console.log('✅ Email verification sent');
                Swal.fire({
                    icon: 'info',
                    title: 'Email verification sent',
                    text: 'Please check your email and click the verification link.'
                });
            }).catch((error) => {
                console.error('❌ Failed to send email verification:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Failed to send verification',
                    text: error.message
                });
            });
        }
        
        // Function để reload user để cập nhật emailVerified status
        function reloadUser() {
            if (!auth.currentUser) {
                console.log('❌ No user logged in');
                return;
            }
            
            console.log('Reloading user...');
            auth.currentUser.reload().then(() => {
                console.log('✅ User reloaded');
                console.log('Email verified status:', auth.currentUser.emailVerified);
                
                if (auth.currentUser.emailVerified) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Email verified!',
                        text: 'You can now try adding departments again.'
                    });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Email not verified yet',
                        text: 'Please check your email for verification link.'
                    });
                }
            }).catch((error) => {
                console.error('❌ Failed to reload user:', error);
            });
        }
        
        // Thêm functions vào console
        window.verifyEmail = verifyEmail;
        window.reloadUser = reloadUser;
        
        // Debug function để kiểm tra allDepartments
        function debugDepartments() {
            console.log('=== DEPARTMENTS DEBUG ===');
            console.log('allDepartments array:', allDepartments);
            console.log('Number of departments:', allDepartments.length);
            
            if (allDepartments.length > 0) {
                console.log('First department:', allDepartments[0]);
                allDepartments.forEach((dept, index) => {
                    console.log(`Department ${index + 1}:`, {
                        name: dept.name,
                        code: dept.code,
                        id: dept.id
                    });
                });
            } else {
                console.log('❌ No departments found in allDepartments array');
            }
            
            // Test dropdown generation
            if (allDepartments.length > 0) {
                const testOptions = allDepartments.map(dept => 
                    `<option value="${dept.name}">${dept.name} (${dept.code})</option>`
                ).join('');
                console.log('Generated dropdown options:', testOptions);
            }
            
            console.log('=== END DEPARTMENTS DEBUG ===');
        }
        
        // Thêm debug function vào console
        window.debugDepartments = debugDepartments;

        // Tự động load roles khi vào trang
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - initializing...');
            
            // Load tất cả data cần thiết
            loadDepartments(); // Load departments trước để có sẵn cho roles
            loadRoles();
            loadStaff(); // Load staff data
            loadStaffRoleFilter(); // Load dynamic role filter options
            
            // Initialize navigation
            initializeNavigation();
            
            console.log('All initialization completed');
        });
        
        // Navigation handling
        function initializeNavigation() {
            // Add click handlers for navigation items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all nav items
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Hide all content sections
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show target section
                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        
                        // Update page title
                        const titleElement = document.getElementById('page-title-header');
                        if (titleElement) {
                            titleElement.textContent = this.querySelector('span').textContent;
                        }
                        
                        // Load data for specific sections
                        switch(targetId) {
                            case 'departments-management':
                                loadDepartments();
                                break;
                            case 'roles-management':
                                loadRoles();
                                // Đảm bảo departments được load trước khi vào section roles
                                loadDepartments();
                                break;
                            case 'staff-management':
                                loadStaff();
                                break;
                        }
                    }
                });
            });
        }

        // Departments Management Section Logic
        let allDepartments = [];
        
        function loadDepartments() {
            console.log('loadDepartments() called');
            const departmentsTable = document.getElementById('departmentsTable');
            if (!departmentsTable) {
                console.log('No departmentsTable found, but continuing to load data for allDepartments');
            } else {
                departmentsTable.innerHTML = '<tr><td colspan="8" class="text-center">Đang tải dữ liệu...</td></tr>';
            }
            
            // Load data from Firebase
            console.log('Loading departments from Firebase...');
            db.ref('departments').on('value', (snapshot) => {
                console.log('Departments snapshot received in loadDepartments:', snapshot.val());
                allDepartments = [];
                if (snapshot.exists()) {
                    console.log('Departments exist in Firebase');
                    snapshot.forEach((deptSnapshot) => {
                        const department = deptSnapshot.val();
                        department.id = deptSnapshot.key;
                        allDepartments.push(department);
                        console.log('Added department to allDepartments:', department);
                    });
                } else {
                    // Add sample data if no departments exist
                    console.log('No departments found in Firebase, using sample data');
                    allDepartments = [
                        {
                            id: 'sample1',
                            name: 'Lễ tân (Front Desk)',
                            code: '01',
                            description: 'Quản lý check-in/check-out, tiếp khách',
                            manager: 'Nguyễn Tiến Chúc',
                            staffCount: 0,
                            budget: 150000000,
                            status: 'active',
                            location: 'Tầng trệt',
                            email: 'frontdesk@luxuryhaven.com',
                            phone: '0123456789'
                        },
                        {
                            id: 'sample2', 
                            name: 'Quan lý đối tác',
                            code: 'QL01',
                            description: 'Quản lý liên kết với đại lý/website khác',
                            manager: 'Nguyễn Văn B',
                            staffCount: 0,
                            budget: 120000000,
                            status: 'active',
                            location: 'Tầng 2',
                            email: 'partner@luxuryhaven.com',
                            phone: '0123456790'
                        },
                        {
                            id: 'sample3',
                            name: 'Kiểm duyệt đặt phòng',
                            code: 'KD01',
                            description: 'Giải quyết vấn đề giữa khách & khách sạn',
                            manager: 'Nguyễn Văn C',
                            staffCount: 0,
                            budget: 100000000,
                            status: 'active',
                            location: 'Tầng 2',
                            email: 'booking@luxuryhaven.com',
                            phone: '0123456791'
                        }
                    ];
                }
                
                console.log('Final allDepartments array:', allDepartments);
                console.log('Number of departments loaded:', allDepartments.length);
                
                filterAndDisplayDepartments();
            }, (error) => {
                console.error('Error loading departments:', error);
                departmentsTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Lỗi khi tải dữ liệu: ' + error.message + '</td></tr>';
            });
        }

        function filterAndDisplayDepartments() {
            let filteredDepartments = [...allDepartments];
            const searchTerm = document.getElementById('departmentSearchInput')?.value.toLowerCase().trim() || '';
            
            if (searchTerm) {
                filteredDepartments = filteredDepartments.filter(d =>
                    (d.name && d.name.toLowerCase().includes(searchTerm)) ||
                    (d.code && d.code.toLowerCase().includes(searchTerm)) ||
                    (d.description && d.description.toLowerCase().includes(searchTerm)) ||
                    (d.manager && d.manager.toLowerCase().includes(searchTerm))
                );
            }
            renderDepartmentsTable(filteredDepartments);
        }

        function renderDepartmentsTable(departmentList) {
            const departmentsTable = document.getElementById('departmentsTable');
            if (!departmentsTable) return;
            
            departmentsTable.innerHTML = '';
            if (departmentList.length === 0) {
                departmentsTable.innerHTML = '<tr><td colspan="8" class="text-center py-5"><i class="fas fa-inbox fa-2x text-muted mb-2"></i><br>Không tìm thấy phòng ban phù hợp.</td></tr>';
                return;
            }
            
            departmentList.forEach(department => {
                const budget = department.budget ? department.budget.toLocaleString('vi-VN') + ' VNĐ' : '<span class="text-muted">Chưa có</span>';
                const staffCount = department.staffCount || 0;
                const status = department.status === 'active' ? 
                    '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Hoạt động</span>' : 
                    '<span class="badge bg-secondary"><i class="fas fa-pause-circle"></i> Không hoạt động</span>';
                
                const manager = department.manager || '<span class="text-muted">Chưa có</span>';
                const description = department.description ? 
                    (department.description.length > 50 ? 
                        `<span title="${department.description}">${department.description.substring(0, 50)}...</span>` : 
                        department.description) : 
                    '<span class="text-muted">Không có</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong class="text-primary">${department.name || 'N/A'}</strong></td>
                    <td><span class="badge bg-info">${department.code || 'N/A'}</span></td>
                    <td>${description}</td>
                    <td>${manager}</td>
                    <td><span class="badge bg-secondary"><i class="fas fa-users"></i> ${staffCount} người</span></td>
                    <td>${budget}</td>
                    <td>${status}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-info" onclick="viewDepartment('${department.id}')" title="Xem chi tiết" data-bs-toggle="tooltip">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="editDepartment('${department.id}')" title="Chỉnh sửa" data-bs-toggle="tooltip">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deleteDepartment('${department.id}')" title="Xóa" data-bs-toggle="tooltip">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                departmentsTable.appendChild(row);
            });
            
            // Initialize tooltips after rendering
            setTimeout(() => {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }, 100);
        }

        function addDepartment() {
            console.log('=== ADD DEPARTMENT FUNCTION CALLED ===');
            
            // Kiểm tra authentication trước khi tạo department
            const currentUser = auth.currentUser;
            console.log('Current user:', currentUser);
            console.log('User email:', currentUser?.email);
            console.log('User UID:', currentUser?.uid);
            console.log('User emailVerified:', currentUser?.emailVerified);
            
            if (!currentUser) {
                console.log('❌ No user logged in - auth.currentUser is null/undefined');
                Swal.fire('Lỗi', 'Bạn cần đăng nhập để thực hiện chức năng này.', 'error');
                return;
            }
            
            if (currentUser.email !== 'quantrikhachsan@gmail.com') {
                console.log('❌ Unauthorized user:', currentUser.email);
                console.log('Expected: quantrikhachsan@gmail.com');
                Swal.fire('Lỗi', 'Bạn không có quyền thực hiện hành động này. Vui lòng đăng nhập với tài khoản admin.', 'error');
                return;
            }
            
            console.log('✅ Admin authorization confirmed');
            
            Swal.fire({
                title: 'Thêm phòng ban mới',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="deptName" class="form-control mb-2" placeholder="Tên phòng ban *" required>
                                <input type="text" id="deptCode" class="form-control mb-2" placeholder="Mã phòng ban *" required>
                                <textarea id="deptDescription" class="form-control mb-2" rows="3" placeholder="Mô tả phòng ban"></textarea>
                                <input type="text" id="deptManager" class="form-control mb-2" placeholder="Trưởng phòng">
                            </div>
                            <div class="col-md-6">
                                <input type="number" id="deptBudget" class="form-control mb-2" placeholder="Ngân sách (VNĐ)" min="0">
                                <input type="text" id="deptLocation" class="form-control mb-2" placeholder="Địa điểm">
                                <input type="email" id="deptEmail" class="form-control mb-2" placeholder="Email phòng ban">
                                <input type="text" id="deptPhone" class="form-control mb-2" placeholder="Số điện thoại">
                                <select id="deptStatus" class="form-select mb-2">
                                    <option value="active">Hoạt động</option>
                                    <option value="inactive">Không hoạt động</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Thêm mới',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const name = document.getElementById('deptName').value.trim();
                    const code = document.getElementById('deptCode').value.trim();
                    
                    if (!name || !code) {
                        Swal.showValidationMessage('Vui lòng nhập tên và mã phòng ban');
                        return false;
                    }
                    
                    return {
                        name: name,
                        code: code,
                        description: document.getElementById('deptDescription').value.trim(),
                        manager: document.getElementById('deptManager').value.trim(),
                        budget: parseInt(document.getElementById('deptBudget').value) || 0,
                        location: document.getElementById('deptLocation').value.trim(),
                        email: document.getElementById('deptEmail').value.trim(),
                        phone: document.getElementById('deptPhone').value.trim(),
                        status: document.getElementById('deptStatus').value,
                        staffCount: 0,
                        createdAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log('=== SAVING DEPARTMENT DATA ===');
                    
                    const newDepartment = result.value;
                    console.log('Department data to save:', newDepartment);
                    console.log('Current user auth state:', {
                        uid: auth.currentUser?.uid,
                        email: auth.currentUser?.email,
                        emailVerified: auth.currentUser?.emailVerified
                    });
                    
                    // Test Firebase connection trước
                    console.log('Testing Firebase connection...');
                    db.ref('.info/connected').once('value').then((snapshot) => {
                        console.log('Firebase connection status:', snapshot.val());
                        
                        if (snapshot.val() === true) {
                            console.log('✅ Firebase connected successfully');
                            
                            // Get fresh token trước khi save
                            return auth.currentUser.getIdToken(true).then((token) => {
                                console.log('Fresh ID token obtained (first 50 chars):', token.substring(0, 50) + '...');
                                
                                // Thử tạo department
                                console.log('Attempting to save to: departments/');
                                const savePromise = db.ref('departments').push(newDepartment);
                                console.log('Save promise created, waiting for result...');
                                
                                return savePromise;
                            });
                        } else {
                            throw new Error('Firebase not connected');
                        }
                    }).then((ref) => {
                        console.log('✅ Department created successfully!');
                        console.log('New department ID:', ref.key);
                        console.log('Full reference path:', ref.toString());
                        
                        loadDepartments();
                        Swal.fire('Thành công', 'Đã thêm phòng ban mới!', 'success');
                    }).catch((error) => {
                        console.error('❌ ERROR SAVING DEPARTMENT');
                        console.error('Error object:', error);
                        console.error('Error code:', error.code);
                        console.error('Error message:', error.message);
                        console.error('Error stack:', error.stack);
                        
                        // Log thêm thông tin debug
                        console.error('Current user at time of error:', {
                            uid: auth.currentUser?.uid,
                            email: auth.currentUser?.email,
                            emailVerified: auth.currentUser?.emailVerified
                        });
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            html: `
                                <p>Không thể thêm phòng ban:</p>
                                <p><strong>Mã lỗi:</strong> ${error.code}</p>
                                <p><strong>Thông điệp:</strong> ${error.message}</p>
                                <p><em>Kiểm tra Console để xem chi tiết</em></p>
                            `
                        });
                    });
                }
            });
        }

        function editDepartment(deptId) {
            const department = allDepartments.find(d => d.id === deptId);
            if (!department) {
                Swal.fire('Lỗi', 'Không tìm thấy phòng ban này.', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Chỉnh sửa phòng ban',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="editDeptName" class="form-control mb-2" value="${department.name || ''}" placeholder="Tên phòng ban *" required>
                                <input type="text" id="editDeptCode" class="form-control mb-2" value="${department.code || ''}" placeholder="Mã phòng ban *" required>
                                <textarea id="editDeptDescription" class="form-control mb-2" rows="3" placeholder="Mô tả phòng ban">${department.description || ''}</textarea>
                                <input type="text" id="editDeptManager" class="form-control mb-2" value="${department.manager || ''}" placeholder="Trưởng phòng">
                            </div>
                            <div class="col-md-6">
                                <input type="number" id="editDeptBudget" class="form-control mb-2" value="${department.budget || ''}" placeholder="Ngân sách (VNĐ)" min="0">
                                <input type="text" id="editDeptLocation" class="form-control mb-2" value="${department.location || ''}" placeholder="Địa điểm">
                                <input type="email" id="editDeptEmail" class="form-control mb-2" value="${department.email || ''}" placeholder="Email phòng ban">
                                <input type="text" id="editDeptPhone" class="form-control mb-2" value="${department.phone || ''}" placeholder="Số điện thoại">
                                <select id="editDeptStatus" class="form-select mb-2">
                                    <option value="active" ${department.status === 'active' ? 'selected' : ''}>Hoạt động</option>
                                    <option value="inactive" ${department.status === 'inactive' ? 'selected' : ''}>Không hoạt động</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Lưu thay đổi',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const name = document.getElementById('editDeptName').value.trim();
                    const code = document.getElementById('editDeptCode').value.trim();
                    
                    if (!name || !code) {
                        Swal.showValidationMessage('Vui lòng nhập tên và mã phòng ban');
                        return false;
                    }
                    
                    return {
                        name: name,
                        code: code,
                        description: document.getElementById('editDeptDescription').value.trim(),
                        manager: document.getElementById('editDeptManager').value.trim(),
                        budget: parseInt(document.getElementById('editDeptBudget').value) || 0,
                        location: document.getElementById('editDeptLocation').value.trim(),
                        email: document.getElementById('editDeptEmail').value.trim(),
                        phone: document.getElementById('editDeptPhone').value.trim(),
                        status: document.getElementById('editDeptStatus').value,
                        updatedAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedDepartment = result.value;
                    db.ref('departments/' + deptId).update(updatedDepartment).then(() => {
                        loadDepartments();
                        Swal.fire('Thành công', 'Đã cập nhật phòng ban!', 'success');
                    }).catch((error) => {
                        console.error('Error updating department:', error);
                        Swal.fire('Lỗi', 'Không thể cập nhật phòng ban.', 'error');
                    });
                }
            });
        }

        function viewDepartment(deptId) {
            const department = allDepartments.find(d => d.id === deptId);
            if (!department) {
                Swal.fire('Lỗi', 'Không tìm thấy phòng ban này.', 'error');
                return;
            }
            
            const budget = department.budget ? department.budget.toLocaleString('vi-VN') + ' VNĐ' : 'Chưa có';
            const created = department.createdAt ? new Date(department.createdAt).toLocaleDateString('vi-VN') : 'N/A';
            const updated = department.updatedAt ? new Date(department.updatedAt).toLocaleDateString('vi-VN') : 'N/A';
            
            Swal.fire({
                title: `Chi tiết phòng ban: ${department.name}`,
                html: `
                    <div class="container-fluid text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-info-circle"></i> Thông tin cơ bản</h6>
                                <p><strong>Tên phòng ban:</strong> ${department.name}</p>
                                <p><strong>Mã phòng ban:</strong> ${department.code}</p>
                                <p><strong>Mô tả:</strong> ${department.description || 'Không có'}</p>
                                <p><strong>Trưởng phòng:</strong> ${department.manager || 'Chưa có'}</p>
                                <p><strong>Số nhân viên:</strong> ${department.staffCount || 0} người</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-contact-card"></i> Thông tin liên hệ</h6>
                                <p><strong>Ngân sách:</strong> ${budget}</p>
                                <p><strong>Địa điểm:</strong> ${department.location || 'Không có'}</p>
                                <p><strong>Email:</strong> ${department.email || 'Không có'}</p>
                                <p><strong>Số điện thoại:</strong> ${department.phone || 'Không có'}</p>
                                <p><strong>Trạng thái:</strong> ${department.status === 'active' ? 'Hoạt động' : 'Không hoạt động'}</p>
                                <p><strong>Ngày tạo:</strong> ${created}</p>
                                <p><strong>Cập nhật lần cuối:</strong> ${updated}</p>
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                confirmButtonText: 'Đóng'
            });
        }

        function deleteDepartment(deptId) {
            const department = allDepartments.find(d => d.id === deptId);
            if (!department) {
                Swal.fire('Lỗi', 'Không tìm thấy phòng ban này.', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: `Bạn có chắc chắn muốn xóa phòng ban "${department.name}"? Hành động này không thể hoàn tác!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('departments/' + deptId).remove().then(() => {
                        loadDepartments();
                        Swal.fire('Đã xóa', 'Phòng ban đã được xóa thành công.', 'success');
                    }).catch((error) => {
                        console.error('Error deleting department:', error);
                        Swal.fire('Lỗi', 'Không thể xóa phòng ban.', 'error');
                    });
                }
            });
        }

        // Staff Management Section Logic - Booking.com style
        function filterAndDisplayStaff() {
            let filteredStaff = [...allStaff];
            const searchTerm = document.getElementById('staffSearchInput')?.value.toLowerCase().trim() || '';
            const roleFilter = document.getElementById('staffRoleFilter')?.value || 'all';
            if (searchTerm) {
                filteredStaff = filteredStaff.filter(s =>
                    (s.name && s.name.toLowerCase().includes(searchTerm)) ||
                    (s.email && s.email.toLowerCase().includes(searchTerm)) ||
                    (s.phone && s.phone.includes(searchTerm))
                );
            }
            if (roleFilter !== 'all') {
                filteredStaff = filteredStaff.filter(s => s.role === roleFilter);
            }
            renderStaffTable(filteredStaff);
        }

        function loadStaff() {
            const staffTable = document.getElementById('staffTable');
            staffTable.innerHTML = '<tr><td colspan="7" class="text-center">Đang tải dữ liệu...</td></tr>';
            db.ref('staff').on('value', (snapshot) => {
                allStaff = [];
                if (snapshot.exists()) {
                    snapshot.forEach((staffSnapshot) => {
                        const staff = staffSnapshot.val();
                        staff.id = staffSnapshot.key;
                        allStaff.push(staff);
                    });
                }
                filterAndDisplayStaff();
            }, (error) => {
                staffTable.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>';
            });
        }

        function loadStaffRoleFilter() {
            const roleFilter = document.getElementById('staffRoleFilter');
            if (!roleFilter) return;
            
            // Lưu giá trị hiện tại
            const currentValue = roleFilter.value;
            
            // Load roles từ Firebase
            db.ref('roles').once('value').then((snapshot) => {
                // Reset filter với option "Tất cả vai trò"
                roleFilter.innerHTML = '<option value="all">Tất cả vai trò</option>';
                
                if (snapshot.exists()) {
                    snapshot.forEach((roleSnapshot) => {
                        const role = roleSnapshot.val();
                        if (role.name && role.code) {
                            const option = document.createElement('option');
                            option.value = role.code;
                            option.textContent = role.name;
                            roleFilter.appendChild(option);
                        }
                    });
                } else {
                    // Fallback options nếu không có roles trong database
                    const fallbackRoles = [
                        {code: 'admin', name: 'Quản trị viên'},
                        {code: 'cskh', name: 'Chăm sóc khách hàng'},
                        {code: 'manager', name: 'Quản lý khách sạn'},
                        {code: 'marketing', name: 'Marketing'},
                        {code: 'kythuat', name: 'Kỹ thuật'},
                        {code: 'receptionist', name: 'Lễ tân'},
                        {code: 'housekeeping', name: 'Buồng phòng'},
                        {code: 'security', name: 'Bảo vệ'},
                        {code: 'finance', name: 'Kế toán'},
                        {code: 'hr', name: 'Nhân sự'}
                    ];
                    
                    fallbackRoles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.code;
                        option.textContent = role.name;
                        roleFilter.appendChild(option);
                    });
                }
                
                // Khôi phục giá trị đã chọn (nếu có)
                if (currentValue) {
                    roleFilter.value = currentValue;
                }
                
            }).catch((error) => {
                console.error('Error loading roles for filter:', error);
                // Sử dụng fallback nếu có lỗi
                roleFilter.innerHTML = `
                    <option value="all">Tất cả vai trò</option>
                    <option value="admin">Quản trị viên</option>
                    <option value="cskh">Chăm sóc khách hàng</option>
                    <option value="manager">Quản lý khách sạn</option>
                    <option value="marketing">Marketing</option>
                    <option value="kythuat">Kỹ thuật</option>
                    <option value="receptionist">Lễ tân</option>
                    <option value="housekeeping">Buồng phòng</option>
                    <option value="security">Bảo vệ</option>
                    <option value="finance">Kế toán</option>
                    <option value="hr">Nhân sự</option>
                `;
            });
        }

        function loadDepartmentOptions(selectElementId) {
            const departmentSelect = document.getElementById(selectElementId);
            if (!departmentSelect) return Promise.resolve();
            
            return db.ref('departments').once('value').then((snapshot) => {
                // Lưu giá trị hiện tại
                const currentValue = departmentSelect.value;
                
                // Reset với option mặc định
                departmentSelect.innerHTML = '<option value="">Chọn phòng ban</option>';
                
                if (snapshot.exists()) {
                    snapshot.forEach((deptSnapshot) => {
                        const department = deptSnapshot.val();
                        if (department.name && department.status === 'active') {
                            const option = document.createElement('option');
                            option.value = department.code || department.name;
                            option.textContent = department.name;
                            departmentSelect.appendChild(option);
                        }
                    });
                } else {
                    // Fallback options nếu không có departments trong database
                    const fallbackDepartments = [
                        'Operations',
                        'Sales & Marketing', 
                        'Human Resources',
                        'Finance',
                        'IT',
                        'Customer Service'
                    ];
                    
                    fallbackDepartments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        option.textContent = dept;
                        departmentSelect.appendChild(option);
                    });
                }
                
                // Khôi phục giá trị đã chọn (nếu có)
                if (currentValue) {
                    departmentSelect.value = currentValue;
                }
                
            }).catch((error) => {
                console.error('Error loading departments:', error);
                // Sử dụng fallback nếu có lỗi
                departmentSelect.innerHTML = `
                    <option value="">Chọn phòng ban</option>
                    <option value="Operations">Vận hành</option>
                    <option value="Sales & Marketing">Kinh doanh & Marketing</option>
                    <option value="Human Resources">Nhân sự</option>
                    <option value="Finance">Tài chính</option>
                    <option value="IT">Công nghệ thông tin</option>
                    <option value="Customer Service">Chăm sóc khách hàng</option>
                `;
            });
        }

        function renderStaffTable(staffList) {
            const staffTable = document.getElementById('staffTable');
            staffTable.innerHTML = '';
            if (staffList.length === 0) {
                staffTable.innerHTML = '<tr><td colspan="7" class="text-center py-5">Không tìm thấy nhân viên phù hợp.</td></tr>';
                return;
            }
            staffList.forEach(staff => {
                const avatar = staff.avatar ? `<img src="${staff.avatar}" alt="avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : '<span class="avatar-placeholder" style="display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;background-color:#e9ecef;border-radius:50%;color:#6c757d;"><i class="fas fa-user"></i></span>';
                const joined = staff.joinedAt ? new Date(staff.joinedAt).toLocaleDateString('vi-VN') : 'N/A';
                
                // Dynamic role display từ Firebase
                let roleDisplay = 'Chưa phân vai trò';
                if (staff.role) {
                    // Tìm role từ allRoles (Firebase data)
                    const roleData = allRoles.find(r => r.code === staff.role);
                    if (roleData && roleData.name) {
                        roleDisplay = roleData.name;
                    } else {
                        // Fallback mapping nếu không tìm thấy trong Firebase
                        const roleDisplayNames = {
                            'cskh': 'Chăm sóc khách hàng',
                            'manager': 'Quản lý khách sạn',
                            'marketing': 'Marketing',
                            'kythuat': 'Kỹ thuật',
                            'admin': 'Quản trị viên',
                            'receptionist': 'Lễ tân',
                            'housekeeping': 'Buồng phòng',
                            'security': 'Bảo vệ',
                            'finance': 'Kế toán',
                            'hr': 'Nhân sự'
                        };
                        roleDisplay = roleDisplayNames[staff.role] || staff.role;
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${avatar}</td>
                    <td>
                        <div class="fw-bold">${staff.name || 'N/A'}</div>
                        <small class="text-muted">${staff.employeeId || 'N/A'}</small>
                    </td>
                    <td>${staff.email || 'N/A'}</td>
                    <td>${staff.phone || 'N/A'}</td>
                    <td>
                        <span class="badge bg-primary">${roleDisplay}</span>
                    </td>
                    <td>${joined}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info" onclick="viewStaff('${staff.id}')" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editStaff('${staff.id}')" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStaff('${staff.id}')" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                staffTable.appendChild(row);
            });
        }

        function addStaff() {
            // Load danh sách users, roles và departments từ Firebase trước khi hiển thị modal
            Promise.all([
                db.ref('users').once('value'),
                db.ref('roles').once('value'),
                db.ref('departments').once('value')
            ]).then(([usersSnapshot, rolesSnapshot, departmentsSnapshot]) => {
                let usersOptions = '<option value="">-- Nhập thủ công hoặc chọn từ danh sách --</option>';
                let rolesOptions = '<option value="">Chọn chức vụ *</option>';
                let departmentsOptions = '<option value="">Chọn phòng ban</option>';
                
                // Load users options
                if (usersSnapshot.exists()) {
                    usersSnapshot.forEach((userSnapshot) => {
                        const user = userSnapshot.val();
                        const userId = userSnapshot.key;
                        if (user.name && user.phone) {
                            usersOptions += `<option value="${userId}" data-user='${JSON.stringify(user)}'>${user.name} - ${user.phone}</option>`;
                        }
                    });
                }
                
                // Load roles options
                window.rolesData = {}; // Khởi tạo đối tượng lưu trữ thông tin roles
                if (rolesSnapshot.exists()) {
                    rolesSnapshot.forEach((roleSnapshot) => {
                        const role = roleSnapshot.val();
                        const roleId = roleSnapshot.key;
                        if (role.name && role.code) {
                            // Lưu thông tin role vào window.rolesData
                            window.rolesData[role.code] = role;
                            
                            const salary = role.salary ? ` - ${role.salary.toLocaleString('vi-VN')} VNĐ` : '';
                            const allowance = role.allowance ? ` + ${role.allowance.toLocaleString('vi-VN')} VNĐ phụ cấp` : '';
                            rolesOptions += `<option value="${role.code}" data-role='${JSON.stringify(role)}'>${role.name} (${role.code})${salary}${allowance}</option>`;
                        }
                    });
                } else {
                    // Fallback options nếu không có roles trong database
                    rolesOptions += `
                        <option value="cskh">Chăm sóc khách hàng</option>
                        <option value="manager">Quản lý khách sạn</option>
                        <option value="marketing">Marketing</option>
                        <option value="kythuat">Kỹ thuật</option>
                        <option value="admin">Quản trị viên</option>
                        <option value="receptionist">Lễ tân</option>
                        <option value="housekeeping">Buồng phòng</option>
                        <option value="security">Bảo vệ</option>
                        <option value="finance">Kế toán</option>
                        <option value="hr">Nhân sự</option>
                    `;
                }
                
                // Load departments options
                if (departmentsSnapshot.exists()) {
                    departmentsSnapshot.forEach((deptSnapshot) => {
                        const department = deptSnapshot.val();
                        if (department.name && department.status === 'active') {
                            departmentsOptions += `<option value="${department.code || department.name}">${department.name}</option>`;
                        }
                    });
                } else {
                    // Fallback options nếu không có departments trong database
                    departmentsOptions += `
                        <option value="Operations">Vận hành</option>
                        <option value="Sales & Marketing">Kinh doanh & Marketing</option>
                        <option value="Human Resources">Nhân sự</option>
                        <option value="Finance">Tài chính</option>
                        <option value="IT">Công nghệ thông tin</option>
                        <option value="Customer Service">Chăm sóc khách hàng</option>
                    `;
                }
                
                Swal.fire({
                title: 'Thêm nhân viên mới',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Thông tin cá nhân</h6>
                                <div class="mb-2">
                                    <label class="form-label">Chọn từ khách hàng hiện có (tùy chọn)</label>
                                    <select id="staffUserSelect" class="form-select" onchange="fillUserData()">
                                        ${usersOptions}
                                    </select>
                                </div>
                                <input type="text" id="staffName" class="form-control mb-2" placeholder="Họ và tên đầy đủ *" required>
                                <input type="date" id="staffBirthDate" class="form-control mb-2" placeholder="Ngày sinh">
                                <select id="staffGender" class="form-select mb-2">
                                    <option value="">Chọn giới tính</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                    <option value="Khác">Khác</option>
                                </select>
                                <input type="text" id="staffIdCard" class="form-control mb-2" placeholder="Số CCCD/CMND *" required>
                                <input type="date" id="staffIdCardDate" class="form-control mb-2" placeholder="Ngày cấp CCCD">
                                <input type="text" id="staffIdCardPlace" class="form-control mb-2" placeholder="Nơi cấp CCCD">
                                <input type="text" id="staffNationality" class="form-control mb-2" placeholder="Quốc tịch" value="Việt Nam">
                                <input type="text" id="staffEthnicity" class="form-control mb-2" placeholder="Dân tộc" value="Kinh">
                                <input type="text" id="staffReligion" class="form-control mb-2" placeholder="Tôn giáo">
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-address-card"></i> Thông tin liên hệ</h6>
                                <input type="email" id="staffEmail" class="form-control mb-2" placeholder="Email công ty *" required>
                                <input type="text" id="staffPhone" class="form-control mb-2" placeholder="Số điện thoại *" required>
                                <input type="text" id="staffPersonalPhone" class="form-control mb-2" placeholder="Số điện thoại cá nhân">
                                <textarea id="staffAddress" class="form-control mb-2" rows="2" placeholder="Địa chỉ thường trú"></textarea>
                                <textarea id="staffTempAddress" class="form-control mb-2" rows="2" placeholder="Địa chỉ tạm trú (nếu khác)"></textarea>
                                <input type="text" id="staffEmergencyContact" class="form-control mb-2" placeholder="Người liên hệ khẩn cấp">
                                <input type="text" id="staffEmergencyPhone" class="form-control mb-2" placeholder="Số điện thoại khẩn cấp">
                                <input type="text" id="staffRelationship" class="form-control mb-2" placeholder="Mối quan hệ (Cha/Mẹ/Anh/Chị/...)">

                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3"><i class="fas fa-graduation-cap"></i> Học vấn & Kinh nghiệm</h6>
                                <select id="staffEducation" class="form-select mb-2">
                                    <option value="">Trình độ học vấn</option>
                                    <option value="Tiểu học">Tiểu học</option>
                                    <option value="Trung học cơ sở">Trung học cơ sở</option>
                                    <option value="Trung học phổ thông">Trung học phổ thông</option>
                                    <option value="Trung cấp">Trung cấp</option>
                                    <option value="Cao đẳng">Cao đẳng</option>
                                    <option value="Đại học">Đại học</option>
                                    <option value="Thạc sĩ">Thạc sĩ</option>
                                    <option value="Tiến sĩ">Tiến sĩ</option>
                                </select>
                                <input type="text" id="staffMajor" class="form-control mb-2" placeholder="Chuyên ngành">
                                <input type="text" id="staffSchool" class="form-control mb-2" placeholder="Trường học/Đại học">
                                <input type="number" id="staffExperience" class="form-control mb-2" placeholder="Số năm kinh nghiệm" min="0">
                                <textarea id="staffSkills" class="form-control mb-2" rows="2" placeholder="Kỹ năng chuyên môn"></textarea>
                                <textarea id="staffCertificates" class="form-control mb-2" rows="2" placeholder="Chứng chỉ/Bằng cấp khác"></textarea>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-briefcase"></i> Thông tin công việc</h6>
                                <select id="staffRole" class="form-select mb-2" required onchange="fillRoleData()">
                                    ${rolesOptions}
                                </select>
                                <div id="roleDetails" class="mb-2 p-2 bg-light rounded" style="display: none;">
                                    <small class="text-muted">
                                        <div><strong>Mô tả:</strong> <span id="roleDescription"></span></div>
                                        <div><strong>Quyền hạn:</strong> <span id="rolePermissions"></span></div>
                                        <div><strong>Lương cơ bản:</strong> <span id="roleSalary"></span></div>
                                        <div><strong>Phụ cấp:</strong> <span id="roleAllowance"></span></div>
                                    </small>
                                </div>
                                <select id="staffDepartment" class="form-select mb-2">
                                    ${departmentsOptions}
                                </select>
                                <input type="date" id="staffStartDate" class="form-control mb-2" placeholder="Ngày bắt đầu làm việc">
                                <select id="staffEmploymentType" class="form-select mb-2">
                                    <option value="Toàn thời gian">Toàn thời gian</option>
                                    <option value="Bán thời gian">Bán thời gian</option>
                                    <option value="Thử việc">Thử việc</option>
                                    <option value="Thực tập">Thực tập</option>
                                    <option value="Hợp đồng">Hợp đồng</option>
                                </select>
                                <input type="number" id="staffBasicSalary" class="form-control mb-2" placeholder="Lương cơ bản (VNĐ)" min="0">
                                <input type="text" id="staffBankAccount" class="form-control mb-2" placeholder="Số tài khoản ngân hàng">
                                <input type="text" id="staffBankName" class="form-control mb-2" placeholder="Tên ngân hàng">
                                <textarea id="staffNote" class="form-control mb-2" rows="2" placeholder="Ghi chú thêm"></textarea>
                            </div>
                        </div>
                    </div>
                `,
                width: '90%',
                showCancelButton: true,
                confirmButtonText: 'Thêm nhân viên',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const name = document.getElementById('staffName').value.trim();
                    const email = document.getElementById('staffEmail').value.trim();
                    const phone = document.getElementById('staffPhone').value.trim();
                    const idCard = document.getElementById('staffIdCard').value.trim();
                    const role = document.getElementById('staffRole').value;
                    
                    if (!name || !email || !phone || !idCard || !role) {
                        Swal.showValidationMessage('Vui lòng nhập đầy đủ các thông tin bắt buộc (*)');
                        return false;
                    }
                    
                    // Validate email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        Swal.showValidationMessage('Email không hợp lệ');
                        return false;
                    }
                    
                    // Validate phone
                    const phoneRegex = /^[0-9]{10,11}$/;
                    if (!phoneRegex.test(phone)) {
                        Swal.showValidationMessage('Số điện thoại phải có 10-11 chữ số');
                        return false;
                    }
                    
                    // Validate ID Card
                    const idCardRegex = /^[0-9]{9,12}$/;
                    if (!idCardRegex.test(idCard)) {
                        Swal.showValidationMessage('Số CCCD/CMND không hợp lệ');
                        return false;
                    }
                    
                    return {
                        // Thông tin cá nhân
                        name: name,
                        birthDate: (document.getElementById('staffBirthDate') || {}).value || '',
                        gender: (document.getElementById('staffGender') || {}).value || '',
                        idCard: idCard,
                        idCardDate: (document.getElementById('staffIdCardDate') || {}).value || '',
                        idCardPlace: (document.getElementById('staffIdCardPlace') || {}).value || '',
                        nationality: (document.getElementById('staffNationality') || {}).value || 'Việt Nam',
                        ethnicity: (document.getElementById('staffEthnicity') || {}).value || 'Kinh',
                        religion: (document.getElementById('staffReligion') || {}).value || '',
                        
                        // Thông tin liên hệ
                        email: email,
                        phone: phone,
                        personalPhone: (document.getElementById('staffPersonalPhone') || {}).value || '',
                        address: (document.getElementById('staffAddress') || {}).value || '',
                        tempAddress: (document.getElementById('staffTempAddress') || {}).value || '',
                        emergencyContact: (document.getElementById('staffEmergencyContact') || {}).value || '',
                        emergencyPhone: (document.getElementById('staffEmergencyPhone') || {}).value || '',
                        relationship: (document.getElementById('staffRelationship') || {}).value || '',
                        
                        // Học vấn & Kinh nghiệm
                        education: (document.getElementById('staffEducation') || {}).value || '',
                        major: (document.getElementById('staffMajor') || {}).value || '',
                        school: (document.getElementById('staffSchool') || {}).value || '',
                        experience: parseInt((document.getElementById('staffExperience') || {}).value) || 0,
                        skills: (document.getElementById('staffSkills') || {}).value || '',
                        certificates: (document.getElementById('staffCertificates') || {}).value || '',
                        
                        // Thông tin công việc
                        role: role,
                        department: (document.getElementById('staffDepartment') || {}).value || '',
                        startDate: (document.getElementById('staffStartDate') || {}).value || '',
                        employmentType: (document.getElementById('staffEmploymentType') || {}).value || 'Toàn thời gian',
                        basicSalary: parseInt((document.getElementById('staffBasicSalary') || {}).value) || 0,
                        bankAccount: (document.getElementById('staffBankAccount') || {}).value || '',
                        bankName: (document.getElementById('staffBankName') || {}).value || '',
                        note: (document.getElementById('staffNote') || {}).value || ''
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newStaff = result.value;
                    console.log('New staff data:', newStaff); // Debug log
                    
                    newStaff.joinedAt = Date.now();
                    newStaff.createdAt = Date.now();
                    newStaff.status = 'active';
                    newStaff.employeeId = 'EMP' + Date.now().toString().slice(-8); // Tạo mã nhân viên
                    
                    console.log('Attempting to save staff to Firebase...'); // Debug log
                    
                    db.ref('staff').push(newStaff).then(() => {
                        console.log('Staff saved successfully!'); // Debug log
                        loadStaff();
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: `Đã thêm nhân viên mới: ${newStaff.name}`,
                            timer: 2000
                        });
                    }).catch((error) => {
                        console.error('Error saving staff:', error); // Debug log
                        Swal.fire('Lỗi', 'Không thể thêm nhân viên: ' + error.message, 'error');
                    });
                }
            });
            }).catch((error) => {
                console.error('Error loading users for staff dropdown:', error);
                // Nếu lỗi load users, vẫn hiển thị modal nhưng không có dropdown
                Swal.fire({
                    title: 'Thêm nhân viên mới',
                    text: 'Lỗi tải danh sách khách hàng, vui lòng nhập thủ công.',
                    icon: 'warning'
                });
            });
        }

        // Function để điền dữ liệu từ user đã chọn
        function fillUserData() {
            const select = document.getElementById('staffUserSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value && selectedOption.dataset.user) {
                const userData = JSON.parse(selectedOption.dataset.user);
                
                // Điền thông tin cá nhân
                if (userData.name) document.getElementById('staffName').value = userData.name;
                if (userData.birthday) document.getElementById('staffBirthDate').value = userData.birthday;
                if (userData.gender) document.getElementById('staffGender').value = userData.gender;
                if (userData.identityNumber) document.getElementById('staffIdCard').value = userData.identityNumber;
                if (userData.nationality) document.getElementById('staffNationality').value = userData.nationality;
                
                // Điền thông tin liên hệ (nếu có email trong dữ liệu user)
                if (userData.email) document.getElementById('staffEmail').value = userData.email;
                if (userData.phone) document.getElementById('staffPhone').value = userData.phone;
                if (userData.address) document.getElementById('staffAddress').value = userData.address;
                
                // Tự động điền một số thông tin mặc định
                document.getElementById('staffEmploymentType').value = 'Toàn thời gian';
                document.getElementById('staffStartDate').value = new Date().toISOString().split('T')[0];
                
                Swal.showValidationMessage('Đã điền thông tin từ khách hàng: ' + userData.name);
                setTimeout(() => {
                    Swal.resetValidationMessage();
                }, 2000);
            }
        }

        // Hàm điền thông tin chức vụ khi chọn
        function fillRoleData() {
            const roleSelect = document.getElementById('staffRole');
            const roleDetails = document.getElementById('roleDetails');
            const roleValue = roleSelect.value;

            console.log('fillRoleData called with:', roleValue); // Debug log
            console.log('rolesData:', window.rolesData); // Debug log

            if (roleValue && window.rolesData && window.rolesData[roleValue]) {
                const roleData = window.rolesData[roleValue];
                console.log('Selected role data:', roleData); // Debug log
                
                // Hiển thị thông tin chi tiết chức vụ
                document.getElementById('roleDescription').textContent = roleData.description || 'Chưa có mô tả';
                
                // Xử lý permissions - có thể là string hoặc array
                let permissionsText = 'Chưa có quyền hạn';
                if (roleData.permissions) {
                    if (Array.isArray(roleData.permissions)) {
                        permissionsText = roleData.permissions.join(', ');
                    } else {
                        permissionsText = roleData.permissions;
                    }
                }
                document.getElementById('rolePermissions').textContent = permissionsText;
                
                document.getElementById('roleSalary').textContent = roleData.salary ? formatCurrency(roleData.salary) : 'Chưa có thông tin';
                document.getElementById('roleAllowance').textContent = roleData.allowance ? formatCurrency(roleData.allowance) : 'Chưa có thông tin';
                
                roleDetails.style.display = 'block';
                
                // Tự động điền lương cơ bản vào form với delay nhỏ
                setTimeout(() => {
                    const salaryField = document.getElementById('staffBasicSalary');
                    console.log('Salary field found:', salaryField); // Debug log
                    
                    if (roleData.salary && salaryField) {
                        salaryField.value = roleData.salary;
                        console.log('Salary filled:', roleData.salary); // Debug log
                        
                        // Trigger change event để đảm bảo UI update
                        salaryField.dispatchEvent(new Event('change'));
                    }
                }, 100);
                
                // Tạo một thông báo nhỏ về phụ cấp (vì không có field riêng cho phụ cấp)
                setTimeout(() => {
                    if (roleData.allowance) {
                        const noteField = document.getElementById('staffNote');
                        if (noteField) {
                            const currentNote = noteField.value;
                            const allowanceNote = `Phụ cấp chức vụ: ${formatCurrency(roleData.allowance)}`;
                            
                            if (!currentNote.includes('Phụ cấp chức vụ:')) {
                                noteField.value = currentNote ? `${currentNote}\n${allowanceNote}` : allowanceNote;
                                console.log('Allowance note added:', allowanceNote); // Debug log
                            }
                        }
                    }
                }, 100);
                
            } else {
                roleDetails.style.display = 'none';
                // Xóa giá trị lương cơ bản nếu không có chức vụ
                setTimeout(() => {
                    const salaryField = document.getElementById('staffBasicSalary');
                    if (salaryField) {
                        salaryField.value = '';
                    }
                    
                    // Xóa thông tin phụ cấp khỏi ghi chú
                    const noteField = document.getElementById('staffNote');
                    if (noteField && noteField.value.includes('Phụ cấp chức vụ:')) {
                        noteField.value = noteField.value.replace(/Phụ cấp chức vụ:.*?\n?/g, '').trim();
                    }
                }, 100);
            }
        }

        // Hàm format tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function viewStaff(staffId) {
            const staff = allStaff.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire('Lỗi', 'Không tìm thấy nhân viên này.', 'error');
                return;
            }
            
            Swal.fire({
                title: `<i class="fas fa-user-circle"></i> Thông tin nhân viên: ${staff.name}`,
                html: `
                    <div class="container-fluid text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="fas fa-user"></i> Thông tin cá nhân</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Mã nhân viên:</strong> ${staff.employeeId || 'N/A'}</p>
                                        <p><strong>Họ và tên:</strong> ${staff.name || 'N/A'}</p>
                                        <p><strong>Ngày sinh:</strong> ${staff.birthDate ? new Date(staff.birthDate).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        <p><strong>Giới tính:</strong> ${staff.gender || 'N/A'}</p>
                                        <p><strong>CCCD/CMND:</strong> ${staff.idCard || 'N/A'}</p>
                                        <p><strong>Ngày cấp:</strong> ${staff.idCardDate ? new Date(staff.idCardDate).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        <p><strong>Nơi cấp:</strong> ${staff.idCardPlace || 'N/A'}</p>
                                        <p><strong>Quốc tịch:</strong> ${staff.nationality || 'N/A'}</p>
                                        <p><strong>Dân tộc:</strong> ${staff.ethnicity || 'N/A'}</p>
                                        <p><strong>Tôn giáo:</strong> ${staff.religion || 'N/A'}</p>
                                    </div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-address-card"></i> Thông tin liên hệ</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Email công ty:</strong> ${staff.email || 'N/A'}</p>
                                        <p><strong>Điện thoại:</strong> ${staff.phone || 'N/A'}</p>
                                        <p><strong>Điện thoại cá nhân:</strong> ${staff.personalPhone || 'N/A'}</p>
                                        <p><strong>Địa chỉ thường trú:</strong> ${staff.address || 'N/A'}</p>
                                        <p><strong>Địa chỉ tạm trú:</strong> ${staff.tempAddress || 'N/A'}</p>
                                        <p><strong>Liên hệ khẩn cấp:</strong> ${staff.emergencyContact || 'N/A'}</p>
                                        <p><strong>SĐT khẩn cấp:</strong> ${staff.emergencyPhone || 'N/A'}</p>
                                        <p><strong>Mối quan hệ:</strong> ${staff.relationship || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fas fa-graduation-cap"></i> Học vấn & Kinh nghiệm</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Trình độ học vấn:</strong> ${staff.education || 'N/A'}</p>
                                        <p><strong>Chuyên ngành:</strong> ${staff.major || 'N/A'}</p>
                                        <p><strong>Trường học:</strong> ${staff.school || 'N/A'}</p>
                                        <p><strong>Kinh nghiệm:</strong> ${staff.experience || 0} năm</p>
                                        <p><strong>Kỹ năng:</strong> ${staff.skills || 'N/A'}</p>
                                        <p><strong>Chứng chỉ:</strong> ${staff.certificates || 'N/A'}</p>
                                    </div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-briefcase"></i> Thông tin công việc</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Chức vụ:</strong> ${staff.role || 'N/A'}</p>
                                        <p><strong>Phòng ban:</strong> ${staff.department || 'N/A'}</p>
                                        <p><strong>Ngày bắt đầu:</strong> ${staff.startDate ? new Date(staff.startDate).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                        <p><strong>Loại hợp đồng:</strong> ${staff.employmentType || 'N/A'}</p>
                                        <p><strong>Lương cơ bản:</strong> ${staff.basicSalary ? staff.basicSalary.toLocaleString('vi-VN') + ' VNĐ' : 'N/A'}</p>
                                        <p><strong>Tài khoản ngân hàng:</strong> ${staff.bankAccount || 'N/A'}</p>
                                        <p><strong>Ngân hàng:</strong> ${staff.bankName || 'N/A'}</p>
                                        <p><strong>Trạng thái:</strong> 
                                            <span class="badge ${staff.status === 'active' ? 'bg-success' : staff.status === 'inactive' ? 'bg-secondary' : 'bg-warning'}">
                                                ${staff.status === 'active' ? 'Đang làm việc' : staff.status === 'inactive' ? 'Đã nghỉ việc' : 'Tạm nghỉ'}
                                            </span>
                                        </p>
                                        <p><strong>Ghi chú:</strong> ${staff.note || 'N/A'}</p>
                                        <p><strong>Ngày tạo:</strong> ${staff.createdAt ? new Date(staff.createdAt).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                width: '90%',
                showCloseButton: true,
                focusConfirm: false,
                confirmButtonText: 'Đóng'
            });
        }

        function editStaff(staffId) {
            const staff = allStaff.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire('Lỗi', 'Không tìm thấy nhân viên này.', 'error');
                return;
            }
            
            // Load roles và departments từ Firebase trước khi hiển thị modal
            Promise.all([
                db.ref('roles').once('value'),
                db.ref('departments').once('value')
            ]).then(([rolesSnapshot, departmentsSnapshot]) => {
                let rolesOptions = '<option value="">Chọn chức vụ *</option>';
                let departmentsOptions = '<option value="">Phòng ban</option>';
                
                if (rolesSnapshot.exists()) {
                    rolesSnapshot.forEach((roleSnapshot) => {
                        const role = roleSnapshot.val();
                        const roleId = roleSnapshot.key;
                        if (role.name && role.code) {
                            const salary = role.salary ? ` - ${role.salary.toLocaleString('vi-VN')} VNĐ` : '';
                            const allowance = role.allowance ? ` + ${role.allowance.toLocaleString('vi-VN')} VNĐ phụ cấp` : '';
                            const isSelected = staff.role === role.code ? 'selected' : '';
                            rolesOptions += `<option value="${role.code}" ${isSelected} data-salary="${role.salary || 0}" data-allowance="${role.allowance || 0}" data-description="${role.description || ''}" data-permissions="${role.permissions || ''}">${role.name} (${role.code})${salary}${allowance}</option>`;
                        }
                    });
                } else {
                    // Fallback options nếu không có roles trong database
                    rolesOptions += `
                        <option value="cskh" ${staff.role === 'cskh' ? 'selected' : ''}>Chăm sóc khách hàng</option>
                        <option value="manager" ${staff.role === 'manager' ? 'selected' : ''}>Quản lý khách sạn</option>
                        <option value="marketing" ${staff.role === 'marketing' ? 'selected' : ''}>Marketing</option>
                        <option value="kythuat" ${staff.role === 'kythuat' ? 'selected' : ''}>Kỹ thuật</option>
                        <option value="admin" ${staff.role === 'admin' ? 'selected' : ''}>Quản trị viên</option>
                        <option value="receptionist" ${staff.role === 'receptionist' ? 'selected' : ''}>Lễ tân</option>
                        <option value="housekeeping" ${staff.role === 'housekeeping' ? 'selected' : ''}>Buồng phòng</option>
                        <option value="security" ${staff.role === 'security' ? 'selected' : ''}>Bảo vệ</option>
                        <option value="finance" ${staff.role === 'finance' ? 'selected' : ''}>Kế toán</option>
                        <option value="hr" ${staff.role === 'hr' ? 'selected' : ''}>Nhân sự</option>
                    `;
                }
                
                // Load departments options
                if (departmentsSnapshot.exists()) {
                    departmentsSnapshot.forEach((deptSnapshot) => {
                        const department = deptSnapshot.val();
                        if (department.name && department.status === 'active') {
                            const isSelected = staff.department === (department.code || department.name) ? 'selected' : '';
                            departmentsOptions += `<option value="${department.code || department.name}" ${isSelected}>${department.name}</option>`;
                        }
                    });
                } else {
                    // Fallback options nếu không có departments trong database
                    departmentsOptions += `
                        <option value="Operations" ${staff.department === 'Operations' ? 'selected' : ''}>Vận hành</option>
                        <option value="Sales & Marketing" ${staff.department === 'Sales & Marketing' ? 'selected' : ''}>Kinh doanh & Marketing</option>
                        <option value="Human Resources" ${staff.department === 'Human Resources' ? 'selected' : ''}>Nhân sự</option>
                        <option value="Finance" ${staff.department === 'Finance' ? 'selected' : ''}>Tài chính</option>
                        <option value="IT" ${staff.department === 'IT' ? 'selected' : ''}>Công nghệ thông tin</option>
                        <option value="Customer Service" ${staff.department === 'Customer Service' ? 'selected' : ''}>Chăm sóc khách hàng</option>
                    `;
                }
            
            Swal.fire({
                title: 'Chỉnh sửa thông tin nhân viên',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Thông tin cá nhân</h6>
                                <input type="text" id="editStaffName" class="form-control mb-2" placeholder="Họ và tên đầy đủ *" value="${staff.name || ''}" required>
                                <input type="date" id="editStaffBirthDate" class="form-control mb-2" value="${staff.birthDate || ''}">
                                <select id="editStaffGender" class="form-select mb-2">
                                    <option value="">Chọn giới tính</option>
                                    <option value="Nam" ${staff.gender === 'Nam' ? 'selected' : ''}>Nam</option>
                                    <option value="Nữ" ${staff.gender === 'Nữ' ? 'selected' : ''}>Nữ</option>
                                    <option value="Khác" ${staff.gender === 'Khác' ? 'selected' : ''}>Khác</option>
                                </select>
                                <input type="text" id="editStaffIdCard" class="form-control mb-2" placeholder="Số CCCD/CMND *" value="${staff.idCard || ''}" required>
                                <input type="date" id="editStaffIdCardDate" class="form-control mb-2" value="${staff.idCardDate || ''}">
                                <input type="text" id="editStaffIdCardPlace" class="form-control mb-2" placeholder="Nơi cấp CCCD" value="${staff.idCardPlace || ''}">
                                <input type="text" id="editStaffNationality" class="form-control mb-2" placeholder="Quốc tịch" value="${staff.nationality || 'Việt Nam'}">
                                <input type="text" id="editStaffEthnicity" class="form-control mb-2" placeholder="Dân tộc" value="${staff.ethnicity || 'Kinh'}">
                                <input type="text" id="editStaffReligion" class="form-control mb-2" placeholder="Tôn giáo" value="${staff.religion || ''}">
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-address-card"></i> Thông tin liên hệ</h6>
                                <input type="email" id="editStaffEmail" class="form-control mb-2" placeholder="Email công ty *" value="${staff.email || ''}" required>
                                <input type="text" id="editStaffPhone" class="form-control mb-2" placeholder="Số điện thoại *" value="${staff.phone || ''}" required>
                                <input type="text" id="editStaffPersonalPhone" class="form-control mb-2" placeholder="Số điện thoại cá nhân" value="${staff.personalPhone || ''}">
                                <textarea id="editStaffAddress" class="form-control mb-2" rows="2" placeholder="Địa chỉ thường trú">${staff.address || ''}</textarea>
                                <textarea id="editStaffTempAddress" class="form-control mb-2" rows="2" placeholder="Địa chỉ tạm trú">${staff.tempAddress || ''}</textarea>
                                <input type="text" id="editStaffEmergencyContact" class="form-control mb-2" placeholder="Người liên hệ khẩn cấp" value="${staff.emergencyContact || ''}">
                                <input type="text" id="editStaffEmergencyPhone" class="form-control mb-2" placeholder="SĐT người liên hệ khẩn cấp" value="${staff.emergencyPhone || ''}">
                                <input type="text" id="editStaffRelationship" class="form-control mb-2" placeholder="Mối quan hệ" value="${staff.relationship || ''}">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3"><i class="fas fa-graduation-cap"></i> Học vấn & Kinh nghiệm</h6>
                                <select id="editStaffEducation" class="form-select mb-2">
                                    <option value="">Trình độ học vấn</option>
                                    <option value="Tiểu học" ${staff.education === 'Tiểu học' ? 'selected' : ''}>Tiểu học</option>
                                    <option value="Trung học cơ sở" ${staff.education === 'Trung học cơ sở' ? 'selected' : ''}>Trung học cơ sở</option>
                                    <option value="Trung học phổ thông" ${staff.education === 'Trung học phổ thông' ? 'selected' : ''}>Trung học phổ thông</option>
                                    <option value="Trung cấp" ${staff.education === 'Trung cấp' ? 'selected' : ''}>Trung cấp</option>
                                    <option value="Cao đẳng" ${staff.education === 'Cao đẳng' ? 'selected' : ''}>Cao đẳng</option>
                                    <option value="Đại học" ${staff.education === 'Đại học' ? 'selected' : ''}>Đại học</option>
                                    <option value="Thạc sĩ" ${staff.education === 'Thạc sĩ' ? 'selected' : ''}>Thạc sĩ</option>
                                    <option value="Tiến sĩ" ${staff.education === 'Tiến sĩ' ? 'selected' : ''}>Tiến sĩ</option>
                                </select>
                                <input type="text" id="editStaffMajor" class="form-control mb-2" placeholder="Chuyên ngành" value="${staff.major || ''}">
                                <input type="text" id="editStaffSchool" class="form-control mb-2" placeholder="Trường học/Đại học" value="${staff.school || ''}">
                                <input type="number" id="editStaffExperience" class="form-control mb-2" placeholder="Số năm kinh nghiệm" min="0" value="${staff.experience || 0}">
                                <textarea id="editStaffSkills" class="form-control mb-2" rows="2" placeholder="Kỹ năng chuyên môn">${staff.skills || ''}</textarea>
                                <textarea id="editStaffCertificates" class="form-control mb-2" rows="2" placeholder="Chứng chỉ/Bằng cấp khác">${staff.certificates || ''}</textarea>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info mb-3"><i class="fas fa-briefcase"></i> Thông tin công việc</h6>
                                <select id="editStaffRole" class="form-select mb-2" required onchange="updateEditRoleInfo()">
                                    ${rolesOptions}
                                </select>
                                <div id="editRoleDetails" class="mb-2 p-2 bg-light rounded" style="display: none;">
                                    <small class="text-muted">
                                        <div><strong>Mô tả:</strong> <span id="editRoleDescription"></span></div>
                                        <div><strong>Quyền hạn:</strong> <span id="editRolePermissions"></span></div>
                                        <div><strong>Lương cơ bản:</strong> <span id="editRoleSalary"></span></div>
                                        <div><strong>Phụ cấp:</strong> <span id="editRoleAllowance"></span></div>
                                    </small>
                                </div>
                                <select id="editStaffDepartment" class="form-select mb-2">
                                    ${departmentsOptions}
                                </select>
                                <input type="date" id="editStaffStartDate" class="form-control mb-2" value="${staff.startDate || ''}">
                                <select id="editStaffEmploymentType" class="form-select mb-2">
                                    <option value="Toàn thời gian" ${staff.employmentType === 'Toàn thời gian' ? 'selected' : ''}>Toàn thời gian</option>
                                    <option value="Bán thời gian" ${staff.employmentType === 'Bán thời gian' ? 'selected' : ''}>Bán thời gian</option>
                                    <option value="Thử việc" ${staff.employmentType === 'Thử việc' ? 'selected' : ''}>Thử việc</option>
                                    <option value="Thực tập" ${staff.employmentType === 'Thực tập' ? 'selected' : ''}>Thực tập</option>
                                    <option value="Hợp đồng" ${staff.employmentType === 'Hợp đồng' ? 'selected' : ''}>Hợp đồng</option>
                                </select>
                                <input type="number" id="editStaffBasicSalary" class="form-control mb-2" placeholder="Lương cơ bản (VNĐ)" min="0" value="${staff.basicSalary || ''}">
                                <input type="text" id="editStaffBankAccount" class="form-control mb-2" placeholder="Số tài khoản ngân hàng" value="${staff.bankAccount || ''}">
                                <input type="text" id="editStaffBankName" class="form-control mb-2" placeholder="Tên ngân hàng" value="${staff.bankName || ''}">
                                <select id="editStaffStatus" class="form-select mb-2">
                                    <option value="active" ${staff.status === 'active' ? 'selected' : ''}>Đang làm việc</option>
                                    <option value="inactive" ${staff.status === 'inactive' ? 'selected' : ''}>Đã nghỉ việc</option>
                                    <option value="leave" ${staff.status === 'leave' ? 'selected' : ''}>Tạm nghỉ</option>
                                </select>
                                <textarea id="editStaffNote" class="form-control mb-2" rows="2" placeholder="Ghi chú thêm">${staff.note || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `,
                width: '90%',
                showCancelButton: true,
                confirmButtonText: 'Lưu thay đổi',
                cancelButtonText: 'Hủy',
                didOpen: () => {
                    // Hiển thị thông tin role hiện tại nếu có
                    updateEditRoleInfo();
                },
                preConfirm: () => {
                    const name = document.getElementById('editStaffName').value.trim();
                    const email = document.getElementById('editStaffEmail').value.trim();
                    const phone = document.getElementById('editStaffPhone').value.trim();
                    const idCard = document.getElementById('editStaffIdCard').value.trim();
                    const role = document.getElementById('editStaffRole').value;
                    
                    if (!name || !email || !phone || !idCard || !role) {
                        Swal.showValidationMessage('Vui lòng nhập đầy đủ các thông tin bắt buộc (*)');
                        return false;
                    }
                    
                    // Validate email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        Swal.showValidationMessage('Email không hợp lệ');
                        return false;
                    }
                    
                    // Validate phone
                    const phoneRegex = /^[0-9]{10,11}$/;
                    if (!phoneRegex.test(phone)) {
                        Swal.showValidationMessage('Số điện thoại phải có 10-11 chữ số');
                        return false;
                    }
                    
                    // Validate ID Card
                    const idCardRegex = /^[0-9]{9,12}$/;
                    if (!idCardRegex.test(idCard)) {
                        Swal.showValidationMessage('Số CCCD/CMND không hợp lệ');
                        return false;
                    }
                    
                    return {
                        // Thông tin cá nhân
                        name: name,
                        birthDate: document.getElementById('editStaffBirthDate').value,
                        gender: document.getElementById('editStaffGender').value,
                        idCard: idCard,
                        idCardDate: document.getElementById('editStaffIdCardDate').value,
                        idCardPlace: document.getElementById('editStaffIdCardPlace').value,
                        nationality: document.getElementById('editStaffNationality').value || 'Việt Nam',
                        ethnicity: document.getElementById('editStaffEthnicity').value || 'Kinh',
                        religion: document.getElementById('editStaffReligion').value,
                        
                        // Thông tin liên hệ
                        email: email,
                        phone: phone,
                        personalPhone: document.getElementById('editStaffPersonalPhone').value,
                        address: document.getElementById('editStaffAddress').value,
                        tempAddress: document.getElementById('editStaffTempAddress').value,
                        emergencyContact: document.getElementById('editStaffEmergencyContact').value,
                        emergencyPhone: document.getElementById('editStaffEmergencyPhone').value,
                        relationship: document.getElementById('editStaffRelationship').value,
                        
                        // Học vấn & Kinh nghiệm
                        education: document.getElementById('editStaffEducation').value,
                        major: document.getElementById('editStaffMajor').value,
                        school: document.getElementById('editStaffSchool').value,
                        experience: parseInt(document.getElementById('editStaffExperience').value) || 0,
                        skills: document.getElementById('editStaffSkills').value,
                        certificates: document.getElementById('editStaffCertificates').value,
                        
                        // Thông tin công việc
                        role: role,
                        department: document.getElementById('editStaffDepartment').value,
                        startDate: document.getElementById('editStaffStartDate').value,
                        employmentType: document.getElementById('editStaffEmploymentType').value || 'Toàn thời gian',
                        basicSalary: parseInt(document.getElementById('editStaffBasicSalary').value) || 0,
                        bankAccount: document.getElementById('editStaffBankAccount').value,
                        bankName: document.getElementById('editStaffBankName').value,
                        status: document.getElementById('editStaffStatus').value,
                        note: document.getElementById('editStaffNote').value,
                        updatedAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedStaff = result.value;
                    db.ref('staff/' + staffId).update(updatedStaff).then(() => {
                        loadStaff();
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: 'Đã cập nhật thông tin nhân viên!',
                            timer: 2000
                        });
                    }).catch((error) => {
                        Swal.fire('Lỗi', 'Không thể cập nhật nhân viên: ' + error.message, 'error');
                    });
                }
            });
            
            }).catch((error) => {
                console.error('Error loading roles for edit:', error);
                Swal.fire('Lỗi', 'Không thể tải danh sách chức vụ: ' + error.message, 'error');
            });
        }

        function updateEditRoleInfo() {
            const roleSelect = document.getElementById('editStaffRole');
            const selectedOption = roleSelect.options[roleSelect.selectedIndex];
            const roleDetails = document.getElementById('editRoleDetails');
            
            if (selectedOption && selectedOption.value && selectedOption.hasAttribute('data-description')) {
                // Hiển thị thông tin role
                const description = selectedOption.getAttribute('data-description') || 'Không có mô tả';
                const permissions = selectedOption.getAttribute('data-permissions') || 'Không có quyền hạn';
                const salary = selectedOption.getAttribute('data-salary') || '0';
                const allowance = selectedOption.getAttribute('data-allowance') || '0';
                
                document.getElementById('editRoleDescription').textContent = description;
                document.getElementById('editRolePermissions').textContent = permissions;
                document.getElementById('editRoleSalary').textContent = parseInt(salary) ? parseInt(salary).toLocaleString('vi-VN') + ' VNĐ' : 'Chưa cấu hình';
                document.getElementById('editRoleAllowance').textContent = parseInt(allowance) ? parseInt(allowance).toLocaleString('vi-VN') + ' VNĐ' : 'Không có';
                
                roleDetails.style.display = 'block';
            } else {
                roleDetails.style.display = 'none';
            }
        }

        function deleteStaff(staffId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn không thể hoàn tác sau khi xóa!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('staff/' + staffId).remove().then(() => {
                        loadStaff();
                        Swal.fire('Đã xóa', 'Nhân viên đã bị xóa.', 'success');
                    }).catch((error) => {
                        Swal.fire('Lỗi', 'Không thể xóa nhân viên.', 'error');
                    });
                }
            });
        }

        function changeStaffRole(staffId, newRole) {
            db.ref('staff/' + staffId).update({ role: newRole }).then(() => {
                loadStaff();
            }).catch((error) => {
                Swal.fire('Lỗi', 'Không thể cập nhật vai trò.', 'error');
            });
        }
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.firebasestorage.app",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Biến toàn cục để lưu các thể hiện của biểu đồ
        let revenueChartInstance, bookingTypeChartInstance, newUsersChartInstance, locationChartInstance;
        // Biến lưu trữ dữ liệu gốc
        let allBookings = [], allUsers = [], allHotels = [], allTours = [], allDeals = [], allTravelGuides = [], allStaff = [];
        let miniRevenueChartInstance;

        // Kiểm tra đăng nhập và quyền admin/nhân viên
        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                console.log('Auth state changed:', user);
                
                if (!user) {
                    console.log('❌ No user authenticated - redirecting');
                    window.location.href = 'index.html';
                    return;
                }
                
                console.log('✅ User authenticated:', user.email);
                console.log('User UID:', user.uid);
                
                // Cho phép cả admin và nhân viên truy cập dashboard
                const isAdmin = user.email === 'quantrikhachsan@gmail.com';
                const isStaff = user.email === 'nhanvien2@luxuryhaven.com';
                
                console.log('Is Admin:', isAdmin);
                console.log('Is Staff:', isStaff);
                
                if (!isAdmin && !isStaff) {
                    console.log('❌ Access denied for user:', user.email);
                    Swal.fire({
                        icon: 'error',
                        title: 'Truy cập bị từ chối',
                        text: 'Bạn không có quyền truy cập trang này'
                    }).then(() => {
                        auth.signOut();
                        window.location.href = 'index.html';
                    });
                    return;
                }
                
                console.log('✅ Access granted for user:', user.email);
                
                // Test Firebase Rules ngay sau khi xác thực
                if (isAdmin) {
                    setTimeout(() => {
                        console.log('Running Firebase Rules test...');
                        testFirebaseRules();
                    }, 2000);
                }
                // Phân quyền giao diện cho nhân viên theo bảng phân quyền
                if (isStaff) {
                    // Ẩn các mục không được phép truy cập
                    const dealsNav = document.querySelector('a[href="#deals"]');
                    const guidesNav = document.querySelector('a[href="#travel-guides"]');
                    const settingsNav = document.querySelector('a[href="#settings"]');
                    if (dealsNav) dealsNav.style.display = 'none';
                    if (guidesNav) guidesNav.style.display = 'none';
                    if (settingsNav) settingsNav.style.display = 'none';
                    // Main content sections
                    const dealsSection = document.getElementById('deals');
                    const guidesSection = document.getElementById('travel-guides');
                    const settingsSection = document.getElementById('settings');
                    if (dealsSection) dealsSection.style.display = 'none';
                    if (guidesSection) guidesSection.style.display = 'none';
                    if (settingsSection) settingsSection.style.display = 'none';
                    // Cho phép xem thông báo
                    const notifBell = document.getElementById('notificationBell');
                    if (notifBell) notifBell.style.display = 'block';
                    // Khách sạn: chỉ cho xem, không cho thêm/sửa/xóa
                    const addHotelBtn = document.querySelector('#hotels .btn.btn-primary');
                    if (addHotelBtn) addHotelBtn.style.display = 'none';
                    // Người dùng: chỉ cho xem, không cho sửa/xóa
                    const usersTable = document.getElementById('usersTable');
                    if (usersTable) {
                        usersTable.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => btn.style.display = 'none');
                    }
                    // Tours: chỉ cho xem, không cho thêm/sửa/xóa
                    const addTourBtn = document.querySelector('#tours .btn.btn-primary');
                    if (addTourBtn) addTourBtn.style.display = 'none';
                    // Dashboard: cho xuất file
                    const exportExcelBtn = document.getElementById('export-excel-btn');
                    if (exportExcelBtn) exportExcelBtn.style.display = 'block';
                }
            });
        }

        // Đăng xuất
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Lỗi đăng xuất:', error);
            });
        }

        // Load statistics
        function loadStatistics() {
            // Load total hotels
            db.ref('location').once('value').then((snapshot) => {
                let totalHotels = 0;
                snapshot.forEach((locationSnapshot) => {
                    totalHotels += locationSnapshot.child('hotels').numChildren();
                });
                document.getElementById('totalHotels').textContent = totalHotels;
            });

            // Load today's bookings (bookings CREATED today)
            const startOfDay = new Date();
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date();
            endOfDay.setHours(23, 59, 59, 999);

            db.ref('bookings')
                .orderByChild('createdAt')
                .startAt(startOfDay.getTime())
                .endAt(endOfDay.getTime())
                .once('value')
                .then((snapshot) => {
                document.getElementById('todayBookings').textContent = snapshot.numChildren();
            });

            // Load total users
            db.ref('users').on('value', (snapshot) => {
                document.getElementById('totalUsers').textContent = snapshot.numChildren();
            });

            // Load active deals
            db.ref('specialOffers').once('value').then((snapshot) => {
                document.getElementById('activeDeals').textContent = snapshot.numChildren();
            });

            // Load chart data với delay để tránh conflict
            try {
                setTimeout(() => loadRevenueChart(), 100);
                setTimeout(() => loadBookingTypeChart(), 200);
                setTimeout(() => loadNewUsersChart(), 300);
                setTimeout(() => loadLocationChart(), 400);
            } catch (error) {
                console.error('Lỗi khi load charts:', error);
            }
        }

        // Load bookings data
        function loadBookings() {
            const bookingsRef = db.ref('bookings');
            bookingsRef.on('value', (snapshot) => {
                allBookings = [];
                snapshot.forEach((childSnapshot) => {
                    const booking = childSnapshot.val();
                    booking.id = childSnapshot.key;
                    allBookings.push(booking);
                });
                allBookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by most recent
                filterAndDisplayBookings(); 
            }, (error) => {
                console.error("Error loading bookings:", error);
                Swal.fire('Lỗi', 'Không thể tải danh sách đặt phòng.', 'error');
            });
        }
        
        function filterAndDisplayBookings() {
            let filteredBookings = [...allBookings];
            const searchContainer = document.getElementById('headerSearchContainer');

            if (searchContainer && searchContainer.style.display !== 'none') {
                 // 1. Search term filter
                const searchTerm = document.getElementById('globalSearchInput').value.toLowerCase().trim();
                if (searchTerm) {
                    filteredBookings = filteredBookings.filter(b => 
                        (b.id && b.id.toLowerCase().includes(searchTerm)) ||
                        (b.customerName && b.customerName.toLowerCase().includes(searchTerm)) ||
                        (b.customerEmail && b.customerEmail.toLowerCase().includes(searchTerm)) ||
                        (b.customerPhone && b.customerPhone.includes(searchTerm))
                    );
                }
            }

            // 2. Status filter
            const statusFilter = document.getElementById('bookingStatusFilter').value;
            if (statusFilter !== 'all') {
                filteredBookings = filteredBookings.filter(b => b.status === statusFilter);
            }

            // Lọc chỉ booking khách sạn, loại bỏ hoàn toàn booking tour
            filteredBookings = filteredBookings.filter(b => (!b.type && !b.bookingType) || b.type === 'hotel' || b.bookingType === 'hotel');
            
            renderBookingsTable(filteredBookings);
        }

        function renderBookingsTable(bookings) {
            const tableBody = document.getElementById('bookingsTable');
            tableBody.innerHTML = '';
            if (bookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" class="text-center py-5">Không tìm thấy dữ liệu phù hợp.</td></tr>';
                return;
            }
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                // Status Badge
                const statusBadge = `<span class="status status-${booking.status || 'pending'}">${booking.status || 'Chờ xác nhận'}</span>`;
                // Service Details
                let serviceDetails = '';
                if (booking.type === 'hotel' || booking.roomId || booking.roomName) {
                    serviceDetails = `
                        <strong title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</strong><br>
                        <small class="text-muted" title="${booking.roomId || booking.roomName || ''}">${booking.roomId || booking.roomName || 'N/A'}</small>
                    `;
                } else if (booking.type === 'tour') {
                    serviceDetails = `
                        <strong title="${booking.tourName || ''}">${booking.tourName || 'Tour'}</strong><br>
                        <small class="text-muted">Tour</small>
                    `;
                } else {
                    serviceDetails = 'Không xác định';
                }
                row.innerHTML = `
                    <td title="${booking.id}">${booking.id}</td>
                    <td title="${booking.customerName || ''}">${booking.customerName || 'N/A'}</td>
                    <td title="${booking.customerEmail || ''}">${booking.customerEmail || 'N/A'}</td>
                    <td title="${booking.customerPhone || ''}">${booking.customerPhone || 'N/A'}</td>
                    <td title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</td>
                    <td>${serviceDetails}</td>
                    <td title="${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : ''}">${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td title="${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : ''}">${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td title="${booking.guests || ''}">${booking.guests || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editBooking('${booking.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load users data
        function loadUsers() {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '<tr><td colspan="8" class="text-center">Đang tải dữ liệu...</td></tr>';

            db.ref('users').on('value', (snapshot) => {
                allUsers = []; // Reset
                if (snapshot.exists()) {
                    snapshot.forEach((userSnapshot) => {
                        const user = userSnapshot.val();
                        user.id = userSnapshot.key;
                        allUsers.push(user);
                    });
                }
                // Initial render after loading.
                filterAndDisplayUsers();
            }, (error) => {
                console.error('Error loading users:', error);
                usersTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>';
            });
        }
        
        function renderUsersTable(users) {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '';

            if (users.length === 0) {
                usersTable.innerHTML = '<tr><td colspan="10" class="text-center py-5">Không tìm thấy người dùng phù hợp.</td></tr>';
                return;
            }

            // Debug log để kiểm tra dữ liệu
            console.log('Rendering users:', users);

            users.forEach(user => {
                const avatar = user.avatar ? `<img src="${user.avatar}" alt="avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : '<span class="avatar-placeholder" style="display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;background-color:#e9ecef;border-radius:50%;color:#6c757d;"><i class="fas fa-user"></i></span>';
                
                const birthday = user.birthday || user.birthdate || '';
                const formattedBirthday = birthday ? new Date(birthday).toLocaleDateString('vi-VN') : 'N/A';
                
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : (user.updatedAt ? new Date(user.updatedAt).toLocaleDateString('vi-VN') : 'N/A');
                
                const memberLevel = user.memberLevel || 'Đồng';
                const loyaltyPoints = user.loyaltyPoints || 0;
                
                // Giới tính với icon
                const genderIcon = user.gender === 'Nam' ? '<i class="fas fa-mars text-info"></i>' : user.gender === 'Nữ' ? '<i class="fas fa-venus text-danger"></i>' : '<i class="fas fa-genderless text-muted"></i>';
                const genderDisplay = user.gender ? `${genderIcon} ${user.gender}` : 'N/A';
                
                // Trạng thái tài khoản
                const status = user.status || 'active';
                const statusBadge = status === 'active' ? '<span class="badge bg-success">Hoạt động</span>' : 
                                   status === 'inactive' ? '<span class="badge bg-warning">Tạm khóa</span>' :
                                   status === 'banned' ? '<span class="badge bg-danger">Bị cấm</span>' :
                                   '<span class="badge bg-secondary">Không xác định</span>';
                
                // Quốc tịch với cờ
                const nationality = user.nationality || 'Việt Nam';
                const flagIcon = nationality === 'Việt Nam' ? '🇻🇳' : '🏳️';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${avatar}</td>
                    <td>
                        <div class="fw-bold">${user.name || 'N/A'}</div>
                        <small class="text-muted">
                            <i class="fas fa-crown text-warning"></i> ${memberLevel} 
                            <span class="badge bg-light text-dark ms-1">${loyaltyPoints} điểm</span>
                        </small>
                    </td>
                    <td>
                        <div>${user.email || 'N/A'}</div>
                        <small class="text-muted">
                            <i class="fas fa-phone text-success"></i> ${user.phone || 'N/A'}
                        </small>
                    </td>
                    <td>${genderDisplay}</td>
                    <td>
                        <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${user.address || 'N/A'}">
                            ${user.address || 'N/A'}
                        </div>
                    </td>
                    <td>${flagIcon} ${nationality}</td>
                    <td>${formattedBirthday}</td>
                    <td>
                        <div>${createdAt}</div>
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('vi-VN') : 'Chưa đăng nhập'}
                        </small>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-info" onclick="viewUser('${user.id}')" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editUser('${user.id}')" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm ${status === 'active' ? 'btn-secondary' : 'btn-success'}" onclick="toggleUserStatus('${user.id}', '${status}')" title="${status === 'active' ? 'Khóa tài khoản' : 'Kích hoạt tài khoản'}">
                                <i class="fas ${status === 'active' ? 'fa-lock' : 'fa-unlock'}"></i>
                            </button>
                        </div>
                    </td>
                `;
                usersTable.appendChild(row);
            });
        }
        
        function filterAndDisplayUsers() {
            let filteredUsers = [...allUsers];
            
            // Lấy từ khóa tìm kiếm từ input riêng cho users
            const searchTerm = (document.getElementById('userSearchInput') || {}).value ? 
                             document.getElementById('userSearchInput').value.toLowerCase().trim() : 
                             (document.getElementById('globalSearchInput') || {}).value ? 
                             document.getElementById('globalSearchInput').value.toLowerCase().trim() : '';

            // Lọc theo từ khóa tìm kiếm
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u =>
                    (u.name && u.name.toLowerCase().includes(searchTerm)) ||
                    (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                    (u.phone && u.phone.includes(searchTerm)) ||
                    (u.address && u.address.toLowerCase().includes(searchTerm)) ||
                    (u.nationality && u.nationality.toLowerCase().includes(searchTerm))
                );
            }
            
            // Lọc theo trạng thái
            const statusFilter = (document.getElementById('userStatusFilter') || {}).value || 'all';
            if (statusFilter !== 'all') {
                filteredUsers = filteredUsers.filter(u => (u.status || 'active') === statusFilter);
            }
            
            renderUsersTable(filteredUsers);
        }

        // Load hotels data
        function loadHotels() {
            const hotelsGrid = document.getElementById('hotelsGrid');
            hotelsGrid.innerHTML = '<div class="col-12 text-center">Đang tải dữ liệu...</div>';

            db.ref('location').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    hotelsGrid.innerHTML = '<div class="col-12 text-center">Không có dữ liệu</div>';
                    return;
                }

                hotelsGrid.innerHTML = '';
                snapshot.forEach((locationSnapshot) => {
                    const hotels = locationSnapshot.child('hotels').val();
                    if (!hotels) return;

                    Object.entries(hotels).forEach(([hotelId, hotel]) => {
                        const hotelCard = document.createElement('div');
                        hotelCard.className = 'col-md-4 mb-4';
                        hotelCard.innerHTML = `
                            <div class="card h-100">
                                <img src="${hotel.chiTiet.image || 'images/default-hotel.jpg'}" class="card-img-top" alt="${hotel.tenKhachSan}">
                                <div class="card-body">
                                    <h5 class="card-title">${hotel.tenKhachSan}</h5>
                                    <p class="card-text">${(hotel.moTa || '').substring(0, 100)}...</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">${hotel.xepHangSao} sao</span>
                                        <div>
                                            <button class="btn btn-action btn-view" onclick="viewHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-action btn-edit" onclick="editHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-action btn-delete" onclick="deleteHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        hotelsGrid.appendChild(hotelCard);
                    });
                });
            }).catch(error => {
                console.error('Error loading hotels:', error);
                hotelsGrid.innerHTML = '<div class="col-12 text-center text-danger">Lỗi khi tải dữ liệu</div>';
            });
        }

        // Load tours data
        function loadTours() {
            const toursAccordion = document.getElementById('toursAccordion');
            toursAccordion.innerHTML = '<div class="col-12 text-center">Đang tải dữ liệu...</div>';

            const tourCategoryNames = {
                amThucVaVanHoa: 'Ẩm thực và Văn hóa',
                hoatDongGanBan: 'Hoạt động gần bạn',
                traiNghiemDiaPhuong: 'Trải nghiệm địa phương'
            };

            db.ref('specialTours').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    toursAccordion.innerHTML = '<div class="col-12 text-center">Không có dữ liệu</div>';
                    return;
                }

                toursAccordion.innerHTML = '';
                const allToursData = snapshot.val();

                Object.keys(tourCategoryNames).forEach((categoryKey, index) => {
                    const categoryName = tourCategoryNames[categoryKey];
                    const toursInCategory = allToursData[categoryKey];

                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';

                    let tourCardsHtml = '<div class="row">';
                    if (toursInCategory && typeof toursInCategory === 'object') {
                        Object.entries(toursInCategory).forEach(([tourId, tourData]) => {
                            tourCardsHtml += `
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100">
                                        <img src="${tourData.image || 'images/default-tour.jpg'}" class="card-img-top" alt="${tourData.name}">
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title">${tourData.name}</h5>
                                            <p class="card-text flex-grow-1">${(tourData.description || '').substring(0, 80)}...</p>
                                            <p class="tour-price mb-2"><b>Giá:</b> ${tourData.price ? tourData.price.toLocaleString('vi-VN') + ' đ' : 'Chưa có'}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-primary">${tourData.duration}</span>
                                                <div>
                                                    <button class="btn btn-action btn-view" onclick="viewTour('${categoryKey}', '${tourId}')"><i class="fas fa-eye"></i></button>
                                                    <button class="btn btn-action btn-edit" onclick="editTour('${categoryKey}', '${tourId}')"><i class="fas fa-edit"></i></button>
                                                    <button class="btn btn-action btn-delete" onclick="deleteTour('${categoryKey}', '${tourId}')"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        tourCardsHtml += '<p class="text-muted col-12">Chưa có tour nào trong danh mục này.</p>';
                    }
                    tourCardsHtml += '</div>'; // Close .row

                    accordionItem.innerHTML = `
                        <h2 class="accordion-header" id="heading-${categoryKey}">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${categoryKey}" aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse-${categoryKey}">
                                ${categoryName}
                            </button>
                        </h2>
                        <div id="collapse-${categoryKey}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading-${categoryKey}" data-bs-parent="#toursAccordion">
                            <div class="accordion-body">
                                ${tourCardsHtml}
                            </div>
                        </div>
                    `;

                    toursAccordion.appendChild(accordionItem);
                });

            }).catch(error => {
                console.error('Error loading tours:', error);
                toursAccordion.innerHTML = '<div class="col-12 text-center text-danger">Lỗi khi tải dữ liệu</div>';
            });
        }

        // === VOUCHERS CRUD ===
        function loadVouchers() {
            const vouchersGrid = document.getElementById('vouchersGrid');
            vouchersGrid.innerHTML = '<div class="col-12 text-center">Đang tải dữ liệu...</div>';

            db.ref('vouchers').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    vouchersGrid.innerHTML = '<div class="col-12 text-center">Không có dữ liệu</div>';
                    return;
                }

                vouchersGrid.innerHTML = '';
                snapshot.forEach((voucherSnapshot) => {
                    const voucher = voucherSnapshot.val();
                    const voucherId = voucherSnapshot.key;
                    const voucherCard = document.createElement('div');
                    voucherCard.className = 'col-md-4 mb-4';
                    voucherCard.innerHTML = `
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${voucher.title || 'Voucher'}</h5>
                                <p class="card-text">${voucher.description || ''}</p>
                                <div>
                                    <span class="badge bg-success">${voucher.code || ''}</span>
                                    <span class="badge bg-info">${voucher.discount ? voucher.discount + '%' : ''}</span>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-action btn-edit" onclick="editVoucher('${voucherId}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-action btn-delete" onclick="deleteVoucher('${voucherId}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    vouchersGrid.appendChild(voucherCard);
                });
            }).catch(error => {
                vouchersGrid.innerHTML = '<div class="col-12 text-center text-danger">Lỗi khi tải dữ liệu</div>';
            });
        }

        function addVoucher() {
            Swal.fire({
                title: 'Thêm voucher mới',
                html: `
                    <form id="addVoucherForm" class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Tiêu đề</label>
                            <input type="text" class="form-control" id="addVoucherTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mã voucher</label>
                            <input type="text" class="form-control" id="addVoucherCode" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Giảm giá (%)</label>
                            <input type="number" class="form-control" id="addVoucherDiscount" min="1" max="100" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" id="addVoucherDesc"></textarea>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Thêm mới',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const form = document.getElementById('addVoucherForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    return {
                        title: document.getElementById('addVoucherTitle').value,
                        code: document.getElementById('addVoucherCode').value,
                        discount: parseInt(document.getElementById('addVoucherDiscount').value, 10),
                        description: document.getElementById('addVoucherDesc').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newVoucher = result.value;
                    db.ref('vouchers').push(newVoucher).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: 'Voucher mới đã được thêm.',
                            timer: 1500
                        });
                        loadVouchers();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi!',
                            text: 'Không thể thêm voucher: ' + error.message
                        });
                    });
                }
            });
        }

        function editVoucher(voucherId) {
            db.ref('vouchers/' + voucherId).once('value').then((snapshot) => {
                const voucher = snapshot.val();
                Swal.fire({
                    title: 'Chỉnh sửa voucher',
                    html: `
                        <form id="editVoucherForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">Tiêu đề</label>
                                <input type="text" class="form-control" id="editVoucherTitle" value="${voucher.title || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mã voucher</label>
                                <input type="text" class="form-control" id="editVoucherCode" value="${voucher.code || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Giảm giá (%)</label>
                                <input type="number" class="form-control" id="editVoucherDiscount" value="${voucher.discount || ''}" min="1" max="100" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="editVoucherDesc">${voucher.description || ''}</textarea>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu thay đổi',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const form = document.getElementById('editVoucherForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            title: document.getElementById('editVoucherTitle').value,
                            code: document.getElementById('editVoucherCode').value,
                            discount: parseInt(document.getElementById('editVoucherDiscount').value, 10),
                            description: document.getElementById('editVoucherDesc').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedVoucher = result.value;
                        db.ref('vouchers/' + voucherId).update(updatedVoucher).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: 'Voucher đã được cập nhật.',
                                timer: 1500
                            });
                            loadVouchers();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: 'Không thể cập nhật voucher: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteVoucher(voucherId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn không thể hoàn tác sau khi xóa!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('vouchers/' + voucherId).remove().then(() => {
                        Swal.fire('Đã xóa!', 'Voucher đã được xóa.', 'success');
                        loadVouchers();
                    });
                }
            });
        }

        // View booking details
        function viewBooking(bookingId) {
            db.ref('bookings/' + bookingId).once('value').then((snapshot) => {
                const booking = snapshot.val();
                Swal.fire({
                    title: 'Chi tiết đặt phòng',
                    html: `
                        <div class="text-start">
                            <p><strong>Khách hàng:</strong> ${booking.name}</p>
                            <p><strong>Email:</strong> ${booking.email}</p>
                            <p><strong>Số điện thoại:</strong> ${booking.phone}</p>
                            <p><strong>Khách sạn:</strong> ${booking.hotelId}</p>
                            <p><strong>Phòng:</strong> ${booking.roomId}</p>
                            <p><strong>Check-in:</strong> ${booking.checkIn}</p>
                            <p><strong>Check-out:</strong> ${booking.checkOut}</p>
                            <p><strong>Số khách:</strong> ${booking.guests}</p>
                        </div>
                    `,
                    width: '600px'
                });
            });
        }

        // Edit booking
        function editBooking(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('Lỗi', 'Không tìm thấy đặt phòng này.', 'error');
                return;
            }
            // Danh sách các trường hợp lệ theo rule
            const allowedFields = [
                'bookingType', 'checkIn', 'checkOut', 'createdAt', 'customerEmail', 'customerName', 'customerPhone', 'email',
                'guests', 'hotelId', 'hotelName', 'nights', 'note', 'paymentMethod', 'paymentStatus', 'roomId', 'roomName',
                'roomPrice', 'status', 'totalPrice', 'updatedAt', 'userId',
                // Các trường cho tour
                'numberOfGuests', 'tourId', 'tourName', 'tourCategory', 'tourLocation', 'tourDuration', 'tourImage', 'tourType',
                'tourPrice', 'tourDescription', 'tourIncludes', 'tourExcludes', 'tourRating', 'tourReviewsCount'
            ];
            // Nếu là booking tour
            if (booking.type === 'tour' || booking.bookingType === 'tour') {
                Swal.fire({
                    title: 'Sửa thông tin đặt tour',
                    html: `
                        <input id="edit-tourName" class="swal2-input" placeholder="Tên tour" value="${booking.tourName || ''}">
                        <input id="edit-tourLocation" class="swal2-input" placeholder="Điểm đến" value="${booking.tourLocation || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="Số khách" value="${booking.numberOfGuests || booking.guests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="Tên khách" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="Số điện thoại" value="${booking.customerPhone || ''}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Chờ xác nhận</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Đã xác nhận</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Đã hủy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Hoàn thành</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        return {
                            tourName: document.getElementById('edit-tourName').value,
                            tourLocation: document.getElementById('edit-tourLocation').value,
                            checkIn: document.getElementById('edit-checkIn').value,
                            numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value),
                            customerName: document.getElementById('edit-customerName').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Lọc dữ liệu cũ chỉ lấy các trường hợp lệ
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // Gộp với dữ liệu mới
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('Dữ liệu gửi lên Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Thành công', 'Đã cập nhật thông tin!', 'success');
                            loadBookingsTours();
                            loadBookings(); // Để đồng bộ nếu có thay đổi
                        }).catch(() => {
                            Swal.fire('Lỗi', 'Không thể cập nhật thông tin.', 'error');
                        });
                    }
                });
            } else {
                // Booking khách sạn giữ như cũ
                Swal.fire({
                    title: 'Sửa thông tin đặt phòng',
                    html: `
                        <input id="edit-customerName" class="swal2-input" placeholder="Tên khách" value="${booking.customerName || ''}">
                        <input id="edit-customerEmail" class="swal2-input" placeholder="Email" value="${booking.customerEmail || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="Số điện thoại" value="${booking.customerPhone || ''}">
                        <input id="edit-hotelName" class="swal2-input" placeholder="Khách sạn" value="${booking.hotelName || ''}">
                        <input id="edit-roomId" class="swal2-input" placeholder="Phòng" value="${booking.roomId || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-checkOut" class="swal2-input" type="date" value="${booking.checkOut ? booking.checkOut.split('T')[0] : ''}">
                        <input id="edit-guests" class="swal2-input" type="number" min="1" placeholder="Số khách" value="${booking.guests || 1}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Chờ xác nhận</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Đã xác nhận</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Đã hủy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Hoàn thành</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const roomIdValue = document.getElementById('edit-roomId').value;
                        return {
                            customerName: document.getElementById('edit-customerName').value,
                            customerEmail: document.getElementById('edit-customerEmail').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            hotelName: document.getElementById('edit-hotelName').value,
                            roomId: roomIdValue,
                            roomName: roomIdValue,
                            checkIn: document.getElementById('edit-checkIn').value,
                            checkOut: document.getElementById('edit-checkOut').value,
                            guests: parseInt(document.getElementById('edit-guests').value),
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Lọc dữ liệu cũ chỉ lấy các trường hợp lệ
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // Gộp với dữ liệu mới
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('Dữ liệu gửi lên Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Thành công', 'Đã cập nhật thông tin!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('Lỗi', 'Không thể cập nhật thông tin.', 'error');
                        });
                    }
                });
            }
        }

        // Delete booking
        function deleteBooking(bookingId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: "Bạn không thể hoàn tác sau khi xóa!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('bookings/' + bookingId).remove().then(() => {
                        Swal.fire('Đã xóa!', 'Đặt phòng đã được xóa.', 'success');
                        generateNotification('fas fa-trash', 'bg-danger', `Đã xóa đặt phòng #${bookingId.substring(0, 6)}...`);
                        loadBookings();
                    });
                }
            });
        }

        // Revenue Chart
        function loadRevenueChart() {
            try {
                // Destroy chart cũ nếu tồn tại
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                    revenueChartInstance = null;
                }

                const canvas = document.getElementById('revenueChart');
                if (!canvas) {
                    console.warn('Canvas revenueChart không tồn tại');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Không thể lấy context từ canvas revenueChart');
                    return;
                }

                db.ref('bookings').once('value').then(snapshot => {
                    const monthlyRevenue = Array(12).fill(0);
                    const monthLabels = [];
                    const now = new Date();

                    for (let i = 11; i >= 0; i--) {
                        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        monthLabels.push(`T${d.getMonth() + 1}/${d.getFullYear().toString().slice(-2)}`);
                    }

                    if (snapshot.exists()) {
                        snapshot.forEach(bookingSnapshot => {
                            const booking = bookingSnapshot.val();
                            // Sửa logic: Tính doanh thu cho cả đơn "confirmed" và "completed"
                            if ((booking.status === 'completed' || booking.status === 'confirmed') && typeof booking.totalPrice === 'number' && booking.createdAt) {
                                const date = new Date(booking.createdAt);
                                const monthDiff = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());
                                if (monthDiff >= 0 && monthDiff < 12) {
                                    monthlyRevenue[11 - monthDiff] += booking.totalPrice;
                                }
                            }
                        });
                    }
                    const revenueInMillions = monthlyRevenue.map(r => (r / 1000000).toFixed(2));

                    // Kiểm tra lại canvas trước khi tạo chart mới
                    if (canvas && !revenueChartInstance) {
                        revenueChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Doanh thu (triệu VNĐ)',
                                    data: revenueInMillions,
                                    borderColor: '#1a237e',
                                    backgroundColor: 'rgba(26, 35, 126, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Doanh thu theo tháng (12 tháng gần nhất)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function (value) {
                                                return value + 'tr';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('Lỗi khi load revenue chart:', error);
                });
            } catch (error) {
                console.error('Lỗi trong loadRevenueChart:', error);
            }
        }

        // Booking Type Chart
        function loadBookingTypeChart() {
            try {
                // Destroy chart cũ nếu tồn tại
                if (bookingTypeChartInstance) {
                    bookingTypeChartInstance.destroy();
                    bookingTypeChartInstance = null;
                }

                const canvas = document.getElementById('bookingTypeChart');
                if (!canvas) {
                    console.warn('Canvas bookingTypeChart không tồn tại');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Không thể lấy context từ canvas bookingTypeChart');
                    return;
                }

                db.ref('bookings').once('value').then(snapshot => {
                    let hotelCount = 0;
                    let tourCount = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(bookingSnapshot => {
                            const booking = bookingSnapshot.val();
                            if (booking.bookingType === 'hotel') {
                                hotelCount++;
                            } else if (booking.bookingType === 'tour') {
                                tourCount++;
                            }
                        });
                    }

                    // Kiểm tra lại canvas trước khi tạo chart mới
                    if (canvas && !bookingTypeChartInstance) {
                        bookingTypeChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Đặt phòng khách sạn', 'Đặt tour'],
                                datasets: [{
                                    data: [hotelCount, tourCount],
                                    backgroundColor: [
                                        '#1a237e',
                                        '#1976d2'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Tỷ lệ loại hình đặt phòng'
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('Lỗi khi load booking type chart:', error);
                });
            } catch (error) {
                console.error('Lỗi trong loadBookingTypeChart:', error);
            }
        }

        // New Users Chart
        function loadNewUsersChart() {
            try {
                // Destroy chart cũ nếu tồn tại
                if (newUsersChartInstance) {
                    newUsersChartInstance.destroy();
                    newUsersChartInstance = null;
                }

                const canvas = document.getElementById('newUsersChart');
                if (!canvas) {
                    console.warn('Canvas newUsersChart không tồn tại');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Không thể lấy context từ canvas newUsersChart');
                    return;
                }

                const weekLabels = ['6 tuần trước', '5 tuần trước', '4 tuần trước', '3 tuần trước', '2 tuần trước', 'Tuần trước', 'Tuần này'];
                const weeklyNewUsers = Array(7).fill(0);
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

                db.ref('users').orderByChild('createdAt').startAt(todayStart - 6 * 7 * 24 * 3600 * 1000).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(userSnapshot => {
                            const user = userSnapshot.val();
                            if (user.createdAt) {
                                const joinDate = new Date(user.createdAt);
                                const weeksAgo = Math.floor((todayStart - joinDate.getTime()) / (7 * 24 * 3600 * 1000));
                                if (weeksAgo >= 0 && weeksAgo < 7) {
                                    weeklyNewUsers[6 - weeksAgo]++;
                                }
                            }
                        });
                    }

                    // Kiểm tra lại canvas trước khi tạo chart mới
                    if (canvas && !newUsersChartInstance) {
                        newUsersChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: weekLabels,
                                datasets: [{
                                    label: 'Người dùng mới',
                                    data: weeklyNewUsers,
                                    backgroundColor: '#2e7d32'
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false,
                                    },
                                    title: {
                                        display: true,
                                        text: 'Người dùng mới (7 tuần gần nhất)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('Lỗi khi load new users chart:', error);
                });
            } catch (error) {
                console.error('Lỗi trong loadNewUsersChart:', error);
            }
        }

        // Location Chart (Number of hotels per location)
        function loadLocationChart() {
            try {
                // Destroy chart cũ nếu tồn tại
                if (locationChartInstance) {
                    locationChartInstance.destroy();
                    locationChartInstance = null;
                }

                const canvas = document.getElementById('locationChart');
                if (!canvas) {
                    console.warn('Canvas locationChart không tồn tại');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Không thể lấy context từ canvas');
                    return;
                }

                db.ref('location').once('value').then(snapshot => {
                    const locationLabels = [];
                    const hotelCounts = [];
                    // Bảng màu mới, có độ tương phản cao để dễ phân biệt
                    const backgroundColors = [
                        '#3366CC', '#DC3912', '#FF9900', '#109618', '#990099',
                        '#0099C6', '#DD4477', '#66AA00', '#B82E2E', '#316395'
                    ];
                    let colorIndex = 0;

                    if (snapshot.exists()) {
                        snapshot.forEach(locationSnapshot => {
                            const locationKey = locationSnapshot.key;
                            const locationName = locationKey.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                            const hotels = locationSnapshot.child('hotels').val();
                            const count = hotels ? Object.keys(hotels).length : 0;
                            if (count > 0) {
                                locationLabels.push(locationName);
                                hotelCounts.push(count);
                            }
                        });
                    }

                    // Kiểm tra lại canvas trước khi tạo chart mới
                    if (canvas && !locationChartInstance) {
                        locationChartInstance = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: locationLabels,
                                datasets: [{
                                    data: hotelCounts,
                                    backgroundColor: locationLabels.map(() => backgroundColors[colorIndex++ % backgroundColors.length])
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Phân bổ khách sạn theo khu vực'
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('Lỗi khi load location chart:', error);
                });
            } catch (error) {
                console.error('Lỗi trong loadLocationChart:', error);
            }
        }

        // Thêm đặt phòng mới
        function addBooking() {
            // Lấy danh sách khách sạn
            db.ref('location').once('value').then(snapshot => {
                let hotelOptions = '';
                let hotelsData = [];
                snapshot.forEach(locationSnap => {
                    const location = locationSnap.val();
                    if (location.hotels) {
                        Object.entries(location.hotels).forEach(([hotelKey, hotel]) => {
                            hotelsData.push({
                                id: hotelKey,
                                name: hotel.tenKhachSan,
                                rooms: hotel.chiTiet && hotel.chiTiet.rooms ? hotel.chiTiet.rooms : [],
                                locationId: locationSnap.key
                            });
                            hotelOptions += `<option value="${locationSnap.key}__${hotelKey}">${hotel.tenKhachSan}</option>`;
                        });
                    }
                });
                Swal.fire({
                    title: 'Thêm đặt phòng mới',
                    html: `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <input id="add-customerName" class="swal2-input" placeholder="Tên khách">
                            <input id="add-customerEmail" class="swal2-input" placeholder="Email">
                            <input id="add-customerPhone" class="swal2-input" placeholder="Số điện thoại">
                            <select id="add-hotelSelect" class="swal2-input" style="width: 100%"><option value="">Chọn khách sạn</option>${hotelOptions}</select>
                            <select id="add-roomSelect" class="swal2-input" style="width: 100%" disabled><option value="">Chọn phòng</option></select>
                            <input id="add-checkIn" class="swal2-input" type="date">
                            <input id="add-checkOut" class="swal2-input" type="date">
                            <input id="add-guests" class="swal2-input" type="number" min="1" placeholder="Số khách" value="1">
                            <select id="add-status" class="swal2-input" style="width: 100%">
                                <option value="pending">Chờ xác nhận</option>
                                <option value="confirmed">Đã xác nhận</option>
                                <option value="cancelled">Đã hủy</option>
                                <option value="completed">Hoàn thành</option>
                            </select>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu',
                    cancelButtonText: 'Hủy',
                    didOpen: () => {
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const roomSelect = document.getElementById('add-roomSelect');
                        hotelSelect.addEventListener('change', function() {
                            const value = this.value;
                            roomSelect.innerHTML = '<option value="">Chọn phòng</option>';
                            roomSelect.disabled = true;
                            if (!value) return;
                            const [locationId, hotelKey] = value.split('__');
                            const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                            if (hotel && Array.isArray(hotel.rooms)) {
                                hotel.rooms.forEach(room => {
                                    if (room && room.name) {
                                        const option = document.createElement('option');
                                        option.value = room.name;
                                        option.textContent = room.name;
                                        roomSelect.appendChild(option);
                                    }
                                });
                                roomSelect.disabled = false;
                            }
                        });
                    },
                    preConfirm: () => {
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const roomSelect = document.getElementById('add-roomSelect');
                        const hotelValue = hotelSelect.value;
                        const [locationId, hotelKey] = hotelValue.split('__');
                        const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                        return {
                            userId: 'admin-created', // Admin tạo booking cho khách
                            customerName: document.getElementById('add-customerName').value,
                            customerEmail: document.getElementById('add-customerEmail').value,
                            customerPhone: document.getElementById('add-customerPhone').value,
                            hotelName: hotel ? hotel.name : '',
                            roomId: roomSelect.value,
                            roomName: roomSelect.value,
                            checkIn: document.getElementById('add-checkIn').value,
                            checkOut: document.getElementById('add-checkOut').value,
                            guests: parseInt(document.getElementById('add-guests').value),
                            status: document.getElementById('add-status').value,
                            type: 'hotel',
                            bookingType: 'hotel',
                            createdAt: new Date().toISOString()
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        db.ref('bookings').push(result.value).then(() => {
                            Swal.fire('Thành công', 'Đã thêm đặt phòng mới!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('Lỗi', 'Không thể thêm đặt phòng.', 'error');
                        });
                    }
                });
            });
        }

        // Load danh sách khách sạn và phòng
        function loadHotelsAndRooms() {
            const hotelSelect = document.getElementById('newHotelId');
            const roomSelect = document.getElementById('newRoomId');
            if (!hotelSelect || !roomSelect) return;

            db.ref('location').once('value').then((snapshot) => {
                hotelSelect.innerHTML = '<option value="">Chọn khách sạn</option>';
                snapshot.forEach((locationSnapshot) => {
                    const location = locationSnapshot.val();
                    location.hotels.forEach((hotel, index) => {
                        const option = document.createElement('option');
                        option.value = `${locationSnapshot.key}_${index}`;
                        option.textContent = hotel.tenKhachSan;
                        hotelSelect.appendChild(option);
                    });
                });
            });

            // Cập nhật danh sách phòng khi chọn khách sạn
            hotelSelect.addEventListener('change', (e) => {
                const [locationId, hotelIndex] = e.target.value.split('_');
                if (!locationId || !hotelIndex) {
                    roomSelect.innerHTML = '<option value="">Chọn phòng</option>';
                    return;
                }

                db.ref(`location/${locationId}/hotels/${hotelIndex}/chiTiet/rooms`).once('value').then((snapshot) => {
                    roomSelect.innerHTML = '<option value="">Chọn phòng</option>';
                    const rooms = snapshot.val();
                    console.log('Rooms data:', rooms); // Thêm dòng này để kiểm tra dữ liệu

                    let found = false;
                    if (Array.isArray(rooms)) {
                        rooms.forEach((room, idx) => {
                            if (room) {
                                found = true;
                                const option = document.createElement('option');
                                option.value = idx;
                                option.textContent = `${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}đ`;
                                roomSelect.appendChild(option);
                            }
                        });
                    } else if (rooms && typeof rooms === 'object') {
                        Object.entries(rooms).forEach(([key, room]) => {
                            if (room) {
                                found = true;
                                const option = document.createElement('option');
                                option.value = key;
                                option.textContent = `${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}đ`;
                                roomSelect.appendChild(option);
                            }
                        });
                    }
                    if (!found) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Không có phòng nào';
                        roomSelect.appendChild(option);
                    }
                });
            });
        }

        // Hàm helper để lấy class cho badge trạng thái
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning';
                case 'confirmed': return 'bg-success';
                case 'cancelled': return 'bg-danger';
                case 'completed': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        // Hàm helper để lấy text trạng thái
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'Chờ xác nhận';
                case 'confirmed': return 'Đã xác nhận';
                case 'cancelled': return 'Đã hủy';
                case 'completed': return 'Hoàn thành';
                default: return 'Không xác định';
            }
        }

        function handleGlobalSearch() {
            const activeSection = document.querySelector('.content-section:not([style*="display: none"])');
            if (!activeSection) return;

            const sectionId = activeSection.id;
            switch (sectionId) {
                case 'bookings':
                    filterAndDisplayBookings();
                    break;
                case 'users':
                    filterAndDisplayUsers();
                    break;
                // Add cases for other sections here in the future
                // case 'hotels':
                //     filterAndDisplayHotels();
                //     break;
            }
        }

        // Destroy all charts
        function destroyAllCharts() {
            try {
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                    revenueChartInstance = null;
                }
                if (bookingTypeChartInstance) {
                    bookingTypeChartInstance.destroy();
                    bookingTypeChartInstance = null;
                }
                if (newUsersChartInstance) {
                    newUsersChartInstance.destroy();
                    newUsersChartInstance = null;
                }
                if (locationChartInstance) {
                    locationChartInstance.destroy();
                    locationChartInstance = null;
                }
            } catch (error) {
                console.error('Lỗi khi destroy charts:', error);
            }
        }

        // Update showContent function to load data when switching sections
        function showContent(contentId) {
            // Destroy all charts before switching sections
            destroyAllCharts();
            
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected content
            document.getElementById(contentId).style.display = 'block';

            // Update active menu item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[href="#${contentId}"]`).classList.add('active');

            // Update page title
            const pageTitle = document.querySelector(`[href="#${contentId}"]`).textContent.trim();
            document.getElementById('page-title-header').textContent = pageTitle;


            // Handle search bar visibility and placeholder
            const searchContainer = document.getElementById('headerSearchContainer');
            const searchInput = document.getElementById('globalSearchInput');
            
            const searchableSections = {
                'bookings': 'Tìm theo ID, Tên, Email, SĐT...',
                'users': 'Tìm theo Tên, Email, SĐT...',
                'hotels': 'Tìm theo tên khách sạn...',
                'tours': 'Tìm theo tên tour...',
                'deals': 'Tìm theo tiêu đề ưu đãi...',
                'travel-guides': 'Tìm theo tiêu đề bài viết...',
                'contributions': 'Tìm theo tiêu đề, tác giả, địa điểm...'
            };

            if (searchableSections[contentId]) {
                searchContainer.style.display = 'flex';
                searchInput.placeholder = searchableSections[contentId];
            } else {
                searchContainer.style.display = 'none';
            }
            searchInput.value = ''; // Clear search on tab switch


            // Load data for the selected section
            switch (contentId) {
                case 'dashboard':
                    loadStatistics();
                    break;
                case 'bookings':
                    loadBookings();
                    break;
                case 'bookings-tours':
                    loadBookingsTours();
                    break;
                case 'hotels':
                    loadHotels();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'tours':
                    loadTours();
                    break;
                case 'vouchers':
                    loadVouchers();
                    break;
                case 'deals':
                    loadDeals();
                    break;
                case 'travel-guides':
                    loadTravelGuides();
                    break;
                case 'contributions':
                    loadContributions();
                    break;
                case 'refunds':
                    loadRefunds();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                // Add more cases for other sections
            }

        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Kiểm tra đăng nhập khi trang được tải
            checkAuth();

            // Thêm sự kiện click cho nút đăng xuất
            const logoutBtn = document.querySelector('.btn-danger.w-100');
            if (logoutBtn && logoutBtn.onclick === null) { // Add listener only if no onclick is present
                logoutBtn.addEventListener('click', logout);
            }

            // Add click event listeners to menu items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const contentId = item.getAttribute('href').substring(1);
                    showContent(contentId);
                });
            });

            // Add event listener for settings form
            const settingsForm = document.getElementById('settingsForm');
            if (settingsForm) {
                settingsForm.addEventListener('submit', saveSettings);
            }
            
            // Add event listener for booking status filter
            const bookingStatusFilter = document.getElementById('bookingStatusFilter');
            if(bookingStatusFilter) {
                bookingStatusFilter.addEventListener('change', filterAndDisplayBookings);
            }

            // Add event listener for mobile toggle
            const mobileToggle = document.getElementById('mobile-toggle');
            if(mobileToggle) {
                mobileToggle.addEventListener('click', toggleSidebar);
            }

            // Show dashboard by default
            showContent('dashboard');

            // Load pending contributions count for sidebar badge
            loadPendingContributionsCount();

             // Initialize global search
            const globalSearchInput = document.getElementById('globalSearchInput');
            if(globalSearchInput) {
                globalSearchInput.addEventListener('input', handleGlobalSearch);
            }

            // Initialize notifications
            const notifBell = document.getElementById('notificationBell');
            const notifDropdown = document.getElementById('notificationDropdown');
            const markAllReadBtn = document.getElementById('markAllAsReadBtn');

            if(notifBell && notifDropdown) {
                notifBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notifDropdown.classList.toggle('show');
                    // Mark as read when opening
                    if (notifDropdown.classList.contains('show')) {
                        markNotificationsAsRead();
                    }
                });

                markAllReadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    markNotificationsAsRead();
                });

                document.addEventListener('click', (e) => {
                    if (!notifDropdown.contains(e.target) && !notifBell.contains(e.target)) {
                        notifDropdown.classList.remove('show');
                    }
                });
            }
            
            loadNotifications();

            // Set tháng/năm mặc định là hiện tại
            const now = new Date();
            document.getElementById('stat-month').value = (now.getMonth() + 1).toString();
            document.getElementById('stat-year').value = now.getFullYear();
            updateMonthlyStatsUI();
        });

        // Xem chi tiết khách sạn
        function viewHotel(locationId, hotelId) {
            db.ref(`location/${locationId}/hotels/${hotelId}`).once('value').then((snapshot) => {
                const hotel = snapshot.val();
                if (!hotel) return;

                const chiTiet = hotel.chiTiet || {};
                const rooms = chiTiet.rooms || {};
                let roomList = '<li>Không có phòng nào</li>';
                if(Object.keys(rooms).length > 0){
                    roomList = Object.values(rooms).map(room => `<li>${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}đ</li>`).join('');
                }

                Swal.fire({
                    title: hotel.tenKhachSan,
                    html: `
                        <img src="${chiTiet.image || 'images/default-hotel.jpg'}" alt="Hình ảnh khách sạn" class="img-fluid mb-3" style="max-height:200px;">
                        <p><strong>Mô tả:</strong> ${hotel.moTa || ''}</p>
                        <p><strong>Xếp hạng sao:</strong> ${hotel.xepHangSao || ''}</p>
                        <p><strong>Địa chỉ:</strong> ${hotel.diaChi || ''}</p>
                        <p><strong>Điện thoại:</strong> ${hotel.phone || ''}</p>
                        <p><strong>Phí dịch vụ:</strong> ${hotel.serviceFee ? hotel.serviceFee.toLocaleString('vi-VN') + ' đ' : ''}</p>
                        <p><strong>Tiện nghi:</strong> ${(chiTiet.facilities || []).join(', ')}</p>
                        <p><strong>Danh sách phòng:</strong></p>
                        <ul>${roomList}</ul>
                    `,
                    width: '700px'
                });
            });
        }

        function editHotel(locationId, hotelId) {
            db.ref(`location/${locationId}/hotels/${hotelId}`).once('value').then((snapshot) => {
                const hotel = snapshot.val();
                 if (!hotel) {
                     Swal.fire('Lỗi', 'Không tìm thấy khách sạn!', 'error');
                     return;
                 }
                const chiTiet = hotel.chiTiet || {};
                Swal.fire({
                    title: 'Chỉnh sửa khách sạn',
                    html: `
                        <form id="editHotelForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">Tên khách sạn</label>
                                <input type="text" class="form-control" id="editHotelName" value="${hotel.tenKhachSan || ''}" required>
                            </div>
                             <div class="mb-3">
                                <label class="form-label">Địa chỉ</label>
                                <input type="text" class="form-control" id="editHotelAddress" value="${hotel.diaChi || ''}" required>
                            </div>
                             <div class="mb-3">
                                <label class="form-label">Điện thoại</label>
                                <input type="tel" class="form-control" id="editHotelPhone" value="${hotel.phone || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="editHotelDesc">${hotel.moTa || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hình ảnh (URL)</label>
                                <input type="text" class="form-control" id="editHotelImage" value="${chiTiet.image || ''}">
                            </div>
                             <div class="mb-3">
                                <label class="form-label">Phí dịch vụ</label>
                                <input type="number" class="form-control" id="editHotelServiceFee" value="${hotel.serviceFee || 0}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Xếp hạng sao</label>
                                <input type="number" class="form-control" id="editHotelStar" value="${hotel.xepHangSao || ''}" min="1" max="5">
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu thay đổi',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const form = document.getElementById('editHotelForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            tenKhachSan: document.getElementById('editHotelName').value,
                            diaChi: document.getElementById('editHotelAddress').value,
                            phone: document.getElementById('editHotelPhone').value,
                            moTa: document.getElementById('editHotelDesc').value,
                            serviceFee: parseInt(document.getElementById('editHotelServiceFee').value, 10),
                            xepHangSao: parseInt(document.getElementById('editHotelStar').value, 10),
                            'chiTiet/image': document.getElementById('editHotelImage').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedHotel = result.value;
                        db.ref(`location/${locationId}/hotels/${hotelId}`).update(updatedHotel).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: 'Khách sạn đã được cập nhật.',
                                timer: 1500
                            });
                             generateNotification('fas fa-hotel', 'bg-info', `Đã cập nhật khách sạn ${updatedHotel.tenKhachSan}.`);
                            loadHotels();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: 'Không thể cập nhật khách sạn: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteHotel(locationId, hotelId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn không thể hoàn tác sau khi xóa!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`location/${locationId}/hotels/${hotelId}`).remove().then(() => {
                        Swal.fire('Đã xóa!', 'Khách sạn đã được xóa.', 'success');
                        generateNotification('fas fa-trash', 'bg-danger', `Đã xóa một khách sạn.`);
                        loadHotels();
                    }).catch(error => {
                        Swal.fire('Lỗi!', 'Không thể xóa khách sạn: ' + error.message, 'error');
                    });
                }
            });
        }

        // Thêm khách sạn mới
        function addHotel() {
            db.ref('location').once('value').then((snapshot) => {
                const locations = [];
                snapshot.forEach((locationSnapshot) => {
                    locations.push(locationSnapshot.key);
                });
                Swal.fire({
                    title: 'Thêm khách sạn mới',
                    html: `
                        <form id="addHotelForm" class="text-start">
                             <div class="mb-3">
                                <label class="form-label">Tỉnh/Thành phố</label>
                                <select class="form-control" id="addHotelLocation" required>
                                    <option value="">Chọn tỉnh/thành phố</option>
                                    ${locations.map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tên khách sạn</label>
                                <input type="text" class="form-control" id="addHotelName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Địa chỉ</label>
                                <input type="text" class="form-control" id="addHotelAddress" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Điện thoại</label>
                                <input type="tel" class="form-control" id="addHotelPhone" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="addHotelDesc" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hình ảnh (URL)</label>
                                <input type="text" class="form-control" id="addHotelImage" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phí dịch vụ (VNĐ)</label>
                                <input type="number" class="form-control" id="addHotelServiceFee" value="0" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Xếp hạng sao</label>
                                <input type="number" class="form-control" id="addHotelStar" value="3" min="1" max="5" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tiện nghi (cách nhau bởi dấu phẩy)</label>
                                <input type="text" class="form-control" id="addHotelFacilities" required>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Thêm mới',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const form = document.getElementById('addHotelForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        const location = document.getElementById('addHotelLocation').value;
                        if (!location) {
                           Swal.showValidationMessage('Vui lòng chọn Tỉnh/Thành phố');
                           return false;
                        }
                        return {
                            location: location,
                            tenKhachSan: document.getElementById('addHotelName').value,
                            diaChi: document.getElementById('addHotelAddress').value,
                            phone: document.getElementById('addHotelPhone').value,
                            moTa: document.getElementById('addHotelDesc').value,
                            location: location,
                            tenKhachSan: document.getElementById('addHotelName').value,
                            diaChi: document.getElementById('addHotelAddress').value,
                            phone: document.getElementById('addHotelPhone').value,
                            moTa: document.getElementById('addHotelDesc').value,
                            serviceFee: parseInt(document.getElementById('addHotelServiceFee').value, 10),
                            xepHangSao: parseInt(document.getElementById('addHotelStar').value, 10),
                            chiTiet: {
                                image: document.getElementById('addHotelImage').value,
                                facilities: document.getElementById('addHotelFacilities').value.split(',').map(f => f.trim()),
                                rooms: {} // Khởi tạo với danh sách phòng rỗng
                            }
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const data = result.value;
                        const location = data.location;
                        // Xóa location khỏi object trước khi push
                        delete data.location;

                        db.ref(`location/${location}/hotels`).push(data).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: 'Khách sạn mới đã được thêm.',
                                timer: 1500
                            });
                            generateNotification('fas fa-plus', 'bg-success', `Đã thêm khách sạn mới: ${data.tenKhachSan}`);
                            loadHotels();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: 'Không thể thêm khách sạn: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function viewUser(userId) {
            db.ref('users/' + userId).once('value').then((snapshot) => {
                const user = snapshot.val();
                const memberLevel = user.memberLevel || 'Đồng';
                const loyaltyPoints = user.loyaltyPoints || 0;
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                const updatedAt = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString('vi-VN') : 'N/A';
                
                Swal.fire({
                    title: user.name || 'Thông tin người dùng',
                    html: `
                        <div class="text-start">
                            <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                            <p><strong>Số điện thoại:</strong> ${user.phone || 'N/A'}</p>
                            <p><strong>Địa chỉ:</strong> ${user.address || 'N/A'}</p>
                            <p><strong>Cấp độ thành viên:</strong> <span class="badge bg-primary">${memberLevel}</span></p>
                            <p><strong>Điểm tích lũy:</strong> <span class="badge bg-success">${loyaltyPoints} điểm</span></p>
                            <p><strong>Ngày tham gia:</strong> ${createdAt}</p>
                            <p><strong>Cập nhật lần cuối:</strong> ${updatedAt}</p>
                        </div>
                    `,
                    width: '600px'
                });
            });
        }

        function editUser(userId) {
            db.ref('users/' + userId).once('value').then((snapshot) => {
                const user = snapshot.val();
                Swal.fire({
                    title: 'Chỉnh sửa người dùng',
                    html: `
                        <form id="editUserForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">Tên</label>
                                <input type="text" class="form-control" id="editUserName" value="${user.name || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="editUserEmail" value="${user.email || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="editUserPhone" value="${user.phone || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Địa chỉ</label>
                                <input type="text" class="form-control" id="editUserAddress" value="${user.address || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cấp độ thành viên</label>
                                <select class="form-control" id="editUserMemberLevel">
                                    <option value="Đồng" ${user.memberLevel === 'Đồng' ? 'selected' : ''}>Đồng</option>
                                    <option value="Bạc" ${user.memberLevel === 'Bạc' ? 'selected' : ''}>Bạc</option>
                                    <option value="Vàng" ${user.memberLevel === 'Vàng' ? 'selected' : ''}>Vàng</option>
                                    <option value="Kim cương" ${user.memberLevel === 'Kim cương' ? 'selected' : ''}>Kim cương</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Điểm tích lũy</label>
                                <input type="number" class="form-control" id="editUserLoyaltyPoints" value="${user.loyaltyPoints || 0}" min="0">
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu thay đổi',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const form = document.getElementById('editUserForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            name: document.getElementById('editUserName').value,
                            email: document.getElementById('editUserEmail').value,
                            phone: document.getElementById('editUserPhone').value,
                            address: document.getElementById('editUserAddress').value,
                            memberLevel: document.getElementById('editUserMemberLevel').value,
                            loyaltyPoints: parseInt(document.getElementById('editUserLoyaltyPoints').value, 10),
                            updatedAt: Date.now()
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedUser = result.value;
                        db.ref('users/' + userId).update(updatedUser).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: 'Người dùng đã được cập nhật.',
                                timer: 1500
                            });
                             generateNotification('fas fa-user-edit', 'bg-info', `Đã cập nhật người dùng ${updatedUser.name}.`);
                            loadUsers();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: 'Không thể cập nhật người dùng: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        // Hàm xem chi tiết người dùng
        function viewUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                Swal.fire('Lỗi', 'Không tìm thấy người dùng này.', 'error');
                return;
            }
            
            const avatar = user.avatar ? `<img src="${user.avatar}" alt="avatar" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">` : '<div style="width:80px;height:80px;border-radius:50%;background-color:#e9ecef;display:flex;align-items:center;justify-content:center;"><i class="fas fa-user fa-2x text-muted"></i></div>';
            const memberLevel = user.memberLevel || 'Đồng';
            const loyaltyPoints = user.loyaltyPoints || 0;
            const status = user.status || 'active';
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('vi-VN') : 'Chưa đăng nhập';
            
            Swal.fire({
                title: `<i class="fas fa-user-circle"></i> Thông tin chi tiết người dùng`,
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-12 text-center mb-3">
                                ${avatar}
                                <h5 class="mt-2 mb-1">${user.name || 'N/A'}</h5>
                                <div class="mb-2">
                                    <span class="badge bg-warning text-dark"><i class="fas fa-crown"></i> ${memberLevel}</span>
                                    <span class="badge bg-info ms-1">${loyaltyPoints} điểm thưởng</span>
                                    <span class="badge ${status === 'active' ? 'bg-success' : status === 'inactive' ? 'bg-warning' : 'bg-danger'} ms-1">
                                        ${status === 'active' ? 'Hoạt động' : status === 'inactive' ? 'Tạm khóa' : 'Bị cấm'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3"><i class="fas fa-user"></i> Thông tin cá nhân</h6>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>Số điện thoại:</strong> ${user.phone || 'N/A'}</p>
                                <p><strong>Giới tính:</strong> ${user.gender || 'N/A'}</p>
                                <p><strong>Ngày sinh:</strong> ${user.birthday ? new Date(user.birthday).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                <p><strong>Quốc tịch:</strong> ${user.nationality || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3"><i class="fas fa-map-marker-alt"></i> Thông tin khác</h6>
                                <p><strong>Địa chỉ:</strong> ${user.address || 'N/A'}</p>
                                <p><strong>Số CCCD:</strong> ${user.identityNumber || 'N/A'}</p>
                                <p><strong>Ngày tham gia:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                <p><strong>Lần đăng nhập cuối:</strong> ${lastLogin}</p>
                                <p><strong>Tổng số booking:</strong> ${user.totalBookings || 0}</p>
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCloseButton: true,
                focusConfirm: false,
                confirmButtonText: 'Đóng'
            });
        }

        // Hàm chỉnh sửa người dùng
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                Swal.fire('Lỗi', 'Không tìm thấy người dùng này.', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Chỉnh sửa thông tin người dùng',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="editUserName" class="form-control mb-2" placeholder="Họ và tên" value="${user.name || ''}">
                                <input type="email" id="editUserEmail" class="form-control mb-2" placeholder="Email" value="${user.email || ''}">
                                <input type="text" id="editUserPhone" class="form-control mb-2" placeholder="Số điện thoại" value="${user.phone || ''}">
                                <input type="date" id="editUserBirthday" class="form-control mb-2" value="${user.birthday || ''}">
                                <select id="editUserGender" class="form-select mb-2">
                                    <option value="">Chọn giới tính</option>
                                    <option value="Nam" ${user.gender === 'Nam' ? 'selected' : ''}>Nam</option>
                                    <option value="Nữ" ${user.gender === 'Nữ' ? 'selected' : ''}>Nữ</option>
                                    <option value="Khác" ${user.gender === 'Khác' ? 'selected' : ''}>Khác</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <textarea id="editUserAddress" class="form-control mb-2" rows="2" placeholder="Địa chỉ">${user.address || ''}</textarea>
                                <input type="text" id="editUserNationality" class="form-control mb-2" placeholder="Quốc tịch" value="${user.nationality || 'Việt Nam'}">
                                <input type="text" id="editUserIdentityNumber" class="form-control mb-2" placeholder="Số CCCD" value="${user.identityNumber || ''}">
                                <select id="editUserMemberLevel" class="form-select mb-2">
                                    <option value="Đồng" ${user.memberLevel === 'Đồng' ? 'selected' : ''}>Đồng</option>
                                    <option value="Bạc" ${user.memberLevel === 'Bạc' ? 'selected' : ''}>Bạc</option>
                                    <option value="Vàng" ${user.memberLevel === 'Vàng' ? 'selected' : ''}>Vàng</option>
                                    <option value="Kim cương" ${user.memberLevel === 'Kim cương' ? 'selected' : ''}>Kim cương</option>
                                </select>
                                <input type="number" id="editUserLoyaltyPoints" class="form-control mb-2" placeholder="Điểm thưởng" value="${user.loyaltyPoints || 0}" min="0">
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Lưu thay đổi',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const name = document.getElementById('editUserName').value.trim();
                    const email = document.getElementById('editUserEmail').value.trim();
                    const phone = document.getElementById('editUserPhone').value.trim();
                    
                    if (!name || !email || !phone) {
                        Swal.showValidationMessage('Vui lòng nhập đầy đủ họ tên, email và số điện thoại');
                        return false;
                    }
                    
                    return {
                        name: name,
                        email: email,
                        phone: phone,
                        birthday: document.getElementById('editUserBirthday').value,
                        gender: document.getElementById('editUserGender').value,
                        address: document.getElementById('editUserAddress').value.trim(),
                        nationality: document.getElementById('editUserNationality').value.trim(),
                        identityNumber: document.getElementById('editUserIdentityNumber').value.trim(),
                        memberLevel: document.getElementById('editUserMemberLevel').value,
                        loyaltyPoints: parseInt(document.getElementById('editUserLoyaltyPoints').value) || 0
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedUser = result.value;
                    db.ref('users/' + userId).update(updatedUser).then(() => {
                        Swal.fire('Thành công', 'Đã cập nhật thông tin người dùng!', 'success');
                        loadUsers();
                    }).catch((error) => {
                        Swal.fire('Lỗi', 'Không thể cập nhật người dùng: ' + error.message, 'error');
                    });
                }
            });
        }

        // Hàm thêm người dùng mới
        function addUser() {
            Swal.fire({
                title: 'Thêm người dùng mới',
                html: `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="newUserName" class="form-control mb-2" placeholder="Họ và tên *" required>
                                <input type="email" id="newUserEmail" class="form-control mb-2" placeholder="Email *" required>
                                <input type="text" id="newUserPhone" class="form-control mb-2" placeholder="Số điện thoại *" required>
                                <input type="date" id="newUserBirthday" class="form-control mb-2">
                                <select id="newUserGender" class="form-select mb-2">
                                    <option value="">Chọn giới tính</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                    <option value="Khác">Khác</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <textarea id="newUserAddress" class="form-control mb-2" rows="2" placeholder="Địa chỉ"></textarea>
                                <input type="text" id="newUserNationality" class="form-control mb-2" placeholder="Quốc tịch" value="Việt Nam">
                                <input type="text" id="newUserIdentityNumber" class="form-control mb-2" placeholder="Số CCCD">
                                <select id="newUserMemberLevel" class="form-select mb-2">
                                    <option value="Đồng" selected>Đồng</option>
                                    <option value="Bạc">Bạc</option>
                                    <option value="Vàng">Vàng</option>
                                    <option value="Kim cương">Kim cương</option>
                                </select>
                                <input type="number" id="newUserLoyaltyPoints" class="form-control mb-2" placeholder="Điểm thưởng" value="0" min="0">
                            </div>
                        </div>
                    </div>
                `,
                width: '80%',
                showCancelButton: true,
                confirmButtonText: 'Thêm người dùng',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const name = document.getElementById('newUserName').value.trim();
                    const email = document.getElementById('newUserEmail').value.trim();
                    const phone = document.getElementById('newUserPhone').value.trim();
                    
                    if (!name || !email || !phone) {
                        Swal.showValidationMessage('Vui lòng nhập đầy đủ họ tên, email và số điện thoại');
                        return false;
                    }
                    
                    // Validate email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        Swal.showValidationMessage('Email không hợp lệ');
                        return false;
                    }
                    
                    return {
                        name: name,
                        email: email,
                        phone: phone,
                        birthday: document.getElementById('newUserBirthday').value,
                        gender: document.getElementById('newUserGender').value,
                        address: document.getElementById('newUserAddress').value.trim(),
                        nationality: document.getElementById('newUserNationality').value.trim(),
                        identityNumber: document.getElementById('newUserIdentityNumber').value.trim(),
                        memberLevel: document.getElementById('newUserMemberLevel').value,
                        loyaltyPoints: parseInt(document.getElementById('newUserLoyaltyPoints').value) || 0,
                        status: 'active',
                        createdAt: Date.now()
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newUser = result.value;
                    db.ref('users').push(newUser).then(() => {
                        Swal.fire('Thành công', 'Đã thêm người dùng mới!', 'success');
                        loadUsers();
                    }).catch((error) => {
                        Swal.fire('Lỗi', 'Không thể thêm người dùng: ' + error.message, 'error');
                    });
                }
            });
        }

        // Hàm chuyển đổi trạng thái người dùng
        function toggleUserStatus(userId, currentStatus) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                Swal.fire('Lỗi', 'Không tìm thấy người dùng này.', 'error');
                return;
            }
            
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'kích hoạt' : 'khóa';
            
            Swal.fire({
                title: `Xác nhận ${action} tài khoản?`,
                text: `Bạn có chắc chắn muốn ${action} tài khoản của ${user.name}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: newStatus === 'active' ? '#28a745' : '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: `${action.charAt(0).toUpperCase() + action.slice(1)}`,
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('users/' + userId).update({ status: newStatus }).then(() => {
                        Swal.fire('Thành công', `Đã ${action} tài khoản thành công!`, 'success');
                        loadUsers();
                    }).catch((error) => {
                        Swal.fire('Lỗi', `Không thể ${action} tài khoản: ` + error.message, 'error');
                    });
                }
            });
        }

        function deleteUser(userId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn không thể hoàn tác sau khi xóa!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('users/' + userId).remove().then(() => {
                        Swal.fire('Đã xóa!', 'Người dùng đã được xóa.', 'success');
                        generateNotification('fas fa-user-slash', 'bg-danger', `Đã xóa một người dùng.`);
                        loadUsers();
                    });
                }
            });
        }

        function viewTour(tourType, tourId) {
            db.ref(`specialTours/${tourType}/${tourId}`).once('value').then((snapshot) => {
                const tour = snapshot.val();
                 if(!tour) {
                    Swal.fire('Lỗi', 'Không tìm thấy tour!', 'error');
                    return;
                }
                Swal.fire({
                    title: tour.name || 'Thông tin tour',
                    html: `
                        <img src="${tour.image || 'images/default-tour.jpg'}" alt="Hình ảnh tour" class="img-fluid mb-3" style="max-height:200px;">
                        <p><strong>Mô tả:</strong> ${tour.description || ''}</p>
                        <p><strong>Thời lượng:</strong> ${tour.duration || ''}</p>
                        <p><strong>Giá:</strong> ${tour.price ? tour.price.toLocaleString('vi-VN') + ' đ' : 'Chưa có'}</p>
                    `,
                    width: '600px'
                });
            });
        }

        function editTour(tourType, tourId) {
            db.ref(`specialTours/${tourType}/${tourId}`).once('value').then((snapshot) => {
                const tour = snapshot.val();
                if(!tour) {
                    Swal.fire('Lỗi', 'Không tìm thấy tour!', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Chỉnh sửa tour',
                    html: `
                        <form id="editTourForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">Tên tour</label>
                                <input type="text" class="form-control" id="editTourName" value="${tour.name || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="editTourDesc">${tour.description || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hình ảnh (URL)</label>
                                <input type="text" class="form-control" id="editTourImage" value="${tour.image || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Thời lượng</label>
                                <input type="text" class="form-control" id="editTourDuration" value="${tour.duration || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Giá tiền (VNĐ)</label>
                                <input type="number" class="form-control" id="editTourPrice" value="${tour.price || ''}" min="0" required>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu thay đổi',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const form = document.getElementById('editTourForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            name: document.getElementById('editTourName').value,
                            description: document.getElementById('editTourDesc').value,
                            image: document.getElementById('editTourImage').value,
                            duration: document.getElementById('editTourDuration').value,
                            price: parseInt(document.getElementById('editTourPrice').value, 10)
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedTour = result.value;
                        db.ref(`specialTours/${tourType}/${tourId}`).update(updatedTour).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: 'Tour đã được cập nhật.',
                                timer: 1500
                            });
                            loadTours();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: 'Không thể cập nhật tour: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteTour(tourType, tourId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn không thể hoàn tác sau khi xóa!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`specialTours/${tourType}/${tourId}`).remove().then(() => {
                        Swal.fire('Đã xóa!', 'Tour đã được xóa.', 'success');
                        loadTours();
                    }).catch(error => {
                        Swal.fire('Lỗi', 'Không thể xóa tour: ' + error.message, 'error');
                    });
                }
            });
        }

        function addTour() {
            const tourTypes = ['amThucVaVanHoa', 'hoatDongGanBan', 'traiNghiemDiaPhuong'];
            Swal.fire({
                title: 'Thêm tour mới',
                html: `
                    <form id="addTourForm" class="text-start">
                         <div class="mb-3">
                            <label class="form-label">Loại tour</label>
                            <select class="form-control" id="addTourType" required>
                                <option value="">Chọn loại tour</option>
                                ${tourTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tên tour</label>
                            <input type="text" class="form-control" id="addTourName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" id="addTourDesc" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Hình ảnh (URL)</label>
                            <input type="text" class="form-control" id="addTourImage" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Thời lượng</label>
                            <input type="text" class="form-control" id="addTourDuration" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Giá tiền (VNĐ)</label>
                            <input type="number" class="form-control" id="addTourPrice" min="0" required>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Thêm mới',
                cancelButtonText: 'Hủy',
                preConfirm: () => {
                    const form = document.getElementById('addTourForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                     const tourType = document.getElementById('addTourType').value;
                     if (!tourType) {
                        Swal.showValidationMessage('Vui lòng chọn loại tour');
                        return false;
                     }
                    return {
                        tourType: tourType,
                        name: document.getElementById('addTourName').value,
                        description: document.getElementById('addTourDesc').value,
                        image: document.getElementById('addTourImage').value,
                        duration: document.getElementById('addTourDuration').value,
                        price: parseInt(document.getElementById('addTourPrice').value, 10)
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newTourData = result.value;
                    const tourType = newTourData.tourType;
                    delete newTourData.tourType; // Xóa key tạm thời

                    db.ref(`specialTours/${tourType}`).push(newTourData).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: 'Tour mới đã được thêm.',
                            timer: 1500
                        });
                        loadTours();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi!',
                            text: 'Không thể thêm tour: ' + error.message
                        });
                    });
                }
            });
        }

        window.viewHotel = viewHotel;
        window.editHotel = editHotel;
        window.deleteHotel = deleteHotel;
        window.addHotel = addHotel;
        window.viewUser = viewUser;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.viewTour = viewTour;
        window.editTour = editTour;
        window.deleteTour = deleteTour;
        window.addTour = addTour;
        window.editVoucher = editVoucher; window.deleteVoucher = deleteVoucher;
        window.addVoucher = addVoucher;
        window.addDeal = addDeal;
        window.editDeal = editDeal;
        window.deleteDeal = deleteDeal;
        window.addTravelGuide = addTravelGuide;
        window.editTravelGuide = editTravelGuide;
        window.deleteTravelGuide = deleteTravelGuide;

        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function (event) {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.mobile-toggle');

            if (window.innerWidth <= 768 &&
                !sidebar.contains(event.target) &&
                !toggleBtn.contains(event.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        window.toggleSidebar = toggleSidebar;

        // Load deals data
        function loadDeals() {
            const dealsTableBody = document.getElementById('dealsTableBody');
            dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Đang tải dữ liệu...</td></tr>';

            db.ref('specialOffers').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Không có dữ liệu</td></tr>';
                    return;
                }

                dealsTableBody.innerHTML = '';
                snapshot.forEach((dealSnapshot) => {
                    const deal = dealSnapshot.val();
                    const dealId = dealSnapshot.key;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${deal.title || 'N/A'}</td>
                        <td><span class="badge bg-success">${deal.newPrice || 'N/A'}</span></td>
                        <td><span style="text-decoration: line-through;">${deal.oldPrice || 'N/A'}</span></td>
                        <td>${deal.stayEndDate ? new Date(deal.stayEndDate).toLocaleDateString('vi-VN') : 'Không có'}</td>
                        <td>
                            <button class="btn btn-action btn-edit" onclick="editDeal('${dealId}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-action btn-delete" onclick="deleteDeal('${dealId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    dealsTableBody.appendChild(row);
                });
            }).catch(error => {
                dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Lỗi khi tải dữ liệu</div></tr>';
            });
        }

        function addDeal() {
            Swal.fire({
                title: 'Thêm ưu đãi mới',
                html: `
                    <form id="addDealForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                        <div class="mb-3"><label class="form-label">Tiêu đề</label><input type="text" class="form-control" id="dealTitle" required></div>
                        <div class="mb-3"><label class="form-label">Mô tả</label><textarea class="form-control" id="dealDesc" required></textarea></div>
                        <div class="mb-3"><label class="form-label">Nhãn</label><input type="text" class="form-control" id="dealLabel" placeholder="VD: Flash Sale, Hot..."></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Giá mới</label><input type="text" class="form-control" id="dealNewPrice" placeholder="VD: 3.200.000đ" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Giá cũ</label><input type="text" class="form-control" id="dealOldPrice" placeholder="VD: 5.000.000đ" required></div>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Ngày bắt đầu</label><input type="date" class="form-control" id="dealStayStart" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Ngày kết thúc</label><input type="date" class="form-control" id="dealStayEnd" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Hình ảnh (URL)</label><input type="url" class="form-control" id="dealImage" required></div>
                        <div class="row">
                           <div class="col-md-6 mb-3"><label class="form-label">Số đêm</label><input type="number" class="form-control" id="dealNights" min="1" required></div>
                           <div class="col-md-6 mb-3"><label class="form-label">Số khách</label><input type="number" class="form-control" id="dealGuests" min="1" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Tình trạng</label><input type="text" class="form-control" id="dealAvailability" placeholder="VD: Chỉ còn 50 phòng"></div>
                        <div class="mb-3"><label class="form-label">Đặc điểm (mỗi đặc điểm một dòng)</label><textarea class="form-control" id="dealFeatures" rows="3"></textarea></div>
                        <div class="mb-3"><label class="form-label">Ghi chú</label><textarea class="form-control" id="dealNote"></textarea></div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Thêm mới',
                cancelButtonText: 'Hủy',
                width: '800px',
                preConfirm: () => {
                    const form = document.getElementById('addDealForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    return {
                        title: document.getElementById('dealTitle').value,
                        desc: document.getElementById('dealDesc').value,
                        label: document.getElementById('dealLabel').value,
                        newPrice: document.getElementById('dealNewPrice').value,
                        oldPrice: document.getElementById('dealOldPrice').value,
                        stayStartDate: document.getElementById('dealStayStart').value,
                        stayEndDate: document.getElementById('dealStayEnd').value,
                        image: document.getElementById('dealImage').value,
                        nights: parseInt(document.getElementById('dealNights').value),
                        guests: parseInt(document.getElementById('dealGuests').value),
                        availability: document.getElementById('dealAvailability').value,
                        features: document.getElementById('dealFeatures').value.split('\\n').map(f => f.trim()).filter(f => f),
                        note: document.getElementById('dealNote').value,
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newDealRef = db.ref('specialOffers').push();
                    const newDeal = {
                        ...result.value,
                        id: newDealRef.key
                    };
                    
                    newDealRef.set(newDeal).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: 'Ưu đãi mới đã được thêm.',
                            timer: 1500
                        });
                        loadDeals();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi!',
                            text: 'Không thể thêm ưu đãi: ' + error.message
                        });
                    });
                }
            });
        }

        function editDeal(dealId) {
            db.ref('specialOffers/' + dealId).once('value').then((snapshot) => {
                const deal = snapshot.val();
                if (!deal) {
                    Swal.fire('Lỗi', 'Không tìm thấy ưu đãi này!', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Chỉnh sửa ưu đãi',
                    html: `
                       <form id="editDealForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                            <div class="mb-3"><label class="form-label">Tiêu đề</label><input type="text" class="form-control" id="dealTitle" value="${deal.title || ''}" required></div>
                            <div class="mb-3"><label class="form-label">Mô tả</label><textarea class="form-control" id="dealDesc" required>${deal.desc || ''}</textarea></div>
                            <div class="mb-3"><label class="form-label">Nhãn</label><input type="text" class="form-control" id="dealLabel" value="${deal.label || ''}" placeholder="VD: Flash Sale, Hot..."></div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Giá mới</label><input type="text" class="form-control" id="dealNewPrice" value="${deal.newPrice || ''}" placeholder="VD: 3.200.000đ" required></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Giá cũ</label><input type="text" class="form-control" id="dealOldPrice" value="${deal.oldPrice || ''}" placeholder="VD: 5.000.000đ" required></div>
                            </div>
                             <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Ngày bắt đầu</label><input type="date" class="form-control" id="dealStayStart" value="${deal.stayStartDate || ''}" required></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Ngày kết thúc</label><input type="date" class="form-control" id="dealStayEnd" value="${deal.stayEndDate || ''}" required></div>
                            </div>
                            <div class="mb-3"><label class="form-label">Hình ảnh (URL)</label><input type="url" class="form-control" id="dealImage" value="${deal.image || ''}" required></div>
                            <div class="row">
                               <div class="col-md-6 mb-3"><label class="form-label">Số đêm</label><input type="number" class="form-control" id="dealNights" value="${deal.nights || 1}" min="1" required></div>
                               <div class="col-md-6 mb-3"><label class="form-label">Số khách</label><input type="number" class="form-control" id="dealGuests" value="${deal.guests || 1}" min="1" required></div>
                            </div>
                            <div class="mb-3"><label class="form-label">Tình trạng</label><input type="text" class="form-control" id="dealAvailability" value="${deal.availability || ''}" placeholder="VD: Chỉ còn 50 phòng"></div>
                            <div class="mb-3"><label class="form-label">Đặc điểm (mỗi đặc điểm một dòng)</label><textarea class="form-control" id="dealFeatures" rows="3">${(deal.features || []).join('\\n')}</textarea></div>
                            <div class="mb-3"><label class="form-label">Ghi chú</label><textarea class="form-control" id="dealNote">${deal.note || ''}</textarea></div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu thay đổi',
                    cancelButtonText: 'Hủy',
                    width: '800px',
                    preConfirm: () => {
                        const form = document.getElementById('editDealForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            title: document.getElementById('dealTitle').value,
                            desc: document.getElementById('dealDesc').value,
                            label: document.getElementById('dealLabel').value,
                            newPrice: document.getElementById('dealNewPrice').value,
                            oldPrice: document.getElementById('dealOldPrice').value,
                            stayStartDate: document.getElementById('dealStayStart').value,
                            stayEndDate: document.getElementById('dealStayEnd').value,
                            image: document.getElementById('dealImage').value,
                            nights: parseInt(document.getElementById('dealNights').value),
                            guests: parseInt(document.getElementById('dealGuests').value),
                            availability: document.getElementById('dealAvailability').value,
                            features: document.getElementById('dealFeatures').value.split('\\n').map(f => f.trim()).filter(f => f),
                            note: document.getElementById('dealNote').value,
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedDeal = {
                            ...result.value,
                            id: dealId // Make sure ID is preserved
                        };
                        db.ref('specialOffers/' + dealId).update(updatedDeal).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: 'Ưu đãi đã được cập nhật.',
                                timer: 1500
                            });
                            loadDeals();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: 'Không thể cập nhật ưu đãi: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteDeal(dealId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn không thể hoàn tác sau khi xóa!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('specialOffers/' + dealId).remove().then(() => {
                        Swal.fire('Đã xóa!', 'Ưu đãi đã được xóa.', 'success');
                        loadDeals();
                    });
                }
            });
        }

        // Travel Guide CRUD
        function loadTravelGuides() {
            const travelGuidesTableBody = document.getElementById('travelGuidesTableBody');
            travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Đang tải dữ liệu...</td></tr>';

            db.ref('travelGuides').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Không có dữ liệu</td></tr>';
                    return;
                }

                travelGuidesTableBody.innerHTML = '';
                snapshot.forEach((guideSnapshot) => {
                    const guide = guideSnapshot.val();
                    const guideId = guideSnapshot.key;
                    
                    // Helper to create a title from the key
                    const title = guideId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    const displayDate = guide.last_updated ? new Date(guide.last_updated).toLocaleDateString('vi-VN') : 'N/A';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${guide.main_image || 'images/default-tour.jpg'}" alt="guide-image" style="width: 100px; object-fit: cover;"></td>
                        <td>${title}</td>
                        <td>${guide.author || 'N/A'}</td>
                        <td>${displayDate}</td>
                        <td>
                            <button class="btn btn-action btn-edit" onclick="editTravelGuide('${guideId}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-action btn-delete" onclick="deleteTravelGuide('${guideId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    travelGuidesTableBody.appendChild(row);
                });
            }).catch(error => {
                travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>';
            });
        }

        function addTravelGuide() {
            Swal.fire({
                title: 'Thêm bài viết cẩm nang',
                html: `
                    <form id="addTravelGuideForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                        <div class="mb-3">
                            <label class="form-label">Tiêu đề bài viết</label>
                            <input type="text" class="form-control" id="guideTitle" placeholder="VD: Khám Phá Đà Nẵng" required>
                            <small class="form-text text-muted">Tiêu đề sẽ được dùng để tạo ID duy nhất (VD: kham-pha-da-nang).</small>
                        </div>
                        <div class="mb-3"><label class="form-label">Tác giả</label><input type="text" class="form-control" id="guideAuthor" required></div>
                        <div class="mb-3"><label class="form-label">Ngày đăng</label><input type="date" class="form-control" id="guideDate" required></div>
                        <div class="mb-3"><label class="form-label">Hình ảnh chính (URL)</label><input type="url" class="form-control" id="guideImage" required></div>
                        <div class="mb-3"><label class="form-label">Mô tả tổng quan</label><textarea class="form-control" id="guideOverview" rows="5" required></textarea></div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Thêm mới',
                cancelButtonText: 'Hủy',
                width: '800px',
                preConfirm: () => {
                    const form = document.getElementById('addTravelGuideForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    const title = document.getElementById('guideTitle').value;
                    // A simple slugify function
                    const slugify = (text) => {
                        const a = 'àáâãèéêìíòóôõùúăđĩũơưăạảấầẩẫậắằẳẵặẹẻẽềềểỄỆỈỊỌỎỐỒỔỖỘỚỜỞỠỢỤỦỨỪễệỉịọỏốồổỗộớờởỡợụủứừỬỮỰỲỴÝỶỸửữựỳỵỷỹ';
                        const b = 'aaaaaaaaeeeeiiooooouuadiuouaaaaaaaaaaaaaaaeeeeeeeeeeIIOOOOOOOOOOOOOOOOOOUUUUUeeeeeeiiooooooooooooooooouuuuuUUUUUYYYYYuuuuuyyyyy';
                        const p = new RegExp(a.split('').join('|'), 'g');

                        return text.toString().toLowerCase()
                            .replace(p, c => b.charAt(a.indexOf(c)))
                            .replace(/\s+/g, '-')
                            .replace(/[^\w\-]+/g, '')
                            .replace(/\-\-+/g, '-')
                            .replace(/^-+/, '')
                            .replace(/-+$/, '');
                    };
                    const guideId = slugify(title);

                    if (!guideId) {
                        Swal.showValidationMessage('Vui lòng nhập tiêu đề hợp lệ.');
                        return false;
                    }

                    return {
                        guideId: guideId,
                        author: document.getElementById('guideAuthor').value,
                        last_updated: document.getElementById('guideDate').value,
                        main_image: document.getElementById('guideImage').value,
                        overview: document.getElementById('guideOverview').value,
                        // SỬA LỖI: Khởi tạo sections và related_destinations dưới dạng đối tượng thay vì mảng
                        sections: { "0": { "heading": "Nội dung đang được cập nhật..." } },
                        related_destinations: { "0": "" },
                        is_featured_on_homepage: false,
                        id: 'guide_' + guideId.replace(/-/g, '_')
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newGuideData = result.value;
                    const guideId = newGuideData.guideId;
                    delete newGuideData.guideId;

                    db.ref('travelGuides/' + guideId).once('value').then(snapshot => {
                        if (snapshot.exists()) {
                            Swal.fire('Lỗi!', 'Tiêu đề này đã tồn tại, vui lòng chọn tiêu đề khác.', 'error');
                        } else {
                            db.ref('travelGuides/' + guideId).set(newGuideData).then(() => {
                                Swal.fire('Thành công!', 'Bài viết mới đã được thêm.', 'success');
                                loadTravelGuides();
                            }).catch((error) => {
                                Swal.fire('Lỗi!', 'Không thể thêm bài viết: ' + error.message, 'error');
                            });
                        }
                    });
                }
            });
        }

        function editTravelGuide(guideId) {
            db.ref('travelGuides/' + guideId).once('value').then((snapshot) => {
                const guide = snapshot.val();
                if (!guide) {
                    Swal.fire('Lỗi', 'Không tìm thấy bài viết này!', 'error');
                    return;
                }
                const title = guideId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                Swal.fire({
                    title: 'Chỉnh sửa bài viết cẩm nang',
                    html: `
                        <form id="editTravelGuideForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                            <div class="mb-3"><label class="form-label">Tiêu đề (ID)</label><input type="text" class="form-control" value="${title}" disabled></div>
                            <div class="mb-3"><label class="form-label">Tác giả</label><input type="text" class="form-control" id="guideAuthor" value="${guide.author || ''}" required></div>
                            <div class="mb-3"><label class="form-label">Ngày cập nhật</label><input type="date" class="form-control" id="guideDate" value="${guide.last_updated || ''}" required></div>
                            <div class="mb-3"><label class="form-label">Hình ảnh chính (URL)</label><input type="url" class="form-control" id="guideImage" value="${guide.main_image || ''}" required></div>
                            <div class="mb-3"><label class="form-label">Mô tả tổng quan</label><textarea class="form-control" id="guideOverview" rows="5" required>${guide.overview || ''}</textarea></div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu thay đổi',
                    cancelButtonText: 'Hủy',
                    width: '800px',
                    preConfirm: () => {
                        const form = document.getElementById('editTravelGuideForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            author: document.getElementById('guideAuthor').value,
                            last_updated: document.getElementById('guideDate').value,
                            main_image: document.getElementById('guideImage').value,
                            overview: document.getElementById('guideOverview').value,
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        db.ref('travelGuides/' + guideId).update(result.value).then(() => {
                            Swal.fire('Thành công!', 'Bài viết đã được cập nhật.', 'success');
                            loadTravelGuides();
                        }).catch((error) => {
                            Swal.fire('Lỗi!', 'Không thể cập nhật bài viết: ' + error.message, 'error');
                        });
                    }
                });
            });
        }

        function deleteTravelGuide(guideId) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: 'Bạn không thể hoàn tác sau khi xóa!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('travelGuides/' + guideId).remove().then(() => {
                        Swal.fire('Đã xóa!', 'Bài viết đã được xóa.', 'success');
                        loadTravelGuides();
                    }).catch(error => {
                        Swal.fire('Lỗi!', 'Không thể xóa bài viết: ' + error.message, 'error');
                    });
                }
            });
        }

        // =================== CONTRIBUTIONS MANAGEMENT ===================
        
        let currentContributions = [];
        let currentFilter = 'all';

        // Load contributions from Firebase
        function loadContributions() {
            const loadingElement = document.getElementById('contributions-loading');
            const emptyElement = document.getElementById('contributions-empty');
            const listElement = document.getElementById('contributions-list');

            // Show loading
            loadingElement.style.display = 'block';
            emptyElement.style.display = 'none';
            listElement.innerHTML = '';

            db.ref('userContributions').once('value').then((snapshot) => {
                loadingElement.style.display = 'none';

                if (!snapshot.exists()) {
                    emptyElement.style.display = 'block';
                    updateContributionsCount(0);
                    return;
                }

                currentContributions = [];
                snapshot.forEach((contributionSnapshot) => {
                    const contribution = contributionSnapshot.val();
                    contribution.id = contributionSnapshot.key;
                    currentContributions.push(contribution);
                });

                // Sắp xếp theo thời gian gửi (mới nhất trước)
                currentContributions.sort((a, b) => (b.submittedAt || 0) - (a.submittedAt || 0));

                updateContributionsCount(currentContributions.length);
                displayContributions(currentContributions);

                // Update pending count badge
                const pendingCount = currentContributions.filter(c => c.status === 'pending').length;
                updatePendingBadge(pendingCount);

            }).catch(error => {
                loadingElement.style.display = 'none';
                listElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Lỗi khi tải dữ liệu: ${error.message}
                    </div>
                `;
            });
        }

        // Display contributions with current filter
        function displayContributions(contributions) {
            const listElement = document.getElementById('contributions-list');
            
            // Filter contributions based on current filter
            let filteredContributions = contributions;
            if (currentFilter !== 'all') {
                filteredContributions = contributions.filter(c => c.status === currentFilter);
            }

            if (filteredContributions.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">Không có cẩm nang nào với trạng thái "${getStatusText(currentFilter)}"</h6>
                    </div>
                `;
                return;
            }

            listElement.innerHTML = '';
            filteredContributions.forEach(contribution => {
                const contributionCard = createContributionCard(contribution);
                listElement.appendChild(contributionCard);
            });
        }

        // Create contribution card element
        function createContributionCard(contribution) {
            const div = document.createElement('div');
            div.className = 'card mb-4 contribution-card';

            const status = contribution.status || 'pending';
            const statusBadge = getStatusBadge(status);
            const submittedDate = contribution.submittedAt ? new Date(contribution.submittedAt).toLocaleString('vi-VN') : 'Không rõ';
            const hotelCount = contribution.hotelRecommendations ? contribution.hotelRecommendations.length : 0;

            div.innerHTML = `
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <img src="${contribution.main_image || '/images/default-guide.jpg'}" 
                                 alt="Ảnh cẩm nang" class="img-fluid rounded" style="height: 150px; object-fit: cover; width: 100%;">
                        </div>
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-1">${contribution.title}</h5>
                                ${statusBadge}
                            </div>
                            
                            <div class="row text-muted small mb-2">
                                <div class="col-md-6">
                                    <i class="fas fa-user"></i> <strong>Tác giả:</strong> ${contribution.authorName}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-envelope"></i> ${contribution.authorEmail}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-map-marker-alt"></i> <strong>Địa điểm:</strong> ${contribution.location}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-tag"></i> <strong>Danh mục:</strong> ${contribution.category}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-clock"></i> <strong>Thời gian:</strong> ${contribution.duration || 'Không rõ'}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-hotel"></i> <strong>Khách sạn gợi ý:</strong> ${hotelCount} khách sạn
                                </div>
                                <div class="col-12 mt-2">
                                    <i class="fas fa-calendar"></i> <strong>Gửi lúc:</strong> ${submittedDate}
                                </div>
                            </div>
                            
                            <p class="card-text text-muted">${contribution.summary}</p>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="viewContribution('${contribution.id}')">
                                    <i class="fas fa-eye"></i> Xem chi tiết
                                </button>
                                ${status === 'pending' ? `
                                    <button class="btn btn-success btn-sm" onclick="quickApproveContribution('${contribution.id}')">
                                        <i class="fas fa-check"></i> Duyệt nhanh
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="quickRejectContribution('${contribution.id}')">
                                        <i class="fas fa-times"></i> Từ chối
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Chờ duyệt</span>',
                'approved': '<span class="badge bg-success"><i class="fas fa-check"></i> Đã duyệt</span>',
                'rejected': '<span class="badge bg-danger"><i class="fas fa-times"></i> Từ chối</span>'
            };
            return badges[status] || badges['pending'];
        }

        // Get status text
        function getStatusText(status) {
            const texts = {
                'all': 'tất cả',
                'pending': 'chờ duyệt',
                'approved': 'đã duyệt', 
                'rejected': 'từ chối'
            };
            return texts[status] || 'không rõ';
        }

        // Filter contributions
        function filterContributions(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('[onclick^="filterContributions"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');

            displayContributions(currentContributions);
        }

        // Update contributions count
        function updateContributionsCount(count) {
            const badge = document.getElementById('contributions-count-badge');
            if (badge) {
                badge.textContent = count;
            }
        }

        // Update pending badge in sidebar
        function updatePendingBadge(count) {
            const badge = document.getElementById('pending-contributions-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Load pending contributions count for sidebar
        function loadPendingContributionsCount() {
            db.ref('userContributions').orderByChild('status').equalTo('pending').once('value').then((snapshot) => {
                const pendingCount = snapshot.numChildren();
                updatePendingBadge(pendingCount);
            }).catch(error => {
                console.error('Error loading pending contributions count:', error);
            });
        }

        // View contribution details
        function viewContribution(contributionId) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('Lỗi!', 'Không tìm thấy cẩm nang này!', 'error');
                return;
            }

            // Store current contribution for approval/rejection
            window.currentContribution = contribution;

            const modalContent = document.getElementById('contribution-detail-content');
            const submittedDate = contribution.submittedAt ? new Date(contribution.submittedAt).toLocaleString('vi-VN') : 'Không rõ';
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h3>${contribution.title}</h3>
                        <div class="mb-3">
                            ${getStatusBadge(contribution.status || 'pending')}
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong><i class="fas fa-user"></i> Tác giả:</strong> ${contribution.authorName}<br>
                                <strong><i class="fas fa-envelope"></i> Email:</strong> ${contribution.authorEmail}<br>
                                <strong><i class="fas fa-map-marker-alt"></i> Địa điểm:</strong> ${contribution.location}<br>
                                <strong><i class="fas fa-tag"></i> Danh mục:</strong> ${contribution.category}
                            </div>
                            <div class="col-md-6">
                                <strong><i class="fas fa-clock"></i> Thời gian:</strong> ${contribution.duration || 'Không rõ'}<br>
                                <strong><i class="fas fa-dollar-sign"></i> Ngân sách:</strong> ${contribution.budget || 'Không rõ'}<br>
                                <strong><i class="fas fa-calendar"></i> Mùa thích hợp:</strong> ${contribution.season || 'Không rõ'}<br>
                                <strong><i class="fas fa-calendar-plus"></i> Gửi lúc:</strong> ${submittedDate}
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5><i class="fas fa-align-left"></i> Tóm tắt</h5>
                            <p class="bg-light p-3 rounded">${contribution.summary}</p>
                        </div>

                        <div class="mb-4">
                            <h5><i class="fas fa-file-alt"></i> Nội dung chi tiết</h5>
                            <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                                ${contribution.content.replace(/\n/g, '<br>')}
                            </div>
                        </div>

                        ${contribution.hotelRecommendations && contribution.hotelRecommendations.length > 0 ? `
                            <div class="mb-4">
                                <h5><i class="fas fa-hotel"></i> Khách sạn gợi ý (${contribution.hotelRecommendations.length})</h5>
                                ${contribution.hotelRecommendations.map(hotel => `
                                    <div class="card mb-2">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">${hotel.name}</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small><strong>Đánh giá:</strong> ${hotel.rating ? '⭐'.repeat(hotel.rating) : 'Chưa đánh giá'}</small><br>
                                                    <small><strong>Giá:</strong> ${hotel.price || 'Chưa có thông tin'}</small><br>
                                                    <small><strong>Vị trí:</strong> ${hotel.location || 'Chưa có thông tin'}</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small><strong>Gợi ý:</strong> ${getRecommendationText(hotel.recommendation)}</small>
                                                </div>
                                            </div>
                                            ${hotel.review ? `<p class="mt-2 mb-0"><small><strong>Nhận xét:</strong> ${hotel.review}</small></p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <img src="${contribution.main_image || '/images/default-guide.jpg'}" 
                                 alt="Ảnh cẩm nang" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Thông tin thêm</h6>
                            </div>
                            <div class="card-body">
                                <small>
                                    <strong>ID:</strong> ${contribution.id}<br>
                                    <strong>Slug:</strong> ${contribution.slug || 'Chưa tạo'}<br>
                                    <strong>Trạng thái:</strong> ${getStatusText(contribution.status || 'pending')}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Show/hide action buttons based on status
            const approveBtn = document.getElementById('approveContributionBtn');
            const rejectBtn = document.getElementById('rejectContributionBtn');
            
            if (contribution.status === 'pending') {
                approveBtn.style.display = 'inline-block';
                rejectBtn.style.display = 'inline-block';
            } else {
                approveBtn.style.display = 'none';
                rejectBtn.style.display = 'none';
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('contributionDetailModal'));
            modal.show();
        }

        // Get recommendation text
        function getRecommendationText(recommendation) {
            const texts = {
                'highly-recommended': '🔥 Rất khuyến khích',
                'recommended': '👍 Khuyến khích',
                'okay': '😐 Tạm được',
                'not-recommended': '👎 Không khuyến khích'
            };
            return texts[recommendation] || 'Chưa đánh giá';
        }

        // Quick approve contribution
        function quickApproveContribution(contributionId) {
            Swal.fire({
                title: 'Duyệt cẩm nang?',
                text: 'Cẩm nang sẽ được công bố trên website ngay lập tức.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Duyệt',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    approveContribution(contributionId);
                }
            });
        }

        // Quick reject contribution
        function quickRejectContribution(contributionId) {
            Swal.fire({
                title: 'Từ chối cẩm nang',
                input: 'textarea',
                inputLabel: 'Lý do từ chối',
                inputPlaceholder: 'Nhập lý do từ chối để gửi phản hồi cho tác giả...',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Vui lòng nhập lý do từ chối!';
                    }
                },
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Từ chối',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    rejectContribution(contributionId, result.value);
                }
            });
        }

        // Approve contribution
        function approveContribution(contributionId) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('Lỗi!', 'Không tìm thấy cẩm nang này!', 'error');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'Đang xử lý...',
                text: 'Vui lòng đợi trong giây lát',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Generate guide data for travelGuides collection
            const slugId = contribution.slug || generateSlug(contribution.title);
            const guideData = {
                title: contribution.title,
                author: contribution.authorName,
                main_image: contribution.main_image || '/images/default-guide.jpg',
                overview: contribution.summary,
                last_updated: new Date().toISOString().split('T')[0],
                is_featured_on_homepage: false,
                id: slugId,
                slug: slugId, // Thêm slug để hiển thị trên travel_guide.html
                sections: {
                    "0": {
                        "heading": "Thông tin chi tiết",
                        "content": contribution.content
                    }
                },
                related_destinations: { "0": contribution.location },
                category: contribution.category,
                location: contribution.location,
                duration: contribution.duration,
                budget: contribution.budget,
                season: contribution.season,
                hotelRecommendations: contribution.hotelRecommendations || [],
                originalContributionId: contributionId
            };

            // Save to travelGuides and update contribution status
            Promise.all([
                db.ref('travelGuides/' + slugId).set(guideData),
                db.ref('userContributions/' + contributionId + '/status').set('approved'),
                db.ref('userContributions/' + contributionId + '/approvedAt').set(firebase.database.ServerValue.TIMESTAMP),
                db.ref('userContributions/' + contributionId + '/publishedGuideId').set(slugId)
            ]).then(() => {
                // Send approval email
                return emailjs.send("service_6spwxxw", "template_vcjlg02", {
                    to_email: contribution.authorEmail,
                    from_name: "Admin LuxuryHavenTravel",
                    title: "Cẩm nang đã được duyệt",
                    message: `Chúc mừng! Cẩm nang "${contribution.title}" của bạn đã được duyệt và công bố trên website. Cảm ơn bạn đã đóng góp nội dung chất lượng cho cộng đồng du lịch.`,
                    timestamp: new Date().toLocaleString('vi-VN')
                });
            }).then(() => {
                Swal.fire({
                    title: 'Thành công!',
                    text: 'Cẩm nang đã được duyệt và công bố trên website.',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
                
                // Reload contributions
                loadContributions();
                
                // Close modal if open
                const modal = bootstrap.Modal.getInstance(document.getElementById('contributionDetailModal'));
                if (modal) modal.hide();
                
            }).catch(error => {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể duyệt cẩm nang: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
                console.error('Error approving contribution:', error);
            });
        }

        // Reject contribution
        function rejectContribution(contributionId, reason) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('Lỗi!', 'Không tìm thấy cẩm nang này!', 'error');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'Đang xử lý...',
                text: 'Vui lòng đợi trong giây lát',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Update contribution status and add rejection reason
            Promise.all([
                db.ref('userContributions/' + contributionId + '/status').set('rejected'),
                db.ref('userContributions/' + contributionId + '/rejectedAt').set(firebase.database.ServerValue.TIMESTAMP),
                db.ref('userContributions/' + contributionId + '/rejectionReason').set(reason)
            ]).then(() => {
                // Send rejection email
                return emailjs.send("service_6spwxxw", "template_vcjlg02", {
                    to_email: contribution.authorEmail,
                    from_name: "Admin LuxuryHavenTravel",
                    title: "Cẩm nang cần chỉnh sửa",
                    message: `Cẩm nang "${contribution.title}" của bạn cần được chỉnh sửa theo phản hồi sau:\n\n${reason}\n\nVui lòng chỉnh sửa và gửi lại cẩm nang. Cảm ơn bạn đã đóng góp!`,
                    timestamp: new Date().toLocaleString('vi-VN')
                });
            }).then(() => {
                Swal.fire({
                    title: 'Đã từ chối!',
                    text: 'Phản hồi đã được gửi đến tác giả qua email.',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
                
                // Reload contributions
                loadContributions();
                
                // Close modal if open
                const modal = bootstrap.Modal.getInstance(document.getElementById('contributionDetailModal'));
                if (modal) modal.hide();
                
            }).catch(error => {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Không thể từ chối cẩm nang: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
                console.error('Error rejecting contribution:', error);
            });
        }

        // Generate slug from title
        function generateSlug(title) {
            return title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/[đĐ]/g, 'd')
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Remove multiple hyphens
                .trim('-'); // Remove leading/trailing hyphens
        }

        // Event listeners for contribution modals
        document.addEventListener('DOMContentLoaded', function() {
            // Approve button in detail modal
            const approveBtn = document.getElementById('approveContributionBtn');
            if (approveBtn) {
                approveBtn.addEventListener('click', function() {
                    if (window.currentContribution) {
                        approveContribution(window.currentContribution.id);
                    }
                });
            }

            // Reject button in detail modal
            const rejectBtn = document.getElementById('rejectContributionBtn');
            if (rejectBtn) {
                rejectBtn.addEventListener('click', function() {
                    if (window.currentContribution) {
                        const modal = new bootstrap.Modal(document.getElementById('rejectContributionModal'));
                        modal.show();
                    }
                });
            }

            // Confirm reject button in reject modal
            const confirmRejectBtn = document.getElementById('confirmRejectBtn');
            if (confirmRejectBtn) {
                confirmRejectBtn.addEventListener('click', function() {
                    const reason = document.getElementById('rejectReason').value.trim();
                    if (reason && window.currentContribution) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('rejectContributionModal'));
                        modal.hide();
                        rejectContribution(window.currentContribution.id, reason);
                    }
                });
            }
        });

        // --- Settings Management ---
        function loadSettings() {
            db.ref('settings').once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    document.getElementById('settingWebsiteName').value = settings.websiteName || '';
                    document.getElementById('settingContactEmail').value = settings.contactEmail || '';
                    document.getElementById('settingPhoneNumber').value = settings.phoneNumber || '';
                    document.getElementById('settingAddress').value = settings.address || '';
                } else {
                    console.log("No settings found in Firebase. Using default form values.");
                }
            }).catch(error => {
                console.error("Error loading settings:", error);
                Swal.fire('Lỗi!', 'Không thể tải cài đặt: ' + error.message, 'error');
            });
        }

        function saveSettings(event) {
            event.preventDefault(); // Prevent form from submitting traditionally
            const settingsData = {
                websiteName: document.getElementById('settingWebsiteName').value,
                contactEmail: document.getElementById('settingContactEmail').value,
                phoneNumber: document.getElementById('settingPhoneNumber').value,
                address: document.getElementById('settingAddress').value
            };

            db.ref('settings').update(settingsData).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: 'Cài đặt đã được lưu.',
                    timer: 1500
                });
            }).catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Không thể lưu cài đặt: ' + error.message
                });
            });
        }

        // Initialize
        loadLocationChart();
        loadBookings();
        loadHotels();
        loadTours();
        loadDeals();
        loadUsers();
        loadTravelGuides();

        // Initialize things that should only run once
        function initializeApp() {

            // Add event listeners for booking filters
            document.getElementById('bookingSearchInput').addEventListener('input', filterAndDisplayBookings);
            document.getElementById('bookingStatusFilter').addEventListener('change', filterAndDisplayBookings);
            
            // Add event listeners for bulk actions
            document.getElementById('selectAllBookings').addEventListener('change', handleSelectAllBookings);
            document.getElementById('bookingsTable').addEventListener('change', (e) => {
                if (e.target.classList.contains('booking-checkbox')) {
                    updateBulkActionUI();
                }
            });

            document.getElementById('mobile-toggle').addEventListener('click', () => {
                 document.getElementById('sidebar').classList.toggle('active');
            });
            
            updateBulkActionUI(); // Update UI in case filters change selection state
        }

        // --- Bulk Actions for Bookings ---
        function getSelectedBookingIds() {
            return Array.from(document.querySelectorAll('.booking-checkbox:checked')).map(cb => cb.dataset.id);
        }

        function updateBulkActionUI() {
            const selectedIds = getSelectedBookingIds();
            const bulkActionContainer = document.getElementById('bulk-action-container');
            const selectedCountEl = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('selectAllBookings');

            if (selectedIds.length > 0) {
                selectedCountEl.textContent = `${selectedIds.length} đã chọn`;
                bulkActionContainer.classList.remove('d-none');
                bulkActionContainer.classList.add('d-flex');
            } else {
                bulkActionContainer.classList.add('d-none');
                bulkActionContainer.classList.remove('d-flex');
            }

            // Update the "select all" checkbox state
            const totalCheckboxes = document.querySelectorAll('.booking-checkbox').length;
            selectAllCheckbox.checked = totalCheckboxes > 0 && selectedIds.length === totalCheckboxes;
        }
        
        function handleSelectAllBookings(e) {
            const isChecked = e.target.checked;
            document.querySelectorAll('.booking-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkActionUI();
        }

        async function deleteSelectedBookings() {
            const selectedIds = getSelectedBookingIds();
            if (selectedIds.length === 0) {
                Swal.fire("Chưa chọn mục nào", "Vui lòng chọn các mục bạn muốn xóa.", "info");
                return;
            }

            const result = await Swal.fire({
                title: `Bạn chắc chắn muốn xóa ${selectedIds.length} mục?`,
                text: "Hành động này không thể hoàn tác!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Đồng ý xóa!',
                cancelButtonText: 'Hủy'
            });

            if (result.isConfirmed) {
                const deletePromises = selectedIds.map(id => db.ref('bookings/' + id).remove());
                try {
                    await Promise.all(deletePromises);
                    Swal.fire('Đã xóa!', `${selectedIds.length} mục đã được xóa.`, 'success');
                    // Data will refresh automatically via the 'on' listener
                } catch (error) {
                    console.error("Error deleting selected bookings: ", error);
                    Swal.fire('Lỗi!', 'Không thể xóa các mục đã chọn.', 'error');
                }
            }
        }

        async function updateSelectedStatus() {
            const selectedIds = getSelectedBookingIds();
             if (selectedIds.length === 0) {
                Swal.fire("Chưa chọn mục nào", "Vui lòng chọn các mục bạn muốn cập nhật.", "info");
                return;
            }

            const { value: newStatus } = await Swal.fire({
                title: 'Chọn trạng thái mới',
                input: 'select',
                inputOptions: {
                    'pending': 'Chờ xác nhận',
                    'confirmed': 'Đã xác nhận',
                    'cancelled': 'Đã hủy',
                    'completed': 'Hoàn thành'
                },
                inputPlaceholder: 'Chọn một trạng thái',
                showCancelButton: true,
                confirmButtonText: 'Cập nhật',
                cancelButtonText: 'Hủy'
            });

            if (newStatus) {
                const updates = {};
                selectedIds.forEach(id => {
                    updates[`/bookings/${id}/status`] = newStatus;
                });

                try {
                    await db.ref().update(updates);
                    Swal.fire('Thành công!', `Đã cập nhật trạng thái cho ${selectedIds.length} mục.`, 'success');
                } catch (error) {
                     console.error("Error updating selected statuses: ", error);
                    Swal.fire('Lỗi!', 'Không thể cập nhật trạng thái.', 'error');
                }
            }
        }

        function editBooking(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('Lỗi', 'Không tìm thấy đặt phòng này.', 'error');
                return;
            }
            // Danh sách các trường hợp lệ theo rule
            const allowedFields = [
                'bookingType', 'checkIn', 'checkOut', 'createdAt', 'customerEmail', 'customerName', 'customerPhone', 'email',
                'guests', 'hotelId', 'hotelName', 'nights', 'note', 'paymentMethod', 'paymentStatus', 'roomId', 'roomName',
                'roomPrice', 'status', 'totalPrice', 'updatedAt', 'userId',
                // Các trường cho tour
                'numberOfGuests', 'tourId', 'tourName', 'tourCategory', 'tourLocation', 'tourDuration', 'tourImage', 'tourType',
                'tourPrice', 'tourDescription', 'tourIncludes', 'tourExcludes', 'tourRating', 'tourReviewsCount'
            ];
            // Nếu là booking tour
            if (booking.type === 'tour' || booking.bookingType === 'tour') {
                Swal.fire({
                    title: 'Sửa thông tin đặt tour',
                    html: `
                        <input id="edit-tourName" class="swal2-input" placeholder="Tên tour" value="${booking.tourName || ''}">
                        <input id="edit-tourLocation" class="swal2-input" placeholder="Điểm đến" value="${booking.tourLocation || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="Số khách" value="${booking.numberOfGuests || booking.guests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="Tên khách" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="Số điện thoại" value="${booking.customerPhone || ''}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Chờ xác nhận</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Đã xác nhận</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Đã hủy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Hoàn thành</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        return {
                            tourName: document.getElementById('edit-tourName').value,
                            tourLocation: document.getElementById('edit-tourLocation').value,
                            checkIn: document.getElementById('edit-checkIn').value,
                            numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value),
                            customerName: document.getElementById('edit-customerName').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Lọc dữ liệu cũ chỉ lấy các trường hợp lệ
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // Gộp với dữ liệu mới
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('Dữ liệu gửi lên Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Thành công', 'Đã cập nhật thông tin!', 'success');
                            loadBookingsTours();
                            loadBookings(); // Để đồng bộ nếu có thay đổi
                        }).catch(() => {
                            Swal.fire('Lỗi', 'Không thể cập nhật thông tin.', 'error');
                        });
                    }
                });
            } else {
                // Booking khách sạn giữ như cũ
                Swal.fire({
                    title: 'Sửa thông tin đặt phòng',
                    html: `
                        <input id="edit-customerName" class="swal2-input" placeholder="Tên khách" value="${booking.customerName || ''}">
                        <input id="edit-customerEmail" class="swal2-input" placeholder="Email" value="${booking.customerEmail || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="Số điện thoại" value="${booking.customerPhone || ''}">
                        <input id="edit-hotelName" class="swal2-input" placeholder="Khách sạn" value="${booking.hotelName || ''}">
                        <input id="edit-roomId" class="swal2-input" placeholder="Phòng" value="${booking.roomId || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-checkOut" class="swal2-input" type="date" value="${booking.checkOut ? booking.checkOut.split('T')[0] : ''}">
                        <input id="edit-guests" class="swal2-input" type="number" min="1" placeholder="Số khách" value="${booking.guests || 1}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Chờ xác nhận</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Đã xác nhận</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Đã hủy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Hoàn thành</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Lưu',
                    cancelButtonText: 'Hủy',
                    preConfirm: () => {
                        const roomIdValue = document.getElementById('edit-roomId').value;
                        return {
                            customerName: document.getElementById('edit-customerName').value,
                            customerEmail: document.getElementById('edit-customerEmail').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            hotelName: document.getElementById('edit-hotelName').value,
                            roomId: roomIdValue,
                            roomName: roomIdValue,
                            checkIn: document.getElementById('edit-checkIn').value,
                            checkOut: document.getElementById('edit-checkOut').value,
                            guests: parseInt(document.getElementById('edit-guests').value),
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Lọc dữ liệu cũ chỉ lấy các trường hợp lệ
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // Gộp với dữ liệu mới
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('Dữ liệu gửi lên Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Thành công', 'Đã cập nhật thông tin!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('Lỗi', 'Không thể cập nhật thông tin.', 'error');
                        });
                    }
                });
            }
        }

        // === NOTIFICATIONS ===
        function generateNotification(icon, color, text, link = '#') {
            const newNotif = {
                icon: icon, // e.g., 'fas fa-plus'
                color: color, // e.g., 'bg-success'
                text: text,
                link: link,
                read: false,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            db.ref('notifications').push(newNotif);
        }

        function loadNotifications() {
            const notifList = document.getElementById('notificationList');
            const badge = document.getElementById('notificationBell').querySelector('.badge-dot');

            const notificationsRef = db.ref('notifications').orderByChild('timestamp').limitToLast(15);
            
            notificationsRef.on('value', (snapshot) => {
                notifList.innerHTML = '';
                const notifications = [];
                let hasUnread = false;

                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const notif = childSnapshot.val();
                        notif.id = childSnapshot.key;
                        notifications.push(notif);
                        if (!notif.read) {
                            hasUnread = true;
                        }
                    });

                    notifications.reverse(); // Show newest first

                    notifications.forEach(notif => {
                        const item = document.createElement('a');
                        item.href = notif.link || '#';
                        item.className = 'notification-item' + (notif.read ? '' : ' unread');
                        item.dataset.id = notif.id;

                        item.innerHTML = `
                            <div class="icon ${notif.color || 'bg-primary'}">
                                <i class="${notif.icon || 'fas fa-info'}"></i>
                            </div>
                            <div class="content">
                                <p>${notif.text}</p>
                                <span class="timestamp">${new Date(notif.timestamp).toLocaleString('vi-VN')}</span>
                            </div>
                        `;
                        notifList.appendChild(item);
                    });

                } else {
                     notifList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No new notifications</p>
                         </div>`;
                }
                
                // Update badge visibility
                badge.style.display = hasUnread ? 'block' : 'none';
            });
        }

        function markNotificationsAsRead() {
            const notificationsRef = db.ref('notifications');
            notificationsRef.orderByChild('read').equalTo(false).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const updates = {};
                    snapshot.forEach(childSnapshot => {
                        updates[childSnapshot.key + '/read'] = true;
                    });
                    notificationsRef.update(updates);
                }
            });
        }

        function updateMissingRoomId() {
          Swal.fire({
            title: 'Cập nhật dữ liệu phòng?',
            text: 'Tự động cập nhật tất cả booking bị thiếu trường Phòng thành "Chưa cập nhật". Bạn có chắc muốn thực hiện?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Cập nhật',
            cancelButtonText: 'Hủy'
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').once('value').then(snapshot => {
                let count = 0;
                snapshot.forEach(child => {
                  const data = child.val();
                  if (!data.roomId || !String(data.roomId).trim()) {
                    db.ref('bookings/' + child.key).update({ roomId: 'Chưa cập nhật' });
                    count++;
                  }
                });
                Swal.fire('Thành công', `Đã cập nhật ${count} booking bị thiếu trường Phòng!`, 'success');
                loadBookings();
              });
            }
          });
        }

        function updateRoomIdKhongXacDinh() {
          Swal.fire({
            title: 'Cập nhật phòng "Không xác định"?',
            text: 'Tự động cập nhật tất cả booking có trường Phòng là "Không xác định" thành "Phòng chưa đặt". Bạn có chắc muốn thực hiện?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Cập nhật',
            cancelButtonText: 'Hủy'
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').once('value').then(snapshot => {
                let count = 0;
                snapshot.forEach(child => {
                  const data = child.val();
                  if (data.roomId && data.roomId.trim() === 'Không xác định') {
                    db.ref('bookings/' + child.key).update({ roomId: 'Phòng chưa đặt' });
                    count++;
                  }
                });
                Swal.fire('Thành công', `Đã cập nhật ${count} booking có phòng "Không xác định"!`, 'success');
                loadBookings();
              });
                }
            });
        }

        // JS: Thêm hàm loadBookingsTours để lọc và render các booking tour
        function loadBookingsTours() {
          const tableBody = document.getElementById('bookingsToursTable');
          tableBody.innerHTML = '';
          // Lọc booking tour theo cả type và bookingType
          const tourBookings = allBookings.filter(b => b.type === 'tour' || b.bookingType === 'tour');
          if (tourBookings.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-5">Không có booking tour nào.</td></tr>';
            return;
          }
          tourBookings.forEach(booking => {
            const row = document.createElement('tr');
            const statusBadge = `<span class="status status-${booking.status || 'pending'}">${booking.status || 'Chờ xác nhận'}</span>`;
            row.innerHTML = `
              <td>${booking.id}</td>
              <td>${booking.customerName || 'N/A'}</td>
              <td>${booking.customerEmail || 'N/A'}</td>
              <td>${booking.customerPhone || 'N/A'}</td>
              <td>${booking.tourName || 'Tour'}</td>
              <td>${booking.tourLocation || 'N/A'}</td>
              <td>${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</td>
              <td>${booking.numberOfGuests || booking.guests || 'N/A'}</td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="editBooking('${booking.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking.id}')"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        }

        // JS: Thêm hàm addTourBooking
        function addTourBooking() {
          db.ref('specialTours').once('value').then(snapshot => {
            const tours = [];
            snapshot.forEach(groupSnap => {
              const group = groupSnap.val();
              Object.values(group).forEach(tour => {
                tours.push({
                  name: tour.name || '',
                  location: tour.location || ''
                });
              });
            });
            showAddTourBookingPopup(tours);
          });
        }

        function showAddTourBookingPopup(tours) {
          let tourOptions = tours.map(t => `<option value="${t.name}" data-location="${t.location}">${t.name}</option>`).join('');
          Swal.fire({
            title: 'Thêm đặt tour mới',
            html: `
              <div style="display: flex; flex-direction: column; gap: 12px;">
                <select id="add-tourName" class="swal2-input" style="width: 100%"><option value="">Chọn tour</option>${tourOptions}</select>
                <input id="add-tourLocation" class="swal2-input" placeholder="Điểm đến" readonly>
                <input id="add-checkIn" class="swal2-input" type="date">
                <input id="add-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="Số khách" value="1">
                <input id="add-customerName" class="swal2-input" placeholder="Tên khách">
                <input id="add-customerPhone" class="swal2-input" placeholder="Số điện thoại">
                <select id="add-status" class="swal2-input" style="width: 100%">
                  <option value="pending">Chờ xác nhận</option>
                  <option value="confirmed">Đã xác nhận</option>
                  <option value="cancelled">Đã hủy</option>
                  <option value="completed">Hoàn thành</option>
                </select>
              </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Lưu',
            cancelButtonText: 'Hủy',
            didOpen: () => {
              const tourSelect = document.getElementById('add-tourName');
              const locationInput = document.getElementById('add-tourLocation');
              tourSelect.addEventListener('change', function() {
                const selected = tourSelect.options[tourSelect.selectedIndex];
                locationInput.value = selected.getAttribute('data-location') || '';
              });
            },
            preConfirm: () => {
              const tourSelect = document.getElementById('add-tourName');
              const locationInput = document.getElementById('add-tourLocation');
              return {
                tourName: tourSelect.value,
                tourLocation: locationInput.value,
                checkIn: document.getElementById('add-checkIn').value,
                numberOfGuests: parseInt(document.getElementById('add-numberOfGuests').value),
                customerName: document.getElementById('add-customerName').value,
                customerPhone: document.getElementById('add-customerPhone').value,
                status: document.getElementById('add-status').value,
                type: 'tour',
                createdAt: new Date().toISOString()
              };
            }
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').push(result.value).then(() => {
                Swal.fire('Thành công', 'Đã thêm đặt tour mới!', 'success');
                loadBookingsTours();
              }).catch(() => {
                Swal.fire('Lỗi', 'Không thể thêm đặt tour.', 'error');
              });
                }
            });
        }

        // ===== QUẢN LÝ HOÀN TIỀN =====
        function loadRefunds() {
            const refundsTable = document.getElementById('refundsTable');
            if (!refundsTable) return;

            refundsTable.innerHTML = '<tr><td colspan="8" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>';

            db.ref('bookings').orderByChild('status').equalTo('cancelled').once('value').then(snapshot => {
                const refunds = [];
                snapshot.forEach(child => {
                    const booking = child.val();
                    if (booking.refundStatus) { // Chỉ hiển thị booking có thông tin hoàn tiền
                        refunds.push({
                            id: child.key,
                            ...booking
                        });
                    }
                });

                // Sắp xếp theo thời gian hủy mới nhất
                refunds.sort((a, b) => b.cancelledAt - a.cancelledAt);

                if (refunds.length === 0) {
                    refundsTable.innerHTML = '<tr><td colspan="8" class="text-center py-4">Không có yêu cầu hoàn tiền nào.</td></tr>';
                    return;
                }

                refundsTable.innerHTML = '';
                                    refunds.forEach(refund => {
                        const row = document.createElement('tr');
                        const statusBadge = getRefundStatusBadge(refund.refundStatus);
                        const refundAmount = refund.refundAmount || 0;
                        const totalPrice = refund.totalPrice || refund.roomPrice || 0;
                        
                        // Tạo nút thao tác phù hợp với trạng thái
                        let actionButtons = '';
                        if (refund.refundStatus === 'pending') {
                            actionButtons = `
                                <button class="btn btn-sm btn-success" onclick="processRefund('${refund.id}')" title="Xử lý hoàn tiền">
                                    <i class="fas fa-money-bill-wave"></i> Xử lý
                                </button>
                            `;
                        } else if (refund.refundStatus === 'processing') {
                            actionButtons = `
                                <button class="btn btn-sm btn-warning" disabled title="Đang xử lý">
                                    <i class="fas fa-spinner fa-spin"></i> Đang xử lý
                                </button>
                            `;
                        } else if (refund.refundStatus === 'failed') {
                            actionButtons = `
                                <button class="btn btn-sm btn-success" onclick="processRefund('${refund.id}')" title="Thử lại">
                                    <i class="fas fa-redo"></i> Thử lại
                                </button>
                            `;
                        } else if (refund.refundStatus === 'completed') {
                            actionButtons = `
                                <button class="btn btn-sm btn-secondary" disabled title="Đã hoàn tiền">
                                    <i class="fas fa-check-circle"></i> Đã hoàn
                                </button>
                            `;
                        }
                        
                        row.innerHTML = `
                            <td>${refund.id}</td>
                            <td>${refund.customerName || refund.userName || 'N/A'}</td>
                            <td>${refund.customerEmail || refund.email || 'N/A'}</td>
                            <td>${refund.hotelName || refund.tourName || 'N/A'}</td>
                            <td>${totalPrice.toLocaleString()} VNĐ</td>
                            <td>${refundAmount.toLocaleString()} VNĐ</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${actionButtons}
                                <button class="btn btn-sm btn-info" onclick="viewRefundDetails('${refund.id}')" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i> Chi tiết
                                </button>
                            </td>
                        `;
                        refundsTable.appendChild(row);
                    });
            });
        }

        function getRefundStatusBadge(status) {
            const statusMap = {
                'pending': '<span class="badge bg-warning">Chờ xử lý</span>',
                'processing': '<span class="badge bg-info">Đang xử lý</span>',
                'completed': '<span class="badge bg-success">Đã hoàn tiền</span>',
                'failed': '<span class="badge bg-danger">Thất bại</span>'
            };
            return statusMap[status] || '<span class="badge bg-secondary">Không xác định</span>';
        }

        function getRefundStatusText(status) {
            const statusMap = {
                'pending': 'Chờ xử lý',
                'processing': 'Đang xử lý',
                'completed': 'Đã hoàn tiền',
                'failed': 'Thất bại'
            };
            return statusMap[status] || 'Không xác định';
        }

        function processRefund(bookingId) {
            Swal.fire({
                title: 'Chọn phương thức hoàn tiền',
                text: 'Bạn muốn hoàn tiền bằng phương thức nào?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Hoàn tiền tự động (VNPay)',
                cancelButtonText: 'Hoàn tiền thủ công',
                showDenyButton: true,
                denyButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Hoàn tiền tự động qua VNPay
                    processAutomaticRefund(bookingId);
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    // Hoàn tiền thủ công
                    processManualRefund(bookingId);
                }
            });
        }

        // Hoàn tiền tự động qua VNPay
        async function processAutomaticRefund(bookingId) {
            try {
                Swal.fire({
                    title: 'Đang xử lý hoàn tiền...',
                    text: 'Vui lòng chờ trong giây lát',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Lấy thông tin booking
                const snapshot = await db.ref('bookings/' + bookingId).once('value');
                const booking = snapshot.val();

                if (!booking) {
                    throw new Error('Không tìm thấy thông tin booking');
                }

                // Cập nhật trạng thái thành processing
                await db.ref('bookings/' + bookingId).update({
                    refundStatus: 'processing',
                    refundProcessingAt: Date.now()
                });

                // Giả lập hoàn tiền VNPay (trong thực tế sẽ gọi API VNPay)
                await new Promise(resolve => setTimeout(resolve, 2000)); // Giả lập delay

                // Giả lập kết quả thành công (luôn thành công cho demo)
                const success = true; // Luôn thành công cho demo

                if (success) {
                    await db.ref('bookings/' + bookingId).update({
                        refundStatus: 'completed',
                        refundCompletedAt: Date.now(),
                        refundTransactionId: `VNPAY_${Date.now()}`,
                        refundMethod: 'vnpay_automatic'
                    });

                    Swal.fire('Thành công', 'Đã hoàn tiền tự động qua VNPay!', 'success');
                } else {
                    await db.ref('bookings/' + bookingId).update({
                        refundStatus: 'failed',
                        refundFailedAt: Date.now(),
                        refundErrorMessage: 'Hoàn tiền thất bại - Vui lòng thử lại'
                    });

                    Swal.fire('Thất bại', 'Hoàn tiền tự động thất bại. Vui lòng thử hoàn tiền thủ công.', 'error');
                }

                loadRefunds();
            } catch (error) {
                console.error('Lỗi khi hoàn tiền tự động:', error);
                Swal.fire('Lỗi', 'Không thể xử lý hoàn tiền tự động: ' + error.message, 'error');
            }
        }

        // Hoàn tiền thủ công
        async function processManualRefund(bookingId) {
            try {
                Swal.fire({
                    title: 'Xác nhận hoàn tiền thủ công?',
                    text: 'Bạn có chắc đã hoàn tiền cho khách hàng?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await db.ref('bookings/' + bookingId).update({
                            refundStatus: 'completed',
                            refundCompletedAt: Date.now(),
                            refundMethod: 'manual_bank_transfer',
                            refundNote: 'Admin xác nhận đã hoàn tiền thủ công'
                        });

                        Swal.fire('Thành công', 'Đã xác nhận hoàn tiền thủ công!', 'success');
                        loadRefunds();
                    }
                });
            } catch (error) {
                console.error('Lỗi khi hoàn tiền thủ công:', error);
                Swal.fire('Lỗi', 'Không thể cập nhật trạng thái hoàn tiền.', 'error');
            }
        }

        function viewRefundDetails(bookingId) {
            db.ref('bookings/' + bookingId).once('value').then(snapshot => {
                const booking = snapshot.val();
                if (!booking) {
                    Swal.fire('Lỗi', 'Không tìm thấy thông tin booking.', 'error');
                    return;
                }

                const refundAmount = booking.refundAmount || 0;
                const totalPrice = booking.totalPrice || booking.roomPrice || 0;
                const refundPercentage = totalPrice > 0 ? ((refundAmount / totalPrice) * 100).toFixed(1) : 0;
                
                // Thông tin thời gian
                const cancelledDate = booking.cancelledAt ? new Date(booking.cancelledAt).toLocaleString('vi-VN') : 'N/A';
                const processingDate = booking.refundProcessingAt ? new Date(booking.refundProcessingAt).toLocaleString('vi-VN') : 'N/A';
                const completedDate = booking.refundCompletedAt ? new Date(booking.refundCompletedAt).toLocaleString('vi-VN') : 'N/A';
                const failedDate = booking.refundFailedAt ? new Date(booking.refundFailedAt).toLocaleString('vi-VN') : 'N/A';
                
                // Thông tin phương thức hoàn tiền
                const refundMethod = booking.refundMethod || 'Chưa xác định';
                const transactionId = booking.refundTransactionId || 'N/A';
                const errorMessage = booking.refundErrorMessage || '';
                const refundNote = booking.refundNote || 'N/A';

                Swal.fire({
                    title: 'Chi tiết hoàn tiền',
                    html: `
                        <div class="text-left">
                            <h6 class="mb-3">Thông tin booking</h6>
                            <p><strong>Booking ID:</strong> ${bookingId}</p>
                            <p><strong>Khách hàng:</strong> ${booking.customerName || booking.userName || 'N/A'}</p>
                            <p><strong>Email:</strong> ${booking.customerEmail || booking.email || 'N/A'}</p>
                            <p><strong>Dịch vụ:</strong> ${booking.hotelName || booking.tourName || 'N/A'}</p>
                            <p><strong>Tổng tiền:</strong> ${totalPrice.toLocaleString()} VNĐ</p>
                            
                            <hr>
                            <h6 class="mb-3">Thông tin hoàn tiền</h6>
                            <p><strong>Số tiền hoàn:</strong> ${refundAmount.toLocaleString()} VNĐ (${refundPercentage}%)</p>
                            <p><strong>Trạng thái:</strong> ${getRefundStatusText(booking.refundStatus)}</p>
                            <p><strong>Phương thức:</strong> ${refundMethod}</p>
                            <p><strong>Mã giao dịch:</strong> ${transactionId}</p>
                            
                            <hr>
                            <h6 class="mb-3">Thời gian</h6>
                            <p><strong>Ngày hủy:</strong> ${cancelledDate}</p>
                            <p><strong>Bắt đầu xử lý:</strong> ${processingDate}</p>
                            <p><strong>Hoàn thành:</strong> ${completedDate}</p>
                            <p><strong>Thất bại:</strong> ${failedDate}</p>
                            
                            ${errorMessage ? `
                                <hr>
                                <h6 class="mb-3">Lỗi</h6>
                                <p class="text-danger"><strong>Lỗi:</strong> ${errorMessage}</p>
                            ` : ''}
                            
                            ${refundNote !== 'N/A' ? `
                                <hr>
                                <h6 class="mb-3">Ghi chú</h6>
                                <p><strong>Ghi chú:</strong> ${refundNote}</p>
                            ` : ''}
                        </div>
                    `,
                    width: '600px',
                    icon: 'info',
                    confirmButtonText: 'Đóng'
                });
            });
        }

        // Hàm tổng hợp số liệu theo tháng (trả về object)
        async function getMonthlyStats(month, year) {
          const start = new Date(year, month - 1, 1).getTime();
          const end = new Date(year, month, 0, 23, 59, 59, 999).getTime();
          // 1. Lấy users
          const usersSnap = await db.ref('users').once('value');
          let newUsers = 0;
          usersSnap.forEach(userSnap => {
            const user = userSnap.val();
            if (user.createdAt && user.createdAt >= start && user.createdAt <= end) newUsers++;
          });
          // 2. Lấy bookings
          const bookingsSnap = await db.ref('bookings').once('value');
          const roomSet = new Set();
          const userIds = new Set();
          let revenue = 0;
          bookingsSnap.forEach(bookingSnap => {
            const booking = bookingSnap.val();
            if (booking.createdAt >= start && booking.createdAt <= end) {
              userIds.add(booking.userId);
              if ((booking.status === 'confirmed' || booking.status === 'completed')) {
                roomSet.add(`${booking.hotelId}_${booking.roomId}`);
                revenue += booking.totalPrice || 0;
              }
            }
          });
          // 3. Thống kê giới tính
          let male = 0, female = 0, other = 0;
          userIds.forEach(uid => {
            const user = usersSnap.child(uid).val();
            if (user && user.gender) {
              if (user.gender === 'Nam') male++;
              else if (user.gender === 'Nữ') female++;
              else other++;
            } else {
              other++;
            }
          });
          return {
            newUsers,
            roomsBooked: roomSet.size,
            gender: { male, female, other },
            revenue
          };
        }

        // Hàm tính % thay đổi so với tháng trước
        function calcChange(current, prev) {
          if (prev === 0 && current === 0) return {percent: 0, up: false};
          if (prev === 0) return {percent: 100, up: true};
          const percent = Math.round(((current - prev) / prev) * 100);
          return {percent: Math.abs(percent), up: current >= prev};
        }

        // Cập nhật giao diện thống kê và so sánh tháng trước
        async function updateMonthlyStatsUI() {
          const month = parseInt(document.getElementById('stat-month').value);
          const year = parseInt(document.getElementById('stat-year').value);
          document.getElementById('stat-month-label').textContent = month;
          document.getElementById('stat-year-label').textContent = year;
          const stats = await getMonthlyStats(month, year);
          // Tháng trước
          let prevMonth = month - 1, prevYear = year;
          if (prevMonth === 0) { prevMonth = 12; prevYear = year - 1; }
          const prevStats = await getMonthlyStats(prevMonth, prevYear);
          // Hiển thị số liệu hiện tại
          document.getElementById('stat-new-users').textContent = stats.newUsers;
          document.getElementById('stat-rooms-booked').textContent = stats.roomsBooked;
          document.getElementById('stat-gender').textContent = `${stats.gender.male}/${stats.gender.female}/${stats.gender.other}`;
          document.getElementById('stat-revenue').textContent = stats.revenue.toLocaleString('vi-VN');
          // Hiển thị % thay đổi
          function renderChange(el, change) {
            if (!el) return;
            if (change.percent === 0) {
              el.innerHTML = '<span style="color:#888">0%</span>';
            } else {
              el.innerHTML = `<span style="color:${change.up ? '#43a047' : '#e53935'};font-weight:600"><i class="fas fa-arrow-${change.up ? 'up' : 'down'}"></i> ${change.percent}%</span>`;
            }
          }
          renderChange(document.getElementById('stat-new-users-change'), calcChange(stats.newUsers, prevStats.newUsers));
          renderChange(document.getElementById('stat-rooms-booked-change'), calcChange(stats.roomsBooked, prevStats.roomsBooked));
          renderChange(document.getElementById('stat-gender-male-change'), calcChange(stats.gender.male, prevStats.gender.male));
          renderChange(document.getElementById('stat-revenue-change'), calcChange(stats.revenue, prevStats.revenue));
          // Lưu lại để xuất Excel
          window._lastMonthlyStats = { month, year, ...stats };
          // Kích hoạt tooltip Bootstrap
          if (window.bootstrap && window.bootstrap.Tooltip) {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
              new bootstrap.Tooltip(el);
            });
          }
          // Vẽ mini chart doanh thu 12 tháng gần nhất
          await renderMiniRevenueChart(month, year);
        }

        document.getElementById('stat-month').addEventListener('change', updateMonthlyStatsUI);
        document.getElementById('stat-year').addEventListener('change', updateMonthlyStatsUI);
        window.addEventListener('DOMContentLoaded', updateMonthlyStatsUI);

        // Xuất Excel
        function exportStatsToExcel() {
          const stats = window._lastMonthlyStats;
          if (!stats) return;
          const wsData = [
            ['Thống kê tháng', `${stats.month}/${stats.year}`],
            ['Số khách mới', stats.newUsers],
            ['Số phòng có người đặt', stats.roomsBooked],
            ['Giới tính (Nam/Nữ/Khác)', `${stats.gender.male}/${stats.gender.female}/${stats.gender.other}`],
            ['Doanh thu (VNĐ)', stats.revenue]
          ];
          const ws = XLSX.utils.aoa_to_sheet(wsData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Thống kê');
          XLSX.writeFile(wb, `ThongKe_${stats.month}_${stats.year}.xlsx`);
        }
        document.getElementById('export-excel-btn').addEventListener('click', exportStatsToExcel);

        // Vẽ mini chart doanh thu 12 tháng gần nhất
        async function renderMiniRevenueChart(selectedMonth, selectedYear) {
          const canvas = document.getElementById('mini-revenue-chart');
          if (!canvas) return;
          if (miniRevenueChartInstance) { miniRevenueChartInstance.destroy(); miniRevenueChartInstance = null; }
          // Lấy dữ liệu 12 tháng gần nhất
          const now = new Date(selectedYear, selectedMonth - 1);
          const labels = [];
          const data = [];
          for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            labels.push(`${d.getMonth() + 1}/${d.getFullYear().toString().slice(-2)}`);
            const stats = await getMonthlyStats(d.getMonth() + 1, d.getFullYear());
            data.push(Math.round(stats.revenue / 1000000)); // Triệu VNĐ
          }
          const ctx = canvas.getContext('2d');
          miniRevenueChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                data,
                borderColor: '#43e97b',
                backgroundColor: 'rgba(67,233,123,0.08)',
                tension: 0.4,
                pointRadius: 0,
                fill: true,
                borderWidth: 2
              }]
            },
            options: {
              plugins: { legend: { display: false } },
              scales: { x: { display: false }, y: { display: false } },
              elements: { line: { borderJoinStyle: 'round' } },
              responsive: false,
              maintainAspectRatio: false
            }
          });
        }

        // Popup chi tiết doanh thu từng ngày khi click vào card doanh thu
        const revenueCard = document.querySelector('.stats-summary-card.revenue');
        if (revenueCard) {
          revenueCard.style.cursor = 'pointer';
          revenueCard.addEventListener('click', async () => {
            const month = parseInt(document.getElementById('stat-month').value);
            const year = parseInt(document.getElementById('stat-year').value);
            // Lấy doanh thu từng ngày trong tháng
            const start = new Date(year, month - 1, 1).getTime();
            const end = new Date(year, month, 0, 23, 59, 59, 999).getTime();
            const bookingsSnap = await db.ref('bookings').once('value');
            const dailyRevenue = {};
            for (let d = 1; d <= new Date(year, month, 0).getDate(); d++) dailyRevenue[d] = 0;
            bookingsSnap.forEach(bookingSnap => {
              const booking = bookingSnap.val();
              if (
                booking.createdAt >= start && booking.createdAt <= end &&
                (booking.status === 'confirmed' || booking.status === 'completed')
              ) {
                const date = new Date(booking.createdAt);
                const day = date.getDate();
                dailyRevenue[day] += booking.totalPrice || 0;
              }
            });
            // Hiển thị popup với biểu đồ cột
            const days = Object.keys(dailyRevenue);
            const values = Object.values(dailyRevenue).map(v => Math.round(v / 1000)); // Nghìn VNĐ
            const popupId = 'popup-daily-revenue-chart';
            Swal.fire({
              title: `Chi tiết doanh thu từng ngày tháng ${month}/${year}`,
              html: `<canvas id="${popupId}" height="220"></canvas>`,
              width: 700,
              showCloseButton: true,
              didOpen: () => {
                const ctx = document.getElementById(popupId).getContext('2d');
                new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: days,
                    datasets: [{
                      label: 'Doanh thu (nghìn VNĐ)',
                      data: values,
                      backgroundColor: '#43e97b',
                      borderRadius: 6
                    }]
                  },
                  options: {
                    plugins: { legend: { display: false } },
                    scales: { x: { title: { display: true, text: 'Ngày' } }, y: { title: { display: true, text: 'Nghìn VNĐ' } } },
                    responsive: true,
                    maintainAspectRatio: false
                  }
                });
              }
            });
          });
        }

        // Sự kiện click card 'Phòng có người'
        document.querySelector('.stats-summary-card .fa-bed').closest('.stats-summary-card').addEventListener('click', async function() {
          const month = parseInt(document.getElementById('stat-month').value);
          const year = parseInt(document.getElementById('stat-year').value);
          // Tính ngày đầu và cuối tháng dạng YYYY-MM-DD
          const startDate = new Date(year, month - 1, 1);
          const endDate = new Date(year, month, 0);
          function parseDate(str) {
            // str: YYYY-MM-DD
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
          }
          // Lấy bookings hợp lệ (chỉ loại trừ cancelled/rejected)
          const bookingsSnap = await db.ref('bookings').once('value');
          const bookings = [];
          bookingsSnap.forEach(snap => {
            const b = snap.val();
            const status = (b.status || '').toLowerCase();
            if (status !== 'cancelled' && status !== 'rejected' && b.checkIn) {
              let checkInDate;
              if (typeof b.checkIn === 'string' && b.checkIn.match(/^\d{4}-\d{2}-\d{2}$/)) {
                checkInDate = parseDate(b.checkIn);
              } else if (typeof b.checkIn === 'number') {
                checkInDate = new Date(b.checkIn);
              }
              if (checkInDate && checkInDate >= startDate && checkInDate <= endDate) {
                bookings.push({...b, id: snap.key});
              }
            }
          });
          // Lấy thông tin khách sạn/phòng
          const hotelNames = {};
          const roomNames = {};
          for (const b of bookings) {
            if (b.hotelId && !hotelNames[b.hotelId]) {
              const hSnap = await db.ref('hotels/' + b.hotelId).once('value');
              hotelNames[b.hotelId] = hSnap.exists() ? hSnap.val().name : (b.hotelName || b.hotelId);
            }
            if (b.roomId && !roomNames[b.roomId]) {
              roomNames[b.roomId] = b.roomId;
            }
          }
          // Render bảng
          const tbody = document.getElementById('occupiedRoomsTableBody');
          tbody.innerHTML = bookings.map(b => `
            <tr>
              <td>${b.hotelId ? (hotelNames[b.hotelId] || b.hotelName || b.hotelId) : '<span class="text-danger">Thiếu dữ liệu</span>'}</td>
              <td>${b.roomId ? (roomNames[b.roomId] || b.roomId) : '<span class="text-danger">Thiếu dữ liệu</span>'}</td>
              <td>${b.customerName || b.guestName || ''}</td>
              <td>${b.checkIn ? (typeof b.checkIn === 'string' ? b.checkIn : (new Date(b.checkIn)).toLocaleDateString()) : '<span class="text-danger">Thiếu dữ liệu</span>'}</td>
              <td>${b.checkOut ? (typeof b.checkOut === 'string' ? b.checkOut : (new Date(b.checkOut)).toLocaleDateString()) : ''}</td>
              <td>${b.status || ''}</td>
            </tr>
          `).join('');
          // Mở modal
          const modal = new bootstrap.Modal(document.getElementById('occupiedRoomsModal'));
          modal.show();
        });
    </script>

    <!-- Modal chi tiết cẩm nang -->
    <div class="modal fade" id="contributionDetailModal" tabindex="-1" aria-labelledby="contributionDetailModalLabel">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contributionDetailModalLabel">Chi tiết cẩm nang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div id="contribution-detail-content">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" id="rejectContributionBtn">
                        <i class="fas fa-times"></i> Từ chối
                    </button>
                    <button type="button" class="btn btn-success" id="approveContributionBtn">
                        <i class="fas fa-check"></i> Duyệt & Công bố
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal từ chối cẩm nang -->
    <div class="modal fade" id="rejectContributionModal" tabindex="-1" aria-labelledby="rejectContributionModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectContributionModalLabel">Từ chối cẩm nang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">Lý do từ chối *</label>
                        <textarea class="form-control" id="rejectReason" rows="4" 
                            placeholder="Nhập lý do từ chối để gửi phản hồi cho tác giả..."></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Lưu ý:</strong> Lý do từ chối sẽ được gửi email cho tác giả để họ có thể chỉnh sửa và gửi lại.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                        <i class="fas fa-times"></i> Xác nhận từ chối
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chi tiết phòng có người -->
    <div class="modal fade" id="occupiedRoomsModal" tabindex="-1" aria-labelledby="occupiedRoomsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="occupiedRoomsModalLabel">Danh sách phòng có người đặt trong tháng</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Tên khách sạn</th>
                    <th>Số phòng</th>
                    <th>Tên khách</th>
                    <th>Ngày nhận</th>
                    <th>Ngày trả</th>
                    <th>Trạng thái</th>
                  </tr>
                </thead>
                <tbody id="occupiedRoomsTableBody">
                  <!-- Dữ liệu sẽ được render bằng JS -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mobile JavaScript -->
    <script src="js/mobile.js"></script>
</body>

</html>