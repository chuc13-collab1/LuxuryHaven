<!DOCTYPE html>
<html lang="vi">
    

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxuryHavenTravel Admin Dashboard</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    
    <!-- Google Fonts - Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Local CSS -->
    <link rel="stylesheet" href="css/admin-dashboard.css">
    <link rel="stylesheet" href="css/admin-dashboard-mobile.css">
    <link rel="stylesheet" href="css/mobile.css">
</head>

<body class="admin-body">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-brand">
                <!-- <i class="fas fa-gem me-2"></i> Example Logo Icon -->
                <span>ADMIN LuxuryHavenTravel</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-group">
                <span class="nav-group-title">MAIN</span>
            <a href="#dashboard" class="nav-item active">
                    <i class="fas fa-home-alt"></i> <span>Dashboard</span>
            </a>
            </div>
            <div class="nav-group">
                <span class="nav-group-title">QU·∫¢N L√ù</span>
            <a href="#bookings" class="nav-item">
                <i class="fas fa-bed"></i><span>ƒê·∫∑t ph√≤ng</span>
             </a>
            <a href="#bookings-tours" class="nav-item">
                <i class="fas fa-route"></i> <span>ƒê·∫∑t tours</span>
            </a>
            <a href="#hotels" class="nav-item">
                    <i class="fas fa-hotel"></i> <span>Kh√°ch s·∫°n</span>
            </a>
            <a href="#users" class="nav-item">
                    <i class="fas fa-users"></i> <span>Ng∆∞·ªùi d√πng</span>
            </a>
            <a href="#tours" class="nav-item">
                    <i class="fas fa-map-marked-alt"></i> <span>Tours</span>
            </a>
            <a href="#refunds" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i> <span>Qu·∫£n l√Ω ho√†n ti·ªÅn</span>
            </a>
            <a href="#deals" class="nav-item">
                    <i class="fas fa-tags"></i> <span>∆Øu ƒë√£i</span>
                </a>
                <a href="#travel-guides" class="nav-item">
                    <i class="fas fa-book-open"></i> <span>C·∫©m nang du l·ªãch</span>
                </a>
                <a href="#contributions" class="nav-item">
                    <i class="fas fa-user-edit"></i> <span>Duy·ªát c·∫©m nang</span>
                    <span id="pending-contributions-badge" class="badge bg-danger ms-2" style="display: none;">0</span>
                </a>
            </div>
             <div class="nav-group">
                <span class="nav-group-title">H·ªÜ TH·ªêNG</span>
            <a href="#settings" class="nav-item">
                    <i class="fas fa-cog"></i> <span>C√†i ƒë·∫∑t</span>
            </a>
            </div>
        </nav>
        <div class="sidebar-footer">
            <button class="btn btn-danger w-100" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Main Header -->
        <header class="main-header">
             <div class="header-left">
                <button class="mobile-toggle" id="mobile-toggle">
                    <i class="fas fa-bars"></i>
                    </button>
                <h1 class="page-title" id="page-title-header">Dashboard</h1>
                </div>
            <div class="header-right">
                <div class="header-search" id="headerSearchContainer" style="display: none;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="globalSearchInput" placeholder="Search...">
            </div>
                <div class="header-actions">
                    <div class="notification-wrapper">
                        <button class="btn-icon" id="notificationBell">
                            <i class="fas fa-bell"></i>
                            <span class="badge-dot" style="display: none;"></span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h6 class="mb-0">Th√¥ng b√°o</h6>
                                <a href="#" class="btn-link" id="markAllAsReadBtn">ƒê√°nh d·∫•u t·∫•t c·∫£ l√† ƒë√£ ƒë·ªçc</a>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</p>
                                 </div>
                            </div>
                             <div class="notification-footer">
                                <a href="#">Xem t·∫•t c·∫£ th√¥ng b√°o</a>
                            </div>
                        </div>
                    </div>
                    <!-- <button class="btn-icon"><i class="fas fa-cog"></i></button> -->
                </div>
                <!-- <div class="user-profile">
                    <span class="user-name">Omar Ali</span>
                    <span class="user-role">Company Owner</span>
                    <img src="https://i.pravatar.cc/40" alt="User Avatar">
                </div> -->
            </div>
        </header>
        
        <main class="content-wrapper">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section">
            <!-- Th√™m v√†o sau header, tr∆∞·ªõc ph·∫ßn th·ªëng k√™ cards -->
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="stat-month" class="form-label">Ch·ªçn th√°ng</label>
                <select id="stat-month" class="form-select">
                  <option value="1">Th√°ng 1</option>
                  <option value="2">Th√°ng 2</option>
                  <option value="3">Th√°ng 3</option>
                  <option value="4">Th√°ng 4</option>
                  <option value="5">Th√°ng 5</option>
                  <option value="6">Th√°ng 6</option>
                  <option value="7">Th√°ng 7</option>
                  <option value="8">Th√°ng 8</option>
                  <option value="9">Th√°ng 9</option>
                  <option value="10">Th√°ng 10</option>
                  <option value="11">Th√°ng 11</option>
                  <option value="12">Th√°ng 12</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="stat-year" class="form-label">Ch·ªçn nƒÉm</label>
                <input type="number" id="stat-year" class="form-control" min="2020" max="2100" value="2025">
              </div>
              <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success w-100" id="export-excel-btn"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</button>
              </div>
            </div>
            <div class="dashboard-greeting mb-4">
              <h2 style="font-weight:700; font-size:2rem; margin-bottom:0.2em;">Xin ch√†o, <span id="admin-greeting-name">Admin</span>!</h2>
              <div style="color:#1976d2; font-size:1.1rem; font-weight:500;">Ch√∫c b·∫°n m·ªôt ng√†y l√†m vi·ªác hi·ªáu qu·∫£ v√† doanh thu b·ª©t ph√° üöÄ</div>
            </div>
            <div class="stats-summary-cards">
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#1976d2 0%,#64b5f6 100%)"><i class="fas fa-user-plus"></i></div>
                <div>
                  <div class="stats-summary-label">Kh√°ch m·ªõi <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="S·ªë ng∆∞·ªùi d√πng m·ªõi ƒëƒÉng k√Ω trong th√°ng n√†y."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-new-users">0</div>
                    <span id="stat-new-users-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">trong th√°ng <span id="stat-month-label"></span>/<span id="stat-year-label"></span></div>
                </div>
              </div>
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#ff9800 0%,#ffc107 100%)"><i class="fas fa-bed"></i></div>
                <div>
                  <div class="stats-summary-label">Ph√≤ng c√≥ ng∆∞·ªùi <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="S·ªë ph√≤ng ƒë√£ c√≥ booking x√°c nh·∫≠n ho·∫∑c ho√†n th√†nh trong th√°ng n√†y."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-rooms-booked">0</div>
                    <span id="stat-rooms-booked-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">ƒë√£ ƒë·∫∑t trong th√°ng</div>
                </div>
              </div>
              <div class="stats-summary-card">
                <div class="stats-summary-icon" style="background:linear-gradient(135deg,#e91e63 0%,#f48fb1 100%)"><i class="fas fa-venus-mars"></i></div>
                <div>
                  <div class="stats-summary-label">Gi·ªõi t√≠nh <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="T·ªïng s·ªë kh√°ch c√≥ booking trong th√°ng n√†y, ph√¢n theo Nam/N·ªØ/Kh√°c."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-gender">0/0/0</div>
                    <span id="stat-gender-male-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">Nam / N·ªØ / Kh√°c</div>
                </div>
              </div>
              <div class="stats-summary-card revenue">
                <div class="stats-summary-icon"><i class="fas fa-coins"></i></div>
                <div>
                  <div class="stats-summary-label">Doanh thu <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" title="T·ªïng doanh thu t·ª´ c√°c booking ƒë√£ x√°c nh·∫≠n/ho√†n th√†nh trong th√°ng n√†y."></i></div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="stats-summary-value" id="stat-revenue">0</div>
                    <span id="stat-revenue-change" class="stats-summary-change"></span>
                  </div>
                  <div class="stats-summary-sub">VNƒê trong th√°ng</div>
                  <canvas id="mini-revenue-chart" height="36" style="margin-top:8px;max-width:180px;"></canvas>
                </div>
              </div>
            </div>
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #e3f2fd; color: #1976d2;">
                            <i class="fas fa-hotel"></i>
                        </div>
                        <div class="title">T·ªïng kh√°ch s·∫°n</div>
                        <div class="value" id="totalHotels">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #e8f5e9; color: #2e7d32;">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="title">ƒê·∫∑t ph√≤ng h√¥m nay</div>
                        <div class="value" id="todayBookings">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #fff3e0; color: #e65100;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="title">T·ªïng ng∆∞·ªùi d√πng</div>
                        <div class="value" id="totalUsers">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon" style="background: #f3e5f5; color: #7b1fa2;">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="title">∆Øu ƒë√£i ƒëang c√≥</div>
                        <div class="value" id="activeDeals">0</div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="bookingTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="newUsersChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookings" class="content-section" style="display: none;">
            <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0">Danh s√°ch ƒë·∫∑t ph√≤ng</h5>
                        
                        <div id="bulk-action-container" class="d-none align-items-center">
                            <span id="selected-count" class="fw-bold me-3"></span>
                            <button class="btn btn-sm btn-secondary" onclick="updateSelectedStatus()">
                                <i class="fas fa-edit me-1"></i> ƒê·ªïi tr·∫°ng th√°i
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelectedBookings()">
                                <i class="fas fa-trash me-1"></i> X√≥a
                            </button>
                        </div>

                        <div class="ms-auto"> <!-- Push the add button to the right -->
                    <button class="btn btn-primary btn-sm" onclick="addBooking()">
                        <i class="fas fa-plus-circle me-1"></i> Th√™m ƒë·∫∑t ph√≤ng
                    </button>
                        </div>
                    </div>
                    <div class="card-body p-3 border-bottom">
                         <div class="row g-2 justify-content-end">
                            <div class="col-md-4">
                                <select id="bookingStatusFilter" class="form-select">
                                    <option value="all" selected>T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                    <option value="pending">Ch·ªù x√°c nh·∫≠n</option>
                                    <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                                    <option value="cancelled">ƒê√£ h·ªßy</option>
                                    <option value="completed">Ho√†n th√†nh</option>
                                </select>
                            </div>
                        </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-hover align-middle">
                        <thead class="table-light">
                          <tr>
                                    <th>ID</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>Email</th>
                                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>Kh√°ch s·∫°n</th>
                            <th>D·ªãch v·ª•</th>
                            <th>Check-in</th>
                            <th>Check-out</th>
                                    <th>S·ªë kh√°ch</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTable">
                          <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Tours Section -->
        <div id="bookings-tours" class="content-section" style="display: none;">
          <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h5 class="mb-0">Danh s√°ch ƒë·∫∑t tours</h5>
              <button class="btn btn-primary btn-sm" onclick="addTourBooking()">
                <i class="fas fa-plus-circle me-1"></i> Th√™m ƒë·∫∑t tours
              </button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Kh√°ch h√†ng</th>
                      <th>Email</th>
                      <th>S·ªë ƒëi·ªán tho·∫°i</th>
                      <th>T√™n tour</th>
                      <th>ƒêi·ªÉm ƒë·∫øn</th>
                      <th>Check-in</th>
                      <th>S·ªë kh√°ch</th>
                      <th>Tr·∫°ng th√°i</th>
                      <th>Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody id="bookingsToursTable">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hotels Section -->
        <div id="hotels" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh s√°ch kh√°ch s·∫°n</h5>
                    <button class="btn btn-primary btn-sm" onclick="addHotel()">
                        <i class="fas fa-plus"></i> Th√™m kh√°ch s·∫°n
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="hotelsGrid">
                        <!-- Hotel cards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Danh s√°ch ng∆∞·ªùi d√πng</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table data-table mb-0">
                            <thead>
                                <tr>
                                    <th>Avatar</th>
                                    <th>T√™n</th>
                                    <th>Email</th>
                                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                                    <th>ƒê·ªãa ch·ªâ</th>
                                    <th>Ng√†y sinh</th>
                                    <th>Ng√†y tham gia</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tours Section -->
        <div id="tours" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh s√°ch tours</h5>
                    <button class="btn btn-primary btn-sm" onclick="addTour()">
                        <i class="fas fa-plus"></i> Th√™m tour
                    </button>
                </div>
                <div class="card-body">
                    <div class="accordion" id="toursAccordion">
                        <!-- Accordion for tour categories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Refunds Management Section -->
        <div id="refunds" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Qu·∫£n l√Ω ho√†n ti·ªÅn</h5>
                    <button class="btn btn-success btn-sm" onclick="loadRefunds()">
                        <i class="fas fa-sync-alt"></i> L√†m m·ªõi
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>Email</th>
                                    <th>D·ªãch v·ª•</th>
                                    <th>T·ªïng ti·ªÅn</th>
                                    <th>S·ªë ti·ªÅn ho√†n</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="refundsTable">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deals Management Section -->
        <div id="deals" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh s√°ch ∆Øu ƒë√£i</h5>
                    <button class="btn btn-primary btn-sm" onclick="addDeal()">
                        <i class="fas fa-plus"></i> Th√™m ∆∞u ƒë√£i
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ti√™u ƒë·ªÅ</th>
                                <th>Gi√° m·ªõi</th>
                                <th>Gi√° c≈©</th>
                                <th>Ng√†y k·∫øt th√∫c</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="dealsTableBody">
                            <!-- Deal rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


            <!-- Travel Guides Section -->
            <div id="travel-guides" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Danh s√°ch b√†i vi·∫øt</h5>
                        <button class="btn btn-primary btn-sm" onclick="addTravelGuide()">
                            <i class="fas fa-plus"></i> Th√™m b√†i vi·∫øt
                        </button>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>H√¨nh ·∫£nh</th>
                                    <th>Ti√™u ƒë·ªÅ</th>
                                    <th>T√°c gi·∫£</th>
                                    <th>Ng√†y ƒëƒÉng</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="travelGuidesTableBody">
                                <!-- Travel guide rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Contributions Section -->
        <div id="contributions" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>C·∫©m nang ch·ªù duy·ªát
                        <span id="contributions-count-badge" class="badge bg-warning ms-2">0</span>
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="filterContributions('all')">
                            <i class="fas fa-list"></i> T·∫•t c·∫£
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="filterContributions('pending')">
                            <i class="fas fa-clock"></i> Ch·ªù duy·ªát
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="filterContributions('approved')">
                            <i class="fas fa-check"></i> ƒê√£ duy·ªát
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="filterContributions('rejected')">
                            <i class="fas fa-times"></i> T·ª´ ch·ªëi
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="contributions-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch c·∫©m nang...</p>
                    </div>
                    
                    <div id="contributions-empty" class="text-center py-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Kh√¥ng c√≥ c·∫©m nang n√†o</h5>
                        <p class="text-muted">Ch∆∞a c√≥ c·∫©m nang n√†o ƒë∆∞·ª£c g·ª≠i t·ª´ members.</p>
                    </div>
                    
                    <div id="contributions-list">
                        <!-- Contributions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>


        <!-- Settings Section -->
        <div id="settings" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">C√†i ƒë·∫∑t h·ªá th·ªëng</h5>
                </div>
                <div class="card-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label class="form-label">T√™n website</label>
                                <input type="text" class="form-control" id="settingWebsiteName" value="LuxuryHavenTravel">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email li√™n h·ªá</label>
                                <input type="email" class="form-control" id="settingContactEmail" value="LuxuryHavenTravel@gmail.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="settingPhoneNumber" value="0837 918 274 - 0912 38 4956 ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <textarea class="form-control" id="settingAddress" rows="3">L·∫ßu 5, T√≤a nh√† ABC, 456 ƒê∆∞·ªùng L√™ Lai, Ph∆∞·ªùng B·∫øn Th√†nh, Qu·∫≠n 1, TP. H·ªì Ch√≠ Minh, Vi·ªát Nam</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                    </form>
                </div>
            </div>
        </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDuX4_RKARM7g0K3BvoZPS8ADxVgrYQKYc",
            authDomain: "websitedatphongkhachsan.firebaseapp.com",
            databaseURL: "https://websitedatphongkhachsan-default-rtdb.firebaseio.com",
            projectId: "websitedatphongkhachsan",
            storageBucket: "websitedatphongkhachsan.firebasestorage.app",
            messagingSenderId: "732884739524",
            appId: "1:732884739524:web:a9c34746f5704a9c3eb091",
            measurementId: "G-RC61EXTZH7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u c√°c th·ªÉ hi·ªán c·ªßa bi·ªÉu ƒë·ªì
        let revenueChartInstance, bookingTypeChartInstance, newUsersChartInstance, locationChartInstance;
        // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu g·ªëc
        let allBookings = [], allUsers = [], allHotels = [], allTours = [], allDeals = [], allTravelGuides = [];
        let miniRevenueChartInstance;

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p v√† quy·ªÅn admin/nh√¢n vi√™n
        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }
                // Cho ph√©p c·∫£ admin v√† nh√¢n vi√™n truy c·∫≠p dashboard
                const isAdmin = user.email === 'quantrikhachsan@gmail.com';
                const isStaff = user.email === 'nhanvien2@luxuryhaven.com';
                if (!isAdmin && !isStaff) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Truy c·∫≠p b·ªã t·ª´ ch·ªëi',
                        text: 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y'
                    }).then(() => {
                        auth.signOut();
                        window.location.href = 'index.html';
                    });
                    return;
                }
                // Ph√¢n quy·ªÅn giao di·ªán
                if (isStaff) {
                    // Sidebar
                    const dealsNav = document.querySelector('a[href="#deals"]');
                    const guidesNav = document.querySelector('a[href="#travel-guides"]');
                    const settingsNav = document.querySelector('a[href="#settings"]');
                    if (dealsNav) dealsNav.style.display = 'none';
                    if (guidesNav) guidesNav.style.display = 'none';
                    if (settingsNav) settingsNav.style.display = 'none';
                    // Main content sections
                    const dealsSection = document.getElementById('deals');
                    const guidesSection = document.getElementById('travel-guides');
                    const settingsSection = document.getElementById('settings');
                    if (dealsSection) dealsSection.style.display = 'none';
                    if (guidesSection) guidesSection.style.display = 'none';
                    if (settingsSection) settingsSection.style.display = 'none';
                    // ·∫®n notification bell
                    const notifBell = document.getElementById('notificationBell');
                    if (notifBell) notifBell.style.display = 'none';
                }
            });
        }

        // ƒêƒÉng xu·∫•t
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
            });
        }

        // Load statistics
        function loadStatistics() {
            // Load total hotels
            db.ref('location').once('value').then((snapshot) => {
                let totalHotels = 0;
                snapshot.forEach((locationSnapshot) => {
                    totalHotels += locationSnapshot.child('hotels').numChildren();
                });
                document.getElementById('totalHotels').textContent = totalHotels;
            });

            // Load today's bookings (bookings CREATED today)
            const startOfDay = new Date();
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date();
            endOfDay.setHours(23, 59, 59, 999);

            db.ref('bookings')
                .orderByChild('createdAt')
                .startAt(startOfDay.getTime())
                .endAt(endOfDay.getTime())
                .once('value')
                .then((snapshot) => {
                document.getElementById('todayBookings').textContent = snapshot.numChildren();
            });

            // Load total users
            db.ref('users').on('value', (snapshot) => {
                document.getElementById('totalUsers').textContent = snapshot.numChildren();
            });

            // Load active deals
            db.ref('specialOffers').once('value').then((snapshot) => {
                document.getElementById('activeDeals').textContent = snapshot.numChildren();
            });

            // Load chart data v·ªõi delay ƒë·ªÉ tr√°nh conflict
            try {
                setTimeout(() => loadRevenueChart(), 100);
                setTimeout(() => loadBookingTypeChart(), 200);
                setTimeout(() => loadNewUsersChart(), 300);
                setTimeout(() => loadLocationChart(), 400);
            } catch (error) {
                console.error('L·ªói khi load charts:', error);
            }
        }

        // Load bookings data
        function loadBookings() {
            const bookingsRef = db.ref('bookings');
            bookingsRef.on('value', (snapshot) => {
                allBookings = [];
                snapshot.forEach((childSnapshot) => {
                    const booking = childSnapshot.val();
                    booking.id = childSnapshot.key;
                    allBookings.push(booking);
                });
                allBookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort by most recent
                filterAndDisplayBookings(); 
            }, (error) => {
                console.error("Error loading bookings:", error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·∫∑t ph√≤ng.', 'error');
            });
        }
        
        function filterAndDisplayBookings() {
            let filteredBookings = [...allBookings];
            const searchContainer = document.getElementById('headerSearchContainer');

            if (searchContainer && searchContainer.style.display !== 'none') {
                 // 1. Search term filter
                const searchTerm = document.getElementById('globalSearchInput').value.toLowerCase().trim();
                if (searchTerm) {
                    filteredBookings = filteredBookings.filter(b => 
                        (b.id && b.id.toLowerCase().includes(searchTerm)) ||
                        (b.customerName && b.customerName.toLowerCase().includes(searchTerm)) ||
                        (b.customerEmail && b.customerEmail.toLowerCase().includes(searchTerm)) ||
                        (b.customerPhone && b.customerPhone.includes(searchTerm))
                    );
                }
            }

            // 2. Status filter
            const statusFilter = document.getElementById('bookingStatusFilter').value;
            if (statusFilter !== 'all') {
                filteredBookings = filteredBookings.filter(b => b.status === statusFilter);
            }

            // L·ªçc ch·ªâ booking kh√°ch s·∫°n, lo·∫°i b·ªè ho√†n to√†n booking tour
            filteredBookings = filteredBookings.filter(b => (!b.type && !b.bookingType) || b.type === 'hotel' || b.bookingType === 'hotel');
            
            renderBookingsTable(filteredBookings);
        }

        function renderBookingsTable(bookings) {
            const tableBody = document.getElementById('bookingsTable');
            tableBody.innerHTML = '';
            if (bookings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" class="text-center py-5">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</td></tr>';
                return;
            }
            bookings.forEach(booking => {
                const row = document.createElement('tr');
                // Status Badge
                const statusBadge = `<span class="status status-${booking.status || 'pending'}">${booking.status || 'Ch·ªù x√°c nh·∫≠n'}</span>`;
                // Service Details
                let serviceDetails = '';
                if (booking.type === 'hotel' || booking.roomId || booking.roomName) {
                    serviceDetails = `
                        <strong title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</strong><br>
                        <small class="text-muted" title="${booking.roomId || booking.roomName || ''}">${booking.roomId || booking.roomName || 'N/A'}</small>
                    `;
                } else if (booking.type === 'tour') {
                    serviceDetails = `
                        <strong title="${booking.tourName || ''}">${booking.tourName || 'Tour'}</strong><br>
                        <small class="text-muted">Tour</small>
                    `;
                } else {
                    serviceDetails = 'Kh√¥ng x√°c ƒë·ªãnh';
                }
                row.innerHTML = `
                    <td title="${booking.id}">${booking.id}</td>
                    <td title="${booking.customerName || ''}">${booking.customerName || 'N/A'}</td>
                    <td title="${booking.customerEmail || ''}">${booking.customerEmail || 'N/A'}</td>
                    <td title="${booking.customerPhone || ''}">${booking.customerPhone || 'N/A'}</td>
                    <td title="${booking.hotelName || ''}">${booking.hotelName || 'N/A'}</td>
                    <td>${serviceDetails}</td>
                    <td title="${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : ''}">${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td title="${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : ''}">${booking.checkOut ? new Date(booking.checkOut).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td title="${booking.guests || ''}">${booking.guests || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editBooking('${booking.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load users data
        function loadUsers() {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '<tr><td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('users').on('value', (snapshot) => {
                allUsers = []; // Reset
                if (snapshot.exists()) {
                    snapshot.forEach((userSnapshot) => {
                        const user = userSnapshot.val();
                        user.id = userSnapshot.key;
                        allUsers.push(user);
                    });
                }
                // Initial render after loading.
                filterAndDisplayUsers();
            }, (error) => {
                console.error('Error loading users:', error);
                usersTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
            });
        }
        
        function renderUsersTable(users) {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = '';

            if (users.length === 0) {
                usersTable.innerHTML = '<tr><td colspan="8" class="text-center py-5">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ph√π h·ª£p.</td></tr>';
                return;
            }

            // Debug log ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
            console.log('Rendering users:', users);

            users.forEach(user => {
                const avatar = user.avatar ? `<img src="${user.avatar}" alt="avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : '<span class="avatar-placeholder"><i class="fas fa-user"></i></span>';
                const birthday = user.birthday || user.birthdate || '';
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : (user.updatedAt ? new Date(user.updatedAt).toLocaleDateString('vi-VN') : 'N/A');
                const memberLevel = user.memberLevel || 'ƒê·ªìng';
                const loyaltyPoints = user.loyaltyPoints || 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${avatar}</td>
                    <td>
                        <strong>${user.name || 'N/A'}</strong><br>
                        <small class="text-muted">${memberLevel} - ${loyaltyPoints} ƒëi·ªÉm</small>
                    </td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone || 'N/A'}</td>
                    <td>${user.address || 'N/A'}</td>
                    <td>${birthday}</td>
                    <td>${createdAt}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewUser('${user.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                usersTable.appendChild(row);
            });
        }
        
        function filterAndDisplayUsers() {
            let filteredUsers = [...allUsers];
            const searchTerm = document.getElementById('globalSearchInput').value.toLowerCase().trim();

            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u =>
                    (u.name && u.name.toLowerCase().includes(searchTerm)) ||
                    (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                    (u.phone && u.phone.includes(searchTerm))
                );
            }
            
            renderUsersTable(filteredUsers);
        }

        // Load hotels data
        function loadHotels() {
            const hotelsGrid = document.getElementById('hotelsGrid');
            hotelsGrid.innerHTML = '<div class="col-12 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            db.ref('location').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    hotelsGrid.innerHTML = '<div class="col-12 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
                    return;
                }

                hotelsGrid.innerHTML = '';
                snapshot.forEach((locationSnapshot) => {
                    const hotels = locationSnapshot.child('hotels').val();
                    if (!hotels) return;

                    Object.entries(hotels).forEach(([hotelId, hotel]) => {
                        const hotelCard = document.createElement('div');
                        hotelCard.className = 'col-md-4 mb-4';
                        hotelCard.innerHTML = `
                            <div class="card h-100">
                                <img src="${hotel.chiTiet.image || 'images/default-hotel.jpg'}" class="card-img-top" alt="${hotel.tenKhachSan}">
                                <div class="card-body">
                                    <h5 class="card-title">${hotel.tenKhachSan}</h5>
                                    <p class="card-text">${(hotel.moTa || '').substring(0, 100)}...</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">${hotel.xepHangSao} sao</span>
                                        <div>
                                            <button class="btn btn-action btn-view" onclick="viewHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-action btn-edit" onclick="editHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-action btn-delete" onclick="deleteHotel('${locationSnapshot.key}', '${hotelId}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        hotelsGrid.appendChild(hotelCard);
                    });
                });
            }).catch(error => {
                console.error('Error loading hotels:', error);
                hotelsGrid.innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            });
        }

        // Load tours data
        function loadTours() {
            const toursAccordion = document.getElementById('toursAccordion');
            toursAccordion.innerHTML = '<div class="col-12 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            const tourCategoryNames = {
                amThucVaVanHoa: '·∫®m th·ª±c v√† VƒÉn h√≥a',
                hoatDongGanBan: 'Ho·∫°t ƒë·ªông g·∫ßn b·∫°n',
                traiNghiemDiaPhuong: 'Tr·∫£i nghi·ªám ƒë·ªãa ph∆∞∆°ng'
            };

            db.ref('specialTours').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    toursAccordion.innerHTML = '<div class="col-12 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
                    return;
                }

                toursAccordion.innerHTML = '';
                const allToursData = snapshot.val();

                Object.keys(tourCategoryNames).forEach((categoryKey, index) => {
                    const categoryName = tourCategoryNames[categoryKey];
                    const toursInCategory = allToursData[categoryKey];

                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';

                    let tourCardsHtml = '<div class="row">';
                    if (toursInCategory && typeof toursInCategory === 'object') {
                        Object.entries(toursInCategory).forEach(([tourId, tourData]) => {
                            tourCardsHtml += `
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100">
                                        <img src="${tourData.image || 'images/default-tour.jpg'}" class="card-img-top" alt="${tourData.name}">
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title">${tourData.name}</h5>
                                            <p class="card-text flex-grow-1">${(tourData.description || '').substring(0, 80)}...</p>
                                            <p class="tour-price mb-2"><b>Gi√°:</b> ${tourData.price ? tourData.price.toLocaleString('vi-VN') + ' ƒë' : 'Ch∆∞a c√≥'}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-primary">${tourData.duration}</span>
                                                <div>
                                                    <button class="btn btn-action btn-view" onclick="viewTour('${categoryKey}', '${tourId}')"><i class="fas fa-eye"></i></button>
                                                    <button class="btn btn-action btn-edit" onclick="editTour('${categoryKey}', '${tourId}')"><i class="fas fa-edit"></i></button>
                                                    <button class="btn btn-action btn-delete" onclick="deleteTour('${categoryKey}', '${tourId}')"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        tourCardsHtml += '<p class="text-muted col-12">Ch∆∞a c√≥ tour n√†o trong danh m·ª•c n√†y.</p>';
                    }
                    tourCardsHtml += '</div>'; // Close .row

                    accordionItem.innerHTML = `
                        <h2 class="accordion-header" id="heading-${categoryKey}">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${categoryKey}" aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse-${categoryKey}">
                                ${categoryName}
                            </button>
                        </h2>
                        <div id="collapse-${categoryKey}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading-${categoryKey}" data-bs-parent="#toursAccordion">
                            <div class="accordion-body">
                                ${tourCardsHtml}
                            </div>
                        </div>
                    `;

                    toursAccordion.appendChild(accordionItem);
                });

            }).catch(error => {
                console.error('Error loading tours:', error);
                toursAccordion.innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            });
        }

        // === VOUCHERS CRUD ===
        function loadVouchers() {
            const vouchersGrid = document.getElementById('vouchersGrid');
            vouchersGrid.innerHTML = '<div class="col-12 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            db.ref('vouchers').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    vouchersGrid.innerHTML = '<div class="col-12 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
                    return;
                }

                vouchersGrid.innerHTML = '';
                snapshot.forEach((voucherSnapshot) => {
                    const voucher = voucherSnapshot.val();
                    const voucherId = voucherSnapshot.key;
                    const voucherCard = document.createElement('div');
                    voucherCard.className = 'col-md-4 mb-4';
                    voucherCard.innerHTML = `
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${voucher.title || 'Voucher'}</h5>
                                <p class="card-text">${voucher.description || ''}</p>
                                <div>
                                    <span class="badge bg-success">${voucher.code || ''}</span>
                                    <span class="badge bg-info">${voucher.discount ? voucher.discount + '%' : ''}</span>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-action btn-edit" onclick="editVoucher('${voucherId}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-action btn-delete" onclick="deleteVoucher('${voucherId}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    vouchersGrid.appendChild(voucherCard);
                });
            }).catch(error => {
                vouchersGrid.innerHTML = '<div class="col-12 text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            });
        }

        function addVoucher() {
            Swal.fire({
                title: 'Th√™m voucher m·ªõi',
                html: `
                    <form id="addVoucherForm" class="text-start">
                        <div class="mb-3">
                            <label class="form-label">Ti√™u ƒë·ªÅ</label>
                            <input type="text" class="form-control" id="addVoucherTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√£ voucher</label>
                            <input type="text" class="form-control" id="addVoucherCode" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gi·∫£m gi√° (%)</label>
                            <input type="number" class="form-control" id="addVoucherDiscount" min="1" max="100" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√¥ t·∫£</label>
                            <textarea class="form-control" id="addVoucherDesc"></textarea>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const form = document.getElementById('addVoucherForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    return {
                        title: document.getElementById('addVoucherTitle').value,
                        code: document.getElementById('addVoucherCode').value,
                        discount: parseInt(document.getElementById('addVoucherDiscount').value, 10),
                        description: document.getElementById('addVoucherDesc').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newVoucher = result.value;
                    db.ref('vouchers').push(newVoucher).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Th√†nh c√¥ng!',
                            text: 'Voucher m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.',
                            timer: 1500
                        });
                        loadVouchers();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói!',
                            text: 'Kh√¥ng th·ªÉ th√™m voucher: ' + error.message
                        });
                    });
                }
            });
        }

        function editVoucher(voucherId) {
            db.ref('vouchers/' + voucherId).once('value').then((snapshot) => {
                const voucher = snapshot.val();
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a voucher',
                    html: `
                        <form id="editVoucherForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">Ti√™u ƒë·ªÅ</label>
                                <input type="text" class="form-control" id="editVoucherTitle" value="${voucher.title || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√£ voucher</label>
                                <input type="text" class="form-control" id="editVoucherCode" value="${voucher.code || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Gi·∫£m gi√° (%)</label>
                                <input type="number" class="form-control" id="editVoucherDiscount" value="${voucher.discount || ''}" min="1" max="100" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="editVoucherDesc">${voucher.description || ''}</textarea>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('editVoucherForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            title: document.getElementById('editVoucherTitle').value,
                            code: document.getElementById('editVoucherCode').value,
                            discount: parseInt(document.getElementById('editVoucherDiscount').value, 10),
                            description: document.getElementById('editVoucherDesc').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedVoucher = result.value;
                        db.ref('vouchers/' + voucherId).update(updatedVoucher).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Voucher ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                            loadVouchers();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t voucher: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteVoucher(voucherId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('vouchers/' + voucherId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'Voucher ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        loadVouchers();
                    });
                }
            });
        }

        // View booking details
        function viewBooking(bookingId) {
            db.ref('bookings/' + bookingId).once('value').then((snapshot) => {
                const booking = snapshot.val();
                Swal.fire({
                    title: 'Chi ti·∫øt ƒë·∫∑t ph√≤ng',
                    html: `
                        <div class="text-start">
                            <p><strong>Kh√°ch h√†ng:</strong> ${booking.name}</p>
                            <p><strong>Email:</strong> ${booking.email}</p>
                            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${booking.phone}</p>
                            <p><strong>Kh√°ch s·∫°n:</strong> ${booking.hotelId}</p>
                            <p><strong>Ph√≤ng:</strong> ${booking.roomId}</p>
                            <p><strong>Check-in:</strong> ${booking.checkIn}</p>
                            <p><strong>Check-out:</strong> ${booking.checkOut}</p>
                            <p><strong>S·ªë kh√°ch:</strong> ${booking.guests}</p>
                        </div>
                    `,
                    width: '600px'
                });
            });
        }

        // Edit booking
        function editBooking(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ƒë·∫∑t ph√≤ng n√†y.', 'error');
                return;
            }
            // Danh s√°ch c√°c tr∆∞·ªùng h·ª£p l·ªá theo rule
            const allowedFields = [
                'bookingType', 'checkIn', 'checkOut', 'createdAt', 'customerEmail', 'customerName', 'customerPhone', 'email',
                'guests', 'hotelId', 'hotelName', 'nights', 'note', 'paymentMethod', 'paymentStatus', 'roomId', 'roomName',
                'roomPrice', 'status', 'totalPrice', 'updatedAt', 'userId',
                // C√°c tr∆∞·ªùng cho tour
                'numberOfGuests', 'tourId', 'tourName', 'tourCategory', 'tourLocation', 'tourDuration', 'tourImage', 'tourType',
                'tourPrice', 'tourDescription', 'tourIncludes', 'tourExcludes', 'tourRating', 'tourReviewsCount'
            ];
            // N·∫øu l√† booking tour
            if (booking.type === 'tour' || booking.bookingType === 'tour') {
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin ƒë·∫∑t tour',
                    html: `
                        <input id="edit-tourName" class="swal2-input" placeholder="T√™n tour" value="${booking.tourName || ''}">
                        <input id="edit-tourLocation" class="swal2-input" placeholder="ƒêi·ªÉm ƒë·∫øn" value="${booking.tourLocation || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="${booking.numberOfGuests || booking.guests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${booking.customerPhone || ''}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        return {
                            tourName: document.getElementById('edit-tourName').value,
                            tourLocation: document.getElementById('edit-tourLocation').value,
                            checkIn: document.getElementById('edit-checkIn').value,
                            numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value),
                            customerName: document.getElementById('edit-customerName').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // L·ªçc d·ªØ li·ªáu c≈© ch·ªâ l·∫•y c√°c tr∆∞·ªùng h·ª£p l·ªá
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // G·ªôp v·ªõi d·ªØ li·ªáu m·ªõi
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('D·ªØ li·ªáu g·ª≠i l√™n Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                            loadBookingsTours();
                            loadBookings(); // ƒê·ªÉ ƒë·ªìng b·ªô n·∫øu c√≥ thay ƒë·ªïi
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        });
                    }
                });
            } else {
                // Booking kh√°ch s·∫°n gi·ªØ nh∆∞ c≈©
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin ƒë·∫∑t ph√≤ng',
                    html: `
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerEmail" class="swal2-input" placeholder="Email" value="${booking.customerEmail || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${booking.customerPhone || ''}">
                        <input id="edit-hotelName" class="swal2-input" placeholder="Kh√°ch s·∫°n" value="${booking.hotelName || ''}">
                        <input id="edit-roomId" class="swal2-input" placeholder="Ph√≤ng" value="${booking.roomId || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-checkOut" class="swal2-input" type="date" value="${booking.checkOut ? booking.checkOut.split('T')[0] : ''}">
                        <input id="edit-guests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="${booking.guests || 1}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const roomIdValue = document.getElementById('edit-roomId').value;
                        return {
                            customerName: document.getElementById('edit-customerName').value,
                            customerEmail: document.getElementById('edit-customerEmail').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            hotelName: document.getElementById('edit-hotelName').value,
                            roomId: roomIdValue,
                            roomName: roomIdValue,
                            checkIn: document.getElementById('edit-checkIn').value,
                            checkOut: document.getElementById('edit-checkOut').value,
                            guests: parseInt(document.getElementById('edit-guests').value),
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // L·ªçc d·ªØ li·ªáu c≈© ch·ªâ l·∫•y c√°c tr∆∞·ªùng h·ª£p l·ªá
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // G·ªôp v·ªõi d·ªØ li·ªáu m·ªõi
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('D·ªØ li·ªáu g·ª≠i l√™n Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        });
                    }
                });
            }
        }

        // Delete booking
        function deleteBooking(bookingId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: "B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('bookings/' + bookingId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'ƒê·∫∑t ph√≤ng ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        generateNotification('fas fa-trash', 'bg-danger', `ƒê√£ x√≥a ƒë·∫∑t ph√≤ng #${bookingId.substring(0, 6)}...`);
                        loadBookings();
                    });
                }
            });
        }

        // Revenue Chart
        function loadRevenueChart() {
            try {
                // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                    revenueChartInstance = null;
                }

                const canvas = document.getElementById('revenueChart');
                if (!canvas) {
                    console.warn('Canvas revenueChart kh√¥ng t·ªìn t·∫°i');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas revenueChart');
                    return;
                }

                db.ref('bookings').once('value').then(snapshot => {
                    const monthlyRevenue = Array(12).fill(0);
                    const monthLabels = [];
                    const now = new Date();

                    for (let i = 11; i >= 0; i--) {
                        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        monthLabels.push(`T${d.getMonth() + 1}/${d.getFullYear().toString().slice(-2)}`);
                    }

                    if (snapshot.exists()) {
                        snapshot.forEach(bookingSnapshot => {
                            const booking = bookingSnapshot.val();
                            // S·ª≠a logic: T√≠nh doanh thu cho c·∫£ ƒë∆°n "confirmed" v√† "completed"
                            if ((booking.status === 'completed' || booking.status === 'confirmed') && typeof booking.totalPrice === 'number' && booking.createdAt) {
                                const date = new Date(booking.createdAt);
                                const monthDiff = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());
                                if (monthDiff >= 0 && monthDiff < 12) {
                                    monthlyRevenue[11 - monthDiff] += booking.totalPrice;
                                }
                            }
                        });
                    }
                    const revenueInMillions = monthlyRevenue.map(r => (r / 1000000).toFixed(2));

                    // Ki·ªÉm tra l·∫°i canvas tr∆∞·ªõc khi t·∫°o chart m·ªõi
                    if (canvas && !revenueChartInstance) {
                        revenueChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: monthLabels,
                                datasets: [{
                                    label: 'Doanh thu (tri·ªáu VNƒê)',
                                    data: revenueInMillions,
                                    borderColor: '#1a237e',
                                    backgroundColor: 'rgba(26, 35, 126, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Doanh thu theo th√°ng (12 th√°ng g·∫ßn nh·∫•t)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function (value) {
                                                return value + 'tr';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('L·ªói khi load revenue chart:', error);
                });
            } catch (error) {
                console.error('L·ªói trong loadRevenueChart:', error);
            }
        }

        // Booking Type Chart
        function loadBookingTypeChart() {
            try {
                // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
                if (bookingTypeChartInstance) {
                    bookingTypeChartInstance.destroy();
                    bookingTypeChartInstance = null;
                }

                const canvas = document.getElementById('bookingTypeChart');
                if (!canvas) {
                    console.warn('Canvas bookingTypeChart kh√¥ng t·ªìn t·∫°i');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas bookingTypeChart');
                    return;
                }

                db.ref('bookings').once('value').then(snapshot => {
                    let hotelCount = 0;
                    let tourCount = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach(bookingSnapshot => {
                            const booking = bookingSnapshot.val();
                            if (booking.bookingType === 'hotel') {
                                hotelCount++;
                            } else if (booking.bookingType === 'tour') {
                                tourCount++;
                            }
                        });
                    }

                    // Ki·ªÉm tra l·∫°i canvas tr∆∞·ªõc khi t·∫°o chart m·ªõi
                    if (canvas && !bookingTypeChartInstance) {
                        bookingTypeChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['ƒê·∫∑t ph√≤ng kh√°ch s·∫°n', 'ƒê·∫∑t tour'],
                                datasets: [{
                                    data: [hotelCount, tourCount],
                                    backgroundColor: [
                                        '#1a237e',
                                        '#1976d2'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'T·ª∑ l·ªá lo·∫°i h√¨nh ƒë·∫∑t ph√≤ng'
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('L·ªói khi load booking type chart:', error);
                });
            } catch (error) {
                console.error('L·ªói trong loadBookingTypeChart:', error);
            }
        }

        // New Users Chart
        function loadNewUsersChart() {
            try {
                // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
                if (newUsersChartInstance) {
                    newUsersChartInstance.destroy();
                    newUsersChartInstance = null;
                }

                const canvas = document.getElementById('newUsersChart');
                if (!canvas) {
                    console.warn('Canvas newUsersChart kh√¥ng t·ªìn t·∫°i');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas newUsersChart');
                    return;
                }

                const weekLabels = ['6 tu·∫ßn tr∆∞·ªõc', '5 tu·∫ßn tr∆∞·ªõc', '4 tu·∫ßn tr∆∞·ªõc', '3 tu·∫ßn tr∆∞·ªõc', '2 tu·∫ßn tr∆∞·ªõc', 'Tu·∫ßn tr∆∞·ªõc', 'Tu·∫ßn n√†y'];
                const weeklyNewUsers = Array(7).fill(0);
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

                db.ref('users').orderByChild('createdAt').startAt(todayStart - 6 * 7 * 24 * 3600 * 1000).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(userSnapshot => {
                            const user = userSnapshot.val();
                            if (user.createdAt) {
                                const joinDate = new Date(user.createdAt);
                                const weeksAgo = Math.floor((todayStart - joinDate.getTime()) / (7 * 24 * 3600 * 1000));
                                if (weeksAgo >= 0 && weeksAgo < 7) {
                                    weeklyNewUsers[6 - weeksAgo]++;
                                }
                            }
                        });
                    }

                    // Ki·ªÉm tra l·∫°i canvas tr∆∞·ªõc khi t·∫°o chart m·ªõi
                    if (canvas && !newUsersChartInstance) {
                        newUsersChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: weekLabels,
                                datasets: [{
                                    label: 'Ng∆∞·ªùi d√πng m·ªõi',
                                    data: weeklyNewUsers,
                                    backgroundColor: '#2e7d32'
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false,
                                    },
                                    title: {
                                        display: true,
                                        text: 'Ng∆∞·ªùi d√πng m·ªõi (7 tu·∫ßn g·∫ßn nh·∫•t)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('L·ªói khi load new users chart:', error);
                });
            } catch (error) {
                console.error('L·ªói trong loadNewUsersChart:', error);
            }
        }

        // Location Chart (Number of hotels per location)
        function loadLocationChart() {
            try {
                // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
                if (locationChartInstance) {
                    locationChartInstance.destroy();
                    locationChartInstance = null;
                }

                const canvas = document.getElementById('locationChart');
                if (!canvas) {
                    console.warn('Canvas locationChart kh√¥ng t·ªìn t·∫°i');
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.warn('Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas');
                    return;
                }

                db.ref('location').once('value').then(snapshot => {
                    const locationLabels = [];
                    const hotelCounts = [];
                    // B·∫£ng m√†u m·ªõi, c√≥ ƒë·ªô t∆∞∆°ng ph·∫£n cao ƒë·ªÉ d·ªÖ ph√¢n bi·ªát
                    const backgroundColors = [
                        '#3366CC', '#DC3912', '#FF9900', '#109618', '#990099',
                        '#0099C6', '#DD4477', '#66AA00', '#B82E2E', '#316395'
                    ];
                    let colorIndex = 0;

                    if (snapshot.exists()) {
                        snapshot.forEach(locationSnapshot => {
                            const locationKey = locationSnapshot.key;
                            const locationName = locationKey.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                            const hotels = locationSnapshot.child('hotels').val();
                            const count = hotels ? Object.keys(hotels).length : 0;
                            if (count > 0) {
                                locationLabels.push(locationName);
                                hotelCounts.push(count);
                            }
                        });
                    }

                    // Ki·ªÉm tra l·∫°i canvas tr∆∞·ªõc khi t·∫°o chart m·ªõi
                    if (canvas && !locationChartInstance) {
                        locationChartInstance = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: locationLabels,
                                datasets: [{
                                    data: hotelCounts,
                                    backgroundColor: locationLabels.map(() => backgroundColors[colorIndex++ % backgroundColors.length])
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: 'Ph√¢n b·ªï kh√°ch s·∫°n theo khu v·ª±c'
                                    }
                                }
                            }
                        });
                    }
                }).catch(error => {
                    console.error('L·ªói khi load location chart:', error);
                });
            } catch (error) {
                console.error('L·ªói trong loadLocationChart:', error);
            }
        }

        // Th√™m ƒë·∫∑t ph√≤ng m·ªõi
        function addBooking() {
            // L·∫•y danh s√°ch kh√°ch s·∫°n
            db.ref('location').once('value').then(snapshot => {
                let hotelOptions = '';
                let hotelsData = [];
                snapshot.forEach(locationSnap => {
                    const location = locationSnap.val();
                    if (location.hotels) {
                        Object.entries(location.hotels).forEach(([hotelKey, hotel]) => {
                            hotelsData.push({
                                id: hotelKey,
                                name: hotel.tenKhachSan,
                                rooms: hotel.chiTiet && hotel.chiTiet.rooms ? hotel.chiTiet.rooms : [],
                                locationId: locationSnap.key
                            });
                            hotelOptions += `<option value="${locationSnap.key}__${hotelKey}">${hotel.tenKhachSan}</option>`;
                        });
                    }
                });
                Swal.fire({
                    title: 'Th√™m ƒë·∫∑t ph√≤ng m·ªõi',
                    html: `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <input id="add-customerName" class="swal2-input" placeholder="T√™n kh√°ch">
                            <input id="add-customerEmail" class="swal2-input" placeholder="Email">
                            <input id="add-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                            <select id="add-hotelSelect" class="swal2-input" style="width: 100%"><option value="">Ch·ªçn kh√°ch s·∫°n</option>${hotelOptions}</select>
                            <select id="add-roomSelect" class="swal2-input" style="width: 100%" disabled><option value="">Ch·ªçn ph√≤ng</option></select>
                            <input id="add-checkIn" class="swal2-input" type="date">
                            <input id="add-checkOut" class="swal2-input" type="date">
                            <input id="add-guests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="1">
                            <select id="add-status" class="swal2-input" style="width: 100%">
                                <option value="pending">Ch·ªù x√°c nh·∫≠n</option>
                                <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                                <option value="cancelled">ƒê√£ h·ªßy</option>
                                <option value="completed">Ho√†n th√†nh</option>
                            </select>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    didOpen: () => {
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const roomSelect = document.getElementById('add-roomSelect');
                        hotelSelect.addEventListener('change', function() {
                            const value = this.value;
                            roomSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng</option>';
                            roomSelect.disabled = true;
                            if (!value) return;
                            const [locationId, hotelKey] = value.split('__');
                            const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                            if (hotel && Array.isArray(hotel.rooms)) {
                                hotel.rooms.forEach(room => {
                                    if (room && room.name) {
                                        const option = document.createElement('option');
                                        option.value = room.name;
                                        option.textContent = room.name;
                                        roomSelect.appendChild(option);
                                    }
                                });
                                roomSelect.disabled = false;
                            }
                        });
                    },
                    preConfirm: () => {
                        const hotelSelect = document.getElementById('add-hotelSelect');
                        const roomSelect = document.getElementById('add-roomSelect');
                        const hotelValue = hotelSelect.value;
                        const [locationId, hotelKey] = hotelValue.split('__');
                        const hotel = hotelsData.find(h => h.id === hotelKey && h.locationId === locationId);
                        return {
                            userId: 'admin-created', // Admin t·∫°o booking cho kh√°ch
                            customerName: document.getElementById('add-customerName').value,
                            customerEmail: document.getElementById('add-customerEmail').value,
                            customerPhone: document.getElementById('add-customerPhone').value,
                            hotelName: hotel ? hotel.name : '',
                            roomId: roomSelect.value,
                            roomName: roomSelect.value,
                            checkIn: document.getElementById('add-checkIn').value,
                            checkOut: document.getElementById('add-checkOut').value,
                            guests: parseInt(document.getElementById('add-guests').value),
                            status: document.getElementById('add-status').value,
                            type: 'hotel',
                            bookingType: 'hotel',
                            createdAt: new Date().toISOString()
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        db.ref('bookings').push(result.value).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m ƒë·∫∑t ph√≤ng m·ªõi!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ th√™m ƒë·∫∑t ph√≤ng.', 'error');
                        });
                    }
                });
            });
        }

        // Load danh s√°ch kh√°ch s·∫°n v√† ph√≤ng
        function loadHotelsAndRooms() {
            const hotelSelect = document.getElementById('newHotelId');
            const roomSelect = document.getElementById('newRoomId');
            if (!hotelSelect || !roomSelect) return;

            db.ref('location').once('value').then((snapshot) => {
                hotelSelect.innerHTML = '<option value="">Ch·ªçn kh√°ch s·∫°n</option>';
                snapshot.forEach((locationSnapshot) => {
                    const location = locationSnapshot.val();
                    location.hotels.forEach((hotel, index) => {
                        const option = document.createElement('option');
                        option.value = `${locationSnapshot.key}_${index}`;
                        option.textContent = hotel.tenKhachSan;
                        hotelSelect.appendChild(option);
                    });
                });
            });

            // C·∫≠p nh·∫≠t danh s√°ch ph√≤ng khi ch·ªçn kh√°ch s·∫°n
            hotelSelect.addEventListener('change', (e) => {
                const [locationId, hotelIndex] = e.target.value.split('_');
                if (!locationId || !hotelIndex) {
                    roomSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng</option>';
                    return;
                }

                db.ref(`location/${locationId}/hotels/${hotelIndex}/chiTiet/rooms`).once('value').then((snapshot) => {
                    roomSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng</option>';
                    const rooms = snapshot.val();
                    console.log('Rooms data:', rooms); // Th√™m d√≤ng n√†y ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu

                    let found = false;
                    if (Array.isArray(rooms)) {
                        rooms.forEach((room, idx) => {
                            if (room) {
                                found = true;
                                const option = document.createElement('option');
                                option.value = idx;
                                option.textContent = `${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}ƒë`;
                                roomSelect.appendChild(option);
                            }
                        });
                    } else if (rooms && typeof rooms === 'object') {
                        Object.entries(rooms).forEach(([key, room]) => {
                            if (room) {
                                found = true;
                                const option = document.createElement('option');
                                option.value = key;
                                option.textContent = `${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}ƒë`;
                                roomSelect.appendChild(option);
                            }
                        });
                    }
                    if (!found) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Kh√¥ng c√≥ ph√≤ng n√†o';
                        roomSelect.appendChild(option);
                    }
                });
            });
        }

        // H√†m helper ƒë·ªÉ l·∫•y class cho badge tr·∫°ng th√°i
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning';
                case 'confirmed': return 'bg-success';
                case 'cancelled': return 'bg-danger';
                case 'completed': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        // H√†m helper ƒë·ªÉ l·∫•y text tr·∫°ng th√°i
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'Ch·ªù x√°c nh·∫≠n';
                case 'confirmed': return 'ƒê√£ x√°c nh·∫≠n';
                case 'cancelled': return 'ƒê√£ h·ªßy';
                case 'completed': return 'Ho√†n th√†nh';
                default: return 'Kh√¥ng x√°c ƒë·ªãnh';
            }
        }

        function handleGlobalSearch() {
            const activeSection = document.querySelector('.content-section:not([style*="display: none"])');
            if (!activeSection) return;

            const sectionId = activeSection.id;
            switch (sectionId) {
                case 'bookings':
                    filterAndDisplayBookings();
                    break;
                case 'users':
                    filterAndDisplayUsers();
                    break;
                // Add cases for other sections here in the future
                // case 'hotels':
                //     filterAndDisplayHotels();
                //     break;
            }
        }

        // Destroy all charts
        function destroyAllCharts() {
            try {
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                    revenueChartInstance = null;
                }
                if (bookingTypeChartInstance) {
                    bookingTypeChartInstance.destroy();
                    bookingTypeChartInstance = null;
                }
                if (newUsersChartInstance) {
                    newUsersChartInstance.destroy();
                    newUsersChartInstance = null;
                }
                if (locationChartInstance) {
                    locationChartInstance.destroy();
                    locationChartInstance = null;
                }
            } catch (error) {
                console.error('L·ªói khi destroy charts:', error);
            }
        }

        // Update showContent function to load data when switching sections
        function showContent(contentId) {
            // Destroy all charts before switching sections
            destroyAllCharts();
            
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected content
            document.getElementById(contentId).style.display = 'block';

            // Update active menu item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[href="#${contentId}"]`).classList.add('active');

            // Update page title
            const pageTitle = document.querySelector(`[href="#${contentId}"]`).textContent.trim();
            document.getElementById('page-title-header').textContent = pageTitle;


            // Handle search bar visibility and placeholder
            const searchContainer = document.getElementById('headerSearchContainer');
            const searchInput = document.getElementById('globalSearchInput');
            
            const searchableSections = {
                'bookings': 'T√¨m theo ID, T√™n, Email, SƒêT...',
                'users': 'T√¨m theo T√™n, Email, SƒêT...',
                'hotels': 'T√¨m theo t√™n kh√°ch s·∫°n...',
                'tours': 'T√¨m theo t√™n tour...',
                'deals': 'T√¨m theo ti√™u ƒë·ªÅ ∆∞u ƒë√£i...',
                'travel-guides': 'T√¨m theo ti√™u ƒë·ªÅ b√†i vi·∫øt...',
                'contributions': 'T√¨m theo ti√™u ƒë·ªÅ, t√°c gi·∫£, ƒë·ªãa ƒëi·ªÉm...'
            };

            if (searchableSections[contentId]) {
                searchContainer.style.display = 'flex';
                searchInput.placeholder = searchableSections[contentId];
            } else {
                searchContainer.style.display = 'none';
            }
            searchInput.value = ''; // Clear search on tab switch


            // Load data for the selected section
            switch (contentId) {
                case 'dashboard':
                    loadStatistics();
                    break;
                case 'bookings':
                    loadBookings();
                    break;
                case 'bookings-tours':
                    loadBookingsTours();
                    break;
                case 'hotels':
                    loadHotels();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'tours':
                    loadTours();
                    break;
                case 'vouchers':
                    loadVouchers();
                    break;
                case 'deals':
                    loadDeals();
                    break;
                case 'travel-guides':
                    loadTravelGuides();
                    break;
                case 'contributions':
                    loadContributions();
                    break;
                case 'refunds':
                    loadRefunds();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                // Add more cases for other sections
            }

        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p khi trang ƒë∆∞·ª£c t·∫£i
            checkAuth();

            // Th√™m s·ª± ki·ªán click cho n√∫t ƒëƒÉng xu·∫•t
            const logoutBtn = document.querySelector('.btn-danger.w-100');
            if (logoutBtn && logoutBtn.onclick === null) { // Add listener only if no onclick is present
                logoutBtn.addEventListener('click', logout);
            }

            // Add click event listeners to menu items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const contentId = item.getAttribute('href').substring(1);
                    showContent(contentId);
                });
            });

            // Add event listener for settings form
            const settingsForm = document.getElementById('settingsForm');
            if (settingsForm) {
                settingsForm.addEventListener('submit', saveSettings);
            }
            
            // Add event listener for booking status filter
            const bookingStatusFilter = document.getElementById('bookingStatusFilter');
            if(bookingStatusFilter) {
                bookingStatusFilter.addEventListener('change', filterAndDisplayBookings);
            }

            // Add event listener for mobile toggle
            const mobileToggle = document.getElementById('mobile-toggle');
            if(mobileToggle) {
                mobileToggle.addEventListener('click', toggleSidebar);
            }

            // Show dashboard by default
            showContent('dashboard');

            // Load pending contributions count for sidebar badge
            loadPendingContributionsCount();

             // Initialize global search
            const globalSearchInput = document.getElementById('globalSearchInput');
            if(globalSearchInput) {
                globalSearchInput.addEventListener('input', handleGlobalSearch);
            }

            // Initialize notifications
            const notifBell = document.getElementById('notificationBell');
            const notifDropdown = document.getElementById('notificationDropdown');
            const markAllReadBtn = document.getElementById('markAllAsReadBtn');

            if(notifBell && notifDropdown) {
                notifBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notifDropdown.classList.toggle('show');
                    // Mark as read when opening
                    if (notifDropdown.classList.contains('show')) {
                        markNotificationsAsRead();
                    }
                });

                markAllReadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    markNotificationsAsRead();
                });

                document.addEventListener('click', (e) => {
                    if (!notifDropdown.contains(e.target) && !notifBell.contains(e.target)) {
                        notifDropdown.classList.remove('show');
                    }
                });
            }
            
            loadNotifications();

            // Set th√°ng/nƒÉm m·∫∑c ƒë·ªãnh l√† hi·ªán t·∫°i
            const now = new Date();
            document.getElementById('stat-month').value = (now.getMonth() + 1).toString();
            document.getElementById('stat-year').value = now.getFullYear();
            updateMonthlyStatsUI();
        });

        // Xem chi ti·∫øt kh√°ch s·∫°n
        function viewHotel(locationId, hotelId) {
            db.ref(`location/${locationId}/hotels/${hotelId}`).once('value').then((snapshot) => {
                const hotel = snapshot.val();
                if (!hotel) return;

                const chiTiet = hotel.chiTiet || {};
                const rooms = chiTiet.rooms || {};
                let roomList = '<li>Kh√¥ng c√≥ ph√≤ng n√†o</li>';
                if(Object.keys(rooms).length > 0){
                    roomList = Object.values(rooms).map(room => `<li>${room.name} - ${room.bed} - ${room.size} - ${room.view} - ${(room.price ? room.price.toLocaleString('vi-VN') : '')}ƒë</li>`).join('');
                }

                Swal.fire({
                    title: hotel.tenKhachSan,
                    html: `
                        <img src="${chiTiet.image || 'images/default-hotel.jpg'}" alt="H√¨nh ·∫£nh kh√°ch s·∫°n" class="img-fluid mb-3" style="max-height:200px;">
                        <p><strong>M√¥ t·∫£:</strong> ${hotel.moTa || ''}</p>
                        <p><strong>X·∫øp h·∫°ng sao:</strong> ${hotel.xepHangSao || ''}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${hotel.diaChi || ''}</p>
                        <p><strong>ƒêi·ªán tho·∫°i:</strong> ${hotel.phone || ''}</p>
                        <p><strong>Ph√≠ d·ªãch v·ª•:</strong> ${hotel.serviceFee ? hotel.serviceFee.toLocaleString('vi-VN') + ' ƒë' : ''}</p>
                        <p><strong>Ti·ªán nghi:</strong> ${(chiTiet.facilities || []).join(', ')}</p>
                        <p><strong>Danh s√°ch ph√≤ng:</strong></p>
                        <ul>${roomList}</ul>
                    `,
                    width: '700px'
                });
            });
        }

        function editHotel(locationId, hotelId) {
            db.ref(`location/${locationId}/hotels/${hotelId}`).once('value').then((snapshot) => {
                const hotel = snapshot.val();
                 if (!hotel) {
                     Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y kh√°ch s·∫°n!', 'error');
                     return;
                 }
                const chiTiet = hotel.chiTiet || {};
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a kh√°ch s·∫°n',
                    html: `
                        <form id="editHotelForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">T√™n kh√°ch s·∫°n</label>
                                <input type="text" class="form-control" id="editHotelName" value="${hotel.tenKhachSan || ''}" required>
                            </div>
                             <div class="mb-3">
                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <input type="text" class="form-control" id="editHotelAddress" value="${hotel.diaChi || ''}" required>
                            </div>
                             <div class="mb-3">
                                <label class="form-label">ƒêi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="editHotelPhone" value="${hotel.phone || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="editHotelDesc">${hotel.moTa || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">H√¨nh ·∫£nh (URL)</label>
                                <input type="text" class="form-control" id="editHotelImage" value="${chiTiet.image || ''}">
                            </div>
                             <div class="mb-3">
                                <label class="form-label">Ph√≠ d·ªãch v·ª•</label>
                                <input type="number" class="form-control" id="editHotelServiceFee" value="${hotel.serviceFee || 0}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">X·∫øp h·∫°ng sao</label>
                                <input type="number" class="form-control" id="editHotelStar" value="${hotel.xepHangSao || ''}" min="1" max="5">
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('editHotelForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            tenKhachSan: document.getElementById('editHotelName').value,
                            diaChi: document.getElementById('editHotelAddress').value,
                            phone: document.getElementById('editHotelPhone').value,
                            moTa: document.getElementById('editHotelDesc').value,
                            serviceFee: parseInt(document.getElementById('editHotelServiceFee').value, 10),
                            xepHangSao: parseInt(document.getElementById('editHotelStar').value, 10),
                            'chiTiet/image': document.getElementById('editHotelImage').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedHotel = result.value;
                        db.ref(`location/${locationId}/hotels/${hotelId}`).update(updatedHotel).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Kh√°ch s·∫°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                             generateNotification('fas fa-hotel', 'bg-info', `ƒê√£ c·∫≠p nh·∫≠t kh√°ch s·∫°n ${updatedHotel.tenKhachSan}.`);
                            loadHotels();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t kh√°ch s·∫°n: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteHotel(locationId, hotelId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`location/${locationId}/hotels/${hotelId}`).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'Kh√°ch s·∫°n ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        generateNotification('fas fa-trash', 'bg-danger', `ƒê√£ x√≥a m·ªôt kh√°ch s·∫°n.`);
                        loadHotels();
                    }).catch(error => {
                        Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a kh√°ch s·∫°n: ' + error.message, 'error');
                    });
                }
            });
        }

        // Th√™m kh√°ch s·∫°n m·ªõi
        function addHotel() {
            db.ref('location').once('value').then((snapshot) => {
                const locations = [];
                snapshot.forEach((locationSnapshot) => {
                    locations.push(locationSnapshot.key);
                });
                Swal.fire({
                    title: 'Th√™m kh√°ch s·∫°n m·ªõi',
                    html: `
                        <form id="addHotelForm" class="text-start">
                             <div class="mb-3">
                                <label class="form-label">T·ªânh/Th√†nh ph·ªë</label>
                                <select class="form-control" id="addHotelLocation" required>
                                    <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
                                    ${locations.map(loc => `<option value="${loc}">${loc}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">T√™n kh√°ch s·∫°n</label>
                                <input type="text" class="form-control" id="addHotelName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <input type="text" class="form-control" id="addHotelAddress" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒêi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="addHotelPhone" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="addHotelDesc" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">H√¨nh ·∫£nh (URL)</label>
                                <input type="text" class="form-control" id="addHotelImage" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ph√≠ d·ªãch v·ª• (VNƒê)</label>
                                <input type="number" class="form-control" id="addHotelServiceFee" value="0" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">X·∫øp h·∫°ng sao</label>
                                <input type="number" class="form-control" id="addHotelStar" value="3" min="1" max="5" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ti·ªán nghi (c√°ch nhau b·ªüi d·∫•u ph·∫©y)</label>
                                <input type="text" class="form-control" id="addHotelFacilities" required>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Th√™m m·ªõi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('addHotelForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        const location = document.getElementById('addHotelLocation').value;
                        if (!location) {
                           Swal.showValidationMessage('Vui l√≤ng ch·ªçn T·ªânh/Th√†nh ph·ªë');
                           return false;
                        }
                        return {
                            location: location,
                            tenKhachSan: document.getElementById('addHotelName').value,
                            diaChi: document.getElementById('addHotelAddress').value,
                            phone: document.getElementById('addHotelPhone').value,
                            moTa: document.getElementById('addHotelDesc').value,
                            location: location,
                            tenKhachSan: document.getElementById('addHotelName').value,
                            diaChi: document.getElementById('addHotelAddress').value,
                            phone: document.getElementById('addHotelPhone').value,
                            moTa: document.getElementById('addHotelDesc').value,
                            serviceFee: parseInt(document.getElementById('addHotelServiceFee').value, 10),
                            xepHangSao: parseInt(document.getElementById('addHotelStar').value, 10),
                            chiTiet: {
                                image: document.getElementById('addHotelImage').value,
                                facilities: document.getElementById('addHotelFacilities').value.split(',').map(f => f.trim()),
                                rooms: {} // Kh·ªüi t·∫°o v·ªõi danh s√°ch ph√≤ng r·ªóng
                            }
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const data = result.value;
                        const location = data.location;
                        // X√≥a location kh·ªèi object tr∆∞·ªõc khi push
                        delete data.location;

                        db.ref(`location/${location}/hotels`).push(data).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Kh√°ch s·∫°n m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.',
                                timer: 1500
                            });
                            generateNotification('fas fa-plus', 'bg-success', `ƒê√£ th√™m kh√°ch s·∫°n m·ªõi: ${data.tenKhachSan}`);
                            loadHotels();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ th√™m kh√°ch s·∫°n: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function viewUser(userId) {
            db.ref('users/' + userId).once('value').then((snapshot) => {
                const user = snapshot.val();
                const memberLevel = user.memberLevel || 'ƒê·ªìng';
                const loyaltyPoints = user.loyaltyPoints || 0;
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                const updatedAt = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString('vi-VN') : 'N/A';
                
                Swal.fire({
                    title: user.name || 'Th√¥ng tin ng∆∞·ªùi d√πng',
                    html: `
                        <div class="text-start">
                            <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${user.phone || 'N/A'}</p>
                            <p><strong>ƒê·ªãa ch·ªâ:</strong> ${user.address || 'N/A'}</p>
                            <p><strong>C·∫•p ƒë·ªô th√†nh vi√™n:</strong> <span class="badge bg-primary">${memberLevel}</span></p>
                            <p><strong>ƒêi·ªÉm t√≠ch l≈©y:</strong> <span class="badge bg-success">${loyaltyPoints} ƒëi·ªÉm</span></p>
                            <p><strong>Ng√†y tham gia:</strong> ${createdAt}</p>
                            <p><strong>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</strong> ${updatedAt}</p>
                        </div>
                    `,
                    width: '600px'
                });
            });
        }

        function editUser(userId) {
            db.ref('users/' + userId).once('value').then((snapshot) => {
                const user = snapshot.val();
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng',
                    html: `
                        <form id="editUserForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">T√™n</label>
                                <input type="text" class="form-control" id="editUserName" value="${user.name || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="editUserEmail" value="${user.email || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="editUserPhone" value="${user.phone || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <input type="text" class="form-control" id="editUserAddress" value="${user.address || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">C·∫•p ƒë·ªô th√†nh vi√™n</label>
                                <select class="form-control" id="editUserMemberLevel">
                                    <option value="ƒê·ªìng" ${user.memberLevel === 'ƒê·ªìng' ? 'selected' : ''}>ƒê·ªìng</option>
                                    <option value="B·∫°c" ${user.memberLevel === 'B·∫°c' ? 'selected' : ''}>B·∫°c</option>
                                    <option value="V√†ng" ${user.memberLevel === 'V√†ng' ? 'selected' : ''}>V√†ng</option>
                                    <option value="Kim c∆∞∆°ng" ${user.memberLevel === 'Kim c∆∞∆°ng' ? 'selected' : ''}>Kim c∆∞∆°ng</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒêi·ªÉm t√≠ch l≈©y</label>
                                <input type="number" class="form-control" id="editUserLoyaltyPoints" value="${user.loyaltyPoints || 0}" min="0">
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('editUserForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            name: document.getElementById('editUserName').value,
                            email: document.getElementById('editUserEmail').value,
                            phone: document.getElementById('editUserPhone').value,
                            address: document.getElementById('editUserAddress').value,
                            memberLevel: document.getElementById('editUserMemberLevel').value,
                            loyaltyPoints: parseInt(document.getElementById('editUserLoyaltyPoints').value, 10),
                            updatedAt: Date.now()
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedUser = result.value;
                        db.ref('users/' + userId).update(updatedUser).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                             generateNotification('fas fa-user-edit', 'bg-info', `ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng ${updatedUser.name}.`);
                            loadUsers();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteUser(userId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('users/' + userId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        generateNotification('fas fa-user-slash', 'bg-danger', `ƒê√£ x√≥a m·ªôt ng∆∞·ªùi d√πng.`);
                        loadUsers();
                    });
                }
            });
        }

        function viewTour(tourType, tourId) {
            db.ref(`specialTours/${tourType}/${tourId}`).once('value').then((snapshot) => {
                const tour = snapshot.val();
                 if(!tour) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y tour!', 'error');
                    return;
                }
                Swal.fire({
                    title: tour.name || 'Th√¥ng tin tour',
                    html: `
                        <img src="${tour.image || 'images/default-tour.jpg'}" alt="H√¨nh ·∫£nh tour" class="img-fluid mb-3" style="max-height:200px;">
                        <p><strong>M√¥ t·∫£:</strong> ${tour.description || ''}</p>
                        <p><strong>Th·ªùi l∆∞·ª£ng:</strong> ${tour.duration || ''}</p>
                        <p><strong>Gi√°:</strong> ${tour.price ? tour.price.toLocaleString('vi-VN') + ' ƒë' : 'Ch∆∞a c√≥'}</p>
                    `,
                    width: '600px'
                });
            });
        }

        function editTour(tourType, tourId) {
            db.ref(`specialTours/${tourType}/${tourId}`).once('value').then((snapshot) => {
                const tour = snapshot.val();
                if(!tour) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y tour!', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a tour',
                    html: `
                        <form id="editTourForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">T√™n tour</label>
                                <input type="text" class="form-control" id="editTourName" value="${tour.name || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control" id="editTourDesc">${tour.description || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">H√¨nh ·∫£nh (URL)</label>
                                <input type="text" class="form-control" id="editTourImage" value="${tour.image || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Th·ªùi l∆∞·ª£ng</label>
                                <input type="text" class="form-control" id="editTourDuration" value="${tour.duration || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Gi√° ti·ªÅn (VNƒê)</label>
                                <input type="number" class="form-control" id="editTourPrice" value="${tour.price || ''}" min="0" required>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const form = document.getElementById('editTourForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            name: document.getElementById('editTourName').value,
                            description: document.getElementById('editTourDesc').value,
                            image: document.getElementById('editTourImage').value,
                            duration: document.getElementById('editTourDuration').value,
                            price: parseInt(document.getElementById('editTourPrice').value, 10)
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedTour = result.value;
                        db.ref(`specialTours/${tourType}/${tourId}`).update(updatedTour).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: 'Tour ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                            loadTours();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tour: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteTour(tourType, tourId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`specialTours/${tourType}/${tourId}`).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'Tour ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        loadTours();
                    }).catch(error => {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√≥a tour: ' + error.message, 'error');
                    });
                }
            });
        }

        function addTour() {
            const tourTypes = ['amThucVaVanHoa', 'hoatDongGanBan', 'traiNghiemDiaPhuong'];
            Swal.fire({
                title: 'Th√™m tour m·ªõi',
                html: `
                    <form id="addTourForm" class="text-start">
                         <div class="mb-3">
                            <label class="form-label">Lo·∫°i tour</label>
                            <select class="form-control" id="addTourType" required>
                                <option value="">Ch·ªçn lo·∫°i tour</option>
                                ${tourTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">T√™n tour</label>
                            <input type="text" class="form-control" id="addTourName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√¥ t·∫£</label>
                            <textarea class="form-control" id="addTourDesc" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">H√¨nh ·∫£nh (URL)</label>
                            <input type="text" class="form-control" id="addTourImage" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Th·ªùi l∆∞·ª£ng</label>
                            <input type="text" class="form-control" id="addTourDuration" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gi√° ti·ªÅn (VNƒê)</label>
                            <input type="number" class="form-control" id="addTourPrice" min="0" required>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                preConfirm: () => {
                    const form = document.getElementById('addTourForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                     const tourType = document.getElementById('addTourType').value;
                     if (!tourType) {
                        Swal.showValidationMessage('Vui l√≤ng ch·ªçn lo·∫°i tour');
                        return false;
                     }
                    return {
                        tourType: tourType,
                        name: document.getElementById('addTourName').value,
                        description: document.getElementById('addTourDesc').value,
                        image: document.getElementById('addTourImage').value,
                        duration: document.getElementById('addTourDuration').value,
                        price: parseInt(document.getElementById('addTourPrice').value, 10)
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newTourData = result.value;
                    const tourType = newTourData.tourType;
                    delete newTourData.tourType; // X√≥a key t·∫°m th·ªùi

                    db.ref(`specialTours/${tourType}`).push(newTourData).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Th√†nh c√¥ng!',
                            text: 'Tour m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.',
                            timer: 1500
                        });
                        loadTours();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói!',
                            text: 'Kh√¥ng th·ªÉ th√™m tour: ' + error.message
                        });
                    });
                }
            });
        }

        window.viewHotel = viewHotel;
        window.editHotel = editHotel;
        window.deleteHotel = deleteHotel;
        window.addHotel = addHotel;
        window.viewUser = viewUser;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.viewTour = viewTour;
        window.editTour = editTour;
        window.deleteTour = deleteTour;
        window.addTour = addTour;
        window.editVoucher = editVoucher; window.deleteVoucher = deleteVoucher;
        window.addVoucher = addVoucher;
        window.addDeal = addDeal;
        window.editDeal = editDeal;
        window.deleteDeal = deleteDeal;
        window.addTravelGuide = addTravelGuide;
        window.editTravelGuide = editTravelGuide;
        window.deleteTravelGuide = deleteTravelGuide;

        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function (event) {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.querySelector('.mobile-toggle');

            if (window.innerWidth <= 768 &&
                !sidebar.contains(event.target) &&
                !toggleBtn.contains(event.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        window.toggleSidebar = toggleSidebar;

        // Load deals data
        function loadDeals() {
            const dealsTableBody = document.getElementById('dealsTableBody');
            dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('specialOffers').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }

                dealsTableBody.innerHTML = '';
                snapshot.forEach((dealSnapshot) => {
                    const deal = dealSnapshot.val();
                    const dealId = dealSnapshot.key;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${deal.title || 'N/A'}</td>
                        <td><span class="badge bg-success">${deal.newPrice || 'N/A'}</span></td>
                        <td><span style="text-decoration: line-through;">${deal.oldPrice || 'N/A'}</span></td>
                        <td>${deal.stayEndDate ? new Date(deal.stayEndDate).toLocaleDateString('vi-VN') : 'Kh√¥ng c√≥'}</td>
                        <td>
                            <button class="btn btn-action btn-edit" onclick="editDeal('${dealId}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-action btn-delete" onclick="deleteDeal('${dealId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    dealsTableBody.appendChild(row);
                });
            }).catch(error => {
                dealsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</div></tr>';
            });
        }

        function addDeal() {
            Swal.fire({
                title: 'Th√™m ∆∞u ƒë√£i m·ªõi',
                html: `
                    <form id="addDealForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                        <div class="mb-3"><label class="form-label">Ti√™u ƒë·ªÅ</label><input type="text" class="form-control" id="dealTitle" required></div>
                        <div class="mb-3"><label class="form-label">M√¥ t·∫£</label><textarea class="form-control" id="dealDesc" required></textarea></div>
                        <div class="mb-3"><label class="form-label">Nh√£n</label><input type="text" class="form-control" id="dealLabel" placeholder="VD: Flash Sale, Hot..."></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Gi√° m·ªõi</label><input type="text" class="form-control" id="dealNewPrice" placeholder="VD: 3.200.000ƒë" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Gi√° c≈©</label><input type="text" class="form-control" id="dealOldPrice" placeholder="VD: 5.000.000ƒë" required></div>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" class="form-control" id="dealStayStart" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label">Ng√†y k·∫øt th√∫c</label><input type="date" class="form-control" id="dealStayEnd" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">H√¨nh ·∫£nh (URL)</label><input type="url" class="form-control" id="dealImage" required></div>
                        <div class="row">
                           <div class="col-md-6 mb-3"><label class="form-label">S·ªë ƒë√™m</label><input type="number" class="form-control" id="dealNights" min="1" required></div>
                           <div class="col-md-6 mb-3"><label class="form-label">S·ªë kh√°ch</label><input type="number" class="form-control" id="dealGuests" min="1" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label">T√¨nh tr·∫°ng</label><input type="text" class="form-control" id="dealAvailability" placeholder="VD: Ch·ªâ c√≤n 50 ph√≤ng"></div>
                        <div class="mb-3"><label class="form-label">ƒê·∫∑c ƒëi·ªÉm (m·ªói ƒë·∫∑c ƒëi·ªÉm m·ªôt d√≤ng)</label><textarea class="form-control" id="dealFeatures" rows="3"></textarea></div>
                        <div class="mb-3"><label class="form-label">Ghi ch√∫</label><textarea class="form-control" id="dealNote"></textarea></div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                width: '800px',
                preConfirm: () => {
                    const form = document.getElementById('addDealForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    return {
                        title: document.getElementById('dealTitle').value,
                        desc: document.getElementById('dealDesc').value,
                        label: document.getElementById('dealLabel').value,
                        newPrice: document.getElementById('dealNewPrice').value,
                        oldPrice: document.getElementById('dealOldPrice').value,
                        stayStartDate: document.getElementById('dealStayStart').value,
                        stayEndDate: document.getElementById('dealStayEnd').value,
                        image: document.getElementById('dealImage').value,
                        nights: parseInt(document.getElementById('dealNights').value),
                        guests: parseInt(document.getElementById('dealGuests').value),
                        availability: document.getElementById('dealAvailability').value,
                        features: document.getElementById('dealFeatures').value.split('\\n').map(f => f.trim()).filter(f => f),
                        note: document.getElementById('dealNote').value,
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newDealRef = db.ref('specialOffers').push();
                    const newDeal = {
                        ...result.value,
                        id: newDealRef.key
                    };
                    
                    newDealRef.set(newDeal).then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Th√†nh c√¥ng!',
                            text: '∆Øu ƒë√£i m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.',
                            timer: 1500
                        });
                        loadDeals();
                    }).catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói!',
                            text: 'Kh√¥ng th·ªÉ th√™m ∆∞u ƒë√£i: ' + error.message
                        });
                    });
                }
            });
        }

        function editDeal(dealId) {
            db.ref('specialOffers/' + dealId).once('value').then((snapshot) => {
                const deal = snapshot.val();
                if (!deal) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ∆∞u ƒë√£i n√†y!', 'error');
                    return;
                }
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a ∆∞u ƒë√£i',
                    html: `
                       <form id="editDealForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                            <div class="mb-3"><label class="form-label">Ti√™u ƒë·ªÅ</label><input type="text" class="form-control" id="dealTitle" value="${deal.title || ''}" required></div>
                            <div class="mb-3"><label class="form-label">M√¥ t·∫£</label><textarea class="form-control" id="dealDesc" required>${deal.desc || ''}</textarea></div>
                            <div class="mb-3"><label class="form-label">Nh√£n</label><input type="text" class="form-control" id="dealLabel" value="${deal.label || ''}" placeholder="VD: Flash Sale, Hot..."></div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Gi√° m·ªõi</label><input type="text" class="form-control" id="dealNewPrice" value="${deal.newPrice || ''}" placeholder="VD: 3.200.000ƒë" required></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Gi√° c≈©</label><input type="text" class="form-control" id="dealOldPrice" value="${deal.oldPrice || ''}" placeholder="VD: 5.000.000ƒë" required></div>
                            </div>
                             <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" class="form-control" id="dealStayStart" value="${deal.stayStartDate || ''}" required></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Ng√†y k·∫øt th√∫c</label><input type="date" class="form-control" id="dealStayEnd" value="${deal.stayEndDate || ''}" required></div>
                            </div>
                            <div class="mb-3"><label class="form-label">H√¨nh ·∫£nh (URL)</label><input type="url" class="form-control" id="dealImage" value="${deal.image || ''}" required></div>
                            <div class="row">
                               <div class="col-md-6 mb-3"><label class="form-label">S·ªë ƒë√™m</label><input type="number" class="form-control" id="dealNights" value="${deal.nights || 1}" min="1" required></div>
                               <div class="col-md-6 mb-3"><label class="form-label">S·ªë kh√°ch</label><input type="number" class="form-control" id="dealGuests" value="${deal.guests || 1}" min="1" required></div>
                            </div>
                            <div class="mb-3"><label class="form-label">T√¨nh tr·∫°ng</label><input type="text" class="form-control" id="dealAvailability" value="${deal.availability || ''}" placeholder="VD: Ch·ªâ c√≤n 50 ph√≤ng"></div>
                            <div class="mb-3"><label class="form-label">ƒê·∫∑c ƒëi·ªÉm (m·ªói ƒë·∫∑c ƒëi·ªÉm m·ªôt d√≤ng)</label><textarea class="form-control" id="dealFeatures" rows="3">${(deal.features || []).join('\\n')}</textarea></div>
                            <div class="mb-3"><label class="form-label">Ghi ch√∫</label><textarea class="form-control" id="dealNote">${deal.note || ''}</textarea></div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    width: '800px',
                    preConfirm: () => {
                        const form = document.getElementById('editDealForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            title: document.getElementById('dealTitle').value,
                            desc: document.getElementById('dealDesc').value,
                            label: document.getElementById('dealLabel').value,
                            newPrice: document.getElementById('dealNewPrice').value,
                            oldPrice: document.getElementById('dealOldPrice').value,
                            stayStartDate: document.getElementById('dealStayStart').value,
                            stayEndDate: document.getElementById('dealStayEnd').value,
                            image: document.getElementById('dealImage').value,
                            nights: parseInt(document.getElementById('dealNights').value),
                            guests: parseInt(document.getElementById('dealGuests').value),
                            availability: document.getElementById('dealAvailability').value,
                            features: document.getElementById('dealFeatures').value.split('\\n').map(f => f.trim()).filter(f => f),
                            note: document.getElementById('dealNote').value,
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const updatedDeal = {
                            ...result.value,
                            id: dealId // Make sure ID is preserved
                        };
                        db.ref('specialOffers/' + dealId).update(updatedDeal).then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Th√†nh c√¥ng!',
                                text: '∆Øu ƒë√£i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.',
                                timer: 1500
                            });
                            loadDeals();
                        }).catch((error) => {
                            Swal.fire({
                                icon: 'error',
                                title: 'L·ªói!',
                                text: 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ∆∞u ƒë√£i: ' + error.message
                            });
                        });
                    }
                });
            });
        }

        function deleteDeal(dealId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('specialOffers/' + dealId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', '∆Øu ƒë√£i ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        loadDeals();
                    });
                }
            });
        }

        // Travel Guide CRUD
        function loadTravelGuides() {
            const travelGuidesTableBody = document.getElementById('travelGuidesTableBody');
            travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('travelGuides').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }

                travelGuidesTableBody.innerHTML = '';
                snapshot.forEach((guideSnapshot) => {
                    const guide = guideSnapshot.val();
                    const guideId = guideSnapshot.key;
                    
                    // Helper to create a title from the key
                    const title = guideId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    const displayDate = guide.last_updated ? new Date(guide.last_updated).toLocaleDateString('vi-VN') : 'N/A';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${guide.main_image || 'images/default-tour.jpg'}" alt="guide-image" style="width: 100px; object-fit: cover;"></td>
                        <td>${title}</td>
                        <td>${guide.author || 'N/A'}</td>
                        <td>${displayDate}</td>
                        <td>
                            <button class="btn btn-action btn-edit" onclick="editTravelGuide('${guideId}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-action btn-delete" onclick="deleteTravelGuide('${guideId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    travelGuidesTableBody.appendChild(row);
                });
            }).catch(error => {
                travelGuidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
            });
        }

        function addTravelGuide() {
            Swal.fire({
                title: 'Th√™m b√†i vi·∫øt c·∫©m nang',
                html: `
                    <form id="addTravelGuideForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                        <div class="mb-3">
                            <label class="form-label">Ti√™u ƒë·ªÅ b√†i vi·∫øt</label>
                            <input type="text" class="form-control" id="guideTitle" placeholder="VD: Kh√°m Ph√° ƒê√† N·∫µng" required>
                            <small class="form-text text-muted">Ti√™u ƒë·ªÅ s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ t·∫°o ID duy nh·∫•t (VD: kham-pha-da-nang).</small>
                        </div>
                        <div class="mb-3"><label class="form-label">T√°c gi·∫£</label><input type="text" class="form-control" id="guideAuthor" required></div>
                        <div class="mb-3"><label class="form-label">Ng√†y ƒëƒÉng</label><input type="date" class="form-control" id="guideDate" required></div>
                        <div class="mb-3"><label class="form-label">H√¨nh ·∫£nh ch√≠nh (URL)</label><input type="url" class="form-control" id="guideImage" required></div>
                        <div class="mb-3"><label class="form-label">M√¥ t·∫£ t·ªïng quan</label><textarea class="form-control" id="guideOverview" rows="5" required></textarea></div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Th√™m m·ªõi',
                cancelButtonText: 'H·ªßy',
                width: '800px',
                preConfirm: () => {
                    const form = document.getElementById('addTravelGuideForm');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    const title = document.getElementById('guideTitle').value;
                    // A simple slugify function
                    const slugify = (text) => {
                        const a = '√†√°√¢√£√®√©√™√¨√≠√≤√≥√¥√µ√π√∫ƒÉƒëƒ©≈©∆°∆∞ƒÉ·∫°·∫£·∫•·∫ß·∫©·∫´·∫≠·∫Ø·∫±·∫≥·∫µ·∫∑·∫π·∫ª·∫Ω·ªÅ·ªÅ·ªÉ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ªÖ·ªá·ªâ·ªã·ªç·ªè·ªë·ªì·ªï·ªó·ªô·ªõ·ªù·ªü·ª°·ª£·ª•·ªß·ª©·ª´·ª¨·ªÆ·ª∞·ª≤·ª¥√ù·ª∂·ª∏·ª≠·ªØ·ª±·ª≥·ªµ·ª∑·ªπ';
                        const b = 'aaaaaaaaeeeeiiooooouuadiuouaaaaaaaaaaaaaaaeeeeeeeeeeIIOOOOOOOOOOOOOOOOOOUUUUUeeeeeeiiooooooooooooooooouuuuuUUUUUYYYYYuuuuuyyyyy';
                        const p = new RegExp(a.split('').join('|'), 'g');

                        return text.toString().toLowerCase()
                            .replace(p, c => b.charAt(a.indexOf(c)))
                            .replace(/\s+/g, '-')
                            .replace(/[^\w\-]+/g, '')
                            .replace(/\-\-+/g, '-')
                            .replace(/^-+/, '')
                            .replace(/-+$/, '');
                    };
                    const guideId = slugify(title);

                    if (!guideId) {
                        Swal.showValidationMessage('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ h·ª£p l·ªá.');
                        return false;
                    }

                    return {
                        guideId: guideId,
                        author: document.getElementById('guideAuthor').value,
                        last_updated: document.getElementById('guideDate').value,
                        main_image: document.getElementById('guideImage').value,
                        overview: document.getElementById('guideOverview').value,
                        // S·ª¨A L·ªñI: Kh·ªüi t·∫°o sections v√† related_destinations d∆∞·ªõi d·∫°ng ƒë·ªëi t∆∞·ª£ng thay v√¨ m·∫£ng
                        sections: { "0": { "heading": "N·ªôi dung ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t..." } },
                        related_destinations: { "0": "" },
                        is_featured_on_homepage: false,
                        id: 'guide_' + guideId.replace(/-/g, '_')
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newGuideData = result.value;
                    const guideId = newGuideData.guideId;
                    delete newGuideData.guideId;

                    db.ref('travelGuides/' + guideId).once('value').then(snapshot => {
                        if (snapshot.exists()) {
                            Swal.fire('L·ªói!', 'Ti√™u ƒë·ªÅ n√†y ƒë√£ t·ªìn t·∫°i, vui l√≤ng ch·ªçn ti√™u ƒë·ªÅ kh√°c.', 'error');
                        } else {
                            db.ref('travelGuides/' + guideId).set(newGuideData).then(() => {
                                Swal.fire('Th√†nh c√¥ng!', 'B√†i vi·∫øt m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.', 'success');
                                loadTravelGuides();
                            }).catch((error) => {
                                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ th√™m b√†i vi·∫øt: ' + error.message, 'error');
                            });
                        }
                    });
                }
            });
        }

        function editTravelGuide(guideId) {
            db.ref('travelGuides/' + guideId).once('value').then((snapshot) => {
                const guide = snapshot.val();
                if (!guide) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†y!', 'error');
                    return;
                }
                const title = guideId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                Swal.fire({
                    title: 'Ch·ªânh s·ª≠a b√†i vi·∫øt c·∫©m nang',
                    html: `
                        <form id="editTravelGuideForm" class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 15px;">
                            <div class="mb-3"><label class="form-label">Ti√™u ƒë·ªÅ (ID)</label><input type="text" class="form-control" value="${title}" disabled></div>
                            <div class="mb-3"><label class="form-label">T√°c gi·∫£</label><input type="text" class="form-control" id="guideAuthor" value="${guide.author || ''}" required></div>
                            <div class="mb-3"><label class="form-label">Ng√†y c·∫≠p nh·∫≠t</label><input type="date" class="form-control" id="guideDate" value="${guide.last_updated || ''}" required></div>
                            <div class="mb-3"><label class="form-label">H√¨nh ·∫£nh ch√≠nh (URL)</label><input type="url" class="form-control" id="guideImage" value="${guide.main_image || ''}" required></div>
                            <div class="mb-3"><label class="form-label">M√¥ t·∫£ t·ªïng quan</label><textarea class="form-control" id="guideOverview" rows="5" required>${guide.overview || ''}</textarea></div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u thay ƒë·ªïi',
                    cancelButtonText: 'H·ªßy',
                    width: '800px',
                    preConfirm: () => {
                        const form = document.getElementById('editTravelGuideForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return false;
                        }
                        return {
                            author: document.getElementById('guideAuthor').value,
                            last_updated: document.getElementById('guideDate').value,
                            main_image: document.getElementById('guideImage').value,
                            overview: document.getElementById('guideOverview').value,
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        db.ref('travelGuides/' + guideId).update(result.value).then(() => {
                            Swal.fire('Th√†nh c√¥ng!', 'B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.', 'success');
                            loadTravelGuides();
                        }).catch((error) => {
                            Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t b√†i vi·∫øt: ' + error.message, 'error');
                        });
                    }
                });
            });
        }

        function deleteTravelGuide(guideId) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: 'B·∫°n kh√¥ng th·ªÉ ho√†n t√°c sau khi x√≥a!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('travelGuides/' + guideId).remove().then(() => {
                        Swal.fire('ƒê√£ x√≥a!', 'B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                        loadTravelGuides();
                    }).catch(error => {
                        Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt: ' + error.message, 'error');
                    });
                }
            });
        }

        // =================== CONTRIBUTIONS MANAGEMENT ===================
        
        let currentContributions = [];
        let currentFilter = 'all';

        // Load contributions from Firebase
        function loadContributions() {
            const loadingElement = document.getElementById('contributions-loading');
            const emptyElement = document.getElementById('contributions-empty');
            const listElement = document.getElementById('contributions-list');

            // Show loading
            loadingElement.style.display = 'block';
            emptyElement.style.display = 'none';
            listElement.innerHTML = '';

            db.ref('userContributions').once('value').then((snapshot) => {
                loadingElement.style.display = 'none';

                if (!snapshot.exists()) {
                    emptyElement.style.display = 'block';
                    updateContributionsCount(0);
                    return;
                }

                currentContributions = [];
                snapshot.forEach((contributionSnapshot) => {
                    const contribution = contributionSnapshot.val();
                    contribution.id = contributionSnapshot.key;
                    currentContributions.push(contribution);
                });

                // S·∫Øp x·∫øp theo th·ªùi gian g·ª≠i (m·ªõi nh·∫•t tr∆∞·ªõc)
                currentContributions.sort((a, b) => (b.submittedAt || 0) - (a.submittedAt || 0));

                updateContributionsCount(currentContributions.length);
                displayContributions(currentContributions);

                // Update pending count badge
                const pendingCount = currentContributions.filter(c => c.status === 'pending').length;
                updatePendingBadge(pendingCount);

            }).catch(error => {
                loadingElement.style.display = 'none';
                listElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}
                    </div>
                `;
            });
        }

        // Display contributions with current filter
        function displayContributions(contributions) {
            const listElement = document.getElementById('contributions-list');
            
            // Filter contributions based on current filter
            let filteredContributions = contributions;
            if (currentFilter !== 'all') {
                filteredContributions = contributions.filter(c => c.status === currentFilter);
            }

            if (filteredContributions.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">Kh√¥ng c√≥ c·∫©m nang n√†o v·ªõi tr·∫°ng th√°i "${getStatusText(currentFilter)}"</h6>
                    </div>
                `;
                return;
            }

            listElement.innerHTML = '';
            filteredContributions.forEach(contribution => {
                const contributionCard = createContributionCard(contribution);
                listElement.appendChild(contributionCard);
            });
        }

        // Create contribution card element
        function createContributionCard(contribution) {
            const div = document.createElement('div');
            div.className = 'card mb-4 contribution-card';

            const status = contribution.status || 'pending';
            const statusBadge = getStatusBadge(status);
            const submittedDate = contribution.submittedAt ? new Date(contribution.submittedAt).toLocaleString('vi-VN') : 'Kh√¥ng r√µ';
            const hotelCount = contribution.hotelRecommendations ? contribution.hotelRecommendations.length : 0;

            div.innerHTML = `
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <img src="${contribution.main_image || '/images/default-guide.jpg'}" 
                                 alt="·∫¢nh c·∫©m nang" class="img-fluid rounded" style="height: 150px; object-fit: cover; width: 100%;">
                        </div>
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-1">${contribution.title}</h5>
                                ${statusBadge}
                            </div>
                            
                            <div class="row text-muted small mb-2">
                                <div class="col-md-6">
                                    <i class="fas fa-user"></i> <strong>T√°c gi·∫£:</strong> ${contribution.authorName}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-envelope"></i> ${contribution.authorEmail}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-map-marker-alt"></i> <strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${contribution.location}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-tag"></i> <strong>Danh m·ª•c:</strong> ${contribution.category}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-clock"></i> <strong>Th·ªùi gian:</strong> ${contribution.duration || 'Kh√¥ng r√µ'}
                                </div>
                                <div class="col-md-6">
                                    <i class="fas fa-hotel"></i> <strong>Kh√°ch s·∫°n g·ª£i √Ω:</strong> ${hotelCount} kh√°ch s·∫°n
                                </div>
                                <div class="col-12 mt-2">
                                    <i class="fas fa-calendar"></i> <strong>G·ª≠i l√∫c:</strong> ${submittedDate}
                                </div>
                            </div>
                            
                            <p class="card-text text-muted">${contribution.summary}</p>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="viewContribution('${contribution.id}')">
                                    <i class="fas fa-eye"></i> Xem chi ti·∫øt
                                </button>
                                ${status === 'pending' ? `
                                    <button class="btn btn-success btn-sm" onclick="quickApproveContribution('${contribution.id}')">
                                        <i class="fas fa-check"></i> Duy·ªát nhanh
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="quickRejectContribution('${contribution.id}')">
                                        <i class="fas fa-times"></i> T·ª´ ch·ªëi
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Ch·ªù duy·ªát</span>',
                'approved': '<span class="badge bg-success"><i class="fas fa-check"></i> ƒê√£ duy·ªát</span>',
                'rejected': '<span class="badge bg-danger"><i class="fas fa-times"></i> T·ª´ ch·ªëi</span>'
            };
            return badges[status] || badges['pending'];
        }

        // Get status text
        function getStatusText(status) {
            const texts = {
                'all': 't·∫•t c·∫£',
                'pending': 'ch·ªù duy·ªát',
                'approved': 'ƒë√£ duy·ªát', 
                'rejected': 't·ª´ ch·ªëi'
            };
            return texts[status] || 'kh√¥ng r√µ';
        }

        // Filter contributions
        function filterContributions(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('[onclick^="filterContributions"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');

            displayContributions(currentContributions);
        }

        // Update contributions count
        function updateContributionsCount(count) {
            const badge = document.getElementById('contributions-count-badge');
            if (badge) {
                badge.textContent = count;
            }
        }

        // Update pending badge in sidebar
        function updatePendingBadge(count) {
            const badge = document.getElementById('pending-contributions-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Load pending contributions count for sidebar
        function loadPendingContributionsCount() {
            db.ref('userContributions').orderByChild('status').equalTo('pending').once('value').then((snapshot) => {
                const pendingCount = snapshot.numChildren();
                updatePendingBadge(pendingCount);
            }).catch(error => {
                console.error('Error loading pending contributions count:', error);
            });
        }

        // View contribution details
        function viewContribution(contributionId) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y c·∫©m nang n√†y!', 'error');
                return;
            }

            // Store current contribution for approval/rejection
            window.currentContribution = contribution;

            const modalContent = document.getElementById('contribution-detail-content');
            const submittedDate = contribution.submittedAt ? new Date(contribution.submittedAt).toLocaleString('vi-VN') : 'Kh√¥ng r√µ';
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h3>${contribution.title}</h3>
                        <div class="mb-3">
                            ${getStatusBadge(contribution.status || 'pending')}
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong><i class="fas fa-user"></i> T√°c gi·∫£:</strong> ${contribution.authorName}<br>
                                <strong><i class="fas fa-envelope"></i> Email:</strong> ${contribution.authorEmail}<br>
                                <strong><i class="fas fa-map-marker-alt"></i> ƒê·ªãa ƒëi·ªÉm:</strong> ${contribution.location}<br>
                                <strong><i class="fas fa-tag"></i> Danh m·ª•c:</strong> ${contribution.category}
                            </div>
                            <div class="col-md-6">
                                <strong><i class="fas fa-clock"></i> Th·ªùi gian:</strong> ${contribution.duration || 'Kh√¥ng r√µ'}<br>
                                <strong><i class="fas fa-dollar-sign"></i> Ng√¢n s√°ch:</strong> ${contribution.budget || 'Kh√¥ng r√µ'}<br>
                                <strong><i class="fas fa-calendar"></i> M√πa th√≠ch h·ª£p:</strong> ${contribution.season || 'Kh√¥ng r√µ'}<br>
                                <strong><i class="fas fa-calendar-plus"></i> G·ª≠i l√∫c:</strong> ${submittedDate}
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5><i class="fas fa-align-left"></i> T√≥m t·∫Øt</h5>
                            <p class="bg-light p-3 rounded">${contribution.summary}</p>
                        </div>

                        <div class="mb-4">
                            <h5><i class="fas fa-file-alt"></i> N·ªôi dung chi ti·∫øt</h5>
                            <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                                ${contribution.content.replace(/\n/g, '<br>')}
                            </div>
                        </div>

                        ${contribution.hotelRecommendations && contribution.hotelRecommendations.length > 0 ? `
                            <div class="mb-4">
                                <h5><i class="fas fa-hotel"></i> Kh√°ch s·∫°n g·ª£i √Ω (${contribution.hotelRecommendations.length})</h5>
                                ${contribution.hotelRecommendations.map(hotel => `
                                    <div class="card mb-2">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">${hotel.name}</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small><strong>ƒê√°nh gi√°:</strong> ${hotel.rating ? '‚≠ê'.repeat(hotel.rating) : 'Ch∆∞a ƒë√°nh gi√°'}</small><br>
                                                    <small><strong>Gi√°:</strong> ${hotel.price || 'Ch∆∞a c√≥ th√¥ng tin'}</small><br>
                                                    <small><strong>V·ªã tr√≠:</strong> ${hotel.location || 'Ch∆∞a c√≥ th√¥ng tin'}</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small><strong>G·ª£i √Ω:</strong> ${getRecommendationText(hotel.recommendation)}</small>
                                                </div>
                                            </div>
                                            ${hotel.review ? `<p class="mt-2 mb-0"><small><strong>Nh·∫≠n x√©t:</strong> ${hotel.review}</small></p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <img src="${contribution.main_image || '/images/default-guide.jpg'}" 
                                 alt="·∫¢nh c·∫©m nang" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Th√¥ng tin th√™m</h6>
                            </div>
                            <div class="card-body">
                                <small>
                                    <strong>ID:</strong> ${contribution.id}<br>
                                    <strong>Slug:</strong> ${contribution.slug || 'Ch∆∞a t·∫°o'}<br>
                                    <strong>Tr·∫°ng th√°i:</strong> ${getStatusText(contribution.status || 'pending')}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Show/hide action buttons based on status
            const approveBtn = document.getElementById('approveContributionBtn');
            const rejectBtn = document.getElementById('rejectContributionBtn');
            
            if (contribution.status === 'pending') {
                approveBtn.style.display = 'inline-block';
                rejectBtn.style.display = 'inline-block';
            } else {
                approveBtn.style.display = 'none';
                rejectBtn.style.display = 'none';
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('contributionDetailModal'));
            modal.show();
        }

        // Get recommendation text
        function getRecommendationText(recommendation) {
            const texts = {
                'highly-recommended': 'üî• R·∫•t khuy·∫øn kh√≠ch',
                'recommended': 'üëç Khuy·∫øn kh√≠ch',
                'okay': 'üòê T·∫°m ƒë∆∞·ª£c',
                'not-recommended': 'üëé Kh√¥ng khuy·∫øn kh√≠ch'
            };
            return texts[recommendation] || 'Ch∆∞a ƒë√°nh gi√°';
        }

        // Quick approve contribution
        function quickApproveContribution(contributionId) {
            Swal.fire({
                title: 'Duy·ªát c·∫©m nang?',
                text: 'C·∫©m nang s·∫Ω ƒë∆∞·ª£c c√¥ng b·ªë tr√™n website ngay l·∫≠p t·ª©c.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Duy·ªát',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    approveContribution(contributionId);
                }
            });
        }

        // Quick reject contribution
        function quickRejectContribution(contributionId) {
            Swal.fire({
                title: 'T·ª´ ch·ªëi c·∫©m nang',
                input: 'textarea',
                inputLabel: 'L√Ω do t·ª´ ch·ªëi',
                inputPlaceholder: 'Nh·∫≠p l√Ω do t·ª´ ch·ªëi ƒë·ªÉ g·ª≠i ph·∫£n h·ªìi cho t√°c gi·∫£...',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi!';
                    }
                },
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'T·ª´ ch·ªëi',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    rejectContribution(contributionId, result.value);
                }
            });
        }

        // Approve contribution
        function approveContribution(contributionId) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y c·∫©m nang n√†y!', 'error');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'ƒêang x·ª≠ l√Ω...',
                text: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Generate guide data for travelGuides collection
            const slugId = contribution.slug || generateSlug(contribution.title);
            const guideData = {
                title: contribution.title,
                author: contribution.authorName,
                main_image: contribution.main_image || '/images/default-guide.jpg',
                overview: contribution.summary,
                last_updated: new Date().toISOString().split('T')[0],
                is_featured_on_homepage: false,
                id: slugId,
                slug: slugId, // Th√™m slug ƒë·ªÉ hi·ªÉn th·ªã tr√™n travel_guide.html
                sections: {
                    "0": {
                        "heading": "Th√¥ng tin chi ti·∫øt",
                        "content": contribution.content
                    }
                },
                related_destinations: { "0": contribution.location },
                category: contribution.category,
                location: contribution.location,
                duration: contribution.duration,
                budget: contribution.budget,
                season: contribution.season,
                hotelRecommendations: contribution.hotelRecommendations || [],
                originalContributionId: contributionId
            };

            // Save to travelGuides and update contribution status
            Promise.all([
                db.ref('travelGuides/' + slugId).set(guideData),
                db.ref('userContributions/' + contributionId + '/status').set('approved'),
                db.ref('userContributions/' + contributionId + '/approvedAt').set(firebase.database.ServerValue.TIMESTAMP),
                db.ref('userContributions/' + contributionId + '/publishedGuideId').set(slugId)
            ]).then(() => {
                // Send approval email
                return emailjs.send("service_6spwxxw", "template_vcjlg02", {
                    to_email: contribution.authorEmail,
                    from_name: "Admin LuxuryHavenTravel",
                    title: "C·∫©m nang ƒë√£ ƒë∆∞·ª£c duy·ªát",
                    message: `Ch√∫c m·ª´ng! C·∫©m nang "${contribution.title}" c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c duy·ªát v√† c√¥ng b·ªë tr√™n website. C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p n·ªôi dung ch·∫•t l∆∞·ª£ng cho c·ªông ƒë·ªìng du l·ªãch.`,
                    timestamp: new Date().toLocaleString('vi-VN')
                });
            }).then(() => {
                Swal.fire({
                    title: 'Th√†nh c√¥ng!',
                    text: 'C·∫©m nang ƒë√£ ƒë∆∞·ª£c duy·ªát v√† c√¥ng b·ªë tr√™n website.',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
                
                // Reload contributions
                loadContributions();
                
                // Close modal if open
                const modal = bootstrap.Modal.getInstance(document.getElementById('contributionDetailModal'));
                if (modal) modal.hide();
                
            }).catch(error => {
                Swal.fire({
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ duy·ªát c·∫©m nang: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
                console.error('Error approving contribution:', error);
            });
        }

        // Reject contribution
        function rejectContribution(contributionId, reason) {
            const contribution = currentContributions.find(c => c.id === contributionId);
            if (!contribution) {
                Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y c·∫©m nang n√†y!', 'error');
                return;
            }

            // Show loading
            Swal.fire({
                title: 'ƒêang x·ª≠ l√Ω...',
                text: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Update contribution status and add rejection reason
            Promise.all([
                db.ref('userContributions/' + contributionId + '/status').set('rejected'),
                db.ref('userContributions/' + contributionId + '/rejectedAt').set(firebase.database.ServerValue.TIMESTAMP),
                db.ref('userContributions/' + contributionId + '/rejectionReason').set(reason)
            ]).then(() => {
                // Send rejection email
                return emailjs.send("service_6spwxxw", "template_vcjlg02", {
                    to_email: contribution.authorEmail,
                    from_name: "Admin LuxuryHavenTravel",
                    title: "C·∫©m nang c·∫ßn ch·ªânh s·ª≠a",
                    message: `C·∫©m nang "${contribution.title}" c·ªßa b·∫°n c·∫ßn ƒë∆∞·ª£c ch·ªânh s·ª≠a theo ph·∫£n h·ªìi sau:\n\n${reason}\n\nVui l√≤ng ch·ªânh s·ª≠a v√† g·ª≠i l·∫°i c·∫©m nang. C·∫£m ∆°n b·∫°n ƒë√£ ƒë√≥ng g√≥p!`,
                    timestamp: new Date().toLocaleString('vi-VN')
                });
            }).then(() => {
                Swal.fire({
                    title: 'ƒê√£ t·ª´ ch·ªëi!',
                    text: 'Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn t√°c gi·∫£ qua email.',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
                
                // Reload contributions
                loadContributions();
                
                // Close modal if open
                const modal = bootstrap.Modal.getInstance(document.getElementById('contributionDetailModal'));
                if (modal) modal.hide();
                
            }).catch(error => {
                Swal.fire({
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ t·ª´ ch·ªëi c·∫©m nang: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
                console.error('Error rejecting contribution:', error);
            });
        }

        // Generate slug from title
        function generateSlug(title) {
            return title
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/[ƒëƒê]/g, 'd')
                .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/-+/g, '-') // Remove multiple hyphens
                .trim('-'); // Remove leading/trailing hyphens
        }

        // Event listeners for contribution modals
        document.addEventListener('DOMContentLoaded', function() {
            // Approve button in detail modal
            const approveBtn = document.getElementById('approveContributionBtn');
            if (approveBtn) {
                approveBtn.addEventListener('click', function() {
                    if (window.currentContribution) {
                        approveContribution(window.currentContribution.id);
                    }
                });
            }

            // Reject button in detail modal
            const rejectBtn = document.getElementById('rejectContributionBtn');
            if (rejectBtn) {
                rejectBtn.addEventListener('click', function() {
                    if (window.currentContribution) {
                        const modal = new bootstrap.Modal(document.getElementById('rejectContributionModal'));
                        modal.show();
                    }
                });
            }

            // Confirm reject button in reject modal
            const confirmRejectBtn = document.getElementById('confirmRejectBtn');
            if (confirmRejectBtn) {
                confirmRejectBtn.addEventListener('click', function() {
                    const reason = document.getElementById('rejectReason').value.trim();
                    if (reason && window.currentContribution) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('rejectContributionModal'));
                        modal.hide();
                        rejectContribution(window.currentContribution.id, reason);
                    }
                });
            }
        });

        // --- Settings Management ---
        function loadSettings() {
            db.ref('settings').once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    document.getElementById('settingWebsiteName').value = settings.websiteName || '';
                    document.getElementById('settingContactEmail').value = settings.contactEmail || '';
                    document.getElementById('settingPhoneNumber').value = settings.phoneNumber || '';
                    document.getElementById('settingAddress').value = settings.address || '';
                } else {
                    console.log("No settings found in Firebase. Using default form values.");
                }
            }).catch(error => {
                console.error("Error loading settings:", error);
                Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ t·∫£i c√†i ƒë·∫∑t: ' + error.message, 'error');
            });
        }

        function saveSettings(event) {
            event.preventDefault(); // Prevent form from submitting traditionally
            const settingsData = {
                websiteName: document.getElementById('settingWebsiteName').value,
                contactEmail: document.getElementById('settingContactEmail').value,
                phoneNumber: document.getElementById('settingPhoneNumber').value,
                address: document.getElementById('settingAddress').value
            };

            db.ref('settings').update(settingsData).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: 'C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c l∆∞u.',
                    timer: 1500
                });
            }).catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói!',
                    text: 'Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t: ' + error.message
                });
            });
        }

        // Initialize
        loadLocationChart();
        loadBookings();
        loadHotels();
        loadTours();
        loadDeals();
        loadUsers();
        loadTravelGuides();

        // Initialize things that should only run once
        function initializeApp() {

            // Add event listeners for booking filters
            document.getElementById('bookingSearchInput').addEventListener('input', filterAndDisplayBookings);
            document.getElementById('bookingStatusFilter').addEventListener('change', filterAndDisplayBookings);
            
            // Add event listeners for bulk actions
            document.getElementById('selectAllBookings').addEventListener('change', handleSelectAllBookings);
            document.getElementById('bookingsTable').addEventListener('change', (e) => {
                if (e.target.classList.contains('booking-checkbox')) {
                    updateBulkActionUI();
                }
            });

            document.getElementById('mobile-toggle').addEventListener('click', () => {
                 document.getElementById('sidebar').classList.toggle('active');
            });
            
            updateBulkActionUI(); // Update UI in case filters change selection state
        }

        // --- Bulk Actions for Bookings ---
        function getSelectedBookingIds() {
            return Array.from(document.querySelectorAll('.booking-checkbox:checked')).map(cb => cb.dataset.id);
        }

        function updateBulkActionUI() {
            const selectedIds = getSelectedBookingIds();
            const bulkActionContainer = document.getElementById('bulk-action-container');
            const selectedCountEl = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('selectAllBookings');

            if (selectedIds.length > 0) {
                selectedCountEl.textContent = `${selectedIds.length} ƒë√£ ch·ªçn`;
                bulkActionContainer.classList.remove('d-none');
                bulkActionContainer.classList.add('d-flex');
            } else {
                bulkActionContainer.classList.add('d-none');
                bulkActionContainer.classList.remove('d-flex');
            }

            // Update the "select all" checkbox state
            const totalCheckboxes = document.querySelectorAll('.booking-checkbox').length;
            selectAllCheckbox.checked = totalCheckboxes > 0 && selectedIds.length === totalCheckboxes;
        }
        
        function handleSelectAllBookings(e) {
            const isChecked = e.target.checked;
            document.querySelectorAll('.booking-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkActionUI();
        }

        async function deleteSelectedBookings() {
            const selectedIds = getSelectedBookingIds();
            if (selectedIds.length === 0) {
                Swal.fire("Ch∆∞a ch·ªçn m·ª•c n√†o", "Vui l√≤ng ch·ªçn c√°c m·ª•c b·∫°n mu·ªën x√≥a.", "info");
                return;
            }

            const result = await Swal.fire({
                title: `B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selectedIds.length} m·ª•c?`,
                text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ƒê·ªìng √Ω x√≥a!',
                cancelButtonText: 'H·ªßy'
            });

            if (result.isConfirmed) {
                const deletePromises = selectedIds.map(id => db.ref('bookings/' + id).remove());
                try {
                    await Promise.all(deletePromises);
                    Swal.fire('ƒê√£ x√≥a!', `${selectedIds.length} m·ª•c ƒë√£ ƒë∆∞·ª£c x√≥a.`, 'success');
                    // Data will refresh automatically via the 'on' listener
                } catch (error) {
                    console.error("Error deleting selected bookings: ", error);
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a c√°c m·ª•c ƒë√£ ch·ªçn.', 'error');
                }
            }
        }

        async function updateSelectedStatus() {
            const selectedIds = getSelectedBookingIds();
             if (selectedIds.length === 0) {
                Swal.fire("Ch∆∞a ch·ªçn m·ª•c n√†o", "Vui l√≤ng ch·ªçn c√°c m·ª•c b·∫°n mu·ªën c·∫≠p nh·∫≠t.", "info");
                return;
            }

            const { value: newStatus } = await Swal.fire({
                title: 'Ch·ªçn tr·∫°ng th√°i m·ªõi',
                input: 'select',
                inputOptions: {
                    'pending': 'Ch·ªù x√°c nh·∫≠n',
                    'confirmed': 'ƒê√£ x√°c nh·∫≠n',
                    'cancelled': 'ƒê√£ h·ªßy',
                    'completed': 'Ho√†n th√†nh'
                },
                inputPlaceholder: 'Ch·ªçn m·ªôt tr·∫°ng th√°i',
                showCancelButton: true,
                confirmButtonText: 'C·∫≠p nh·∫≠t',
                cancelButtonText: 'H·ªßy'
            });

            if (newStatus) {
                const updates = {};
                selectedIds.forEach(id => {
                    updates[`/bookings/${id}/status`] = newStatus;
                });

                try {
                    await db.ref().update(updates);
                    Swal.fire('Th√†nh c√¥ng!', `ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i cho ${selectedIds.length} m·ª•c.`, 'success');
                } catch (error) {
                     console.error("Error updating selected statuses: ", error);
                    Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i.', 'error');
                }
            }
        }

        function editBooking(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) {
                Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y ƒë·∫∑t ph√≤ng n√†y.', 'error');
                return;
            }
            // Danh s√°ch c√°c tr∆∞·ªùng h·ª£p l·ªá theo rule
            const allowedFields = [
                'bookingType', 'checkIn', 'checkOut', 'createdAt', 'customerEmail', 'customerName', 'customerPhone', 'email',
                'guests', 'hotelId', 'hotelName', 'nights', 'note', 'paymentMethod', 'paymentStatus', 'roomId', 'roomName',
                'roomPrice', 'status', 'totalPrice', 'updatedAt', 'userId',
                // C√°c tr∆∞·ªùng cho tour
                'numberOfGuests', 'tourId', 'tourName', 'tourCategory', 'tourLocation', 'tourDuration', 'tourImage', 'tourType',
                'tourPrice', 'tourDescription', 'tourIncludes', 'tourExcludes', 'tourRating', 'tourReviewsCount'
            ];
            // N·∫øu l√† booking tour
            if (booking.type === 'tour' || booking.bookingType === 'tour') {
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin ƒë·∫∑t tour',
                    html: `
                        <input id="edit-tourName" class="swal2-input" placeholder="T√™n tour" value="${booking.tourName || ''}">
                        <input id="edit-tourLocation" class="swal2-input" placeholder="ƒêi·ªÉm ƒë·∫øn" value="${booking.tourLocation || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="${booking.numberOfGuests || booking.guests || 1}">
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${booking.customerPhone || ''}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        return {
                            tourName: document.getElementById('edit-tourName').value,
                            tourLocation: document.getElementById('edit-tourLocation').value,
                            checkIn: document.getElementById('edit-checkIn').value,
                            numberOfGuests: parseInt(document.getElementById('edit-numberOfGuests').value),
                            customerName: document.getElementById('edit-customerName').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // L·ªçc d·ªØ li·ªáu c≈© ch·ªâ l·∫•y c√°c tr∆∞·ªùng h·ª£p l·ªá
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // G·ªôp v·ªõi d·ªØ li·ªáu m·ªõi
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('D·ªØ li·ªáu g·ª≠i l√™n Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                            loadBookingsTours();
                            loadBookings(); // ƒê·ªÉ ƒë·ªìng b·ªô n·∫øu c√≥ thay ƒë·ªïi
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        });
                    }
                });
            } else {
                // Booking kh√°ch s·∫°n gi·ªØ nh∆∞ c≈©
                Swal.fire({
                    title: 'S·ª≠a th√¥ng tin ƒë·∫∑t ph√≤ng',
                    html: `
                        <input id="edit-customerName" class="swal2-input" placeholder="T√™n kh√°ch" value="${booking.customerName || ''}">
                        <input id="edit-customerEmail" class="swal2-input" placeholder="Email" value="${booking.customerEmail || ''}">
                        <input id="edit-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i" value="${booking.customerPhone || ''}">
                        <input id="edit-hotelName" class="swal2-input" placeholder="Kh√°ch s·∫°n" value="${booking.hotelName || ''}">
                        <input id="edit-roomId" class="swal2-input" placeholder="Ph√≤ng" value="${booking.roomId || ''}">
                        <input id="edit-checkIn" class="swal2-input" type="date" value="${booking.checkIn ? booking.checkIn.split('T')[0] : ''}">
                        <input id="edit-checkOut" class="swal2-input" type="date" value="${booking.checkOut ? booking.checkOut.split('T')[0] : ''}">
                        <input id="edit-guests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="${booking.guests || 1}">
                        <select id="edit-status" class="swal2-input">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Ch·ªù x√°c nh·∫≠n</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'L∆∞u',
                    cancelButtonText: 'H·ªßy',
                    preConfirm: () => {
                        const roomIdValue = document.getElementById('edit-roomId').value;
                        return {
                            customerName: document.getElementById('edit-customerName').value,
                            customerEmail: document.getElementById('edit-customerEmail').value,
                            customerPhone: document.getElementById('edit-customerPhone').value,
                            hotelName: document.getElementById('edit-hotelName').value,
                            roomId: roomIdValue,
                            roomName: roomIdValue,
                            checkIn: document.getElementById('edit-checkIn').value,
                            checkOut: document.getElementById('edit-checkOut').value,
                            guests: parseInt(document.getElementById('edit-guests').value),
                            status: document.getElementById('edit-status').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // L·ªçc d·ªØ li·ªáu c≈© ch·ªâ l·∫•y c√°c tr∆∞·ªùng h·ª£p l·ªá
                        const updateData = {};
                        allowedFields.forEach(field => {
                            if (booking[field] !== undefined) updateData[field] = booking[field];
                        });
                        // G·ªôp v·ªõi d·ªØ li·ªáu m·ªõi
                        Object.assign(updateData, result.value);
                        delete updateData.id;
                        console.log('D·ªØ li·ªáu g·ª≠i l√™n Firebase:', updateData);
                        db.ref('bookings/' + bookingId).update(updateData).then(() => {
                            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                            loadBookings();
                        }).catch(() => {
                            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        });
                    }
                });
            }
        }

        // === NOTIFICATIONS ===
        function generateNotification(icon, color, text, link = '#') {
            const newNotif = {
                icon: icon, // e.g., 'fas fa-plus'
                color: color, // e.g., 'bg-success'
                text: text,
                link: link,
                read: false,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            db.ref('notifications').push(newNotif);
        }

        function loadNotifications() {
            const notifList = document.getElementById('notificationList');
            const badge = document.getElementById('notificationBell').querySelector('.badge-dot');

            const notificationsRef = db.ref('notifications').orderByChild('timestamp').limitToLast(15);
            
            notificationsRef.on('value', (snapshot) => {
                notifList.innerHTML = '';
                const notifications = [];
                let hasUnread = false;

                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const notif = childSnapshot.val();
                        notif.id = childSnapshot.key;
                        notifications.push(notif);
                        if (!notif.read) {
                            hasUnread = true;
                        }
                    });

                    notifications.reverse(); // Show newest first

                    notifications.forEach(notif => {
                        const item = document.createElement('a');
                        item.href = notif.link || '#';
                        item.className = 'notification-item' + (notif.read ? '' : ' unread');
                        item.dataset.id = notif.id;

                        item.innerHTML = `
                            <div class="icon ${notif.color || 'bg-primary'}">
                                <i class="${notif.icon || 'fas fa-info'}"></i>
                            </div>
                            <div class="content">
                                <p>${notif.text}</p>
                                <span class="timestamp">${new Date(notif.timestamp).toLocaleString('vi-VN')}</span>
                            </div>
                        `;
                        notifList.appendChild(item);
                    });

                } else {
                     notifList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No new notifications</p>
                         </div>`;
                }
                
                // Update badge visibility
                badge.style.display = hasUnread ? 'block' : 'none';
            });
        }

        function markNotificationsAsRead() {
            const notificationsRef = db.ref('notifications');
            notificationsRef.orderByChild('read').equalTo(false).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const updates = {};
                    snapshot.forEach(childSnapshot => {
                        updates[childSnapshot.key + '/read'] = true;
                    });
                    notificationsRef.update(updates);
                }
            });
        }

        function updateMissingRoomId() {
          Swal.fire({
            title: 'C·∫≠p nh·∫≠t d·ªØ li·ªáu ph√≤ng?',
            text: 'T·ª± ƒë·ªông c·∫≠p nh·∫≠t t·∫•t c·∫£ booking b·ªã thi·∫øu tr∆∞·ªùng Ph√≤ng th√†nh "Ch∆∞a c·∫≠p nh·∫≠t". B·∫°n c√≥ ch·∫Øc mu·ªën th·ª±c hi·ªán?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'C·∫≠p nh·∫≠t',
            cancelButtonText: 'H·ªßy'
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').once('value').then(snapshot => {
                let count = 0;
                snapshot.forEach(child => {
                  const data = child.val();
                  if (!data.roomId || !String(data.roomId).trim()) {
                    db.ref('bookings/' + child.key).update({ roomId: 'Ch∆∞a c·∫≠p nh·∫≠t' });
                    count++;
                  }
                });
                Swal.fire('Th√†nh c√¥ng', `ƒê√£ c·∫≠p nh·∫≠t ${count} booking b·ªã thi·∫øu tr∆∞·ªùng Ph√≤ng!`, 'success');
                loadBookings();
              });
            }
          });
        }

        function updateRoomIdKhongXacDinh() {
          Swal.fire({
            title: 'C·∫≠p nh·∫≠t ph√≤ng "Kh√¥ng x√°c ƒë·ªãnh"?',
            text: 'T·ª± ƒë·ªông c·∫≠p nh·∫≠t t·∫•t c·∫£ booking c√≥ tr∆∞·ªùng Ph√≤ng l√† "Kh√¥ng x√°c ƒë·ªãnh" th√†nh "Ph√≤ng ch∆∞a ƒë·∫∑t". B·∫°n c√≥ ch·∫Øc mu·ªën th·ª±c hi·ªán?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'C·∫≠p nh·∫≠t',
            cancelButtonText: 'H·ªßy'
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').once('value').then(snapshot => {
                let count = 0;
                snapshot.forEach(child => {
                  const data = child.val();
                  if (data.roomId && data.roomId.trim() === 'Kh√¥ng x√°c ƒë·ªãnh') {
                    db.ref('bookings/' + child.key).update({ roomId: 'Ph√≤ng ch∆∞a ƒë·∫∑t' });
                    count++;
                  }
                });
                Swal.fire('Th√†nh c√¥ng', `ƒê√£ c·∫≠p nh·∫≠t ${count} booking c√≥ ph√≤ng "Kh√¥ng x√°c ƒë·ªãnh"!`, 'success');
                loadBookings();
              });
                }
            });
        }

        // JS: Th√™m h√†m loadBookingsTours ƒë·ªÉ l·ªçc v√† render c√°c booking tour
        function loadBookingsTours() {
          const tableBody = document.getElementById('bookingsToursTable');
          tableBody.innerHTML = '';
          // L·ªçc booking tour theo c·∫£ type v√† bookingType
          const tourBookings = allBookings.filter(b => b.type === 'tour' || b.bookingType === 'tour');
          if (tourBookings.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-5">Kh√¥ng c√≥ booking tour n√†o.</td></tr>';
            return;
          }
          tourBookings.forEach(booking => {
            const row = document.createElement('tr');
            const statusBadge = `<span class="status status-${booking.status || 'pending'}">${booking.status || 'Ch·ªù x√°c nh·∫≠n'}</span>`;
            row.innerHTML = `
              <td>${booking.id}</td>
              <td>${booking.customerName || 'N/A'}</td>
              <td>${booking.customerEmail || 'N/A'}</td>
              <td>${booking.customerPhone || 'N/A'}</td>
              <td>${booking.tourName || 'Tour'}</td>
              <td>${booking.tourLocation || 'N/A'}</td>
              <td>${booking.checkIn ? new Date(booking.checkIn).toLocaleDateString('vi-VN') : 'N/A'}</td>
              <td>${booking.numberOfGuests || booking.guests || 'N/A'}</td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="editBooking('${booking.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking.id}')"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        }

        // JS: Th√™m h√†m addTourBooking
        function addTourBooking() {
          db.ref('specialTours').once('value').then(snapshot => {
            const tours = [];
            snapshot.forEach(groupSnap => {
              const group = groupSnap.val();
              Object.values(group).forEach(tour => {
                tours.push({
                  name: tour.name || '',
                  location: tour.location || ''
                });
              });
            });
            showAddTourBookingPopup(tours);
          });
        }

        function showAddTourBookingPopup(tours) {
          let tourOptions = tours.map(t => `<option value="${t.name}" data-location="${t.location}">${t.name}</option>`).join('');
          Swal.fire({
            title: 'Th√™m ƒë·∫∑t tour m·ªõi',
            html: `
              <div style="display: flex; flex-direction: column; gap: 12px;">
                <select id="add-tourName" class="swal2-input" style="width: 100%"><option value="">Ch·ªçn tour</option>${tourOptions}</select>
                <input id="add-tourLocation" class="swal2-input" placeholder="ƒêi·ªÉm ƒë·∫øn" readonly>
                <input id="add-checkIn" class="swal2-input" type="date">
                <input id="add-numberOfGuests" class="swal2-input" type="number" min="1" placeholder="S·ªë kh√°ch" value="1">
                <input id="add-customerName" class="swal2-input" placeholder="T√™n kh√°ch">
                <input id="add-customerPhone" class="swal2-input" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                <select id="add-status" class="swal2-input" style="width: 100%">
                  <option value="pending">Ch·ªù x√°c nh·∫≠n</option>
                  <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                  <option value="cancelled">ƒê√£ h·ªßy</option>
                  <option value="completed">Ho√†n th√†nh</option>
                </select>
              </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'L∆∞u',
            cancelButtonText: 'H·ªßy',
            didOpen: () => {
              const tourSelect = document.getElementById('add-tourName');
              const locationInput = document.getElementById('add-tourLocation');
              tourSelect.addEventListener('change', function() {
                const selected = tourSelect.options[tourSelect.selectedIndex];
                locationInput.value = selected.getAttribute('data-location') || '';
              });
            },
            preConfirm: () => {
              const tourSelect = document.getElementById('add-tourName');
              const locationInput = document.getElementById('add-tourLocation');
              return {
                tourName: tourSelect.value,
                tourLocation: locationInput.value,
                checkIn: document.getElementById('add-checkIn').value,
                numberOfGuests: parseInt(document.getElementById('add-numberOfGuests').value),
                customerName: document.getElementById('add-customerName').value,
                customerPhone: document.getElementById('add-customerPhone').value,
                status: document.getElementById('add-status').value,
                type: 'tour',
                createdAt: new Date().toISOString()
              };
            }
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref('bookings').push(result.value).then(() => {
                Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m ƒë·∫∑t tour m·ªõi!', 'success');
                loadBookingsTours();
              }).catch(() => {
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ th√™m ƒë·∫∑t tour.', 'error');
              });
                }
            });
        }

        // ===== QU·∫¢N L√ù HO√ÄN TI·ªÄN =====
        function loadRefunds() {
            const refundsTable = document.getElementById('refundsTable');
            if (!refundsTable) return;

            refundsTable.innerHTML = '<tr><td colspan="8" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>';

            db.ref('bookings').orderByChild('status').equalTo('cancelled').once('value').then(snapshot => {
                const refunds = [];
                snapshot.forEach(child => {
                    const booking = child.val();
                    if (booking.refundStatus) { // Ch·ªâ hi·ªÉn th·ªã booking c√≥ th√¥ng tin ho√†n ti·ªÅn
                        refunds.push({
                            id: child.key,
                            ...booking
                        });
                    }
                });

                // S·∫Øp x·∫øp theo th·ªùi gian h·ªßy m·ªõi nh·∫•t
                refunds.sort((a, b) => b.cancelledAt - a.cancelledAt);

                if (refunds.length === 0) {
                    refundsTable.innerHTML = '<tr><td colspan="8" class="text-center py-4">Kh√¥ng c√≥ y√™u c·∫ßu ho√†n ti·ªÅn n√†o.</td></tr>';
                    return;
                }

                refundsTable.innerHTML = '';
                                    refunds.forEach(refund => {
                        const row = document.createElement('tr');
                        const statusBadge = getRefundStatusBadge(refund.refundStatus);
                        const refundAmount = refund.refundAmount || 0;
                        const totalPrice = refund.totalPrice || refund.roomPrice || 0;
                        
                        // T·∫°o n√∫t thao t√°c ph√π h·ª£p v·ªõi tr·∫°ng th√°i
                        let actionButtons = '';
                        if (refund.refundStatus === 'pending') {
                            actionButtons = `
                                <button class="btn btn-sm btn-success" onclick="processRefund('${refund.id}')" title="X·ª≠ l√Ω ho√†n ti·ªÅn">
                                    <i class="fas fa-money-bill-wave"></i> X·ª≠ l√Ω
                                </button>
                            `;
                        } else if (refund.refundStatus === 'processing') {
                            actionButtons = `
                                <button class="btn btn-sm btn-warning" disabled title="ƒêang x·ª≠ l√Ω">
                                    <i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω
                                </button>
                            `;
                        } else if (refund.refundStatus === 'failed') {
                            actionButtons = `
                                <button class="btn btn-sm btn-success" onclick="processRefund('${refund.id}')" title="Th·ª≠ l·∫°i">
                                    <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
                                </button>
                            `;
                        } else if (refund.refundStatus === 'completed') {
                            actionButtons = `
                                <button class="btn btn-sm btn-secondary" disabled title="ƒê√£ ho√†n ti·ªÅn">
                                    <i class="fas fa-check-circle"></i> ƒê√£ ho√†n
                                </button>
                            `;
                        }
                        
                        row.innerHTML = `
                            <td>${refund.id}</td>
                            <td>${refund.customerName || refund.userName || 'N/A'}</td>
                            <td>${refund.customerEmail || refund.email || 'N/A'}</td>
                            <td>${refund.hotelName || refund.tourName || 'N/A'}</td>
                            <td>${totalPrice.toLocaleString()} VNƒê</td>
                            <td>${refundAmount.toLocaleString()} VNƒê</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${actionButtons}
                                <button class="btn btn-sm btn-info" onclick="viewRefundDetails('${refund.id}')" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i> Chi ti·∫øt
                                </button>
                            </td>
                        `;
                        refundsTable.appendChild(row);
                    });
            });
        }

        function getRefundStatusBadge(status) {
            const statusMap = {
                'pending': '<span class="badge bg-warning">Ch·ªù x·ª≠ l√Ω</span>',
                'processing': '<span class="badge bg-info">ƒêang x·ª≠ l√Ω</span>',
                'completed': '<span class="badge bg-success">ƒê√£ ho√†n ti·ªÅn</span>',
                'failed': '<span class="badge bg-danger">Th·∫•t b·∫°i</span>'
            };
            return statusMap[status] || '<span class="badge bg-secondary">Kh√¥ng x√°c ƒë·ªãnh</span>';
        }

        function getRefundStatusText(status) {
            const statusMap = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'processing': 'ƒêang x·ª≠ l√Ω',
                'completed': 'ƒê√£ ho√†n ti·ªÅn',
                'failed': 'Th·∫•t b·∫°i'
            };
            return statusMap[status] || 'Kh√¥ng x√°c ƒë·ªãnh';
        }

        function processRefund(bookingId) {
            Swal.fire({
                title: 'Ch·ªçn ph∆∞∆°ng th·ª©c ho√†n ti·ªÅn',
                text: 'B·∫°n mu·ªën ho√†n ti·ªÅn b·∫±ng ph∆∞∆°ng th·ª©c n√†o?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ho√†n ti·ªÅn t·ª± ƒë·ªông (VNPay)',
                cancelButtonText: 'Ho√†n ti·ªÅn th·ªß c√¥ng',
                showDenyButton: true,
                denyButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Ho√†n ti·ªÅn t·ª± ƒë·ªông qua VNPay
                    processAutomaticRefund(bookingId);
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    // Ho√†n ti·ªÅn th·ªß c√¥ng
                    processManualRefund(bookingId);
                }
            });
        }

        // Ho√†n ti·ªÅn t·ª± ƒë·ªông qua VNPay
        async function processAutomaticRefund(bookingId) {
            try {
                Swal.fire({
                    title: 'ƒêang x·ª≠ l√Ω ho√†n ti·ªÅn...',
                    text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // L·∫•y th√¥ng tin booking
                const snapshot = await db.ref('bookings/' + bookingId).once('value');
                const booking = snapshot.val();

                if (!booking) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin booking');
                }

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh processing
                await db.ref('bookings/' + bookingId).update({
                    refundStatus: 'processing',
                    refundProcessingAt: Date.now()
                });

                // Gi·∫£ l·∫≠p ho√†n ti·ªÅn VNPay (trong th·ª±c t·∫ø s·∫Ω g·ªçi API VNPay)
                await new Promise(resolve => setTimeout(resolve, 2000)); // Gi·∫£ l·∫≠p delay

                // Gi·∫£ l·∫≠p k·∫øt qu·∫£ th√†nh c√¥ng (lu√¥n th√†nh c√¥ng cho demo)
                const success = true; // Lu√¥n th√†nh c√¥ng cho demo

                if (success) {
                    await db.ref('bookings/' + bookingId).update({
                        refundStatus: 'completed',
                        refundCompletedAt: Date.now(),
                        refundTransactionId: `VNPAY_${Date.now()}`,
                        refundMethod: 'vnpay_automatic'
                    });

                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ ho√†n ti·ªÅn t·ª± ƒë·ªông qua VNPay!', 'success');
                } else {
                    await db.ref('bookings/' + bookingId).update({
                        refundStatus: 'failed',
                        refundFailedAt: Date.now(),
                        refundErrorMessage: 'Ho√†n ti·ªÅn th·∫•t b·∫°i - Vui l√≤ng th·ª≠ l·∫°i'
                    });

                    Swal.fire('Th·∫•t b·∫°i', 'Ho√†n ti·ªÅn t·ª± ƒë·ªông th·∫•t b·∫°i. Vui l√≤ng th·ª≠ ho√†n ti·ªÅn th·ªß c√¥ng.', 'error');
                }

                loadRefunds();
            } catch (error) {
                console.error('L·ªói khi ho√†n ti·ªÅn t·ª± ƒë·ªông:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x·ª≠ l√Ω ho√†n ti·ªÅn t·ª± ƒë·ªông: ' + error.message, 'error');
            }
        }

        // Ho√†n ti·ªÅn th·ªß c√¥ng
        async function processManualRefund(bookingId) {
            try {
                Swal.fire({
                    title: 'X√°c nh·∫≠n ho√†n ti·ªÅn th·ªß c√¥ng?',
                    text: 'B·∫°n c√≥ ch·∫Øc ƒë√£ ho√†n ti·ªÅn cho kh√°ch h√†ng?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'X√°c nh·∫≠n',
                    cancelButtonText: 'H·ªßy'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await db.ref('bookings/' + bookingId).update({
                            refundStatus: 'completed',
                            refundCompletedAt: Date.now(),
                            refundMethod: 'manual_bank_transfer',
                            refundNote: 'Admin x√°c nh·∫≠n ƒë√£ ho√†n ti·ªÅn th·ªß c√¥ng'
                        });

                        Swal.fire('Th√†nh c√¥ng', 'ƒê√£ x√°c nh·∫≠n ho√†n ti·ªÅn th·ªß c√¥ng!', 'success');
                        loadRefunds();
                    }
                });
            } catch (error) {
                console.error('L·ªói khi ho√†n ti·ªÅn th·ªß c√¥ng:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n ti·ªÅn.', 'error');
            }
        }

        function viewRefundDetails(bookingId) {
            db.ref('bookings/' + bookingId).once('value').then(snapshot => {
                const booking = snapshot.val();
                if (!booking) {
                    Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y th√¥ng tin booking.', 'error');
                    return;
                }

                const refundAmount = booking.refundAmount || 0;
                const totalPrice = booking.totalPrice || booking.roomPrice || 0;
                const refundPercentage = totalPrice > 0 ? ((refundAmount / totalPrice) * 100).toFixed(1) : 0;
                
                // Th√¥ng tin th·ªùi gian
                const cancelledDate = booking.cancelledAt ? new Date(booking.cancelledAt).toLocaleString('vi-VN') : 'N/A';
                const processingDate = booking.refundProcessingAt ? new Date(booking.refundProcessingAt).toLocaleString('vi-VN') : 'N/A';
                const completedDate = booking.refundCompletedAt ? new Date(booking.refundCompletedAt).toLocaleString('vi-VN') : 'N/A';
                const failedDate = booking.refundFailedAt ? new Date(booking.refundFailedAt).toLocaleString('vi-VN') : 'N/A';
                
                // Th√¥ng tin ph∆∞∆°ng th·ª©c ho√†n ti·ªÅn
                const refundMethod = booking.refundMethod || 'Ch∆∞a x√°c ƒë·ªãnh';
                const transactionId = booking.refundTransactionId || 'N/A';
                const errorMessage = booking.refundErrorMessage || '';
                const refundNote = booking.refundNote || 'N/A';

                Swal.fire({
                    title: 'Chi ti·∫øt ho√†n ti·ªÅn',
                    html: `
                        <div class="text-left">
                            <h6 class="mb-3">Th√¥ng tin booking</h6>
                            <p><strong>Booking ID:</strong> ${bookingId}</p>
                            <p><strong>Kh√°ch h√†ng:</strong> ${booking.customerName || booking.userName || 'N/A'}</p>
                            <p><strong>Email:</strong> ${booking.customerEmail || booking.email || 'N/A'}</p>
                            <p><strong>D·ªãch v·ª•:</strong> ${booking.hotelName || booking.tourName || 'N/A'}</p>
                            <p><strong>T·ªïng ti·ªÅn:</strong> ${totalPrice.toLocaleString()} VNƒê</p>
                            
                            <hr>
                            <h6 class="mb-3">Th√¥ng tin ho√†n ti·ªÅn</h6>
                            <p><strong>S·ªë ti·ªÅn ho√†n:</strong> ${refundAmount.toLocaleString()} VNƒê (${refundPercentage}%)</p>
                            <p><strong>Tr·∫°ng th√°i:</strong> ${getRefundStatusText(booking.refundStatus)}</p>
                            <p><strong>Ph∆∞∆°ng th·ª©c:</strong> ${refundMethod}</p>
                            <p><strong>M√£ giao d·ªãch:</strong> ${transactionId}</p>
                            
                            <hr>
                            <h6 class="mb-3">Th·ªùi gian</h6>
                            <p><strong>Ng√†y h·ªßy:</strong> ${cancelledDate}</p>
                            <p><strong>B·∫Øt ƒë·∫ßu x·ª≠ l√Ω:</strong> ${processingDate}</p>
                            <p><strong>Ho√†n th√†nh:</strong> ${completedDate}</p>
                            <p><strong>Th·∫•t b·∫°i:</strong> ${failedDate}</p>
                            
                            ${errorMessage ? `
                                <hr>
                                <h6 class="mb-3">L·ªói</h6>
                                <p class="text-danger"><strong>L·ªói:</strong> ${errorMessage}</p>
                            ` : ''}
                            
                            ${refundNote !== 'N/A' ? `
                                <hr>
                                <h6 class="mb-3">Ghi ch√∫</h6>
                                <p><strong>Ghi ch√∫:</strong> ${refundNote}</p>
                            ` : ''}
                        </div>
                    `,
                    width: '600px',
                    icon: 'info',
                    confirmButtonText: 'ƒê√≥ng'
                });
            });
        }

        // H√†m t·ªïng h·ª£p s·ªë li·ªáu theo th√°ng (tr·∫£ v·ªÅ object)
        async function getMonthlyStats(month, year) {
          const start = new Date(year, month - 1, 1).getTime();
          const end = new Date(year, month, 0, 23, 59, 59, 999).getTime();
          // 1. L·∫•y users
          const usersSnap = await db.ref('users').once('value');
          let newUsers = 0;
          usersSnap.forEach(userSnap => {
            const user = userSnap.val();
            if (user.createdAt && user.createdAt >= start && user.createdAt <= end) newUsers++;
          });
          // 2. L·∫•y bookings
          const bookingsSnap = await db.ref('bookings').once('value');
          const roomSet = new Set();
          const userIds = new Set();
          let revenue = 0;
          bookingsSnap.forEach(bookingSnap => {
            const booking = bookingSnap.val();
            if (booking.createdAt >= start && booking.createdAt <= end) {
              userIds.add(booking.userId);
              if ((booking.status === 'confirmed' || booking.status === 'completed')) {
                roomSet.add(`${booking.hotelId}_${booking.roomId}`);
                revenue += booking.totalPrice || 0;
              }
            }
          });
          // 3. Th·ªëng k√™ gi·ªõi t√≠nh
          let male = 0, female = 0, other = 0;
          userIds.forEach(uid => {
            const user = usersSnap.child(uid).val();
            if (user && user.gender) {
              if (user.gender === 'Nam') male++;
              else if (user.gender === 'N·ªØ') female++;
              else other++;
            } else {
              other++;
            }
          });
          return {
            newUsers,
            roomsBooked: roomSet.size,
            gender: { male, female, other },
            revenue
          };
        }

        // H√†m t√≠nh % thay ƒë·ªïi so v·ªõi th√°ng tr∆∞·ªõc
        function calcChange(current, prev) {
          if (prev === 0 && current === 0) return {percent: 0, up: false};
          if (prev === 0) return {percent: 100, up: true};
          const percent = Math.round(((current - prev) / prev) * 100);
          return {percent: Math.abs(percent), up: current >= prev};
        }

        // C·∫≠p nh·∫≠t giao di·ªán th·ªëng k√™ v√† so s√°nh th√°ng tr∆∞·ªõc
        async function updateMonthlyStatsUI() {
          const month = parseInt(document.getElementById('stat-month').value);
          const year = parseInt(document.getElementById('stat-year').value);
          document.getElementById('stat-month-label').textContent = month;
          document.getElementById('stat-year-label').textContent = year;
          const stats = await getMonthlyStats(month, year);
          // Th√°ng tr∆∞·ªõc
          let prevMonth = month - 1, prevYear = year;
          if (prevMonth === 0) { prevMonth = 12; prevYear = year - 1; }
          const prevStats = await getMonthlyStats(prevMonth, prevYear);
          // Hi·ªÉn th·ªã s·ªë li·ªáu hi·ªán t·∫°i
          document.getElementById('stat-new-users').textContent = stats.newUsers;
          document.getElementById('stat-rooms-booked').textContent = stats.roomsBooked;
          document.getElementById('stat-gender').textContent = `${stats.gender.male}/${stats.gender.female}/${stats.gender.other}`;
          document.getElementById('stat-revenue').textContent = stats.revenue.toLocaleString('vi-VN');
          // Hi·ªÉn th·ªã % thay ƒë·ªïi
          function renderChange(el, change) {
            if (!el) return;
            if (change.percent === 0) {
              el.innerHTML = '<span style="color:#888">0%</span>';
            } else {
              el.innerHTML = `<span style="color:${change.up ? '#43a047' : '#e53935'};font-weight:600"><i class="fas fa-arrow-${change.up ? 'up' : 'down'}"></i> ${change.percent}%</span>`;
            }
          }
          renderChange(document.getElementById('stat-new-users-change'), calcChange(stats.newUsers, prevStats.newUsers));
          renderChange(document.getElementById('stat-rooms-booked-change'), calcChange(stats.roomsBooked, prevStats.roomsBooked));
          renderChange(document.getElementById('stat-gender-male-change'), calcChange(stats.gender.male, prevStats.gender.male));
          renderChange(document.getElementById('stat-revenue-change'), calcChange(stats.revenue, prevStats.revenue));
          // L∆∞u l·∫°i ƒë·ªÉ xu·∫•t Excel
          window._lastMonthlyStats = { month, year, ...stats };
          // K√≠ch ho·∫°t tooltip Bootstrap
          if (window.bootstrap && window.bootstrap.Tooltip) {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
              new bootstrap.Tooltip(el);
            });
          }
          // V·∫Ω mini chart doanh thu 12 th√°ng g·∫ßn nh·∫•t
          await renderMiniRevenueChart(month, year);
        }

        document.getElementById('stat-month').addEventListener('change', updateMonthlyStatsUI);
        document.getElementById('stat-year').addEventListener('change', updateMonthlyStatsUI);
        window.addEventListener('DOMContentLoaded', updateMonthlyStatsUI);

        // Xu·∫•t Excel
        function exportStatsToExcel() {
          const stats = window._lastMonthlyStats;
          if (!stats) return;
          const wsData = [
            ['Th·ªëng k√™ th√°ng', `${stats.month}/${stats.year}`],
            ['S·ªë kh√°ch m·ªõi', stats.newUsers],
            ['S·ªë ph√≤ng c√≥ ng∆∞·ªùi ƒë·∫∑t', stats.roomsBooked],
            ['Gi·ªõi t√≠nh (Nam/N·ªØ/Kh√°c)', `${stats.gender.male}/${stats.gender.female}/${stats.gender.other}`],
            ['Doanh thu (VNƒê)', stats.revenue]
          ];
          const ws = XLSX.utils.aoa_to_sheet(wsData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Th·ªëng k√™');
          XLSX.writeFile(wb, `ThongKe_${stats.month}_${stats.year}.xlsx`);
        }
        document.getElementById('export-excel-btn').addEventListener('click', exportStatsToExcel);

        // V·∫Ω mini chart doanh thu 12 th√°ng g·∫ßn nh·∫•t
        async function renderMiniRevenueChart(selectedMonth, selectedYear) {
          const canvas = document.getElementById('mini-revenue-chart');
          if (!canvas) return;
          if (miniRevenueChartInstance) { miniRevenueChartInstance.destroy(); miniRevenueChartInstance = null; }
          // L·∫•y d·ªØ li·ªáu 12 th√°ng g·∫ßn nh·∫•t
          const now = new Date(selectedYear, selectedMonth - 1);
          const labels = [];
          const data = [];
          for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            labels.push(`${d.getMonth() + 1}/${d.getFullYear().toString().slice(-2)}`);
            const stats = await getMonthlyStats(d.getMonth() + 1, d.getFullYear());
            data.push(Math.round(stats.revenue / 1000000)); // Tri·ªáu VNƒê
          }
          const ctx = canvas.getContext('2d');
          miniRevenueChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                data,
                borderColor: '#43e97b',
                backgroundColor: 'rgba(67,233,123,0.08)',
                tension: 0.4,
                pointRadius: 0,
                fill: true,
                borderWidth: 2
              }]
            },
            options: {
              plugins: { legend: { display: false } },
              scales: { x: { display: false }, y: { display: false } },
              elements: { line: { borderJoinStyle: 'round' } },
              responsive: false,
              maintainAspectRatio: false
            }
          });
        }

        // Popup chi ti·∫øt doanh thu t·ª´ng ng√†y khi click v√†o card doanh thu
        const revenueCard = document.querySelector('.stats-summary-card.revenue');
        if (revenueCard) {
          revenueCard.style.cursor = 'pointer';
          revenueCard.addEventListener('click', async () => {
            const month = parseInt(document.getElementById('stat-month').value);
            const year = parseInt(document.getElementById('stat-year').value);
            // L·∫•y doanh thu t·ª´ng ng√†y trong th√°ng
            const start = new Date(year, month - 1, 1).getTime();
            const end = new Date(year, month, 0, 23, 59, 59, 999).getTime();
            const bookingsSnap = await db.ref('bookings').once('value');
            const dailyRevenue = {};
            for (let d = 1; d <= new Date(year, month, 0).getDate(); d++) dailyRevenue[d] = 0;
            bookingsSnap.forEach(bookingSnap => {
              const booking = bookingSnap.val();
              if (
                booking.createdAt >= start && booking.createdAt <= end &&
                (booking.status === 'confirmed' || booking.status === 'completed')
              ) {
                const date = new Date(booking.createdAt);
                const day = date.getDate();
                dailyRevenue[day] += booking.totalPrice || 0;
              }
            });
            // Hi·ªÉn th·ªã popup v·ªõi bi·ªÉu ƒë·ªì c·ªôt
            const days = Object.keys(dailyRevenue);
            const values = Object.values(dailyRevenue).map(v => Math.round(v / 1000)); // Ngh√¨n VNƒê
            const popupId = 'popup-daily-revenue-chart';
            Swal.fire({
              title: `Chi ti·∫øt doanh thu t·ª´ng ng√†y th√°ng ${month}/${year}`,
              html: `<canvas id="${popupId}" height="220"></canvas>`,
              width: 700,
              showCloseButton: true,
              didOpen: () => {
                const ctx = document.getElementById(popupId).getContext('2d');
                new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: days,
                    datasets: [{
                      label: 'Doanh thu (ngh√¨n VNƒê)',
                      data: values,
                      backgroundColor: '#43e97b',
                      borderRadius: 6
                    }]
                  },
                  options: {
                    plugins: { legend: { display: false } },
                    scales: { x: { title: { display: true, text: 'Ng√†y' } }, y: { title: { display: true, text: 'Ngh√¨n VNƒê' } } },
                    responsive: true,
                    maintainAspectRatio: false
                  }
                });
              }
            });
          });
        }

        // S·ª± ki·ªán click card 'Ph√≤ng c√≥ ng∆∞·ªùi'
        document.querySelector('.stats-summary-card .fa-bed').closest('.stats-summary-card').addEventListener('click', async function() {
          const month = parseInt(document.getElementById('stat-month').value);
          const year = parseInt(document.getElementById('stat-year').value);
          // T√≠nh ng√†y ƒë·∫ßu v√† cu·ªëi th√°ng d·∫°ng YYYY-MM-DD
          const startDate = new Date(year, month - 1, 1);
          const endDate = new Date(year, month, 0);
          function parseDate(str) {
            // str: YYYY-MM-DD
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
          }
          // L·∫•y bookings h·ª£p l·ªá (ch·ªâ lo·∫°i tr·ª´ cancelled/rejected)
          const bookingsSnap = await db.ref('bookings').once('value');
          const bookings = [];
          bookingsSnap.forEach(snap => {
            const b = snap.val();
            const status = (b.status || '').toLowerCase();
            if (status !== 'cancelled' && status !== 'rejected' && b.checkIn) {
              let checkInDate;
              if (typeof b.checkIn === 'string' && b.checkIn.match(/^\d{4}-\d{2}-\d{2}$/)) {
                checkInDate = parseDate(b.checkIn);
              } else if (typeof b.checkIn === 'number') {
                checkInDate = new Date(b.checkIn);
              }
              if (checkInDate && checkInDate >= startDate && checkInDate <= endDate) {
                bookings.push({...b, id: snap.key});
              }
            }
          });
          // L·∫•y th√¥ng tin kh√°ch s·∫°n/ph√≤ng
          const hotelNames = {};
          const roomNames = {};
          for (const b of bookings) {
            if (b.hotelId && !hotelNames[b.hotelId]) {
              const hSnap = await db.ref('hotels/' + b.hotelId).once('value');
              hotelNames[b.hotelId] = hSnap.exists() ? hSnap.val().name : (b.hotelName || b.hotelId);
            }
            if (b.roomId && !roomNames[b.roomId]) {
              roomNames[b.roomId] = b.roomId;
            }
          }
          // Render b·∫£ng
          const tbody = document.getElementById('occupiedRoomsTableBody');
          tbody.innerHTML = bookings.map(b => `
            <tr>
              <td>${b.hotelId ? (hotelNames[b.hotelId] || b.hotelName || b.hotelId) : '<span class="text-danger">Thi·∫øu d·ªØ li·ªáu</span>'}</td>
              <td>${b.roomId ? (roomNames[b.roomId] || b.roomId) : '<span class="text-danger">Thi·∫øu d·ªØ li·ªáu</span>'}</td>
              <td>${b.customerName || b.guestName || ''}</td>
              <td>${b.checkIn ? (typeof b.checkIn === 'string' ? b.checkIn : (new Date(b.checkIn)).toLocaleDateString()) : '<span class="text-danger">Thi·∫øu d·ªØ li·ªáu</span>'}</td>
              <td>${b.checkOut ? (typeof b.checkOut === 'string' ? b.checkOut : (new Date(b.checkOut)).toLocaleDateString()) : ''}</td>
              <td>${b.status || ''}</td>
            </tr>
          `).join('');
          // M·ªü modal
          const modal = new bootstrap.Modal(document.getElementById('occupiedRoomsModal'));
          modal.show();
        });
    </script>

    <!-- Modal chi ti·∫øt c·∫©m nang -->
    <div class="modal fade" id="contributionDetailModal" tabindex="-1" aria-labelledby="contributionDetailModalLabel">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contributionDetailModalLabel">Chi ti·∫øt c·∫©m nang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    <div id="contribution-detail-content">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-danger" id="rejectContributionBtn">
                        <i class="fas fa-times"></i> T·ª´ ch·ªëi
                    </button>
                    <button type="button" class="btn btn-success" id="approveContributionBtn">
                        <i class="fas fa-check"></i> Duy·ªát & C√¥ng b·ªë
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal t·ª´ ch·ªëi c·∫©m nang -->
    <div class="modal fade" id="rejectContributionModal" tabindex="-1" aria-labelledby="rejectContributionModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectContributionModalLabel">T·ª´ ch·ªëi c·∫©m nang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">L√Ω do t·ª´ ch·ªëi *</label>
                        <textarea class="form-control" id="rejectReason" rows="4" 
                            placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi ƒë·ªÉ g·ª≠i ph·∫£n h·ªìi cho t√°c gi·∫£..."></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>L∆∞u √Ω:</strong> L√Ω do t·ª´ ch·ªëi s·∫Ω ƒë∆∞·ª£c g·ª≠i email cho t√°c gi·∫£ ƒë·ªÉ h·ªç c√≥ th·ªÉ ch·ªânh s·ª≠a v√† g·ª≠i l·∫°i.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                        <i class="fas fa-times"></i> X√°c nh·∫≠n t·ª´ ch·ªëi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chi ti·∫øt ph√≤ng c√≥ ng∆∞·ªùi -->
    <div class="modal fade" id="occupiedRoomsModal" tabindex="-1" aria-labelledby="occupiedRoomsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="occupiedRoomsModalLabel">Danh s√°ch ph√≤ng c√≥ ng∆∞·ªùi ƒë·∫∑t trong th√°ng</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>T√™n kh√°ch s·∫°n</th>
                    <th>S·ªë ph√≤ng</th>
                    <th>T√™n kh√°ch</th>
                    <th>Ng√†y nh·∫≠n</th>
                    <th>Ng√†y tr·∫£</th>
                    <th>Tr·∫°ng th√°i</th>
                  </tr>
                </thead>
                <tbody id="occupiedRoomsTableBody">
                  <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mobile JavaScript -->
    <script src="js/mobile.js"></script>
</body>

</html>